# Comparing `tmp/bambooai-0.3.7.tar.gz` & `tmp/bambooai-0.3.8.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "bambooai-0.3.7.tar", last modified: Tue Jun 27 07:28:37 2023, max compression
+gzip compressed data, was "bambooai-0.3.8.tar", last modified: Sat Jul  1 05:15:43 2023, max compression
```

## Comparing `bambooai-0.3.7.tar` & `bambooai-0.3.8.tar`

### file list

```diff
@@ -1,17 +1,17 @@
-drwxrwxrwx   0        0        0        0 2023-06-27 07:28:37.163458 bambooai-0.3.7/
--rw-rw-rw-   0        0        0     7870 2023-06-27 07:28:37.162956 bambooai-0.3.7/PKG-INFO
--rw-rw-rw-   0        0        0     7317 2023-06-27 07:25:47.000000 bambooai-0.3.7/README.md
-drwxrwxrwx   0        0        0        0 2023-06-27 07:28:37.126161 bambooai-0.3.7/bambooai/
--rw-rw-rw-   0        0        0      107 2023-06-27 07:23:09.000000 bambooai-0.3.7/bambooai/__init__.py
--rw-rw-rw-   0        0        0    31816 2023-06-27 07:22:25.000000 bambooai-0.3.7/bambooai/bambooai.py
--rw-rw-rw-   0        0        0     1309 2023-06-22 23:44:14.000000 bambooai-0.3.7/bambooai/func_calls.py
--rw-rw-rw-   0        0        0     5817 2023-06-24 13:34:56.000000 bambooai-0.3.7/bambooai/prompts.py
--rw-rw-rw-   0        0        0     4189 2023-06-27 02:19:42.000000 bambooai-0.3.7/bambooai/qa_retrieval.py
-drwxrwxrwx   0        0        0        0 2023-06-27 07:28:37.161111 bambooai-0.3.7/bambooai.egg-info/
--rw-rw-rw-   0        0        0     7870 2023-06-27 07:28:37.000000 bambooai-0.3.7/bambooai.egg-info/PKG-INFO
--rw-rw-rw-   0        0        0      287 2023-06-27 07:28:37.000000 bambooai-0.3.7/bambooai.egg-info/SOURCES.txt
--rw-rw-rw-   0        0        0        1 2023-06-27 07:28:37.000000 bambooai-0.3.7/bambooai.egg-info/dependency_links.txt
--rw-rw-rw-   0        0        0       24 2023-06-27 07:28:37.000000 bambooai-0.3.7/bambooai.egg-info/requires.txt
--rw-rw-rw-   0        0        0        9 2023-06-27 07:28:37.000000 bambooai-0.3.7/bambooai.egg-info/top_level.txt
--rw-rw-rw-   0        0        0       42 2023-06-27 07:28:37.164046 bambooai-0.3.7/setup.cfg
--rw-rw-rw-   0        0        0      702 2023-06-27 07:23:56.000000 bambooai-0.3.7/setup.py
+drwxrwxrwx   0        0        0        0 2023-07-01 05:15:43.776786 bambooai-0.3.8/
+-rw-rw-rw-   0        0        0     7870 2023-07-01 05:15:43.776511 bambooai-0.3.8/PKG-INFO
+-rw-rw-rw-   0        0        0     7317 2023-06-27 07:25:47.000000 bambooai-0.3.8/README.md
+drwxrwxrwx   0        0        0        0 2023-07-01 05:15:43.741875 bambooai-0.3.8/bambooai/
+-rw-rw-rw-   0        0        0      107 2023-06-27 07:23:09.000000 bambooai-0.3.8/bambooai/__init__.py
+-rw-rw-rw-   0        0        0    31937 2023-07-01 04:57:43.000000 bambooai-0.3.8/bambooai/bambooai.py
+-rw-rw-rw-   0        0        0     1309 2023-06-22 23:44:14.000000 bambooai-0.3.8/bambooai/func_calls.py
+-rw-rw-rw-   0        0        0     6154 2023-07-01 04:51:12.000000 bambooai-0.3.8/bambooai/prompts.py
+-rw-rw-rw-   0        0        0     4189 2023-06-27 02:19:42.000000 bambooai-0.3.8/bambooai/qa_retrieval.py
+drwxrwxrwx   0        0        0        0 2023-07-01 05:15:43.774692 bambooai-0.3.8/bambooai.egg-info/
+-rw-rw-rw-   0        0        0     7870 2023-07-01 05:15:43.000000 bambooai-0.3.8/bambooai.egg-info/PKG-INFO
+-rw-rw-rw-   0        0        0      287 2023-07-01 05:15:43.000000 bambooai-0.3.8/bambooai.egg-info/SOURCES.txt
+-rw-rw-rw-   0        0        0        1 2023-07-01 05:15:43.000000 bambooai-0.3.8/bambooai.egg-info/dependency_links.txt
+-rw-rw-rw-   0        0        0       24 2023-07-01 05:15:43.000000 bambooai-0.3.8/bambooai.egg-info/requires.txt
+-rw-rw-rw-   0        0        0        9 2023-07-01 05:15:43.000000 bambooai-0.3.8/bambooai.egg-info/top_level.txt
+-rw-rw-rw-   0        0        0       42 2023-07-01 05:15:43.777486 bambooai-0.3.8/setup.cfg
+-rw-rw-rw-   0        0        0      702 2023-07-01 05:11:02.000000 bambooai-0.3.8/setup.py
```

### Comparing `bambooai-0.3.7/PKG-INFO` & `bambooai-0.3.8/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: bambooai
-Version: 0.3.7
+Version: 0.3.8
 Summary: A lightweight library for working with pandas dataframes using natural language queries
 Home-page: UNKNOWN
 Author: Palo Galko
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Development Status :: 3 - Alpha
 Classifier: License :: OSI Approved :: MIT License
```

### Comparing `bambooai-0.3.7/README.md` & `bambooai-0.3.8/README.md`

 * *Files identical despite different names*

### Comparing `bambooai-0.3.7/bambooai/bambooai.py` & `bambooai-0.3.8/bambooai/bambooai.py`

 * *Files 1% similar despite different names*

```diff
@@ -233,1757 +233,1765 @@
 00000e80: 7765 725f 7061 6972 203d 2071 615f 7265  wer_pair = qa_re
 00000e90: 7472 6965 7661 6c2e 6164 645f 7175 6573  trieval.add_ques
 00000ea0: 7469 6f6e 5f61 6e73 7765 725f 7061 6972  tion_answer_pair
 00000eb0: 0d0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
 00000ec0: 6574 7269 6576 655f 616e 7377 6572 203d  etrieve_answer =
 00000ed0: 2071 615f 7265 7472 6965 7661 6c2e 7265   qa_retrieval.re
 00000ee0: 7472 6965 7665 5f61 6e73 7765 720d 0a20  trieve_answer.. 
-00000ef0: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
-00000f00: 206f 7065 6e61 692e 6170 695f 6b65 7920   openai.api_key 
-00000f10: 3d20 7365 6c66 2e41 5049 5f4b 4559 0d0a  = self.API_KEY..
-00000f20: 0d0a 2020 2020 2020 2020 2320 496e 6974  ..        # Init
-00000f30: 6961 6c69 7a65 2074 6865 2074 6f74 616c  ialize the total
-00000f40: 2074 6f6b 656e 7320 7573 6564 206c 6973   tokens used lis
-00000f50: 742e 2054 6869 7320 6c69 7374 2077 696c  t. This list wil
-00000f60: 6c20 6265 2075 7365 6420 746f 206b 6565  l be used to kee
-00000f70: 7020 7472 6163 6b20 6f66 2074 6865 2074  p track of the t
-00000f80: 6f74 616c 2074 6f6b 656e 7320 7573 6564  otal tokens used
-00000f90: 2062 7920 7468 6520 6d6f 6465 6c0d 0a20   by the model.. 
-00000fa0: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00000fb0: 6c5f 746f 6b65 6e73 5f75 7365 6420 3d20  l_tokens_used = 
-00000fc0: 5b5d 0d0a 0d0a 2020 2020 6465 6620 6c6c  []....    def ll
-00000fd0: 6d5f 6361 6c6c 2873 656c 662c 206d 6573  m_call(self, mes
-00000fe0: 7361 6765 733a 2073 7472 2c20 7465 6d70  sages: str, temp
-00000ff0: 6572 6174 7572 653a 2066 6c6f 6174 203d  erature: float =
-00001000: 2030 2c20 6d61 785f 746f 6b65 6e73 3a20   0, max_tokens: 
-00001010: 696e 7420 3d20 3130 3030 2c20 6c6c 6d5f  int = 1000, llm_
-00001020: 6361 7363 6164 653a 2062 6f6f 6c20 3d20  cascade: bool = 
-00001030: 4661 6c73 6529 3a0d 0a20 2020 2020 2020  False):..       
-00001040: 206d 6f64 656c 203d 2073 656c 662e 6c6c   model = self.ll
-00001050: 6d0d 0a20 2020 2020 2020 2069 6620 6c6c  m..        if ll
-00001060: 6d5f 6361 7363 6164 653a 0d0a 2020 2020  m_cascade:..    
-00001070: 2020 2020 2020 2020 6d6f 6465 6c20 3d20          model = 
-00001080: 7365 6c66 2e6c 6c6d 5f67 7074 340d 0a20  self.llm_gpt4.. 
-00001090: 2020 2020 2020 2074 7279 3a0d 0a20 2020         try:..   
-000010a0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-000010b0: 6520 3d20 6f70 656e 6169 2e43 6861 7443  e = openai.ChatC
-000010c0: 6f6d 706c 6574 696f 6e2e 6372 6561 7465  ompletion.create
-000010d0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-000010e0: 2020 206d 6f64 656c 3d6d 6f64 656c 2c0d     model=model,.
-000010f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001100: 206d 6573 7361 6765 733d 6d65 7373 6167   messages=messag
-00001110: 6573 2c0d 0a20 2020 2020 2020 2020 2020  es,..           
-00001120: 2020 2020 2074 656d 7065 7261 7475 7265       temperature
-00001130: 3d74 656d 7065 7261 7475 7265 2c0d 0a20  =temperature,.. 
-00001140: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00001150: 6178 5f74 6f6b 656e 733d 6d61 785f 746f  ax_tokens=max_to
-00001160: 6b65 6e73 2c0d 0a20 2020 2020 2020 2020  kens,..         
-00001170: 2020 2029 0d0a 2020 2020 2020 2020 6578     )..        ex
-00001180: 6365 7074 206f 7065 6e61 692e 6572 726f  cept openai.erro
-00001190: 722e 5261 7465 4c69 6d69 7445 7272 6f72  r.RateLimitError
-000011a0: 3a0d 0a20 2020 2020 2020 2020 2020 2070  :..            p
-000011b0: 7269 6e74 280d 0a20 2020 2020 2020 2020  rint(..         
-000011c0: 2020 2020 2020 2022 5468 6520 4f70 656e         "The Open
-000011d0: 4149 2041 5049 2072 6174 6520 6c69 6d69  AI API rate limi
-000011e0: 7420 6861 7320 6265 656e 2065 7863 6565  t has been excee
-000011f0: 6465 642e 2057 6169 7469 6e67 2031 3020  ded. Waiting 10 
-00001200: 7365 636f 6e64 7320 616e 6420 7472 7969  seconds and tryi
-00001210: 6e67 2061 6761 696e 2e22 0d0a 2020 2020  ng again."..    
-00001220: 2020 2020 2020 2020 290d 0a20 2020 2020          )..     
-00001230: 2020 2020 2020 2074 696d 652e 736c 6565         time.slee
-00001240: 7028 3130 290d 0a20 2020 2020 2020 2020  p(10)..         
-00001250: 2020 2072 6573 706f 6e73 6520 3d20 6f70     response = op
-00001260: 656e 6169 2e43 6861 7443 6f6d 706c 6574  enai.ChatComplet
-00001270: 696f 6e2e 6372 6561 7465 280d 0a20 2020  ion.create(..   
-00001280: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00001290: 656c 3d6d 6f64 656c 2c0d 0a20 2020 2020  el=model,..     
-000012a0: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-000012b0: 6765 733d 6d65 7373 6167 6573 2c0d 0a20  ges=messages,.. 
-000012c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000012d0: 656d 7065 7261 7475 7265 3d74 656d 7065  emperature=tempe
-000012e0: 7261 7475 7265 2c0d 0a20 2020 2020 2020  rature,..       
-000012f0: 2020 2020 2020 2020 206d 6178 5f74 6f6b           max_tok
-00001300: 656e 733d 6d61 785f 746f 6b65 6e73 2c0d  ens=max_tokens,.
-00001310: 0a20 2020 2020 2020 2020 2020 2029 0d0a  .            )..
-00001320: 2020 2020 2020 2020 2320 4578 6365 6564          # Exceed
-00001330: 6564 2074 6865 206d 6178 696d 756d 206e  ed the maximum n
-00001340: 756d 6265 7220 6f66 2074 6f6b 656e 7320  umber of tokens 
-00001350: 616c 6c6f 7765 6420 6279 2074 6865 2041  allowed by the A
-00001360: 5049 0d0a 2020 2020 2020 2020 6578 6365  PI..        exce
-00001370: 7074 206f 7065 6e61 692e 6572 726f 722e  pt openai.error.
-00001380: 496e 7661 6c69 6452 6571 7565 7374 4572  InvalidRequestEr
-00001390: 726f 723a 0d0a 2020 2020 2020 2020 2020  ror:..          
-000013a0: 2020 7072 696e 7428 0d0a 2020 2020 2020    print(..      
-000013b0: 2020 2020 2020 2020 2020 2254 6865 204f            "The O
-000013c0: 7065 6e41 4920 4150 4920 6d61 7869 6d75  penAI API maximu
-000013d0: 6d20 746f 6b65 6e73 206c 696d 6974 2068  m tokens limit h
-000013e0: 6173 2062 6565 6e20 6578 6365 6564 6564  as been exceeded
-000013f0: 2e20 5377 6974 6368 696e 6720 746f 2061  . Switching to a
-00001400: 2031 364b 206d 6f64 656c 2e22 0d0a 2020   16K model."..  
-00001410: 2020 2020 2020 2020 2020 290d 0a20 2020            )..   
-00001420: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-00001430: 6520 3d20 6f70 656e 6169 2e43 6861 7443  e = openai.ChatC
-00001440: 6f6d 706c 6574 696f 6e2e 6372 6561 7465  ompletion.create
-00001450: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
-00001460: 2020 206d 6f64 656c 3d73 656c 662e 6c6c     model=self.ll
-00001470: 6d5f 3136 6b2c 0d0a 2020 2020 2020 2020  m_16k,..        
-00001480: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-00001490: 3d6d 6573 7361 6765 732c 0d0a 2020 2020  =messages,..    
-000014a0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-000014b0: 6572 6174 7572 653d 7465 6d70 6572 6174  erature=temperat
-000014c0: 7572 652c 0d0a 2020 2020 2020 2020 2020  ure,..          
-000014d0: 2020 2020 2020 6d61 785f 746f 6b65 6e73        max_tokens
-000014e0: 3d6d 6178 5f74 6f6b 656e 732c 0d0a 2020  =max_tokens,..  
-000014f0: 2020 2020 2020 2020 2020 290d 0a0d 0a20            ).... 
-00001500: 2020 2020 2020 2063 6f6e 7465 6e74 203d         content =
-00001510: 2072 6573 706f 6e73 652e 6368 6f69 6365   response.choice
-00001520: 735b 305d 2e6d 6573 7361 6765 2e63 6f6e  s[0].message.con
-00001530: 7465 6e74 2e73 7472 6970 2829 0d0a 2020  tent.strip()..  
-00001540: 2020 2020 2020 746f 6b65 6e73 5f75 7365        tokens_use
-00001550: 6420 3d20 7265 7370 6f6e 7365 2e75 7361  d = response.usa
-00001560: 6765 2e74 6f74 616c 5f74 6f6b 656e 730d  ge.total_tokens.
-00001570: 0a0d 0a20 2020 2020 2020 2072 6574 7572  ...        retur
-00001580: 6e20 636f 6e74 656e 742c 2074 6f6b 656e  n content, token
-00001590: 735f 7573 6564 0d0a 2020 2020 0d0a 2020  s_used..    ..  
-000015a0: 2020 6465 6620 6c6c 6d5f 6675 6e63 5f63    def llm_func_c
-000015b0: 616c 6c28 7365 6c66 2c20 6d65 7373 6167  all(self, messag
-000015c0: 6573 2c20 6675 6e63 7469 6f6e 732c 2066  es, functions, f
-000015d0: 756e 6374 696f 6e5f 6e61 6d65 293a 0d0a  unction_name):..
-000015e0: 2020 2020 2020 2020 7472 793a 0d0a 2020          try:..  
-000015f0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
-00001600: 7365 203d 206f 7065 6e61 692e 4368 6174  se = openai.Chat
-00001610: 436f 6d70 6c65 7469 6f6e 2e63 7265 6174  Completion.creat
-00001620: 6528 0d0a 2020 2020 2020 2020 2020 2020  e(..            
-00001630: 6d6f 6465 6c20 3d20 7365 6c66 2e6c 6c6d  model = self.llm
-00001640: 5f66 756e 632c 0d0a 2020 2020 2020 2020  _func,..        
-00001650: 2020 2020 6d65 7373 6167 6573 3d6d 6573      messages=mes
-00001660: 7361 6765 732c 0d0a 2020 2020 2020 2020  sages,..        
-00001670: 2020 2020 6675 6e63 7469 6f6e 733d 6675      functions=fu
-00001680: 6e63 7469 6f6e 732c 0d0a 2020 2020 2020  nctions,..      
-00001690: 2020 2020 2020 6675 6e63 7469 6f6e 5f63        function_c
-000016a0: 616c 6c20 3d20 6675 6e63 7469 6f6e 5f6e  all = function_n
-000016b0: 616d 652c 0d0a 2020 2020 2020 2020 2020  ame,..          
-000016c0: 2020 7465 6d70 6572 6174 7572 653d 302c    temperature=0,
-000016d0: 0d0a 2020 2020 2020 2020 2020 2020 6d61  ..            ma
-000016e0: 785f 746f 6b65 6e73 203d 2037 3030 2c20  x_tokens = 700, 
-000016f0: 0d0a 2020 2020 2020 2020 2020 2020 290d  ..            ).
-00001700: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00001710: 6f70 656e 6169 2e65 7272 6f72 2e52 6174  openai.error.Rat
-00001720: 654c 696d 6974 4572 726f 723a 0d0a 2020  eLimitError:..  
-00001730: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00001740: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00001750: 2020 2254 6865 204f 7065 6e41 4920 4150    "The OpenAI AP
-00001760: 4920 7261 7465 206c 696d 6974 2068 6173  I rate limit has
-00001770: 2062 6565 6e20 6578 6365 6564 6564 2e20   been exceeded. 
-00001780: 5761 6974 696e 6720 3130 2073 6563 6f6e  Waiting 10 secon
-00001790: 6473 2061 6e64 2074 7279 696e 6720 6167  ds and trying ag
-000017a0: 6169 6e2e 220d 0a20 2020 2020 2020 2020  ain."..         
-000017b0: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
-000017c0: 2020 7469 6d65 2e73 6c65 6570 2831 3029    time.sleep(10)
-000017d0: 0d0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-000017e0: 7370 6f6e 7365 203d 206f 7065 6e61 692e  sponse = openai.
-000017f0: 4368 6174 436f 6d70 6c65 7469 6f6e 2e63  ChatCompletion.c
-00001800: 7265 6174 6528 0d0a 2020 2020 2020 2020  reate(..        
-00001810: 2020 2020 6d6f 6465 6c20 3d20 7365 6c66      model = self
-00001820: 2e6c 6c6d 5f66 756e 632c 0d0a 2020 2020  .llm_func,..    
-00001830: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-00001840: 3d6d 6573 7361 6765 732c 0d0a 2020 2020  =messages,..    
-00001850: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
-00001860: 733d 6675 6e63 7469 6f6e 732c 0d0a 2020  s=functions,..  
-00001870: 2020 2020 2020 2020 2020 6675 6e63 7469            functi
-00001880: 6f6e 5f63 616c 6c20 3d20 6675 6e63 7469  on_call = functi
-00001890: 6f6e 5f6e 616d 652c 0d0a 2020 2020 2020  on_name,..      
-000018a0: 2020 2020 2020 7465 6d70 6572 6174 7572        temperatur
-000018b0: 653d 302c 0d0a 2020 2020 2020 2020 2020  e=0,..          
-000018c0: 2020 290d 0a20 2020 2020 2020 200d 0a20    )..        .. 
-000018d0: 2020 2020 2020 2066 6e5f 6e61 6d65 203d         fn_name =
-000018e0: 2072 6573 706f 6e73 652e 6368 6f69 6365   response.choice
-000018f0: 735b 305d 2e6d 6573 7361 6765 5b22 6675  s[0].message["fu
-00001900: 6e63 7469 6f6e 5f63 616c 6c22 5d2e 6e61  nction_call"].na
-00001910: 6d65 0d0a 2020 2020 2020 2020 6172 6775  me..        argu
-00001920: 6d65 6e74 7320 3d20 7265 7370 6f6e 7365  ments = response
-00001930: 2e63 686f 6963 6573 5b30 5d2e 6d65 7373  .choices[0].mess
-00001940: 6167 655b 2266 756e 6374 696f 6e5f 6361  age["function_ca
-00001950: 6c6c 225d 2e61 7267 756d 656e 7473 0d0a  ll"].arguments..
-00001960: 2020 2020 2020 2020 746f 6b65 6e73 5f75          tokens_u
-00001970: 7365 6420 3d20 7265 7370 6f6e 7365 2e75  sed = response.u
-00001980: 7361 6765 2e74 6f74 616c 5f74 6f6b 656e  sage.total_token
-00001990: 730d 0a0d 0a20 2020 2020 2020 2072 6574  s....        ret
-000019a0: 7572 6e20 666e 5f6e 616d 652c 6172 6775  urn fn_name,argu
-000019b0: 6d65 6e74 732c 746f 6b65 6e73 5f75 7365  ments,tokens_use
-000019c0: 640d 0a0d 0a20 2020 200d 0a20 2020 2023  d....    ..    #
-000019d0: 2046 756e 6374 696f 6e73 2074 6f20 7361   Functions to sa
-000019e0: 6e69 7469 7a65 2074 6865 206f 7574 7075  nitize the outpu
-000019f0: 7420 6672 6f6d 2074 6865 204c 4c4d 0d0a  t from the LLM..
-00001a00: 2020 2020 6465 6620 5f65 7874 7261 6374      def _extract
-00001a10: 5f63 6f64 6528 7365 6c66 2c72 6573 706f  _code(self,respo
-00001a20: 6e73 653a 2073 7472 2c20 7365 7061 7261  nse: str, separa
-00001a30: 746f 723a 2073 7472 203d 2022 6060 6022  tor: str = "```"
-00001a40: 2920 2d3e 2073 7472 3a0d 0a0d 0a20 2020  ) -> str:....   
-00001a50: 2020 2020 2023 2044 6566 696e 6520 6120       # Define a 
-00001a60: 626c 6163 6b6c 6973 7420 6f66 2050 7974  blacklist of Pyt
-00001a70: 686f 6e20 6b65 7977 6f72 6473 2061 6e64  hon keywords and
-00001a80: 2066 756e 6374 696f 6e73 2074 6861 7420   functions that 
-00001a90: 6172 6520 6e6f 7420 616c 6c6f 7765 640d  are not allowed.
-00001aa0: 0a20 2020 2020 2020 2062 6c61 636b 6c69  .        blackli
-00001ab0: 7374 203d 205b 276f 7327 2c27 7375 6270  st = ['os','subp
-00001ac0: 726f 6365 7373 272c 2773 7973 272c 2765  rocess','sys','e
-00001ad0: 7661 6c27 2c27 6578 6563 272c 2766 696c  val','exec','fil
-00001ae0: 6527 2c27 736f 636b 6574 272c 2775 726c  e','socket','url
-00001af0: 6c69 6227 2c0d 0a20 2020 2020 2020 2020  lib',..         
-00001b00: 2020 2020 2020 2020 2020 2027 7368 7574             'shut
-00001b10: 696c 272c 2770 6963 6b6c 6527 2c27 6374  il','pickle','ct
-00001b20: 7970 6573 272c 276d 756c 7469 7072 6f63  ypes','multiproc
-00001b30: 6573 7369 6e67 272c 2774 656d 7066 696c  essing','tempfil
-00001b40: 6527 2c27 676c 6f62 272c 2763 6f64 6527  e','glob','code'
-00001b50: 2c27 7074 7927 2c27 636f 6d6d 616e 6473  ,'pty','commands
-00001b60: 272c 0d0a 2020 2020 2020 2020 2020 2020  ',..            
-00001b70: 2020 2020 2020 2020 2772 6571 7565 7374          'request
-00001b80: 7327 2c27 6367 6927 2c27 6367 6974 6227  s','cgi','cgitb'
-00001b90: 2c27 786d 6c2e 6574 7265 652e 456c 656d  ,'xml.etree.Elem
-00001ba0: 656e 7454 7265 6527 2c27 6275 696c 7469  entTree','builti
-00001bb0: 6e73 270d 0a20 2020 2020 2020 2020 2020  ns'..           
-00001bc0: 2020 2020 2020 2020 205d 0d0a 0d0a 2020           ]....  
-00001bd0: 2020 2020 2020 2320 5365 6172 6368 2066        # Search f
-00001be0: 6f72 2061 2070 6174 7465 726e 2062 6574  or a pattern bet
-00001bf0: 7765 656e 203c 636f 6465 3e20 616e 6420  ween <code> and 
-00001c00: 3c2f 636f 6465 3e20 696e 2074 6865 2065  </code> in the e
-00001c10: 7874 7261 6374 6564 2063 6f64 650d 0a20  xtracted code.. 
-00001c20: 2020 2020 2020 206d 6174 6368 203d 2072         match = r
-00001c30: 652e 7365 6172 6368 2872 223c 636f 6465  e.search(r"<code
-00001c40: 3e28 2e2a 293c 2f63 6f64 653e 222c 2072  >(.*)</code>", r
-00001c50: 6573 706f 6e73 652c 2072 652e 444f 5441  esponse, re.DOTA
-00001c60: 4c4c 290d 0a20 2020 2020 2020 2069 6620  LL)..        if 
-00001c70: 6d61 7463 683a 0d0a 2020 2020 2020 2020  match:..        
-00001c80: 2020 2020 2320 4966 2061 206d 6174 6368      # If a match
-00001c90: 2069 7320 666f 756e 642c 2065 7874 7261   is found, extra
-00001ca0: 6374 2074 6865 2063 6f64 6520 6265 7477  ct the code betw
-00001cb0: 6565 6e20 3c63 6f64 653e 2061 6e64 203c  een <code> and <
-00001cc0: 2f63 6f64 653e 0d0a 2020 2020 2020 2020  /code>..        
-00001cd0: 2020 2020 636f 6465 203d 206d 6174 6368      code = match
-00001ce0: 2e67 726f 7570 2831 290d 0a20 2020 2020  .group(1)..     
-00001cf0: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
-00001d00: 7265 7370 6f6e 7365 2063 6f6e 7461 696e  response contain
-00001d10: 7320 7468 6520 7365 7061 7261 746f 722c  s the separator,
-00001d20: 2065 7874 7261 6374 2074 6865 2063 6f64   extract the cod
-00001d30: 6520 626c 6f63 6b20 6265 7477 6565 6e20  e block between 
-00001d40: 7468 6520 7365 7061 7261 746f 7273 0d0a  the separators..
-00001d50: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00001d60: 656e 2863 6f64 652e 7370 6c69 7428 7365  en(code.split(se
-00001d70: 7061 7261 746f 7229 2920 3e20 313a 0d0a  parator)) > 1:..
-00001d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d90: 636f 6465 203d 2063 6f64 652e 7370 6c69  code = code.spli
-00001da0: 7428 7365 7061 7261 746f 7229 5b31 5d0d  t(separator)[1].
-00001db0: 0a0d 0a20 2020 2020 2020 2023 2049 6620  ...        # If 
-00001dc0: 7468 6520 7265 7370 6f6e 7365 2063 6f6e  the response con
-00001dd0: 7461 696e 7320 7468 6520 7365 7061 7261  tains the separa
-00001de0: 746f 722c 2065 7874 7261 6374 2074 6865  tor, extract the
-00001df0: 2063 6f64 6520 626c 6f63 6b20 6265 7477   code block betw
-00001e00: 6565 6e20 7468 6520 7365 7061 7261 746f  een the separato
-00001e10: 7273 0d0a 2020 2020 2020 2020 6966 206c  rs..        if l
-00001e20: 656e 2872 6573 706f 6e73 652e 7370 6c69  en(response.spli
-00001e30: 7428 7365 7061 7261 746f 7229 2920 3e20  t(separator)) > 
-00001e40: 313a 0d0a 2020 2020 2020 2020 2020 2020  1:..            
-00001e50: 636f 6465 203d 2072 6573 706f 6e73 652e  code = response.
-00001e60: 7370 6c69 7428 7365 7061 7261 746f 7229  split(separator)
-00001e70: 5b31 5d0d 0a20 2020 2020 2020 2020 2020  [1]..           
-00001e80: 200d 0a20 2020 2020 2020 2023 2052 656d   ..        # Rem
-00001e90: 6f76 6520 7468 6520 2270 7974 686f 6e22  ove the "python"
-00001ea0: 206f 7220 2270 7922 2070 7265 6669 7820   or "py" prefix 
-00001eb0: 6966 2070 7265 7365 6e74 0d0a 2020 2020  if present..    
-00001ec0: 2020 2020 6966 2072 652e 6d61 7463 6828      if re.match(
-00001ed0: 7222 5e28 7079 7468 6f6e 7c70 7929 222c  r"^(python|py)",
-00001ee0: 2063 6f64 6529 3a0d 0a20 2020 2020 2020   code):..       
-00001ef0: 2020 2020 2063 6f64 6520 3d20 7265 2e73       code = re.s
-00001f00: 7562 2872 225e 2870 7974 686f 6e7c 7079  ub(r"^(python|py
-00001f10: 2922 2c20 2222 2c20 636f 6465 290d 0a20  )", "", code).. 
-00001f20: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
-00001f30: 636f 6465 2069 7320 6265 7477 6565 6e20  code is between 
-00001f40: 7369 6e67 6c65 2062 6163 6b74 6963 6b73  single backticks
-00001f50: 2c20 6578 7472 6163 7420 7468 6520 636f  , extract the co
-00001f60: 6465 2062 6574 7765 656e 2074 6865 6d0d  de between them.
-00001f70: 0a20 2020 2020 2020 2069 6620 7265 2e6d  .        if re.m
-00001f80: 6174 6368 2872 225e 602e 2a60 2422 2c20  atch(r"^`.*`$", 
-00001f90: 636f 6465 293a 0d0a 2020 2020 2020 2020  code):..        
-00001fa0: 2020 2020 636f 6465 203d 2072 652e 7375      code = re.su
-00001fb0: 6228 7222 5e60 282e 2a29 6024 222c 2072  b(r"^`(.*)`$", r
-00001fc0: 225c 3122 2c20 636f 6465 290d 0a0d 0a20  "\1", code).... 
-00001fd0: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
-00001fe0: 616e 7920 696e 7374 616e 6365 7320 6f66  any instances of
-00001ff0: 2022 6466 203d 2070 642e 7265 6164 5f63   "df = pd.read_c
-00002000: 7376 2827 6669 6c65 6e61 6d65 2e63 7376  sv('filename.csv
-00002010: 2729 2220 6672 6f6d 2074 6865 2063 6f64  ')" from the cod
-00002020: 650d 0a20 2020 2020 2020 2063 6f64 6520  e..        code 
-00002030: 3d20 7265 2e73 7562 2872 2264 665c 732a  = re.sub(r"df\s*
-00002040: 3d5c 732a 7064 5c2e 7265 6164 5f63 7376  =\s*pd\.read_csv
-00002050: 5c28 272e 2a3f 2728 2c2e 2a29 3f5c 2922  \('.*?'(,.*)?\)"
-00002060: 2c20 2222 2c20 636f 6465 290d 0a0d 0a20  , "", code).... 
-00002070: 2020 2020 2020 2023 2044 6566 696e 6520         # Define 
-00002080: 7468 6520 7265 6775 6c61 7220 6578 7072  the regular expr
-00002090: 6573 7369 6f6e 2070 6174 7465 726e 2074  ession pattern t
-000020a0: 6f20 6d61 7463 6820 7468 6520 626c 6163  o match the blac
-000020b0: 6b6c 6973 7420 6974 656d 730d 0a20 2020  klist items..   
-000020c0: 2020 2020 2070 6174 7465 726e 203d 2072       pattern = r
-000020d0: 225e 282e 2a5c 6228 2220 2b20 227c 222e  "^(.*\b(" + "|".
-000020e0: 6a6f 696e 2862 6c61 636b 6c69 7374 2920  join(blacklist) 
-000020f0: 2b20 7222 295c 622e 2a29 2422 0d0a 0d0a  + r")\b.*)$"....
-00002100: 2020 2020 2020 2020 2320 5265 706c 6163          # Replac
-00002110: 6520 7468 6520 626c 6163 6b6c 6973 7420  e the blacklist 
-00002120: 6974 656d 7320 7769 7468 2063 6f6d 6d65  items with comme
-00002130: 6e74 730d 0a20 2020 2020 2020 2063 6f64  nts..        cod
-00002140: 6520 3d20 7265 2e73 7562 2870 6174 7465  e = re.sub(patte
-00002150: 726e 2c20 7222 2320 6e6f 7420 616c 6c6f  rn, r"# not allo
-00002160: 7765 6420 5c31 222c 2063 6f64 652c 2066  wed \1", code, f
-00002170: 6c61 6773 3d72 652e 4d55 4c54 494c 494e  lags=re.MULTILIN
-00002180: 4529 0d0a 0d0a 2020 2020 2020 2020 2320  E)....        # 
-00002190: 5265 7475 726e 2074 6865 2063 6c65 616e  Return the clean
-000021a0: 6564 2061 6e64 2065 7874 7261 6374 6564  ed and extracted
-000021b0: 2063 6f64 650d 0a20 2020 2020 2020 2072   code..        r
-000021c0: 6574 7572 6e20 636f 6465 2e73 7472 6970  eturn code.strip
-000021d0: 2829 0d0a 2020 2020 0d0a 2020 2020 6465  ()..    ..    de
-000021e0: 6620 5f65 7874 7261 6374 5f72 616e 6b28  f _extract_rank(
-000021f0: 7365 6c66 2c72 6573 706f 6e73 653a 2073  self,response: s
-00002200: 7472 2920 2d3e 2073 7472 3a0d 0a0d 0a20  tr) -> str:.... 
-00002210: 2020 2020 2020 2023 2053 6561 7263 6820         # Search 
-00002220: 666f 7220 6120 7061 7474 6572 6e20 6265  for a pattern be
-00002230: 7477 6565 6e20 3c72 616e 6b3e 2061 6e64  tween <rank> and
-00002240: 203c 2f72 616e 6b3e 2069 6e20 7468 6520   </rank> in the 
-00002250: 7265 7370 6f6e 7365 0d0a 2020 2020 2020  response..      
-00002260: 2020 6d61 7463 6820 3d20 7265 2e73 6561    match = re.sea
-00002270: 7263 6828 7222 3c72 616e 6b3e 282e 2a29  rch(r"<rank>(.*)
-00002280: 3c2f 7261 6e6b 3e22 2c20 7265 7370 6f6e  </rank>", respon
-00002290: 7365 290d 0a20 2020 2020 2020 2069 6620  se)..        if 
-000022a0: 6d61 7463 683a 0d0a 2020 2020 2020 2020  match:..        
-000022b0: 2020 2020 2320 4966 2061 206d 6174 6368      # If a match
-000022c0: 2069 7320 666f 756e 642c 2065 7874 7261   is found, extra
-000022d0: 6374 2074 6865 2072 616e 6b20 6265 7477  ct the rank betw
-000022e0: 6565 6e20 3c72 616e 6b3e 2061 6e64 203c  een <rank> and <
-000022f0: 2f72 616e 6b3e 0d0a 2020 2020 2020 2020  /rank>..        
-00002300: 2020 2020 7261 6e6b 203d 206d 6174 6368      rank = match
-00002310: 2e67 726f 7570 2831 290d 0a20 2020 2020  .group(1)..     
-00002320: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
-00002330: 2020 2020 2020 7261 6e6b 203d 2022 220d        rank = "".
-00002340: 0a0d 0a20 2020 2020 2020 2023 2052 6574  ...        # Ret
-00002350: 7572 6e20 7468 6520 636c 6561 6e65 6420  urn the cleaned 
-00002360: 616e 6420 6578 7472 6163 7465 6420 636f  and extracted co
-00002370: 6465 0d0a 2020 2020 2020 2020 7265 7475  de..        retu
-00002380: 726e 2072 616e 6b2e 7374 7269 7028 290d  rn rank.strip().
-00002390: 0a20 2020 200d 0a20 2020 2023 2046 756e  .    ..    # Fun
-000023a0: 6374 696f 6e20 746f 2072 656d 6f76 6520  ction to remove 
-000023b0: 6578 616d 706c 6573 2066 726f 6d20 6d65  examples from me
-000023c0: 7373 6167 6573 2077 6865 6e20 6e6f 206c  ssages when no l
-000023d0: 6f6e 6765 7220 6e65 6564 6564 0d0a 2020  onger needed..  
-000023e0: 2020 6465 6620 5f72 656d 6f76 655f 6578    def _remove_ex
-000023f0: 616d 706c 6573 2873 656c 662c 6d65 7373  amples(self,mess
-00002400: 6167 6573 3a20 7374 7229 202d 3e20 7374  ages: str) -> st
-00002410: 723a 0d0a 2020 2020 2020 2020 2320 4465  r:..        # De
-00002420: 6669 6e65 2074 6865 2072 6567 756c 6172  fine the regular
-00002430: 2065 7870 7265 7373 696f 6e20 7061 7474   expression patt
-00002440: 6572 6e0d 0a20 2020 2020 2020 2070 6174  ern..        pat
-00002450: 7465 726e 203d 2027 4578 616d 706c 6520  tern = 'Example 
-00002460: 4f75 7470 7574 3a5c 732a 3c63 6f64 653e  Output:\s*<code>
-00002470: 2e2a 3f3c 2f63 6f64 653e 5c73 2a27 0d0a  .*?</code>\s*'..
-00002480: 0d0a 2020 2020 2020 2020 2320 4974 6572  ..        # Iter
-00002490: 6174 6520 6f76 6572 2074 6865 206c 6973  ate over the lis
-000024a0: 7420 6f66 2064 6963 7469 6f6e 6172 6965  t of dictionarie
-000024b0: 730d 0a20 2020 2020 2020 2066 6f72 2064  s..        for d
-000024c0: 6963 7420 696e 206d 6573 7361 6765 733a  ict in messages:
-000024d0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000024e0: 4163 6365 7373 2061 6e64 2063 6c65 616e  Access and clean
-000024f0: 2075 7020 2763 6f6e 7465 6e74 2720 6669   up 'content' fi
-00002500: 656c 640d 0a20 2020 2020 2020 2020 2020  eld..           
-00002510: 2069 6620 6469 6374 2e67 6574 2827 726f   if dict.get('ro
-00002520: 6c65 2729 203d 3d20 2775 7365 7227 2061  le') == 'user' a
-00002530: 6e64 2027 636f 6e74 656e 7427 2069 6e20  nd 'content' in 
-00002540: 6469 6374 3a0d 0a20 2020 2020 2020 2020  dict:..         
-00002550: 2020 2020 2020 2064 6963 745b 2763 6f6e         dict['con
-00002560: 7465 6e74 275d 203d 2072 652e 7375 6228  tent'] = re.sub(
-00002570: 7061 7474 6572 6e2c 2027 272c 2064 6963  pattern, '', dic
-00002580: 745b 2763 6f6e 7465 6e74 275d 2c20 666c  t['content'], fl
-00002590: 6167 733d 7265 2e44 4f54 414c 4c29 0d0a  ags=re.DOTALL)..
-000025a0: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000025b0: 206d 6573 7361 6765 730d 0a20 2020 200d   messages..    .
-000025c0: 0a20 2020 2064 6566 2074 6173 6b5f 6576  .    def task_ev
-000025d0: 616c 2873 656c 662c 2065 7661 6c5f 6d65  al(self, eval_me
-000025e0: 7373 6167 6573 293a 0d0a 0d0a 2020 2020  ssages):....    
-000025f0: 2020 2020 6966 2027 6970 796b 6572 6e65      if 'ipykerne
-00002600: 6c27 2069 6e20 7379 732e 6d6f 6475 6c65  l' in sys.module
-00002610: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-00002620: 2320 4a75 7079 7465 7220 6e6f 7465 626f  # Jupyter notebo
-00002630: 6f6b 206f 7220 6970 7974 686f 6e0d 0a20  ok or ipython.. 
-00002640: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-00002650: 6179 2848 544d 4c28 6627 3c70 2073 7479  ay(HTML(f'<p sty
-00002660: 6c65 3d22 636f 6c6f 723a 6d61 6765 6e74  le="color:magent
-00002670: 613b 223e 5c6e 4361 6c6c 696e 6720 4d6f  a;">\nCalling Mo
-00002680: 6465 6c3a 207b 7365 6c66 2e6c 6c6d 5f66  del: {self.llm_f
-00002690: 756e 637d 3c2f 703e 2729 290d 0a20 2020  unc}</p>'))..   
-000026a0: 2020 2020 2020 2020 2064 6973 706c 6179           display
-000026b0: 2848 544d 4c28 6627 3c70 3e3c 6220 7374  (HTML(f'<p><b st
-000026c0: 796c 653d 2263 6f6c 6f72 3a6d 6167 656e  yle="color:magen
-000026d0: 7461 3b22 3e54 7279 696e 6720 746f 2064  ta;">Trying to d
-000026e0: 6574 6572 6d69 6e65 2074 6865 2062 6573  etermine the bes
-000026f0: 7420 6d65 7468 6f64 2074 6f20 616e 7377  t method to answ
-00002700: 6572 2079 6f75 7220 7175 6573 7469 6f6e  er your question
-00002710: 2c20 706c 6561 7365 2077 6169 742e 2e2e  , please wait...
-00002720: 3c2f 623e 3c2f 703e 3c62 723e 2729 290d  </b></p><br>')).
-00002730: 0a20 2020 2020 2020 2065 6c73 653a 0d0a  .        else:..
-00002740: 2020 2020 2020 2020 2020 2020 2320 4f74              # Ot
-00002750: 6865 7220 656e 7669 726f 6e6d 656e 7420  her environment 
-00002760: 286c 696b 6520 7465 726d 696e 616c 290d  (like terminal).
-00002770: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00002780: 6e74 2863 6f6c 6f72 6564 2866 225c 6e3e  nt(colored(f"\n>
-00002790: 3e20 4361 6c6c 696e 6720 4d6f 6465 6c3a  > Calling Model:
-000027a0: 207b 7365 6c66 2e6c 6c6d 5f66 756e 637d   {self.llm_func}
-000027b0: 222c 2022 6d61 6765 6e74 6122 2929 0d0a  ", "magenta"))..
-000027c0: 2020 2020 2020 2020 2020 2020 6370 7269              cpri
-000027d0: 6e74 2866 225c 6e3e 3e20 5472 7969 6e67  nt(f"\n>> Trying
-000027e0: 2074 6f20 6465 7465 726d 696e 6520 7468   to determine th
-000027f0: 6520 6265 7374 206d 6574 686f 6420 746f  e best method to
-00002800: 2061 6e73 7765 7220 796f 7572 2071 7565   answer your que
-00002810: 7374 696f 6e2c 2070 6c65 6173 6520 7761  stion, please wa
-00002820: 6974 2e2e 2e5c 6e22 2c20 276d 6167 656e  it...\n", 'magen
-00002830: 7461 272c 2061 7474 7273 3d5b 2762 6f6c  ta', attrs=['bol
-00002840: 6427 5d29 0d0a 0d0a 2020 2020 2020 2020  d'])....        
-00002850: 2320 4361 6c6c 204f 7065 6e41 4920 4150  # Call OpenAI AP
-00002860: 490d 0a20 2020 2020 2020 2066 756e 6374  I..        funct
-00002870: 696f 6e5f 6e61 6d65 203d 207b 226e 616d  ion_name = {"nam
-00002880: 6522 3a20 2251 415f 5265 7370 6f6e 7365  e": "QA_Response
-00002890: 227d 0d0a 2020 2020 2020 2020 666e 5f6e  "}..        fn_n
-000028a0: 616d 652c 2061 7267 756d 656e 7473 2c20  ame, arguments, 
-000028b0: 746f 6b65 6e73 5f75 7365 6420 3d20 7365  tokens_used = se
-000028c0: 6c66 2e6c 6c6d 5f66 756e 635f 6361 6c6c  lf.llm_func_call
-000028d0: 2865 7661 6c5f 6d65 7373 6167 6573 2c73  (eval_messages,s
-000028e0: 656c 662e 7461 736b 5f65 7661 6c5f 6675  elf.task_eval_fu
-000028f0: 6e63 7469 6f6e 2c20 6675 6e63 7469 6f6e  nction, function
-00002900: 5f6e 616d 6529 0d0a 0d0a 2020 2020 2020  _name)....      
-00002910: 2020 2320 5061 7273 6520 7468 6520 4a53    # Parse the JS
-00002920: 4f4e 2073 7472 696e 6720 746f 2061 2050  ON string to a P
-00002930: 7974 686f 6e20 6469 6374 0d0a 2020 2020  ython dict..    
-00002940: 2020 2020 6172 6775 6d65 6e74 735f 6469      arguments_di
-00002950: 6374 203d 206a 736f 6e2e 6c6f 6164 7328  ct = json.loads(
-00002960: 6172 6775 6d65 6e74 732c 2073 7472 6963  arguments, stric
-00002970: 743d 4661 6c73 6529 0d0a 0d0a 2020 2020  t=False)....    
-00002980: 2020 2020 2320 5265 7472 6965 7665 2076      # Retrieve v
-00002990: 616c 7565 730d 0a20 2020 2020 2020 2065  alues..        e
-000029a0: 7661 6c5f 616e 7377 6572 203d 2061 7267  val_answer = arg
-000029b0: 756d 656e 7473 5f64 6963 745b 2261 6e73  uments_dict["ans
-000029c0: 7765 7222 5d0d 0a20 2020 2020 2020 2065  wer"]..        e
-000029d0: 7661 6c5f 616e 7377 6572 5f74 7970 6520  val_answer_type 
-000029e0: 3d20 6172 6775 6d65 6e74 735f 6469 6374  = arguments_dict
-000029f0: 5b22 616e 7377 6572 5f74 7970 6522 5d0d  ["answer_type"].
-00002a00: 0a0d 0a20 2020 2020 2020 2073 656c 662e  ...        self.
-00002a10: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
-00002a20: 642e 6170 7065 6e64 2874 6f6b 656e 735f  d.append(tokens_
-00002a30: 7573 6564 290d 0a0d 0a20 2020 2020 2020  used)....       
-00002a40: 2072 6574 7572 6e20 6172 6775 6d65 6e74   return argument
-00002a50: 732c 2066 6e5f 6e61 6d65 2c20 6576 616c  s, fn_name, eval
-00002a60: 5f61 6e73 7765 722c 2065 7661 6c5f 616e  _answer, eval_an
-00002a70: 7377 6572 5f74 7970 650d 0a0d 0a20 2020  swer_type....   
-00002a80: 2064 6566 2064 6562 7567 5f63 6f64 6528   def debug_code(
-00002a90: 7365 6c66 2c63 6f64 652c 7175 6573 7469  self,code,questi
-00002aa0: 6f6e 2c20 6c6c 6d5f 6361 7363 6164 653d  on, llm_cascade=
-00002ab0: 4661 6c73 6529 3a0d 0a20 2020 2020 2020  False):..       
-00002ac0: 2023 2049 6e69 7469 616c 697a 6520 7468   # Initialize th
-00002ad0: 6520 6d65 7373 6167 6573 206c 6973 7420  e messages list 
-00002ae0: 7769 7468 2061 2073 7973 7465 6d20 6d65  with a system me
-00002af0: 7373 6167 6520 636f 6e74 6169 6e69 6e67  ssage containing
-00002b00: 2074 6865 2074 6173 6b20 7072 6f6d 7074   the task prompt
-00002b10: 0d0a 2020 2020 2020 2020 6465 6275 675f  ..        debug_
-00002b20: 6d65 7373 6167 6573 203d 205b 7b22 726f  messages = [{"ro
-00002b30: 6c65 223a 2022 7379 7374 656d 222c 2022  le": "system", "
-00002b40: 636f 6e74 656e 7422 3a20 7365 6c66 2e64  content": self.d
-00002b50: 6562 7567 5f63 6f64 655f 7461 736b 2e66  ebug_code_task.f
-00002b60: 6f72 6d61 7428 636f 6465 2c71 7565 7374  ormat(code,quest
-00002b70: 696f 6e29 7d5d 0d0a 0d0a 2020 2020 2020  ion)}]....      
-00002b80: 2020 7573 696e 675f 6d6f 6465 6c20 3d20    using_model = 
-00002b90: 7365 6c66 2e6c 6c6d 0d0a 2020 2020 2020  self.llm..      
-00002ba0: 2020 6966 206c 6c6d 5f63 6173 6361 6465    if llm_cascade
-00002bb0: 3a0d 0a20 2020 2020 2020 2020 2020 2075  :..            u
-00002bc0: 7369 6e67 5f6d 6f64 656c 203d 2073 656c  sing_model = sel
-00002bd0: 662e 6c6c 6d5f 6770 7434 0d0a 0d0a 2020  f.llm_gpt4....  
-00002be0: 2020 2020 2020 6966 2027 6970 796b 6572        if 'ipyker
-00002bf0: 6e65 6c27 2069 6e20 7379 732e 6d6f 6475  nel' in sys.modu
-00002c00: 6c65 733a 0d0a 2020 2020 2020 2020 2020  les:..          
-00002c10: 2020 2320 4a75 7079 7465 7220 6e6f 7465    # Jupyter note
-00002c20: 626f 6f6b 206f 7220 6970 7974 686f 6e0d  book or ipython.
-00002c30: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-00002c40: 706c 6179 2848 544d 4c28 6627 3c70 2073  play(HTML(f'<p s
-00002c50: 7479 6c65 3d22 636f 6c6f 723a 6d61 6765  tyle="color:mage
-00002c60: 6e74 613b 223e 5c6e 4361 6c6c 696e 6720  nta;">\nCalling 
-00002c70: 4d6f 6465 6c3a 207b 7573 696e 675f 6d6f  Model: {using_mo
-00002c80: 6465 6c7d 3c2f 703e 2729 290d 0a20 2020  del}</p>'))..   
-00002c90: 2020 2020 2020 2020 2064 6973 706c 6179           display
-00002ca0: 2848 544d 4c28 6627 3c70 3e3c 6220 7374  (HTML(f'<p><b st
-00002cb0: 796c 653d 2263 6f6c 6f72 3a6d 6167 656e  yle="color:magen
-00002cc0: 7461 3b22 3e49 2068 6176 6520 7265 6365  ta;">I have rece
-00002cd0: 6976 6564 2074 6865 2066 6972 7374 2076  ived the first v
-00002ce0: 6572 7369 6f6e 206f 6620 7468 6520 636f  ersion of the co
-00002cf0: 6465 2e20 4920 616d 2073 656e 6469 6e67  de. I am sending
-00002d00: 2069 7420 6261 636b 2074 6f20 4c4c 4d20   it back to LLM 
-00002d10: 746f 2067 6574 2069 7420 6368 6563 6b65  to get it checke
-00002d20: 6420 666f 7220 616e 7920 6572 726f 7273  d for any errors
-00002d30: 2c20 6275 6773 206f 7220 696e 636f 6e73  , bugs or incons
-00002d40: 6973 7465 6e63 6965 732c 2061 6e64 2063  istencies, and c
-00002d50: 6f72 7265 6374 696f 6e20 6966 206e 6563  orrection if nec
-00002d60: 6573 7361 7279 2e20 506c 6561 7365 2077  essary. Please w
-00002d70: 6169 742e 2e2e 3c2f 623e 3c2f 703e 3c62  ait...</b></p><b
-00002d80: 723e 2729 290d 0a20 2020 2020 2020 2065  r>'))..        e
-00002d90: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
-00002da0: 2020 2320 4f74 6865 7220 656e 7669 726f    # Other enviro
-00002db0: 6e6d 656e 7420 286c 696b 6520 7465 726d  nment (like term
-00002dc0: 696e 616c 290d 0a20 2020 2020 2020 2020  inal)..         
-00002dd0: 2020 2070 7269 6e74 2863 6f6c 6f72 6564     print(colored
-00002de0: 2866 225c 6e3e 3e20 4361 6c6c 696e 6720  (f"\n>> Calling 
-00002df0: 4d6f 6465 6c3a 207b 7573 696e 675f 6d6f  Model: {using_mo
-00002e00: 6465 6c7d 222c 2022 6d61 6765 6e74 6122  del}", "magenta"
-00002e10: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
-00002e20: 6370 7269 6e74 2866 225c 6e3e 3e20 4920  cprint(f"\n>> I 
-00002e30: 6861 7665 2072 6563 6569 7665 6420 7468  have received th
-00002e40: 6520 6669 7273 7420 7665 7273 696f 6e20  e first version 
-00002e50: 6f66 2074 6865 2063 6f64 652e 2049 2061  of the code. I a
-00002e60: 6d20 7365 6e64 696e 6720 6974 2062 6163  m sending it bac
-00002e70: 6b20 746f 204c 4c4d 2074 6f20 6765 7420  k to LLM to get 
-00002e80: 6974 2063 6865 636b 6564 2066 6f72 2061  it checked for a
-00002e90: 6e79 2065 7272 6f72 732c 2062 7567 7320  ny errors, bugs 
-00002ea0: 6f72 2069 6e63 6f6e 7369 7374 656e 6369  or inconsistenci
-00002eb0: 6573 2c20 616e 6420 636f 7272 6563 7469  es, and correcti
-00002ec0: 6f6e 2069 6620 6e65 6365 7373 6172 792e  on if necessary.
-00002ed0: 2050 6c65 6173 6520 7761 6974 2e2e 2e5c   Please wait...\
-00002ee0: 6e22 2c20 276d 6167 656e 7461 272c 2061  n", 'magenta', a
-00002ef0: 7474 7273 3d5b 2762 6f6c 6427 5d29 0d0a  ttrs=['bold'])..
-00002f00: 0d0a 2020 2020 2020 2020 2320 4675 6e63  ..        # Func
-00002f10: 7469 6f6e 2074 6f20 6469 7370 6c61 7920  tion to display 
-00002f20: 7265 7375 6c74 7320 6e69 6365 6c79 0d0a  results nicely..
-00002f30: 2020 2020 2020 2020 6465 6620 6469 7370          def disp
-00002f40: 6c61 795f 7461 736b 2829 3a0d 0a20 2020  lay_task():..   
-00002f50: 2020 2020 2020 2020 2069 6620 2769 7079           if 'ipy
-00002f60: 6b65 726e 656c 2720 696e 2073 7973 2e6d  kernel' in sys.m
-00002f70: 6f64 756c 6573 3a0d 0a20 2020 2020 2020  odules:..       
-00002f80: 2020 2020 2020 2020 2023 204a 7570 7974           # Jupyt
-00002f90: 6572 206e 6f74 6562 6f6f 6b20 6f72 2069  er notebook or i
-00002fa0: 7079 7468 6f6e 0d0a 2020 2020 2020 2020  python..        
-00002fb0: 2020 2020 2020 2020 6469 7370 6c61 7928          display(
-00002fc0: 4854 4d4c 2866 273c 703e 3c62 2073 7479  HTML(f'<p><b sty
-00002fd0: 6c65 3d22 636f 6c6f 723a 6d61 6765 6e74  le="color:magent
-00002fe0: 613b 223e 4920 6861 7665 2066 696e 6973  a;">I have finis
-00002ff0: 6865 6420 6465 6275 6767 696e 6720 7468  hed debugging th
-00003000: 6520 636f 6465 2c20 616e 6420 7769 6c6c  e code, and will
-00003010: 206e 6f77 2070 726f 6365 6564 2074 6f20   now proceed to 
-00003020: 7468 6520 6578 6563 7574 696f 6e2e 2e2e  the execution...
-00003030: 3c2f 623e 3c2f 703e 3c62 723e 2729 290d  </b></p><br>')).
-00003040: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00003050: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00003060: 2020 2020 2320 4f74 6865 7220 656e 7669      # Other envi
-00003070: 726f 6e6d 656e 7420 286c 696b 6520 7465  ronment (like te
-00003080: 726d 696e 616c 290d 0a20 2020 2020 2020  rminal)..       
-00003090: 2020 2020 2020 2020 2063 7072 696e 7428           cprint(
-000030a0: 6622 5c6e 3e3e 2049 2068 6176 6520 6669  f"\n>> I have fi
-000030b0: 6e69 7368 6564 2064 6562 7567 6769 6e67  nished debugging
-000030c0: 2074 6865 2063 6f64 652c 2061 6e64 2077   the code, and w
-000030d0: 696c 6c20 6e6f 7720 7072 6f63 6565 6420  ill now proceed 
-000030e0: 746f 2074 6865 2065 7865 6375 7469 6f6e  to the execution
-000030f0: 2e2e 2e5c 6e22 2c20 276d 6167 656e 7461  ...\n", 'magenta
-00003100: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
-00003110: 5d29 0d0a 0d0a 2020 2020 2020 2020 2320  ])....        # 
-00003120: 4361 6c6c 2074 6865 204f 7065 6e41 4920  Call the OpenAI 
-00003130: 4150 490d 0a20 2020 2020 2020 206c 6c6d  API..        llm
-00003140: 5f72 6573 706f 6e73 652c 2074 6f6b 656e  _response, token
-00003150: 735f 7573 6564 203d 2073 656c 662e 6c6c  s_used = self.ll
-00003160: 6d5f 6361 6c6c 2864 6562 7567 5f6d 6573  m_call(debug_mes
-00003170: 7361 6765 732c 7465 6d70 6572 6174 7572  sages,temperatur
-00003180: 653d 302c 6c6c 6d5f 6361 7363 6164 653d  e=0,llm_cascade=
-00003190: 6c6c 6d5f 6361 7363 6164 6529 2023 2068  llm_cascade) # h
-000031a0: 6967 6865 7220 7465 6d70 6572 6174 7572  igher temperatur
-000031b0: 6520 7265 7375 6c74 7320 696e 206d 6f72  e results in mor
-000031c0: 6520 2263 7265 6174 6976 6522 2061 6e73  e "creative" ans
-000031d0: 7765 7273 2028 736f 6d65 7469 6d65 7320  wers (sometimes 
-000031e0: 746f 6f20 6372 6561 7469 7665 203a 2d29  too creative :-)
-000031f0: 290d 0a20 2020 2020 2020 200d 0a20 2020  )..        ..   
-00003200: 2020 2020 2023 2045 7874 7261 6374 2074       # Extract t
-00003210: 6865 2063 6f64 6520 6672 6f6d 2074 6865  he code from the
-00003220: 2041 5049 2072 6573 706f 6e73 650d 0a20   API response.. 
-00003230: 2020 2020 2020 2064 6562 7567 6765 645f         debugged_
-00003240: 636f 6465 203d 2073 656c 662e 5f65 7874  code = self._ext
-00003250: 7261 6374 5f63 6f64 6528 6c6c 6d5f 7265  ract_code(llm_re
-00003260: 7370 6f6e 7365 2920 2020 2020 2020 0d0a  sponse)       ..
-00003270: 2020 2020 2020 2020 6469 7370 6c61 795f          display_
-00003280: 7461 736b 2829 0d0a 0d0a 2020 2020 2020  task()....      
-00003290: 2020 7365 6c66 2e74 6f74 616c 5f74 6f6b    self.total_tok
-000032a0: 656e 735f 7573 6564 2e61 7070 656e 6428  ens_used.append(
-000032b0: 746f 6b65 6e73 5f75 7365 6429 0d0a 0d0a  tokens_used)....
-000032c0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-000032d0: 6562 7567 6765 645f 636f 6465 0d0a 0d0a  ebugged_code....
-000032e0: 2020 2020 6465 6620 7261 6e6b 5f63 6f64      def rank_cod
-000032f0: 6528 7365 6c66 2c63 6f64 652c 7175 6573  e(self,code,ques
-00003300: 7469 6f6e 2c6c 6c6d 5f63 6173 6361 6465  tion,llm_cascade
-00003310: 3d46 616c 7365 293a 0d0a 2020 2020 2020  =False):..      
-00003320: 2020 2320 496e 6974 6961 6c69 7a65 2074    # Initialize t
-00003330: 6865 206d 6573 7361 6765 7320 6c69 7374  he messages list
-00003340: 2077 6974 6820 6120 7379 7374 656d 206d   with a system m
-00003350: 6573 7361 6765 2063 6f6e 7461 696e 696e  essage containin
-00003360: 6720 7468 6520 7461 736b 2070 726f 6d70  g the task promp
-00003370: 740d 0a20 2020 2020 2020 2072 616e 6b5f  t..        rank_
-00003380: 6d65 7373 6167 6573 203d 205b 7b22 726f  messages = [{"ro
-00003390: 6c65 223a 2022 7379 7374 656d 222c 2022  le": "system", "
-000033a0: 636f 6e74 656e 7422 3a20 7365 6c66 2e72  content": self.r
-000033b0: 616e 6b5f 616e 7377 6572 2e66 6f72 6d61  ank_answer.forma
-000033c0: 7428 636f 6465 2c71 7565 7374 696f 6e29  t(code,question)
-000033d0: 7d5d 0d0a 0d0a 2020 2020 2020 2020 7573  }]....        us
-000033e0: 696e 675f 6d6f 6465 6c20 3d20 7365 6c66  ing_model = self
-000033f0: 2e6c 6c6d 0d0a 2020 2020 2020 2020 6966  .llm..        if
-00003400: 206c 6c6d 5f63 6173 6361 6465 3a0d 0a20   llm_cascade:.. 
-00003410: 2020 2020 2020 2020 2020 2075 7369 6e67             using
-00003420: 5f6d 6f64 656c 203d 2073 656c 662e 6c6c  _model = self.ll
-00003430: 6d5f 6770 7434 0d0a 0d0a 2020 2020 2020  m_gpt4....      
-00003440: 2020 6966 2027 6970 796b 6572 6e65 6c27    if 'ipykernel'
-00003450: 2069 6e20 7379 732e 6d6f 6475 6c65 733a   in sys.modules:
-00003460: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00003470: 4a75 7079 7465 7220 6e6f 7465 626f 6f6b  Jupyter notebook
-00003480: 206f 7220 6970 7974 686f 6e0d 0a20 2020   or ipython..   
-00003490: 2020 2020 2020 2020 2064 6973 706c 6179           display
-000034a0: 2848 544d 4c28 6627 3c70 2073 7479 6c65  (HTML(f'<p style
-000034b0: 3d22 636f 6c6f 723a 6d61 6765 6e74 613b  ="color:magenta;
-000034c0: 223e 5c6e 4361 6c6c 696e 6720 4d6f 6465  ">\nCalling Mode
-000034d0: 6c3a 207b 7573 696e 675f 6d6f 6465 6c7d  l: {using_model}
-000034e0: 3c2f 703e 2729 290d 0a20 2020 2020 2020  </p>'))..       
-000034f0: 2020 2020 2064 6973 706c 6179 2848 544d       display(HTM
-00003500: 4c28 6627 3c70 3e3c 6220 7374 796c 653d  L(f'<p><b style=
-00003510: 2263 6f6c 6f72 3a6d 6167 656e 7461 3b22  "color:magenta;"
-00003520: 3e49 2061 6d20 676f 696e 6720 746f 2065  >I am going to e
-00003530: 7661 6c75 6174 6520 616e 6420 7261 6e6b  valuate and rank
-00003540: 2074 6865 2061 6e73 7765 722e 2050 6c65   the answer. Ple
-00003550: 6173 6520 7761 6974 2e2e 2e3c 2f62 3e3c  ase wait...</b><
-00003560: 2f70 3e3c 6272 3e27 2929 0d0a 2020 2020  /p><br>'))..    
-00003570: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
-00003580: 2020 2020 2020 2023 204f 7468 6572 2065         # Other e
-00003590: 6e76 6972 6f6e 6d65 6e74 2028 6c69 6b65  nvironment (like
-000035a0: 2074 6572 6d69 6e61 6c29 0d0a 2020 2020   terminal)..    
-000035b0: 2020 2020 2020 2020 7072 696e 7428 636f          print(co
-000035c0: 6c6f 7265 6428 6622 5c6e 3e3e 2043 616c  lored(f"\n>> Cal
-000035d0: 6c69 6e67 204d 6f64 656c 3a20 7b75 7369  ling Model: {usi
-000035e0: 6e67 5f6d 6f64 656c 7d22 2c20 226d 6167  ng_model}", "mag
-000035f0: 656e 7461 2229 290d 0a20 2020 2020 2020  enta"))..       
-00003600: 2020 2020 2063 7072 696e 7428 6622 5c6e       cprint(f"\n
-00003610: 3e3e 2049 2061 6d20 676f 696e 6720 746f  >> I am going to
-00003620: 2065 7661 6c75 6174 6520 616e 6420 7261   evaluate and ra
-00003630: 6e6b 2074 6865 2061 6e73 7765 722e 2050  nk the answer. P
-00003640: 6c65 6173 6520 7761 6974 2e2e 5c6e 222c  lease wait..\n",
-00003650: 2027 6d61 6765 6e74 6127 2c20 6174 7472   'magenta', attr
-00003660: 733d 5b27 626f 6c64 275d 290d 0a0d 0a20  s=['bold']).... 
-00003670: 2020 2020 2020 2023 2043 616c 6c20 7468         # Call th
-00003680: 6520 4f70 656e 4149 2041 5049 200d 0a20  e OpenAI API .. 
-00003690: 2020 2020 2020 206c 6c6d 5f72 6573 706f         llm_respo
-000036a0: 6e73 652c 2074 6f6b 656e 735f 7573 6564  nse, tokens_used
-000036b0: 203d 2073 656c 662e 6c6c 6d5f 6361 6c6c   = self.llm_call
-000036c0: 2872 616e 6b5f 6d65 7373 6167 6573 2c6c  (rank_messages,l
-000036d0: 6c6d 5f63 6173 6361 6465 3d6c 6c6d 5f63  lm_cascade=llm_c
-000036e0: 6173 6361 6465 290d 0a0d 0a20 2020 2020  ascade)....     
-000036f0: 2020 2023 2045 7874 7261 6374 2074 6865     # Extract the
-00003700: 2072 616e 6b20 6672 6f6d 2074 6865 2041   rank from the A
-00003710: 5049 2072 6573 706f 6e73 650d 0a20 2020  PI response..   
-00003720: 2020 2020 2072 616e 6b20 3d20 7365 6c66       rank = self
-00003730: 2e5f 6578 7472 6163 745f 7261 6e6b 286c  ._extract_rank(l
-00003740: 6c6d 5f72 6573 706f 6e73 6529 2020 2020  lm_response)    
-00003750: 2020 200d 0a0d 0a20 2020 2020 2020 2073     ....        s
-00003760: 656c 662e 746f 7461 6c5f 746f 6b65 6e73  elf.total_tokens
-00003770: 5f75 7365 642e 6170 7065 6e64 2874 6f6b  _used.append(tok
-00003780: 656e 735f 7573 6564 290d 0a0d 0a20 2020  ens_used)....   
-00003790: 2020 2020 2072 6574 7572 6e20 7261 6e6b       return rank
-000037a0: 0d0a 0d0a 2020 2020 6465 6620 7064 5f61  ....    def pd_a
-000037b0: 6765 6e74 5f63 6f6e 7665 7273 6528 7365  gent_converse(se
-000037c0: 6c66 2c20 7175 6573 7469 6f6e 3d4e 6f6e  lf, question=Non
-000037d0: 6529 3a0d 0a20 2020 2020 2020 2023 2046  e):..        # F
-000037e0: 756e 6374 696f 6e73 2074 6f20 6469 7370  unctions to disp
-000037f0: 6c61 7920 7265 7375 6c74 7320 6e69 6365  lay results nice
-00003800: 6c79 0d0a 2020 2020 2020 2020 6465 6620  ly..        def 
-00003810: 6469 7370 6c61 795f 7265 7375 6c74 7328  display_results(
-00003820: 616e 7377 6572 2c20 636f 6465 2c20 7261  answer, code, ra
-00003830: 6e6b 2c20 746f 7461 6c5f 746f 6b65 6e73  nk, total_tokens
-00003840: 5f75 7365 645f 7375 6d29 3a0d 0a20 2020  _used_sum):..   
-00003850: 2020 2020 2020 2020 2069 6620 2769 7079           if 'ipy
-00003860: 6b65 726e 656c 2720 696e 2073 7973 2e6d  kernel' in sys.m
-00003870: 6f64 756c 6573 3a20 2020 2020 0d0a 2020  odules:     ..  
-00003880: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00003890: 2061 6e73 7765 7220 6973 206e 6f74 204e   answer is not N
-000038a0: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-000038b0: 2020 2020 2020 2020 2020 6469 7370 6c61            displa
-000038c0: 7928 4854 4d4c 2866 273c 703e 3c62 2073  y(HTML(f'<p><b s
-000038d0: 7479 6c65 3d22 636f 6c6f 723a 626c 7565  tyle="color:blue
-000038e0: 3b22 3e49 206e 6f77 2068 6176 6520 7468  ;">I now have th
-000038f0: 6520 6669 6e61 6c20 616e 7377 6572 3a3c  e final answer:<
-00003900: 2f62 3e3c 6272 3e3c 7072 6520 7374 796c  /b><br><pre styl
-00003910: 653d 2263 6f6c 6f72 3a62 6c61 636b 3b20  e="color:black; 
-00003920: 7768 6974 652d 7370 6163 653a 2070 7265  white-space: pre
-00003930: 2d77 7261 703b 2066 6f6e 742d 7765 6967  -wrap; font-weig
-00003940: 6874 3a20 626f 6c64 3b22 3e7b 616e 7377  ht: bold;">{answ
-00003950: 6572 7d3c 2f70 7265 3e3c 2f70 3e3c 6272  er}</pre></p><br
-00003960: 3e27 2929 0d0a 2020 2020 2020 2020 2020  >'))..          
-00003970: 2020 2020 2020 6966 2063 6f64 6520 6973        if code is
-00003980: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
-00003990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039a0: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
-000039b0: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
-000039c0: 723a 626c 7565 3b22 3e48 6572 6520 6973  r:blue;">Here is
-000039d0: 2074 6865 2066 696e 616c 2063 6f64 6520   the final code 
-000039e0: 7468 6174 2061 6363 6f6d 706c 6973 6865  that accomplishe
-000039f0: 7320 7468 6520 7461 736b 3a3c 2f62 3e3c  s the task:</b><
-00003a00: 6272 3e3c 7072 6520 7374 796c 653d 2263  br><pre style="c
-00003a10: 6f6c 6f72 3a23 3535 3535 3535 3b22 3e7b  olor:#555555;">{
-00003a20: 636f 6465 7d3c 2f70 7265 3e3c 2f70 3e3c  code}</pre></p><
-00003a30: 6272 3e27 2929 0d0a 2020 2020 2020 2020  br>'))..        
-00003a40: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00003a50: 7665 6374 6f72 5f64 6220 616e 6420 7261  vector_db and ra
-00003a60: 6e6b 2069 7320 6e6f 7420 4e6f 6e65 3a0d  nk is not None:.
-00003a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003a80: 2020 2020 2064 6973 706c 6179 2848 544d       display(HTM
-00003a90: 4c28 6627 3c70 3e3c 6220 7374 796c 653d  L(f'<p><b style=
-00003aa0: 2263 6f6c 6f72 3a62 6c75 653b 223e 5261  "color:blue;">Ra
-00003ab0: 6e6b 3a3c 2f62 3e3c 6272 3e3c 7370 616e  nk:</b><br><span
-00003ac0: 2073 7479 6c65 3d22 636f 6c6f 723a 626c   style="color:bl
-00003ad0: 6163 6b3b 223e 7b72 616e 6b7d 3c2f 7370  ack;">{rank}</sp
-00003ae0: 616e 3e3c 2f70 3e3c 6272 3e27 2929 0d0a  an></p><br>'))..
-00003af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b00: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
-00003b10: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
-00003b20: 723a 626c 7565 3b22 3e54 6f74 616c 2054  r:blue;">Total T
-00003b30: 6f6b 656e 7320 5573 6564 3a3c 2f62 3e3c  okens Used:</b><
-00003b40: 6272 3e3c 7370 616e 2073 7479 6c65 3d22  br><span style="
-00003b50: 636f 6c6f 723a 626c 6163 6b3b 223e 7b74  color:black;">{t
-00003b60: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-00003b70: 5f73 756d 7d3c 2f73 7061 6e3e 3c2f 703e  _sum}</span></p>
-00003b80: 3c62 723e 2729 290d 0a20 2020 2020 2020  <br>'))..       
-00003b90: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00003ba0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-00003bb0: 6e73 7765 7220 6973 206e 6f74 204e 6f6e  nswer is not Non
-00003bc0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00003bd0: 2020 2020 2020 2020 6370 7269 6e74 2866          cprint(f
-00003be0: 225c 6e3e 3e20 4920 6e6f 7720 6861 7665  "\n>> I now have
-00003bf0: 2074 6865 2066 696e 616c 2061 6e73 7765   the final answe
-00003c00: 723a 5c6e 7b61 6e73 7765 727d 5c6e 222c  r:\n{answer}\n",
-00003c10: 2027 6772 6565 6e27 2c20 6174 7472 733d   'green', attrs=
-00003c20: 5b27 626f 6c64 275d 290d 0a20 2020 2020  ['bold'])..     
-00003c30: 2020 2020 2020 2020 2020 2069 6620 636f             if co
-00003c40: 6465 2069 7320 6e6f 7420 4e6f 6e65 3a0d  de is not None:.
-00003c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003c60: 2020 2020 2063 7072 696e 7428 6622 3e3e       cprint(f">>
-00003c70: 2048 6572 6520 6973 2074 6865 2066 696e   Here is the fin
-00003c80: 616c 2063 6f64 6520 7468 6174 2061 6363  al code that acc
-00003c90: 6f6d 706c 6973 6865 7320 7468 6520 7461  omplishes the ta
-00003ca0: 736b 3a5c 6e7b 636f 6465 7d5c 6e22 2c20  sk:\n{code}\n", 
-00003cb0: 2767 7265 656e 272c 2061 7474 7273 3d5b  'green', attrs=[
-00003cc0: 2762 6f6c 6427 5d29 0d0a 2020 2020 2020  'bold'])..      
-00003cd0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00003ce0: 662e 7665 6374 6f72 5f64 6220 616e 6420  f.vector_db and 
-00003cf0: 7261 6e6b 2069 7320 6e6f 7420 4e6f 6e65  rank is not None
-00003d00: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00003d10: 2020 2020 2020 2063 7072 696e 7428 6622         cprint(f"
-00003d20: 3e3e 2052 616e 6b3a 5c6e 7b72 616e 6b7d  >> Rank:\n{rank}
-00003d30: 5c6e 222c 2027 6772 6565 6e27 2c20 6174  \n", 'green', at
-00003d40: 7472 733d 5b27 626f 6c64 275d 290d 0a20  trs=['bold']).. 
-00003d50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00003d60: 7072 696e 7428 6622 3e3e 2054 6f74 616c  print(f">> Total
-00003d70: 2074 6f6b 656e 7320 7573 6564 3a5c 6e7b   tokens used:\n{
-00003d80: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
-00003d90: 645f 7375 6d7d 5c6e 222c 2027 7965 6c6c  d_sum}\n", 'yell
-00003da0: 6f77 272c 2061 7474 7273 3d5b 2762 6f6c  ow', attrs=['bol
-00003db0: 6427 5d29 0d0a 0d0a 2020 2020 2020 2020  d'])....        
-00003dc0: 6465 6620 6469 7370 6c61 795f 6576 616c  def display_eval
-00003dd0: 2874 6173 6b5f 6576 616c 2c20 7469 746c  (task_eval, titl
-00003de0: 652c 2074 6f74 616c 5f74 6f6b 656e 735f  e, total_tokens_
-00003df0: 7573 6564 5f73 756d 293a 0d0a 2020 2020  used_sum):..    
-00003e00: 2020 2020 2020 2020 6966 2027 6970 796b          if 'ipyk
-00003e10: 6572 6e65 6c27 2069 6e20 7379 732e 6d6f  ernel' in sys.mo
-00003e20: 6475 6c65 733a 0d0a 2020 2020 2020 2020  dules:..        
-00003e30: 2020 2020 2020 2020 2320 4a75 7079 7465          # Jupyte
-00003e40: 7220 6e6f 7465 626f 6f6b 206f 7220 6970  r notebook or ip
-00003e50: 7974 686f 6e0d 0a20 2020 2020 2020 2020  ython..         
-00003e60: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
-00003e70: 544d 4c28 6627 3c70 3e3c 6220 7374 796c  TML(f'<p><b styl
-00003e80: 653d 2263 6f6c 6f72 3a62 6c75 653b 223e  e="color:blue;">
-00003e90: 7b74 6974 6c65 7d3c 2f62 3e3c 6272 3e3c  {title}</b><br><
-00003ea0: 7072 6520 7374 796c 653d 2263 6f6c 6f72  pre style="color
-00003eb0: 3a62 6c61 636b 3b20 7768 6974 652d 7370  :black; white-sp
-00003ec0: 6163 653a 2070 7265 2d77 7261 703b 2066  ace: pre-wrap; f
-00003ed0: 6f6e 742d 7765 6967 6874 3a20 626f 6c64  ont-weight: bold
-00003ee0: 3b22 3e7b 7461 736b 5f65 7661 6c7d 3c2f  ;">{task_eval}</
-00003ef0: 7072 653e 3c2f 703e 3c62 723e 2729 290d  pre></p><br>')).
-00003f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003f10: 2064 6973 706c 6179 2848 544d 4c28 6627   display(HTML(f'
-00003f20: 3c70 3e3c 6220 7374 796c 653d 2263 6f6c  <p><b style="col
-00003f30: 6f72 3a62 6c75 653b 223e 546f 7461 6c20  or:blue;">Total 
-00003f40: 546f 6b65 6e73 2055 7365 643a 3c2f 623e  Tokens Used:</b>
-00003f50: 3c62 723e 3c73 7061 6e20 7374 796c 653d  <br><span style=
-00003f60: 2263 6f6c 6f72 3a62 6c61 636b 3b22 3e7b  "color:black;">{
-00003f70: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
-00003f80: 645f 7375 6d7d 3c2f 7370 616e 3e3c 2f70  d_sum}</span></p
-00003f90: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
-00003fa0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00003fb0: 2020 2020 2020 2020 2020 2020 2023 204f               # O
-00003fc0: 7468 6572 2065 6e76 6972 6f6e 6d65 6e74  ther environment
-00003fd0: 2028 6c69 6b65 2074 6572 6d69 6e61 6c29   (like terminal)
-00003fe0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00003ff0: 2020 6370 7269 6e74 2866 225c 6e3e 3e20    cprint(f"\n>> 
-00004000: 7b74 6974 6c65 7d5c 6e7b 7461 736b 5f65  {title}\n{task_e
-00004010: 7661 6c7d 5c6e 222c 2027 6d61 6765 6e74  val}\n", 'magent
-00004020: 6127 2c20 6174 7472 733d 5b27 626f 6c64  a', attrs=['bold
-00004030: 275d 290d 0a20 2020 2020 2020 2020 2020  '])..           
-00004040: 2020 2020 2063 7072 696e 7428 6622 3e3e       cprint(f">>
-00004050: 2054 6f74 616c 2074 6f6b 656e 7320 7573   Total tokens us
-00004060: 6564 3a5c 6e7b 746f 7461 6c5f 746f 6b65  ed:\n{total_toke
-00004070: 6e73 5f75 7365 645f 7375 6d7d 5c6e 222c  ns_used_sum}\n",
-00004080: 2027 7965 6c6c 6f77 272c 2061 7474 7273   'yellow', attrs
-00004090: 3d5b 2762 6f6c 6427 5d29 0d0a 0d0a 2020  =['bold'])....  
-000040a0: 2020 2020 2020 2320 496e 6974 6961 6c69        # Initiali
-000040b0: 7a65 2074 6865 2065 7661 6c5f 6d65 7373  ze the eval_mess
-000040c0: 6167 6573 206c 6973 740d 0a20 2020 2020  ages list..     
-000040d0: 2020 2065 7661 6c5f 6d65 7373 6167 6573     eval_messages
-000040e0: 203d 205b 5d0d 0a20 2020 2020 2020 200d   = []..        .
-000040f0: 0a20 2020 2020 2020 2023 2049 6620 6120  .        # If a 
-00004100: 7175 6573 7469 6f6e 2069 7320 7072 6f76  question is prov
-00004110: 6964 6564 2c20 736b 6970 2074 6865 2069  ided, skip the i
-00004120: 6e70 7574 2070 726f 6d70 740d 0a20 2020  nput prompt..   
-00004130: 2020 2020 2069 6620 7175 6573 7469 6f6e       if question
-00004140: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
-00004150: 2020 2020 2020 2020 2020 2023 2049 6e69             # Ini
-00004160: 7469 616c 697a 6520 7468 6520 6d65 7373  tialize the mess
-00004170: 6167 6573 206c 6973 7420 7769 7468 2061  ages list with a
-00004180: 2073 7973 7465 6d20 6d65 7373 6167 6520   system message 
-00004190: 636f 6e74 6169 6e69 6e67 2074 6865 2074  containing the t
-000041a0: 6173 6b20 7072 6f6d 7074 0d0a 2020 2020  ask prompt..    
-000041b0: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-000041c0: 203d 205b 7b22 726f 6c65 223a 2022 7379   = [{"role": "sy
-000041d0: 7374 656d 222c 2022 636f 6e74 656e 7422  stem", "content"
-000041e0: 3a20 7365 6c66 2e73 7973 7465 6d5f 7461  : self.system_ta
-000041f0: 736b 7d5d 0d0a 2020 2020 2020 2020 2020  sk}]..          
-00004200: 2020 2320 496e 6974 6961 6c69 7a65 2074    # Initialize t
-00004210: 6865 206d 6573 7361 6765 7320 6c69 7374  he messages list
-00004220: 2077 6974 6820 6120 7379 7374 656d 206d   with a system m
-00004230: 6573 7361 6765 2063 6f6e 7461 696e 696e  essage containin
-00004240: 6720 7468 6520 7461 736b 2070 726f 6d70  g the task promp
-00004250: 740d 0a20 2020 2020 2020 2020 2020 2065  t..            e
-00004260: 7661 6c5f 6d65 7373 6167 6573 2e61 7070  val_messages.app
-00004270: 656e 6428 7b22 726f 6c65 223a 2022 7573  end({"role": "us
-00004280: 6572 222c 2022 636f 6e74 656e 7422 3a20  er", "content": 
-00004290: 7365 6c66 2e74 6173 6b5f 6576 616c 7561  self.task_evalua
-000042a0: 7469 6f6e 2e66 6f72 6d61 7428 7175 6573  tion.format(ques
-000042b0: 7469 6f6e 2c20 7365 6c66 2e64 665f 6865  tion, self.df_he
-000042c0: 6164 297d 290d 0a0d 0a20 2020 2020 2020  ad)})....       
-000042d0: 2020 2020 2023 2043 616c 6c20 7468 6520       # Call the 
-000042e0: 7461 736b 5f65 7661 6c20 6d65 7468 6f64  task_eval method
-000042f0: 2077 6974 6820 7468 6520 7573 6572 2773   with the user's
-00004300: 2071 7565 7374 696f 6e20 6966 2074 6865   question if the
-00004310: 2065 7870 6c6f 7261 746f 7279 206d 6f64   exploratory mod
-00004320: 6520 6973 2054 7275 650d 0a20 2020 2020  e is True..     
-00004330: 2020 2020 2020 2069 6620 7365 6c66 2e65         if self.e
-00004340: 7870 6c6f 7261 746f 7279 2069 7320 5472  xploratory is Tr
-00004350: 7565 3a0d 0a20 2020 2020 2020 2020 2020  ue:..           
-00004360: 2020 2020 2061 7267 756d 656e 7473 2c20       arguments, 
-00004370: 666e 5f6e 616d 652c 2074 6173 6b5f 6576  fn_name, task_ev
-00004380: 616c 2c20 7461 736b 5f74 7970 6520 3d20  al, task_type = 
-00004390: 7365 6c66 2e74 6173 6b5f 6576 616c 2865  self.task_eval(e
-000043a0: 7661 6c5f 6d65 7373 6167 6573 290d 0a20  val_messages).. 
-000043b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000043c0: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-000043d0: 5f73 756d 203d 2073 756d 2873 656c 662e  _sum = sum(self.
-000043e0: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
-000043f0: 6429 0d0a 2020 2020 2020 2020 2020 2020  d)..            
-00004400: 2020 2020 6966 2074 6173 6b5f 7479 7065      if task_type
-00004410: 203d 3d20 276e 6172 7261 7469 7665 273a   == 'narrative':
-00004420: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00004430: 2020 2020 2020 7469 746c 6520 3d20 2748        title = 'H
-00004440: 6572 6520 6973 2074 6865 2061 6e73 7765  ere is the answe
-00004450: 7220 746f 2079 6f75 7220 7175 6573 7469  r to your questi
-00004460: 6f6e 3a27 2020 2020 2020 2020 2020 2020  on:'            
-00004470: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
-00004480: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-00004490: 706c 6179 5f65 7661 6c28 7461 736b 5f65  play_eval(task_e
-000044a0: 7661 6c2c 2074 6974 6c65 2c20 746f 7461  val, title, tota
-000044b0: 6c5f 746f 6b65 6e73 5f75 7365 645f 7375  l_tokens_used_su
-000044c0: 6d29 0d0a 2020 2020 2020 2020 2020 2020  m)..            
-000044d0: 2020 2020 2020 2020 7265 7475 726e 0d0a          return..
-000044e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044f0: 6966 2074 6173 6b5f 7479 7065 203d 3d20  if task_type == 
-00004500: 2766 6f6c 6c6f 775f 7570 273a 0d0a 2020  'follow_up':..  
-00004510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004520: 2020 7469 746c 6520 3d20 2754 6f20 6265    title = 'To be
-00004530: 2061 626c 6520 746f 2061 6e73 7765 7220   able to answer 
-00004540: 796f 7572 2071 7565 7374 696f 6e2c 2049  your question, I
-00004550: 2061 6d20 676f 696e 6720 746f 206e 6565   am going to nee
-00004560: 6420 736f 6d65 206d 6f72 6520 696e 666f  d some more info
-00004570: 3a27 2020 2020 2020 2020 2020 2020 2020  :'              
-00004580: 2020 2020 200d 0a20 2020 2020 2020 2020       ..         
-00004590: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-000045a0: 6179 5f65 7661 6c28 7461 736b 5f65 7661  ay_eval(task_eva
-000045b0: 6c2c 2074 6974 6c65 2c20 746f 7461 6c5f  l, title, total_
-000045c0: 746f 6b65 6e73 5f75 7365 645f 7375 6d29  tokens_used_sum)
-000045d0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000045e0: 2020 2020 2020 7265 7475 726e 0d0a 2020        return..  
-000045f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00004600: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00004610: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
-00004620: 2027 4865 7265 2069 7320 7468 6520 7365   'Here is the se
-00004630: 7175 656e 6365 206f 6620 7374 6570 7320  quence of steps 
-00004640: 7265 7175 6972 6564 2074 6f20 636f 6d70  required to comp
-00004650: 6c65 7465 2074 6865 2074 6173 6b3a 270d  lete the task:'.
-00004660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004670: 2020 2020 2074 6173 6b20 3d20 7461 736b       task = task
-00004680: 5f65 7661 6c0d 0a20 2020 2020 2020 2020  _eval..         
-00004690: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-000046a0: 6179 5f65 7661 6c28 7461 736b 5f65 7661  ay_eval(task_eva
-000046b0: 6c2c 2074 6974 6c65 2c20 746f 7461 6c5f  l, title, total_
-000046c0: 746f 6b65 6e73 5f75 7365 645f 7375 6d29  tokens_used_sum)
-000046d0: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-000046e0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-000046f0: 2020 2020 2074 6173 6b20 3d20 7175 6573       task = ques
-00004700: 7469 6f6e 0d0a 0d0a 2020 2020 2020 2020  tion....        
-00004710: 2020 2020 6966 2073 656c 662e 7665 6374      if self.vect
-00004720: 6f72 5f64 623a 0d0a 2020 2020 2020 2020  or_db:..        
-00004730: 2020 2020 2020 2020 2320 4361 6c6c 2074          # Call t
-00004740: 6865 2072 6574 7269 6576 655f 616e 7377  he retrieve_answ
-00004750: 6572 206d 6574 686f 6420 746f 2063 6865  er method to che
-00004760: 636b 2069 6620 7468 6520 7175 6573 7469  ck if the questi
-00004770: 6f6e 2068 6173 2061 6c72 6561 6479 2062  on has already b
-00004780: 6565 6e20 6173 6b65 6420 616e 6420 616e  een asked and an
-00004790: 7377 6572 6564 0d0a 2020 2020 2020 2020  swered..        
-000047a0: 2020 2020 2020 2020 6578 616d 706c 655f          example_
-000047b0: 6f75 7470 7574 203d 2073 656c 662e 7265  output = self.re
-000047c0: 7472 6965 7665 5f61 6e73 7765 7228 7461  trieve_answer(ta
-000047d0: 736b 2c20 7365 6c66 2e64 665f 636f 6c75  sk, self.df_colu
-000047e0: 6d6e 7329 0d0a 2020 2020 2020 2020 2020  mns)..          
-000047f0: 2020 2020 2020 6966 2065 7861 6d70 6c65        if example
-00004800: 5f6f 7574 7075 7420 6973 206e 6f74 204e  _output is not N
-00004810: 6f6e 653a 0d0a 2020 2020 2020 2020 2020  one:..          
-00004820: 2020 2020 2020 2020 2020 6578 616d 706c            exampl
-00004830: 655f 6f75 7470 7574 203d 2065 7861 6d70  e_output = examp
-00004840: 6c65 5f6f 7574 7075 740d 0a20 2020 2020  le_output..     
-00004850: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00004860: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00004870: 2020 2020 2020 6578 616d 706c 655f 6f75        example_ou
-00004880: 7470 7574 203d 2073 656c 662e 6465 6661  tput = self.defa
-00004890: 756c 745f 6578 616d 706c 655f 6f75 7470  ult_example_outp
+00000ef0: 2020 2020 2020 2073 656c 662e 7369 6d69         self.simi
+00000f00: 6c61 7269 7479 5f74 6872 6573 686f 6c64  larity_threshold
+00000f10: 203d 2030 2e38 0d0a 2020 2020 2020 2020   = 0.8..        
+00000f20: 0d0a 2020 2020 2020 2020 6f70 656e 6169  ..        openai
+00000f30: 2e61 7069 5f6b 6579 203d 2073 656c 662e  .api_key = self.
+00000f40: 4150 495f 4b45 590d 0a0d 0a20 2020 2020  API_KEY....     
+00000f50: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
+00000f60: 7468 6520 746f 7461 6c20 746f 6b65 6e73  the total tokens
+00000f70: 2075 7365 6420 6c69 7374 2e20 5468 6973   used list. This
+00000f80: 206c 6973 7420 7769 6c6c 2062 6520 7573   list will be us
+00000f90: 6564 2074 6f20 6b65 6570 2074 7261 636b  ed to keep track
+00000fa0: 206f 6620 7468 6520 746f 7461 6c20 746f   of the total to
+00000fb0: 6b65 6e73 2075 7365 6420 6279 2074 6865  kens used by the
+00000fc0: 206d 6f64 656c 0d0a 2020 2020 2020 2020   model..        
+00000fd0: 7365 6c66 2e74 6f74 616c 5f74 6f6b 656e  self.total_token
+00000fe0: 735f 7573 6564 203d 205b 5d0d 0a0d 0a20  s_used = [].... 
+00000ff0: 2020 2064 6566 206c 6c6d 5f63 616c 6c28     def llm_call(
+00001000: 7365 6c66 2c20 6d65 7373 6167 6573 3a20  self, messages: 
+00001010: 7374 722c 2074 656d 7065 7261 7475 7265  str, temperature
+00001020: 3a20 666c 6f61 7420 3d20 302c 206d 6178  : float = 0, max
+00001030: 5f74 6f6b 656e 733a 2069 6e74 203d 2031  _tokens: int = 1
+00001040: 3030 302c 206c 6c6d 5f63 6173 6361 6465  000, llm_cascade
+00001050: 3a20 626f 6f6c 203d 2046 616c 7365 293a  : bool = False):
+00001060: 0d0a 2020 2020 2020 2020 6d6f 6465 6c20  ..        model 
+00001070: 3d20 7365 6c66 2e6c 6c6d 0d0a 2020 2020  = self.llm..    
+00001080: 2020 2020 6966 206c 6c6d 5f63 6173 6361      if llm_casca
+00001090: 6465 3a0d 0a20 2020 2020 2020 2020 2020  de:..           
+000010a0: 206d 6f64 656c 203d 2073 656c 662e 6c6c   model = self.ll
+000010b0: 6d5f 6770 7434 0d0a 2020 2020 2020 2020  m_gpt4..        
+000010c0: 7472 793a 0d0a 2020 2020 2020 2020 2020  try:..          
+000010d0: 2020 7265 7370 6f6e 7365 203d 206f 7065    response = ope
+000010e0: 6e61 692e 4368 6174 436f 6d70 6c65 7469  nai.ChatCompleti
+000010f0: 6f6e 2e63 7265 6174 6528 0d0a 2020 2020  on.create(..    
+00001100: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00001110: 6c3d 6d6f 6465 6c2c 0d0a 2020 2020 2020  l=model,..      
+00001120: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
+00001130: 6573 3d6d 6573 7361 6765 732c 0d0a 2020  es=messages,..  
+00001140: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00001150: 6d70 6572 6174 7572 653d 7465 6d70 6572  mperature=temper
+00001160: 6174 7572 652c 0d0a 2020 2020 2020 2020  ature,..        
+00001170: 2020 2020 2020 2020 6d61 785f 746f 6b65          max_toke
+00001180: 6e73 3d6d 6178 5f74 6f6b 656e 732c 0d0a  ns=max_tokens,..
+00001190: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+000011a0: 2020 2020 2020 2065 7863 6570 7420 6f70         except op
+000011b0: 656e 6169 2e65 7272 6f72 2e52 6174 654c  enai.error.RateL
+000011c0: 696d 6974 4572 726f 723a 0d0a 2020 2020  imitError:..    
+000011d0: 2020 2020 2020 2020 7072 696e 7428 0d0a          print(..
+000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011f0: 2254 6865 204f 7065 6e41 4920 4150 4920  "The OpenAI API 
+00001200: 7261 7465 206c 696d 6974 2068 6173 2062  rate limit has b
+00001210: 6565 6e20 6578 6365 6564 6564 2e20 5761  een exceeded. Wa
+00001220: 6974 696e 6720 3130 2073 6563 6f6e 6473  iting 10 seconds
+00001230: 2061 6e64 2074 7279 696e 6720 6167 6169   and trying agai
+00001240: 6e2e 220d 0a20 2020 2020 2020 2020 2020  n."..           
+00001250: 2029 0d0a 2020 2020 2020 2020 2020 2020   )..            
+00001260: 7469 6d65 2e73 6c65 6570 2831 3029 0d0a  time.sleep(10)..
+00001270: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00001280: 6f6e 7365 203d 206f 7065 6e61 692e 4368  onse = openai.Ch
+00001290: 6174 436f 6d70 6c65 7469 6f6e 2e63 7265  atCompletion.cre
+000012a0: 6174 6528 0d0a 2020 2020 2020 2020 2020  ate(..          
+000012b0: 2020 2020 2020 6d6f 6465 6c3d 6d6f 6465        model=mode
+000012c0: 6c2c 0d0a 2020 2020 2020 2020 2020 2020  l,..            
+000012d0: 2020 2020 6d65 7373 6167 6573 3d6d 6573      messages=mes
+000012e0: 7361 6765 732c 0d0a 2020 2020 2020 2020  sages,..        
+000012f0: 2020 2020 2020 2020 7465 6d70 6572 6174          temperat
+00001300: 7572 653d 7465 6d70 6572 6174 7572 652c  ure=temperature,
+00001310: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00001320: 2020 6d61 785f 746f 6b65 6e73 3d6d 6178    max_tokens=max
+00001330: 5f74 6f6b 656e 732c 0d0a 2020 2020 2020  _tokens,..      
+00001340: 2020 2020 2020 290d 0a20 2020 2020 2020        )..       
+00001350: 2023 2045 7863 6565 6465 6420 7468 6520   # Exceeded the 
+00001360: 6d61 7869 6d75 6d20 6e75 6d62 6572 206f  maximum number o
+00001370: 6620 746f 6b65 6e73 2061 6c6c 6f77 6564  f tokens allowed
+00001380: 2062 7920 7468 6520 4150 490d 0a20 2020   by the API..   
+00001390: 2020 2020 2065 7863 6570 7420 6f70 656e       except open
+000013a0: 6169 2e65 7272 6f72 2e49 6e76 616c 6964  ai.error.Invalid
+000013b0: 5265 7175 6573 7445 7272 6f72 3a0d 0a20  RequestError:.. 
+000013c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000013d0: 280d 0a20 2020 2020 2020 2020 2020 2020  (..             
+000013e0: 2020 2022 5468 6520 4f70 656e 4149 2041     "The OpenAI A
+000013f0: 5049 206d 6178 696d 756d 2074 6f6b 656e  PI maximum token
+00001400: 7320 6c69 6d69 7420 6861 7320 6265 656e  s limit has been
+00001410: 2065 7863 6565 6465 642e 2053 7769 7463   exceeded. Switc
+00001420: 6869 6e67 2074 6f20 6120 3136 4b20 6d6f  hing to a 16K mo
+00001430: 6465 6c2e 220d 0a20 2020 2020 2020 2020  del."..         
+00001440: 2020 2029 0d0a 2020 2020 2020 2020 2020     )..          
+00001450: 2020 7265 7370 6f6e 7365 203d 206f 7065    response = ope
+00001460: 6e61 692e 4368 6174 436f 6d70 6c65 7469  nai.ChatCompleti
+00001470: 6f6e 2e63 7265 6174 6528 0d0a 2020 2020  on.create(..    
+00001480: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00001490: 6c3d 7365 6c66 2e6c 6c6d 5f31 366b 2c0d  l=self.llm_16k,.
+000014a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000014b0: 206d 6573 7361 6765 733d 6d65 7373 6167   messages=messag
+000014c0: 6573 2c0d 0a20 2020 2020 2020 2020 2020  es,..           
+000014d0: 2020 2020 2074 656d 7065 7261 7475 7265       temperature
+000014e0: 3d74 656d 7065 7261 7475 7265 2c0d 0a20  =temperature,.. 
+000014f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00001500: 6178 5f74 6f6b 656e 733d 6d61 785f 746f  ax_tokens=max_to
+00001510: 6b65 6e73 2c0d 0a20 2020 2020 2020 2020  kens,..         
+00001520: 2020 2029 0d0a 0d0a 2020 2020 2020 2020     )....        
+00001530: 636f 6e74 656e 7420 3d20 7265 7370 6f6e  content = respon
+00001540: 7365 2e63 686f 6963 6573 5b30 5d2e 6d65  se.choices[0].me
+00001550: 7373 6167 652e 636f 6e74 656e 742e 7374  ssage.content.st
+00001560: 7269 7028 290d 0a20 2020 2020 2020 2074  rip()..        t
+00001570: 6f6b 656e 735f 7573 6564 203d 2072 6573  okens_used = res
+00001580: 706f 6e73 652e 7573 6167 652e 746f 7461  ponse.usage.tota
+00001590: 6c5f 746f 6b65 6e73 0d0a 0d0a 2020 2020  l_tokens....    
+000015a0: 2020 2020 7265 7475 726e 2063 6f6e 7465      return conte
+000015b0: 6e74 2c20 746f 6b65 6e73 5f75 7365 640d  nt, tokens_used.
+000015c0: 0a20 2020 200d 0a20 2020 2064 6566 206c  .    ..    def l
+000015d0: 6c6d 5f66 756e 635f 6361 6c6c 2873 656c  lm_func_call(sel
+000015e0: 662c 206d 6573 7361 6765 732c 2066 756e  f, messages, fun
+000015f0: 6374 696f 6e73 2c20 6675 6e63 7469 6f6e  ctions, function
+00001600: 5f6e 616d 6529 3a0d 0a20 2020 2020 2020  _name):..       
+00001610: 2074 7279 3a0d 0a20 2020 2020 2020 2020   try:..         
+00001620: 2020 2072 6573 706f 6e73 6520 3d20 6f70     response = op
+00001630: 656e 6169 2e43 6861 7443 6f6d 706c 6574  enai.ChatComplet
+00001640: 696f 6e2e 6372 6561 7465 280d 0a20 2020  ion.create(..   
+00001650: 2020 2020 2020 2020 206d 6f64 656c 203d           model =
+00001660: 2073 656c 662e 6c6c 6d5f 6675 6e63 2c0d   self.llm_func,.
+00001670: 0a20 2020 2020 2020 2020 2020 206d 6573  .            mes
+00001680: 7361 6765 733d 6d65 7373 6167 6573 2c0d  sages=messages,.
+00001690: 0a20 2020 2020 2020 2020 2020 2066 756e  .            fun
+000016a0: 6374 696f 6e73 3d66 756e 6374 696f 6e73  ctions=functions
+000016b0: 2c0d 0a20 2020 2020 2020 2020 2020 2066  ,..            f
+000016c0: 756e 6374 696f 6e5f 6361 6c6c 203d 2066  unction_call = f
+000016d0: 756e 6374 696f 6e5f 6e61 6d65 2c0d 0a20  unction_name,.. 
+000016e0: 2020 2020 2020 2020 2020 2074 656d 7065             tempe
+000016f0: 7261 7475 7265 3d30 2c0d 0a20 2020 2020  rature=0,..     
+00001700: 2020 2020 2020 206d 6178 5f74 6f6b 656e         max_token
+00001710: 7320 3d20 3730 302c 200d 0a20 2020 2020  s = 700, ..     
+00001720: 2020 2020 2020 2029 0d0a 2020 2020 2020         )..      
+00001730: 2020 6578 6365 7074 206f 7065 6e61 692e    except openai.
+00001740: 6572 726f 722e 5261 7465 4c69 6d69 7445  error.RateLimitE
+00001750: 7272 6f72 3a0d 0a20 2020 2020 2020 2020  rror:..         
+00001760: 2020 2070 7269 6e74 280d 0a20 2020 2020     print(..     
+00001770: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
+00001780: 4f70 656e 4149 2041 5049 2072 6174 6520  OpenAI API rate 
+00001790: 6c69 6d69 7420 6861 7320 6265 656e 2065  limit has been e
+000017a0: 7863 6565 6465 642e 2057 6169 7469 6e67  xceeded. Waiting
+000017b0: 2031 3020 7365 636f 6e64 7320 616e 6420   10 seconds and 
+000017c0: 7472 7969 6e67 2061 6761 696e 2e22 0d0a  trying again."..
+000017d0: 2020 2020 2020 2020 2020 2020 290d 0a20              ).. 
+000017e0: 2020 2020 2020 2020 2020 2074 696d 652e             time.
+000017f0: 736c 6565 7028 3130 290d 0a20 2020 2020  sleep(10)..     
+00001800: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00001810: 3d20 6f70 656e 6169 2e43 6861 7443 6f6d  = openai.ChatCom
+00001820: 706c 6574 696f 6e2e 6372 6561 7465 280d  pletion.create(.
+00001830: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+00001840: 656c 203d 2073 656c 662e 6c6c 6d5f 6675  el = self.llm_fu
+00001850: 6e63 2c0d 0a20 2020 2020 2020 2020 2020  nc,..           
+00001860: 206d 6573 7361 6765 733d 6d65 7373 6167   messages=messag
+00001870: 6573 2c0d 0a20 2020 2020 2020 2020 2020  es,..           
+00001880: 2066 756e 6374 696f 6e73 3d66 756e 6374   functions=funct
+00001890: 696f 6e73 2c0d 0a20 2020 2020 2020 2020  ions,..         
+000018a0: 2020 2066 756e 6374 696f 6e5f 6361 6c6c     function_call
+000018b0: 203d 2066 756e 6374 696f 6e5f 6e61 6d65   = function_name
+000018c0: 2c0d 0a20 2020 2020 2020 2020 2020 2074  ,..            t
+000018d0: 656d 7065 7261 7475 7265 3d30 2c0d 0a20  emperature=0,.. 
+000018e0: 2020 2020 2020 2020 2020 2029 0d0a 2020             )..  
+000018f0: 2020 2020 2020 0d0a 2020 2020 2020 2020        ..        
+00001900: 666e 5f6e 616d 6520 3d20 7265 7370 6f6e  fn_name = respon
+00001910: 7365 2e63 686f 6963 6573 5b30 5d2e 6d65  se.choices[0].me
+00001920: 7373 6167 655b 2266 756e 6374 696f 6e5f  ssage["function_
+00001930: 6361 6c6c 225d 2e6e 616d 650d 0a20 2020  call"].name..   
+00001940: 2020 2020 2061 7267 756d 656e 7473 203d       arguments =
+00001950: 2072 6573 706f 6e73 652e 6368 6f69 6365   response.choice
+00001960: 735b 305d 2e6d 6573 7361 6765 5b22 6675  s[0].message["fu
+00001970: 6e63 7469 6f6e 5f63 616c 6c22 5d2e 6172  nction_call"].ar
+00001980: 6775 6d65 6e74 730d 0a20 2020 2020 2020  guments..       
+00001990: 2074 6f6b 656e 735f 7573 6564 203d 2072   tokens_used = r
+000019a0: 6573 706f 6e73 652e 7573 6167 652e 746f  esponse.usage.to
+000019b0: 7461 6c5f 746f 6b65 6e73 0d0a 0d0a 2020  tal_tokens....  
+000019c0: 2020 2020 2020 7265 7475 726e 2066 6e5f        return fn_
+000019d0: 6e61 6d65 2c61 7267 756d 656e 7473 2c74  name,arguments,t
+000019e0: 6f6b 656e 735f 7573 6564 0d0a 0d0a 2020  okens_used....  
+000019f0: 2020 0d0a 2020 2020 2320 4675 6e63 7469    ..    # Functi
+00001a00: 6f6e 7320 746f 2073 616e 6974 697a 6520  ons to sanitize 
+00001a10: 7468 6520 6f75 7470 7574 2066 726f 6d20  the output from 
+00001a20: 7468 6520 4c4c 4d0d 0a20 2020 2064 6566  the LLM..    def
+00001a30: 205f 6578 7472 6163 745f 636f 6465 2873   _extract_code(s
+00001a40: 656c 662c 7265 7370 6f6e 7365 3a20 7374  elf,response: st
+00001a50: 722c 2073 6570 6172 6174 6f72 3a20 7374  r, separator: st
+00001a60: 7220 3d20 2260 6060 2229 202d 3e20 7374  r = "```") -> st
+00001a70: 723a 0d0a 0d0a 2020 2020 2020 2020 2320  r:....        # 
+00001a80: 4465 6669 6e65 2061 2062 6c61 636b 6c69  Define a blackli
+00001a90: 7374 206f 6620 5079 7468 6f6e 206b 6579  st of Python key
+00001aa0: 776f 7264 7320 616e 6420 6675 6e63 7469  words and functi
+00001ab0: 6f6e 7320 7468 6174 2061 7265 206e 6f74  ons that are not
+00001ac0: 2061 6c6c 6f77 6564 0d0a 2020 2020 2020   allowed..      
+00001ad0: 2020 626c 6163 6b6c 6973 7420 3d20 5b27    blacklist = ['
+00001ae0: 6f73 272c 2773 7562 7072 6f63 6573 7327  os','subprocess'
+00001af0: 2c27 7379 7327 2c27 6576 616c 272c 2765  ,'sys','eval','e
+00001b00: 7865 6327 2c27 6669 6c65 272c 2773 6f63  xec','file','soc
+00001b10: 6b65 7427 2c27 7572 6c6c 6962 272c 0d0a  ket','urllib',..
+00001b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b30: 2020 2020 2773 6875 7469 6c27 2c27 7069      'shutil','pi
+00001b40: 636b 6c65 272c 2763 7479 7065 7327 2c27  ckle','ctypes','
+00001b50: 6d75 6c74 6970 726f 6365 7373 696e 6727  multiprocessing'
+00001b60: 2c27 7465 6d70 6669 6c65 272c 2767 6c6f  ,'tempfile','glo
+00001b70: 6227 2c27 636f 6465 272c 2770 7479 272c  b','code','pty',
+00001b80: 2763 6f6d 6d61 6e64 7327 2c0d 0a20 2020  'commands',..   
+00001b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ba0: 2027 7265 7175 6573 7473 272c 2763 6769   'requests','cgi
+00001bb0: 272c 2763 6769 7462 272c 2778 6d6c 2e65  ','cgitb','xml.e
+00001bc0: 7472 6565 2e45 6c65 6d65 6e74 5472 6565  tree.ElementTree
+00001bd0: 272c 2762 7569 6c74 696e 7327 0d0a 2020  ','builtins'..  
+00001be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001bf0: 2020 5d0d 0a0d 0a20 2020 2020 2020 2023    ]....        #
+00001c00: 2053 6561 7263 6820 666f 7220 6120 7061   Search for a pa
+00001c10: 7474 6572 6e20 6265 7477 6565 6e20 3c63  ttern between <c
+00001c20: 6f64 653e 2061 6e64 203c 2f63 6f64 653e  ode> and </code>
+00001c30: 2069 6e20 7468 6520 6578 7472 6163 7465   in the extracte
+00001c40: 6420 636f 6465 0d0a 2020 2020 2020 2020  d code..        
+00001c50: 6d61 7463 6820 3d20 7265 2e73 6561 7263  match = re.searc
+00001c60: 6828 7222 3c63 6f64 653e 282e 2a29 3c2f  h(r"<code>(.*)</
+00001c70: 636f 6465 3e22 2c20 7265 7370 6f6e 7365  code>", response
+00001c80: 2c20 7265 2e44 4f54 414c 4c29 0d0a 2020  , re.DOTALL)..  
+00001c90: 2020 2020 2020 6966 206d 6174 6368 3a0d        if match:.
+00001ca0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+00001cb0: 6620 6120 6d61 7463 6820 6973 2066 6f75  f a match is fou
+00001cc0: 6e64 2c20 6578 7472 6163 7420 7468 6520  nd, extract the 
+00001cd0: 636f 6465 2062 6574 7765 656e 203c 636f  code between <co
+00001ce0: 6465 3e20 616e 6420 3c2f 636f 6465 3e0d  de> and </code>.
+00001cf0: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
+00001d00: 6520 3d20 6d61 7463 682e 6772 6f75 7028  e = match.group(
+00001d10: 3129 0d0a 2020 2020 2020 2020 2020 2020  1)..            
+00001d20: 2320 4966 2074 6865 2072 6573 706f 6e73  # If the respons
+00001d30: 6520 636f 6e74 6169 6e73 2074 6865 2073  e contains the s
+00001d40: 6570 6172 6174 6f72 2c20 6578 7472 6163  eparator, extrac
+00001d50: 7420 7468 6520 636f 6465 2062 6c6f 636b  t the code block
+00001d60: 2062 6574 7765 656e 2074 6865 2073 6570   between the sep
+00001d70: 6172 6174 6f72 730d 0a20 2020 2020 2020  arators..       
+00001d80: 2020 2020 2069 6620 6c65 6e28 636f 6465       if len(code
+00001d90: 2e73 706c 6974 2873 6570 6172 6174 6f72  .split(separator
+00001da0: 2929 203e 2031 3a0d 0a20 2020 2020 2020  )) > 1:..       
+00001db0: 2020 2020 2020 2020 2063 6f64 6520 3d20           code = 
+00001dc0: 636f 6465 2e73 706c 6974 2873 6570 6172  code.split(separ
+00001dd0: 6174 6f72 295b 315d 0d0a 0d0a 2020 2020  ator)[1]....    
+00001de0: 2020 2020 2320 4966 2074 6865 2072 6573      # If the res
+00001df0: 706f 6e73 6520 636f 6e74 6169 6e73 2074  ponse contains t
+00001e00: 6865 2073 6570 6172 6174 6f72 2c20 6578  he separator, ex
+00001e10: 7472 6163 7420 7468 6520 636f 6465 2062  tract the code b
+00001e20: 6c6f 636b 2062 6574 7765 656e 2074 6865  lock between the
+00001e30: 2073 6570 6172 6174 6f72 730d 0a20 2020   separators..   
+00001e40: 2020 2020 2069 6620 6c65 6e28 7265 7370       if len(resp
+00001e50: 6f6e 7365 2e73 706c 6974 2873 6570 6172  onse.split(separ
+00001e60: 6174 6f72 2929 203e 2031 3a0d 0a20 2020  ator)) > 1:..   
+00001e70: 2020 2020 2020 2020 2063 6f64 6520 3d20           code = 
+00001e80: 7265 7370 6f6e 7365 2e73 706c 6974 2873  response.split(s
+00001e90: 6570 6172 6174 6f72 295b 315d 0d0a 2020  eparator)[1]..  
+00001ea0: 2020 2020 2020 2020 2020 0d0a 2020 2020            ..    
+00001eb0: 2020 2020 2320 5265 6d6f 7665 2074 6865      # Remove the
+00001ec0: 2022 7079 7468 6f6e 2220 6f72 2022 7079   "python" or "py
+00001ed0: 2220 7072 6566 6978 2069 6620 7072 6573  " prefix if pres
+00001ee0: 656e 740d 0a20 2020 2020 2020 2069 6620  ent..        if 
+00001ef0: 7265 2e6d 6174 6368 2872 225e 2870 7974  re.match(r"^(pyt
+00001f00: 686f 6e7c 7079 2922 2c20 636f 6465 293a  hon|py)", code):
+00001f10: 0d0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+00001f20: 6465 203d 2072 652e 7375 6228 7222 5e28  de = re.sub(r"^(
+00001f30: 7079 7468 6f6e 7c70 7929 222c 2022 222c  python|py)", "",
+00001f40: 2063 6f64 6529 0d0a 2020 2020 2020 2020   code)..        
+00001f50: 2320 4966 2074 6865 2063 6f64 6520 6973  # If the code is
+00001f60: 2062 6574 7765 656e 2073 696e 676c 6520   between single 
+00001f70: 6261 636b 7469 636b 732c 2065 7874 7261  backticks, extra
+00001f80: 6374 2074 6865 2063 6f64 6520 6265 7477  ct the code betw
+00001f90: 6565 6e20 7468 656d 0d0a 2020 2020 2020  een them..      
+00001fa0: 2020 6966 2072 652e 6d61 7463 6828 7222    if re.match(r"
+00001fb0: 5e60 2e2a 6024 222c 2063 6f64 6529 3a0d  ^`.*`$", code):.
+00001fc0: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
+00001fd0: 6520 3d20 7265 2e73 7562 2872 225e 6028  e = re.sub(r"^`(
+00001fe0: 2e2a 2960 2422 2c20 7222 5c31 222c 2063  .*)`$", r"\1", c
+00001ff0: 6f64 6529 0d0a 0d0a 2020 2020 2020 2020  ode)....        
+00002000: 2320 5265 6d6f 7665 2061 6e79 2069 6e73  # Remove any ins
+00002010: 7461 6e63 6573 206f 6620 2264 6620 3d20  tances of "df = 
+00002020: 7064 2e72 6561 645f 6373 7628 2766 696c  pd.read_csv('fil
+00002030: 656e 616d 652e 6373 7627 2922 2066 726f  ename.csv')" fro
+00002040: 6d20 7468 6520 636f 6465 0d0a 2020 2020  m the code..    
+00002050: 2020 2020 636f 6465 203d 2072 652e 7375      code = re.su
+00002060: 6228 7222 6466 5c73 2a3d 5c73 2a70 645c  b(r"df\s*=\s*pd\
+00002070: 2e72 6561 645f 6373 765c 2827 2e2a 3f27  .read_csv\('.*?'
+00002080: 282c 2e2a 293f 5c29 222c 2022 222c 2063  (,.*)?\)", "", c
+00002090: 6f64 6529 0d0a 0d0a 2020 2020 2020 2020  ode)....        
+000020a0: 2320 4465 6669 6e65 2074 6865 2072 6567  # Define the reg
+000020b0: 756c 6172 2065 7870 7265 7373 696f 6e20  ular expression 
+000020c0: 7061 7474 6572 6e20 746f 206d 6174 6368  pattern to match
+000020d0: 2074 6865 2062 6c61 636b 6c69 7374 2069   the blacklist i
+000020e0: 7465 6d73 0d0a 2020 2020 2020 2020 7061  tems..        pa
+000020f0: 7474 6572 6e20 3d20 7222 5e28 2e2a 5c62  ttern = r"^(.*\b
+00002100: 2822 202b 2022 7c22 2e6a 6f69 6e28 626c  (" + "|".join(bl
+00002110: 6163 6b6c 6973 7429 202b 2072 2229 5c62  acklist) + r")\b
+00002120: 2e2a 2924 220d 0a0d 0a20 2020 2020 2020  .*)$"....       
+00002130: 2023 2052 6570 6c61 6365 2074 6865 2062   # Replace the b
+00002140: 6c61 636b 6c69 7374 2069 7465 6d73 2077  lacklist items w
+00002150: 6974 6820 636f 6d6d 656e 7473 0d0a 2020  ith comments..  
+00002160: 2020 2020 2020 636f 6465 203d 2072 652e        code = re.
+00002170: 7375 6228 7061 7474 6572 6e2c 2072 2223  sub(pattern, r"#
+00002180: 206e 6f74 2061 6c6c 6f77 6564 205c 3122   not allowed \1"
+00002190: 2c20 636f 6465 2c20 666c 6167 733d 7265  , code, flags=re
+000021a0: 2e4d 554c 5449 4c49 4e45 290d 0a0d 0a20  .MULTILINE).... 
+000021b0: 2020 2020 2020 2023 2052 6574 7572 6e20         # Return 
+000021c0: 7468 6520 636c 6561 6e65 6420 616e 6420  the cleaned and 
+000021d0: 6578 7472 6163 7465 6420 636f 6465 0d0a  extracted code..
+000021e0: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+000021f0: 6f64 652e 7374 7269 7028 290d 0a20 2020  ode.strip()..   
+00002200: 200d 0a20 2020 2064 6566 205f 6578 7472   ..    def _extr
+00002210: 6163 745f 7261 6e6b 2873 656c 662c 7265  act_rank(self,re
+00002220: 7370 6f6e 7365 3a20 7374 7229 202d 3e20  sponse: str) -> 
+00002230: 7374 723a 0d0a 0d0a 2020 2020 2020 2020  str:....        
+00002240: 2320 5365 6172 6368 2066 6f72 2061 2070  # Search for a p
+00002250: 6174 7465 726e 2062 6574 7765 656e 203c  attern between <
+00002260: 7261 6e6b 3e20 616e 6420 3c2f 7261 6e6b  rank> and </rank
+00002270: 3e20 696e 2074 6865 2072 6573 706f 6e73  > in the respons
+00002280: 650d 0a20 2020 2020 2020 206d 6174 6368  e..        match
+00002290: 203d 2072 652e 7365 6172 6368 2872 223c   = re.search(r"<
+000022a0: 7261 6e6b 3e28 2e2a 293c 2f72 616e 6b3e  rank>(.*)</rank>
+000022b0: 222c 2072 6573 706f 6e73 6529 0d0a 2020  ", response)..  
+000022c0: 2020 2020 2020 6966 206d 6174 6368 3a0d        if match:.
+000022d0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+000022e0: 6620 6120 6d61 7463 6820 6973 2066 6f75  f a match is fou
+000022f0: 6e64 2c20 6578 7472 6163 7420 7468 6520  nd, extract the 
+00002300: 7261 6e6b 2062 6574 7765 656e 203c 7261  rank between <ra
+00002310: 6e6b 3e20 616e 6420 3c2f 7261 6e6b 3e0d  nk> and </rank>.
+00002320: 0a20 2020 2020 2020 2020 2020 2072 616e  .            ran
+00002330: 6b20 3d20 6d61 7463 682e 6772 6f75 7028  k = match.group(
+00002340: 3129 0d0a 2020 2020 2020 2020 656c 7365  1)..        else
+00002350: 3a0d 0a20 2020 2020 2020 2020 2020 2072  :..            r
+00002360: 616e 6b20 3d20 2222 0d0a 0d0a 2020 2020  ank = ""....    
+00002370: 2020 2020 2320 5265 7475 726e 2074 6865      # Return the
+00002380: 2063 6c65 616e 6564 2061 6e64 2065 7874   cleaned and ext
+00002390: 7261 6374 6564 2063 6f64 650d 0a20 2020  racted code..   
+000023a0: 2020 2020 2072 6574 7572 6e20 7261 6e6b       return rank
+000023b0: 2e73 7472 6970 2829 0d0a 2020 2020 0d0a  .strip()..    ..
+000023c0: 2020 2020 2320 4675 6e63 7469 6f6e 2074      # Function t
+000023d0: 6f20 7265 6d6f 7665 2065 7861 6d70 6c65  o remove example
+000023e0: 7320 6672 6f6d 206d 6573 7361 6765 7320  s from messages 
+000023f0: 7768 656e 206e 6f20 6c6f 6e67 6572 206e  when no longer n
+00002400: 6565 6465 640d 0a20 2020 2064 6566 205f  eeded..    def _
+00002410: 7265 6d6f 7665 5f65 7861 6d70 6c65 7328  remove_examples(
+00002420: 7365 6c66 2c6d 6573 7361 6765 733a 2073  self,messages: s
+00002430: 7472 2920 2d3e 2073 7472 3a0d 0a20 2020  tr) -> str:..   
+00002440: 2020 2020 2023 2044 6566 696e 6520 7468       # Define th
+00002450: 6520 7265 6775 6c61 7220 6578 7072 6573  e regular expres
+00002460: 7369 6f6e 2070 6174 7465 726e 0d0a 2020  sion pattern..  
+00002470: 2020 2020 2020 7061 7474 6572 6e20 3d20        pattern = 
+00002480: 2745 7861 6d70 6c65 204f 7574 7075 743a  'Example Output:
+00002490: 5c73 2a3c 636f 6465 3e2e 2a3f 3c2f 636f  \s*<code>.*?</co
+000024a0: 6465 3e5c 732a 270d 0a0d 0a20 2020 2020  de>\s*'....     
+000024b0: 2020 2023 2049 7465 7261 7465 206f 7665     # Iterate ove
+000024c0: 7220 7468 6520 6c69 7374 206f 6620 6469  r the list of di
+000024d0: 6374 696f 6e61 7269 6573 0d0a 2020 2020  ctionaries..    
+000024e0: 2020 2020 666f 7220 6469 6374 2069 6e20      for dict in 
+000024f0: 6d65 7373 6167 6573 3a0d 0a20 2020 2020  messages:..     
+00002500: 2020 2020 2020 2023 2041 6363 6573 7320         # Access 
+00002510: 616e 6420 636c 6561 6e20 7570 2027 636f  and clean up 'co
+00002520: 6e74 656e 7427 2066 6965 6c64 0d0a 2020  ntent' field..  
+00002530: 2020 2020 2020 2020 2020 6966 2064 6963            if dic
+00002540: 742e 6765 7428 2772 6f6c 6527 2920 3d3d  t.get('role') ==
+00002550: 2027 7573 6572 2720 616e 6420 2763 6f6e   'user' and 'con
+00002560: 7465 6e74 2720 696e 2064 6963 743a 0d0a  tent' in dict:..
+00002570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002580: 6469 6374 5b27 636f 6e74 656e 7427 5d20  dict['content'] 
+00002590: 3d20 7265 2e73 7562 2870 6174 7465 726e  = re.sub(pattern
+000025a0: 2c20 2727 2c20 6469 6374 5b27 636f 6e74  , '', dict['cont
+000025b0: 656e 7427 5d2c 2066 6c61 6773 3d72 652e  ent'], flags=re.
+000025c0: 444f 5441 4c4c 290d 0a0d 0a20 2020 2020  DOTALL)....     
+000025d0: 2020 2072 6574 7572 6e20 6d65 7373 6167     return messag
+000025e0: 6573 0d0a 2020 2020 0d0a 2020 2020 6465  es..    ..    de
+000025f0: 6620 7461 736b 5f65 7661 6c28 7365 6c66  f task_eval(self
+00002600: 2c20 6576 616c 5f6d 6573 7361 6765 7329  , eval_messages)
+00002610: 3a0d 0a0d 0a20 2020 2020 2020 2069 6620  :....        if 
+00002620: 2769 7079 6b65 726e 656c 2720 696e 2073  'ipykernel' in s
+00002630: 7973 2e6d 6f64 756c 6573 3a0d 0a20 2020  ys.modules:..   
+00002640: 2020 2020 2020 2020 2023 204a 7570 7974           # Jupyt
+00002650: 6572 206e 6f74 6562 6f6f 6b20 6f72 2069  er notebook or i
+00002660: 7079 7468 6f6e 0d0a 2020 2020 2020 2020  python..        
+00002670: 2020 2020 6469 7370 6c61 7928 4854 4d4c      display(HTML
+00002680: 2866 273c 7020 7374 796c 653d 2263 6f6c  (f'<p style="col
+00002690: 6f72 3a6d 6167 656e 7461 3b22 3e5c 6e43  or:magenta;">\nC
+000026a0: 616c 6c69 6e67 204d 6f64 656c 3a20 7b73  alling Model: {s
+000026b0: 656c 662e 6c6c 6d5f 6675 6e63 7d3c 2f70  elf.llm_func}</p
+000026c0: 3e27 2929 0d0a 2020 2020 2020 2020 2020  >'))..          
+000026d0: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
+000026e0: 273c 703e 3c62 2073 7479 6c65 3d22 636f  '<p><b style="co
+000026f0: 6c6f 723a 6d61 6765 6e74 613b 223e 5472  lor:magenta;">Tr
+00002700: 7969 6e67 2074 6f20 6465 7465 726d 696e  ying to determin
+00002710: 6520 7468 6520 6265 7374 206d 6574 686f  e the best metho
+00002720: 6420 746f 2061 6e73 7765 7220 796f 7572  d to answer your
+00002730: 2071 7565 7374 696f 6e2c 2070 6c65 6173   question, pleas
+00002740: 6520 7761 6974 2e2e 2e3c 2f62 3e3c 2f70  e wait...</b></p
+00002750: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
+00002760: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
+00002770: 2020 2020 2023 204f 7468 6572 2065 6e76       # Other env
+00002780: 6972 6f6e 6d65 6e74 2028 6c69 6b65 2074  ironment (like t
+00002790: 6572 6d69 6e61 6c29 0d0a 2020 2020 2020  erminal)..      
+000027a0: 2020 2020 2020 7072 696e 7428 636f 6c6f        print(colo
+000027b0: 7265 6428 6622 5c6e 3e3e 2043 616c 6c69  red(f"\n>> Calli
+000027c0: 6e67 204d 6f64 656c 3a20 7b73 656c 662e  ng Model: {self.
+000027d0: 6c6c 6d5f 6675 6e63 7d22 2c20 226d 6167  llm_func}", "mag
+000027e0: 656e 7461 2229 290d 0a20 2020 2020 2020  enta"))..       
+000027f0: 2020 2020 2063 7072 696e 7428 6622 5c6e       cprint(f"\n
+00002800: 3e3e 2054 7279 696e 6720 746f 2064 6574  >> Trying to det
+00002810: 6572 6d69 6e65 2074 6865 2062 6573 7420  ermine the best 
+00002820: 6d65 7468 6f64 2074 6f20 616e 7377 6572  method to answer
+00002830: 2079 6f75 7220 7175 6573 7469 6f6e 2c20   your question, 
+00002840: 706c 6561 7365 2077 6169 742e 2e2e 5c6e  please wait...\n
+00002850: 222c 2027 6d61 6765 6e74 6127 2c20 6174  ", 'magenta', at
+00002860: 7472 733d 5b27 626f 6c64 275d 290d 0a0d  trs=['bold'])...
+00002870: 0a20 2020 2020 2020 2023 2043 616c 6c20  .        # Call 
+00002880: 4f70 656e 4149 2041 5049 0d0a 2020 2020  OpenAI API..    
+00002890: 2020 2020 6675 6e63 7469 6f6e 5f6e 616d      function_nam
+000028a0: 6520 3d20 7b22 6e61 6d65 223a 2022 5141  e = {"name": "QA
+000028b0: 5f52 6573 706f 6e73 6522 7d0d 0a20 2020  _Response"}..   
+000028c0: 2020 2020 2066 6e5f 6e61 6d65 2c20 6172       fn_name, ar
+000028d0: 6775 6d65 6e74 732c 2074 6f6b 656e 735f  guments, tokens_
+000028e0: 7573 6564 203d 2073 656c 662e 6c6c 6d5f  used = self.llm_
+000028f0: 6675 6e63 5f63 616c 6c28 6576 616c 5f6d  func_call(eval_m
+00002900: 6573 7361 6765 732c 7365 6c66 2e74 6173  essages,self.tas
+00002910: 6b5f 6576 616c 5f66 756e 6374 696f 6e2c  k_eval_function,
+00002920: 2066 756e 6374 696f 6e5f 6e61 6d65 290d   function_name).
+00002930: 0a0d 0a20 2020 2020 2020 2023 2050 6172  ...        # Par
+00002940: 7365 2074 6865 204a 534f 4e20 7374 7269  se the JSON stri
+00002950: 6e67 2074 6f20 6120 5079 7468 6f6e 2064  ng to a Python d
+00002960: 6963 740d 0a20 2020 2020 2020 2061 7267  ict..        arg
+00002970: 756d 656e 7473 5f64 6963 7420 3d20 6a73  uments_dict = js
+00002980: 6f6e 2e6c 6f61 6473 2861 7267 756d 656e  on.loads(argumen
+00002990: 7473 2c20 7374 7269 6374 3d46 616c 7365  ts, strict=False
+000029a0: 290d 0a0d 0a20 2020 2020 2020 2023 2052  )....        # R
+000029b0: 6574 7269 6576 6520 7661 6c75 6573 0d0a  etrieve values..
+000029c0: 2020 2020 2020 2020 6576 616c 5f61 6e73          eval_ans
+000029d0: 7765 7220 3d20 6172 6775 6d65 6e74 735f  wer = arguments_
+000029e0: 6469 6374 5b22 616e 7377 6572 225d 0d0a  dict["answer"]..
+000029f0: 2020 2020 2020 2020 6576 616c 5f61 6e73          eval_ans
+00002a00: 7765 725f 7479 7065 203d 2061 7267 756d  wer_type = argum
+00002a10: 656e 7473 5f64 6963 745b 2261 6e73 7765  ents_dict["answe
+00002a20: 725f 7479 7065 225d 0d0a 0d0a 2020 2020  r_type"]....    
+00002a30: 2020 2020 7365 6c66 2e74 6f74 616c 5f74      self.total_t
+00002a40: 6f6b 656e 735f 7573 6564 2e61 7070 656e  okens_used.appen
+00002a50: 6428 746f 6b65 6e73 5f75 7365 6429 0d0a  d(tokens_used)..
+00002a60: 0d0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00002a70: 2061 7267 756d 656e 7473 2c20 666e 5f6e   arguments, fn_n
+00002a80: 616d 652c 2065 7661 6c5f 616e 7377 6572  ame, eval_answer
+00002a90: 2c20 6576 616c 5f61 6e73 7765 725f 7479  , eval_answer_ty
+00002aa0: 7065 0d0a 0d0a 2020 2020 6465 6620 6465  pe....    def de
+00002ab0: 6275 675f 636f 6465 2873 656c 662c 636f  bug_code(self,co
+00002ac0: 6465 2c71 7565 7374 696f 6e2c 206c 6c6d  de,question, llm
+00002ad0: 5f63 6173 6361 6465 3d46 616c 7365 293a  _cascade=False):
+00002ae0: 0d0a 2020 2020 2020 2020 2320 496e 6974  ..        # Init
+00002af0: 6961 6c69 7a65 2074 6865 206d 6573 7361  ialize the messa
+00002b00: 6765 7320 6c69 7374 2077 6974 6820 6120  ges list with a 
+00002b10: 7379 7374 656d 206d 6573 7361 6765 2063  system message c
+00002b20: 6f6e 7461 696e 696e 6720 7468 6520 7461  ontaining the ta
+00002b30: 736b 2070 726f 6d70 740d 0a20 2020 2020  sk prompt..     
+00002b40: 2020 2064 6562 7567 5f6d 6573 7361 6765     debug_message
+00002b50: 7320 3d20 5b7b 2272 6f6c 6522 3a20 2273  s = [{"role": "s
+00002b60: 7973 7465 6d22 2c20 2263 6f6e 7465 6e74  ystem", "content
+00002b70: 223a 2073 656c 662e 6465 6275 675f 636f  ": self.debug_co
+00002b80: 6465 5f74 6173 6b2e 666f 726d 6174 2863  de_task.format(c
+00002b90: 6f64 652c 7175 6573 7469 6f6e 297d 5d0d  ode,question)}].
+00002ba0: 0a0d 0a20 2020 2020 2020 2075 7369 6e67  ...        using
+00002bb0: 5f6d 6f64 656c 203d 2073 656c 662e 6c6c  _model = self.ll
+00002bc0: 6d0d 0a20 2020 2020 2020 2069 6620 6c6c  m..        if ll
+00002bd0: 6d5f 6361 7363 6164 653a 0d0a 2020 2020  m_cascade:..    
+00002be0: 2020 2020 2020 2020 7573 696e 675f 6d6f          using_mo
+00002bf0: 6465 6c20 3d20 7365 6c66 2e6c 6c6d 5f67  del = self.llm_g
+00002c00: 7074 340d 0a0d 0a20 2020 2020 2020 2069  pt4....        i
+00002c10: 6620 2769 7079 6b65 726e 656c 2720 696e  f 'ipykernel' in
+00002c20: 2073 7973 2e6d 6f64 756c 6573 3a0d 0a20   sys.modules:.. 
+00002c30: 2020 2020 2020 2020 2020 2023 204a 7570             # Jup
+00002c40: 7974 6572 206e 6f74 6562 6f6f 6b20 6f72  yter notebook or
+00002c50: 2069 7079 7468 6f6e 0d0a 2020 2020 2020   ipython..      
+00002c60: 2020 2020 2020 6469 7370 6c61 7928 4854        display(HT
+00002c70: 4d4c 2866 273c 7020 7374 796c 653d 2263  ML(f'<p style="c
+00002c80: 6f6c 6f72 3a6d 6167 656e 7461 3b22 3e5c  olor:magenta;">\
+00002c90: 6e43 616c 6c69 6e67 204d 6f64 656c 3a20  nCalling Model: 
+00002ca0: 7b75 7369 6e67 5f6d 6f64 656c 7d3c 2f70  {using_model}</p
+00002cb0: 3e27 2929 0d0a 2020 2020 2020 2020 2020  >'))..          
+00002cc0: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
+00002cd0: 273c 703e 3c62 2073 7479 6c65 3d22 636f  '<p><b style="co
+00002ce0: 6c6f 723a 6d61 6765 6e74 613b 223e 4920  lor:magenta;">I 
+00002cf0: 6861 7665 2072 6563 6569 7665 6420 7468  have received th
+00002d00: 6520 6669 7273 7420 7665 7273 696f 6e20  e first version 
+00002d10: 6f66 2074 6865 2063 6f64 652e 2049 2061  of the code. I a
+00002d20: 6d20 7365 6e64 696e 6720 6974 2062 6163  m sending it bac
+00002d30: 6b20 746f 204c 4c4d 2074 6f20 6765 7420  k to LLM to get 
+00002d40: 6974 2063 6865 636b 6564 2066 6f72 2061  it checked for a
+00002d50: 6e79 2065 7272 6f72 732c 2062 7567 7320  ny errors, bugs 
+00002d60: 6f72 2069 6e63 6f6e 7369 7374 656e 6369  or inconsistenci
+00002d70: 6573 2c20 616e 6420 636f 7272 6563 7469  es, and correcti
+00002d80: 6f6e 2069 6620 6e65 6365 7373 6172 792e  on if necessary.
+00002d90: 2050 6c65 6173 6520 7761 6974 2e2e 2e3c   Please wait...<
+00002da0: 2f62 3e3c 2f70 3e3c 6272 3e27 2929 0d0a  /b></p><br>'))..
+00002db0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00002dc0: 2020 2020 2020 2020 2020 2023 204f 7468             # Oth
+00002dd0: 6572 2065 6e76 6972 6f6e 6d65 6e74 2028  er environment (
+00002de0: 6c69 6b65 2074 6572 6d69 6e61 6c29 0d0a  like terminal)..
+00002df0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00002e00: 7428 636f 6c6f 7265 6428 6622 5c6e 3e3e  t(colored(f"\n>>
+00002e10: 2043 616c 6c69 6e67 204d 6f64 656c 3a20   Calling Model: 
+00002e20: 7b75 7369 6e67 5f6d 6f64 656c 7d22 2c20  {using_model}", 
+00002e30: 226d 6167 656e 7461 2229 290d 0a20 2020  "magenta"))..   
+00002e40: 2020 2020 2020 2020 2063 7072 696e 7428           cprint(
+00002e50: 6622 5c6e 3e3e 2049 2068 6176 6520 7265  f"\n>> I have re
+00002e60: 6365 6976 6564 2074 6865 2066 6972 7374  ceived the first
+00002e70: 2076 6572 7369 6f6e 206f 6620 7468 6520   version of the 
+00002e80: 636f 6465 2e20 4920 616d 2073 656e 6469  code. I am sendi
+00002e90: 6e67 2069 7420 6261 636b 2074 6f20 4c4c  ng it back to LL
+00002ea0: 4d20 746f 2067 6574 2069 7420 6368 6563  M to get it chec
+00002eb0: 6b65 6420 666f 7220 616e 7920 6572 726f  ked for any erro
+00002ec0: 7273 2c20 6275 6773 206f 7220 696e 636f  rs, bugs or inco
+00002ed0: 6e73 6973 7465 6e63 6965 732c 2061 6e64  nsistencies, and
+00002ee0: 2063 6f72 7265 6374 696f 6e20 6966 206e   correction if n
+00002ef0: 6563 6573 7361 7279 2e20 506c 6561 7365  ecessary. Please
+00002f00: 2077 6169 742e 2e2e 5c6e 222c 2027 6d61   wait...\n", 'ma
+00002f10: 6765 6e74 6127 2c20 6174 7472 733d 5b27  genta', attrs=['
+00002f20: 626f 6c64 275d 290d 0a0d 0a20 2020 2020  bold'])....     
+00002f30: 2020 2023 2046 756e 6374 696f 6e20 746f     # Function to
+00002f40: 2064 6973 706c 6179 2072 6573 756c 7473   display results
+00002f50: 206e 6963 656c 790d 0a20 2020 2020 2020   nicely..       
+00002f60: 2064 6566 2064 6973 706c 6179 5f74 6173   def display_tas
+00002f70: 6b28 293a 0d0a 2020 2020 2020 2020 2020  k():..          
+00002f80: 2020 6966 2027 6970 796b 6572 6e65 6c27    if 'ipykernel'
+00002f90: 2069 6e20 7379 732e 6d6f 6475 6c65 733a   in sys.modules:
+00002fa0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00002fb0: 2020 2320 4a75 7079 7465 7220 6e6f 7465    # Jupyter note
+00002fc0: 626f 6f6b 206f 7220 6970 7974 686f 6e0d  book or ipython.
+00002fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002fe0: 2064 6973 706c 6179 2848 544d 4c28 6627   display(HTML(f'
+00002ff0: 3c70 3e3c 6220 7374 796c 653d 2263 6f6c  <p><b style="col
+00003000: 6f72 3a6d 6167 656e 7461 3b22 3e49 2068  or:magenta;">I h
+00003010: 6176 6520 6669 6e69 7368 6564 2064 6562  ave finished deb
+00003020: 7567 6769 6e67 2074 6865 2063 6f64 652c  ugging the code,
+00003030: 2061 6e64 2077 696c 6c20 6e6f 7720 7072   and will now pr
+00003040: 6f63 6565 6420 746f 2074 6865 2065 7865  oceed to the exe
+00003050: 6375 7469 6f6e 2e2e 2e3c 2f62 3e3c 2f70  cution...</b></p
+00003060: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
+00003070: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+00003080: 2020 2020 2020 2020 2020 2020 2023 204f               # O
+00003090: 7468 6572 2065 6e76 6972 6f6e 6d65 6e74  ther environment
+000030a0: 2028 6c69 6b65 2074 6572 6d69 6e61 6c29   (like terminal)
+000030b0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000030c0: 2020 6370 7269 6e74 2866 225c 6e3e 3e20    cprint(f"\n>> 
+000030d0: 4920 6861 7665 2066 696e 6973 6865 6420  I have finished 
+000030e0: 6465 6275 6767 696e 6720 7468 6520 636f  debugging the co
+000030f0: 6465 2c20 616e 6420 7769 6c6c 206e 6f77  de, and will now
+00003100: 2070 726f 6365 6564 2074 6f20 7468 6520   proceed to the 
+00003110: 6578 6563 7574 696f 6e2e 2e2e 5c6e 222c  execution...\n",
+00003120: 2027 6d61 6765 6e74 6127 2c20 6174 7472   'magenta', attr
+00003130: 733d 5b27 626f 6c64 275d 290d 0a0d 0a20  s=['bold']).... 
+00003140: 2020 2020 2020 2023 2043 616c 6c20 7468         # Call th
+00003150: 6520 4f70 656e 4149 2041 5049 0d0a 2020  e OpenAI API..  
+00003160: 2020 2020 2020 6c6c 6d5f 7265 7370 6f6e        llm_respon
+00003170: 7365 2c20 746f 6b65 6e73 5f75 7365 6420  se, tokens_used 
+00003180: 3d20 7365 6c66 2e6c 6c6d 5f63 616c 6c28  = self.llm_call(
+00003190: 6465 6275 675f 6d65 7373 6167 6573 2c74  debug_messages,t
+000031a0: 656d 7065 7261 7475 7265 3d30 2c6c 6c6d  emperature=0,llm
+000031b0: 5f63 6173 6361 6465 3d6c 6c6d 5f63 6173  _cascade=llm_cas
+000031c0: 6361 6465 2920 2320 6869 6768 6572 2074  cade) # higher t
+000031d0: 656d 7065 7261 7475 7265 2072 6573 756c  emperature resul
+000031e0: 7473 2069 6e20 6d6f 7265 2022 6372 6561  ts in more "crea
+000031f0: 7469 7665 2220 616e 7377 6572 7320 2873  tive" answers (s
+00003200: 6f6d 6574 696d 6573 2074 6f6f 2063 7265  ometimes too cre
+00003210: 6174 6976 6520 3a2d 2929 0d0a 2020 2020  ative :-))..    
+00003220: 2020 2020 0d0a 2020 2020 2020 2020 2320      ..        # 
+00003230: 4578 7472 6163 7420 7468 6520 636f 6465  Extract the code
+00003240: 2066 726f 6d20 7468 6520 4150 4920 7265   from the API re
+00003250: 7370 6f6e 7365 0d0a 2020 2020 2020 2020  sponse..        
+00003260: 6465 6275 6767 6564 5f63 6f64 6520 3d20  debugged_code = 
+00003270: 7365 6c66 2e5f 6578 7472 6163 745f 636f  self._extract_co
+00003280: 6465 286c 6c6d 5f72 6573 706f 6e73 6529  de(llm_response)
+00003290: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
+000032a0: 2064 6973 706c 6179 5f74 6173 6b28 290d   display_task().
+000032b0: 0a0d 0a20 2020 2020 2020 2073 656c 662e  ...        self.
+000032c0: 746f 7461 6c5f 746f 6b65 6e73 5f75 7365  total_tokens_use
+000032d0: 642e 6170 7065 6e64 2874 6f6b 656e 735f  d.append(tokens_
+000032e0: 7573 6564 290d 0a0d 0a20 2020 2020 2020  used)....       
+000032f0: 2072 6574 7572 6e20 6465 6275 6767 6564   return debugged
+00003300: 5f63 6f64 650d 0a0d 0a20 2020 2064 6566  _code....    def
+00003310: 2072 616e 6b5f 636f 6465 2873 656c 662c   rank_code(self,
+00003320: 636f 6465 2c71 7565 7374 696f 6e2c 6c6c  code,question,ll
+00003330: 6d5f 6361 7363 6164 653d 4661 6c73 6529  m_cascade=False)
+00003340: 3a0d 0a20 2020 2020 2020 2023 2049 6e69  :..        # Ini
+00003350: 7469 616c 697a 6520 7468 6520 6d65 7373  tialize the mess
+00003360: 6167 6573 206c 6973 7420 7769 7468 2061  ages list with a
+00003370: 2073 7973 7465 6d20 6d65 7373 6167 6520   system message 
+00003380: 636f 6e74 6169 6e69 6e67 2074 6865 2074  containing the t
+00003390: 6173 6b20 7072 6f6d 7074 0d0a 2020 2020  ask prompt..    
+000033a0: 2020 2020 7261 6e6b 5f6d 6573 7361 6765      rank_message
+000033b0: 7320 3d20 5b7b 2272 6f6c 6522 3a20 2273  s = [{"role": "s
+000033c0: 7973 7465 6d22 2c20 2263 6f6e 7465 6e74  ystem", "content
+000033d0: 223a 2073 656c 662e 7261 6e6b 5f61 6e73  ": self.rank_ans
+000033e0: 7765 722e 666f 726d 6174 2863 6f64 652c  wer.format(code,
+000033f0: 7175 6573 7469 6f6e 297d 5d0d 0a0d 0a20  question)}].... 
+00003400: 2020 2020 2020 2075 7369 6e67 5f6d 6f64         using_mod
+00003410: 656c 203d 2073 656c 662e 6c6c 6d0d 0a20  el = self.llm.. 
+00003420: 2020 2020 2020 2069 6620 6c6c 6d5f 6361         if llm_ca
+00003430: 7363 6164 653a 0d0a 2020 2020 2020 2020  scade:..        
+00003440: 2020 2020 7573 696e 675f 6d6f 6465 6c20      using_model 
+00003450: 3d20 7365 6c66 2e6c 6c6d 5f67 7074 340d  = self.llm_gpt4.
+00003460: 0a0d 0a20 2020 2020 2020 2069 6620 2769  ...        if 'i
+00003470: 7079 6b65 726e 656c 2720 696e 2073 7973  pykernel' in sys
+00003480: 2e6d 6f64 756c 6573 3a0d 0a20 2020 2020  .modules:..     
+00003490: 2020 2020 2020 2023 204a 7570 7974 6572         # Jupyter
+000034a0: 206e 6f74 6562 6f6f 6b20 6f72 2069 7079   notebook or ipy
+000034b0: 7468 6f6e 0d0a 2020 2020 2020 2020 2020  thon..          
+000034c0: 2020 6469 7370 6c61 7928 4854 4d4c 2866    display(HTML(f
+000034d0: 273c 7020 7374 796c 653d 2263 6f6c 6f72  '<p style="color
+000034e0: 3a6d 6167 656e 7461 3b22 3e5c 6e43 616c  :magenta;">\nCal
+000034f0: 6c69 6e67 204d 6f64 656c 3a20 7b75 7369  ling Model: {usi
+00003500: 6e67 5f6d 6f64 656c 7d3c 2f70 3e27 2929  ng_model}</p>'))
+00003510: 0d0a 2020 2020 2020 2020 2020 2020 6469  ..            di
+00003520: 7370 6c61 7928 4854 4d4c 2866 273c 703e  splay(HTML(f'<p>
+00003530: 3c62 2073 7479 6c65 3d22 636f 6c6f 723a  <b style="color:
+00003540: 6d61 6765 6e74 613b 223e 4920 616d 2067  magenta;">I am g
+00003550: 6f69 6e67 2074 6f20 6576 616c 7561 7465  oing to evaluate
+00003560: 2061 6e64 2072 616e 6b20 7468 6520 616e   and rank the an
+00003570: 7377 6572 2e20 506c 6561 7365 2077 6169  swer. Please wai
+00003580: 742e 2e2e 3c2f 623e 3c2f 703e 3c62 723e  t...</b></p><br>
+00003590: 2729 290d 0a20 2020 2020 2020 2065 6c73  '))..        els
+000035a0: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+000035b0: 2320 4f74 6865 7220 656e 7669 726f 6e6d  # Other environm
+000035c0: 656e 7420 286c 696b 6520 7465 726d 696e  ent (like termin
+000035d0: 616c 290d 0a20 2020 2020 2020 2020 2020  al)..           
+000035e0: 2070 7269 6e74 2863 6f6c 6f72 6564 2866   print(colored(f
+000035f0: 225c 6e3e 3e20 4361 6c6c 696e 6720 4d6f  "\n>> Calling Mo
+00003600: 6465 6c3a 207b 7573 696e 675f 6d6f 6465  del: {using_mode
+00003610: 6c7d 222c 2022 6d61 6765 6e74 6122 2929  l}", "magenta"))
+00003620: 0d0a 2020 2020 2020 2020 2020 2020 6370  ..            cp
+00003630: 7269 6e74 2866 225c 6e3e 3e20 4920 616d  rint(f"\n>> I am
+00003640: 2067 6f69 6e67 2074 6f20 6576 616c 7561   going to evalua
+00003650: 7465 2061 6e64 2072 616e 6b20 7468 6520  te and rank the 
+00003660: 616e 7377 6572 2e20 506c 6561 7365 2077  answer. Please w
+00003670: 6169 742e 2e5c 6e22 2c20 276d 6167 656e  ait..\n", 'magen
+00003680: 7461 272c 2061 7474 7273 3d5b 2762 6f6c  ta', attrs=['bol
+00003690: 6427 5d29 0d0a 0d0a 2020 2020 2020 2020  d'])....        
+000036a0: 2320 4361 6c6c 2074 6865 204f 7065 6e41  # Call the OpenA
+000036b0: 4920 4150 4920 0d0a 2020 2020 2020 2020  I API ..        
+000036c0: 6c6c 6d5f 7265 7370 6f6e 7365 2c20 746f  llm_response, to
+000036d0: 6b65 6e73 5f75 7365 6420 3d20 7365 6c66  kens_used = self
+000036e0: 2e6c 6c6d 5f63 616c 6c28 7261 6e6b 5f6d  .llm_call(rank_m
+000036f0: 6573 7361 6765 732c 6c6c 6d5f 6361 7363  essages,llm_casc
+00003700: 6164 653d 6c6c 6d5f 6361 7363 6164 6529  ade=llm_cascade)
+00003710: 0d0a 0d0a 2020 2020 2020 2020 2320 4578  ....        # Ex
+00003720: 7472 6163 7420 7468 6520 7261 6e6b 2066  tract the rank f
+00003730: 726f 6d20 7468 6520 4150 4920 7265 7370  rom the API resp
+00003740: 6f6e 7365 0d0a 2020 2020 2020 2020 7261  onse..        ra
+00003750: 6e6b 203d 2073 656c 662e 5f65 7874 7261  nk = self._extra
+00003760: 6374 5f72 616e 6b28 6c6c 6d5f 7265 7370  ct_rank(llm_resp
+00003770: 6f6e 7365 2920 2020 2020 2020 0d0a 0d0a  onse)       ....
+00003780: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+00003790: 616c 5f74 6f6b 656e 735f 7573 6564 2e61  al_tokens_used.a
+000037a0: 7070 656e 6428 746f 6b65 6e73 5f75 7365  ppend(tokens_use
+000037b0: 6429 0d0a 0d0a 2020 2020 2020 2020 7265  d)....        re
+000037c0: 7475 726e 2072 616e 6b0d 0a0d 0a20 2020  turn rank....   
+000037d0: 2064 6566 2070 645f 6167 656e 745f 636f   def pd_agent_co
+000037e0: 6e76 6572 7365 2873 656c 662c 2071 7565  nverse(self, que
+000037f0: 7374 696f 6e3d 4e6f 6e65 293a 0d0a 2020  stion=None):..  
+00003800: 2020 2020 2020 2320 4675 6e63 7469 6f6e        # Function
+00003810: 7320 746f 2064 6973 706c 6179 2072 6573  s to display res
+00003820: 756c 7473 206e 6963 656c 790d 0a20 2020  ults nicely..   
+00003830: 2020 2020 2064 6566 2064 6973 706c 6179       def display
+00003840: 5f72 6573 756c 7473 2861 6e73 7765 722c  _results(answer,
+00003850: 2063 6f64 652c 2072 616e 6b2c 2074 6f74   code, rank, tot
+00003860: 616c 5f74 6f6b 656e 735f 7573 6564 5f73  al_tokens_used_s
+00003870: 756d 293a 0d0a 2020 2020 2020 2020 2020  um):..          
+00003880: 2020 6966 2027 6970 796b 6572 6e65 6c27    if 'ipykernel'
+00003890: 2069 6e20 7379 732e 6d6f 6475 6c65 733a   in sys.modules:
+000038a0: 2020 2020 200d 0a20 2020 2020 2020 2020       ..         
+000038b0: 2020 2020 2020 2069 6620 616e 7377 6572         if answer
+000038c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+000038d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000038e0: 2020 2064 6973 706c 6179 2848 544d 4c28     display(HTML(
+000038f0: 6627 3c70 3e3c 6220 7374 796c 653d 2263  f'<p><b style="c
+00003900: 6f6c 6f72 3a62 6c75 653b 223e 4920 6e6f  olor:blue;">I no
+00003910: 7720 6861 7665 2074 6865 2066 696e 616c  w have the final
+00003920: 2061 6e73 7765 723a 3c2f 623e 3c62 723e   answer:</b><br>
+00003930: 3c70 7265 2073 7479 6c65 3d22 636f 6c6f  <pre style="colo
+00003940: 723a 626c 6163 6b3b 2077 6869 7465 2d73  r:black; white-s
+00003950: 7061 6365 3a20 7072 652d 7772 6170 3b20  pace: pre-wrap; 
+00003960: 666f 6e74 2d77 6569 6768 743a 2062 6f6c  font-weight: bol
+00003970: 643b 223e 7b61 6e73 7765 727d 3c2f 7072  d;">{answer}</pr
+00003980: 653e 3c2f 703e 3c62 723e 2729 290d 0a20  e></p><br>')).. 
+00003990: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000039a0: 6620 636f 6465 2069 7320 6e6f 7420 4e6f  f code is not No
+000039b0: 6e65 3a0d 0a20 2020 2020 2020 2020 2020  ne:..           
+000039c0: 2020 2020 2020 2020 2064 6973 706c 6179           display
+000039d0: 2848 544d 4c28 6627 3c70 3e3c 6220 7374  (HTML(f'<p><b st
+000039e0: 796c 653d 2263 6f6c 6f72 3a62 6c75 653b  yle="color:blue;
+000039f0: 223e 4865 7265 2069 7320 7468 6520 6669  ">Here is the fi
+00003a00: 6e61 6c20 636f 6465 2074 6861 7420 6163  nal code that ac
+00003a10: 636f 6d70 6c69 7368 6573 2074 6865 2074  complishes the t
+00003a20: 6173 6b3a 3c2f 623e 3c62 723e 3c70 7265  ask:</b><br><pre
+00003a30: 2073 7479 6c65 3d22 636f 6c6f 723a 2335   style="color:#5
+00003a40: 3535 3535 353b 223e 7b63 6f64 657d 3c2f  55555;">{code}</
+00003a50: 7072 653e 3c2f 703e 3c62 723e 2729 290d  pre></p><br>')).
+00003a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003a70: 2069 6620 7365 6c66 2e76 6563 746f 725f   if self.vector_
+00003a80: 6462 2061 6e64 2072 616e 6b20 6973 206e  db and rank is n
+00003a90: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+00003aa0: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00003ab0: 7370 6c61 7928 4854 4d4c 2866 273c 703e  splay(HTML(f'<p>
+00003ac0: 3c62 2073 7479 6c65 3d22 636f 6c6f 723a  <b style="color:
+00003ad0: 626c 7565 3b22 3e52 616e 6b3a 3c2f 623e  blue;">Rank:</b>
+00003ae0: 3c62 723e 3c73 7061 6e20 7374 796c 653d  <br><span style=
+00003af0: 2263 6f6c 6f72 3a62 6c61 636b 3b22 3e7b  "color:black;">{
+00003b00: 7261 6e6b 7d3c 2f73 7061 6e3e 3c2f 703e  rank}</span></p>
+00003b10: 3c62 723e 2729 290d 0a20 2020 2020 2020  <br>'))..       
+00003b20: 2020 2020 2020 2020 2064 6973 706c 6179           display
+00003b30: 2848 544d 4c28 6627 3c70 3e3c 6220 7374  (HTML(f'<p><b st
+00003b40: 796c 653d 2263 6f6c 6f72 3a62 6c75 653b  yle="color:blue;
+00003b50: 223e 546f 7461 6c20 546f 6b65 6e73 2055  ">Total Tokens U
+00003b60: 7365 643a 3c2f 623e 3c62 723e 3c73 7061  sed:</b><br><spa
+00003b70: 6e20 7374 796c 653d 2263 6f6c 6f72 3a62  n style="color:b
+00003b80: 6c61 636b 3b22 3e7b 746f 7461 6c5f 746f  lack;">{total_to
+00003b90: 6b65 6e73 5f75 7365 645f 7375 6d7d 3c2f  kens_used_sum}</
+00003ba0: 7370 616e 3e3c 2f70 3e3c 6272 3e27 2929  span></p><br>'))
+00003bb0: 0d0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00003bc0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00003bd0: 2020 2020 2069 6620 616e 7377 6572 2069       if answer i
+00003be0: 7320 6e6f 7420 4e6f 6e65 3a0d 0a20 2020  s not None:..   
+00003bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c00: 2063 7072 696e 7428 6622 5c6e 3e3e 2049   cprint(f"\n>> I
+00003c10: 206e 6f77 2068 6176 6520 7468 6520 6669   now have the fi
+00003c20: 6e61 6c20 616e 7377 6572 3a5c 6e7b 616e  nal answer:\n{an
+00003c30: 7377 6572 7d5c 6e22 2c20 2767 7265 656e  swer}\n", 'green
+00003c40: 272c 2061 7474 7273 3d5b 2762 6f6c 6427  ', attrs=['bold'
+00003c50: 5d29 0d0a 2020 2020 2020 2020 2020 2020  ])..            
+00003c60: 2020 2020 6966 2063 6f64 6520 6973 206e      if code is n
+00003c70: 6f74 204e 6f6e 653a 0d0a 2020 2020 2020  ot None:..      
+00003c80: 2020 2020 2020 2020 2020 2020 2020 6370                cp
+00003c90: 7269 6e74 2866 223e 3e20 4865 7265 2069  rint(f">> Here i
+00003ca0: 7320 7468 6520 6669 6e61 6c20 636f 6465  s the final code
+00003cb0: 2074 6861 7420 6163 636f 6d70 6c69 7368   that accomplish
+00003cc0: 6573 2074 6865 2074 6173 6b3a 5c6e 7b63  es the task:\n{c
+00003cd0: 6f64 657d 5c6e 222c 2027 6772 6565 6e27  ode}\n", 'green'
+00003ce0: 2c20 6174 7472 733d 5b27 626f 6c64 275d  , attrs=['bold']
+00003cf0: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
+00003d00: 2020 2069 6620 7365 6c66 2e76 6563 746f     if self.vecto
+00003d10: 725f 6462 2061 6e64 2072 616e 6b20 6973  r_db and rank is
+00003d20: 206e 6f74 204e 6f6e 653a 0d0a 2020 2020   not None:..    
+00003d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d40: 6370 7269 6e74 2866 223e 3e20 5261 6e6b  cprint(f">> Rank
+00003d50: 3a5c 6e7b 7261 6e6b 7d5c 6e22 2c20 2767  :\n{rank}\n", 'g
+00003d60: 7265 656e 272c 2061 7474 7273 3d5b 2762  reen', attrs=['b
+00003d70: 6f6c 6427 5d29 0d0a 2020 2020 2020 2020  old'])..        
+00003d80: 2020 2020 2020 2020 6370 7269 6e74 2866          cprint(f
+00003d90: 223e 3e20 546f 7461 6c20 746f 6b65 6e73  ">> Total tokens
+00003da0: 2075 7365 643a 5c6e 7b74 6f74 616c 5f74   used:\n{total_t
+00003db0: 6f6b 656e 735f 7573 6564 5f73 756d 7d5c  okens_used_sum}\
+00003dc0: 6e22 2c20 2779 656c 6c6f 7727 2c20 6174  n", 'yellow', at
+00003dd0: 7472 733d 5b27 626f 6c64 275d 290d 0a0d  trs=['bold'])...
+00003de0: 0a20 2020 2020 2020 2064 6566 2064 6973  .        def dis
+00003df0: 706c 6179 5f65 7661 6c28 7461 736b 5f65  play_eval(task_e
+00003e00: 7661 6c2c 2074 6974 6c65 2c20 746f 7461  val, title, tota
+00003e10: 6c5f 746f 6b65 6e73 5f75 7365 645f 7375  l_tokens_used_su
+00003e20: 6d29 3a0d 0a20 2020 2020 2020 2020 2020  m):..           
+00003e30: 2069 6620 2769 7079 6b65 726e 656c 2720   if 'ipykernel' 
+00003e40: 696e 2073 7973 2e6d 6f64 756c 6573 3a0d  in sys.modules:.
+00003e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e60: 2023 204a 7570 7974 6572 206e 6f74 6562   # Jupyter noteb
+00003e70: 6f6f 6b20 6f72 2069 7079 7468 6f6e 0d0a  ook or ipython..
+00003e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003e90: 6469 7370 6c61 7928 4854 4d4c 2866 273c  display(HTML(f'<
+00003ea0: 703e 3c62 2073 7479 6c65 3d22 636f 6c6f  p><b style="colo
+00003eb0: 723a 626c 7565 3b22 3e7b 7469 746c 657d  r:blue;">{title}
+00003ec0: 3c2f 623e 3c62 723e 3c70 7265 2073 7479  </b><br><pre sty
+00003ed0: 6c65 3d22 636f 6c6f 723a 626c 6163 6b3b  le="color:black;
+00003ee0: 2077 6869 7465 2d73 7061 6365 3a20 7072   white-space: pr
+00003ef0: 652d 7772 6170 3b20 666f 6e74 2d77 6569  e-wrap; font-wei
+00003f00: 6768 743a 2062 6f6c 643b 223e 7b74 6173  ght: bold;">{tas
+00003f10: 6b5f 6576 616c 7d3c 2f70 7265 3e3c 2f70  k_eval}</pre></p
+00003f20: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
+00003f30: 2020 2020 2020 2020 2020 6469 7370 6c61            displa
+00003f40: 7928 4854 4d4c 2866 273c 703e 3c62 2073  y(HTML(f'<p><b s
+00003f50: 7479 6c65 3d22 636f 6c6f 723a 626c 7565  tyle="color:blue
+00003f60: 3b22 3e54 6f74 616c 2054 6f6b 656e 7320  ;">Total Tokens 
+00003f70: 5573 6564 3a3c 2f62 3e3c 6272 3e3c 7370  Used:</b><br><sp
+00003f80: 616e 2073 7479 6c65 3d22 636f 6c6f 723a  an style="color:
+00003f90: 626c 6163 6b3b 223e 7b74 6f74 616c 5f74  black;">{total_t
+00003fa0: 6f6b 656e 735f 7573 6564 5f73 756d 7d3c  okens_used_sum}<
+00003fb0: 2f73 7061 6e3e 3c2f 703e 3c62 723e 2729  /span></p><br>')
+00003fc0: 290d 0a20 2020 2020 2020 2020 2020 2065  )..            e
+00003fd0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+00003fe0: 2020 2020 2020 2320 4f74 6865 7220 656e        # Other en
+00003ff0: 7669 726f 6e6d 656e 7420 286c 696b 6520  vironment (like 
+00004000: 7465 726d 696e 616c 290d 0a20 2020 2020  terminal)..     
+00004010: 2020 2020 2020 2020 2020 2063 7072 696e             cprin
+00004020: 7428 6622 5c6e 3e3e 207b 7469 746c 657d  t(f"\n>> {title}
+00004030: 5c6e 7b74 6173 6b5f 6576 616c 7d5c 6e22  \n{task_eval}\n"
+00004040: 2c20 276d 6167 656e 7461 272c 2061 7474  , 'magenta', att
+00004050: 7273 3d5b 2762 6f6c 6427 5d29 0d0a 2020  rs=['bold'])..  
+00004060: 2020 2020 2020 2020 2020 2020 2020 6370                cp
+00004070: 7269 6e74 2866 223e 3e20 546f 7461 6c20  rint(f">> Total 
+00004080: 746f 6b65 6e73 2075 7365 643a 5c6e 7b74  tokens used:\n{t
+00004090: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
+000040a0: 5f73 756d 7d5c 6e22 2c20 2779 656c 6c6f  _sum}\n", 'yello
+000040b0: 7727 2c20 6174 7472 733d 5b27 626f 6c64  w', attrs=['bold
+000040c0: 275d 290d 0a0d 0a20 2020 2020 2020 2023  '])....        #
+000040d0: 2049 6e69 7469 616c 697a 6520 7468 6520   Initialize the 
+000040e0: 6576 616c 5f6d 6573 7361 6765 7320 6c69  eval_messages li
+000040f0: 7374 0d0a 2020 2020 2020 2020 6576 616c  st..        eval
+00004100: 5f6d 6573 7361 6765 7320 3d20 5b5d 0d0a  _messages = []..
+00004110: 2020 2020 2020 2020 0d0a 2020 2020 2020          ..      
+00004120: 2020 2320 4966 2061 2071 7565 7374 696f    # If a questio
+00004130: 6e20 6973 2070 726f 7669 6465 642c 2073  n is provided, s
+00004140: 6b69 7020 7468 6520 696e 7075 7420 7072  kip the input pr
+00004150: 6f6d 7074 0d0a 2020 2020 2020 2020 6966  ompt..        if
+00004160: 2071 7565 7374 696f 6e20 6973 206e 6f74   question is not
+00004170: 204e 6f6e 653a 0d0a 2020 2020 2020 2020   None:..        
+00004180: 2020 2020 2320 496e 6974 6961 6c69 7a65      # Initialize
+00004190: 2074 6865 206d 6573 7361 6765 7320 6c69   the messages li
+000041a0: 7374 2077 6974 6820 6120 7379 7374 656d  st with a system
+000041b0: 206d 6573 7361 6765 2063 6f6e 7461 696e   message contain
+000041c0: 696e 6720 7468 6520 7461 736b 2070 726f  ing the task pro
+000041d0: 6d70 740d 0a20 2020 2020 2020 2020 2020  mpt..           
+000041e0: 206d 6573 7361 6765 7320 3d20 5b7b 2272   messages = [{"r
+000041f0: 6f6c 6522 3a20 2273 7973 7465 6d22 2c20  ole": "system", 
+00004200: 2263 6f6e 7465 6e74 223a 2073 656c 662e  "content": self.
+00004210: 7379 7374 656d 5f74 6173 6b7d 5d0d 0a20  system_task}].. 
+00004220: 2020 2020 2020 2020 2020 2023 2049 6e69             # Ini
+00004230: 7469 616c 697a 6520 7468 6520 6d65 7373  tialize the mess
+00004240: 6167 6573 206c 6973 7420 7769 7468 2061  ages list with a
+00004250: 2073 7973 7465 6d20 6d65 7373 6167 6520   system message 
+00004260: 636f 6e74 6169 6e69 6e67 2074 6865 2074  containing the t
+00004270: 6173 6b20 7072 6f6d 7074 0d0a 2020 2020  ask prompt..    
+00004280: 2020 2020 2020 2020 6576 616c 5f6d 6573          eval_mes
+00004290: 7361 6765 732e 6170 7065 6e64 287b 2272  sages.append({"r
+000042a0: 6f6c 6522 3a20 2275 7365 7222 2c20 2263  ole": "user", "c
+000042b0: 6f6e 7465 6e74 223a 2073 656c 662e 7461  ontent": self.ta
+000042c0: 736b 5f65 7661 6c75 6174 696f 6e2e 666f  sk_evaluation.fo
+000042d0: 726d 6174 2871 7565 7374 696f 6e2c 2073  rmat(question, s
+000042e0: 656c 662e 6466 5f68 6561 6429 7d29 0d0a  elf.df_head)})..
+000042f0: 0d0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00004300: 4361 6c6c 2074 6865 2074 6173 6b5f 6576  Call the task_ev
+00004310: 616c 206d 6574 686f 6420 7769 7468 2074  al method with t
+00004320: 6865 2075 7365 7227 7320 7175 6573 7469  he user's questi
+00004330: 6f6e 2069 6620 7468 6520 6578 706c 6f72  on if the explor
+00004340: 6174 6f72 7920 6d6f 6465 2069 7320 5472  atory mode is Tr
+00004350: 7565 0d0a 2020 2020 2020 2020 2020 2020  ue..            
+00004360: 6966 2073 656c 662e 6578 706c 6f72 6174  if self.explorat
+00004370: 6f72 7920 6973 2054 7275 653a 0d0a 2020  ory is True:..  
+00004380: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+00004390: 6775 6d65 6e74 732c 2066 6e5f 6e61 6d65  guments, fn_name
+000043a0: 2c20 7461 736b 5f65 7661 6c2c 2074 6173  , task_eval, tas
+000043b0: 6b5f 7479 7065 203d 2073 656c 662e 7461  k_type = self.ta
+000043c0: 736b 5f65 7661 6c28 6576 616c 5f6d 6573  sk_eval(eval_mes
+000043d0: 7361 6765 7329 0d0a 2020 2020 2020 2020  sages)..        
+000043e0: 2020 2020 2020 2020 746f 7461 6c5f 746f          total_to
+000043f0: 6b65 6e73 5f75 7365 645f 7375 6d20 3d20  kens_used_sum = 
+00004400: 7375 6d28 7365 6c66 2e74 6f74 616c 5f74  sum(self.total_t
+00004410: 6f6b 656e 735f 7573 6564 290d 0a20 2020  okens_used)..   
+00004420: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00004430: 7461 736b 5f74 7970 6520 3d3d 2027 6e61  task_type == 'na
+00004440: 7272 6174 6976 6527 3a0d 0a20 2020 2020  rrative':..     
+00004450: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00004460: 6974 6c65 203d 2027 4865 7265 2069 7320  itle = 'Here is 
+00004470: 7468 6520 616e 7377 6572 2074 6f20 796f  the answer to yo
+00004480: 7572 2071 7565 7374 696f 6e3a 2720 2020  ur question:'   
+00004490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000044a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000044b0: 2020 2020 2020 6469 7370 6c61 795f 6576        display_ev
+000044c0: 616c 2874 6173 6b5f 6576 616c 2c20 7469  al(task_eval, ti
+000044d0: 746c 652c 2074 6f74 616c 5f74 6f6b 656e  tle, total_token
+000044e0: 735f 7573 6564 5f73 756d 290d 0a20 2020  s_used_sum)..   
+000044f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004500: 2072 6574 7572 6e0d 0a20 2020 2020 2020   return..       
+00004510: 2020 2020 2020 2020 2069 6620 7461 736b           if task
+00004520: 5f74 7970 6520 3d3d 2027 666f 6c6c 6f77  _type == 'follow
+00004530: 5f75 7027 3a0d 0a20 2020 2020 2020 2020  _up':..         
+00004540: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+00004550: 203d 2027 546f 2062 6520 6162 6c65 2074   = 'To be able t
+00004560: 6f20 616e 7377 6572 2079 6f75 7220 7175  o answer your qu
+00004570: 6573 7469 6f6e 2c20 4920 616d 2067 6f69  estion, I am goi
+00004580: 6e67 2074 6f20 6e65 6564 2073 6f6d 6520  ng to need some 
+00004590: 6d6f 7265 2069 6e66 6f3a 2720 2020 2020  more info:'     
+000045a0: 2020 2020 2020 2020 2020 2020 2020 0d0a                ..
+000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045c0: 2020 2020 6469 7370 6c61 795f 6576 616c      display_eval
+000045d0: 2874 6173 6b5f 6576 616c 2c20 7469 746c  (task_eval, titl
+000045e0: 652c 2074 6f74 616c 5f74 6f6b 656e 735f  e, total_tokens_
+000045f0: 7573 6564 5f73 756d 290d 0a20 2020 2020  used_sum)..     
+00004600: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00004610: 6574 7572 6e0d 0a20 2020 2020 2020 2020  eturn..         
+00004620: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+00004630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004640: 2020 7469 746c 6520 3d20 2748 6572 6520    title = 'Here 
+00004650: 6973 2074 6865 2073 6571 7565 6e63 6520  is the sequence 
+00004660: 6f66 2073 7465 7073 2072 6571 7569 7265  of steps require
+00004670: 6420 746f 2063 6f6d 706c 6574 6520 7468  d to complete th
+00004680: 6520 7461 736b 3a27 0d0a 2020 2020 2020  e task:'..      
+00004690: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+000046a0: 736b 203d 2074 6173 6b5f 6576 616c 0d0a  sk = task_eval..
+000046b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046c0: 2020 2020 6469 7370 6c61 795f 6576 616c      display_eval
+000046d0: 2874 6173 6b5f 6576 616c 2c20 7469 746c  (task_eval, titl
+000046e0: 652c 2074 6f74 616c 5f74 6f6b 656e 735f  e, total_tokens_
+000046f0: 7573 6564 5f73 756d 290d 0a20 2020 2020  used_sum)..     
+00004700: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+00004710: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00004720: 736b 203d 2071 7565 7374 696f 6e0d 0a0d  sk = question...
+00004730: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00004740: 7365 6c66 2e76 6563 746f 725f 6462 3a0d  self.vector_db:.
+00004750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004760: 2023 2043 616c 6c20 7468 6520 7265 7472   # Call the retr
+00004770: 6965 7665 5f61 6e73 7765 7220 6d65 7468  ieve_answer meth
+00004780: 6f64 2074 6f20 6368 6563 6b20 6966 2074  od to check if t
+00004790: 6865 2071 7565 7374 696f 6e20 6861 7320  he question has 
+000047a0: 616c 7265 6164 7920 6265 656e 2061 736b  already been ask
+000047b0: 6564 2061 6e64 2061 6e73 7765 7265 640d  ed and answered.
+000047c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000047d0: 2065 7861 6d70 6c65 5f6f 7574 7075 7420   example_output 
+000047e0: 3d20 7365 6c66 2e72 6574 7269 6576 655f  = self.retrieve_
+000047f0: 616e 7377 6572 2874 6173 6b2c 2073 656c  answer(task, sel
+00004800: 662e 6466 5f63 6f6c 756d 6e73 2c20 7369  f.df_columns, si
+00004810: 6d69 6c61 7269 7479 5f74 6872 6573 686f  milarity_thresho
+00004820: 6c64 3d73 656c 662e 7369 6d69 6c61 7269  ld=self.similari
+00004830: 7479 5f74 6872 6573 686f 6c64 290d 0a20  ty_threshold).. 
+00004840: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00004850: 6620 6578 616d 706c 655f 6f75 7470 7574  f example_output
+00004860: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+00004870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004880: 2020 2065 7861 6d70 6c65 5f6f 7574 7075     example_outpu
+00004890: 7420 3d20 6578 616d 706c 655f 6f75 7470  t = example_outp
 000048a0: 7574 0d0a 2020 2020 2020 2020 2020 2020  ut..            
-000048b0: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
-000048c0: 2020 2020 2020 2065 7861 6d70 6c65 5f6f         example_o
-000048d0: 7574 7075 7420 3d20 7365 6c66 2e64 6566  utput = self.def
-000048e0: 6175 6c74 5f65 7861 6d70 6c65 5f6f 7574  ault_example_out
-000048f0: 7075 740d 0a0d 0a20 2020 2020 2020 2020  put....         
-00004900: 2020 2023 2043 616c 6c20 7468 6520 7064     # Call the pd
-00004910: 5f61 6765 6e74 206d 6574 686f 6420 7769  _agent method wi
-00004920: 7468 2074 6865 2075 7365 7227 7320 7175  th the user's qu
-00004930: 6573 7469 6f6e 2c20 7468 6520 6d65 7373  estion, the mess
-00004940: 6167 6573 206c 6973 742c 2061 6e64 2074  ages list, and t
-00004950: 6865 2064 6174 6166 7261 6d65 0d0a 2020  he dataframe..  
-00004960: 2020 2020 2020 2020 2020 616e 7377 6572            answer
-00004970: 2c20 636f 6465 2c20 746f 7461 6c5f 746f  , code, total_to
-00004980: 6b65 6e73 5f75 7365 645f 7375 6d20 3d20  kens_used_sum = 
-00004990: 7365 6c66 2e70 645f 6167 656e 7428 7461  self.pd_agent(ta
-000049a0: 736b 2c20 6d65 7373 6167 6573 2c20 6578  sk, messages, ex
-000049b0: 616d 706c 655f 6f75 7470 7574 2c20 7365  ample_output, se
-000049c0: 6c66 2e64 6629 0d0a 0d0a 2020 2020 2020  lf.df)....      
-000049d0: 2020 2020 2020 2320 5261 6e6b 2074 6865        # Rank the
-000049e0: 204c 4c4d 2072 6573 706f 6e73 650d 0a20   LLM response.. 
-000049f0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00004a00: 6c66 2e76 6563 746f 725f 6462 3a0d 0a20  lf.vector_db:.. 
-00004a10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00004a20: 2053 7769 7463 6820 746f 2067 7074 2d34   Switch to gpt-4
-00004a30: 2069 6620 6c6c 6d5f 7377 6974 6368 2070   if llm_switch p
-00004a40: 6172 616d 6574 6572 2069 7320 7365 7420  arameter is set 
-00004a50: 746f 2054 7275 652e 2054 6869 7320 7769  to True. This wi
-00004a60: 6c6c 2069 6e63 7265 6173 6520 7468 6520  ll increase the 
-00004a70: 7072 6f63 6573 7369 6e67 2074 696d 6520  processing time 
-00004a80: 616e 6420 636f 7374 0d0a 2020 2020 2020  and cost..      
-00004a90: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00004aa0: 662e 6c6c 6d5f 7377 6974 6368 3a0d 0a20  f.llm_switch:.. 
-00004ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ac0: 2020 206c 6c6d 5f63 6173 6361 6465 203d     llm_cascade =
-00004ad0: 2054 7275 650d 0a20 2020 2020 2020 2020   True..         
-00004ae0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00004af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b00: 2020 6c6c 6d5f 6361 7363 6164 6520 3d20    llm_cascade = 
-00004b10: 4661 6c73 650d 0a20 2020 2020 2020 2020  False..         
-00004b20: 2020 2020 2020 2072 616e 6b20 3d20 7365         rank = se
-00004b30: 6c66 2e72 616e 6b5f 636f 6465 2863 6f64  lf.rank_code(cod
-00004b40: 652c 7461 736b 2c6c 6c6d 5f63 6173 6361  e,task,llm_casca
-00004b50: 6465 3d6c 6c6d 5f63 6173 6361 6465 290d  de=llm_cascade).
-00004b60: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00004b70: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-00004b80: 2020 2020 7261 6e6b 203d 2022 220d 0a0d      rank = ""...
-00004b90: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-00004ba0: 706c 6179 5f72 6573 756c 7473 2861 6e73  play_results(ans
-00004bb0: 7765 722c 2063 6f64 652c 2072 616e 6b2c  wer, code, rank,
-00004bc0: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
-00004bd0: 6564 5f73 756d 290d 0a0d 0a20 2020 2020  ed_sum)....     
-00004be0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00004bf0: 6563 746f 725f 6462 3a0d 0a20 2020 2020  ector_db:..     
-00004c00: 2020 2020 2020 2020 2020 2023 2050 726f             # Pro
-00004c10: 6d70 7420 7468 6520 7573 6572 2074 6f20  mpt the user to 
-00004c20: 746f 2067 6976 6520 6120 6665 6564 6261  to give a feedba
-00004c30: 636b 206f 6e20 7468 6520 7261 6e6b 696e  ck on the rankin
-00004c40: 670d 0a20 2020 2020 2020 2020 2020 2020  g..             
-00004c50: 2020 2069 6620 2769 7079 6b65 726e 656c     if 'ipykernel
-00004c60: 2720 696e 2073 7973 2e6d 6f64 756c 6573  ' in sys.modules
-00004c70: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00004c80: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
-00004c90: 544d 4c28 273c 6220 7374 796c 653d 2263  TML('<b style="c
-00004ca0: 6f6c 6f72 3a67 7265 656e 3b22 3e41 7265  olor:green;">Are
-00004cb0: 2079 6f75 2068 6170 7079 2077 6974 6820   you happy with 
-00004cc0: 7468 6520 7261 6e6b 696e 6720 3f20 4966  the ranking ? If
-00004cd0: 2059 4553 2074 7970 6520 5c27 7965 735c   YES type \'yes\
-00004ce0: 272e 2049 6620 4e4f 2074 7970 6520 696e  '. If NO type in
-00004cf0: 2074 6865 206e 6577 2072 616e 6b20 6f6e   the new rank on
-00004d00: 2061 2073 6361 6c65 2066 726f 6d20 312d   a scale from 1-
-00004d10: 3130 3a3c 2f62 3e27 2929 0d0a 2020 2020  10:</b>'))..    
-00004d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d30: 7469 6d65 2e73 6c65 6570 2831 290d 0a20  time.sleep(1).. 
-00004d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d50: 2020 2072 616e 6b5f 6665 6564 6261 636b     rank_feedback
-00004d60: 203d 2069 6e70 7574 2829 0d0a 2020 2020   = input()..    
-00004d70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004d80: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00004d90: 2020 2020 2020 2063 7072 696e 7428 225c         cprint("\
-00004da0: 6e41 7265 2079 6f75 2068 6170 7079 2077  nAre you happy w
-00004db0: 6974 6820 7468 6520 7261 6e6b 696e 6720  ith the ranking 
-00004dc0: 3f5c 6e49 6620 5945 5320 7479 7065 2027  ?\nIf YES type '
-00004dd0: 7965 7327 2e20 4966 204e 4f20 7479 7065  yes'. If NO type
-00004de0: 2069 6e20 7468 6520 6e65 7720 7261 6e6b   in the new rank
-00004df0: 206f 6e20 6120 7363 616c 6520 6672 6f6d   on a scale from
-00004e00: 2031 2d31 303a 222c 2027 6772 6565 6e27   1-10:", 'green'
-00004e10: 2c20 6174 7472 733d 5b27 626f 6c64 275d  , attrs=['bold']
-00004e20: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00004e30: 2020 2020 2020 2072 616e 6b5f 6665 6564         rank_feed
-00004e40: 6261 636b 203d 2069 6e70 7574 2829 0d0a  back = input()..
-00004e50: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00004e60: 2020 2320 4966 2074 6865 2075 7365 7220    # If the user 
-00004e70: 7479 7065 7320 2279 6573 222c 2075 7365  types "yes", use
-00004e80: 2074 6865 2072 616e 6b20 6173 2069 732e   the rank as is.
-00004e90: 2049 6620 6e6f 742c 2075 7365 2074 6865   If not, use the
-00004ea0: 2075 7365 7227 7320 7261 6e6b 2e0d 0a20   user's rank... 
-00004eb0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004ec0: 6620 7261 6e6b 5f66 6565 6462 6163 6b2e  f rank_feedback.
-00004ed0: 7374 7269 7028 292e 6c6f 7765 7228 2920  strip().lower() 
-00004ee0: 3d3d 2027 7965 7327 3a0d 0a20 2020 2020  == 'yes':..     
-00004ef0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00004f00: 616e 6b20 3d20 7261 6e6b 0d0a 2020 2020  ank = rank..    
-00004f10: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00004f20: 2072 616e 6b5f 6665 6564 6261 636b 2069   rank_feedback i
-00004f30: 6e20 6d61 7028 7374 722c 2072 616e 6765  n map(str, range
-00004f40: 2830 2c20 3131 2929 3a0d 0a20 2020 2020  (0, 11)):..     
-00004f50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00004f60: 616e 6b20 3d20 7261 6e6b 5f66 6565 6462  ank = rank_feedb
-00004f70: 6163 6b0d 0a20 2020 2020 2020 2020 2020  ack..           
-00004f80: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00004f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fa0: 7261 6e6b 203d 2072 616e 6b0d 0a0d 0a20  rank = rank.... 
-00004fb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00004fc0: 2041 6464 2074 6865 2071 7565 7374 696f   Add the questio
-00004fd0: 6e20 616e 6420 616e 7377 6572 2070 6169  n and answer pai
-00004fe0: 7220 746f 2074 6865 2051 4120 7265 7472  r to the QA retr
-00004ff0: 6965 7661 6c20 696e 6465 780d 0a20 2020  ieval index..   
-00005000: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00005010: 662e 6164 645f 7175 6573 7469 6f6e 5f61  f.add_question_a
-00005020: 6e73 7765 725f 7061 6972 2874 6173 6b2c  nswer_pair(task,
-00005030: 2073 656c 662e 6466 5f63 6f6c 756d 6e73   self.df_columns
-00005040: 2c20 636f 6465 2c20 7261 6e6b 290d 0a0d  , code, rank)...
-00005050: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00005060: 7572 6e0d 0a20 2020 2020 2020 200d 0a20  urn..        .. 
-00005070: 2020 2020 2020 2023 2053 7461 7274 2061         # Start a
-00005080: 6e20 696e 6669 6e69 7465 206c 6f6f 7020  n infinite loop 
-00005090: 746f 206b 6565 7020 6173 6b69 6e67 2074  to keep asking t
-000050a0: 6865 2075 7365 7220 666f 7220 7175 6573  he user for ques
-000050b0: 7469 6f6e 730d 0a20 2020 2020 2020 2066  tions..        f
-000050c0: 6972 7374 5f69 7465 7261 7469 6f6e 203d  irst_iteration =
-000050d0: 2054 7275 6520 2023 2046 6c61 6720 666f   True  # Flag fo
-000050e0: 7220 7468 6520 6669 7273 7420 6974 6572  r the first iter
-000050f0: 6174 696f 6e20 6f66 2074 6865 206c 6f6f  ation of the loo
-00005100: 700d 0a20 2020 2020 2020 2077 6869 6c65  p..        while
-00005110: 2054 7275 653a 0d0a 2020 2020 2020 2020   True:..        
-00005120: 2020 2020 2320 5072 6f6d 7074 2074 6865      # Prompt the
-00005130: 2075 7365 7220 746f 2065 6e74 6572 2061   user to enter a
-00005140: 2071 7565 7374 696f 6e20 6f72 2074 7970   question or typ
-00005150: 6520 2765 7869 7427 2074 6f20 7175 6974  e 'exit' to quit
-00005160: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00005170: 2027 6970 796b 6572 6e65 6c27 2069 6e20   'ipykernel' in 
-00005180: 7379 732e 6d6f 6475 6c65 733a 0d0a 2020  sys.modules:..  
-00005190: 2020 2020 2020 2020 2020 2020 2020 6469                di
-000051a0: 7370 6c61 7928 4854 4d4c 2827 3c62 2073  splay(HTML('<b s
-000051b0: 7479 6c65 3d22 636f 6c6f 723a 626c 7565  tyle="color:blue
-000051c0: 3b22 3e45 6e74 6572 2079 6f75 7220 7175  ;">Enter your qu
-000051d0: 6573 7469 6f6e 206f 7220 7479 7065 205c  estion or type \
-000051e0: 2765 7869 745c 2720 746f 2071 7569 743a  'exit\' to quit:
-000051f0: 3c2f 623e 2729 290d 0a20 2020 2020 2020  </b>'))..       
-00005200: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
-00005210: 6565 7028 3129 0d0a 2020 2020 2020 2020  eep(1)..        
-00005220: 2020 2020 2020 2020 7175 6573 7469 6f6e          question
-00005230: 203d 2069 6e70 7574 2829 0d0a 2020 2020   = input()..    
-00005240: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
-00005250: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00005260: 7072 696e 7428 225c 6e45 6e74 6572 2079  print("\nEnter y
-00005270: 6f75 7220 7175 6573 7469 6f6e 206f 7220  our question or 
-00005280: 7479 7065 2027 6578 6974 2720 746f 2071  type 'exit' to q
-00005290: 7569 743a 222c 2027 626c 7565 272c 2061  uit:", 'blue', a
-000052a0: 7474 7273 3d5b 2762 6f6c 6427 5d29 0d0a  ttrs=['bold'])..
-000052b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000052c0: 7175 6573 7469 6f6e 203d 2069 6e70 7574  question = input
-000052d0: 2829 0d0a 0d0a 2020 2020 2020 2020 2020  ()....          
-000052e0: 2020 2320 4966 2074 6865 2075 7365 7220    # If the user 
-000052f0: 7479 7065 7320 2765 7869 7427 2c20 6272  types 'exit', br
-00005300: 6561 6b20 6f75 7420 6f66 2074 6865 206c  eak out of the l
-00005310: 6f6f 700d 0a20 2020 2020 2020 2020 2020  oop..           
-00005320: 2069 6620 7175 6573 7469 6f6e 2e73 7472   if question.str
-00005330: 6970 2829 2e6c 6f77 6572 2829 203d 3d20  ip().lower() == 
-00005340: 2765 7869 7427 3a0d 0a20 2020 2020 2020  'exit':..       
-00005350: 2020 2020 2020 2020 2062 7265 616b 0d0a           break..
-00005360: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00005370: 2066 6972 7374 5f69 7465 7261 7469 6f6e   first_iteration
-00005380: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00005390: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
-000053a0: 7468 6520 6d65 7373 6167 6573 206c 6973  the messages lis
-000053b0: 7420 7769 7468 2061 2073 7973 7465 6d20  t with a system 
-000053c0: 6d65 7373 6167 6520 636f 6e74 6169 6e69  message containi
-000053d0: 6e67 2074 6865 2074 6173 6b20 7072 6f6d  ng the task prom
-000053e0: 7074 0d0a 2020 2020 2020 2020 2020 2020  pt..            
-000053f0: 2020 2020 6d65 7373 6167 6573 203d 205b      messages = [
-00005400: 7b22 726f 6c65 223a 2022 7379 7374 656d  {"role": "system
-00005410: 222c 2022 636f 6e74 656e 7422 3a20 7365  ", "content": se
-00005420: 6c66 2e73 7973 7465 6d5f 7461 736b 7d5d  lf.system_task}]
-00005430: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005440: 2020 6669 7273 745f 6974 6572 6174 696f    first_iteratio
-00005450: 6e20 3d20 4661 6c73 6520 200d 0a20 2020  n = False  ..   
-00005460: 2020 2020 2020 2020 2020 2020 200d 0a20               .. 
-00005470: 2020 2020 2020 2020 2020 2023 2043 616c             # Cal
-00005480: 6c20 7468 6520 7461 736b 5f65 7661 6c20  l the task_eval 
-00005490: 6d65 7468 6f64 2077 6974 6820 7468 6520  method with the 
-000054a0: 7573 6572 2773 2071 7565 7374 696f 6e20  user's question 
-000054b0: 6966 2074 6865 2065 7870 6c6f 7261 746f  if the explorato
-000054c0: 7279 206d 6f64 6520 6973 2054 7275 650d  ry mode is True.
-000054d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000054e0: 7365 6c66 2e65 7870 6c6f 7261 746f 7279  self.exploratory
-000054f0: 2069 7320 5472 7565 3a0d 0a20 2020 2020   is True:..     
-00005500: 2020 2020 2020 2020 2020 2065 7661 6c5f             eval_
-00005510: 6d65 7373 6167 6573 2e61 7070 656e 6428  messages.append(
-00005520: 7b22 726f 6c65 223a 2022 7573 6572 222c  {"role": "user",
-00005530: 2022 636f 6e74 656e 7422 3a20 7365 6c66   "content": self
-00005540: 2e74 6173 6b5f 6576 616c 7561 7469 6f6e  .task_evaluation
-00005550: 2e66 6f72 6d61 7428 7175 6573 7469 6f6e  .format(question
-00005560: 2c20 7365 6c66 2e64 665f 6865 6164 297d  , self.df_head)}
-00005570: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00005580: 2020 2061 7267 756d 656e 7473 2c20 666e     arguments, fn
-00005590: 5f6e 616d 652c 2074 6173 6b5f 6576 616c  _name, task_eval
-000055a0: 2c20 7461 736b 5f74 7970 6520 3d20 7365  , task_type = se
-000055b0: 6c66 2e74 6173 6b5f 6576 616c 2865 7661  lf.task_eval(eva
-000055c0: 6c5f 6d65 7373 6167 6573 290d 0a20 2020  l_messages)..   
-000055d0: 2020 2020 2020 2020 2020 2020 2065 7661               eva
-000055e0: 6c5f 6d65 7373 6167 6573 2e61 7070 656e  l_messages.appen
-000055f0: 6428 0d0a 2020 2020 2020 2020 2020 2020  d(..            
-00005600: 2020 2020 2020 2020 7b0d 0a20 2020 2020          {..     
-00005610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005620: 2020 2022 726f 6c65 223a 2022 6173 7369     "role": "assi
-00005630: 7374 616e 7422 2c0d 0a20 2020 2020 2020  stant",..       
-00005640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005650: 2022 636f 6e74 656e 7422 3a20 4e6f 6e65   "content": None
-00005660: 2c0d 0a20 2020 2020 2020 2020 2020 2020  ,..             
-00005670: 2020 2020 2020 2020 2020 2022 6675 6e63             "func
-00005680: 7469 6f6e 5f63 616c 6c22 3a20 7b0d 0a20  tion_call": {.. 
-00005690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000056a0: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
-000056b0: 223a 2066 6e5f 6e61 6d65 2c0d 0a20 2020  ": fn_name,..   
+000048b0: 2020 2020 656c 7365 3a0d 0a20 2020 2020      else:..     
+000048c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000048d0: 7861 6d70 6c65 5f6f 7574 7075 7420 3d20  xample_output = 
+000048e0: 7365 6c66 2e64 6566 6175 6c74 5f65 7861  self.default_exa
+000048f0: 6d70 6c65 5f6f 7574 7075 740d 0a20 2020  mple_output..   
+00004900: 2020 2020 2020 2020 2065 6c73 653a 0d0a           else:..
+00004910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004920: 6578 616d 706c 655f 6f75 7470 7574 203d  example_output =
+00004930: 2073 656c 662e 6465 6661 756c 745f 6578   self.default_ex
+00004940: 616d 706c 655f 6f75 7470 7574 0d0a 0d0a  ample_output....
+00004950: 2020 2020 2020 2020 2020 2020 2320 4361              # Ca
+00004960: 6c6c 2074 6865 2070 645f 6167 656e 7420  ll the pd_agent 
+00004970: 6d65 7468 6f64 2077 6974 6820 7468 6520  method with the 
+00004980: 7573 6572 2773 2071 7565 7374 696f 6e2c  user's question,
+00004990: 2074 6865 206d 6573 7361 6765 7320 6c69   the messages li
+000049a0: 7374 2c20 616e 6420 7468 6520 6461 7461  st, and the data
+000049b0: 6672 616d 650d 0a20 2020 2020 2020 2020  frame..         
+000049c0: 2020 2061 6e73 7765 722c 2063 6f64 652c     answer, code,
+000049d0: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
+000049e0: 6564 5f73 756d 203d 2073 656c 662e 7064  ed_sum = self.pd
+000049f0: 5f61 6765 6e74 2874 6173 6b2c 206d 6573  _agent(task, mes
+00004a00: 7361 6765 732c 2065 7861 6d70 6c65 5f6f  sages, example_o
+00004a10: 7574 7075 742c 2073 656c 662e 6466 290d  utput, self.df).
+00004a20: 0a0d 0a20 2020 2020 2020 2020 2020 2023  ...            #
+00004a30: 2052 616e 6b20 7468 6520 4c4c 4d20 7265   Rank the LLM re
+00004a40: 7370 6f6e 7365 0d0a 2020 2020 2020 2020  sponse..        
+00004a50: 2020 2020 6966 2073 656c 662e 7665 6374      if self.vect
+00004a60: 6f72 5f64 623a 0d0a 2020 2020 2020 2020  or_db:..        
+00004a70: 2020 2020 2020 2020 2320 5377 6974 6368          # Switch
+00004a80: 2074 6f20 6770 742d 3420 6966 206c 6c6d   to gpt-4 if llm
+00004a90: 5f73 7769 7463 6820 7061 7261 6d65 7465  _switch paramete
+00004aa0: 7220 6973 2073 6574 2074 6f20 5472 7565  r is set to True
+00004ab0: 2e20 5468 6973 2077 696c 6c20 696e 6372  . This will incr
+00004ac0: 6561 7365 2074 6865 2070 726f 6365 7373  ease the process
+00004ad0: 696e 6720 7469 6d65 2061 6e64 2063 6f73  ing time and cos
+00004ae0: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
+00004af0: 2020 2069 6620 7365 6c66 2e6c 6c6d 5f73     if self.llm_s
+00004b00: 7769 7463 683a 0d0a 2020 2020 2020 2020  witch:..        
+00004b10: 2020 2020 2020 2020 2020 2020 6c6c 6d5f              llm_
+00004b20: 6361 7363 6164 6520 3d20 5472 7565 0d0a  cascade = True..
+00004b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b40: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+00004b50: 2020 2020 2020 2020 2020 206c 6c6d 5f63             llm_c
+00004b60: 6173 6361 6465 203d 2046 616c 7365 0d0a  ascade = False..
+00004b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b80: 7261 6e6b 203d 2073 656c 662e 7261 6e6b  rank = self.rank
+00004b90: 5f63 6f64 6528 636f 6465 2c74 6173 6b2c  _code(code,task,
+00004ba0: 6c6c 6d5f 6361 7363 6164 653d 6c6c 6d5f  llm_cascade=llm_
+00004bb0: 6361 7363 6164 6529 0d0a 2020 2020 2020  cascade)..      
+00004bc0: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+00004bd0: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00004be0: 6b20 3d20 2222 0d0a 0d0a 2020 2020 2020  k = ""....      
+00004bf0: 2020 2020 2020 6469 7370 6c61 795f 7265        display_re
+00004c00: 7375 6c74 7328 616e 7377 6572 2c20 636f  sults(answer, co
+00004c10: 6465 2c20 7261 6e6b 2c20 746f 7461 6c5f  de, rank, total_
+00004c20: 746f 6b65 6e73 5f75 7365 645f 7375 6d29  tokens_used_sum)
+00004c30: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00004c40: 6966 2073 656c 662e 7665 6374 6f72 5f64  if self.vector_d
+00004c50: 623a 0d0a 2020 2020 2020 2020 2020 2020  b:..            
+00004c60: 2020 2020 2320 5072 6f6d 7074 2074 6865      # Prompt the
+00004c70: 2075 7365 7220 746f 2074 6f20 6769 7665   user to to give
+00004c80: 2061 2066 6565 6462 6163 6b20 6f6e 2074   a feedback on t
+00004c90: 6865 2072 616e 6b69 6e67 0d0a 2020 2020  he ranking..    
+00004ca0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+00004cb0: 6970 796b 6572 6e65 6c27 2069 6e20 7379  ipykernel' in sy
+00004cc0: 732e 6d6f 6475 6c65 733a 0d0a 2020 2020  s.modules:..    
+00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ce0: 6469 7370 6c61 7928 4854 4d4c 2827 3c62  display(HTML('<b
+00004cf0: 2073 7479 6c65 3d22 636f 6c6f 723a 6772   style="color:gr
+00004d00: 6565 6e3b 223e 4172 6520 796f 7520 6861  een;">Are you ha
+00004d10: 7070 7920 7769 7468 2074 6865 2072 616e  ppy with the ran
+00004d20: 6b69 6e67 203f 2049 6620 5945 5320 7479  king ? If YES ty
+00004d30: 7065 205c 2779 6573 5c27 2e20 4966 204e  pe \'yes\'. If N
+00004d40: 4f20 7479 7065 2069 6e20 7468 6520 6e65  O type in the ne
+00004d50: 7720 7261 6e6b 206f 6e20 6120 7363 616c  w rank on a scal
+00004d60: 6520 6672 6f6d 2031 2d31 303a 3c2f 623e  e from 1-10:</b>
+00004d70: 2729 290d 0a20 2020 2020 2020 2020 2020  '))..           
+00004d80: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+00004d90: 6565 7028 3129 0d0a 2020 2020 2020 2020  eep(1)..        
+00004da0: 2020 2020 2020 2020 2020 2020 7261 6e6b              rank
+00004db0: 5f66 6565 6462 6163 6b20 3d20 696e 7075  _feedback = inpu
+00004dc0: 7428 290d 0a20 2020 2020 2020 2020 2020  t()..           
+00004dd0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00004de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004df0: 6370 7269 6e74 2822 5c6e 4172 6520 796f  cprint("\nAre yo
+00004e00: 7520 6861 7070 7920 7769 7468 2074 6865  u happy with the
+00004e10: 2072 616e 6b69 6e67 203f 5c6e 4966 2059   ranking ?\nIf Y
+00004e20: 4553 2074 7970 6520 2779 6573 272e 2049  ES type 'yes'. I
+00004e30: 6620 4e4f 2074 7970 6520 696e 2074 6865  f NO type in the
+00004e40: 206e 6577 2072 616e 6b20 6f6e 2061 2073   new rank on a s
+00004e50: 6361 6c65 2066 726f 6d20 312d 3130 3a22  cale from 1-10:"
+00004e60: 2c20 2767 7265 656e 272c 2061 7474 7273  , 'green', attrs
+00004e70: 3d5b 2762 6f6c 6427 5d29 0d0a 2020 2020  =['bold'])..    
+00004e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e90: 7261 6e6b 5f66 6565 6462 6163 6b20 3d20  rank_feedback = 
+00004ea0: 696e 7075 7428 290d 0a0d 0a20 2020 2020  input()....     
+00004eb0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00004ec0: 7468 6520 7573 6572 2074 7970 6573 2022  the user types "
+00004ed0: 7965 7322 2c20 7573 6520 7468 6520 7261  yes", use the ra
+00004ee0: 6e6b 2061 7320 6973 2e20 4966 206e 6f74  nk as is. If not
+00004ef0: 2c20 7573 6520 7468 6520 7573 6572 2773  , use the user's
+00004f00: 2072 616e 6b2e 0d0a 2020 2020 2020 2020   rank...        
+00004f10: 2020 2020 2020 2020 6966 2072 616e 6b5f          if rank_
+00004f20: 6665 6564 6261 636b 2e73 7472 6970 2829  feedback.strip()
+00004f30: 2e6c 6f77 6572 2829 203d 3d20 2779 6573  .lower() == 'yes
+00004f40: 273a 0d0a 2020 2020 2020 2020 2020 2020  ':..            
+00004f50: 2020 2020 2020 2020 7261 6e6b 203d 2072          rank = r
+00004f60: 616e 6b0d 0a20 2020 2020 2020 2020 2020  ank..           
+00004f70: 2020 2020 2065 6c69 6620 7261 6e6b 5f66       elif rank_f
+00004f80: 6565 6462 6163 6b20 696e 206d 6170 2873  eedback in map(s
+00004f90: 7472 2c20 7261 6e67 6528 302c 2031 3129  tr, range(0, 11)
+00004fa0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00004fb0: 2020 2020 2020 2020 7261 6e6b 203d 2072          rank = r
+00004fc0: 616e 6b5f 6665 6564 6261 636b 0d0a 2020  ank_feedback..  
+00004fd0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00004fe0: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00004ff0: 2020 2020 2020 2020 2072 616e 6b20 3d20           rank = 
+00005000: 7261 6e6b 0d0a 0d0a 2020 2020 2020 2020  rank....        
+00005010: 2020 2020 2020 2020 2320 4164 6420 7468          # Add th
+00005020: 6520 7175 6573 7469 6f6e 2061 6e64 2061  e question and a
+00005030: 6e73 7765 7220 7061 6972 2074 6f20 7468  nswer pair to th
+00005040: 6520 5141 2072 6574 7269 6576 616c 2069  e QA retrieval i
+00005050: 6e64 6578 0d0a 2020 2020 2020 2020 2020  ndex..          
+00005060: 2020 2020 2020 7365 6c66 2e61 6464 5f71        self.add_q
+00005070: 7565 7374 696f 6e5f 616e 7377 6572 5f70  uestion_answer_p
+00005080: 6169 7228 7461 736b 2c20 7365 6c66 2e64  air(task, self.d
+00005090: 665f 636f 6c75 6d6e 732c 2063 6f64 652c  f_columns, code,
+000050a0: 2072 616e 6b29 0d0a 0d0a 2020 2020 2020   rank)....      
+000050b0: 2020 2020 2020 7265 7475 726e 0d0a 2020        return..  
+000050c0: 2020 2020 2020 0d0a 2020 2020 2020 2020        ..        
+000050d0: 2320 5374 6172 7420 616e 2069 6e66 696e  # Start an infin
+000050e0: 6974 6520 6c6f 6f70 2074 6f20 6b65 6570  ite loop to keep
+000050f0: 2061 736b 696e 6720 7468 6520 7573 6572   asking the user
+00005100: 2066 6f72 2071 7565 7374 696f 6e73 0d0a   for questions..
+00005110: 2020 2020 2020 2020 6669 7273 745f 6974          first_it
+00005120: 6572 6174 696f 6e20 3d20 5472 7565 2020  eration = True  
+00005130: 2320 466c 6167 2066 6f72 2074 6865 2066  # Flag for the f
+00005140: 6972 7374 2069 7465 7261 7469 6f6e 206f  irst iteration o
+00005150: 6620 7468 6520 6c6f 6f70 0d0a 2020 2020  f the loop..    
+00005160: 2020 2020 7768 696c 6520 5472 7565 3a0d      while True:.
+00005170: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+00005180: 726f 6d70 7420 7468 6520 7573 6572 2074  rompt the user t
+00005190: 6f20 656e 7465 7220 6120 7175 6573 7469  o enter a questi
+000051a0: 6f6e 206f 7220 7479 7065 2027 6578 6974  on or type 'exit
+000051b0: 2720 746f 2071 7569 740d 0a20 2020 2020  ' to quit..     
+000051c0: 2020 2020 2020 2069 6620 2769 7079 6b65         if 'ipyke
+000051d0: 726e 656c 2720 696e 2073 7973 2e6d 6f64  rnel' in sys.mod
+000051e0: 756c 6573 3a0d 0a20 2020 2020 2020 2020  ules:..         
+000051f0: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
+00005200: 544d 4c28 273c 6220 7374 796c 653d 2263  TML('<b style="c
+00005210: 6f6c 6f72 3a62 6c75 653b 223e 456e 7465  olor:blue;">Ente
+00005220: 7220 796f 7572 2071 7565 7374 696f 6e20  r your question 
+00005230: 6f72 2074 7970 6520 5c27 6578 6974 5c27  or type \'exit\'
+00005240: 2074 6f20 7175 6974 3a3c 2f62 3e27 2929   to quit:</b>'))
+00005250: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005260: 2020 7469 6d65 2e73 6c65 6570 2831 290d    time.sleep(1).
+00005270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005280: 2071 7565 7374 696f 6e20 3d20 696e 7075   question = inpu
+00005290: 7428 290d 0a20 2020 2020 2020 2020 2020  t()..           
+000052a0: 2065 6c73 653a 0d0a 2020 2020 2020 2020   else:..        
+000052b0: 2020 2020 2020 2020 6370 7269 6e74 2822          cprint("
+000052c0: 5c6e 456e 7465 7220 796f 7572 2071 7565  \nEnter your que
+000052d0: 7374 696f 6e20 6f72 2074 7970 6520 2765  stion or type 'e
+000052e0: 7869 7427 2074 6f20 7175 6974 3a22 2c20  xit' to quit:", 
+000052f0: 2762 6c75 6527 2c20 6174 7472 733d 5b27  'blue', attrs=['
+00005300: 626f 6c64 275d 290d 0a20 2020 2020 2020  bold'])..       
+00005310: 2020 2020 2020 2020 2071 7565 7374 696f           questio
+00005320: 6e20 3d20 696e 7075 7428 290d 0a0d 0a20  n = input().... 
+00005330: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00005340: 7468 6520 7573 6572 2074 7970 6573 2027  the user types '
+00005350: 6578 6974 272c 2062 7265 616b 206f 7574  exit', break out
+00005360: 206f 6620 7468 6520 6c6f 6f70 0d0a 2020   of the loop..  
+00005370: 2020 2020 2020 2020 2020 6966 2071 7565            if que
+00005380: 7374 696f 6e2e 7374 7269 7028 292e 6c6f  stion.strip().lo
+00005390: 7765 7228 2920 3d3d 2027 6578 6974 273a  wer() == 'exit':
+000053a0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000053b0: 2020 6272 6561 6b0d 0a0d 0a20 2020 2020    break....     
+000053c0: 2020 2020 2020 2069 6620 6669 7273 745f         if first_
+000053d0: 6974 6572 6174 696f 6e3a 0d0a 2020 2020  iteration:..    
+000053e0: 2020 2020 2020 2020 2020 2020 2320 496e              # In
+000053f0: 6974 6961 6c69 7a65 2074 6865 206d 6573  itialize the mes
+00005400: 7361 6765 7320 6c69 7374 2077 6974 6820  sages list with 
+00005410: 6120 7379 7374 656d 206d 6573 7361 6765  a system message
+00005420: 2063 6f6e 7461 696e 696e 6720 7468 6520   containing the 
+00005430: 7461 736b 2070 726f 6d70 740d 0a20 2020  task prompt..   
+00005440: 2020 2020 2020 2020 2020 2020 206d 6573               mes
+00005450: 7361 6765 7320 3d20 5b7b 2272 6f6c 6522  sages = [{"role"
+00005460: 3a20 2273 7973 7465 6d22 2c20 2263 6f6e  : "system", "con
+00005470: 7465 6e74 223a 2073 656c 662e 7379 7374  tent": self.syst
+00005480: 656d 5f74 6173 6b7d 5d0d 0a20 2020 2020  em_task}]..     
+00005490: 2020 2020 2020 2020 2020 2066 6972 7374             first
+000054a0: 5f69 7465 7261 7469 6f6e 203d 2046 616c  _iteration = Fal
+000054b0: 7365 2020 0d0a 2020 2020 2020 2020 2020  se  ..          
+000054c0: 2020 2020 2020 0d0a 2020 2020 2020 2020        ..        
+000054d0: 2020 2020 2320 4361 6c6c 2074 6865 2074      # Call the t
+000054e0: 6173 6b5f 6576 616c 206d 6574 686f 6420  ask_eval method 
+000054f0: 7769 7468 2074 6865 2075 7365 7227 7320  with the user's 
+00005500: 7175 6573 7469 6f6e 2069 6620 7468 6520  question if the 
+00005510: 6578 706c 6f72 6174 6f72 7920 6d6f 6465  exploratory mode
+00005520: 2069 7320 5472 7565 0d0a 2020 2020 2020   is True..      
+00005530: 2020 2020 2020 6966 2073 656c 662e 6578        if self.ex
+00005540: 706c 6f72 6174 6f72 7920 6973 2054 7275  ploratory is Tru
+00005550: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
+00005560: 2020 2020 6576 616c 5f6d 6573 7361 6765      eval_message
+00005570: 732e 6170 7065 6e64 287b 2272 6f6c 6522  s.append({"role"
+00005580: 3a20 2275 7365 7222 2c20 2263 6f6e 7465  : "user", "conte
+00005590: 6e74 223a 2073 656c 662e 7461 736b 5f65  nt": self.task_e
+000055a0: 7661 6c75 6174 696f 6e2e 666f 726d 6174  valuation.format
+000055b0: 2871 7565 7374 696f 6e2c 2073 656c 662e  (question, self.
+000055c0: 6466 5f68 6561 6429 7d29 0d0a 2020 2020  df_head)})..    
+000055d0: 2020 2020 2020 2020 2020 2020 6172 6775              argu
+000055e0: 6d65 6e74 732c 2066 6e5f 6e61 6d65 2c20  ments, fn_name, 
+000055f0: 7461 736b 5f65 7661 6c2c 2074 6173 6b5f  task_eval, task_
+00005600: 7479 7065 203d 2073 656c 662e 7461 736b  type = self.task
+00005610: 5f65 7661 6c28 6576 616c 5f6d 6573 7361  _eval(eval_messa
+00005620: 6765 7329 0d0a 2020 2020 2020 2020 2020  ges)..          
+00005630: 2020 2020 2020 6576 616c 5f6d 6573 7361        eval_messa
+00005640: 6765 732e 6170 7065 6e64 280d 0a20 2020  ges.append(..   
+00005650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005660: 207b 0d0a 2020 2020 2020 2020 2020 2020   {..            
+00005670: 2020 2020 2020 2020 2020 2020 2272 6f6c              "rol
+00005680: 6522 3a20 2261 7373 6973 7461 6e74 222c  e": "assistant",
+00005690: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000056a0: 2020 2020 2020 2020 2020 2263 6f6e 7465            "conte
+000056b0: 6e74 223a 204e 6f6e 652c 0d0a 2020 2020  nt": None,..    
 000056c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000056d0: 2020 2020 2020 2020 2022 6172 6775 6d65           "argume
-000056e0: 6e74 7322 3a20 6172 6775 6d65 6e74 732c  nts": arguments,
-000056f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005700: 2020 2020 2020 2020 2020 7d2c 0d0a 2020            },..  
-00005710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005720: 2020 7d0d 0a20 2020 2020 2020 2020 2020    }..           
-00005730: 2020 2020 2029 0d0a 0d0a 2020 2020 2020       )....      
-00005740: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
-00005750: 7665 2074 6865 206f 6c64 6573 7420 636f  ve the oldest co
-00005760: 6e76 6572 7361 7469 6f6e 2066 726f 6d20  nversation from 
-00005770: 7468 6520 6d65 7373 6167 6573 206c 6973  the messages lis
-00005780: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
-00005790: 2020 2069 6620 6c65 6e28 6576 616c 5f6d     if len(eval_m
-000057a0: 6573 7361 6765 7329 203e 2073 656c 662e  essages) > self.
-000057b0: 4d41 585f 434f 4e56 4552 5341 5449 4f4e  MAX_CONVERSATION
-000057c0: 533a 0d0a 2020 2020 2020 2020 2020 2020  S:..            
-000057d0: 2020 2020 2020 2020 6576 616c 5f6d 6573          eval_mes
-000057e0: 7361 6765 732e 706f 7028 3129 0d0a 2020  sages.pop(1)..  
-000057f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005800: 2020 6576 616c 5f6d 6573 7361 6765 732e    eval_messages.
-00005810: 706f 7028 3129 0d0a 0d0a 2020 2020 2020  pop(1)....      
-00005820: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
-00005830: 746f 6b65 6e73 5f75 7365 645f 7375 6d20  tokens_used_sum 
-00005840: 3d20 7375 6d28 7365 6c66 2e74 6f74 616c  = sum(self.total
-00005850: 5f74 6f6b 656e 735f 7573 6564 290d 0a0d  _tokens_used)...
-00005860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005870: 2069 6620 7461 736b 5f74 7970 6520 3d3d   if task_type ==
-00005880: 2027 6e61 7272 6174 6976 6527 3a0d 0a20   'narrative':.. 
-00005890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058a0: 2020 2074 6974 6c65 203d 2027 4865 7265     title = 'Here
-000058b0: 2069 7320 616e 2061 6e73 7765 7220 746f   is an answer to
-000058c0: 2079 6f75 7220 7175 6573 7469 6f6e 3a27   your question:'
-000058d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058e0: 2020 200d 0a20 2020 2020 2020 2020 2020     ..           
-000058f0: 2020 2020 2020 2020 2064 6973 706c 6179           display
-00005900: 5f65 7661 6c28 7461 736b 5f65 7661 6c2c  _eval(task_eval,
-00005910: 2074 6974 6c65 2c20 746f 7461 6c5f 746f   title, total_to
-00005920: 6b65 6e73 5f75 7365 645f 7375 6d29 0d0a  kens_used_sum)..
-00005930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005940: 2020 2020 636f 6e74 696e 7565 0d0a 2020      continue..  
-00005950: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00005960: 2074 6173 6b5f 7479 7065 203d 3d20 2766   task_type == 'f
-00005970: 6f6c 6c6f 775f 7570 273a 0d0a 2020 2020  ollow_up':..    
-00005980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005990: 7469 746c 6520 3d20 2754 6f20 6265 2061  title = 'To be a
-000059a0: 626c 6520 746f 2061 6e73 7765 7220 796f  ble to answer yo
-000059b0: 7572 2071 7565 7374 696f 6e2c 2049 2061  ur question, I a
-000059c0: 6d20 676f 696e 6720 746f 206e 6565 6420  m going to need 
-000059d0: 736f 6d65 206d 6f72 6520 696e 666f 3a27  some more info:'
-000059e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000059f0: 2020 200d 0a20 2020 2020 2020 2020 2020     ..           
-00005a00: 2020 2020 2020 2020 2064 6973 706c 6179           display
-00005a10: 5f65 7661 6c28 7461 736b 5f65 7661 6c2c  _eval(task_eval,
-00005a20: 2074 6974 6c65 2c20 746f 7461 6c5f 746f   title, total_to
-00005a30: 6b65 6e73 5f75 7365 645f 7375 6d29 0d0a  kens_used_sum)..
-00005a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a50: 2020 2020 636f 6e74 696e 7565 0d0a 2020      continue..  
-00005a60: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00005a70: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
-00005a80: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
-00005a90: 2027 4865 7265 2069 7320 6120 7365 7175   'Here is a sequ
-00005aa0: 656e 6365 206f 6620 7374 6570 7320 7265  ence of steps re
-00005ab0: 7175 6972 6564 2074 6f20 636f 6d70 6c65  quired to comple
-00005ac0: 7465 2074 6865 2074 6173 6b3a 270d 0a20  te the task:'.. 
+000056d0: 2020 2020 2266 756e 6374 696f 6e5f 6361      "function_ca
+000056e0: 6c6c 223a 207b 0d0a 2020 2020 2020 2020  ll": {..        
+000056f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005700: 2020 2020 226e 616d 6522 3a20 666e 5f6e      "name": fn_n
+00005710: 616d 652c 0d0a 2020 2020 2020 2020 2020  ame,..          
+00005720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005730: 2020 2261 7267 756d 656e 7473 223a 2061    "arguments": a
+00005740: 7267 756d 656e 7473 2c0d 0a20 2020 2020  rguments,..     
+00005750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005760: 2020 207d 2c0d 0a20 2020 2020 2020 2020     },..         
+00005770: 2020 2020 2020 2020 2020 207d 0d0a 2020             }..  
+00005780: 2020 2020 2020 2020 2020 2020 2020 290d                ).
+00005790: 0a0d 0a20 2020 2020 2020 2020 2020 2020  ...             
+000057a0: 2020 2023 2052 656d 6f76 6520 7468 6520     # Remove the 
+000057b0: 6f6c 6465 7374 2063 6f6e 7665 7273 6174  oldest conversat
+000057c0: 696f 6e20 6672 6f6d 2074 6865 206d 6573  ion from the mes
+000057d0: 7361 6765 7320 6c69 7374 0d0a 2020 2020  sages list..    
+000057e0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+000057f0: 656e 2865 7661 6c5f 6d65 7373 6167 6573  en(eval_messages
+00005800: 2920 3e20 7365 6c66 2e4d 4158 5f43 4f4e  ) > self.MAX_CON
+00005810: 5645 5253 4154 494f 4e53 3a0d 0a20 2020  VERSATIONS:..   
+00005820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005830: 2065 7661 6c5f 6d65 7373 6167 6573 2e70   eval_messages.p
+00005840: 6f70 2830 290d 0a20 2020 2020 2020 2020  op(0)..         
+00005850: 2020 2020 2020 2020 2020 2065 7661 6c5f             eval_
+00005860: 6d65 7373 6167 6573 2e70 6f70 2830 290d  messages.pop(0).
+00005870: 0a0d 0a20 2020 2020 2020 2020 2020 2020  ...             
+00005880: 2020 2074 6f74 616c 5f74 6f6b 656e 735f     total_tokens_
+00005890: 7573 6564 5f73 756d 203d 2073 756d 2873  used_sum = sum(s
+000058a0: 656c 662e 746f 7461 6c5f 746f 6b65 6e73  elf.total_tokens
+000058b0: 5f75 7365 6429 0d0a 0d0a 2020 2020 2020  _used)....      
+000058c0: 2020 2020 2020 2020 2020 6966 2074 6173            if tas
+000058d0: 6b5f 7479 7065 203d 3d20 276e 6172 7261  k_type == 'narra
+000058e0: 7469 7665 273a 0d0a 2020 2020 2020 2020  tive':..        
+000058f0: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+00005900: 6520 3d20 2748 6572 6520 6973 2061 6e20  e = 'Here is an 
+00005910: 616e 7377 6572 2074 6f20 796f 7572 2071  answer to your q
+00005920: 7565 7374 696f 6e3a 2720 2020 2020 2020  uestion:'       
+00005930: 2020 2020 2020 2020 2020 2020 0d0a 2020              ..  
+00005940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005950: 2020 6469 7370 6c61 795f 6576 616c 2874    display_eval(t
+00005960: 6173 6b5f 6576 616c 2c20 7469 746c 652c  ask_eval, title,
+00005970: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
+00005980: 6564 5f73 756d 290d 0a20 2020 2020 2020  ed_sum)..       
+00005990: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000059a0: 7469 6e75 650d 0a20 2020 2020 2020 2020  tinue..         
+000059b0: 2020 2020 2020 2069 6620 7461 736b 5f74         if task_t
+000059c0: 7970 6520 3d3d 2027 666f 6c6c 6f77 5f75  ype == 'follow_u
+000059d0: 7027 3a0d 0a20 2020 2020 2020 2020 2020  p':..           
+000059e0: 2020 2020 2020 2020 2074 6974 6c65 203d           title =
+000059f0: 2027 546f 2062 6520 6162 6c65 2074 6f20   'To be able to 
+00005a00: 616e 7377 6572 2079 6f75 7220 7175 6573  answer your ques
+00005a10: 7469 6f6e 2c20 4920 616d 2067 6f69 6e67  tion, I am going
+00005a20: 2074 6f20 6e65 6564 2073 6f6d 6520 6d6f   to need some mo
+00005a30: 7265 2069 6e66 6f3a 2720 2020 2020 2020  re info:'       
+00005a40: 2020 2020 2020 2020 2020 2020 0d0a 2020              ..  
+00005a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a60: 2020 6469 7370 6c61 795f 6576 616c 2874    display_eval(t
+00005a70: 6173 6b5f 6576 616c 2c20 7469 746c 652c  ask_eval, title,
+00005a80: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
+00005a90: 6564 5f73 756d 290d 0a20 2020 2020 2020  ed_sum)..       
+00005aa0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00005ab0: 7469 6e75 650d 0a20 2020 2020 2020 2020  tinue..         
+00005ac0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
 00005ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ae0: 2020 2074 6173 6b20 3d20 7461 736b 5f65     task = task_e
-00005af0: 7661 6c0d 0a20 2020 2020 2020 2020 2020  val..           
-00005b00: 2020 2020 2020 2020 2064 6973 706c 6179           display
-00005b10: 5f65 7661 6c28 7461 736b 5f65 7661 6c2c  _eval(task_eval,
-00005b20: 2074 6974 6c65 2c20 746f 7461 6c5f 746f   title, total_to
-00005b30: 6b65 6e73 5f75 7365 645f 7375 6d29 0d0a  kens_used_sum)..
-00005b40: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00005b50: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00005b60: 2020 2074 6173 6b20 3d20 7175 6573 7469     task = questi
-00005b70: 6f6e 0d0a 2020 2020 2020 2020 2020 2020  on..            
-00005b80: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00005b90: 2073 656c 662e 7665 6374 6f72 5f64 623a   self.vector_db:
-00005ba0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005bb0: 2020 2320 4361 6c6c 2074 6865 2072 6574    # Call the ret
-00005bc0: 7269 6576 655f 616e 7377 6572 206d 6574  rieve_answer met
-00005bd0: 686f 6420 746f 2063 6865 636b 2069 6620  hod to check if 
-00005be0: 7468 6520 7175 6573 7469 6f6e 2068 6173  the question has
-00005bf0: 2061 6c72 6561 6479 2062 6565 6e20 6173   already been as
-00005c00: 6b65 6420 616e 6420 616e 7377 6572 6564  ked and answered
-00005c10: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00005c20: 2020 6578 616d 706c 655f 6f75 7470 7574    example_output
-00005c30: 203d 2073 656c 662e 7265 7472 6965 7665   = self.retrieve
-00005c40: 5f61 6e73 7765 7228 7461 736b 2c20 7365  _answer(task, se
-00005c50: 6c66 2e64 665f 636f 6c75 6d6e 7329 0d0a  lf.df_columns)..
-00005c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c70: 6966 2065 7861 6d70 6c65 5f6f 7574 7075  if example_outpu
-00005c80: 7420 6973 206e 6f74 204e 6f6e 653a 0d0a  t is not None:..
-00005c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ca0: 2020 2020 6578 616d 706c 655f 6f75 7470      example_outp
-00005cb0: 7574 203d 2065 7861 6d70 6c65 5f6f 7574  ut = example_out
-00005cc0: 7075 740d 0a20 2020 2020 2020 2020 2020  put..           
-00005cd0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-00005ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cf0: 6578 616d 706c 655f 6f75 7470 7574 203d  example_output =
-00005d00: 2073 656c 662e 6465 6661 756c 745f 6578   self.default_ex
-00005d10: 616d 706c 655f 6f75 7470 7574 0d0a 2020  ample_output..  
-00005d20: 2020 2020 2020 2020 2020 656c 7365 3a0d            else:.
-00005d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005d40: 2065 7861 6d70 6c65 5f6f 7574 7075 7420   example_output 
-00005d50: 3d20 7365 6c66 2e64 6566 6175 6c74 5f65  = self.default_e
-00005d60: 7861 6d70 6c65 5f6f 7574 7075 740d 0a0d  xample_output...
-00005d70: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-00005d80: 616c 6c20 7468 6520 7064 5f61 6765 6e74  all the pd_agent
-00005d90: 206d 6574 686f 6420 7769 7468 2074 6865   method with the
-00005da0: 2075 7365 7227 7320 7175 6573 7469 6f6e   user's question
-00005db0: 2c20 7468 6520 6d65 7373 6167 6573 206c  , the messages l
-00005dc0: 6973 742c 2061 6e64 2074 6865 2064 6174  ist, and the dat
-00005dd0: 6166 7261 6d65 0d0a 2020 2020 2020 2020  aframe..        
-00005de0: 2020 2020 616e 7377 6572 2c20 636f 6465      answer, code
-00005df0: 2c20 746f 7461 6c5f 746f 6b65 6e73 5f75  , total_tokens_u
-00005e00: 7365 645f 7375 6d20 3d20 7365 6c66 2e70  sed_sum = self.p
-00005e10: 645f 6167 656e 7428 7461 736b 2c20 6d65  d_agent(task, me
-00005e20: 7373 6167 6573 2c20 6578 616d 706c 655f  ssages, example_
-00005e30: 6f75 7470 7574 2c20 7365 6c66 2e64 6629  output, self.df)
-00005e40: 0d0a 2020 2020 2020 2020 2020 2020 0d0a  ..            ..
-00005e50: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-00005e60: 6d6f 7665 2074 6865 2065 7861 6d70 6c65  move the example
-00005e70: 7320 6672 6f6d 2074 6865 206d 6573 7361  s from the messa
-00005e80: 6765 7320 6c69 7374 2074 6f20 6d69 6e69  ges list to mini
-00005e90: 6d69 7a65 2074 6865 206e 756d 6265 7220  mize the number 
-00005ea0: 6f66 2074 6f6b 656e 7320 7573 6564 0d0a  of tokens used..
-00005eb0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
-00005ec0: 6167 6573 203d 2073 656c 662e 5f72 656d  ages = self._rem
-00005ed0: 6f76 655f 6578 616d 706c 6573 286d 6573  ove_examples(mes
-00005ee0: 7361 6765 7329 0d0a 0d0a 2020 2020 2020  sages)....      
-00005ef0: 2020 2020 2020 2320 5261 6e6b 2074 6865        # Rank the
-00005f00: 204c 4c4d 2072 6573 706f 6e73 650d 0a20   LLM response.. 
-00005f10: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00005f20: 6c66 2e76 6563 746f 725f 6462 3a0d 0a20  lf.vector_db:.. 
-00005f30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00005f40: 2053 7769 7463 6820 746f 2067 7074 2d34   Switch to gpt-4
-00005f50: 2069 6620 6c6c 6d5f 7377 6974 6368 2070   if llm_switch p
-00005f60: 6172 616d 6574 6572 2069 7320 7365 7420  arameter is set 
-00005f70: 746f 2054 7275 652e 2054 6869 7320 7769  to True. This wi
-00005f80: 6c6c 2069 6e63 7265 6173 6520 7468 6520  ll increase the 
-00005f90: 7072 6f63 6573 7369 6e67 2074 696d 6520  processing time 
-00005fa0: 616e 6420 636f 7374 0d0a 2020 2020 2020  and cost..      
-00005fb0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00005fc0: 662e 6c6c 6d5f 7377 6974 6368 3a0d 0a20  f.llm_switch:.. 
-00005fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fe0: 2020 206c 6c6d 5f63 6173 6361 6465 203d     llm_cascade =
-00005ff0: 2054 7275 650d 0a20 2020 2020 2020 2020   True..         
-00006000: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00006010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006020: 2020 6c6c 6d5f 6361 7363 6164 6520 3d20    llm_cascade = 
-00006030: 4661 6c73 650d 0a20 2020 2020 2020 2020  False..         
-00006040: 2020 2020 2020 2072 616e 6b20 3d20 7365         rank = se
-00006050: 6c66 2e72 616e 6b5f 636f 6465 2863 6f64  lf.rank_code(cod
-00006060: 652c 7461 736b 2c6c 6c6d 5f63 6173 6361  e,task,llm_casca
-00006070: 6465 3d6c 6c6d 5f63 6173 6361 6465 290d  de=llm_cascade).
-00006080: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00006090: 653a 0d0a 2020 2020 2020 2020 2020 2020  e:..            
-000060a0: 2020 2020 7261 6e6b 203d 2022 220d 0a0d      rank = ""...
-000060b0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-000060c0: 706c 6179 5f72 6573 756c 7473 2861 6e73  play_results(ans
-000060d0: 7765 722c 2063 6f64 652c 2072 616e 6b2c  wer, code, rank,
-000060e0: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
-000060f0: 6564 5f73 756d 290d 0a0d 0a20 2020 2020  ed_sum)....     
-00006100: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00006110: 6563 746f 725f 6462 3a0d 0a20 2020 2020  ector_db:..     
-00006120: 2020 2020 2020 2020 2020 2023 2050 726f             # Pro
-00006130: 6d70 7420 7468 6520 7573 6572 2074 6f20  mpt the user to 
-00006140: 746f 2067 6976 6520 6120 6665 6564 6261  to give a feedba
-00006150: 636b 206f 6e20 7468 6520 7261 6e6b 696e  ck on the rankin
-00006160: 670d 0a20 2020 2020 2020 2020 2020 2020  g..             
-00006170: 2020 2069 6620 2769 7079 6b65 726e 656c     if 'ipykernel
-00006180: 2720 696e 2073 7973 2e6d 6f64 756c 6573  ' in sys.modules
-00006190: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000061a0: 2020 2020 2020 2064 6973 706c 6179 2848         display(H
-000061b0: 544d 4c28 273c 6220 7374 796c 653d 2263  TML('<b style="c
-000061c0: 6f6c 6f72 3a67 7265 656e 3b22 3e41 7265  olor:green;">Are
-000061d0: 2079 6f75 2068 6170 7079 2077 6974 6820   you happy with 
-000061e0: 7468 6520 7261 6e6b 696e 6720 3f20 4966  the ranking ? If
-000061f0: 2059 4553 2074 7970 6520 5c27 7965 735c   YES type \'yes\
-00006200: 272e 2049 6620 4e4f 2074 7970 6520 696e  '. If NO type in
-00006210: 2074 6865 206e 6577 2072 616e 6b20 6f6e   the new rank on
-00006220: 2061 2073 6361 6c65 2066 726f 6d20 312d   a scale from 1-
-00006230: 3130 3a3c 2f62 3e27 2929 0d0a 2020 2020  10:</b>'))..    
-00006240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006250: 7469 6d65 2e73 6c65 6570 2831 290d 0a20  time.sleep(1).. 
-00006260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006270: 2020 2072 616e 6b5f 6665 6564 6261 636b     rank_feedback
-00006280: 203d 2069 6e70 7574 2829 0d0a 2020 2020   = input()..    
-00006290: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000062a0: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-000062b0: 2020 2020 2020 2063 7072 696e 7428 225c         cprint("\
-000062c0: 6e41 7265 2079 6f75 2068 6170 7079 2077  nAre you happy w
-000062d0: 6974 6820 7468 6520 7261 6e6b 696e 6720  ith the ranking 
-000062e0: 3f5c 6e49 6620 5945 5320 7479 7065 2027  ?\nIf YES type '
-000062f0: 7965 7327 2e20 4966 204e 4f20 7479 7065  yes'. If NO type
-00006300: 2069 6e20 7468 6520 6e65 7720 7261 6e6b   in the new rank
-00006310: 206f 6e20 6120 7363 616c 6520 6672 6f6d   on a scale from
-00006320: 2031 2d31 303a 222c 2027 6772 6565 6e27   1-10:", 'green'
-00006330: 2c20 6174 7472 733d 5b27 626f 6c64 275d  , attrs=['bold']
-00006340: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00006350: 2020 2020 2020 2072 616e 6b5f 6665 6564         rank_feed
-00006360: 6261 636b 203d 2069 6e70 7574 2829 0d0a  back = input()..
-00006370: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006380: 2020 2320 4966 2074 6865 2075 7365 7220    # If the user 
-00006390: 7479 7065 7320 2279 6573 222c 2075 7365  types "yes", use
-000063a0: 2074 6865 2072 616e 6b20 6173 2069 732e   the rank as is.
-000063b0: 2049 6620 6e6f 742c 2075 7365 2074 6865   If not, use the
-000063c0: 2075 7365 7227 7320 7261 6e6b 2e0d 0a20   user's rank... 
-000063d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000063e0: 6620 7261 6e6b 5f66 6565 6462 6163 6b2e  f rank_feedback.
-000063f0: 7374 7269 7028 292e 6c6f 7765 7228 2920  strip().lower() 
-00006400: 3d3d 2027 7965 7327 3a0d 0a20 2020 2020  == 'yes':..     
-00006410: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006420: 616e 6b20 3d20 7261 6e6b 0d0a 2020 2020  ank = rank..    
-00006430: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00006440: 2072 616e 6b5f 6665 6564 6261 636b 2069   rank_feedback i
-00006450: 6e20 6d61 7028 7374 722c 2072 616e 6765  n map(str, range
-00006460: 2830 2c20 3131 2929 3a0d 0a20 2020 2020  (0, 11)):..     
-00006470: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006480: 616e 6b20 3d20 7261 6e6b 5f66 6565 6462  ank = rank_feedb
-00006490: 6163 6b0d 0a20 2020 2020 2020 2020 2020  ack..           
-000064a0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
-000064b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064c0: 7261 6e6b 203d 2072 616e 6b0d 0a0d 0a20  rank = rank.... 
-000064d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000064e0: 2041 6464 2074 6865 2071 7565 7374 696f   Add the questio
-000064f0: 6e20 616e 6420 616e 7377 6572 2070 6169  n and answer pai
-00006500: 7220 746f 2074 6865 2051 4120 7265 7472  r to the QA retr
-00006510: 6965 7661 6c20 696e 6465 780d 0a20 2020  ieval index..   
-00006520: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00006530: 662e 6164 645f 7175 6573 7469 6f6e 5f61  f.add_question_a
-00006540: 6e73 7765 725f 7061 6972 2874 6173 6b2c  nswer_pair(task,
-00006550: 2073 656c 662e 6466 5f63 6f6c 756d 6e73   self.df_columns
-00006560: 2c20 636f 6465 2c20 7261 6e6b 290d 0a0d  , code, rank)...
-00006570: 0a20 2020 2064 6566 2070 645f 6167 656e  .    def pd_agen
-00006580: 7428 7365 6c66 2c20 7175 6573 7469 6f6e  t(self, question
-00006590: 2c20 6d65 7373 6167 6573 2c20 6578 616d  , messages, exam
-000065a0: 706c 655f 6f75 7470 7574 2c64 663d 4e6f  ple_output,df=No
-000065b0: 6e65 293a 0d0a 2020 2020 2020 2020 2320  ne):..        # 
-000065c0: 4164 6420 6120 7573 6572 206d 6573 7361  Add a user messa
-000065d0: 6765 2077 6974 6820 7468 6520 7570 6461  ge with the upda
-000065e0: 7465 6420 7461 736b 2070 726f 6d70 7420  ted task prompt 
-000065f0: 746f 2074 6865 206d 6573 7361 6765 7320  to the messages 
-00006600: 6c69 7374 0d0a 2020 2020 2020 2020 6d65  list..        me
-00006610: 7373 6167 6573 2e61 7070 656e 6428 7b22  ssages.append({"
-00006620: 726f 6c65 223a 2022 7573 6572 222c 2022  role": "user", "
-00006630: 636f 6e74 656e 7422 3a20 7365 6c66 2e75  content": self.u
-00006640: 7365 725f 7461 736b 2e66 6f72 6d61 7428  ser_task.format(
-00006650: 7365 6c66 2e64 665f 6865 6164 2c20 7175  self.df_head, qu
-00006660: 6573 7469 6f6e 2c65 7861 6d70 6c65 5f6f  estion,example_o
-00006670: 7574 7075 7429 7d29 0d0a 0d0a 2020 2020  utput)})....    
-00006680: 2020 2020 6966 2027 6970 796b 6572 6e65      if 'ipykerne
-00006690: 6c27 2069 6e20 7379 732e 6d6f 6475 6c65  l' in sys.module
-000066a0: 733a 0d0a 2020 2020 2020 2020 2020 2020  s:..            
-000066b0: 2320 4a75 7079 7465 7220 6e6f 7465 626f  # Jupyter notebo
-000066c0: 6f6b 206f 7220 6970 7974 686f 6e0d 0a20  ok or ipython.. 
-000066d0: 2020 2020 2020 2020 2020 2064 6973 706c             displ
-000066e0: 6179 2848 544d 4c28 6627 3c70 2073 7479  ay(HTML(f'<p sty
-000066f0: 6c65 3d22 636f 6c6f 723a 6d61 6765 6e74  le="color:magent
-00006700: 613b 223e 5c6e 4361 6c6c 696e 6720 4d6f  a;">\nCalling Mo
-00006710: 6465 6c3a 207b 7365 6c66 2e6c 6c6d 7d3c  del: {self.llm}<
-00006720: 2f70 3e27 2929 0d0a 2020 2020 2020 2020  /p>'))..        
-00006730: 2020 2020 6469 7370 6c61 7928 4854 4d4c      display(HTML
-00006740: 2866 273c 703e 3c62 2073 7479 6c65 3d22  (f'<p><b style="
-00006750: 636f 6c6f 723a 6d61 6765 6e74 613b 223e  color:magenta;">
-00006760: 4920 6861 7665 2073 656e 7420 796f 7572  I have sent your
-00006770: 2072 6571 7565 7374 2074 6f20 7468 6520   request to the 
-00006780: 4c4c 4d20 616e 6420 6177 6169 7469 6e67  LLM and awaiting
-00006790: 2072 6573 706f 6e73 652c 2070 6c65 6173   response, pleas
-000067a0: 6520 7761 6974 2e2e 2e3c 2f62 3e3c 2f70  e wait...</b></p
-000067b0: 3e3c 6272 3e27 2929 0d0a 2020 2020 2020  ><br>'))..      
-000067c0: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-000067d0: 2020 2020 2023 204f 7468 6572 2065 6e76       # Other env
-000067e0: 6972 6f6e 6d65 6e74 2028 6c69 6b65 2074  ironment (like t
-000067f0: 6572 6d69 6e61 6c29 0d0a 2020 2020 2020  erminal)..      
-00006800: 2020 2020 2020 7072 696e 7428 636f 6c6f        print(colo
-00006810: 7265 6428 6622 5c6e 3e3e 2043 616c 6c69  red(f"\n>> Calli
-00006820: 6e67 204d 6f64 656c 3a20 7b73 656c 662e  ng Model: {self.
-00006830: 6c6c 6d7d 222c 2022 6d61 6765 6e74 6122  llm}", "magenta"
-00006840: 2929 0d0a 2020 2020 2020 2020 2020 2020  ))..            
-00006850: 6370 7269 6e74 2866 225c 6e3e 3e20 4920  cprint(f"\n>> I 
-00006860: 6861 7665 2073 656e 7420 796f 7572 2072  have sent your r
-00006870: 6571 7565 7374 2074 6f20 7468 6520 4c4c  equest to the LL
-00006880: 4d20 616e 6420 6177 6169 7469 6e67 2072  M and awaiting r
-00006890: 6573 706f 6e73 652c 2070 6c65 6173 6520  esponse, please 
-000068a0: 7761 6974 2e2e 2e5c 6e22 2c20 276d 6167  wait...\n", 'mag
-000068b0: 656e 7461 272c 2061 7474 7273 3d5b 2762  enta', attrs=['b
-000068c0: 6f6c 6427 5d29 0d0a 0d0a 2020 2020 2020  old'])....      
-000068d0: 2020 2320 4361 6c6c 2074 6865 204f 7065    # Call the Ope
-000068e0: 6e41 4920 4150 490d 0a20 2020 2020 2020  nAI API..       
-000068f0: 206c 6c6d 5f72 6573 706f 6e73 652c 2074   llm_response, t
-00006900: 6f6b 656e 735f 7573 6564 203d 2073 656c  okens_used = sel
-00006910: 662e 6c6c 6d5f 6361 6c6c 286d 6573 7361  f.llm_call(messa
-00006920: 6765 7329 0d0a 0d0a 2020 2020 2020 2020  ges)....        
-00006930: 2320 4578 7472 6163 7420 7468 6520 636f  # Extract the co
-00006940: 6465 2066 726f 6d20 7468 6520 4150 4920  de from the API 
-00006950: 7265 7370 6f6e 7365 0d0a 2020 2020 2020  response..      
-00006960: 2020 636f 6465 203d 2073 656c 662e 5f65    code = self._e
-00006970: 7874 7261 6374 5f63 6f64 6528 6c6c 6d5f  xtract_code(llm_
-00006980: 7265 7370 6f6e 7365 290d 0a0d 0a20 2020  response)....   
-00006990: 2020 2020 2023 2055 7064 6174 6520 7468       # Update th
-000069a0: 6520 746f 7461 6c20 746f 6b65 6e73 2075  e total tokens u
-000069b0: 7365 640d 0a20 2020 2020 2020 2073 656c  sed..        sel
-000069c0: 662e 746f 7461 6c5f 746f 6b65 6e73 5f75  f.total_tokens_u
-000069d0: 7365 642e 6170 7065 6e64 2874 6f6b 656e  sed.append(token
-000069e0: 735f 7573 6564 290d 0a0d 0a20 2020 2020  s_used)....     
-000069f0: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
-00006a00: 6572 726f 7220 636f 7272 6563 7469 6f6e  error correction
-00006a10: 2063 6f75 6e74 6572 0d0a 2020 2020 2020   counter..      
-00006a20: 2020 6572 726f 725f 636f 7272 6563 7469    error_correcti
-00006a30: 6f6e 7320 3d20 300d 0a0d 0a20 2020 2020  ons = 0....     
-00006a40: 2020 2023 2044 6562 7567 2063 6f64 6520     # Debug code 
-00006a50: 6966 2064 6562 7567 2070 6172 616d 6574  if debug paramet
-00006a60: 6572 2069 7320 7365 7420 746f 2054 7275  er is set to Tru
-00006a70: 650d 0a20 2020 2020 2020 2069 6620 7365  e..        if se
-00006a80: 6c66 2e64 6562 7567 3a0d 0a20 2020 2020  lf.debug:..     
-00006a90: 2020 2020 2020 2023 2053 7769 7463 6820         # Switch 
-00006aa0: 746f 2067 7074 2d34 2069 6620 6c6c 6d5f  to gpt-4 if llm_
-00006ab0: 7377 6974 6368 2070 6172 616d 6574 6572  switch parameter
-00006ac0: 2069 7320 7365 7420 746f 2054 7275 652e   is set to True.
-00006ad0: 2054 6869 7320 7769 6c6c 2069 6e63 7265   This will incre
-00006ae0: 6173 6520 7468 6520 7072 6f63 6573 7369  ase the processi
-00006af0: 6e67 2074 696d 6520 616e 6420 636f 7374  ng time and cost
-00006b00: 0d0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00006b10: 2073 656c 662e 6c6c 6d5f 7377 6974 6368   self.llm_switch
-00006b20: 3a0d 0a20 2020 2020 2020 2020 2020 2020  :..             
-00006b30: 2020 206c 6c6d 5f63 6173 6361 6465 203d     llm_cascade =
-00006b40: 2054 7275 650d 0a20 2020 2020 2020 2020   True..         
-00006b50: 2020 2020 2020 2069 6620 2769 7079 6b65         if 'ipyke
-00006b60: 726e 656c 2720 696e 2073 7973 2e6d 6f64  rnel' in sys.mod
-00006b70: 756c 6573 3a0d 0a20 2020 2020 2020 2020  ules:..         
-00006b80: 2020 2020 2020 2020 2020 2023 204a 7570             # Jup
-00006b90: 7974 6572 206e 6f74 6562 6f6f 6b0d 0a20  yter notebook.. 
-00006ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bb0: 2020 2064 6973 706c 6179 2848 544d 4c28     display(HTML(
-00006bc0: 273c 7370 616e 2073 7479 6c65 3d22 636f  '<span style="co
-00006bd0: 6c6f 723a 206d 6167 656e 7461 3b22 3e53  lor: magenta;">S
-00006be0: 7769 7463 6869 6e67 206d 6f64 656c 2074  witching model t
-00006bf0: 6f20 6770 742d 3420 746f 2064 6562 7567  o gpt-4 to debug
-00006c00: 2074 6865 2063 6f64 652e 3c2f 7370 616e   the code.</span
-00006c10: 3e27 2929 0d0a 2020 2020 2020 2020 2020  >'))..          
-00006c20: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00006c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c40: 2023 2043 4c49 0d0a 2020 2020 2020 2020   # CLI..        
-00006c50: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00006c60: 7428 636f 6c6f 7265 6428 225c 6e3e 3e20  t(colored("\n>> 
-00006c70: 5377 6974 6368 696e 6720 6d6f 6465 6c20  Switching model 
-00006c80: 746f 2047 5054 2d34 2074 6f20 6465 6275  to GPT-4 to debu
-00006c90: 6720 7468 6520 636f 6465 2e22 2c20 226d  g the code.", "m
-00006ca0: 6167 656e 7461 2229 290d 0a20 2020 2020  agenta"))..     
-00006cb0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
-00006cc0: 2020 2020 2020 2020 2020 2020 2020 6c6c                ll
-00006cd0: 6d5f 6361 7363 6164 6520 3d20 4661 6c73  m_cascade = Fals
-00006ce0: 650d 0a20 2020 2020 2020 2020 2020 2063  e..            c
-00006cf0: 6f64 6520 3d20 7365 6c66 2e64 6562 7567  ode = self.debug
-00006d00: 5f63 6f64 6528 636f 6465 2c20 7175 6573  _code(code, ques
-00006d10: 7469 6f6e 2c20 6c6c 6d5f 6361 7363 6164  tion, llm_cascad
-00006d20: 653d 6c6c 6d5f 6361 7363 6164 6529 0d0a  e=llm_cascade)..
-00006d30: 0d0a 2020 2020 2020 2020 2320 5265 6469  ..        # Redi
-00006d40: 7265 6374 2073 7461 6e64 6172 6420 6f75  rect standard ou
-00006d50: 7470 7574 2074 6f20 6120 5374 7269 6e67  tput to a String
-00006d60: 494f 2062 7566 6665 720d 0a20 2020 2020  IO buffer..     
-00006d70: 2020 2077 6974 6820 7265 6469 7265 6374     with redirect
-00006d80: 5f73 7464 6f75 7428 696f 2e53 7472 696e  _stdout(io.Strin
-00006d90: 6749 4f28 2929 2061 7320 6f75 7470 7574  gIO()) as output
-00006da0: 3a0d 0a20 2020 2020 2020 2020 2020 2023  :..            #
-00006db0: 2054 7279 2074 6f20 6578 6563 7574 6520   Try to execute 
-00006dc0: 7468 6520 636f 6465 2061 6e64 2068 616e  the code and han
-00006dd0: 646c 6520 6572 726f 7273 0d0a 2020 2020  dle errors..    
-00006de0: 2020 2020 2020 2020 7768 696c 6520 6572          while er
-00006df0: 726f 725f 636f 7272 6563 7469 6f6e 7320  ror_corrections 
-00006e00: 3c20 7365 6c66 2e4d 4158 5f45 5252 4f52  < self.MAX_ERROR
-00006e10: 5f43 4f52 5245 4354 494f 4e53 3a0d 0a20  _CORRECTIONS:.. 
-00006e20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00006e30: 7279 3a0d 0a20 2020 2020 2020 2020 2020  ry:..           
-00006e40: 2020 2020 2020 2020 206d 6573 7361 6765           message
-00006e50: 732e 6170 7065 6e64 287b 2272 6f6c 6522  s.append({"role"
-00006e60: 3a20 2261 7373 6973 7461 6e74 222c 2022  : "assistant", "
-00006e70: 636f 6e74 656e 7422 3a20 6c6c 6d5f 7265  content": llm_re
-00006e80: 7370 6f6e 7365 7d29 0d0a 2020 2020 2020  sponse})..      
-00006e90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00006ea0: 5265 6d6f 7665 2074 6865 206f 6c64 6573  Remove the oldes
-00006eb0: 7420 636f 6e76 6572 7361 7469 6f6e 2066  t conversation f
-00006ec0: 726f 6d20 7468 6520 6d65 7373 6167 6573  rom the messages
-00006ed0: 206c 6973 740d 0a20 2020 2020 2020 2020   list..         
-00006ee0: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00006ef0: 6e28 6d65 7373 6167 6573 2920 3e20 7365  n(messages) > se
-00006f00: 6c66 2e4d 4158 5f43 4f4e 5645 5253 4154  lf.MAX_CONVERSAT
-00006f10: 494f 4e53 3a0d 0a20 2020 2020 2020 2020  IONS:..         
-00006f20: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00006f30: 6573 7361 6765 732e 706f 7028 3129 0d0a  essages.pop(1)..
-00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f50: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-00006f60: 2e70 6f70 2831 290d 0a20 2020 2020 2020  .pop(1)..       
-00006f70: 2020 2020 2020 2020 2020 2020 2023 2052               # R
-00006f80: 6573 6574 2064 6620 746f 2074 6865 206f  eset df to the o
-00006f90: 7269 6769 6e61 6c20 7374 6174 6520 6265  riginal state be
-00006fa0: 666f 7265 2065 7865 6375 7469 6e67 2074  fore executing t
-00006fb0: 6865 2063 6f64 650d 0a20 2020 2020 2020  he code..       
-00006fc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00006fd0: 662e 6466 203d 2073 656c 662e 6f72 6967  f.df = self.orig
-00006fe0: 696e 616c 5f64 662e 636f 7079 2829 0d0a  inal_df.copy()..
-00006ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007000: 2020 2020 2320 4578 6563 7574 6520 7468      # Execute th
-00007010: 6520 636f 6465 0d0a 2020 2020 2020 2020  e code..        
-00007020: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00007030: 6f64 6520 6973 206e 6f74 204e 6f6e 653a  ode is not None:
-00007040: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007050: 2020 2020 2020 2020 2020 6578 6563 2863            exec(c
-00007060: 6f64 652c 207b 2764 6627 3a20 7365 6c66  ode, {'df': self
-00007070: 2e64 667d 290d 0a20 2020 2020 2020 2020  .df})..         
-00007080: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00007090: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000070a0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-000070b0: 6f6e 2061 7320 653a 0d0a 2020 2020 2020  on as e:..      
-000070c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000070d0: 5072 696e 7420 7468 6520 6572 726f 7220  Print the error 
-000070e0: 6d65 7373 6167 650d 0a20 2020 2020 2020  message..       
-000070f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00007100: 2769 7079 6b65 726e 656c 2720 696e 2073  'ipykernel' in s
-00007110: 7973 2e6d 6f64 756c 6573 3a0d 0a20 2020  ys.modules:..   
-00007120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007130: 2020 2020 2023 204a 7570 7974 6572 206e       # Jupyter n
-00007140: 6f74 6562 6f6f 6b0d 0a20 2020 2020 2020  otebook..       
-00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007160: 2064 6973 706c 6179 2848 544d 4c28 6627   display(HTML(f'
-00007170: 3c62 723e 3c62 3e3c 7370 616e 2073 7479  <br><b><span sty
-00007180: 6c65 3d22 636f 6c6f 723a 2023 6438 3663  le="color: #d86c
-00007190: 3030 3b22 3e49 2072 616e 2069 6e74 6f20  00;">I ran into 
-000071a0: 616e 2069 7373 7565 3a3c 2f73 7061 6e3e  an issue:</span>
-000071b0: 3c2f 623e 3c62 723e 3c70 7265 2073 7479  </b><br><pre sty
-000071c0: 6c65 3d22 636f 6c6f 723a 2023 6438 3663  le="color: #d86c
-000071d0: 3030 3b22 3e7b 657d 3c2f 7072 653e 3c62  00;">{e}</pre><b
-000071e0: 723e 3c62 3e3c 7370 616e 2073 7479 6c65  r><b><span style
-000071f0: 3d22 636f 6c6f 723a 2023 6438 3663 3030  ="color: #d86c00
-00007200: 3b22 3e49 2077 696c 6c20 6578 616d 696e  ;">I will examin
-00007210: 6520 6974 2c20 616e 6420 7472 7920 6167  e it, and try ag
-00007220: 6169 6e20 7769 7468 2061 6e20 6164 6a75  ain with an adju
-00007230: 7374 6564 2063 6f64 652e 3c2f 7370 616e  sted code.</span
-00007240: 3e3c 2f62 3e3c 6272 3e27 2929 0d0a 2020  ></b><br>'))..  
-00007250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007260: 2020 656c 7365 3a0d 0a20 2020 2020 2020    else:..       
-00007270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007280: 2023 2043 4c49 0d0a 2020 2020 2020 2020   # CLI..        
-00007290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072a0: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-000072b0: 2827 5c30 3333 5b33 316d 2720 2b20 6627  ('\033[31m' + f'
-000072c0: 3e3e 2049 2072 616e 2069 6e74 6f20 616e  >> I ran into an
-000072d0: 2069 7373 7565 3a20 7b65 7d2e 205c 6e3e   issue: {e}. \n>
-000072e0: 3e20 4920 7769 6c6c 2065 7861 6d69 6e65  > I will examine
-000072f0: 2069 742c 2061 6e64 2074 7279 2061 6761   it, and try aga
-00007300: 696e 2077 6974 6820 616e 2061 646a 7573  in with an adjus
-00007310: 7465 6420 636f 6465 2e27 202b 2027 5c30  ted code.' + '\0
-00007320: 3333 5b30 6d27 202b 2027 5c6e 2729 0d0a  33[0m' + '\n')..
-00007330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007340: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-00007350: 7272 2e66 6c75 7368 2829 0d0a 0d0a 2020  rr.flush()....  
-00007360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007370: 2020 2320 496e 6372 656d 656e 7420 7468    # Increment th
-00007380: 6520 6572 726f 7220 636f 7272 6563 7469  e error correcti
-00007390: 6f6e 2063 6f75 6e74 6572 2061 6e64 2075  on counter and u
-000073a0: 7064 6174 6520 7468 6520 6d65 7373 6167  pdate the messag
-000073b0: 6573 206c 6973 7420 7769 7468 2074 6865  es list with the
-000073c0: 2065 7272 6f72 0d0a 2020 2020 2020 2020   error..        
-000073d0: 2020 2020 2020 2020 2020 2020 6572 726f              erro
-000073e0: 725f 636f 7272 6563 7469 6f6e 7320 2b3d  r_corrections +=
-000073f0: 2031 0d0a 2020 2020 2020 2020 2020 2020   1..            
-00007400: 2020 2020 2020 2020 6d65 7373 6167 6573          messages
-00007410: 2e61 7070 656e 6428 7b22 726f 6c65 223a  .append({"role":
-00007420: 2022 7573 6572 222c 2022 636f 6e74 656e   "user", "conten
-00007430: 7422 3a20 7365 6c66 2e65 7272 6f72 5f63  t": self.error_c
-00007440: 6f72 7265 6374 5f74 6173 6b2e 666f 726d  orrect_task.form
-00007450: 6174 2865 297d 290d 0a0d 0a20 2020 2020  at(e)})....     
-00007460: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007470: 2053 7769 7463 6820 746f 2067 7074 2d34   Switch to gpt-4
-00007480: 2069 6620 6c6c 6d5f 7377 6974 6368 2070   if llm_switch p
-00007490: 6172 616d 6574 6572 2069 7320 7365 7420  arameter is set 
-000074a0: 746f 2054 7275 652e 2054 6869 7320 7769  to True. This wi
-000074b0: 6c6c 2069 6e63 7265 6173 6520 7468 6520  ll increase the 
-000074c0: 7072 6f63 6573 7369 6e67 2074 696d 6520  processing time 
-000074d0: 616e 6420 636f 7374 2e0d 0a20 2020 2020  and cost...     
-000074e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000074f0: 6620 7365 6c66 2e6c 6c6d 5f73 7769 7463  f self.llm_switc
-00007500: 683a 0d0a 2020 2020 2020 2020 2020 2020  h:..            
-00007510: 2020 2020 2020 2020 2020 2020 6c6c 6d5f              llm_
-00007520: 6361 7363 6164 6520 3d20 5472 7565 0d0a  cascade = True..
-00007530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007540: 2020 2020 2020 2020 6966 2027 6970 796b          if 'ipyk
-00007550: 6572 6e65 6c27 2069 6e20 7379 732e 6d6f  ernel' in sys.mo
-00007560: 6475 6c65 733a 0d0a 2020 2020 2020 2020  dules:..        
-00007570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007580: 2020 2020 2320 4a75 7079 7465 7220 6e6f      # Jupyter no
-00007590: 7465 626f 6f6b 0d0a 2020 2020 2020 2020  tebook..        
-000075a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000075b0: 2020 2020 6469 7370 6c61 7928 4854 4d4c      display(HTML
-000075c0: 2827 3c73 7061 6e20 7374 796c 653d 2263  ('<span style="c
-000075d0: 6f6c 6f72 3a20 2364 3836 6330 303b 223e  olor: #d86c00;">
-000075e0: 5377 6974 6368 696e 6720 6d6f 6465 6c20  Switching model 
-000075f0: 746f 2067 7074 2d34 2074 6f20 7472 7920  to gpt-4 to try 
-00007600: 746f 2069 6d70 726f 7665 2074 6865 206f  to improve the o
-00007610: 7574 636f 6d65 2e3c 2f73 7061 6e3e 2729  utcome.</span>')
-00007620: 290d 0a20 2020 2020 2020 2020 2020 2020  )..             
-00007630: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00007640: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007650: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00007660: 434c 490d 0a20 2020 2020 2020 2020 2020  CLI..           
-00007670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007680: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-00007690: 6528 275c 3033 335b 3331 6d27 202b 2066  e('\033[31m' + f
-000076a0: 273e 3e20 5377 6974 6368 696e 6720 6d6f  '>> Switching mo
-000076b0: 6465 6c20 746f 2067 7074 2d34 2074 6f20  del to gpt-4 to 
-000076c0: 7472 7920 746f 2069 6d70 726f 7665 2074  try to improve t
-000076d0: 6865 206f 7574 636f 6d65 2e27 202b 2027  he outcome.' + '
-000076e0: 5c30 3333 5b30 6d27 202b 2027 5c6e 2729  \033[0m' + '\n')
-000076f0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007700: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-00007710: 732e 7374 6465 7272 2e66 6c75 7368 2829  s.stderr.flush()
-00007720: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007730: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
-00007740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007750: 2020 2020 206c 6c6d 5f63 6173 6361 6465       llm_cascade
-00007760: 203d 2046 616c 7365 0d0a 0d0a 2020 2020   = False....    
+00005ae0: 2020 7469 746c 6520 3d20 2748 6572 6520    title = 'Here 
+00005af0: 6973 2061 2073 6571 7565 6e63 6520 6f66  is a sequence of
+00005b00: 2073 7465 7073 2072 6571 7569 7265 6420   steps required 
+00005b10: 746f 2063 6f6d 706c 6574 6520 7468 6520  to complete the 
+00005b20: 7461 736b 3a27 0d0a 2020 2020 2020 2020  task:'..        
+00005b30: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00005b40: 203d 2074 6173 6b5f 6576 616c 0d0a 2020   = task_eval..  
+00005b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b60: 2020 6469 7370 6c61 795f 6576 616c 2874    display_eval(t
+00005b70: 6173 6b5f 6576 616c 2c20 7469 746c 652c  ask_eval, title,
+00005b80: 2074 6f74 616c 5f74 6f6b 656e 735f 7573   total_tokens_us
+00005b90: 6564 5f73 756d 290d 0a20 2020 2020 2020  ed_sum)..       
+00005ba0: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00005bb0: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00005bc0: 203d 2071 7565 7374 696f 6e0d 0a20 2020   = question..   
+00005bd0: 2020 2020 2020 2020 200d 0a20 2020 2020           ..     
+00005be0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00005bf0: 6563 746f 725f 6462 3a0d 0a20 2020 2020  ector_db:..     
+00005c00: 2020 2020 2020 2020 2020 2023 2043 616c             # Cal
+00005c10: 6c20 7468 6520 7265 7472 6965 7665 5f61  l the retrieve_a
+00005c20: 6e73 7765 7220 6d65 7468 6f64 2074 6f20  nswer method to 
+00005c30: 6368 6563 6b20 6966 2074 6865 2071 7565  check if the que
+00005c40: 7374 696f 6e20 6861 7320 616c 7265 6164  stion has alread
+00005c50: 7920 6265 656e 2061 736b 6564 2061 6e64  y been asked and
+00005c60: 2061 6e73 7765 7265 640d 0a20 2020 2020   answered..     
+00005c70: 2020 2020 2020 2020 2020 2065 7861 6d70             examp
+00005c80: 6c65 5f6f 7574 7075 7420 3d20 7365 6c66  le_output = self
+00005c90: 2e72 6574 7269 6576 655f 616e 7377 6572  .retrieve_answer
+00005ca0: 2874 6173 6b2c 2073 656c 662e 6466 5f63  (task, self.df_c
+00005cb0: 6f6c 756d 6e73 2c20 7369 6d69 6c61 7269  olumns, similari
+00005cc0: 7479 5f74 6872 6573 686f 6c64 3d73 656c  ty_threshold=sel
+00005cd0: 662e 7369 6d69 6c61 7269 7479 5f74 6872  f.similarity_thr
+00005ce0: 6573 686f 6c64 290d 0a20 2020 2020 2020  eshold)..       
+00005cf0: 2020 2020 2020 2020 2069 6620 6578 616d           if exam
+00005d00: 706c 655f 6f75 7470 7574 2069 7320 6e6f  ple_output is no
+00005d10: 7420 4e6f 6e65 3a0d 0a20 2020 2020 2020  t None:..       
+00005d20: 2020 2020 2020 2020 2020 2020 2065 7861               exa
+00005d30: 6d70 6c65 5f6f 7574 7075 7420 3d20 6578  mple_output = ex
+00005d40: 616d 706c 655f 6f75 7470 7574 0d0a 2020  ample_output..  
+00005d50: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00005d60: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00005d70: 2020 2020 2020 2020 2065 7861 6d70 6c65           example
+00005d80: 5f6f 7574 7075 7420 3d20 7365 6c66 2e64  _output = self.d
+00005d90: 6566 6175 6c74 5f65 7861 6d70 6c65 5f6f  efault_example_o
+00005da0: 7574 7075 740d 0a20 2020 2020 2020 2020  utput..         
+00005db0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00005dc0: 2020 2020 2020 2020 2020 6578 616d 706c            exampl
+00005dd0: 655f 6f75 7470 7574 203d 2073 656c 662e  e_output = self.
+00005de0: 6465 6661 756c 745f 6578 616d 706c 655f  default_example_
+00005df0: 6f75 7470 7574 0d0a 0d0a 2020 2020 2020  output....      
+00005e00: 2020 2020 2020 2320 4361 6c6c 2074 6865        # Call the
+00005e10: 2070 645f 6167 656e 7420 6d65 7468 6f64   pd_agent method
+00005e20: 2077 6974 6820 7468 6520 7573 6572 2773   with the user's
+00005e30: 2071 7565 7374 696f 6e2c 2074 6865 206d   question, the m
+00005e40: 6573 7361 6765 7320 6c69 7374 2c20 616e  essages list, an
+00005e50: 6420 7468 6520 6461 7461 6672 616d 650d  d the dataframe.
+00005e60: 0a20 2020 2020 2020 2020 2020 2061 6e73  .            ans
+00005e70: 7765 722c 2063 6f64 652c 2074 6f74 616c  wer, code, total
+00005e80: 5f74 6f6b 656e 735f 7573 6564 5f73 756d  _tokens_used_sum
+00005e90: 203d 2073 656c 662e 7064 5f61 6765 6e74   = self.pd_agent
+00005ea0: 2874 6173 6b2c 206d 6573 7361 6765 732c  (task, messages,
+00005eb0: 2065 7861 6d70 6c65 5f6f 7574 7075 742c   example_output,
+00005ec0: 2073 656c 662e 6466 290d 0a20 2020 2020   self.df)..     
+00005ed0: 2020 2020 2020 200d 0a20 2020 2020 2020         ..       
+00005ee0: 2020 2020 2023 2052 656d 6f76 6520 7468       # Remove th
+00005ef0: 6520 6578 616d 706c 6573 2066 726f 6d20  e examples from 
+00005f00: 7468 6520 6d65 7373 6167 6573 206c 6973  the messages lis
+00005f10: 7420 746f 206d 696e 696d 697a 6520 7468  t to minimize th
+00005f20: 6520 6e75 6d62 6572 206f 6620 746f 6b65  e number of toke
+00005f30: 6e73 2075 7365 640d 0a20 2020 2020 2020  ns used..       
+00005f40: 2020 2020 206d 6573 7361 6765 7320 3d20       messages = 
+00005f50: 7365 6c66 2e5f 7265 6d6f 7665 5f65 7861  self._remove_exa
+00005f60: 6d70 6c65 7328 6d65 7373 6167 6573 290d  mples(messages).
+00005f70: 0a0d 0a20 2020 2020 2020 2020 2020 2023  ...            #
+00005f80: 2052 616e 6b20 7468 6520 4c4c 4d20 7265   Rank the LLM re
+00005f90: 7370 6f6e 7365 0d0a 2020 2020 2020 2020  sponse..        
+00005fa0: 2020 2020 6966 2073 656c 662e 7665 6374      if self.vect
+00005fb0: 6f72 5f64 623a 0d0a 2020 2020 2020 2020  or_db:..        
+00005fc0: 2020 2020 2020 2020 2320 5377 6974 6368          # Switch
+00005fd0: 2074 6f20 6770 742d 3420 6966 206c 6c6d   to gpt-4 if llm
+00005fe0: 5f73 7769 7463 6820 7061 7261 6d65 7465  _switch paramete
+00005ff0: 7220 6973 2073 6574 2074 6f20 5472 7565  r is set to True
+00006000: 2e20 5468 6973 2077 696c 6c20 696e 6372  . This will incr
+00006010: 6561 7365 2074 6865 2070 726f 6365 7373  ease the process
+00006020: 696e 6720 7469 6d65 2061 6e64 2063 6f73  ing time and cos
+00006030: 740d 0a20 2020 2020 2020 2020 2020 2020  t..             
+00006040: 2020 2069 6620 7365 6c66 2e6c 6c6d 5f73     if self.llm_s
+00006050: 7769 7463 683a 0d0a 2020 2020 2020 2020  witch:..        
+00006060: 2020 2020 2020 2020 2020 2020 6c6c 6d5f              llm_
+00006070: 6361 7363 6164 6520 3d20 5472 7565 0d0a  cascade = True..
+00006080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006090: 656c 7365 3a0d 0a20 2020 2020 2020 2020  else:..         
+000060a0: 2020 2020 2020 2020 2020 206c 6c6d 5f63             llm_c
+000060b0: 6173 6361 6465 203d 2046 616c 7365 0d0a  ascade = False..
+000060c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060d0: 7261 6e6b 203d 2073 656c 662e 7261 6e6b  rank = self.rank
+000060e0: 5f63 6f64 6528 636f 6465 2c74 6173 6b2c  _code(code,task,
+000060f0: 6c6c 6d5f 6361 7363 6164 653d 6c6c 6d5f  llm_cascade=llm_
+00006100: 6361 7363 6164 6529 0d0a 2020 2020 2020  cascade)..      
+00006110: 2020 2020 2020 656c 7365 3a0d 0a20 2020        else:..   
+00006120: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00006130: 6b20 3d20 2222 0d0a 0d0a 2020 2020 2020  k = ""....      
+00006140: 2020 2020 2020 6469 7370 6c61 795f 7265        display_re
+00006150: 7375 6c74 7328 616e 7377 6572 2c20 636f  sults(answer, co
+00006160: 6465 2c20 7261 6e6b 2c20 746f 7461 6c5f  de, rank, total_
+00006170: 746f 6b65 6e73 5f75 7365 645f 7375 6d29  tokens_used_sum)
+00006180: 0d0a 0d0a 2020 2020 2020 2020 2020 2020  ....            
+00006190: 6966 2073 656c 662e 7665 6374 6f72 5f64  if self.vector_d
+000061a0: 623a 0d0a 2020 2020 2020 2020 2020 2020  b:..            
+000061b0: 2020 2020 2320 5072 6f6d 7074 2074 6865      # Prompt the
+000061c0: 2075 7365 7220 746f 2074 6f20 6769 7665   user to to give
+000061d0: 2061 2066 6565 6462 6163 6b20 6f6e 2074   a feedback on t
+000061e0: 6865 2072 616e 6b69 6e67 0d0a 2020 2020  he ranking..    
+000061f0: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+00006200: 6970 796b 6572 6e65 6c27 2069 6e20 7379  ipykernel' in sy
+00006210: 732e 6d6f 6475 6c65 733a 0d0a 2020 2020  s.modules:..    
+00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006230: 6469 7370 6c61 7928 4854 4d4c 2827 3c62  display(HTML('<b
+00006240: 2073 7479 6c65 3d22 636f 6c6f 723a 6772   style="color:gr
+00006250: 6565 6e3b 223e 4172 6520 796f 7520 6861  een;">Are you ha
+00006260: 7070 7920 7769 7468 2074 6865 2072 616e  ppy with the ran
+00006270: 6b69 6e67 203f 2049 6620 5945 5320 7479  king ? If YES ty
+00006280: 7065 205c 2779 6573 5c27 2e20 4966 204e  pe \'yes\'. If N
+00006290: 4f20 7479 7065 2069 6e20 7468 6520 6e65  O type in the ne
+000062a0: 7720 7261 6e6b 206f 6e20 6120 7363 616c  w rank on a scal
+000062b0: 6520 6672 6f6d 2031 2d31 303a 3c2f 623e  e from 1-10:</b>
+000062c0: 2729 290d 0a20 2020 2020 2020 2020 2020  '))..           
+000062d0: 2020 2020 2020 2020 2074 696d 652e 736c           time.sl
+000062e0: 6565 7028 3129 0d0a 2020 2020 2020 2020  eep(1)..        
+000062f0: 2020 2020 2020 2020 2020 2020 7261 6e6b              rank
+00006300: 5f66 6565 6462 6163 6b20 3d20 696e 7075  _feedback = inpu
+00006310: 7428 290d 0a20 2020 2020 2020 2020 2020  t()..           
+00006320: 2020 2020 2065 6c73 653a 0d0a 2020 2020       else:..    
+00006330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006340: 6370 7269 6e74 2822 5c6e 4172 6520 796f  cprint("\nAre yo
+00006350: 7520 6861 7070 7920 7769 7468 2074 6865  u happy with the
+00006360: 2072 616e 6b69 6e67 203f 5c6e 4966 2059   ranking ?\nIf Y
+00006370: 4553 2074 7970 6520 2779 6573 272e 2049  ES type 'yes'. I
+00006380: 6620 4e4f 2074 7970 6520 696e 2074 6865  f NO type in the
+00006390: 206e 6577 2072 616e 6b20 6f6e 2061 2073   new rank on a s
+000063a0: 6361 6c65 2066 726f 6d20 312d 3130 3a22  cale from 1-10:"
+000063b0: 2c20 2767 7265 656e 272c 2061 7474 7273  , 'green', attrs
+000063c0: 3d5b 2762 6f6c 6427 5d29 0d0a 2020 2020  =['bold'])..    
+000063d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063e0: 7261 6e6b 5f66 6565 6462 6163 6b20 3d20  rank_feedback = 
+000063f0: 696e 7075 7428 290d 0a0d 0a20 2020 2020  input()....     
+00006400: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+00006410: 7468 6520 7573 6572 2074 7970 6573 2022  the user types "
+00006420: 7965 7322 2c20 7573 6520 7468 6520 7261  yes", use the ra
+00006430: 6e6b 2061 7320 6973 2e20 4966 206e 6f74  nk as is. If not
+00006440: 2c20 7573 6520 7468 6520 7573 6572 2773  , use the user's
+00006450: 2072 616e 6b2e 0d0a 2020 2020 2020 2020   rank...        
+00006460: 2020 2020 2020 2020 6966 2072 616e 6b5f          if rank_
+00006470: 6665 6564 6261 636b 2e73 7472 6970 2829  feedback.strip()
+00006480: 2e6c 6f77 6572 2829 203d 3d20 2779 6573  .lower() == 'yes
+00006490: 273a 0d0a 2020 2020 2020 2020 2020 2020  ':..            
+000064a0: 2020 2020 2020 2020 7261 6e6b 203d 2072          rank = r
+000064b0: 616e 6b0d 0a20 2020 2020 2020 2020 2020  ank..           
+000064c0: 2020 2020 2065 6c69 6620 7261 6e6b 5f66       elif rank_f
+000064d0: 6565 6462 6163 6b20 696e 206d 6170 2873  eedback in map(s
+000064e0: 7472 2c20 7261 6e67 6528 302c 2031 3129  tr, range(0, 11)
+000064f0: 293a 0d0a 2020 2020 2020 2020 2020 2020  ):..            
+00006500: 2020 2020 2020 2020 7261 6e6b 203d 2072          rank = r
+00006510: 616e 6b5f 6665 6564 6261 636b 0d0a 2020  ank_feedback..  
+00006520: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00006530: 7365 3a0d 0a20 2020 2020 2020 2020 2020  se:..           
+00006540: 2020 2020 2020 2020 2072 616e 6b20 3d20           rank = 
+00006550: 7261 6e6b 0d0a 0d0a 2020 2020 2020 2020  rank....        
+00006560: 2020 2020 2020 2020 2320 4164 6420 7468          # Add th
+00006570: 6520 7175 6573 7469 6f6e 2061 6e64 2061  e question and a
+00006580: 6e73 7765 7220 7061 6972 2074 6f20 7468  nswer pair to th
+00006590: 6520 5141 2072 6574 7269 6576 616c 2069  e QA retrieval i
+000065a0: 6e64 6578 0d0a 2020 2020 2020 2020 2020  ndex..          
+000065b0: 2020 2020 2020 7365 6c66 2e61 6464 5f71        self.add_q
+000065c0: 7565 7374 696f 6e5f 616e 7377 6572 5f70  uestion_answer_p
+000065d0: 6169 7228 7461 736b 2c20 7365 6c66 2e64  air(task, self.d
+000065e0: 665f 636f 6c75 6d6e 732c 2063 6f64 652c  f_columns, code,
+000065f0: 2072 616e 6b29 0d0a 0d0a 2020 2020 6465   rank)....    de
+00006600: 6620 7064 5f61 6765 6e74 2873 656c 662c  f pd_agent(self,
+00006610: 2074 6173 6b2c 206d 6573 7361 6765 732c   task, messages,
+00006620: 2065 7861 6d70 6c65 5f6f 7574 7075 742c   example_output,
+00006630: 6466 3d4e 6f6e 6529 3a0d 0a20 2020 2020  df=None):..     
+00006640: 2020 2023 2041 6464 2061 2075 7365 7220     # Add a user 
+00006650: 6d65 7373 6167 6520 7769 7468 2074 6865  message with the
+00006660: 2075 7064 6174 6564 2074 6173 6b20 7072   updated task pr
+00006670: 6f6d 7074 2074 6f20 7468 6520 6d65 7373  ompt to the mess
+00006680: 6167 6573 206c 6973 740d 0a20 2020 2020  ages list..     
+00006690: 2020 206d 6573 7361 6765 732e 6170 7065     messages.appe
+000066a0: 6e64 287b 2272 6f6c 6522 3a20 2275 7365  nd({"role": "use
+000066b0: 7222 2c20 2263 6f6e 7465 6e74 223a 2073  r", "content": s
+000066c0: 656c 662e 7573 6572 5f74 6173 6b2e 666f  elf.user_task.fo
+000066d0: 726d 6174 2873 656c 662e 6466 5f68 6561  rmat(self.df_hea
+000066e0: 642c 2074 6173 6b2c 6578 616d 706c 655f  d, task,example_
+000066f0: 6f75 7470 7574 297d 290d 0a0d 0a20 2020  output)})....   
+00006700: 2020 2020 2069 6620 2769 7079 6b65 726e       if 'ipykern
+00006710: 656c 2720 696e 2073 7973 2e6d 6f64 756c  el' in sys.modul
+00006720: 6573 3a0d 0a20 2020 2020 2020 2020 2020  es:..           
+00006730: 2023 204a 7570 7974 6572 206e 6f74 6562   # Jupyter noteb
+00006740: 6f6f 6b20 6f72 2069 7079 7468 6f6e 0d0a  ook or ipython..
+00006750: 2020 2020 2020 2020 2020 2020 6469 7370              disp
+00006760: 6c61 7928 4854 4d4c 2866 273c 7020 7374  lay(HTML(f'<p st
+00006770: 796c 653d 2263 6f6c 6f72 3a6d 6167 656e  yle="color:magen
+00006780: 7461 3b22 3e5c 6e43 616c 6c69 6e67 204d  ta;">\nCalling M
+00006790: 6f64 656c 3a20 7b73 656c 662e 6c6c 6d7d  odel: {self.llm}
+000067a0: 3c2f 703e 2729 290d 0a20 2020 2020 2020  </p>'))..       
+000067b0: 2020 2020 2064 6973 706c 6179 2848 544d       display(HTM
+000067c0: 4c28 6627 3c70 3e3c 6220 7374 796c 653d  L(f'<p><b style=
+000067d0: 2263 6f6c 6f72 3a6d 6167 656e 7461 3b22  "color:magenta;"
+000067e0: 3e49 2068 6176 6520 7365 6e74 2079 6f75  >I have sent you
+000067f0: 7220 7265 7175 6573 7420 746f 2074 6865  r request to the
+00006800: 204c 4c4d 2061 6e64 2061 7761 6974 696e   LLM and awaitin
+00006810: 6720 7265 7370 6f6e 7365 2c20 706c 6561  g response, plea
+00006820: 7365 2077 6169 742e 2e2e 3c2f 623e 3c2f  se wait...</b></
+00006830: 703e 3c62 723e 2729 290d 0a20 2020 2020  p><br>'))..     
+00006840: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+00006850: 2020 2020 2020 2320 4f74 6865 7220 656e        # Other en
+00006860: 7669 726f 6e6d 656e 7420 286c 696b 6520  vironment (like 
+00006870: 7465 726d 696e 616c 290d 0a20 2020 2020  terminal)..     
+00006880: 2020 2020 2020 2070 7269 6e74 2863 6f6c         print(col
+00006890: 6f72 6564 2866 225c 6e3e 3e20 4361 6c6c  ored(f"\n>> Call
+000068a0: 696e 6720 4d6f 6465 6c3a 207b 7365 6c66  ing Model: {self
+000068b0: 2e6c 6c6d 7d22 2c20 226d 6167 656e 7461  .llm}", "magenta
+000068c0: 2229 290d 0a20 2020 2020 2020 2020 2020  "))..           
+000068d0: 2063 7072 696e 7428 6622 5c6e 3e3e 2049   cprint(f"\n>> I
+000068e0: 2068 6176 6520 7365 6e74 2079 6f75 7220   have sent your 
+000068f0: 7265 7175 6573 7420 746f 2074 6865 204c  request to the L
+00006900: 4c4d 2061 6e64 2061 7761 6974 696e 6720  LM and awaiting 
+00006910: 7265 7370 6f6e 7365 2c20 706c 6561 7365  response, please
+00006920: 2077 6169 742e 2e2e 5c6e 222c 2027 6d61   wait...\n", 'ma
+00006930: 6765 6e74 6127 2c20 6174 7472 733d 5b27  genta', attrs=['
+00006940: 626f 6c64 275d 290d 0a0d 0a20 2020 2020  bold'])....     
+00006950: 2020 2023 2043 616c 6c20 7468 6520 4f70     # Call the Op
+00006960: 656e 4149 2041 5049 0d0a 2020 2020 2020  enAI API..      
+00006970: 2020 6c6c 6d5f 7265 7370 6f6e 7365 2c20    llm_response, 
+00006980: 746f 6b65 6e73 5f75 7365 6420 3d20 7365  tokens_used = se
+00006990: 6c66 2e6c 6c6d 5f63 616c 6c28 6d65 7373  lf.llm_call(mess
+000069a0: 6167 6573 290d 0a0d 0a20 2020 2020 2020  ages)....       
+000069b0: 2023 2045 7874 7261 6374 2074 6865 2063   # Extract the c
+000069c0: 6f64 6520 6672 6f6d 2074 6865 2041 5049  ode from the API
+000069d0: 2072 6573 706f 6e73 650d 0a20 2020 2020   response..     
+000069e0: 2020 2063 6f64 6520 3d20 7365 6c66 2e5f     code = self._
+000069f0: 6578 7472 6163 745f 636f 6465 286c 6c6d  extract_code(llm
+00006a00: 5f72 6573 706f 6e73 6529 0d0a 0d0a 2020  _response)....  
+00006a10: 2020 2020 2020 2320 5570 6461 7465 2074        # Update t
+00006a20: 6865 2074 6f74 616c 2074 6f6b 656e 7320  he total tokens 
+00006a30: 7573 6564 0d0a 2020 2020 2020 2020 7365  used..        se
+00006a40: 6c66 2e74 6f74 616c 5f74 6f6b 656e 735f  lf.total_tokens_
+00006a50: 7573 6564 2e61 7070 656e 6428 746f 6b65  used.append(toke
+00006a60: 6e73 5f75 7365 6429 0d0a 0d0a 2020 2020  ns_used)....    
+00006a70: 2020 2020 2320 496e 6974 6961 6c69 7a65      # Initialize
+00006a80: 2065 7272 6f72 2063 6f72 7265 6374 696f   error correctio
+00006a90: 6e20 636f 756e 7465 720d 0a20 2020 2020  n counter..     
+00006aa0: 2020 2065 7272 6f72 5f63 6f72 7265 6374     error_correct
+00006ab0: 696f 6e73 203d 2030 0d0a 0d0a 2020 2020  ions = 0....    
+00006ac0: 2020 2020 2320 4465 6275 6720 636f 6465      # Debug code
+00006ad0: 2069 6620 6465 6275 6720 7061 7261 6d65   if debug parame
+00006ae0: 7465 7220 6973 2073 6574 2074 6f20 5472  ter is set to Tr
+00006af0: 7565 0d0a 2020 2020 2020 2020 6966 2073  ue..        if s
+00006b00: 656c 662e 6465 6275 673a 0d0a 2020 2020  elf.debug:..    
+00006b10: 2020 2020 2020 2020 2320 5377 6974 6368          # Switch
+00006b20: 2074 6f20 6770 742d 3420 6966 206c 6c6d   to gpt-4 if llm
+00006b30: 5f73 7769 7463 6820 7061 7261 6d65 7465  _switch paramete
+00006b40: 7220 6973 2073 6574 2074 6f20 5472 7565  r is set to True
+00006b50: 2e20 5468 6973 2077 696c 6c20 696e 6372  . This will incr
+00006b60: 6561 7365 2074 6865 2070 726f 6365 7373  ease the process
+00006b70: 696e 6720 7469 6d65 2061 6e64 2063 6f73  ing time and cos
+00006b80: 740d 0a20 2020 2020 2020 2020 2020 2069  t..            i
+00006b90: 6620 7365 6c66 2e6c 6c6d 5f73 7769 7463  f self.llm_switc
+00006ba0: 683a 0d0a 2020 2020 2020 2020 2020 2020  h:..            
+00006bb0: 2020 2020 6c6c 6d5f 6361 7363 6164 6520      llm_cascade 
+00006bc0: 3d20 5472 7565 0d0a 2020 2020 2020 2020  = True..        
+00006bd0: 2020 2020 2020 2020 6966 2027 6970 796b          if 'ipyk
+00006be0: 6572 6e65 6c27 2069 6e20 7379 732e 6d6f  ernel' in sys.mo
+00006bf0: 6475 6c65 733a 0d0a 2020 2020 2020 2020  dules:..        
+00006c00: 2020 2020 2020 2020 2020 2020 2320 4a75              # Ju
+00006c10: 7079 7465 7220 6e6f 7465 626f 6f6b 0d0a  pyter notebook..
+00006c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c30: 2020 2020 6469 7370 6c61 7928 4854 4d4c      display(HTML
+00006c40: 2827 3c73 7061 6e20 7374 796c 653d 2263  ('<span style="c
+00006c50: 6f6c 6f72 3a20 6d61 6765 6e74 613b 223e  olor: magenta;">
+00006c60: 5377 6974 6368 696e 6720 6d6f 6465 6c20  Switching model 
+00006c70: 746f 2067 7074 2d34 2074 6f20 6465 6275  to gpt-4 to debu
+00006c80: 6720 7468 6520 636f 6465 2e3c 2f73 7061  g the code.</spa
+00006c90: 6e3e 2729 290d 0a20 2020 2020 2020 2020  n>'))..         
+00006ca0: 2020 2020 2020 2065 6c73 653a 0d0a 2020         else:..  
+00006cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006cc0: 2020 2320 434c 490d 0a20 2020 2020 2020    # CLI..       
+00006cd0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00006ce0: 6e74 2863 6f6c 6f72 6564 2822 5c6e 3e3e  nt(colored("\n>>
+00006cf0: 2053 7769 7463 6869 6e67 206d 6f64 656c   Switching model
+00006d00: 2074 6f20 4750 542d 3420 746f 2064 6562   to GPT-4 to deb
+00006d10: 7567 2074 6865 2063 6f64 652e 222c 2022  ug the code.", "
+00006d20: 6d61 6765 6e74 6122 2929 0d0a 2020 2020  magenta"))..    
+00006d30: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+00006d40: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00006d50: 6c6d 5f63 6173 6361 6465 203d 2046 616c  lm_cascade = Fal
+00006d60: 7365 0d0a 2020 2020 2020 2020 2020 2020  se..            
+00006d70: 636f 6465 203d 2073 656c 662e 6465 6275  code = self.debu
+00006d80: 675f 636f 6465 2863 6f64 652c 2074 6173  g_code(code, tas
+00006d90: 6b2c 206c 6c6d 5f63 6173 6361 6465 3d6c  k, llm_cascade=l
+00006da0: 6c6d 5f63 6173 6361 6465 290d 0a0d 0a20  lm_cascade).... 
+00006db0: 2020 2020 2020 2023 2052 6564 6972 6563         # Redirec
+00006dc0: 7420 7374 616e 6461 7264 206f 7574 7075  t standard outpu
+00006dd0: 7420 746f 2061 2053 7472 696e 6749 4f20  t to a StringIO 
+00006de0: 6275 6666 6572 0d0a 2020 2020 2020 2020  buffer..        
+00006df0: 7769 7468 2072 6564 6972 6563 745f 7374  with redirect_st
+00006e00: 646f 7574 2869 6f2e 5374 7269 6e67 494f  dout(io.StringIO
+00006e10: 2829 2920 6173 206f 7574 7075 743a 0d0a  ()) as output:..
+00006e20: 2020 2020 2020 2020 2020 2020 2320 5472              # Tr
+00006e30: 7920 746f 2065 7865 6375 7465 2074 6865  y to execute the
+00006e40: 2063 6f64 6520 616e 6420 6861 6e64 6c65   code and handle
+00006e50: 2065 7272 6f72 730d 0a20 2020 2020 2020   errors..       
+00006e60: 2020 2020 2077 6869 6c65 2065 7272 6f72       while error
+00006e70: 5f63 6f72 7265 6374 696f 6e73 203c 2073  _corrections < s
+00006e80: 656c 662e 4d41 585f 4552 524f 525f 434f  elf.MAX_ERROR_CO
+00006e90: 5252 4543 5449 4f4e 533a 0d0a 2020 2020  RRECTIONS:..    
+00006ea0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00006eb0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00006ec0: 2020 2020 2020 6d65 7373 6167 6573 2e61        messages.a
+00006ed0: 7070 656e 6428 7b22 726f 6c65 223a 2022  ppend({"role": "
+00006ee0: 6173 7369 7374 616e 7422 2c20 2263 6f6e  assistant", "con
+00006ef0: 7465 6e74 223a 206c 6c6d 5f72 6573 706f  tent": llm_respo
+00006f00: 6e73 657d 290d 0a20 2020 2020 2020 2020  nse})..         
+00006f10: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
+00006f20: 6f76 6520 7468 6520 6f6c 6465 7374 2063  ove the oldest c
+00006f30: 6f6e 7665 7273 6174 696f 6e20 6672 6f6d  onversation from
+00006f40: 2074 6865 206d 6573 7361 6765 7320 6c69   the messages li
+00006f50: 7374 0d0a 2020 2020 2020 2020 2020 2020  st..            
+00006f60: 2020 2020 2020 2020 6966 206c 656e 286d          if len(m
+00006f70: 6573 7361 6765 7329 203e 2073 656c 662e  essages) > self.
+00006f80: 4d41 585f 434f 4e56 4552 5341 5449 4f4e  MAX_CONVERSATION
+00006f90: 533a 0d0a 2020 2020 2020 2020 2020 2020  S:..            
+00006fa0: 2020 2020 2020 2020 2020 2020 6d65 7373              mess
+00006fb0: 6167 6573 2e70 6f70 2831 290d 0a20 2020  ages.pop(1)..   
+00006fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fd0: 2020 2020 206d 6573 7361 6765 732e 706f       messages.po
+00006fe0: 7028 3129 0d0a 2020 2020 2020 2020 2020  p(1)..          
+00006ff0: 2020 2020 2020 2020 2020 2320 5265 7365            # Rese
+00007000: 7420 6466 2074 6f20 7468 6520 6f72 6967  t df to the orig
+00007010: 696e 616c 2073 7461 7465 2062 6566 6f72  inal state befor
+00007020: 6520 6578 6563 7574 696e 6720 7468 6520  e executing the 
+00007030: 636f 6465 0d0a 2020 2020 2020 2020 2020  code..          
+00007040: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00007050: 6620 3d20 7365 6c66 2e6f 7269 6769 6e61  f = self.origina
+00007060: 6c5f 6466 2e63 6f70 7928 290d 0a20 2020  l_df.copy()..   
+00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007080: 2023 2045 7865 6375 7465 2074 6865 2063   # Execute the c
+00007090: 6f64 650d 0a20 2020 2020 2020 2020 2020  ode..           
+000070a0: 2020 2020 2020 2020 2069 6620 636f 6465           if code
+000070b0: 2069 7320 6e6f 7420 4e6f 6e65 3a0d 0a20   is not None:.. 
+000070c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000070d0: 2020 2020 2020 2065 7865 6328 636f 6465         exec(code
+000070e0: 2c20 7b27 6466 273a 2073 656c 662e 6466  , {'df': self.df
+000070f0: 7d29 0d0a 2020 2020 2020 2020 2020 2020  })..            
+00007100: 2020 2020 2020 2020 6272 6561 6b0d 0a20          break.. 
+00007110: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00007120: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00007130: 6173 2065 3a0d 0a20 2020 2020 2020 2020  as e:..         
+00007140: 2020 2020 2020 2020 2020 2023 2050 7269             # Pri
+00007150: 6e74 2074 6865 2065 7272 6f72 206d 6573  nt the error mes
+00007160: 7361 6765 0d0a 2020 2020 2020 2020 2020  sage..          
+00007170: 2020 2020 2020 2020 2020 6966 2027 6970            if 'ip
+00007180: 796b 6572 6e65 6c27 2069 6e20 7379 732e  ykernel' in sys.
+00007190: 6d6f 6475 6c65 733a 0d0a 2020 2020 2020  modules:..      
+000071a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000071b0: 2020 2320 4a75 7079 7465 7220 6e6f 7465    # Jupyter note
+000071c0: 626f 6f6b 0d0a 2020 2020 2020 2020 2020  book..          
+000071d0: 2020 2020 2020 2020 2020 2020 2020 6469                di
+000071e0: 7370 6c61 7928 4854 4d4c 2866 273c 6272  splay(HTML(f'<br
+000071f0: 3e3c 623e 3c73 7061 6e20 7374 796c 653d  ><b><span style=
+00007200: 2263 6f6c 6f72 3a20 2364 3836 6330 303b  "color: #d86c00;
+00007210: 223e 4920 7261 6e20 696e 746f 2061 6e20  ">I ran into an 
+00007220: 6973 7375 653a 3c2f 7370 616e 3e3c 2f62  issue:</span></b
+00007230: 3e3c 6272 3e3c 7072 6520 7374 796c 653d  ><br><pre style=
+00007240: 2263 6f6c 6f72 3a20 2364 3836 6330 303b  "color: #d86c00;
+00007250: 223e 7b65 7d3c 2f70 7265 3e3c 6272 3e3c  ">{e}</pre><br><
+00007260: 623e 3c73 7061 6e20 7374 796c 653d 2263  b><span style="c
+00007270: 6f6c 6f72 3a20 2364 3836 6330 303b 223e  olor: #d86c00;">
+00007280: 4920 7769 6c6c 2065 7861 6d69 6e65 2069  I will examine i
+00007290: 742c 2061 6e64 2074 7279 2061 6761 696e  t, and try again
+000072a0: 2077 6974 6820 616e 2061 646a 7573 7465   with an adjuste
+000072b0: 6420 636f 6465 2e3c 2f73 7061 6e3e 3c2f  d code.</span></
+000072c0: 623e 3c62 723e 2729 290d 0a20 2020 2020  b><br>'))..     
+000072d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000072e0: 6c73 653a 0d0a 2020 2020 2020 2020 2020  lse:..          
+000072f0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00007300: 434c 490d 0a20 2020 2020 2020 2020 2020  CLI..           
+00007310: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+00007320: 2e73 7464 6572 722e 7772 6974 6528 275c  .stderr.write('\
+00007330: 3033 335b 3331 6d27 202b 2066 273e 3e20  033[31m' + f'>> 
+00007340: 4920 7261 6e20 696e 746f 2061 6e20 6973  I ran into an is
+00007350: 7375 653a 207b 657d 2e20 5c6e 3e3e 2049  sue: {e}. \n>> I
+00007360: 2077 696c 6c20 6578 616d 696e 6520 6974   will examine it
+00007370: 2c20 616e 6420 7472 7920 6167 6169 6e20  , and try again 
+00007380: 7769 7468 2061 6e20 6164 6a75 7374 6564  with an adjusted
+00007390: 2063 6f64 652e 2720 2b20 275c 3033 335b   code.' + '\033[
+000073a0: 306d 2720 2b20 275c 6e27 290d 0a20 2020  0m' + '\n')..   
+000073b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073c0: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+000073d0: 666c 7573 6828 290d 0a0d 0a20 2020 2020  flush()....     
+000073e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000073f0: 2049 6e63 7265 6d65 6e74 2074 6865 2065   Increment the e
+00007400: 7272 6f72 2063 6f72 7265 6374 696f 6e20  rror correction 
+00007410: 636f 756e 7465 7220 616e 6420 7570 6461  counter and upda
+00007420: 7465 2074 6865 206d 6573 7361 6765 7320  te the messages 
+00007430: 6c69 7374 2077 6974 6820 7468 6520 6572  list with the er
+00007440: 726f 720d 0a20 2020 2020 2020 2020 2020  ror..           
+00007450: 2020 2020 2020 2020 2065 7272 6f72 5f63           error_c
+00007460: 6f72 7265 6374 696f 6e73 202b 3d20 310d  orrections += 1.
+00007470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007480: 2020 2020 206d 6573 7361 6765 732e 6170       messages.ap
+00007490: 7065 6e64 287b 2272 6f6c 6522 3a20 2275  pend({"role": "u
+000074a0: 7365 7222 2c20 2263 6f6e 7465 6e74 223a  ser", "content":
+000074b0: 2073 656c 662e 6572 726f 725f 636f 7272   self.error_corr
+000074c0: 6563 745f 7461 736b 2e66 6f72 6d61 7428  ect_task.format(
+000074d0: 6529 7d29 0d0a 0d0a 2020 2020 2020 2020  e)})....        
+000074e0: 2020 2020 2020 2020 2020 2020 2320 5377              # Sw
+000074f0: 6974 6368 2074 6f20 6770 742d 3420 6966  itch to gpt-4 if
+00007500: 206c 6c6d 5f73 7769 7463 6820 7061 7261   llm_switch para
+00007510: 6d65 7465 7220 6973 2073 6574 2074 6f20  meter is set to 
+00007520: 5472 7565 2e20 5468 6973 2077 696c 6c20  True. This will 
+00007530: 696e 6372 6561 7365 2074 6865 2070 726f  increase the pro
+00007540: 6365 7373 696e 6720 7469 6d65 2061 6e64  cessing time and
+00007550: 2063 6f73 742e 0d0a 2020 2020 2020 2020   cost...        
+00007560: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00007570: 656c 662e 6c6c 6d5f 7377 6974 6368 3a0d  elf.llm_switch:.
+00007580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007590: 2020 2020 2020 2020 206c 6c6d 5f63 6173           llm_cas
+000075a0: 6361 6465 203d 2054 7275 650d 0a20 2020  cade = True..   
+000075b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075c0: 2020 2020 2069 6620 2769 7079 6b65 726e       if 'ipykern
+000075d0: 656c 2720 696e 2073 7973 2e6d 6f64 756c  el' in sys.modul
+000075e0: 6573 3a0d 0a20 2020 2020 2020 2020 2020  es:..           
+000075f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007600: 2023 204a 7570 7974 6572 206e 6f74 6562   # Jupyter noteb
+00007610: 6f6f 6b0d 0a20 2020 2020 2020 2020 2020  ook..           
+00007620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007630: 2064 6973 706c 6179 2848 544d 4c28 273c   display(HTML('<
+00007640: 7370 616e 2073 7479 6c65 3d22 636f 6c6f  span style="colo
+00007650: 723a 2023 6438 3663 3030 3b22 3e53 7769  r: #d86c00;">Swi
+00007660: 7463 6869 6e67 206d 6f64 656c 2074 6f20  tching model to 
+00007670: 6770 742d 3420 746f 2074 7279 2074 6f20  gpt-4 to try to 
+00007680: 696d 7072 6f76 6520 7468 6520 6f75 7463  improve the outc
+00007690: 6f6d 652e 3c2f 7370 616e 3e27 2929 0d0a  ome.</span>'))..
+000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076b0: 2020 2020 2020 2020 656c 7365 3a0d 0a20          else:.. 
+000076c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076d0: 2020 2020 2020 2020 2020 2023 2043 4c49             # CLI
+000076e0: 0d0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000076f0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+00007700: 732e 7374 6465 7272 2e77 7269 7465 2827  s.stderr.write('
+00007710: 5c30 3333 5b33 316d 2720 2b20 6627 3e3e  \033[31m' + f'>>
+00007720: 2053 7769 7463 6869 6e67 206d 6f64 656c   Switching model
+00007730: 2074 6f20 6770 742d 3420 746f 2074 7279   to gpt-4 to try
+00007740: 2074 6f20 696d 7072 6f76 6520 7468 6520   to improve the 
+00007750: 6f75 7463 6f6d 652e 2720 2b20 275c 3033  outcome.' + '\03
+00007760: 335b 306d 2720 2b20 275c 6e27 290d 0a20  3[0m' + '\n').. 
 00007770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007780: 2320 4361 6c6c 204f 7065 6e41 4920 4150  # Call OpenAI AP
-00007790: 4920 746f 2067 6574 2061 6e20 7570 6461  I to get an upda
-000077a0: 7465 6420 636f 6465 0d0a 2020 2020 2020  ted code..      
-000077b0: 2020 2020 2020 2020 2020 2020 2020 6c6c                ll
-000077c0: 6d5f 7265 7370 6f6e 7365 2c20 746f 6b65  m_response, toke
-000077d0: 6e73 5f75 7365 6420 3d20 7365 6c66 2e6c  ns_used = self.l
-000077e0: 6c6d 5f63 616c 6c28 6d65 7373 6167 6573  lm_call(messages
-000077f0: 2c6c 6c6d 5f63 6173 6361 6465 3d6c 6c6d  ,llm_cascade=llm
-00007800: 5f63 6173 6361 6465 290d 0a20 2020 2020  _cascade)..     
-00007810: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00007820: 6f64 6520 3d20 7365 6c66 2e5f 6578 7472  ode = self._extr
-00007830: 6163 745f 636f 6465 286c 6c6d 5f72 6573  act_code(llm_res
-00007840: 706f 6e73 6529 0d0a 2020 2020 2020 2020  ponse)..        
-00007850: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00007860: 2e74 6f74 616c 5f74 6f6b 656e 735f 7573  .total_tokens_us
-00007870: 6564 2e61 7070 656e 6428 746f 6b65 6e73  ed.append(tokens
-00007880: 5f75 7365 6429 0d0a 2020 2020 2020 2020  _used)..        
-00007890: 2020 2020 2020 2020 2020 2020 0d0a 0d0a              ....
-000078a0: 2020 2020 2020 2020 2320 4765 7420 7468          # Get th
-000078b0: 6520 6f75 7470 7574 2066 726f 6d20 7468  e output from th
-000078c0: 6520 6578 6563 7574 6564 2063 6f64 650d  e executed code.
-000078d0: 0a20 2020 2020 2020 2061 6e73 7765 7220  .        answer 
-000078e0: 3d20 6f75 7470 7574 2e67 6574 7661 6c75  = output.getvalu
-000078f0: 6528 290d 0a0d 0a20 2020 2020 2020 2023  e()....        #
-00007900: 2043 616c 6c20 4f70 656e 4149 2041 5049   Call OpenAI API
-00007910: 0d0a 2020 2020 2020 2020 2320 496e 6974  ..        # Init
-00007920: 6961 6c69 7a65 2074 6865 206d 6573 7361  ialize the messa
-00007930: 6765 7320 6c69 7374 2077 6974 6820 6120  ges list with a 
-00007940: 7379 7374 656d 206d 6573 7361 6765 2063  system message c
-00007950: 6f6e 7461 696e 696e 6720 7468 6520 7461  ontaining the ta
-00007960: 736b 2070 726f 6d70 740d 0a20 2020 2020  sk prompt..     
-00007970: 2020 2069 6e73 6967 6874 735f 6d65 7373     insights_mess
-00007980: 6167 6573 203d 205b 7b22 726f 6c65 223a  ages = [{"role":
-00007990: 2022 7573 6572 222c 2022 636f 6e74 656e   "user", "conten
-000079a0: 7422 3a20 7365 6c66 2e73 6f6c 7574 696f  t": self.solutio
-000079b0: 6e5f 696e 7369 6768 7473 2e66 6f72 6d61  n_insights.forma
-000079c0: 7428 7175 6573 7469 6f6e 2c20 616e 7377  t(question, answ
-000079d0: 6572 297d 5d0d 0a20 2020 2020 2020 2066  er)}]..        f
-000079e0: 756e 6374 696f 6e5f 6e61 6d65 203d 207b  unction_name = {
-000079f0: 226e 616d 6522 3a20 2253 6f6c 7574 696f  "name": "Solutio
-00007a00: 6e5f 496e 7369 6768 7473 227d 0d0a 2020  n_Insights"}..  
-00007a10: 2020 2020 2020 666e 5f6e 616d 652c 2061        fn_name, a
-00007a20: 7267 756d 656e 7473 2c20 746f 6b65 6e73  rguments, tokens
-00007a30: 5f75 7365 6420 3d20 7365 6c66 2e6c 6c6d  _used = self.llm
-00007a40: 5f66 756e 635f 6361 6c6c 2869 6e73 6967  _func_call(insig
-00007a50: 6874 735f 6d65 7373 6167 6573 2c20 7365  hts_messages, se
-00007a60: 6c66 2e69 6e73 6967 6874 735f 6675 6e63  lf.insights_func
-00007a70: 7469 6f6e 2c20 6675 6e63 7469 6f6e 5f6e  tion, function_n
-00007a80: 616d 6529 0d0a 0d0a 2020 2020 2020 2020  ame)....        
-00007a90: 2320 5061 7273 6520 7468 6520 4a53 4f4e  # Parse the JSON
-00007aa0: 2073 7472 696e 6720 746f 2061 2050 7974   string to a Pyt
-00007ab0: 686f 6e20 6469 6374 0d0a 2020 2020 2020  hon dict..      
-00007ac0: 2020 6172 6775 6d65 6e74 735f 6469 6374    arguments_dict
-00007ad0: 203d 206a 736f 6e2e 6c6f 6164 7328 6172   = json.loads(ar
-00007ae0: 6775 6d65 6e74 732c 7374 7269 6374 3d46  guments,strict=F
-00007af0: 616c 7365 290d 0a0d 0a20 2020 2020 2020  alse)....       
-00007b00: 2023 2052 6574 7269 6576 6520 7661 6c75   # Retrieve valu
-00007b10: 6573 0d0a 2020 2020 2020 2020 616e 7377  es..        answ
-00007b20: 6572 203d 2061 7267 756d 656e 7473 5f64  er = arguments_d
-00007b30: 6963 745b 2269 6e73 6967 6874 225d 0d0a  ict["insight"]..
-00007b40: 0d0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
-00007b50: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-00007b60: 2e61 7070 656e 6428 746f 6b65 6e73 5f75  .append(tokens_u
-00007b70: 7365 6429 0d0a 2020 2020 2020 2020 746f  sed)..        to
-00007b80: 7461 6c5f 746f 6b65 6e73 5f75 7365 645f  tal_tokens_used_
-00007b90: 7375 6d20 3d20 7375 6d28 7365 6c66 2e74  sum = sum(self.t
-00007ba0: 6f74 616c 5f74 6f6b 656e 735f 7573 6564  otal_tokens_used
-00007bb0: 290d 0a0d 0a20 2020 2020 2020 2023 2052  )....        # R
-00007bc0: 6573 6574 2074 6865 2053 7472 696e 6749  eset the StringI
-00007bd0: 4f20 6275 6666 6572 0d0a 2020 2020 2020  O buffer..      
-00007be0: 2020 6f75 7470 7574 2e74 7275 6e63 6174    output.truncat
-00007bf0: 6528 3029 0d0a 2020 2020 2020 2020 6f75  e(0)..        ou
-00007c00: 7470 7574 2e73 6565 6b28 3029 0d0a 0d0a  tput.seek(0)....
-00007c10: 2020 2020 2020 2020 7265 7475 726e 2061          return a
-00007c20: 6e73 7765 722c 2063 6f64 652c 2074 6f74  nswer, code, tot
-00007c30: 616c 5f74 6f6b 656e 735f 7573 6564 5f73  al_tokens_used_s
-00007c40: 756d 0d0a 2020 2020                      um..    
+00007780: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+00007790: 7464 6572 722e 666c 7573 6828 290d 0a20  tderr.flush().. 
+000077a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077b0: 2020 2065 6c73 653a 0d0a 2020 2020 2020     else:..      
+000077c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077d0: 2020 6c6c 6d5f 6361 7363 6164 6520 3d20    llm_cascade = 
+000077e0: 4661 6c73 650d 0a0d 0a20 2020 2020 2020  False....       
+000077f0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+00007800: 616c 6c20 4f70 656e 4149 2041 5049 2074  all OpenAI API t
+00007810: 6f20 6765 7420 616e 2075 7064 6174 6564  o get an updated
+00007820: 2063 6f64 650d 0a20 2020 2020 2020 2020   code..         
+00007830: 2020 2020 2020 2020 2020 206c 6c6d 5f72             llm_r
+00007840: 6573 706f 6e73 652c 2074 6f6b 656e 735f  esponse, tokens_
+00007850: 7573 6564 203d 2073 656c 662e 6c6c 6d5f  used = self.llm_
+00007860: 6361 6c6c 286d 6573 7361 6765 732c 6c6c  call(messages,ll
+00007870: 6d5f 6361 7363 6164 653d 6c6c 6d5f 6361  m_cascade=llm_ca
+00007880: 7363 6164 6529 0d0a 2020 2020 2020 2020  scade)..        
+00007890: 2020 2020 2020 2020 2020 2020 636f 6465              code
+000078a0: 203d 2073 656c 662e 5f65 7874 7261 6374   = self._extract
+000078b0: 5f63 6f64 6528 6c6c 6d5f 7265 7370 6f6e  _code(llm_respon
+000078c0: 7365 290d 0a20 2020 2020 2020 2020 2020  se)..           
+000078d0: 2020 2020 2020 2020 2073 656c 662e 746f           self.to
+000078e0: 7461 6c5f 746f 6b65 6e73 5f75 7365 642e  tal_tokens_used.
+000078f0: 6170 7065 6e64 2874 6f6b 656e 735f 7573  append(tokens_us
+00007900: 6564 290d 0a20 2020 2020 2020 2020 2020  ed)..           
+00007910: 2020 2020 2020 2020 200d 0a0d 0a20 2020           ....   
+00007920: 2020 2020 2023 2047 6574 2074 6865 206f       # Get the o
+00007930: 7574 7075 7420 6672 6f6d 2074 6865 2065  utput from the e
+00007940: 7865 6375 7465 6420 636f 6465 0d0a 2020  xecuted code..  
+00007950: 2020 2020 2020 616e 7377 6572 203d 206f        answer = o
+00007960: 7574 7075 742e 6765 7476 616c 7565 2829  utput.getvalue()
+00007970: 0d0a 0d0a 2020 2020 2020 2020 2320 4361  ....        # Ca
+00007980: 6c6c 204f 7065 6e41 4920 4150 490d 0a20  ll OpenAI API.. 
+00007990: 2020 2020 2020 2023 2049 6e69 7469 616c         # Initial
+000079a0: 697a 6520 7468 6520 6d65 7373 6167 6573  ize the messages
+000079b0: 206c 6973 7420 7769 7468 2061 2073 7973   list with a sys
+000079c0: 7465 6d20 6d65 7373 6167 6520 636f 6e74  tem message cont
+000079d0: 6169 6e69 6e67 2074 6865 2074 6173 6b20  aining the task 
+000079e0: 7072 6f6d 7074 0d0a 2020 2020 2020 2020  prompt..        
+000079f0: 696e 7369 6768 7473 5f6d 6573 7361 6765  insights_message
+00007a00: 7320 3d20 5b7b 2272 6f6c 6522 3a20 2275  s = [{"role": "u
+00007a10: 7365 7222 2c20 2263 6f6e 7465 6e74 223a  ser", "content":
+00007a20: 2073 656c 662e 736f 6c75 7469 6f6e 5f69   self.solution_i
+00007a30: 6e73 6967 6874 732e 666f 726d 6174 2874  nsights.format(t
+00007a40: 6173 6b2c 2061 6e73 7765 7229 7d5d 0d0a  ask, answer)}]..
+00007a50: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
+00007a60: 5f6e 616d 6520 3d20 7b22 6e61 6d65 223a  _name = {"name":
+00007a70: 2022 536f 6c75 7469 6f6e 5f49 6e73 6967   "Solution_Insig
+00007a80: 6874 7322 7d0d 0a20 2020 2020 2020 2066  hts"}..        f
+00007a90: 6e5f 6e61 6d65 2c20 6172 6775 6d65 6e74  n_name, argument
+00007aa0: 732c 2074 6f6b 656e 735f 7573 6564 203d  s, tokens_used =
+00007ab0: 2073 656c 662e 6c6c 6d5f 6675 6e63 5f63   self.llm_func_c
+00007ac0: 616c 6c28 696e 7369 6768 7473 5f6d 6573  all(insights_mes
+00007ad0: 7361 6765 732c 2073 656c 662e 696e 7369  sages, self.insi
+00007ae0: 6768 7473 5f66 756e 6374 696f 6e2c 2066  ghts_function, f
+00007af0: 756e 6374 696f 6e5f 6e61 6d65 290d 0a0d  unction_name)...
+00007b00: 0a20 2020 2020 2020 2023 2050 6172 7365  .        # Parse
+00007b10: 2074 6865 204a 534f 4e20 7374 7269 6e67   the JSON string
+00007b20: 2074 6f20 6120 5079 7468 6f6e 2064 6963   to a Python dic
+00007b30: 740d 0a20 2020 2020 2020 2061 7267 756d  t..        argum
+00007b40: 656e 7473 5f64 6963 7420 3d20 6a73 6f6e  ents_dict = json
+00007b50: 2e6c 6f61 6473 2861 7267 756d 656e 7473  .loads(arguments
+00007b60: 2c73 7472 6963 743d 4661 6c73 6529 0d0a  ,strict=False)..
+00007b70: 0d0a 2020 2020 2020 2020 2320 5265 7472  ..        # Retr
+00007b80: 6965 7665 2076 616c 7565 730d 0a20 2020  ieve values..   
+00007b90: 2020 2020 2061 6e73 7765 7220 3d20 6172       answer = ar
+00007ba0: 6775 6d65 6e74 735f 6469 6374 5b22 696e  guments_dict["in
+00007bb0: 7369 6768 7422 5d0d 0a0d 0a20 2020 2020  sight"]....     
+00007bc0: 2020 2073 656c 662e 746f 7461 6c5f 746f     self.total_to
+00007bd0: 6b65 6e73 5f75 7365 642e 6170 7065 6e64  kens_used.append
+00007be0: 2874 6f6b 656e 735f 7573 6564 290d 0a20  (tokens_used).. 
+00007bf0: 2020 2020 2020 2074 6f74 616c 5f74 6f6b         total_tok
+00007c00: 656e 735f 7573 6564 5f73 756d 203d 2073  ens_used_sum = s
+00007c10: 756d 2873 656c 662e 746f 7461 6c5f 746f  um(self.total_to
+00007c20: 6b65 6e73 5f75 7365 6429 0d0a 0d0a 2020  kens_used)....  
+00007c30: 2020 2020 2020 2320 5265 7365 7420 7468        # Reset th
+00007c40: 6520 5374 7269 6e67 494f 2062 7566 6665  e StringIO buffe
+00007c50: 720d 0a20 2020 2020 2020 206f 7574 7075  r..        outpu
+00007c60: 742e 7472 756e 6361 7465 2830 290d 0a20  t.truncate(0).. 
+00007c70: 2020 2020 2020 206f 7574 7075 742e 7365         output.se
+00007c80: 656b 2830 290d 0a0d 0a20 2020 2020 2020  ek(0)....       
+00007c90: 2072 6574 7572 6e20 616e 7377 6572 2c20   return answer, 
+00007ca0: 636f 6465 2c20 746f 7461 6c5f 746f 6b65  code, total_toke
+00007cb0: 6e73 5f75 7365 645f 7375 6d0d 0a20 2020  ns_used_sum..   
+00007cc0: 20
```

### Comparing `bambooai-0.3.7/bambooai/func_calls.py` & `bambooai-0.3.8/bambooai/func_calls.py`

 * *Files identical despite different names*

### Comparing `bambooai-0.3.7/bambooai/prompts.py` & `bambooai-0.3.8/bambooai/prompts.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,22 +1,23 @@
 # prompts.py
 
+# Default Example (Otherwise Pinecone Long Term Memory)
 example_output = """
     import pandas as pd
 
     # Identify the dataframe `df`
     # df has already been defined and populated with the required data
 
     # Call the `describe()` method on `df`
     df_description = df.describe()
 
     # Print the output of the `describe()` method
     print(df_description)
     """
-
+# Chain of Thought
 task_evaluation = """
     You are an AI data analyst and your job is to assist the user with data analisys.
     The user asked the following question: '{}'.
 
     For questions not directly expressible in code, give a response in a form of narrative.
 
     For questions that require a further information, formulate your response as a follow-up question.
@@ -24,105 +25,107 @@
     For questions that do not require further information and can be directly solved with code, formulate your response as an algorithm that breaks the solution into steps. 
     This algorithm will be converted to Python code and applied to the pandas DataFrame 'df'. Here's the first row of 'df': {}.
     The DataFrame 'df' is already populated with necessary data.
     Present your algorithm in up to eight simple, clear English steps. If fewer steps suffice, that's acceptable. Remember to explain steps rather than write code.
 
     Finally, output your response using the QA_Response function.
     """
-
+# Zero Shot Prompt
 system_task = """
     You are an AI data analyst and your job is to assist user with analysing data in the pandas dataframe.
     The user will provide a dataframe named `df`, and a list of tasks to be accomplished using Python.
     The dataframe df has already been defined and populated with the required data.
     """
-
+# One Shot Prompt
 user_task = """
     You have been presented with a pandas dataframe named `df`.
     The dataframe df has already been defined and populated with the required data.
     The result of `print(df.head(1))` is:
     {}.
     Return the python code that acomplishes the following tasks: {}.
-    Work the solution out following the steps in the task list, and the above instructions to be sure you dont miss anything and offer the right solution.
-    Always include the import statements at the top of the code, and comments and print statement where necessary.
+    Approach each task from the list in isolation, advancing to the next only upon its successful resolution. 
+    Strictly adhere to the prescribed instructions to avoid oversights and ensure an accurate solution.
+    Always include the import statements at the top of the code.
+    Always include print statements to output the results of your code.
     Prefix the python code with <code> and suffix the code with </code>.
 
     Example Output:
     <code>
     {}
     </code>
     """
-
+# Reflection
 error_correct_task = """
     The execution of the code that you provided in the previous step resulted in an error.
     The error message is: {}
     Return a corrected python code that fixes the error.
     Always include the import statements at the top of the code, and comments and print statement where necessary.
     """
-
+# Reflection
 debug_code_task = """
-    Your job as an AI QA engineer is to inspect the given code and make sure that it meets its objective.
+    Your job as an AI QA engineer involves correcting and refactoring of the given Code so it deliveres the outcome as describe in the given Task list.
+
     Code:
     {}.
-    Objective:
+    Task list:
     {}.
-    The dataframe df has already been defined and populated with the required data. 
 
-    Your task involves scrutinizing the code on a line-by-line basis, 
-    verifying its safety for execution and ensuring that it does not contain any elements that could potentially harm the system or the data. 
-    The code should properly include all numerical data, additional values, and formulas - complete with the correct operators - as specified in the objective. 
-    It is important to verify the accurate implementation of these formulas and their expected performance. 
-    Rigorously inspect each line of the code, refining it for optimal accuracy and efficiency with respect to its intended purpose. 
-    After necessary modifications, provide the final, updated code. Do not use <code></code> from "Example Output:" below.
+    Please follow the below instructions to acoomplish your assingment.The dataframe df has already been defined and populated with the required data.
+
+    Task Inspection:
+    Go through the task list and the given Python code side by side.
+    Ensure that each task in the list is accurately addressed by a corresponding section of code. Do not move on to the next task until the current one is completely solved and its implementation in the code is confirmed.
+
+    Code Sectioning and Commenting:
+    Based on the task list, divide the Python code into sections. Each task from the list should correspond to a distinct section of code.
+    At the beginning of each section, insert a comment or header that clearly identifies the task that section of code addresses. This could look like "# Task 1: Identify the dataframe df for example."
+    Ensure that the code within each section correctly and efficiently completes the task described in the comment or header for that section.
+
+    After necessary modifications, provide the final, updated code.
     Prefix the code with <code> and suffix the code with </code>.
 
     Example Input
     Task List:
     1. Identify the dataframe `df`.
     2. Call the `describe()` method on `df`.
     3. Print the output of the `describe()` method.
 
     Code: 
-    # Identify the dataframe `df`
-    # df has already been defined and populated with the required data
-
-    # Call the `describe()` method on `df`
     df_description = df.describe()
-
-    # Print the output of the `describe()` method
-    print(df_description)
+    df_description
 
     Example Output:
     <code>
     import pandas as pd
 
-    # Identify the dataframe `df`
+    # Task 1: Identify the dataframe `df`
     # df has already been defined and populated with the required data
 
-    # Call the `describe()` method on `df`
+    # Task 2: Call the `describe()` method on `df`
     df_description = df.describe()
 
-    # Print the output of the `describe()` method
+    # Task 3: Print the output of the `describe()` method
     print(df_description)
     </code>
-    """
-
+ """
+# Reflection
 rank_answer = """
     As an AI QA Engineer, your role is to evaluate and grade the code: {}, supplied by the AI Data Analyst. You should rank it on a scale of 1 to 10.
 
     In your evaluation, consider factors such as the relevancy and accuracy of the solution in relation to the original assignment: {},
     presence of any errors or bugs, appropriateness of the inclusion of all given values, clarity of the code, and the completeness and format of each output.
 
     For most cases, your ranks should fall within the range of 5 to 7. Only exceptionally well-crafted codes that deliver exactly as per the desired outcome should score higher. 
 
     Please enclose your ranking in <rank></rank> tags.
 
     Example Output:
     <rank>6</rank>
     """
-
+#Zero Shot Prompt
 solution_insights = """
     You have been presented with the following task: {}, and asked to design a solution for it.
     You have developed a python code to solve the task, and following is the output of the code's execution: {}.
     Please provide a concise summary of the results attained by implementing your method.  
     Present this information in the most clear and comprehensible manner.
     Be certain to incorporate all relevant computations and outcomes.
     """
```

### Comparing `bambooai-0.3.7/bambooai/qa_retrieval.py` & `bambooai-0.3.8/bambooai/qa_retrieval.py`

 * *Files identical despite different names*

### Comparing `bambooai-0.3.7/bambooai.egg-info/PKG-INFO` & `bambooai-0.3.8/bambooai.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: bambooai
-Version: 0.3.7
+Version: 0.3.8
 Summary: A lightweight library for working with pandas dataframes using natural language queries
 Home-page: UNKNOWN
 Author: Palo Galko
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Development Status :: 3 - Alpha
 Classifier: License :: OSI Approved :: MIT License
```

### Comparing `bambooai-0.3.7/setup.py` & `bambooai-0.3.8/setup.py`

 * *Files 14% similar despite different names*

```diff
@@ -2,15 +2,15 @@
 import os
 
 with open("README.md", "r") as fh:
     long_description = fh.read()
 
 setup(
     name='bambooai',
-    version='0.3.7',
+    version='0.3.8',
     description='A lightweight library for working with pandas dataframes using natural language queries',
     long_description=long_description,
     long_description_content_type="text/markdown",
     author='Palo Galko',
     packages=find_packages(),
     install_requires=[
         'openai',
```

