# Comparing `tmp/skypilot-0.3.1.tar.gz` & `tmp/skypilot-0.3.2.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "/Users/zongheng/Dropbox/workspace/riselab/sky-computing/dist/.tmp-5lp6ozo5/skypilot-0.3.1.tar", last modified: Sun Jun  4 16:54:31 2023, max compression
+gzip compressed data, was "skypilot-0.3.2.tar", last modified: Sat Jul  1 04:53:18 2023, max compression
```

## Comparing `skypilot-0.3.1.tar` & `skypilot-0.3.2.tar`

### file list

```diff
@@ -1,192 +1,217 @@
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/
--rw-r--r--   0 zongheng   (502) staff       (20)    12170 2022-04-03 15:38:40.000000 skypilot-0.3.1/LICENSE
--rw-r--r--   0 zongheng   (502) staff       (20)      473 2023-06-04 15:57:24.000000 skypilot-0.3.1/MANIFEST.in
--rw-r--r--   0 zongheng   (502) staff       (20)     8102 2023-06-04 16:54:31.000000 skypilot-0.3.1/PKG-INFO
--rw-r--r--   0 zongheng   (502) staff       (20)     7186 2023-06-04 15:57:24.000000 skypilot-0.3.1/README.md
--rw-r--r--   0 zongheng   (502) staff       (20)      519 2023-05-28 16:43:06.000000 skypilot-0.3.1/pyproject.toml
--rw-r--r--   0 zongheng   (502) staff       (20)       38 2023-06-04 16:54:31.000000 skypilot-0.3.1/setup.cfg
--rw-r--r--   0 zongheng   (502) staff       (20)     7354 2023-06-04 15:57:24.000000 skypilot-0.3.1/setup.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/
--rw-r--r--   0 zongheng   (502) staff       (20)     2044 2023-06-04 16:54:02.000000 skypilot-0.3.1/sky/__init__.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/adaptors/
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/adaptors/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2607 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/adaptors/aws.py
--rw-r--r--   0 zongheng   (502) staff       (20)      989 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/adaptors/azure.py
--rw-r--r--   0 zongheng   (502) staff       (20)     7726 2023-06-04 15:58:27.000000 skypilot-0.3.1/sky/adaptors/cloudflare.py
--rw-r--r--   0 zongheng   (502) staff       (20)      852 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/adaptors/docker.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2194 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/adaptors/gcp.py
--rw-r--r--   0 zongheng   (502) staff       (20)     3052 2023-06-01 22:29:03.000000 skypilot-0.3.1/sky/adaptors/ibm.py
--rw-r--r--   0 zongheng   (502) staff       (20)    15703 2023-06-04 15:57:23.000000 skypilot-0.3.1/sky/authentication.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/backends/
--rw-r--r--   0 zongheng   (502) staff       (20)      414 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/backends/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     5542 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/backends/backend.py
--rw-r--r--   0 zongheng   (502) staff       (20)   114176 2023-06-04 15:57:37.000000 skypilot-0.3.1/sky/backends/backend_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)   183549 2023-06-04 15:57:37.000000 skypilot-0.3.1/sky/backends/cloud_vm_ray_backend.py
--rw-r--r--   0 zongheng   (502) staff       (20)     8321 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/backends/docker_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)    16267 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/backends/local_docker_backend.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/backends/monkey_patches/
--rw-r--r--   0 zongheng   (502) staff       (20)     3410 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-r--r--   0 zongheng   (502) staff       (20)    24422 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/backends/onprem_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     5903 2023-01-09 22:00:08.000000 skypilot-0.3.1/sky/backends/wheel_utils.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/benchmark/
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2022-11-22 22:28:46.000000 skypilot-0.3.1/sky/benchmark/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     8723 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/benchmark/benchmark_state.py
--rw-r--r--   0 zongheng   (502) staff       (20)    24632 2023-04-19 13:26:02.000000 skypilot-0.3.1/sky/benchmark/benchmark_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     3571 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/check.py
--rw-r--r--   0 zongheng   (502) staff       (20)   161418 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/cli.py
--rw-r--r--   0 zongheng   (502) staff       (20)     8592 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/cloud_stores.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/clouds/
--rw-r--r--   0 zongheng   (502) staff       (20)      617 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/clouds/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    31552 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/clouds/aws.py
--rw-r--r--   0 zongheng   (502) staff       (20)    20568 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/azure.py
--rw-r--r--   0 zongheng   (502) staff       (20)    18690 2023-06-01 22:22:35.000000 skypilot-0.3.1/sky/clouds/cloud.py
--rw-r--r--   0 zongheng   (502) staff       (20)    31469 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/clouds/gcp.py
--rw-r--r--   0 zongheng   (502) staff       (20)    18104 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/ibm.py
--rw-r--r--   0 zongheng   (502) staff       (20)    10604 2023-06-01 22:22:35.000000 skypilot-0.3.1/sky/clouds/lambda_cloud.py
--rw-r--r--   0 zongheng   (502) staff       (20)     8062 2023-06-01 22:22:35.000000 skypilot-0.3.1/sky/clouds/local.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/clouds/service_catalog/
--rw-r--r--   0 zongheng   (502) staff       (20)    13177 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/clouds/service_catalog/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    10773 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/service_catalog/aws_catalog.py
--rw-r--r--   0 zongheng   (502) staff       (20)     6705 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/service_catalog/azure_catalog.py
--rw-r--r--   0 zongheng   (502) staff       (20)    22851 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/service_catalog/common.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1500 2023-04-19 13:26:02.000000 skypilot-0.3.1/sky/clouds/service_catalog/config.py
--rw-r--r--   0 zongheng   (502) staff       (20)      282 2023-06-02 16:01:04.000000 skypilot-0.3.1/sky/clouds/service_catalog/constants.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    20092 2023-06-01 22:22:35.000000 skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-r--r--   0 zongheng   (502) staff       (20)     8421 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-r--r--   0 zongheng   (502) staff       (20)    17799 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4198 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-r--r--   0 zongheng   (502) staff       (20)    19389 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/clouds/service_catalog/gcp_catalog.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4656 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/service_catalog/ibm_catalog.py
--rw-r--r--   0 zongheng   (502) staff       (20)     5414 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/clouds/service_catalog/lambda_catalog.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2281 2022-12-10 11:50:57.000000 skypilot-0.3.1/sky/config.py
--rw-r--r--   0 zongheng   (502) staff       (20)    39673 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/core.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2477 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/dag.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/data/
--rw-r--r--   0 zongheng   (502) staff       (20)      128 2023-01-09 22:00:08.000000 skypilot-0.3.1/sky/data/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     7273 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/data/data_transfer.py
--rw-r--r--   0 zongheng   (502) staff       (20)     7918 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/data/data_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     3251 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/data/mounting_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)    89078 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/data/storage.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1082 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/data/storage_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     6031 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/exceptions.py
--rw-r--r--   0 zongheng   (502) staff       (20)    37047 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/execution.py
--rw-r--r--   0 zongheng   (502) staff       (20)    27126 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/global_user_state.py
--rw-r--r--   0 zongheng   (502) staff       (20)    44909 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/optimizer.py
--rw-r--r--   0 zongheng   (502) staff       (20)    41104 2023-06-01 22:29:03.000000 skypilot-0.3.1/sky/resources.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/setup_files/
--rw-r--r--   0 zongheng   (502) staff       (20)      473 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/setup_files/MANIFEST.in
--rw-r--r--   0 zongheng   (502) staff       (20)     7354 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/setup_files/setup.py
--rw-r--r--   0 zongheng   (502) staff       (20)     3216 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/sky_logging.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/
--rw-r--r--   0 zongheng   (502) staff       (20)    12568 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/LICENSE
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/skylet/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4378 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/skylet/autostop_lib.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2118 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/skylet/configs.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1173 2023-06-04 15:57:37.000000 skypilot-0.3.1/sky/skylet/constants.py
--rw-r--r--   0 zongheng   (502) staff       (20)     9309 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/skylet/events.py
--rw-r--r--   0 zongheng   (502) staff       (20)    28338 2023-06-04 15:57:37.000000 skypilot-0.3.1/sky/skylet/job_lib.py
--rw-r--r--   0 zongheng   (502) staff       (20)    17792 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/skylet/log_lib.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/aws/
--rw-r--r--   0 zongheng   (502) staff       (20)      110 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/skylet/providers/aws/__init__.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/aws/cloudwatch/
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/skylet/providers/aws/cloudwatch/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    32698 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py
--rw-r--r--   0 zongheng   (502) staff       (20)    52192 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/aws/config.py
--rw-r--r--   0 zongheng   (502) staff       (20)    29406 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/aws/node_provider.py
--rw-r--r--   0 zongheng   (502) staff       (20)     5917 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/skylet/providers/aws/utils.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/azure/
--rw-r--r--   0 zongheng   (502) staff       (20)       97 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/skylet/providers/azure/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4344 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/azure/azure-config-template.json
--rw-r--r--   0 zongheng   (502) staff       (20)    10633 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/azure/azure-vm-template.json
--rw-r--r--   0 zongheng   (502) staff       (20)     5756 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/azure/config.py
--rw-r--r--   0 zongheng   (502) staff       (20)    17469 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/providers/azure/node_provider.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/gcp/
--rw-r--r--   0 zongheng   (502) staff       (20)       91 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/skylet/providers/gcp/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    31015 2023-04-19 03:21:35.000000 skypilot-0.3.1/sky/skylet/providers/gcp/config.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2738 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/skylet/providers/gcp/constants.py
--rw-r--r--   0 zongheng   (502) staff       (20)    26192 2023-04-18 01:28:59.000000 skypilot-0.3.1/sky/skylet/providers/gcp/node.py
--rw-r--r--   0 zongheng   (502) staff       (20)    14276 2023-05-14 16:35:23.000000 skypilot-0.3.1/sky/skylet/providers/gcp/node_provider.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/ibm/
--rw-r--r--   0 zongheng   (502) staff       (20)       94 2023-06-01 22:29:03.000000 skypilot-0.3.1/sky/skylet/providers/ibm/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    38280 2023-06-01 22:29:03.000000 skypilot-0.3.1/sky/skylet/providers/ibm/node_provider.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1290 2023-06-01 22:29:03.000000 skypilot-0.3.1/sky/skylet/providers/ibm/utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)    34628 2023-06-01 22:29:03.000000 skypilot-0.3.1/sky/skylet/providers/ibm/vpc_provider.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/providers/lambda_cloud/
--rw-r--r--   0 zongheng   (502) staff       (20)      112 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/skylet/providers/lambda_cloud/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     8518 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/skylet/providers/lambda_cloud/lambda_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)    13650 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/skylet/ray_patches/
--rw-r--r--   0 zongheng   (502) staff       (20)     2783 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)      294 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/autoscaler.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      391 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/cli.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      224 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/command_runner.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      528 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/log_monitor.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      658 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      289 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/updater.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      565 2023-06-03 18:06:12.000000 skypilot-0.3.1/sky/skylet/ray_patches/worker.py.patch
--rw-r--r--   0 zongheng   (502) staff       (20)      603 2023-01-09 22:00:08.000000 skypilot-0.3.1/sky/skylet/skylet.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2649 2023-06-04 15:46:29.000000 skypilot-0.3.1/sky/skylet/subprocess_daemon.py
--rw-r--r--   0 zongheng   (502) staff       (20)     5654 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/skypilot_config.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/spot/
--rw-r--r--   0 zongheng   (502) staff       (20)     1346 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/spot/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)      561 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/spot/constants.py
--rw-r--r--   0 zongheng   (502) staff       (20)    18420 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/spot/controller.py
--rw-r--r--   0 zongheng   (502) staff       (20)    20897 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/spot/recovery_strategy.py
--rw-r--r--   0 zongheng   (502) staff       (20)    13506 2023-04-19 13:26:02.000000 skypilot-0.3.1/sky/spot/spot_state.py
--rw-r--r--   0 zongheng   (502) staff       (20)    25411 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/spot/spot_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)    35659 2023-06-04 15:57:37.000000 skypilot-0.3.1/sky/task.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/templates/
--rw-r--r--   0 zongheng   (502) staff       (20)    11468 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/templates/aws-ray.yml.j2
--rw-r--r--   0 zongheng   (502) staff       (20)     9407 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/templates/azure-ray.yml.j2
--rw-r--r--   0 zongheng   (502) staff       (20)    10878 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/templates/gcp-ray.yml.j2
--rw-r--r--   0 zongheng   (502) staff       (20)      505 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/templates/gcp-tpu-create.sh.j2
--rw-r--r--   0 zongheng   (502) staff       (20)      328 2022-11-22 22:28:46.000000 skypilot-0.3.1/sky/templates/gcp-tpu-delete.sh.j2
--rw-r--r--   0 zongheng   (502) staff       (20)     8040 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/templates/ibm-ray.yml.j2
--rw-r--r--   0 zongheng   (502) staff       (20)     6830 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/templates/lambda-ray.yml.j2
--rw-r--r--   0 zongheng   (502) staff       (20)     1424 2022-11-22 22:28:46.000000 skypilot-0.3.1/sky/templates/local-ray.yml.j2
--rw-r--r--   0 zongheng   (502) staff       (20)     2356 2023-06-04 15:57:24.000000 skypilot-0.3.1/sky/templates/spot-controller.yaml.j2
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/usage/
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2022-11-22 22:28:46.000000 skypilot-0.3.1/sky/usage/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)      633 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/usage/constants.py
--rw-r--r--   0 zongheng   (502) staff       (20)    16946 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/usage/usage_lib.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/utils/
--rw-r--r--   0 zongheng   (502) staff       (20)       25 2022-11-22 22:28:46.000000 skypilot-0.3.1/sky/utils/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)     2806 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/utils/accelerator_registry.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/sky/utils/cli_utils/
--rw-r--r--   0 zongheng   (502) staff       (20)        0 2022-07-22 04:56:35.000000 skypilot-0.3.1/sky/utils/cli_utils/__init__.py
--rw-r--r--   0 zongheng   (502) staff       (20)    14464 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/utils/cli_utils/status_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)    14688 2023-05-28 16:43:06.000000 skypilot-0.3.1/sky/utils/command_runner.py
--rw-r--r--   0 zongheng   (502) staff       (20)    11033 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/utils/common_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1853 2023-04-03 17:20:30.000000 skypilot-0.3.1/sky/utils/db_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)      852 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/utils/env_options.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4962 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/utils/log_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     6611 2023-06-01 22:22:35.000000 skypilot-0.3.1/sky/utils/schemas.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4078 2023-06-01 23:01:59.000000 skypilot-0.3.1/sky/utils/subprocess_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     3965 2023-02-24 05:01:20.000000 skypilot-0.3.1/sky/utils/timeline.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4186 2023-04-19 13:26:02.000000 skypilot-0.3.1/sky/utils/tpu_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1125 2023-06-01 22:47:29.000000 skypilot-0.3.1/sky/utils/ux_utils.py
--rw-r--r--   0 zongheng   (502) staff       (20)      701 2022-11-22 22:28:46.000000 skypilot-0.3.1/sky/utils/validator.py
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/
--rw-r--r--   0 zongheng   (502) staff       (20)     8102 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/PKG-INFO
--rw-r--r--   0 zongheng   (502) staff       (20)     4827 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/SOURCES.txt
--rw-r--r--   0 zongheng   (502) staff       (20)        1 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/dependency_links.txt
--rw-r--r--   0 zongheng   (502) staff       (20)       36 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/entry_points.txt
--rw-r--r--   0 zongheng   (502) staff       (20)     1163 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/requires.txt
--rw-r--r--   0 zongheng   (502) staff       (20)        4 2023-06-04 16:54:31.000000 skypilot-0.3.1/skypilot.egg-info/top_level.txt
-drwxr-xr-x   0 zongheng   (502) staff       (20)        0 2023-06-04 16:54:31.000000 skypilot-0.3.1/tests/
--rw-r--r--   0 zongheng   (502) staff       (20)     2574 2023-06-01 22:47:29.000000 skypilot-0.3.1/tests/test_cli.py
--rw-r--r--   0 zongheng   (502) staff       (20)     5061 2023-05-28 16:43:06.000000 skypilot-0.3.1/tests/test_config.py
--rw-r--r--   0 zongheng   (502) staff       (20)      300 2021-12-14 23:56:33.000000 skypilot-0.3.1/tests/test_file_mount_helper.py
--rw-r--r--   0 zongheng   (502) staff       (20)      260 2022-11-22 22:28:46.000000 skypilot-0.3.1/tests/test_global_user_state.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1076 2023-02-24 05:01:20.000000 skypilot-0.3.1/tests/test_list_accelerators.py
--rw-r--r--   0 zongheng   (502) staff       (20)    14008 2023-02-24 05:01:20.000000 skypilot-0.3.1/tests/test_onprem.py
--rw-r--r--   0 zongheng   (502) staff       (20)    19443 2023-06-01 22:29:03.000000 skypilot-0.3.1/tests/test_optimizer_dryruns.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4663 2023-04-19 13:26:02.000000 skypilot-0.3.1/tests/test_optimizer_random_dag.py
--rw-r--r--   0 zongheng   (502) staff       (20)       94 2022-02-17 10:51:09.000000 skypilot-0.3.1/tests/test_pycryptodome_version.py
--rw-r--r--   0 zongheng   (502) staff       (20)   101322 2023-06-04 15:57:37.000000 skypilot-0.3.1/tests/test_smoke.py
--rw-r--r--   0 zongheng   (502) staff       (20)     7206 2023-04-03 17:20:30.000000 skypilot-0.3.1/tests/test_spot.py
--rw-r--r--   0 zongheng   (502) staff       (20)     4048 2023-06-01 22:22:35.000000 skypilot-0.3.1/tests/test_storage.py
--rw-r--r--   0 zongheng   (502) staff       (20)     1070 2023-01-09 22:00:08.000000 skypilot-0.3.1/tests/test_wheels.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.344241 skypilot-0.3.2/
+-rwx------   0 zhwu       (502) staff       (20)    12170 2022-10-12 18:53:41.000000 skypilot-0.3.2/LICENSE
+-rw-r--r--   0 zhwu       (502) staff       (20)      647 2023-06-23 05:56:00.000000 skypilot-0.3.2/MANIFEST.in
+-rw-r--r--   0 zhwu       (502) staff       (20)     8643 2023-07-01 04:53:18.343836 skypilot-0.3.2/PKG-INFO
+-rw-r--r--   0 zhwu       (502) staff       (20)     7876 2023-06-30 18:11:28.000000 skypilot-0.3.2/README.md
+-rw-r--r--   0 zhwu       (502) staff       (20)      519 2023-06-22 03:00:27.000000 skypilot-0.3.2/pyproject.toml
+-rw-r--r--   0 zhwu       (502) staff       (20)       38 2023-07-01 04:53:18.344345 skypilot-0.3.2/setup.cfg
+-rw-r--r--   0 zhwu       (502) staff       (20)     7969 2023-06-30 19:37:59.000000 skypilot-0.3.2/setup.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.190451 skypilot-0.3.2/sky/
+-rw-r--r--   0 zhwu       (502) staff       (20)     2076 2023-07-01 04:52:15.000000 skypilot-0.3.2/sky/__init__.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.196080 skypilot-0.3.2/sky/adaptors/
+-rwx------   0 zhwu       (502) staff       (20)        0 2022-10-12 18:53:41.000000 skypilot-0.3.2/sky/adaptors/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2607 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/adaptors/aws.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      989 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/adaptors/azure.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7726 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/adaptors/cloudflare.py
+-rwx------   0 zhwu       (502) staff       (20)      852 2022-10-12 18:53:41.000000 skypilot-0.3.2/sky/adaptors/docker.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2194 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/adaptors/gcp.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     3052 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/adaptors/ibm.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2054 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/adaptors/oci.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    18117 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/authentication.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.204833 skypilot-0.3.2/sky/backends/
+-rw-r--r--   0 zhwu       (502) staff       (20)      414 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5542 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/backend.py
+-rw-r--r--   0 zhwu       (502) staff       (20)   111189 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/backends/backend_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)   198642 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     8321 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/docker_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    16267 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.205507 skypilot-0.3.2/sky/backends/monkey_patches/
+-rw-r--r--   0 zhwu       (502) staff       (20)     3410 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    24422 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/onprem_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5903 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/backends/wheel_utils.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.207259 skypilot-0.3.2/sky/benchmark/
+-rw-r--r--   0 zhwu       (502) staff       (20)        0 2023-06-15 20:22:54.000000 skypilot-0.3.2/sky/benchmark/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     8723 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    24638 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     3571 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/check.py
+-rw-r--r--   0 zhwu       (502) staff       (20)   166724 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/cli.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     8592 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/cloud_stores.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.217702 skypilot-0.3.2/sky/clouds/
+-rw-r--r--   0 zhwu       (502) staff       (20)      701 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    40790 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/aws.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    25079 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/azure.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    23847 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/cloud.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    40881 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/clouds/gcp.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    20008 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/ibm.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    11657 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7903 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/local.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    24297 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/oci.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    14583 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/scp.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.229306 skypilot-0.3.2/sky/clouds/service_catalog/
+-rw-r--r--   0 zhwu       (502) staff       (20)    13191 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    11470 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7050 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    22995 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1500 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      282 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/constants.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.236075 skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 zhwu       (502) staff       (20)        0 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    20092 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     8679 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    18601 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4198 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    19812 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4656 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5414 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7582 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5484 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    40110 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/core.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2502 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/dag.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.250244 skypilot-0.3.2/sky/data/
+-rw-r--r--   0 zhwu       (502) staff       (20)      128 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/data/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7273 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/data/data_transfer.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7918 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/data/data_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     3251 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/data/mounting_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    89236 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/data/storage.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1082 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/data/storage_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     6017 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/exceptions.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    41325 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/execution.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    25969 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/global_user_state.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    45228 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/optimizer.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    45007 2023-07-01 04:52:15.000000 skypilot-0.3.2/sky/resources.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.251718 skypilot-0.3.2/sky/setup_files/
+-rw-r--r--   0 zhwu       (502) staff       (20)      647 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 zhwu       (502) staff       (20)     7969 2023-06-30 19:37:59.000000 skypilot-0.3.2/sky/setup_files/setup.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     3216 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/sky_logging.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.267270 skypilot-0.3.2/sky/skylet/
+-rw-r--r--   0 zhwu       (502) staff       (20)    12568 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/LICENSE
+-rwx------   0 zhwu       (502) staff       (20)        0 2022-10-12 18:53:41.000000 skypilot-0.3.2/sky/skylet/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1203 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4378 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/autostop_lib.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1887 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/skylet/configs.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2064 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/skylet/constants.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     8899 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/events.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    32722 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/job_lib.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    18802 2023-06-27 20:44:12.000000 skypilot-0.3.2/sky/skylet/log_lib.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.170249 skypilot-0.3.2/sky/skylet/providers/
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.271759 skypilot-0.3.2/sky/skylet/providers/aws/
+-rw-r--r--   0 zhwu       (502) staff       (20)      110 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/aws/__init__.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.272913 skypilot-0.3.2/sky/skylet/providers/aws/cloudwatch/
+-rwx------   0 zhwu       (502) staff       (20)        0 2022-10-12 18:53:42.000000 skypilot-0.3.2/sky/skylet/providers/aws/cloudwatch/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    32698 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    52192 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/aws/config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    29406 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/aws/node_provider.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5917 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/aws/utils.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.277805 skypilot-0.3.2/sky/skylet/providers/azure/
+-rwx------   0 zhwu       (502) staff       (20)       97 2022-10-12 18:53:42.000000 skypilot-0.3.2/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4344 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 zhwu       (502) staff       (20)    10633 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 zhwu       (502) staff       (20)     5756 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    17469 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/azure/node_provider.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.282156 skypilot-0.3.2/sky/skylet/providers/gcp/
+-rwx------   0 zhwu       (502) staff       (20)       91 2022-10-12 18:53:42.000000 skypilot-0.3.2/sky/skylet/providers/gcp/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    34963 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/skylet/providers/gcp/config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4168 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/skylet/providers/gcp/constants.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    26192 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/gcp/node.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    14276 2023-07-01 04:52:03.000000 skypilot-0.3.2/sky/skylet/providers/gcp/node_provider.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.285644 skypilot-0.3.2/sky/skylet/providers/ibm/
+-rw-r--r--   0 zhwu       (502) staff       (20)       94 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    38280 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1290 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    34628 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.288129 skypilot-0.3.2/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 zhwu       (502) staff       (20)      112 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     8518 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/skylet/providers/lambda_cloud/lambda_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    13650 2023-06-23 02:46:49.000000 skypilot-0.3.2/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.293272 skypilot-0.3.2/sky/skylet/providers/oci/
+-rw-r--r--   0 zhwu       (502) staff       (20)       91 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4234 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/skylet/providers/oci/config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    20136 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    17048 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      508 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.296184 skypilot-0.3.2/sky/skylet/providers/scp/
+-rw-r--r--   0 zhwu       (502) staff       (20)       91 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4921 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    22219 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/scp/node_provider.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    15481 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/providers/scp/scp_utils.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.301502 skypilot-0.3.2/sky/skylet/ray_patches/
+-rw-r--r--   0 zhwu       (502) staff       (20)     2783 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      294 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      391 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      224 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      528 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      658 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      289 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      565 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 zhwu       (502) staff       (20)      788 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/skylet.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2649 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5654 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/skypilot_config.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.306415 skypilot-0.3.2/sky/spot/
+-rw-r--r--   0 zhwu       (502) staff       (20)     1356 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/spot/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      881 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/spot/constants.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    22650 2023-06-27 20:44:12.000000 skypilot-0.3.2/sky/spot/controller.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.307727 skypilot-0.3.2/sky/spot/dashboard/
+-rw-r--r--   0 zhwu       (502) staff       (20)     2294 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/spot/dashboard/dashboard.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.308438 skypilot-0.3.2/sky/spot/dashboard/static/
+-rw-r--r--   0 zhwu       (502) staff       (20)    15086 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/spot/dashboard/static/favicon.ico
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.309208 skypilot-0.3.2/sky/spot/dashboard/templates/
+-rw-r--r--   0 zhwu       (502) staff       (20)     6247 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/spot/dashboard/templates/index.html
+-rw-r--r--   0 zhwu       (502) staff       (20)    21198 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/spot/recovery_strategy.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    21748 2023-06-27 20:44:12.000000 skypilot-0.3.2/sky/spot/spot_state.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    32413 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/spot/spot_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1457 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/status_lib.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    38207 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/task.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.320207 skypilot-0.3.2/sky/templates/
+-rw-r--r--   0 zhwu       (502) staff       (20)    11468 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     9407 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)    10878 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)      505 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/templates/gcp-tpu-create.sh.j2
+-rwx------   0 zhwu       (502) staff       (20)      328 2022-10-12 18:53:42.000000 skypilot-0.3.2/sky/templates/gcp-tpu-delete.sh.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     8040 2023-06-22 07:29:07.000000 skypilot-0.3.2/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     6830 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     1424 2023-06-15 20:22:54.000000 skypilot-0.3.2/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     8239 2023-06-22 07:29:07.000000 skypilot-0.3.2/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     6830 2023-06-23 05:55:37.000000 skypilot-0.3.2/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 zhwu       (502) staff       (20)     2185 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/templates/spot-controller.yaml.j2
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.321975 skypilot-0.3.2/sky/usage/
+-rw-r--r--   0 zhwu       (502) staff       (20)        0 2023-06-15 20:22:54.000000 skypilot-0.3.2/sky/usage/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      633 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/usage/constants.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    17294 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/usage/usage_lib.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.330945 skypilot-0.3.2/sky/utils/
+-rw-r--r--   0 zhwu       (502) staff       (20)       25 2023-06-15 20:22:54.000000 skypilot-0.3.2/sky/utils/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2806 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.332034 skypilot-0.3.2/sky/utils/cli_utils/
+-rwx------   0 zhwu       (502) staff       (20)        0 2022-10-12 18:53:42.000000 skypilot-0.3.2/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    14897 2023-06-22 09:12:14.000000 skypilot-0.3.2/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    14688 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/utils/command_runner.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    12077 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/utils/common_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2941 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/utils/dag_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     2777 2023-06-23 05:56:00.000000 skypilot-0.3.2/sky/utils/db_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      852 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/utils/env_options.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4962 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/utils/log_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     6846 2023-06-30 18:49:42.000000 skypilot-0.3.2/sky/utils/schemas.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5774 2023-06-30 18:11:28.000000 skypilot-0.3.2/sky/utils/subprocess_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     3965 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/utils/timeline.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4186 2023-06-22 03:00:27.000000 skypilot-0.3.2/sky/utils/tpu_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1125 2023-06-29 03:35:21.000000 skypilot-0.3.2/sky/utils/ux_utils.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      701 2023-06-15 20:22:54.000000 skypilot-0.3.2/sky/utils/validator.py
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.334737 skypilot-0.3.2/skypilot.egg-info/
+-rwx------   0 zhwu       (502) staff       (20)     8643 2023-07-01 04:53:18.000000 skypilot-0.3.2/skypilot.egg-info/PKG-INFO
+-rwx------   0 zhwu       (502) staff       (20)     5500 2023-07-01 04:53:18.000000 skypilot-0.3.2/skypilot.egg-info/SOURCES.txt
+-rwx------   0 zhwu       (502) staff       (20)        1 2023-07-01 04:53:18.000000 skypilot-0.3.2/skypilot.egg-info/dependency_links.txt
+-rwx------   0 zhwu       (502) staff       (20)       36 2023-07-01 04:53:18.000000 skypilot-0.3.2/skypilot.egg-info/entry_points.txt
+-rwx------   0 zhwu       (502) staff       (20)     1234 2023-07-01 04:53:18.000000 skypilot-0.3.2/skypilot.egg-info/requires.txt
+-rwx------   0 zhwu       (502) staff       (20)        4 2023-07-01 04:53:18.000000 skypilot-0.3.2/skypilot.egg-info/top_level.txt
+drwxr-xr-x   0 zhwu       (502) staff       (20)        0 2023-07-01 04:53:18.343019 skypilot-0.3.2/tests/
+-rw-r--r--   0 zhwu       (502) staff       (20)     4677 2023-06-30 18:11:28.000000 skypilot-0.3.2/tests/test_cli.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     5061 2023-06-22 03:00:27.000000 skypilot-0.3.2/tests/test_config.py
+-rw-r--r--   0 zhwu       (502) staff       (20)      260 2023-06-15 20:22:54.000000 skypilot-0.3.2/tests/test_global_user_state.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     3620 2023-06-30 18:11:28.000000 skypilot-0.3.2/tests/test_list_accelerators.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    14008 2023-06-22 03:00:27.000000 skypilot-0.3.2/tests/test_onprem.py
+-rw-r--r--   0 zhwu       (502) staff       (20)    20799 2023-06-30 18:49:42.000000 skypilot-0.3.2/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4663 2023-06-22 03:00:27.000000 skypilot-0.3.2/tests/test_optimizer_random_dag.py
+-rwx------   0 zhwu       (502) staff       (20)       94 2022-10-12 18:53:42.000000 skypilot-0.3.2/tests/test_pycryptodome_version.py
+-rw-r--r--   0 zhwu       (502) staff       (20)   123678 2023-06-30 18:49:42.000000 skypilot-0.3.2/tests/test_smoke.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     7206 2023-06-22 03:00:27.000000 skypilot-0.3.2/tests/test_spot.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     4048 2023-06-22 03:00:27.000000 skypilot-0.3.2/tests/test_storage.py
+-rw-r--r--   0 zhwu       (502) staff       (20)     1070 2023-06-22 03:00:27.000000 skypilot-0.3.2/tests/test_wheels.py
```

### filetype from file(1)

```diff
@@ -1 +1 @@
-POSIX tar archive (GNU)
+POSIX tar archive
```

### Comparing `skypilot-0.3.1/LICENSE` & `skypilot-0.3.2/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/PKG-INFO` & `skypilot-0.3.2/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot
-Version: 0.3.1
+Version: 0.3.2
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
@@ -20,14 +20,16 @@
 Provides-Extra: aws
 Provides-Extra: azure
 Provides-Extra: gcp
 Provides-Extra: ibm
 Provides-Extra: docker
 Provides-Extra: lambda
 Provides-Extra: cloudflare
+Provides-Extra: scp
+Provides-Extra: oci
 Provides-Extra: all
 License-File: LICENSE
 
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/skypilot-wide-light-1k.png" width=55%>
 </p>
 
@@ -48,39 +50,45 @@
 
 
 <h3 align="center">
     Run jobs on any cloud, easily and cost effectively
 </h3>
 
 ----
-:fire: :dromedary_camel: *News* :dromedary_camel: :fire: 
+:fire: *News* :fire:
+- [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
+- [June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung SCP and Oracle OCI!
 - [April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the Vicuna model with a single command**!
 - [March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** 
 - [March, 2023] *Serve* your own LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama)
 ----
 
 SkyPilot is a framework for easily and cost effectively running ML workloads<sup>[1]</sup> on any cloud. 
 
 SkyPilot abstracts away the cloud infra burden:
-- Launch jobs & clusters on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung)
+- Launch jobs & clusters on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI)
 - Find scarce resources across zones/regions/clouds
 - Queue jobs & use cloud object stores
 
 SkyPilot cuts your cloud costs:
 * [Managed Spot](https://skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): **3x cost savings** using spot VMs, with auto-recovery from preemptions
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters 
 * [Benchmark](https://skypilot.readthedocs.io/en/latest/reference/benchmark/index.html): find best VM types for your jobs
 * Optimizer: **2x cost savings** by auto-picking best prices across zones/regions/clouds
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes. 
 
 Install with pip or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html):
 ```
-pip install "skypilot[aws,gcp,azure,lambda,ibm,scp]"  # choose your clouds
+pip install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]"  # choose your clouds
 ```
+<p align="center">
+  <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=80%>
+</p>
+
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
 - [Installation](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)
 - [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/quickstart.html)
 - [CLI reference](https://skypilot.readthedocs.io/en/latest/reference/cli.html)
```

#### html2text {}

```diff
@@ -1,73 +1,81 @@
-Metadata-Version: 2.1 Name: skypilot Version: 0.3.1 Summary: SkyPilot: An
+Metadata-Version: 2.1 Name: skypilot Version: 0.3.2 Summary: SkyPilot: An
 intercloud broker for the clouds Author: SkyPilot Team License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot Project-URL:
 Issues, https://github.com/skypilot-org/skypilot/issues Project-URL:
 Discussion, https://github.com/skypilot-org/skypilot/discussions Project-URL:
 Documentation, https://skypilot.readthedocs.io/en/latest/ Classifier:
 Programming Language :: Python :: 3.7 Classifier: Programming Language ::
 Python :: 3.8 Classifier: Programming Language :: Python :: 3.9 Classifier:
 Programming Language :: Python :: 3.10 Classifier: License :: OSI Approved ::
 Apache Software License Classifier: Operating System :: OS Independent
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
 Classifier: Topic :: System :: Distributed Computing Description-Content-Type:
 text/markdown Provides-Extra: aws Provides-Extra: azure Provides-Extra: gcp
 Provides-Extra: ibm Provides-Extra: docker Provides-Extra: lambda Provides-
-Extra: cloudflare Provides-Extra: all License-File: LICENSE
+Extra: cloudflare Provides-Extra: scp Provides-Extra: oci Provides-Extra: all
+License-File: LICENSE
                                   [SkyPilot]
                  [Documentation] [GitHub_Release] [Join_Slack]
          **** Run jobs on any cloud, easily and cost effectively ****
----- :fire: :dromedary_camel: *News* :dromedary_camel: :fire: - [April, 2023]
-**[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the
-Vicuna model with a single command**! - [March, 2023] **[Vicuna LLM chatbot]
-(https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./
-llm/vicuna/) **for $300 on spot instances!** - [March, 2023] *Serve* your own
-LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-
-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama) ---- SkyPilot
-is a framework for easily and cost effectively running ML workloads[1] on any
-cloud. SkyPilot abstracts away the cloud infra burden: - Launch jobs & clusters
-on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung) - Find scarce
-resources across zones/regions/clouds - Queue jobs & use cloud object stores
-SkyPilot cuts your cloud costs: * [Managed Spot](https://
-skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): **3x cost savings**
-using spot VMs, with auto-recovery from preemptions * [Autostop](https://
-skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
-of idle clusters * [Benchmark](https://skypilot.readthedocs.io/en/latest/
-reference/benchmark/index.html): find best VM types for your jobs * Optimizer:
-**2x cost savings** by auto-picking best prices across zones/regions/clouds
-SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code
-changes. Install with pip or [from source](https://skypilot.readthedocs.io/en/
-latest/getting-started/installation.html): ``` pip install "skypilot
-[aws,gcp,azure,lambda,ibm,scp]" # choose your clouds ``` ## Getting Started You
-can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
-- [Installation](https://skypilot.readthedocs.io/en/latest/getting-started/
-installation.html) - [Quickstart](https://skypilot.readthedocs.io/en/latest/
-getting-started/quickstart.html) - [CLI reference](https://
-skypilot.readthedocs.io/en/latest/reference/cli.html) ## SkyPilot in 1 minute A
-SkyPilot task specifies: resource requirements, data to be synced, setup
-commands, and the task commands. Once written in this [**unified interface**]
-(https://skypilot.readthedocs.io/en/latest/reference/yaml-spec.html) (YAML or
-Python API), the task can be launched on any available cloud. This avoids
-vendor lock-in, and allows easily moving jobs to a different provider. Paste
-the following into a file `my_task.yaml`: ```yaml resources: accelerators:
-V100:1 # 1x NVIDIA V100 GPU num_nodes: 1 # Number of VMs to launch # Working
-directory (optional) containing the project codebase. # Its contents are synced
-to ~/sky_workdir/ on the cluster. workdir: ~/torch_examples # Commands to be
-run before executing the job. # Typical use: pip install -r requirements.txt,
-git clone, etc. setup: | pip install torch torchvision # Commands to run as a
-job. # Typical use: launch the main program. run: | cd mnist python main.py --
-epochs 1 ``` Prepare the workdir by cloning: ```bash git clone https://
-github.com/pytorch/examples.git ~/torch_examples ``` Launch with `sky launch`
-(note: [access to GPU instances](https://skypilot.readthedocs.io/en/latest/
-reference/quota.html) is needed for this example): ```bash sky launch
-my_task.yaml ``` SkyPilot then performs the heavy-lifting for you, including:
-1. Find the lowest priced VM instance type across different clouds 2. Provision
-the VM, with auto-failover if the cloud returned capacity errors 3. Sync the
-local `workdir` to the VM 4. Run the task's `setup` commands to prepare the VM
-for running the task 5. Run the task's `run` commands
+---- :fire: *News* :fire: - [June, 2023] Serving LLM **24x Faster On the
+Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**]
+(https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-
+skypilot/) - [June, 2023] [**Two new clouds supported**](https://
+skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung
+SCP and Oracle OCI! - [April, 2023] **[**SkyPilot YAMLs released**](./llm/
+vicuna/) for finetuning & serving the Vicuna model with a single command**! -
+[March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/
+) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!**
+- [March, 2023] *Serve* your own LLaMA LLM chatbot (not finetuned) on any
+cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/
+skypilot-org/sky-llama) ---- SkyPilot is a framework for easily and cost
+effectively running ML workloads[1] on any cloud. SkyPilot abstracts away the
+cloud infra burden: - Launch jobs & clusters on any cloud (AWS, Azure, GCP,
+Lambda Cloud, IBM, Samsung, OCI) - Find scarce resources across zones/regions/
+clouds - Queue jobs & use cloud object stores SkyPilot cuts your cloud costs: *
+[Managed Spot](https://skypilot.readthedocs.io/en/latest/examples/spot-
+jobs.html): **3x cost savings** using spot VMs, with auto-recovery from
+preemptions * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/
+auto-stop.html): hands-free cleanup of idle clusters * [Benchmark](https://
+skypilot.readthedocs.io/en/latest/reference/benchmark/index.html): find best VM
+types for your jobs * Optimizer: **2x cost savings** by auto-picking best
+prices across zones/regions/clouds SkyPilot supports your existing GPU, TPU,
+and CPU workloads, with no code changes. Install with pip or [from source]
+(https://skypilot.readthedocs.io/en/latest/getting-started/installation.html):
+``` pip install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your
+clouds ```
+                                  [SkyPilot]
+## Getting Started You can find our documentation [here](https://
+skypilot.readthedocs.io/en/latest/). - [Installation](https://
+skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
+[Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
+quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
+reference/cli.html) ## SkyPilot in 1 minute A SkyPilot task specifies: resource
+requirements, data to be synced, setup commands, and the task commands. Once
+written in this [**unified interface**](https://skypilot.readthedocs.io/en/
+latest/reference/yaml-spec.html) (YAML or Python API), the task can be launched
+on any available cloud. This avoids vendor lock-in, and allows easily moving
+jobs to a different provider. Paste the following into a file `my_task.yaml`:
+```yaml resources: accelerators: V100:1 # 1x NVIDIA V100 GPU num_nodes: 1 #
+Number of VMs to launch # Working directory (optional) containing the project
+codebase. # Its contents are synced to ~/sky_workdir/ on the cluster. workdir:
+~/torch_examples # Commands to be run before executing the job. # Typical use:
+pip install -r requirements.txt, git clone, etc. setup: | pip install torch
+torchvision # Commands to run as a job. # Typical use: launch the main program.
+run: | cd mnist python main.py --epochs 1 ``` Prepare the workdir by cloning:
+```bash git clone https://github.com/pytorch/examples.git ~/torch_examples ```
+Launch with `sky launch` (note: [access to GPU instances](https://
+skypilot.readthedocs.io/en/latest/reference/quota.html) is needed for this
+example): ```bash sky launch my_task.yaml ``` SkyPilot then performs the heavy-
+lifting for you, including: 1. Find the lowest priced VM instance type across
+different clouds 2. Provision the VM, with auto-failover if the cloud returned
+capacity errors 3. Sync the local `workdir` to the VM 4. Run the task's `setup`
+commands to prepare the VM for running the task 5. Run the task's `run`
+commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## Learn more -
 [Documentation](https://skypilot.readthedocs.io/en/latest/) - [Example:
 HuggingFace](https://skypilot.readthedocs.io/en/latest/getting-started/
 tutorial.html) - [Tutorials](https://github.com/skypilot-org/skypilot-tutorial)
 - [YAML reference](https://skypilot.readthedocs.io/en/latest/reference/yaml-
```

### Comparing `skypilot-0.3.1/README.md` & `skypilot-0.3.2/README.md`

 * *Files 6% similar despite different names*

```diff
@@ -22,39 +22,48 @@
 
 
 <h3 align="center">
     Run jobs on any cloud, easily and cost effectively
 </h3>
 
 ----
-:fire: :dromedary_camel: *News* :dromedary_camel: :fire: 
+:fire: *News* :fire:
+- [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
+- [June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung SCP and Oracle OCI!
 - [April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the Vicuna model with a single command**!
 - [March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** 
 - [March, 2023] *Serve* your own LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama)
 ----
 
 SkyPilot is a framework for easily and cost effectively running ML workloads[^1] on any cloud. 
 
 SkyPilot abstracts away the cloud infra burden:
-- Launch jobs & clusters on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung)
+- Launch jobs & clusters on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI)
 - Find scarce resources across zones/regions/clouds
 - Queue jobs & use cloud object stores
 
 SkyPilot cuts your cloud costs:
 * [Managed Spot](https://skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): **3x cost savings** using spot VMs, with auto-recovery from preemptions
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters 
 * [Benchmark](https://skypilot.readthedocs.io/en/latest/reference/benchmark/index.html): find best VM types for your jobs
 * Optimizer: **2x cost savings** by auto-picking best prices across zones/regions/clouds
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes. 
 
 Install with pip or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html):
 ```
-pip install "skypilot[aws,gcp,azure,lambda,ibm,scp]"  # choose your clouds
+pip install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]"  # choose your clouds
 ```
+<p align="center">
+  <picture>
+    <source media="(prefers-color-scheme: dark)" srcset="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-dark.png">
+    <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=80%>
+  </picture>
+</p>
+
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
 - [Installation](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)
 - [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/quickstart.html)
 - [CLI reference](https://skypilot.readthedocs.io/en/latest/reference/cli.html)
```

#### html2text {}

```diff
@@ -1,58 +1,65 @@
                                    [SkyPilot]
                  [Documentation] [GitHub_Release] [Join_Slack]
          **** Run jobs on any cloud, easily and cost effectively ****
----- :fire: :dromedary_camel: *News* :dromedary_camel: :fire: - [April, 2023]
-**[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the
-Vicuna model with a single command**! - [March, 2023] **[Vicuna LLM chatbot]
-(https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./
-llm/vicuna/) **for $300 on spot instances!** - [March, 2023] *Serve* your own
-LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-
-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama) ---- SkyPilot
-is a framework for easily and cost effectively running ML workloads[^1] on any
-cloud. SkyPilot abstracts away the cloud infra burden: - Launch jobs & clusters
-on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung) - Find scarce
-resources across zones/regions/clouds - Queue jobs & use cloud object stores
-SkyPilot cuts your cloud costs: * [Managed Spot](https://
-skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): **3x cost savings**
-using spot VMs, with auto-recovery from preemptions * [Autostop](https://
-skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
-of idle clusters * [Benchmark](https://skypilot.readthedocs.io/en/latest/
-reference/benchmark/index.html): find best VM types for your jobs * Optimizer:
-**2x cost savings** by auto-picking best prices across zones/regions/clouds
-SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code
-changes. Install with pip or [from source](https://skypilot.readthedocs.io/en/
-latest/getting-started/installation.html): ``` pip install "skypilot
-[aws,gcp,azure,lambda,ibm,scp]" # choose your clouds ``` ## Getting Started You
-can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
-- [Installation](https://skypilot.readthedocs.io/en/latest/getting-started/
-installation.html) - [Quickstart](https://skypilot.readthedocs.io/en/latest/
-getting-started/quickstart.html) - [CLI reference](https://
-skypilot.readthedocs.io/en/latest/reference/cli.html) ## SkyPilot in 1 minute A
-SkyPilot task specifies: resource requirements, data to be synced, setup
-commands, and the task commands. Once written in this [**unified interface**]
-(https://skypilot.readthedocs.io/en/latest/reference/yaml-spec.html) (YAML or
-Python API), the task can be launched on any available cloud. This avoids
-vendor lock-in, and allows easily moving jobs to a different provider. Paste
-the following into a file `my_task.yaml`: ```yaml resources: accelerators:
-V100:1 # 1x NVIDIA V100 GPU num_nodes: 1 # Number of VMs to launch # Working
-directory (optional) containing the project codebase. # Its contents are synced
-to ~/sky_workdir/ on the cluster. workdir: ~/torch_examples # Commands to be
-run before executing the job. # Typical use: pip install -r requirements.txt,
-git clone, etc. setup: | pip install torch torchvision # Commands to run as a
-job. # Typical use: launch the main program. run: | cd mnist python main.py --
-epochs 1 ``` Prepare the workdir by cloning: ```bash git clone https://
-github.com/pytorch/examples.git ~/torch_examples ``` Launch with `sky launch`
-(note: [access to GPU instances](https://skypilot.readthedocs.io/en/latest/
-reference/quota.html) is needed for this example): ```bash sky launch
-my_task.yaml ``` SkyPilot then performs the heavy-lifting for you, including:
-1. Find the lowest priced VM instance type across different clouds 2. Provision
-the VM, with auto-failover if the cloud returned capacity errors 3. Sync the
-local `workdir` to the VM 4. Run the task's `setup` commands to prepare the VM
-for running the task 5. Run the task's `run` commands
+---- :fire: *News* :fire: - [June, 2023] Serving LLM **24x Faster On the
+Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**]
+(https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-
+skypilot/) - [June, 2023] [**Two new clouds supported**](https://
+skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung
+SCP and Oracle OCI! - [April, 2023] **[**SkyPilot YAMLs released**](./llm/
+vicuna/) for finetuning & serving the Vicuna model with a single command**! -
+[March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/
+) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!**
+- [March, 2023] *Serve* your own LLaMA LLM chatbot (not finetuned) on any
+cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/
+skypilot-org/sky-llama) ---- SkyPilot is a framework for easily and cost
+effectively running ML workloads[^1] on any cloud. SkyPilot abstracts away the
+cloud infra burden: - Launch jobs & clusters on any cloud (AWS, Azure, GCP,
+Lambda Cloud, IBM, Samsung, OCI) - Find scarce resources across zones/regions/
+clouds - Queue jobs & use cloud object stores SkyPilot cuts your cloud costs: *
+[Managed Spot](https://skypilot.readthedocs.io/en/latest/examples/spot-
+jobs.html): **3x cost savings** using spot VMs, with auto-recovery from
+preemptions * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/
+auto-stop.html): hands-free cleanup of idle clusters * [Benchmark](https://
+skypilot.readthedocs.io/en/latest/reference/benchmark/index.html): find best VM
+types for your jobs * Optimizer: **2x cost savings** by auto-picking best
+prices across zones/regions/clouds SkyPilot supports your existing GPU, TPU,
+and CPU workloads, with no code changes. Install with pip or [from source]
+(https://skypilot.readthedocs.io/en/latest/getting-started/installation.html):
+``` pip install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your
+clouds ```
+                                   [SkyPilot]
+## Getting Started You can find our documentation [here](https://
+skypilot.readthedocs.io/en/latest/). - [Installation](https://
+skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
+[Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
+quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
+reference/cli.html) ## SkyPilot in 1 minute A SkyPilot task specifies: resource
+requirements, data to be synced, setup commands, and the task commands. Once
+written in this [**unified interface**](https://skypilot.readthedocs.io/en/
+latest/reference/yaml-spec.html) (YAML or Python API), the task can be launched
+on any available cloud. This avoids vendor lock-in, and allows easily moving
+jobs to a different provider. Paste the following into a file `my_task.yaml`:
+```yaml resources: accelerators: V100:1 # 1x NVIDIA V100 GPU num_nodes: 1 #
+Number of VMs to launch # Working directory (optional) containing the project
+codebase. # Its contents are synced to ~/sky_workdir/ on the cluster. workdir:
+~/torch_examples # Commands to be run before executing the job. # Typical use:
+pip install -r requirements.txt, git clone, etc. setup: | pip install torch
+torchvision # Commands to run as a job. # Typical use: launch the main program.
+run: | cd mnist python main.py --epochs 1 ``` Prepare the workdir by cloning:
+```bash git clone https://github.com/pytorch/examples.git ~/torch_examples ```
+Launch with `sky launch` (note: [access to GPU instances](https://
+skypilot.readthedocs.io/en/latest/reference/quota.html) is needed for this
+example): ```bash sky launch my_task.yaml ``` SkyPilot then performs the heavy-
+lifting for you, including: 1. Find the lowest priced VM instance type across
+different clouds 2. Provision the VM, with auto-failover if the cloud returned
+capacity errors 3. Sync the local `workdir` to the VM 4. Run the task's `setup`
+commands to prepare the VM for running the task 5. Run the task's `run`
+commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## Learn more -
 [Documentation](https://skypilot.readthedocs.io/en/latest/) - [Example:
 HuggingFace](https://skypilot.readthedocs.io/en/latest/getting-started/
 tutorial.html) - [Tutorials](https://github.com/skypilot-org/skypilot-tutorial)
 - [YAML reference](https://skypilot.readthedocs.io/en/latest/reference/yaml-
```

### Comparing `skypilot-0.3.1/pyproject.toml` & `skypilot-0.3.2/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/setup.py` & `skypilot-0.3.2/setup.py`

 * *Files 5% similar despite different names*

```diff
@@ -91,33 +91,40 @@
     'ray[default]>=2.2.0,<=2.4.0',
     'rich',
     'tabulate',
     # Light weight requirement, can be replaced with "typing" once
     # we deprecate Python 3.7 (this will take a while).
     "typing_extensions; python_version < '3.8'",
     'filelock>=3.6.0',
-    # Adopted from ray's setup.py:
+    # Adopted from ray's setup.py: https://github.com/ray-project/ray/blob/ray-2.4.0/python/setup.py
+    # SkyPilot: != 1.48.0 is required to avoid the error where ray dashboard fails to start when
+    # ray start is called (#2054).
     # Tracking issue: https://github.com/ray-project/ray/issues/30984
-    "grpcio >= 1.32.0, <= 1.49.1; python_version < '3.10' and sys_platform == 'darwin'",  # noqa:E501
-    "grpcio >= 1.42.0, <= 1.49.1; python_version >= '3.10' and sys_platform == 'darwin'",  # noqa:E501
+    "grpcio >= 1.32.0, <= 1.49.1, != 1.48.0; python_version < '3.10' and sys_platform == 'darwin'",  # noqa:E501
+    "grpcio >= 1.42.0, <= 1.49.1, != 1.48.0; python_version >= '3.10' and sys_platform == 'darwin'",  # noqa:E501
     # Original issue: https://github.com/ray-project/ray/issues/33833
-    "grpcio >= 1.32.0, <= 1.51.3; python_version < '3.10' and sys_platform != 'darwin'",  # noqa:E501
-    "grpcio >= 1.42.0, <= 1.51.3; python_version >= '3.10' and sys_platform != 'darwin'",  # noqa:E501
+    "grpcio >= 1.32.0, <= 1.51.3, != 1.48.0; python_version < '3.10' and sys_platform != 'darwin'",  # noqa:E501
+    "grpcio >= 1.42.0, <= 1.51.3, != 1.48.0; python_version >= '3.10' and sys_platform != 'darwin'",  # noqa:E501
     'packaging',
     # Adopted from ray's setup.py:
     # https://github.com/ray-project/ray/blob/86fab1764e618215d8131e8e5068f0d493c77023/python/setup.py#L326
     'protobuf >= 3.15.3, != 3.19.5',
     'psutil',
     'pulp',
+    # Ray job has an issue with pydantic>2.0.0, due to API changes of pydantic. See
+    # https://github.com/ray-project/ray/issues/36990
+    'pydantic<2.0'
 ]
 
-# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the following
-# packages dependencies are changed.
+# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the
+# following packages dependencies are changed.
 aws_dependencies = [
-    # awscli>=1.27.10 is required for SSO support.
+    # NOTE: this installs CLI V1. To use AWS SSO (e.g., `aws sso login`), users
+    # should instead use CLI V2 which is not pip-installable. See
+    # https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html.
     'awscli',
     'boto3',
     # 'Crypto' module used in authentication.py for AWS.
     'pycryptodome==3.12.0',
 ]
 extras_require: Dict[str, List[str]] = {
     'aws': aws_dependencies,
@@ -130,15 +137,17 @@
         'azure-cli>=2.31.0', 'azure-core', 'azure-identity>=1.13.0',
         'azure-mgmt-network'
     ],
     'gcp': ['google-api-python-client', 'google-cloud-storage'],
     'ibm': ['ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services'],
     'docker': ['docker'],
     'lambda': [],
-    'cloudflare': aws_dependencies
+    'cloudflare': aws_dependencies,
+    'scp': [],
+    'oci': ['oci'],
 }
 
 extras_require['all'] = sum(extras_require.values(), [])
 
 # Install aws requirements by default, as it is the most common cloud provider,
 # and the installation is quick.
 install_requires += extras_require['aws']
```

### Comparing `skypilot-0.3.1/sky/__init__.py` & `skypilot-0.3.2/sky/__init__.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,50 +1,54 @@
 """The SkyPilot package."""
 import os
 
 # Replaced with the current commit when building the wheels.
-__commit__ = '344a70b41934265fc25a41a8b5c76350be2ca9cb'
-__version__ = '0.3.1'
+__commit__ = '{{SKYPILOT_COMMIT_SHA}}'
+__version__ = '0.3.2'
 __root_dir__ = os.path.dirname(os.path.abspath(__file__))
 
 # Keep this order to avoid cyclic imports
 from sky import backends
 from sky import benchmark
 from sky import clouds
 from sky.clouds.service_catalog import list_accelerators
 from sky.dag import Dag
 from sky.execution import launch, exec, spot_launch  # pylint: disable=redefined-builtin
 from sky.resources import Resources
 from sky.task import Task
 from sky.optimizer import Optimizer, OptimizeTarget
 from sky.data import Storage, StorageMode, StoreType
-from sky.global_user_state import ClusterStatus
+from sky.status_lib import ClusterStatus
 from sky.skylet.job_lib import JobStatus
 from sky.core import (status, start, stop, down, autostop, queue, cancel,
                       tail_logs, download_logs, job_status, spot_queue,
                       spot_status, spot_cancel, storage_ls, storage_delete,
                       cost_report)
 
 # Aliases.
 IBM = clouds.IBM
 AWS = clouds.AWS
 Azure = clouds.Azure
 GCP = clouds.GCP
 Lambda = clouds.Lambda
+SCP = clouds.SCP
 Local = clouds.Local
+OCI = clouds.OCI
 optimize = Optimizer.optimize
 
 __all__ = [
     '__version__',
     'IBM',
     'AWS',
     'Azure',
     'GCP',
     'Lambda',
+    'SCP',
     'Local',
+    'OCI',
     'Optimizer',
     'OptimizeTarget',
     'backends',
     'benchmark',
     'list_accelerators',
     '__root_dir__',
     'Storage',
```

### Comparing `skypilot-0.3.1/sky/adaptors/aws.py` & `skypilot-0.3.2/sky/adaptors/aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/adaptors/azure.py` & `skypilot-0.3.2/sky/adaptors/azure.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/adaptors/cloudflare.py` & `skypilot-0.3.2/sky/adaptors/cloudflare.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/adaptors/docker.py` & `skypilot-0.3.2/sky/adaptors/docker.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/adaptors/gcp.py` & `skypilot-0.3.2/sky/adaptors/gcp.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/adaptors/ibm.py` & `skypilot-0.3.2/sky/adaptors/ibm.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/authentication.py` & `skypilot-0.3.2/sky/authentication.py`

 * *Files 12% similar despite different names*

```diff
@@ -188,39 +188,64 @@
         raise
 
     project_oslogin: str = next(  # type: ignore
         (item for item in project['commonInstanceMetadata'].get('items', [])
          if item['key'] == 'enable-oslogin'), {}).get('value', 'False')
 
     if project_oslogin.lower() == 'true':
-        # project.
         logger.info(
             f'OS Login is enabled for GCP project {project_id}. Running '
             'additional authentication steps.')
-        # Read the account information from the credential file, since the user
-        # should be set according the account, when the oslogin is enabled.
-        config_path = os.path.expanduser(clouds.gcp.GCP_CONFIG_PATH)
-        sky_backup_config_path = os.path.expanduser(
-            clouds.gcp.GCP_CONFIG_SKY_BACKUP_PATH)
-        assert os.path.exists(sky_backup_config_path), (
-            'GCP credential backup file '
-            f'{sky_backup_config_path!r} does not exist.')
-
-        with open(sky_backup_config_path, 'r') as infile:
-            for line in infile:
-                if line.startswith('account'):
-                    account = line.split('=')[1].strip()
-                    break
-            else:
-                with ux_utils.print_exception_no_traceback():
-                    raise RuntimeError(
-                        'GCP authentication failed, as the oslogin is enabled '
-                        f'but the file {config_path} does not contain the '
-                        'account information.')
-        config['auth']['ssh_user'] = account.replace('@', '_').replace('.', '_')
+
+        # Try to get the os-login user from `gcloud`, as this is the most
+        # accurate way to figure out how this gcp user is meant to log in.
+        proc = subprocess.run(
+            'gcloud compute os-login describe-profile --format yaml',
+            shell=True,
+            stdout=subprocess.PIPE,
+            check=False)
+        os_login_username = None
+        if proc.returncode == 0:
+            try:
+                profile = yaml.safe_load(proc.stdout)
+                username = profile['posixAccounts'][0]['username']
+                if username:
+                    os_login_username = username
+            except Exception as e:  # pylint: disable=broad-except
+                logger.debug('Failed to parse gcloud os-login profile.\n'
+                             f'{common_utils.format_exception(e)}')
+                pass
+
+        if os_login_username is None:
+            # As a fallback, read the account information from the credential
+            # file. This works most of the time, but fails if the user's
+            # os-login username is not a straightforward translation of their
+            # email address, for example because their email address changed
+            # within their google workspace after the os-login credentials
+            # were established.
+            config_path = os.path.expanduser(clouds.gcp.GCP_CONFIG_PATH)
+            sky_backup_config_path = os.path.expanduser(
+                clouds.gcp.GCP_CONFIG_SKY_BACKUP_PATH)
+            assert os.path.exists(sky_backup_config_path), (
+                'GCP credential backup file '
+                f'{sky_backup_config_path!r} does not exist.')
+
+            with open(sky_backup_config_path, 'r') as infile:
+                for line in infile:
+                    if line.startswith('account'):
+                        account = line.split('=')[1].strip()
+                        break
+                else:
+                    with ux_utils.print_exception_no_traceback():
+                        raise RuntimeError(
+                            'GCP authentication failed, as the oslogin is '
+                            f'enabled but the file {config_path} does not '
+                            'contain the account information.')
+            os_login_username = account.replace('@', '_').replace('.', '_')
+        config['auth']['ssh_user'] = os_login_username
 
         # Add ssh key to GCP with oslogin
         subprocess.run(
             'gcloud compute os-login ssh-keys add '
             f'--key-file={public_key_path}',
             check=True,
             shell=True,
@@ -385,7 +410,39 @@
 
     # Add public key path to file mounts
     file_mounts = config['file_mounts']
     file_mounts[PUBLIC_SSH_KEY_PATH] = PUBLIC_SSH_KEY_PATH
     config['file_mounts'] = file_mounts
 
     return config
+
+
+# Apr, 2023 by Hysun(hysun.he@oracle.com): Added support for OCI
+def setup_oci_authentication(config: Dict[str, Any]) -> Dict[str, Any]:
+    _, public_key_path = get_or_generate_keys()
+    with open(public_key_path, 'r') as f:
+        public_key = f.read()
+
+    # Need to use ~ relative path because Ray uses the same
+    # path for finding the public key path on both local and head node.
+    config['auth']['ssh_public_key'] = PUBLIC_SSH_KEY_PATH
+
+    file_mounts = config['file_mounts']
+    file_mounts[PUBLIC_SSH_KEY_PATH] = PUBLIC_SSH_KEY_PATH
+    config['file_mounts'] = file_mounts
+
+    for node_type in config['available_node_types']:
+        config['available_node_types'][node_type]['node_config'][
+            'AuthorizedKey'] = public_key
+
+    return config
+
+
+def setup_scp_authentication(config: Dict[str, Any]) -> Dict[str, Any]:
+    private_key_path, public_key_path = get_or_generate_keys()
+    config['auth']['ssh_private_key'] = private_key_path
+    config['auth']['ssh_public_key'] = public_key_path
+
+    file_mounts = config['file_mounts']
+    file_mounts[public_key_path] = public_key_path
+    config['file_mounts'] = file_mounts
+    return config
```

### Comparing `skypilot-0.3.1/sky/backends/backend.py` & `skypilot-0.3.2/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/backends/backend_utils.py` & `skypilot-0.3.2/sky/backends/backend_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -2,23 +2,21 @@
 from datetime import datetime
 import difflib
 import enum
 import getpass
 import json
 import os
 import pathlib
-import random
 import re
 import subprocess
 import tempfile
 import textwrap
 import time
 import typing
-from typing import (Any, Dict, List, Mapping, Optional, Sequence, Set, Tuple,
-                    Union)
+from typing import (Any, Dict, List, Optional, Sequence, Set, Tuple, Union)
 from typing_extensions import Literal
 import uuid
 
 import colorama
 import filelock
 import jinja2
 import jsonschema
@@ -35,29 +33,28 @@
 from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
 from sky import global_user_state
 from sky import skypilot_config
 from sky import sky_logging
 from sky import spot as spot_lib
+from sky import status_lib
 from sky.backends import onprem_utils
 from sky.skylet import constants
 from sky.skylet import log_lib
-from sky.skylet.providers.lambda_cloud import lambda_utils
 from sky.utils import common_utils
 from sky.utils import command_runner
 from sky.utils import env_options
 from sky.utils import log_utils
 from sky.utils import subprocess_utils
 from sky.utils import timeline
 from sky.utils import tpu_utils
 from sky.utils import ux_utils
 from sky.utils import validator
 from sky.usage import usage_lib
-from sky.adaptors import ibm
 
 if typing.TYPE_CHECKING:
     from sky import resources
     from sky import task as task_lib
     from sky.backends import cloud_vm_ray_backend
     from sky.backends import local_docker_backend
 
@@ -193,33 +190,39 @@
     # Remove the file mounts added by the newline.
     if '' in file_mounts:
         assert file_mounts[''] == '', file_mounts['']
         file_mounts.pop('')
 
     # Putting these in file_mounts hurts provisioning speed, as each file
     # opens/closes an SSH connection.  Instead, we:
-    #  - cp locally them into a directory
+    #  - cp them locally into a directory, each with a unique name to avoid
+    #    basename conflicts
     #  - upload that directory as a file mount (1 connection)
     #  - use a remote command to move all runtime files to their right places.
 
     # Local tmp dir holding runtime files.
     local_runtime_files_dir = tempfile.mkdtemp()
     new_file_mounts = {_REMOTE_RUNTIME_FILES_DIR: local_runtime_files_dir}
 
+    # Generate local_src -> unique_name.
+    local_source_to_unique_name = {}
+    for local_src in file_mounts.values():
+        local_source_to_unique_name[local_src] = str(uuid.uuid4())
+
     # (For remote) Build a command that copies runtime files to their right
     # destinations.
     # NOTE: we copy rather than move, because when launching >1 node, head node
     # is fully set up first, and if moving then head node's files would already
     # move out of _REMOTE_RUNTIME_FILES_DIR, which would cause setting up
     # workers (from the head's files) to fail.  An alternative is softlink
     # (then we need to make sure the usage of runtime files follow links).
     commands = []
     basenames = set()
     for dst, src in file_mounts.items():
-        src_basename = os.path.basename(src)
+        src_basename = local_source_to_unique_name[src]
         dst_basename = os.path.basename(dst)
         dst_parent_dir = os.path.dirname(dst)
 
         # Validate by asserts here as these files are added by our backend.
         # Our runtime files (wheel, yaml, credentials) do not have backslashes.
         assert not src.endswith('/'), src
         assert not dst.endswith('/'), dst
@@ -248,45 +251,67 @@
             0] = f'{postprocess_runtime_files_command}; {setup_commands[0]}'
     else:
         setup_commands = [postprocess_runtime_files_command]
 
     yaml_config['file_mounts'] = new_file_mounts
     yaml_config['setup_commands'] = setup_commands
 
-    # (For local) Move all runtime files, including the just-written yaml, to
+    # (For local) Copy all runtime files, including the just-written yaml, to
     # local_runtime_files_dir/.
-    all_local_sources = ''
+    # < 0.3s to cp 6 clouds' credentials.
     for local_src in file_mounts.values():
+        # cp <local_src> <local_runtime_files_dir>/<unique name of local_src>.
         full_local_src = str(pathlib.Path(local_src).expanduser())
-        # Add quotes for paths containing spaces.
-        all_local_sources += f'{full_local_src!r} '
-    # Takes 10-20 ms on laptop incl. 3 clouds' credentials.
-    subprocess.run(f'cp -r {all_local_sources} {local_runtime_files_dir}/',
-                   shell=True,
-                   check=True)
+        unique_name = local_source_to_unique_name[local_src]
+        # !r to add quotes for paths containing spaces.
+        subprocess.run(
+            f'cp -r {full_local_src!r} {local_runtime_files_dir}/{unique_name}',
+            shell=True,
+            check=True)
 
     common_utils.dump_yaml(yaml_path, yaml_config)
 
 
 def path_size_megabytes(path: str) -> int:
-    """Returns the size of 'path' (directory or file) in megabytes."""
+    """Returns the size of 'path' (directory or file) in megabytes.
+
+    Returns:
+        If successful: the size of 'path' in megabytes, rounded down. Otherwise,
+        -1.
+    """
     resolved_path = pathlib.Path(path).expanduser().resolve()
     git_exclude_filter = ''
     if (resolved_path / command_runner.GIT_EXCLUDE).exists():
         # Ensure file exists; otherwise, rsync will error out.
         git_exclude_filter = command_runner.RSYNC_EXCLUDE_OPTION.format(
             str(resolved_path / command_runner.GIT_EXCLUDE))
-    rsync_output = str(
-        subprocess.check_output(
-            f'rsync {command_runner.RSYNC_DISPLAY_OPTION} '
-            f'{command_runner.RSYNC_FILTER_OPTION} '
-            f'{git_exclude_filter} --dry-run {path!r}',
-            shell=True).splitlines()[-1])
-    total_bytes = rsync_output.split(' ')[3].replace(',', '')
-    return int(float(total_bytes)) // 10**6
+    rsync_command = (f'rsync {command_runner.RSYNC_DISPLAY_OPTION} '
+                     f'{command_runner.RSYNC_FILTER_OPTION} '
+                     f'{git_exclude_filter} --dry-run {path!r}')
+    rsync_output = ''
+    try:
+        rsync_output = str(subprocess.check_output(rsync_command, shell=True))
+    except subprocess.CalledProcessError:
+        logger.debug('Command failed, proceeding without estimating size: '
+                     f'{rsync_command}')
+        return -1
+    # 3.2.3:
+    #  total size is 250,957,728  speedup is 330.19 (DRY RUN)
+    # 2.6.9:
+    #  total size is 212627556  speedup is 2437.41
+    match = re.search(r'total size is ([\d,]+)', rsync_output)
+    if match is not None:
+        try:
+            total_bytes = int(float(match.group(1).replace(',', '')))
+            return total_bytes // (1024**2)
+        except ValueError:
+            logger.debug('Failed to find "total size" in rsync output. Inspect '
+                         f'output of the following command: {rsync_command}')
+            pass  # Maybe different rsync versions have different output.
+    return -1
 
 
 class FileMountHelper(object):
     """Helper for handling file mounts."""
 
     @classmethod
     def wrap_file_mount(cls, path: str) -> str:
@@ -1028,14 +1053,18 @@
         config = auth.setup_gcp_authentication(config)
     elif isinstance(cloud, clouds.Azure):
         config = auth.setup_azure_authentication(config)
     elif isinstance(cloud, clouds.Lambda):
         config = auth.setup_lambda_authentication(config)
     elif isinstance(cloud, clouds.IBM):
         config = auth.setup_ibm_authentication(config)
+    elif isinstance(cloud, clouds.SCP):
+        config = auth.setup_scp_authentication(config)
+    elif isinstance(cloud, clouds.OCI):
+        config = auth.setup_oci_authentication(config)
     else:
         assert isinstance(cloud, clouds.Local), cloud
         # Local cluster case, authentication is already filled by the user
         # in the local cluster config (in ~/.sky/local/...). There is no need
         # for Sky to generate authentication.
         pass
     common_utils.dump_yaml(cluster_config_file, config)
@@ -1223,20 +1252,23 @@
 
     def _sync_node(runner: 'command_runner.SSHCommandRunner') -> None:
         if cmd is not None:
             rc, stdout, stderr = runner.run(cmd,
                                             log_path=log_path,
                                             stream_logs=stream_logs,
                                             require_outputs=True)
-            subprocess_utils.handle_returncode(
-                rc,
-                cmd, ('Failed to run command before rsync '
-                      f'{origin_source} -> {target}. '
-                      'Ensure that the network is stable, then retry.'),
-                stderr=stdout + stderr)
+            err_msg = ('Failed to run command before rsync '
+                       f'{origin_source} -> {target}. '
+                       'Ensure that the network is stable, then retry.')
+            if log_path != os.devnull:
+                err_msg += f' See logs in {log_path}'
+            subprocess_utils.handle_returncode(rc,
+                                               cmd,
+                                               err_msg,
+                                               stderr=stdout + stderr)
 
         if run_rsync:
             assert source is not None
             # TODO(zhwu): Optimize for large amount of files.
             # zip / transfer / unzip
             runner.rsync(
                 source=source,
@@ -1522,29 +1554,32 @@
 
     return all_ips
 
 
 @timeline.event
 def get_head_ip(
     handle: 'cloud_vm_ray_backend.CloudVmRayResourceHandle',
-    use_cached_head_ip: bool = True,
     max_attempts: int = 1,
 ) -> str:
-    """Returns the ip of the head node."""
-    if use_cached_head_ip:
-        if handle.head_ip is None:
-            # This happens for INIT clusters (e.g., exit 1 in setup).
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(
-                    'Cluster\'s head IP not found; is it up? To fix: '
-                    'run a successful launch first (`sky launch`) to ensure'
-                    ' the cluster status is UP (`sky status`).')
-        head_ip = handle.head_ip
-    else:
-        head_ip = _query_head_ip_with_retries(handle.cluster_yaml, max_attempts)
+    """Returns the ip of the head node.
+
+    First try to use the cached head ip. If it is not available, query
+    the head ip from the cluster.
+
+    Args:
+        handle: The ResourceHandle of the cluster.
+        max_attempts: The maximum number of attempts to query the head ip.
+
+    Returns:
+        The ip of the head node.
+    """
+    head_ip = handle.head_ip
+    if head_ip is not None:
+        return head_ip
+    head_ip = _query_head_ip_with_retries(handle.cluster_yaml, max_attempts)
     return head_ip
 
 
 def check_network_connection():
     # Tolerate 3 retries as it is observed that connections can fail.
     adapter = adapters.HTTPAdapter(max_retries=retry_lib.Retry(total=3))
     http = requests.Session()
@@ -1556,293 +1591,14 @@
             return
         except (requests.Timeout, requests.exceptions.ConnectionError) as e:
             if i == len(_TEST_IP_LIST) - 1:
                 raise exceptions.NetworkError('Could not refresh the cluster. '
                                               'Network seems down.') from e
 
 
-def _process_cli_query(
-    cloud: str,
-    cluster: str,
-    query_cmd: str,
-    deliminator: str,
-    status_map: Mapping[str, Optional[global_user_state.ClusterStatus]],
-    max_retries: int = 3,
-) -> List[global_user_state.ClusterStatus]:
-    """Run the cloud CLI query and returns cluster status.
-
-    Args:
-        cloud: The cloud provider name.
-        cluster: The cluster name.
-        query_cmd: The cloud CLI query command.
-        deliminator: The deliminator separating the status in the output
-            of the query command.
-        status_map: A map from the CLI status string to the corresponding
-            global_user_state.ClusterStatus.
-        max_retries: Maximum number of retries before giving up. For AWS only.
-
-    Returns:
-        A list of global_user_state.ClusterStatus of all existing nodes in the
-        cluster. The list can be empty if none of the nodes in the clusters are
-        found, i.e. the nodes are all terminated.
-    """
-    returncode, stdout, stderr = log_lib.run_with_log(query_cmd,
-                                                      '/dev/null',
-                                                      require_outputs=True,
-                                                      shell=True)
-    logger.debug(f'{query_cmd} returned {returncode}.\n'
-                 '**** STDOUT ****\n'
-                 f'{stdout}\n'
-                 '**** STDERR ****\n'
-                 f'{stderr}')
-
-    # Cloud-specific error handling.
-    if (cloud == str(clouds.Azure()) and returncode == 2 and
-            'argument --ids: expected at least one argument' in stderr):
-        # Azure CLI has a returncode 2 when the cluster is not found, as
-        # --ids <empty> is passed to the query command. In that case, the
-        # cluster should be considered as DOWN.
-        return []
-    if (cloud == str(clouds.AWS()) and returncode != 0 and
-            'Unable to locate credentials. You can configure credentials by '
-            'running "aws configure"' in stdout + stderr):
-        # AWS: has run into this rare error with spot controller (which has an
-        # assumed IAM role and is working fine most of the time).
-        #
-        # We do not know the root cause. For now, the hypothesis is instance
-        # metadata service is temporarily unavailable. So, we retry the query.
-        if max_retries > 0:
-            logger.info('Encountered AWS "Unable to locate credentials" '
-                        'error. Retrying.')
-            time.sleep(random.uniform(0, 1) * 2)
-            return _process_cli_query(cloud, cluster, query_cmd, deliminator,
-                                      status_map, max_retries - 1)
-
-    if returncode != 0:
-        with ux_utils.print_exception_no_traceback():
-            raise exceptions.ClusterStatusFetchingError(
-                f'Failed to query {cloud} cluster {cluster!r} status: '
-                f'{stdout + stderr}')
-
-    cluster_status = stdout.strip()
-    if cluster_status == '':
-        return []
-
-    statuses = []
-    for s in cluster_status.split(deliminator):
-        node_status = status_map[s]
-        if node_status is not None:
-            statuses.append(node_status)
-    return statuses
-
-
-def _query_status_aws(
-    cluster: str,
-    ray_config: Dict[str, Any],
-) -> List[global_user_state.ClusterStatus]:
-    status_map = {
-        'pending': global_user_state.ClusterStatus.INIT,
-        'running': global_user_state.ClusterStatus.UP,
-        # TODO(zhwu): stopping and shutting-down could occasionally fail
-        # due to internal errors of AWS. We should cover that case.
-        'stopping': global_user_state.ClusterStatus.STOPPED,
-        'stopped': global_user_state.ClusterStatus.STOPPED,
-        'shutting-down': None,
-        'terminated': None,
-    }
-    region = ray_config['provider']['region']
-    query_cmd = ('aws ec2 describe-instances --filters '
-                 f'Name=tag:ray-cluster-name,Values={cluster} '
-                 f'--region {region} '
-                 '--query "Reservations[].Instances[].State.Name" '
-                 '--output text')
-    return _process_cli_query('AWS', cluster, query_cmd, '\t', status_map)
-
-
-def _query_status_gcp(
-    cluster: str,
-    ray_config: Dict[str, Any],
-) -> List[global_user_state.ClusterStatus]:
-    # Note: we use ":" for filtering labels for gcloud, as the latest gcloud (v393.0)
-    # fails to filter labels with "=".
-    # Reference: https://cloud.google.com/sdk/gcloud/reference/topic/filters
-
-    use_tpu_vm = ray_config['provider'].get('_has_tpus', False)
-    zone = ray_config['provider'].get('availability_zone', '')
-    if use_tpu_vm:
-        # TPU VM's state definition is different from compute VM
-        # https://cloud.google.com/tpu/docs/reference/rest/v2alpha1/projects.locations.nodes#State # pylint: disable=line-too-long
-        status_map = {
-            'CREATING': global_user_state.ClusterStatus.INIT,
-            'STARTING': global_user_state.ClusterStatus.INIT,
-            'RESTARTING': global_user_state.ClusterStatus.INIT,
-            'READY': global_user_state.ClusterStatus.UP,
-            'REPAIRING': global_user_state.ClusterStatus.INIT,
-            # 'STOPPED' in GCP TPU VM means stopped, with disk preserved.
-            'STOPPING': global_user_state.ClusterStatus.STOPPED,
-            'STOPPED': global_user_state.ClusterStatus.STOPPED,
-            'DELETING': None,
-            'PREEMPTED': None,
-        }
-        tpu_utils.check_gcp_cli_include_tpu_vm()
-        query_cmd = ('gcloud compute tpus tpu-vm list '
-                     f'--zone {zone} '
-                     f'--filter="(labels.ray-cluster-name={cluster})" '
-                     '--format="value(state)"')
-    else:
-        # Ref: https://cloud.google.com/compute/docs/instances/instance-life-cycle
-        status_map = {
-            'PROVISIONING': global_user_state.ClusterStatus.INIT,
-            'STAGING': global_user_state.ClusterStatus.INIT,
-            'RUNNING': global_user_state.ClusterStatus.UP,
-            'REPAIRING': global_user_state.ClusterStatus.INIT,
-            # 'TERMINATED' in GCP means stopped, with disk preserved.
-            'STOPPING': global_user_state.ClusterStatus.STOPPED,
-            'TERMINATED': global_user_state.ClusterStatus.STOPPED,
-            # 'SUSPENDED' in GCP means stopped, with disk and OS memory
-            # preserved.
-            'SUSPENDING': global_user_state.ClusterStatus.STOPPED,
-            'SUSPENDED': global_user_state.ClusterStatus.STOPPED,
-        }
-        # TODO(zhwu): The status of the TPU attached to the cluster should also
-        # be checked, since TPUs are not part of the VMs.
-        query_cmd = ('gcloud compute instances list '
-                     f'--filter="(labels.ray-cluster-name={cluster})" '
-                     '--format="value(status)"')
-    status_list = _process_cli_query('GCP', cluster, query_cmd, '\n',
-                                     status_map)
-
-    # GCP does not clean up preempted TPU VMs. We remove it ourselves.
-    # TODO(wei-lin): handle multi-node cases.
-    if use_tpu_vm and len(status_list) == 0:
-        logger.debug(f'Terminating preempted TPU VM cluster {cluster}')
-        backend = backends.CloudVmRayBackend()
-        handle = global_user_state.get_handle_from_cluster_name(cluster)
-        assert isinstance(handle,
-                          backends.CloudVmRayResourceHandle), (cluster, handle)
-        # Do not use refresh cluster status during teardown, as that will
-        # cause inifinite recursion by calling cluster status refresh
-        # again.
-        # The caller of this function, `_update_cluster_status_no_lock() ->
-        # _get_cluster_status_via_cloud_cli()`, will do the post teardown
-        # cleanup, which will remove the cluster entry from the status table
-        # & the ssh config file.
-        backend.teardown_no_lock(handle,
-                                 terminate=True,
-                                 purge=False,
-                                 post_teardown_cleanup=False,
-                                 refresh_cluster_status=False)
-    return status_list
-
-
-def _query_status_azure(
-    cluster: str,
-    ray_config: Dict[str, Any],
-) -> List[global_user_state.ClusterStatus]:
-    del ray_config  # Unused.
-    status_map = {
-        'VM starting': global_user_state.ClusterStatus.INIT,
-        'VM running': global_user_state.ClusterStatus.UP,
-        # 'VM stopped' in Azure means Stopped (Allocated), which still bills
-        # for the VM.
-        'VM stopping': global_user_state.ClusterStatus.INIT,
-        'VM stopped': global_user_state.ClusterStatus.INIT,
-        # 'VM deallocated' in Azure means Stopped (Deallocated), which does not
-        # bill for the VM.
-        'VM deallocating': global_user_state.ClusterStatus.STOPPED,
-        'VM deallocated': global_user_state.ClusterStatus.STOPPED,
-    }
-    query_cmd = ('az vm show -d --ids $(az vm list --query '
-                 f'"[?tags.\\"ray-cluster-name\\" == \'{cluster}\'].id" '
-                 '-o tsv) --query "powerState" -o tsv')
-    # NOTE: Azure cli should be handled carefully. The query command above
-    # takes about 1 second to run.
-    # An alternative is the following command, but it will take more than
-    # 20 seconds to run.
-    # query_cmd = (
-    #     f'az vm list --show-details --query "['
-    #     f'?tags.\\"ray-cluster-name\\" == \'{handle.cluster_name}\' '
-    #     '&& tags.\\"ray-node-type\\" == \'head\'].powerState" -o tsv'
-    # )
-    return _process_cli_query('Azure', cluster, query_cmd, '\t', status_map)
-
-
-def _query_status_ibm(
-    cluster: str,
-    ray_config: Dict[str, Any],
-) -> List[global_user_state.ClusterStatus]:
-    """
-    returns a list of Statuses for each of the cluster's nodes.
-    this function gets called when running `sky status` with -r flag and the cluster's head node is either stopped or down.
-    """
-
-    status_map: Dict[str, Any] = {
-        'pending': global_user_state.ClusterStatus.INIT,
-        'starting': global_user_state.ClusterStatus.INIT,
-        'restarting': global_user_state.ClusterStatus.INIT,
-        'running': global_user_state.ClusterStatus.UP,
-        'stopping': global_user_state.ClusterStatus.STOPPED,
-        'stopped': global_user_state.ClusterStatus.STOPPED,
-        'deleting': None,
-        'failed': global_user_state.ClusterStatus.INIT,
-        'cluster_deleted': []
-    }
-
-    client = ibm.client(region=ray_config['provider']['region'])
-    search_client = ibm.search_client()
-    # pylint: disable=E1136
-    vpcs_filtered_by_tags_and_region = search_client.search(
-        query=
-        f'type:vpc AND tags:{cluster} AND region:{ray_config["provider"]["region"]}',
-        fields=['tags', 'region', 'type'],
-        limit=1000).get_result()['items']
-    if not vpcs_filtered_by_tags_and_region:
-        # a vpc could have been removed unkownlingly to skypilot, such as
-        # via `sky autostop --down`, or simply manually (e.g. via console).
-        logger.warning('No vpc exists in '
-                       f'{ray_config["provider"]["region"]} '
-                       f'with tag: {cluster}')
-        return status_map['cluster_deleted']
-    vpc_id = vpcs_filtered_by_tags_and_region[0]['crn'].rsplit(':', 1)[-1]
-    instances = client.list_instances(vpc_id=vpc_id).get_result()['instances']
-
-    return [status_map[instance['status']] for instance in instances]
-
-
-def _query_status_lambda(
-        cluster: str,
-        ray_config: Dict[str, Any],  # pylint: disable=unused-argument
-) -> List[global_user_state.ClusterStatus]:
-    status_map = {
-        'booting': global_user_state.ClusterStatus.INIT,
-        'active': global_user_state.ClusterStatus.UP,
-        'unhealthy': global_user_state.ClusterStatus.INIT,
-        'terminated': None,
-    }
-    # TODO(ewzeng): filter by hash_filter_string to be safe
-    status_list = []
-    vms = lambda_utils.LambdaCloudClient().list_instances()
-    possible_names = [f'{cluster}-head', f'{cluster}-worker']
-    for node in vms:
-        if node.get('name') in possible_names:
-            node_status = status_map[node['status']]
-            if node_status is not None:
-                status_list.append(node_status)
-    return status_list
-
-
-_QUERY_STATUS_FUNCS = {
-    'AWS': _query_status_aws,
-    'GCP': _query_status_gcp,
-    'Azure': _query_status_azure,
-    'Lambda': _query_status_lambda,
-    'IBM': _query_status_ibm,
-}
-
-
 def check_owner_identity(cluster_name: str) -> None:
     """Check if current user is the same as the user who created the cluster.
 
     Raises:
         exceptions.ClusterOwnerIdentityMismatchError: if the current user is
           not the same as the user who created the cluster.
         exceptions.CloudUserIdentityError: if we fail to get the current user
@@ -1905,96 +1661,228 @@
         with ux_utils.print_exception_no_traceback():
             raise exceptions.ClusterOwnerIdentityMismatchError(
                 f'{cluster_name!r} ({cloud}) is owned by account '
                 f'{owner_identity!r}, but the activated account '
                 f'is {current_user_identity!r}.')
 
 
-def _get_cluster_status_via_cloud_cli(
+def tag_filter_for_cluster(cluster_name: str) -> Dict[str, str]:
+    """Returns a tag filter for the cluster."""
+    return {
+        'ray-cluster-name': cluster_name,
+    }
+
+
+def _query_cluster_status_via_cloud_api(
     handle: 'cloud_vm_ray_backend.CloudVmRayResourceHandle'
-) -> List[global_user_state.ClusterStatus]:
+) -> List[status_lib.ClusterStatus]:
     """Returns the status of the cluster."""
-    resources: sky.Resources = handle.launched_resources
-    cloud = resources.cloud
+    cluster_name = handle.cluster_name
+    # Use region and zone from the cluster config, instead of the
+    # handle.launched_resources, because the latter may not be set
+    # correctly yet.
     ray_config = common_utils.read_yaml(handle.cluster_yaml)
-    return _QUERY_STATUS_FUNCS[str(cloud)](handle.cluster_name, ray_config)
+    provider_config = ray_config['provider']
+    region = provider_config.get('region') or provider_config.get('location')
+    zone = ray_config['provider'].get('availability_zone')
+    kwargs = {}
+    if isinstance(handle.launched_resources.cloud, clouds.GCP):
+        kwargs['use_tpu_vm'] = ray_config['provider'].get('_has_tpus', False)
+
+    # Query the cloud provider.
+    node_statuses = handle.launched_resources.cloud.query_status(
+        cluster_name, tag_filter_for_cluster(cluster_name), region, zone,
+        **kwargs)
+    # GCP does not clean up preempted TPU VMs. We remove it ourselves.
+    # TODO(wei-lin): handle multi-node cases.
+    # TODO(zhwu): this should be moved into the GCP class, after we refactor
+    # the cluster termination, as the preempted TPU VM should always be
+    # removed.
+    if kwargs.get('use_tpu_vm', False) and len(node_statuses) == 0:
+        logger.debug(f'Terminating preempted TPU VM cluster {cluster_name}')
+        backend = backends.CloudVmRayBackend()
+        # Do not use refresh cluster status during teardown, as that will
+        # cause infinite recursion by calling cluster status refresh
+        # again.
+
+        # Post teardown cleanup be done later in this function, which will
+        # remove the cluster entry from the status table & the ssh config file.
+        backend.teardown_no_lock(handle,
+                                 terminate=True,
+                                 purge=False,
+                                 post_teardown_cleanup=False,
+                                 refresh_cluster_status=False)
+    return node_statuses
+
+
+def check_can_clone_disk_and_override_task(
+    cluster_name: str, target_cluster_name: Optional[str], task: 'task_lib.Task'
+) -> Tuple['task_lib.Task', 'cloud_vm_ray_backend.CloudVmRayResourceHandle']:
+    """Check if the task is compatible to clone disk from the source cluster.
+
+    Args:
+        cluster_name: The name of the cluster to clone disk from.
+        target_cluster_name: The name of the target cluster.
+        task: The task to check.
+
+    Returns:
+        The task to use and the resource handle of the source cluster.
+
+    Raises:
+        ValueError: If the source cluster does not exist.
+        exceptions.NotSupportedError: If the source cluster is not valid or the
+            task is not compatible to clone disk from the source cluster.
+    """
+    source_cluster_status, handle = refresh_cluster_status_handle(cluster_name)
+    if source_cluster_status is None:
+        with ux_utils.print_exception_no_traceback():
+            raise ValueError(
+                f'Cannot find cluster {cluster_name!r} to clone disk from.')
+
+    if not isinstance(handle, backends.CloudVmRayResourceHandle):
+        with ux_utils.print_exception_no_traceback():
+            raise exceptions.NotSupportedError(
+                f'Cannot clone disk from a non-cloud cluster {cluster_name!r}.')
+
+    if source_cluster_status != status_lib.ClusterStatus.STOPPED:
+        with ux_utils.print_exception_no_traceback():
+            raise exceptions.NotSupportedError(
+                f'Cannot clone disk from cluster {cluster_name!r} '
+                f'({source_cluster_status!r}). Please stop the '
+                f'cluster first: sky stop {cluster_name}')
+
+    if target_cluster_name is not None:
+        target_cluster_status, _ = refresh_cluster_status_handle(
+            target_cluster_name)
+        if target_cluster_status is not None:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.NotSupportedError(
+                    f'The target cluster {target_cluster_name!r} already exists. Cloning '
+                    'disk is only supported when creating a new cluster. To fix: specify '
+                    'a new target cluster name.')
+
+    assert len(task.resources) == 1, task.resources
+    task_resources = list(task.resources)[0]
+    if handle.launched_resources.disk_size > task_resources.disk_size:
+        # The target cluster's disk should be at least as large as the source.
+        with ux_utils.print_exception_no_traceback():
+            target_cluster_name_str = f' {target_cluster_name!r}'
+            if target_cluster_name is None:
+                target_cluster_name_str = ''
+            raise exceptions.NotSupportedError(
+                f'The target cluster{target_cluster_name_str} should have a disk size '
+                f'of at least {handle.launched_resources.disk_size} GB to clone the '
+                f'disk from {cluster_name!r}.')
+    override_param = {}
+    original_cloud = handle.launched_resources.cloud
+    assert original_cloud is not None, handle.launched_resources
+    if task_resources.cloud is None:
+        override_param['cloud'] = original_cloud
+    else:
+        if not original_cloud.is_same_cloud(task_resources.cloud):
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    f'Cannot clone disk across cloud from {original_cloud} to '
+                    f'{task_resources.cloud}.')
+    original_cloud.check_features_are_supported(
+        {clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER})
+
+    if task_resources.region is None:
+        override_param['region'] = handle.launched_resources.region
+
+    if override_param:
+        logger.info(
+            f'No cloud/region specified for the task. Using the same region '
+            f'as source cluster {cluster_name!r}: '
+            f'{handle.launched_resources.cloud}'
+            f'({handle.launched_resources.region}).')
+        task_resources = task_resources.copy(**override_param)
+        task.set_resources({task_resources})
+        # Reset the best_resources to triger re-optimization
+        # later, so that the new task_resources will be used.
+        task.best_resources = None
+    return task, handle
 
 
 def _update_cluster_status_no_lock(
         cluster_name: str) -> Optional[Dict[str, Any]]:
     record = global_user_state.get_cluster_from_name(cluster_name)
     if record is None:
         return None
     handle = record['handle']
     if not isinstance(handle, backends.CloudVmRayResourceHandle):
         return record
-
     cluster_name = handle.cluster_name
-    use_spot = handle.launched_resources.use_spot
-    ray_cluster_up = False
-    try:
-        # TODO(zhwu): This function cannot distinguish transient network error
-        # in ray's get IPs vs. ray runtime failing.
-        external_ips = handle.external_ips(use_cached_ips=False)
-        # This happens to a stopped TPU VM as we use gcloud to query the IP.
-        if external_ips is None or len(external_ips) == 0:
-            raise exceptions.FetchIPError(
-                reason=exceptions.FetchIPError.Reason.HEAD)
-        # Check if ray cluster status is healthy.
-        ssh_credentials = ssh_credential_from_yaml(handle.cluster_yaml)
-        runner = command_runner.SSHCommandRunner(external_ips[0],
-                                                 **ssh_credentials)
-        rc, output, _ = runner.run(RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND,
-                                   stream_logs=False,
-                                   require_outputs=True,
-                                   separate_stderr=True)
-        if rc:
-            raise exceptions.FetchIPError(
-                reason=exceptions.FetchIPError.Reason.HEAD)
 
-        ready_head, ready_workers = _count_healthy_nodes_from_ray(output)
+    node_statuses = _query_cluster_status_via_cloud_api(handle)
 
-        if ready_head + ready_workers == handle.launched_nodes:
-            ray_cluster_up = True
+    all_nodes_up = (all(
+        status == status_lib.ClusterStatus.UP for status in node_statuses) and
+                    len(node_statuses) == handle.launched_nodes)
 
-        # For non-spot clusters:
-        # If ray status shows all nodes are healthy, it is safe to set
-        # the status to UP as starting ray is the final step of sky launch.
-        # For spot clusters, the above can be unsafe because the Ray cluster
-        # may remain healthy for a while before the cloud completely
-        # preempts the VMs.
-        # Additionally, we query the VM state from the cloud provider.
-        if ray_cluster_up and not use_spot:
-            record['status'] = global_user_state.ClusterStatus.UP
-            global_user_state.add_or_update_cluster(cluster_name,
-                                                    handle,
-                                                    requested_resources=None,
-                                                    ready=True,
-                                                    is_launch=False)
-            return record
-    except exceptions.FetchIPError:
-        logger.debug('Refreshing status: Failed to get IPs from cluster '
-                     f'{cluster_name!r}, trying to fetch from provider.')
-    # For all code below, we query cluster status by cloud CLI for two cases:
-    # 1) ray fails to get IPs for the cluster.
-    # 2) the cluster is a spot cluster.
-    node_statuses = _get_cluster_status_via_cloud_cli(handle)
+    def run_ray_status_to_check_ray_cluster_healthy() -> bool:
+        try:
+            # TODO(zhwu): This function cannot distinguish transient network
+            # error in ray's get IPs vs. ray runtime failing.
+            #
+            # NOTE: using use_cached_ips=False is very slow as it calls into
+            # `ray get head-ip/worker-ips`. Setting it to True is safe because
+            # in the worst case we time out in the `ray status` SSH command
+            # below.
+            external_ips = handle.external_ips(use_cached_ips=True)
+            # This happens to a stopped TPU VM as we use gcloud to query the IP.
+            if external_ips is None or len(external_ips) == 0:
+                raise exceptions.FetchIPError(
+                    reason=exceptions.FetchIPError.Reason.HEAD)
+            # Check if ray cluster status is healthy.
+            ssh_credentials = ssh_credential_from_yaml(handle.cluster_yaml)
+            runner = command_runner.SSHCommandRunner(external_ips[0],
+                                                     **ssh_credentials)
+            rc, output, _ = runner.run(RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND,
+                                       stream_logs=False,
+                                       require_outputs=True,
+                                       separate_stderr=True)
+            if rc:
+                raise exceptions.FetchIPError(
+                    reason=exceptions.FetchIPError.Reason.HEAD)
 
-    all_nodes_up = (all(status == global_user_state.ClusterStatus.UP
-                        for status in node_statuses) and
-                    len(node_statuses) == handle.launched_nodes)
-    if ray_cluster_up and all_nodes_up:
-        record['status'] = global_user_state.ClusterStatus.UP
+            ready_head, ready_workers = _count_healthy_nodes_from_ray(output)
+            if ready_head + ready_workers == handle.launched_nodes:
+                return True
+        except exceptions.FetchIPError:
+            logger.debug(
+                'Refreshing status: Failed to use `ray` to get IPs from cluster'
+                f' {cluster_name!r}.')
+        return False
+
+    # Determining if the cluster is healthy (UP):
+    #
+    # For non-spot clusters: If ray status shows all nodes are healthy, it is
+    # safe to set the status to UP as starting ray is the final step of sky
+    # launch. But we found that ray status is way too slow (see NOTE below) so
+    # we always query the cloud provider first which is faster.
+    #
+    # For spot clusters: the above can be unsafe because the Ray cluster may
+    # remain healthy for a while before the cloud completely preempts the VMs.
+    # We have mitigated this by again first querying the VM state from the cloud
+    # provider.
+    if all_nodes_up and run_ray_status_to_check_ray_cluster_healthy():
+        # NOTE: all_nodes_up calculation is fast due to calling cloud CLI;
+        # run_ray_status_to_check_all_nodes_up() is slow due to calling `ray get
+        # head-ip/worker-ips`.
+        record['status'] = status_lib.ClusterStatus.UP
         global_user_state.add_or_update_cluster(cluster_name,
                                                 handle,
                                                 requested_resources=None,
                                                 ready=True,
                                                 is_launch=False)
         return record
 
+    # All cases below are transitioning the cluster to non-UP states.
+
     if len(node_statuses) > handle.launched_nodes:
         # Unexpected: in the queried region more than 1 cluster with the same
         # constructed name tag returned. This will typically not happen unless
         # users manually create a cluster with that constructed name or there
         # was a resource leak caused by different launch hash before #1671
         # was merged.
         #
@@ -2005,21 +1893,22 @@
         # now?)
         #
         # We have not experienced the above; adding as a safeguard.
         #
         # Since we failed to refresh, raise the status fetching error.
         with ux_utils.print_exception_no_traceback():
             raise exceptions.ClusterStatusFetchingError(
-                f'Found {len(node_statuses)} node(s) with the same cluster name tag in the '
-                f'cloud provider for cluster {cluster_name!r}, which should have '
-                f'{handle.launched_nodes} nodes. This normally should not happen. '
-                f'{colorama.Fore.RED}Please check the cloud console and fix any possible '
-                'resources leakage (e.g., if there are any stopped nodes and they do not '
-                f'have data or are unhealthy, terminate them).{colorama.Style.RESET_ALL}'
-            )
+                f'Found {len(node_statuses)} node(s) with the same cluster name'
+                f' tag in the cloud provider for cluster {cluster_name!r}, '
+                f'which should have {handle.launched_nodes} nodes. This '
+                f'normally should not happen. {colorama.Fore.RED}Please check '
+                'the cloud console and fix any possible resources leakage '
+                '(e.g., if there are any stopped nodes and they do not have '
+                'data or are unhealthy, terminate them).'
+                f'{colorama.Style.RESET_ALL}')
     assert len(node_statuses) <= handle.launched_nodes
 
     # If the node_statuses is empty, all the nodes are terminated. We can
     # safely set the cluster status to TERMINATED. This handles the edge case
     # where the cluster is terminated by the user manually through the UI.
     to_terminate = not node_statuses
 
@@ -2034,35 +1923,57 @@
     #     of the function.
     #   * Some of the nodes UP should be considered abnormal, because the ray
     #     cluster is probably down.
     #   * The cluster is partially terminated or stopped should be considered
     #     abnormal.
     #
     # An abnormal cluster will transition to INIT and have any autostop setting
-    # reset (unless it's autostopping/autodowning.).
-    is_abnormal = ((0 < len(node_statuses) < handle.launched_nodes) or
-                   any(status != global_user_state.ClusterStatus.STOPPED
-                       for status in node_statuses))
+    # reset (unless it's autostopping/autodowning).
+    is_abnormal = ((0 < len(node_statuses) < handle.launched_nodes) or any(
+        status != status_lib.ClusterStatus.STOPPED for status in node_statuses))
     if is_abnormal:
         backend = get_backend_from_handle(handle)
         if isinstance(backend,
                       backends.CloudVmRayBackend) and record['autostop'] >= 0:
             if not backend.is_definitely_autostopping(handle,
                                                       stream_logs=False):
                 # Reset the autostopping as the cluster is abnormal, and may
                 # not correctly autostop. Resetting the autostop will let
                 # the user know that the autostop may not happen to avoid
                 # leakages from the assumption that the cluster will autostop.
+                success = True
                 try:
                     backend.set_autostop(handle, -1, stream_logs=False)
                 except (Exception, SystemExit) as e:  # pylint: disable=broad-except
+                    success = False
                     logger.debug(f'Failed to reset autostop. Due to '
                                  f'{common_utils.format_exception(e)}')
                 global_user_state.set_cluster_autostop_value(
                     handle.cluster_name, -1, to_down=False)
+
+                # Friendly hint.
+                autostop = record['autostop']
+                maybe_down_str = ' --down' if record['to_down'] else ''
+                noun = 'autodown' if record['to_down'] else 'autostop'
+                if success:
+                    operation_str = (f'Canceled {noun} on the cluster '
+                                     f'{cluster_name!r}')
+                else:
+                    operation_str = (
+                        f'Attempted to cancel {noun} on the '
+                        f'cluster {cluster_name!r} with best effort')
+                yellow = colorama.Fore.YELLOW
+                bright = colorama.Style.BRIGHT
+                reset = colorama.Style.RESET_ALL
+                ux_utils.console_newline()
+                logger.warning(
+                    f'{yellow}{operation_str}, since it is found to be in an '
+                    f'abnormal state. To fix, try running: {reset}{bright}sky '
+                    f'start -f -i {autostop}{maybe_down_str} {cluster_name}'
+                    f'{reset}')
             else:
                 ux_utils.console_newline()
                 operation_str = 'autodowning' if record[
                     'to_down'] else 'autostopping'
                 logger.info(
                     f'Cluster {cluster_name!r} is {operation_str}. Setting to '
                     'INIT status; try refresh again in a while.')
@@ -2172,31 +2083,30 @@
     if record is None:
         return None
     check_owner_identity(cluster_name)
 
     handle = record['handle']
     if isinstance(handle, backends.CloudVmRayResourceHandle):
         use_spot = handle.launched_resources.use_spot
-        has_autostop = (
-            record['status'] != global_user_state.ClusterStatus.STOPPED and
-            record['autostop'] >= 0)
+        has_autostop = (record['status'] != status_lib.ClusterStatus.STOPPED and
+                        record['autostop'] >= 0)
         if force_refresh or has_autostop or use_spot:
             record = _update_cluster_status(
                 cluster_name,
                 acquire_per_cluster_status_lock=acquire_per_cluster_status_lock)
     return record
 
 
 @timeline.event
 def refresh_cluster_status_handle(
     cluster_name: str,
     *,
     force_refresh: bool = False,
     acquire_per_cluster_status_lock: bool = True,
-) -> Tuple[Optional[global_user_state.ClusterStatus],
+) -> Tuple[Optional[status_lib.ClusterStatus],
            Optional[backends.ResourceHandle]]:
     """Refresh the cluster, and return the possibly updated status and handle.
 
     This is a wrapper of refresh_cluster_record, which returns the status and
     handle of the cluster.
     Please refer to the docstring of refresh_cluster_record for the details.
     """
@@ -2205,14 +2115,17 @@
         force_refresh=force_refresh,
         acquire_per_cluster_status_lock=acquire_per_cluster_status_lock)
     if record is None:
         return None, None
     return record['status'], record['handle']
 
 
+# =====================================
+
+
 @typing.overload
 def check_cluster_available(
     cluster_name: str,
     *,
     operation: str,
     check_cloud_vm_ray_backend: Literal[True] = True,
 ) -> 'cloud_vm_ray_backend.CloudVmRayResourceHandle':
@@ -2283,33 +2196,33 @@
             backend, backends.CloudVmRayBackend):
         with ux_utils.print_exception_no_traceback():
             raise exceptions.NotSupportedError(
                 f'{colorama.Fore.YELLOW}{operation.capitalize()}: skipped for '
                 f'cluster {cluster_name!r}. It is only supported by backend: '
                 f'{backends.CloudVmRayBackend.NAME}.'
                 f'{reset}')
-    if cluster_status != global_user_state.ClusterStatus.UP:
+    if cluster_status != status_lib.ClusterStatus.UP:
         if onprem_utils.check_if_local_cloud(cluster_name):
             raise exceptions.ClusterNotUpError(
                 constants.UNINITIALIZED_ONPREM_CLUSTER_MESSAGE.format(
                     cluster_name),
                 cluster_status=cluster_status,
                 handle=handle)
         with ux_utils.print_exception_no_traceback():
             hint_for_init = ''
-            if cluster_status == global_user_state.ClusterStatus.INIT:
+            if cluster_status == status_lib.ClusterStatus.INIT:
                 hint_for_init = (
                     f'{reset} Wait for a launch to finish, or use this command '
                     f'to try to transition the cluster to UP: {bright}sky '
                     f'start {cluster_name}{reset}')
             raise exceptions.ClusterNotUpError(
                 f'{colorama.Fore.YELLOW}{operation.capitalize()}: skipped for '
                 f'cluster {cluster_name!r} (status: {cluster_status.value}). '
                 'It is only allowed for '
-                f'{global_user_state.ClusterStatus.UP.value} clusters.'
+                f'{status_lib.ClusterStatus.UP.value} clusters.'
                 f'{hint_for_init}'
                 f'{reset}',
                 cluster_status=cluster_status,
                 handle=handle)
 
     if handle.head_ip is None:
         with ux_utils.print_exception_no_traceback():
@@ -2578,30 +2491,46 @@
     print(f'{colorama.Style.DIM}Tip: The job will keep '
           f'running after Ctrl-Z.{colorama.Style.RESET_ALL}')
     with ux_utils.print_exception_no_traceback():
         raise KeyboardInterrupt(exceptions.SIGTSTP_CODE)
 
 
 def validate_schema(obj, schema, err_msg_prefix=''):
+    """Validates an object against a JSON schema.
+
+    Raises:
+        ValueError: if the object does not match the schema.
+    """
     err_msg = None
     try:
         validator.SchemaValidator(schema).validate(obj)
     except jsonschema.ValidationError as e:
         if e.validator == 'additionalProperties':
-            err_msg = err_msg_prefix + 'The following fields are invalid:'
-            known_fields = set(e.schema.get('properties', {}).keys())
-            for field in e.instance:
-                if field not in known_fields:
-                    most_similar_field = difflib.get_close_matches(
-                        field, known_fields, 1)
-                    if most_similar_field:
-                        err_msg += (f'\nInstead of {field!r}, did you mean '
-                                    f'{most_similar_field[0]!r}?')
-                    else:
-                        err_msg += f'\nFound unsupported field {field!r}.'
+            if tuple(e.schema_path) == ('properties', 'envs',
+                                        'additionalProperties'):
+                # Hack. Here the error is Task.envs having some invalid keys. So
+                # we should not print "unsupported field".
+                #
+                # This will print something like:
+                # 'hello world' does not match any of the regexes: <regex>
+                err_msg = (err_msg_prefix +
+                           'The `envs` field contains invalid keys:\n' +
+                           e.message)
+            else:
+                err_msg = err_msg_prefix + 'The following fields are invalid:'
+                known_fields = set(e.schema.get('properties', {}).keys())
+                for field in e.instance:
+                    if field not in known_fields:
+                        most_similar_field = difflib.get_close_matches(
+                            field, known_fields, 1)
+                        if most_similar_field:
+                            err_msg += (f'\nInstead of {field!r}, did you mean '
+                                        f'{most_similar_field[0]!r}?')
+                        else:
+                            err_msg += f'\nFound unsupported field {field!r}.'
         else:
             # Example e.json_path value: '$.resources'
             err_msg = (err_msg_prefix + e.message +
                        f'. Check problematic field(s): {e.json_path}')
 
     if err_msg:
         with ux_utils.print_exception_no_traceback():
```

### Comparing `skypilot-0.3.1/sky/backends/cloud_vm_ray_backend.py` & `skypilot-0.3.2/sky/backends/cloud_vm_ray_backend.py`

 * *Files 1% similar despite different names*

```diff
@@ -28,14 +28,15 @@
 from sky import exceptions
 from sky import global_user_state
 from sky import resources as resources_lib
 from sky import sky_logging
 from sky import optimizer
 from sky import skypilot_config
 from sky import spot as spot_lib
+from sky import status_lib
 from sky import task as task_lib
 from sky.data import data_utils
 from sky.data import storage as storage_lib
 from sky.backends import backend_utils
 from sky.backends import onprem_utils
 from sky.backends import wheel_utils
 from sky.skylet import autostop_lib
@@ -46,14 +47,15 @@
 from sky.utils import common_utils
 from sky.utils import command_runner
 from sky.utils import log_utils
 from sky.utils import subprocess_utils
 from sky.utils import timeline
 from sky.utils import tpu_utils
 from sky.utils import ux_utils
+from sky.skylet.providers.scp.node_provider import SCPNodeProvider, SCPError
 
 if typing.TYPE_CHECKING:
     from sky import dag
 
 Path = str
 
 SKY_REMOTE_APP_DIR = backend_utils.SKY_REMOTE_APP_DIR
@@ -68,14 +70,15 @@
 _NODES_LAUNCHING_PROGRESS_TIMEOUT = {
     clouds.AWS: 90,
     clouds.Azure: 90,
     clouds.GCP: 120,
     clouds.Lambda: 150,
     clouds.IBM: 160,
     clouds.Local: 90,
+    clouds.OCI: 300,
 }
 
 # Time gap between retries after failing to provision in all possible places.
 # Used only if --retry-until-up is set.
 _RETRY_UNTIL_UP_INIT_GAP_SECONDS = 60
 
 # The maximum retry count for fetching IP address.
@@ -113,23 +116,28 @@
 # Path to the monkey-patched ray up script.
 # We don't do import then __file__ because that script needs to be filled in
 # (so import would fail).
 _RAY_UP_WITH_MONKEY_PATCHED_HASH_LAUNCH_CONF_PATH = (
     pathlib.Path(sky.__file__).resolve().parent / 'backends' /
     'monkey_patches' / 'monkey_patch_ray_up.py')
 
+# Restart skylet when the version does not match to keep the skylet up-to-date.
+_MAYBE_SKYLET_RESTART_CMD = 'python3 -m sky.skylet.attempt_skylet'
+
 
 def _get_cluster_config_template(cloud):
     cloud_to_template = {
         clouds.AWS: 'aws-ray.yml.j2',
         clouds.Azure: 'azure-ray.yml.j2',
         clouds.GCP: 'gcp-ray.yml.j2',
         clouds.Lambda: 'lambda-ray.yml.j2',
         clouds.IBM: 'ibm-ray.yml.j2',
         clouds.Local: 'local-ray.yml.j2',
+        clouds.SCP: 'scp-ray.yml.j2',
+        clouds.OCI: 'oci-ray.yml.j2',
     }
     return cloud_to_template[type(cloud)]
 
 
 def write_ray_up_script_with_patched_launch_hash_fn(
     cluster_config_path: str,
     ray_up_kwargs: Dict[str, bool],
@@ -187,24 +195,19 @@
         # and monotonically increasing starting from 1.
         # To generate the job ID, we use the following logic:
         #   code = job_lib.JobLibCodeGen.add_job(username,
         #                                              run_timestamp)
         #   job_id = get_output(run_on_cluster(code))
         self.job_id = None
 
-    def add_prologue(self,
-                     job_id: int,
-                     spot_task: Optional['task_lib.Task'] = None,
-                     setup_cmd: Optional[str] = None,
-                     envs: Optional[Dict[str, str]] = None,
-                     setup_log_path: Optional[str] = None,
-                     is_local: bool = False) -> None:
+    def add_prologue(self, job_id: int, is_local: bool = False) -> None:
         assert not self._has_prologue, 'add_prologue() called twice?'
         self._has_prologue = True
         self.job_id = job_id
+        self.is_local = is_local
         # Should use 'auto' or 'ray://<internal_head_ip>:10001' rather than
         # 'ray://localhost:10001', or 'ray://127.0.0.1:10001', for public cloud.
         # Otherwise, ray will fail to get the placement group because of a bug
         # in ray job.
         # TODO(mluo): Check why 'auto' not working with on-prem cluster and
         # whether the placement group issue also occurs in on-prem cluster.
         ray_address = 'ray://localhost:10001' if is_local else 'auto'
@@ -246,98 +249,55 @@
             )
             run_fn = None
             futures = []
             """),
             # FIXME: This is a hack to make sure that the functions can be found
             # by ray.remote. This should be removed once we have a better way to
             # specify dependencies for ray.
+            inspect.getsource(log_lib._ProcessingArgs),  # pylint: disable=protected-access
+            inspect.getsource(log_lib._handle_io_stream),  # pylint: disable=protected-access
             inspect.getsource(log_lib.process_subprocess_stream),
             inspect.getsource(log_lib.run_with_log),
             inspect.getsource(log_lib.make_task_bash_script),
             inspect.getsource(log_lib.add_ray_env_vars),
             inspect.getsource(log_lib.run_bash_command_with_log),
             'run_bash_command_with_log = ray.remote(run_bash_command_with_log)',
-            f'setup_cmd = {setup_cmd!r}',
         ]
         # Currently, the codegen program is/can only be submitted to the head
         # node, due to using job_lib for updating job statuses, and using
         # autostop_lib here.
         self._code.append(
             # Use hasattr to handle backward compatibility.
             # TODO(zongheng): remove in ~1-2 minor releases (currently 0.2.x).
             textwrap.dedent("""\
               if hasattr(autostop_lib, 'set_last_active_time_to_now'):
                   autostop_lib.set_last_active_time_to_now()
             """))
-        if setup_cmd is not None:
-            self._code += [
-                textwrap.dedent(f"""\
-                _SETUP_CPUS = 0.0001
-                # The setup command will be run as a ray task with num_cpus=_SETUP_CPUS as the
-                # requirement; this means Ray will set CUDA_VISIBLE_DEVICES to an empty string.
-                # We unset it so that user setup command may properly use this env var.
-                setup_cmd = 'unset CUDA_VISIBLE_DEVICES; ' + setup_cmd
-                job_lib.set_status({job_id!r}, job_lib.JobStatus.SETTING_UP)
-                print({_CTRL_C_TIP_MESSAGE!r}, file=sys.stderr, flush=True)
-                total_num_nodes = len(ray.nodes())
-                setup_bundles = [{{"CPU": _SETUP_CPUS}} for _ in range(total_num_nodes)]
-                setup_pg = ray.util.placement_group(setup_bundles, strategy='STRICT_SPREAD')
-                ray.get(setup_pg.ready())
-                setup_workers = [run_bash_command_with_log \\
-                    .options(name='setup', num_cpus=_SETUP_CPUS, placement_group=setup_pg, placement_group_bundle_index=i) \\
-                    .remote(
-                        setup_cmd,
-                        os.path.expanduser({setup_log_path!r}),
-                        getpass.getuser(),
-                        job_id={self.job_id},
-                        env_vars={envs!r},
-                        stream_logs=True,
-                        with_ray=True,
-                        use_sudo={is_local},
-                    ) for i in range(total_num_nodes)]
-                setup_returncodes = ray.get(setup_workers)
-                if sum(setup_returncodes) != 0:
-                    job_lib.set_status({self.job_id!r}, job_lib.JobStatus.FAILED_SETUP)
-                    # This waits for all streaming logs to finish.
-                    time.sleep(1)
-                    print('ERROR: {colorama.Fore.RED}Job {self.job_id}\\'s setup failed with '
-                        'return code list:{colorama.Style.RESET_ALL}',
-                        setup_returncodes,
-                        file=sys.stderr,
-                        flush=True)
-                    # Need this to set the job status in ray job to be FAILED.
-                    sys.exit(1)
-                """)
-            ]
         self._code += [
             f'job_lib.set_status({job_id!r}, job_lib.JobStatus.PENDING)',
         ]
-        if spot_task is not None:
-            # Add the spot job to spot queue table.
-            resources_str = backend_utils.get_task_resources_str(spot_task)
-            self._code += [
-                'from sky.spot import spot_state',
-                f'spot_state.set_pending('
-                f'{job_id}, {spot_task.name!r}, {resources_str!r})',
-            ]
 
-    def add_gang_scheduling_placement_group(
+    def add_gang_scheduling_placement_group_and_setup(
         self,
         num_nodes: int,
         accelerator_dict: Optional[Dict[str, float]],
         stable_cluster_internal_ips: List[str],
+        setup_cmd: Optional[str] = None,
+        setup_log_path: Optional[str] = None,
+        envs: Optional[Dict[str, str]] = None,
     ) -> None:
         """Create the gang scheduling placement group for a Task.
 
         cluster_ips_sorted is used to ensure that the SKY_NODE_RANK environment
         variable is assigned in a deterministic order whenever a new task is
         added.
         """
-        assert self._has_prologue, ('Call add_prologue() before '
-                                    'add_gang_scheduling_placement_group().')
+        assert self._has_prologue, (
+            'Call add_prologue() before '
+            'add_gang_scheduling_placement_group_and_setup().')
         self._has_gang_scheduling = True
         self._num_nodes = num_nodes
 
         # Set CPU to avoid ray hanging the resources allocation
         # for remote functions, since the task will request 1 CPU
         # by default.
         bundles = [{
@@ -362,40 +322,101 @@
 
         self._code += [
             textwrap.dedent(f"""\
                 pg = ray_util.placement_group({json.dumps(bundles)}, 'STRICT_SPREAD')
                 plural = 's' if {num_nodes} > 1 else ''
                 node_str = f'{num_nodes} node{{plural}}'
 
-                message = '' if setup_cmd is not None else {_CTRL_C_TIP_MESSAGE!r} + '\\n'
+                message = {_CTRL_C_TIP_MESSAGE!r} + '\\n'
                 message += f'INFO: Waiting for task resources on {{node_str}}. This will block if the cluster is full.'
                 print(message,
                       file=sys.stderr,
                       flush=True)
                 # FIXME: This will print the error message from autoscaler if
                 # it is waiting for other task to finish. We should hide the
                 # error message.
                 ray.get(pg.ready())
                 print('INFO: All task resources reserved.',
                       file=sys.stderr,
                       flush=True)
-                job_lib.set_job_started({self.job_id!r})
                 """)
         ]
 
+        job_id = self.job_id
+        if setup_cmd is not None:
+            self._code += [
+                textwrap.dedent(f"""\
+                setup_cmd = {setup_cmd!r}
+                _SETUP_CPUS = 0.0001
+                # The setup command will be run as a ray task with num_cpus=_SETUP_CPUS as the
+                # requirement; this means Ray will set CUDA_VISIBLE_DEVICES to an empty string.
+                # We unset it so that user setup command may properly use this env var.
+                setup_cmd = 'unset CUDA_VISIBLE_DEVICES; ' + setup_cmd
+                job_lib.set_status({job_id!r}, job_lib.JobStatus.SETTING_UP)
+
+                # The schedule_step should be called after the job status is set to non-PENDING,
+                # otherwise, the scheduler will think the current job is not submitted yet, and
+                # skip the scheduling step.
+                job_lib.scheduler.schedule_step()
+
+                total_num_nodes = len(ray.nodes())
+                setup_bundles = [{{"CPU": _SETUP_CPUS}} for _ in range(total_num_nodes)]
+                setup_pg = ray.util.placement_group(setup_bundles, strategy='STRICT_SPREAD')
+                setup_workers = [run_bash_command_with_log \\
+                    .options(
+                        name='setup',
+                        num_cpus=_SETUP_CPUS,
+                        scheduling_strategy=ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy(
+                            placement_group=setup_pg,
+                            placement_group_bundle_index=i)
+                    ) \\
+                    .remote(
+                        setup_cmd,
+                        os.path.expanduser({setup_log_path!r}),
+                        getpass.getuser(),
+                        job_id={self.job_id},
+                        env_vars={envs!r},
+                        stream_logs=True,
+                        with_ray=True,
+                        use_sudo={self.is_local},
+                    ) for i in range(total_num_nodes)]
+                setup_returncodes = ray.get(setup_workers)
+                if sum(setup_returncodes) != 0:
+                    job_lib.set_status({self.job_id!r}, job_lib.JobStatus.FAILED_SETUP)
+                    # This waits for all streaming logs to finish.
+                    time.sleep(1)
+                    print('ERROR: {colorama.Fore.RED}Job {self.job_id}\\'s setup failed with '
+                        'return code list:{colorama.Style.RESET_ALL}',
+                        setup_returncodes,
+                        file=sys.stderr,
+                        flush=True)
+                    # Need this to set the job status in ray job to be FAILED.
+                    sys.exit(1)
+                """)
+            ]
+
+        self._code.append(f'job_lib.set_job_started({self.job_id!r})')
+        if setup_cmd is None:
+            # Need to call schedule_step() to make sure the scheduler
+            # schedule the next pending job.
+            self._code.append('job_lib.scheduler.schedule_step()')
+
         # Export IP and node rank to the environment variables.
         self._code += [
             textwrap.dedent(f"""\
                 @ray.remote
                 def check_ip():
                     return ray.util.get_node_ip_address()
                 gang_scheduling_id_to_ip = ray.get([
-                    check_ip.options(num_cpus={backend_utils.DEFAULT_TASK_CPU_DEMAND},
-                                     placement_group=pg,
-                                     placement_group_bundle_index=i).remote()
+                    check_ip.options(
+                            num_cpus={backend_utils.DEFAULT_TASK_CPU_DEMAND},
+                            scheduling_strategy=ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy(
+                                placement_group=pg,
+                                placement_group_bundle_index=i
+                            )).remote()
                     for i in range(pg.bundle_count)
                 ])
                 print('INFO: Reserved IPs:', gang_scheduling_id_to_ip)
 
                 cluster_ips_to_node_id = {{ip: i for i, ip in enumerate({stable_cluster_internal_ips!r})}}
                 job_ip_rank_list = sorted(gang_scheduling_id_to_ip, key=cluster_ips_to_node_id.get)
                 job_ip_rank_map = {{ip: i for i, ip in enumerate(job_ip_rank_list)}}
@@ -406,15 +427,15 @@
     def register_run_fn(self, run_fn: str, run_fn_name: str) -> None:
         """Register the run function to be run on the remote cluster.
 
         Args:
             run_fn: The run function to be run on the remote cluster.
         """
         assert self._has_gang_scheduling, (
-            'Call add_gang_scheduling_placement_group() '
+            'Call add_gang_scheduling_placement_group_and_setup() '
             'before register_run_fn().')
         assert not self._has_register_run_fn, (
             'register_run_fn() called twice?')
         self._has_register_run_fn = True
 
         self._code += [
             run_fn,
@@ -428,44 +449,46 @@
                      ray_resources_dict: Optional[Dict[str, float]],
                      log_dir: str,
                      env_vars: Optional[Dict[str, str]] = None,
                      gang_scheduling_id: int = 0,
                      use_sudo: bool = False) -> None:
         """Generates code for a ray remote task that runs a bash command."""
         assert self._has_gang_scheduling, (
-            'Call add_gang_scheduling_placement_group() before add_ray_task().')
+            'Call add_gang_scheduling_placement_group_and_setup() before '
+            'add_ray_task().')
         assert (not self._has_register_run_fn or
                 bash_script is None), ('bash_script should '
                                        'be None when run_fn is registered.')
         # Build remote_task.options(...)
         #   resources=...
         #   num_gpus=...
-        cpu_str = f', num_cpus={backend_utils.DEFAULT_TASK_CPU_DEMAND}'
+        options = []
+        options.append(f'num_cpus={backend_utils.DEFAULT_TASK_CPU_DEMAND}')
 
-        resources_str = ''
         num_gpus = 0.0
-        num_gpus_str = ''
         if ray_resources_dict is not None:
             assert len(ray_resources_dict) == 1, \
                 ('There can only be one type of accelerator per instance.'
                  f' Found: {ray_resources_dict}.')
             num_gpus = list(ray_resources_dict.values())[0]
-            resources_str = f', resources={json.dumps(ray_resources_dict)}'
+            options.append(f'resources={json.dumps(ray_resources_dict)}')
 
-            # Passing this ensures that the Ray remote task gets
-            # CUDA_VISIBLE_DEVICES set correctly.  If not passed, that flag
-            # would be force-set to empty by Ray.
-            num_gpus_str = f', num_gpus={num_gpus}'
-            # `num_gpus` should be empty when the accelerator is not GPU.
-            # FIXME: use a set of GPU types.
             resources_key = list(ray_resources_dict.keys())[0]
-            if 'tpu' in resources_key.lower():
-                num_gpus_str = ''
-        resources_str += ', placement_group=pg'
-        resources_str += f', placement_group_bundle_index={gang_scheduling_id}'
+            if 'tpu' not in resources_key.lower():
+                # `num_gpus` should be empty when the accelerator is not GPU.
+                # FIXME: use a set of GPU types, instead of 'tpu' in the key.
+
+                # Passing this ensures that the Ray remote task gets
+                # CUDA_VISIBLE_DEVICES set correctly.  If not passed, that flag
+                # would be force-set to empty by Ray.
+                options.append(f'num_gpus={num_gpus}')
+        options.append(
+            'scheduling_strategy=ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy('  # pylint: disable=line-too-long
+            'placement_group=pg, '
+            f'placement_group_bundle_index={gang_scheduling_id})')
 
         sky_env_vars_dict_str = [
             textwrap.dedent("""\
             sky_env_vars_dict = {}
             sky_env_vars_dict['SKYPILOT_NODE_IPS'] = job_ip_list_str
             # Environment starting with `SKY_` is deprecated.
             sky_env_vars_dict['SKY_NODE_IPS'] = job_ip_list_str
@@ -473,21 +496,26 @@
         ]
 
         if env_vars is not None:
             sky_env_vars_dict_str.extend(f'sky_env_vars_dict[{k!r}] = {v!r}'
                                          for k, v in env_vars.items())
         if job_run_id is not None:
             sky_env_vars_dict_str += [
-                f'sky_env_vars_dict[{constants.JOB_ID_ENV_VAR!r}]'
+                f'sky_env_vars_dict[{constants.TASK_ID_ENV_VAR!r}]'
+                f' = {job_run_id!r}',
+                # TODO(zhwu): remove this deprecated env var in later release
+                # (after 0.5).
+                f'sky_env_vars_dict[{constants.TASK_ID_ENV_VAR_DEPRECATED!r}]'
                 f' = {job_run_id!r}'
             ]
         sky_env_vars_dict_str = '\n'.join(sky_env_vars_dict_str)
 
+        options_str = ', '.join(options)
         logger.debug('Added Task with options: '
-                     f'{cpu_str}{resources_str}{num_gpus_str}')
+                     f'{options_str}')
         self._code += [
             sky_env_vars_dict_str,
             textwrap.dedent(f"""\
         script = {bash_script!r}
         if run_fn is not None:
             script = run_fn({gang_scheduling_id}, gang_scheduling_id_to_ip)
 
@@ -516,15 +544,15 @@
             sky_env_vars_dict['SKY_NODE_RANK'] = rank
 
             sky_env_vars_dict['SKYPILOT_INTERNAL_JOB_ID'] = {self.job_id}
             # Environment starting with `SKY_` is deprecated.
             sky_env_vars_dict['SKY_INTERNAL_JOB_ID'] = {self.job_id}
 
             futures.append(run_bash_command_with_log \\
-                    .options(name=name_str{cpu_str}{resources_str}{num_gpus_str}) \\
+                    .options(name=name_str, {options_str}) \\
                     .remote(
                         script,
                         log_path,
                         getpass.getuser(),
                         job_id={self.job_id},
                         env_vars=sky_env_vars_dict,
                         stream_logs=True,
@@ -541,28 +569,30 @@
 
         self._code += [
             textwrap.dedent(f"""\
             returncodes = ray.get(futures)
             if sum(returncodes) != 0:
                 job_lib.set_status({self.job_id!r}, job_lib.JobStatus.FAILED)
                 # This waits for all streaming logs to finish.
-                time.sleep(1)
+                job_lib.scheduler.schedule_step()
+                time.sleep(0.5)
                 print('ERROR: {colorama.Fore.RED}Job {self.job_id} failed with '
                       'return code list:{colorama.Style.RESET_ALL}',
                       returncodes,
                       file=sys.stderr,
                       flush=True)
                 # Need this to set the job status in ray job to be FAILED.
                 sys.exit(1)
             else:
                 sys.stdout.flush()
                 sys.stderr.flush()
                 job_lib.set_status({self.job_id!r}, job_lib.JobStatus.SUCCEEDED)
                 # This waits for all streaming logs to finish.
-                time.sleep(1)
+                job_lib.scheduler.schedule_step()
+                time.sleep(0.5)
             """)
         ]
 
     def build(self) -> str:
         """Returns the entire generated program."""
         assert self._has_epilogue, 'Call add_epilogue() before build().'
         return '\n'.join(self._code)
@@ -571,17 +601,17 @@
 class RetryingVmProvisioner(object):
     """A provisioner that retries different cloud/regions/zones."""
 
     class ToProvisionConfig:
         """Resources to be provisioned."""
 
         def __init__(
-            self, cluster_name: str, resources: resources_lib.Resources,
-            num_nodes: int,
-            prev_cluster_status: Optional[global_user_state.ClusterStatus]
+                self, cluster_name: str, resources: resources_lib.Resources,
+                num_nodes: int,
+                prev_cluster_status: Optional[status_lib.ClusterStatus]
         ) -> None:
             assert cluster_name is not None, 'cluster_name must be specified.'
             self.cluster_name = cluster_name
             self.resources = resources
             self.num_nodes = num_nodes
             self.prev_cluster_status = prev_cluster_status
 
@@ -621,14 +651,24 @@
         ]
         if len(exception_list) == 1:
             # Parse structured response {'errors': [...]}.
             exception_str = exception_list[0][len('Exception: '):]
             try:
                 exception_dict = ast.literal_eval(exception_str)
             except Exception as e:
+                if 'wait_ready timeout exceeded' in exception_str:
+                    # This error seems to occur when the provisioning process
+                    # went through partially (e.g., for spot, initial
+                    # provisioning succeeded, but while waiting for ssh/setting
+                    # up it got preempted).
+                    logger.error('Got the following exception, continuing: '
+                                 f'{exception_list[0]}')
+                    self._blocked_resources.add(
+                        launchable_resources.copy(zone=zone.name))
+                    return
                 raise RuntimeError(
                     f'Failed to parse exception: {exception_str}') from e
             # TPU VM returns a different structured response.
             if 'errors' not in exception_dict:
                 exception_dict = {'errors': [exception_dict]}
             for error in exception_dict['errors']:
                 code = error['code']
@@ -662,18 +702,21 @@
                     # not documented by GCP.
                     self._blocked_resources.add(
                         launchable_resources.copy(zone=zone.name))
                 elif code in ['RESOURCE_NOT_READY']:
                     # This code is returned when the VM is still STOPPING.
                     self._blocked_resources.add(
                         launchable_resources.copy(zone=zone.name))
-                elif code == 8:
+                elif code in [8, 9]:
                     # Error code 8 means TPU resources is out of
                     # capacity. Example:
                     # {'code': 8, 'message': 'There is no more capacity in the zone "europe-west4-a"; you can try in another zone where Cloud TPU Nodes are offered (see https://cloud.google.com/tpu/docs/regions) [EID: 0x1bc8f9d790be9142]'} # pylint: disable=line-too-long
+                    # Error code 9 means TPU resources is insufficient reserved
+                    # capacity. Example:
+                    # {'code': 9, 'message': 'Insufficient reserved capacity. Contact customer support to increase your reservation. [EID: 0x2f8bc266e74261a]'} # pylint: disable=line-too-long
                     self._blocked_resources.add(
                         launchable_resources.copy(zone=zone.name))
                 elif code == 'RESOURCE_NOT_FOUND':
                     # https://github.com/skypilot-org/skypilot/issues/1797
                     # In the inner provision loop we have used retries to
                     # recover but failed. This indicates this zone is most
                     # likely out of capacity. The provision loop will terminate
@@ -686,14 +729,26 @@
         elif len(httperror_str) >= 1:
             logger.info(f'Got {httperror_str[0]}')
             if ('Requested disk size cannot be smaller than the image size'
                     in httperror_str[0]):
                 logger.info('Skipping all regions due to disk size issue.')
                 self._blocked_resources.add(
                     launchable_resources.copy(region=None, zone=None))
+            elif ('Policy update access denied.' in httperror_str[0] or
+                  'IAM_PERMISSION_DENIED' in httperror_str[0]):
+                logger.info(
+                    'Skipping all regions due to service account not '
+                    'having the required permissions and the user '
+                    'account does not have enough permission to '
+                    'update it. Please contact your administrator and '
+                    'check out: https://skypilot.readthedocs.io/en/latest/cloud-setup/cloud-permissions.html#gcp\n'  # pylint: disable=line-too-long
+                    f'Details: {httperror_str[0]}')
+                self._blocked_resources.add(
+                    launchable_resources.copy(region=None, zone=None))
+
             else:
                 # Parse HttpError for unauthorized regions. Example:
                 # googleapiclient.errors.HttpError: <HttpError 403 when requesting ... returned "Location us-east1-d is not found or access is unauthorized.". # pylint: disable=line-too-long
                 # Details: "Location us-east1-d is not found or access is
                 # unauthorized.">
                 self._blocked_resources.add(
                     launchable_resources.copy(zone=zone.name))
@@ -853,14 +908,50 @@
         for e in errors:
             if e.find('Regions with capacity available:') != -1:
                 for r in clouds.Lambda.regions():
                     if e.find(r.name) == -1:
                         self._blocked_resources.add(
                             launchable_resources.copy(region=r.name, zone=None))
 
+    def _update_blocklist_on_scp_error(
+            self, launchable_resources: 'resources_lib.Resources', region,
+            zones, stdout, stderr):
+        del zones  # Unused.
+        style = colorama.Style
+        stdout_splits = stdout.split('\n')
+        stderr_splits = stderr.split('\n')
+        errors = [
+            s.strip()
+            for s in stdout_splits + stderr_splits
+            if 'SCPError:' in s.strip()
+        ]
+        if not errors:
+            logger.info('====== stdout ======')
+            for s in stdout_splits:
+                print(s)
+            logger.info('====== stderr ======')
+            for s in stderr_splits:
+                print(s)
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError('Errors occurred during provision; '
+                                   'check logs above.')
+
+        logger.warning(f'Got error(s) in {region.name}:')
+        messages = '\n\t'.join(errors)
+        logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
+        self._blocked_resources.add(launchable_resources.copy(zone=None))
+
+        # Sometimes, SCPError will list available regions.
+        for e in errors:
+            if e.find('Regions with capacity available:') != -1:
+                for r in clouds.SCP.regions():
+                    if e.find(r.name) == -1:
+                        self._blocked_resources.add(
+                            launchable_resources.copy(region=r.name, zone=None))
+
     def _update_blocklist_on_ibm_error(
             self, launchable_resources: 'resources_lib.Resources',
             region: 'clouds.Region', zones: Optional[List['clouds.Zone']],
             stdout: str, stderr: str):
 
         style = colorama.Style
         stdout_splits = stdout.split('\n')
@@ -914,14 +1005,52 @@
                     'check logs above.')
         logger.warning('Got error(s) on local cluster:')
         messages = '\n\t'.join(errors)
         logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
         self._blocked_resources.add(
             launchable_resources.copy(region=region.name, zone=None))
 
+    # Apr, 2023 by Hysun(hysun.he@oracle.com): Added support for OCI
+    def _update_blocklist_on_oci_error(
+            self, launchable_resources: 'resources_lib.Resources',
+            region: 'clouds.Region', zones: Optional[List['clouds.Zone']],
+            stdout: str, stderr: str):
+
+        style = colorama.Style
+        stdout_splits = stdout.split('\n')
+        stderr_splits = stderr.split('\n')
+        errors = [
+            s.strip()
+            for s in stdout_splits + stderr_splits
+            if ('VcnSubnetNotFound' in s.strip()) or
+            ('oci.exceptions.ServiceError' in s.strip() and
+             ('NotAuthorizedOrNotFound' in s.strip() or 'CannotParseRequest' in
+              s.strip() or 'InternalError' in s.strip() or
+              'LimitExceeded' in s.strip() or 'NotAuthenticated' in s.strip()))
+        ]
+        if not errors:
+            logger.info('====== stdout ======')
+            for s in stdout_splits:
+                print(s)
+            logger.info('====== stderr ======')
+            for s in stderr_splits:
+                print(s)
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError('Errors occurred during provision; '
+                                   'check logs above.')
+
+        logger.warning(f'Got error(s) in {region.name}:')
+        messages = '\n\t'.join(errors)
+        logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
+
+        if zones is not None:
+            for zone in zones:
+                self._blocked_resources.add(
+                    launchable_resources.copy(zone=zone.name))
+
     def _update_blocklist_on_error(
             self, launchable_resources: 'resources_lib.Resources',
             region: 'clouds.Region', zones: Optional[List['clouds.Zone']],
             stdout: Optional[str], stderr: Optional[str]) -> bool:
         """Handles cloud-specific errors and updates the block list.
 
         This parses textual stdout/stderr because we don't directly use the
@@ -949,15 +1078,17 @@
         # TODO(zongheng): refactor into Cloud interface?
         handlers = {
             clouds.AWS: self._update_blocklist_on_aws_error,
             clouds.Azure: self._update_blocklist_on_azure_error,
             clouds.GCP: self._update_blocklist_on_gcp_error,
             clouds.Lambda: self._update_blocklist_on_lambda_error,
             clouds.IBM: self._update_blocklist_on_ibm_error,
+            clouds.SCP: self._update_blocklist_on_scp_error,
             clouds.Local: self._update_blocklist_on_local_error,
+            clouds.OCI: self._update_blocklist_on_oci_error,
         }
         cloud = launchable_resources.cloud
         cloud_type = type(cloud)
         if cloud_type not in handlers:
             raise NotImplementedError(
                 f'Cloud {cloud} unknown, or has not added '
                 'support for parsing and handling provision failures.')
@@ -983,15 +1114,15 @@
             not head_node_launch_may_have_been_requested)
 
         return definitely_no_nodes_launched
 
     def _yield_zones(
         self, to_provision: resources_lib.Resources, num_nodes: int,
         cluster_name: str,
-        prev_cluster_status: Optional[global_user_state.ClusterStatus]
+        prev_cluster_status: Optional[status_lib.ClusterStatus]
     ) -> Iterable[Optional[List[clouds.Zone]]]:
         """Yield zones within the given region to try for provisioning.
 
         Yields:
             Zones to try for provisioning within the given to_provision.region.
               - None means the cloud does not support zones, but the region does
                 offer the requested resources (so the outer loop should issue a
@@ -1010,16 +1141,17 @@
         cloud = to_provision.cloud
         region = clouds.Region(to_provision.region)
         zones = None
 
         def _get_previously_launched_zones() -> Optional[List[clouds.Zone]]:
             # When the cluster exists, the to_provision should have been set
             # to the previous cluster's resources.
-            zones = [clouds.Zone(name=to_provision.zone)
-                    ] if to_provision.zone is not None else None
+            zones = [
+                clouds.Zone(name=to_provision.zone),
+            ] if to_provision.zone is not None else None
             if zones is None:
                 # Reuse the zone field in the ray yaml as the
                 # prev_resources.zone field may not be set before the previous
                 # cluster is launched.
                 handle = global_user_state.get_handle_from_cluster_name(
                     cluster_name)
                 assert isinstance(handle, CloudVmRayResourceHandle), (
@@ -1037,15 +1169,15 @@
             return zones
 
         if prev_cluster_status is not None:
             # If the cluster is previously launched, we should relaunch in the
             # same region and zone.
             zones = _get_previously_launched_zones()
 
-            if prev_cluster_status != global_user_state.ClusterStatus.UP:
+            if prev_cluster_status != status_lib.ClusterStatus.UP:
                 logger.info(
                     f'Cluster {cluster_name!r} (status: '
                     f'{prev_cluster_status.value}) was previously launched '
                     f'in {cloud} {region.name}. Relaunching in that region.')
             # TODO(zhwu): The cluster being killed by cloud provider should
             # be tested whether re-launching a cluster killed spot instance
             # will recover the data.
@@ -1056,51 +1188,51 @@
             # provider.
             # If it reaches here: the cluster status in the database gets
             # set to INIT, since a launch request was issued but failed.
             #
             # Cluster with status UP can reach here, if it was killed by the
             # cloud provider and no available resources in that region to
             # relaunch, which can happen to spot instance.
-            if prev_cluster_status == global_user_state.ClusterStatus.UP:
+            if prev_cluster_status == status_lib.ClusterStatus.UP:
                 message = (
                     f'Failed to connect to the cluster {cluster_name!r}. '
                     'It is possibly killed by cloud provider or manually '
                     'in the cloud provider console. To remove the cluster '
                     f'please run: sky down {cluster_name}')
                 # Reset to UP (rather than keeping it at INIT), as INIT
                 # mode will enable failover to other regions, causing
                 # data lose.
                 # TODO(zhwu): This is set to UP to be more conservative,
                 # we may need to confirm whether the cluster is down in all
                 # cases.
                 global_user_state.set_cluster_status(
-                    cluster_name, global_user_state.ClusterStatus.UP)
+                    cluster_name, status_lib.ClusterStatus.UP)
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.ResourcesUnavailableError(message,
                                                                no_failover=True)
 
             # Check the *previous* cluster status. If the cluster is previously
             # stopped, we should not retry other regions, since the previously
             # attached volumes are not visible on another region.
-            elif prev_cluster_status == global_user_state.ClusterStatus.STOPPED:
+            elif prev_cluster_status == status_lib.ClusterStatus.STOPPED:
                 message = (
                     'Failed to acquire resources to restart the stopped '
                     f'cluster {cluster_name} in {region.name}. Please retry '
                     'again later.')
 
                 # Reset to STOPPED (rather than keeping it at INIT), because
                 # (1) the cluster is not up (2) it ensures future `sky start`
                 # will disable auto-failover too.
                 global_user_state.set_cluster_status(
-                    cluster_name, global_user_state.ClusterStatus.STOPPED)
+                    cluster_name, status_lib.ClusterStatus.STOPPED)
 
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.ResourcesUnavailableError(message,
                                                                no_failover=True)
-            assert prev_cluster_status == global_user_state.ClusterStatus.INIT
+            assert prev_cluster_status == status_lib.ClusterStatus.INIT
             message = (f'Failed to launch cluster {cluster_name!r} '
                        f'(previous status: {prev_cluster_status.value}) '
                        f'with the original resources: {to_provision}.')
             # We attempted re-launching a previously INIT cluster with the
             # same cloud/region/resources, but failed. Here no_failover=False,
             # so we will retry provisioning it with the current requested
             # resources in the outer loop.
@@ -1197,15 +1329,15 @@
         to_provision: resources_lib.Resources,
         num_nodes: int,
         requested_resources: Set[resources_lib.Resources],
         dryrun: bool,
         stream_logs: bool,
         cluster_name: str,
         cloud_user_identity: Optional[List[str]],
-        prev_cluster_status: Optional[global_user_state.ClusterStatus],
+        prev_cluster_status: Optional[status_lib.ClusterStatus],
     ):
         """The provision retry loop."""
         style = colorama.Style
         fore = colorama.Fore
         # Get log_path name
         log_path = os.path.join(self.log_dir, 'provision.log')
         log_abs_path = os.path.abspath(log_path)
@@ -1214,22 +1346,51 @@
         tail_cmd = f'tail -n100 -f {log_path}'
         logger.info('To view detailed progress: '
                     f'{style.BRIGHT}{tail_cmd}{style.RESET_ALL}')
 
         # Get previous cluster status
         cluster_exists = prev_cluster_status is not None
         is_prev_cluster_healthy = prev_cluster_status in [
-            global_user_state.ClusterStatus.STOPPED,
-            global_user_state.ClusterStatus.UP
+            status_lib.ClusterStatus.STOPPED, status_lib.ClusterStatus.UP
         ]
 
         assert to_provision.region is not None, (
             to_provision, 'region should have been set by the optimizer.')
         region = clouds.Region(to_provision.region)
 
+        # Optimization - check if user has non-zero quota for
+        # the instance type in the target region. If not, fail early
+        # instead of trying to provision and failing later.
+        try:
+            need_provision = to_provision.cloud.check_quota_available(
+                to_provision.region, to_provision.instance_type,
+                to_provision.use_spot)
+
+        except Exception as e:  # pylint: disable=broad-except
+            need_provision = True
+            logger.info(f'Error occurred when trying to check quota. '
+                        f'Proceeding assuming quotas are available. Error: '
+                        f'{common_utils.format_exception(e, use_bracket=True)}')
+
+        if not need_provision:
+            # if quota is found to be zero, raise exception and skip to
+            # the next region
+            if to_provision.use_spot:
+                instance_descriptor = 'spot'
+            else:
+                instance_descriptor = 'on-demand'
+            raise exceptions.ResourcesUnavailableError(
+                f'{colorama.Fore.YELLOW}Found no quota for '
+                f'{to_provision.instance_type} {instance_descriptor} '
+                f'instances in region {to_provision.region}. '
+                f'{colorama.Style.RESET_ALL}'
+                f'To request quotas, check the instruction: '
+                f'https://skypilot.readthedocs.io/en/latest/cloud-setup/quota.html.'  # pylint: disable=line-too-long
+            )
+
         for zones in self._yield_zones(to_provision, num_nodes, cluster_name,
                                        prev_cluster_status):
             # Filter out zones that are blocked, if any.
             # This optimize the provision loop by skipping zones that are
             # indicated to be unavailable from previous provision attempts.
             # It can happen for the provisioning on GCP, as the
             # yield_region_zones will return zones from a region one by one,
@@ -1287,15 +1448,15 @@
                 cluster_yaml=cluster_config_file,
                 launched_nodes=num_nodes,
                 # OK for this to be shown in CLI as status == INIT.
                 launched_resources=to_provision.copy(region=region.name),
                 tpu_create_script=config_dict.get('tpu-create-script'),
                 tpu_delete_script=config_dict.get('tpu-delete-script'))
             usage_lib.messages.usage.update_final_cluster_status(
-                global_user_state.ClusterStatus.INIT)
+                status_lib.ClusterStatus.INIT)
 
             # This sets the status to INIT (even for a normal, UP cluster).
             global_user_state.add_or_update_cluster(
                 cluster_name,
                 cluster_handle=handle,
                 requested_resources=requested_resources,
                 ready=False,
@@ -1713,31 +1874,26 @@
             #   - get all node ips
             #   - for all nodes: ray stop
             #   - ray up --restart-only
             return
         backend = CloudVmRayBackend()
 
         returncode = backend.run_on_head(
-            handle,
-            backend_utils.RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND,
-            # At this state, an erroneous cluster may not have cached
-            # handle.head_ip (global_user_state.add_or_update_cluster(...,
-            # ready=True)).
-            use_cached_head_ip=False)
+            handle, backend_utils.RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND)
         if returncode == 0:
             return
         launched_resources = handle.launched_resources
         # Ray cluster should already be running if the system admin has setup
         # Ray.
         if isinstance(launched_resources.cloud, clouds.Local):
             raise RuntimeError(
                 'The command `ray status` errored out on the head node '
                 'of the local cluster. Check if ray[default]==2.4.0 '
                 'is installed or running correctly.')
-        backend.run_on_head(handle, 'ray stop', use_cached_head_ip=False)
+        backend.run_on_head(handle, 'ray stop')
 
         # Runs `ray up <kwargs>` with our monkey-patched launch hash
         # calculation. See the monkey patch file for why.
         script_path = write_ray_up_script_with_patched_launch_hash_fn(
             handle.cluster_yaml, ray_up_kwargs={'restart_only': True})
         log_lib.run_with_log(
             [sys.executable, script_path],
@@ -1839,16 +1995,16 @@
                 self._blocked_resources.add(to_provision)
             else:
                 # If we reach here, it means that the existing cluster must have
                 # a previous status of INIT, because other statuses (UP,
                 # STOPPED) will not trigger the failover due to `no_failover`
                 # flag; see _yield_zones(). Also, the cluster should have been
                 # terminated by _retry_zones().
-                assert (prev_cluster_status == global_user_state.ClusterStatus.
-                        INIT), prev_cluster_status
+                assert (prev_cluster_status == status_lib.ClusterStatus.INIT
+                       ), prev_cluster_status
                 assert global_user_state.get_handle_from_cluster_name(
                     cluster_name) is None, cluster_name
                 logger.info('Retrying provisioning with requested resources '
                             f'{task.num_nodes}x {task.resources}')
                 # Retry with the current, potentially "smaller" resources:
                 # to_provision == the current new resources (e.g., V100:1),
                 # which may be "smaller" than the original (V100:8).
@@ -2404,37 +2560,41 @@
             self._update_after_cluster_provisioned(handle, task,
                                                    prev_cluster_status, ip_list,
                                                    lock_path)
             return handle
 
     def _update_after_cluster_provisioned(
             self, handle: CloudVmRayResourceHandle, task: task_lib.Task,
-            prev_cluster_status: Optional[global_user_state.ClusterStatus],
+            prev_cluster_status: Optional[status_lib.ClusterStatus],
             ip_list: List[str], lock_path: str) -> None:
         usage_lib.messages.usage.update_cluster_resources(
             handle.launched_nodes, handle.launched_resources)
         usage_lib.messages.usage.update_final_cluster_status(
-            global_user_state.ClusterStatus.UP)
+            status_lib.ClusterStatus.UP)
+
+        # For backward compatibility and robustness of skylet, it is restarted
+        with log_utils.safe_rich_status('Updating remote skylet'):
+            self.run_on_head(handle, _MAYBE_SKYLET_RESTART_CMD)
 
         # Update job queue to avoid stale jobs (when restarted), before
         # setting the cluster to be ready.
-        if prev_cluster_status == global_user_state.ClusterStatus.INIT:
+        if prev_cluster_status == status_lib.ClusterStatus.INIT:
             # update_status will query the ray job status for all INIT /
             # PENDING / RUNNING jobs for the real status, since we do not
             # know the actual previous status of the cluster.
             job_owner = onprem_utils.get_job_owner(handle.cluster_yaml)
             cmd = job_lib.JobLibCodeGen.update_status(job_owner)
             with log_utils.safe_rich_status('[bold cyan]Preparing Job Queue'):
                 returncode, _, stderr = self.run_on_head(handle,
                                                          cmd,
                                                          require_outputs=True)
             subprocess_utils.handle_returncode(returncode, cmd,
                                                'Failed to update job status.',
                                                stderr)
-        if prev_cluster_status == global_user_state.ClusterStatus.STOPPED:
+        if prev_cluster_status == status_lib.ClusterStatus.STOPPED:
             # Safely set all the previous jobs to FAILED since the cluster
             # is restarted
             # An edge case here due to racing:
             # 1. A job finishes RUNNING, but right before it update itself
             # to SUCCEEDED, the cluster is STOPPED by `sky stop`.
             # 2. On next `sky start`, it gets reset to FAILED.
             cmd = job_lib.JobLibCodeGen.fail_all_jobs_in_progress()
@@ -2450,15 +2610,15 @@
             global_user_state.add_or_update_cluster(
                 handle.cluster_name,
                 handle,
                 task.resources,
                 ready=True,
             )
             usage_lib.messages.usage.update_final_cluster_status(
-                global_user_state.ClusterStatus.UP)
+                status_lib.ClusterStatus.UP)
             auth_config = common_utils.read_yaml(handle.cluster_yaml)['auth']
             backend_utils.SSHConfigHelper.add_cluster(handle.cluster_name,
                                                       ip_list, auth_config)
 
             common_utils.remove_file_if_exists(lock_path)
 
     def _sync_workdir(self, handle: CloudVmRayResourceHandle,
@@ -2631,14 +2791,15 @@
     def _exec_code_on_head(
         self,
         handle: CloudVmRayResourceHandle,
         codegen: str,
         job_id: int,
         executable: str,
         detach_run: bool = False,
+        spot_dag: Optional['dag.Dag'] = None,
     ) -> None:
         """Executes generated code on the head node."""
         style = colorama.Style
         fore = colorama.Fore
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
         runner = command_runner.SSHCommandRunner(handle.head_ip,
@@ -2671,23 +2832,56 @@
             ray_command = (f'{cd} && {executable} -u {script_path} '
                            f'> {remote_log_path} 2>&1')
             job_submit_cmd = self._setup_and_create_job_cmd_on_local_head(
                 handle, ray_command, ray_job_id)
         else:
             job_submit_cmd = (
                 'RAY_DASHBOARD_PORT=$(python -c "from sky.skylet import job_lib; print(job_lib.get_job_submission_port())" 2> /dev/null || echo 8265);'  # pylint: disable=line-too-long
-                f'{cd} && mkdir -p {remote_log_dir} && ray job submit '
+                f'{cd} && ray job submit '
                 '--address=http://127.0.0.1:$RAY_DASHBOARD_PORT '
                 f'--submission-id {ray_job_id} --no-wait '
                 f'"{executable} -u {script_path} > {remote_log_path} 2>&1"')
 
+            mkdir_code = (f'{cd} && mkdir -p {remote_log_dir} && '
+                          f'touch {remote_log_path}')
+            code = job_lib.JobLibCodeGen.queue_job(job_id, job_submit_cmd)
+
+            job_submit_cmd = mkdir_code + ' && ' + code
+
+            if spot_dag is not None:
+                # Add the spot job to spot queue table.
+                spot_codegen = spot_lib.SpotCodeGen()
+                spot_code = spot_codegen.set_pending(job_id, spot_dag)
+                # Set the spot job to PENDING state to make sure that this spot
+                # job appears in the `sky spot queue`, when there are already 16
+                # controller process jobs running on the controller VM with 8
+                # CPU cores.
+                # The spot job should be set to PENDING state *after* the
+                # controller process job has been queued, as our skylet on spot
+                # controller will set the spot job in FAILED state if the
+                # controller process job does not exist.
+                # We cannot set the spot job to PENDING state in the codegen for
+                # the controller process job, as it will stay in the job pending
+                # table and not be executed until there is an empty slot.
+                job_submit_cmd = job_submit_cmd + ' && ' + spot_code
+
         returncode, stdout, stderr = self.run_on_head(handle,
                                                       job_submit_cmd,
                                                       stream_logs=False,
                                                       require_outputs=True)
+
+        if 'has no attribute' in stdout:
+            # Happens when someone calls `sky exec` but remote is outdated
+            # necessicating calling `sky launch`
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError(
+                    f'{colorama.Fore.RED}SkyPilot runtime is stale on the '
+                    'remote cluster. To update, run: sky launch -c '
+                    f'{handle.cluster_name}{colorama.Style.RESET_ALL}')
+
         subprocess_utils.handle_returncode(returncode,
                                            job_submit_cmd,
                                            f'Failed to submit job {job_id}.',
                                            stderr=stdout + stderr)
 
         logger.info('Job submitted with Job ID: '
                     f'{style.BRIGHT}{job_id}{style.RESET_ALL}')
@@ -2713,14 +2907,17 @@
                     f'{backend_utils.BOLD}sky spot logs {job_id}'
                     f'{backend_utils.RESET_BOLD}'
                     f'\nTo stream controller logs:\t'
                     f'{backend_utils.BOLD}sky spot logs --controller {job_id}'
                     f'{backend_utils.RESET_BOLD}'
                     '\nTo view all spot jobs:\t\t'
                     f'{backend_utils.BOLD}sky spot queue'
+                    f'{backend_utils.RESET_BOLD}'
+                    '\nTo view the spot job dashboard:\t'
+                    f'{backend_utils.BOLD}sky spot dashboard'
                     f'{backend_utils.RESET_BOLD}')
             else:
                 logger.info(f'{fore.CYAN}Job ID: '
                             f'{style.BRIGHT}{job_id}{style.RESET_ALL}'
                             '\nTo cancel the job:\t'
                             f'{backend_utils.BOLD}sky cancel {name} {job_id}'
                             f'{backend_utils.RESET_BOLD}'
@@ -3136,14 +3333,20 @@
         log_path = os.path.join(os.path.expanduser(self.log_dir),
                                 'teardown.log')
         log_abs_path = os.path.abspath(log_path)
         cloud = handle.launched_resources.cloud
         config = common_utils.read_yaml(handle.cluster_yaml)
         cluster_name = handle.cluster_name
         use_tpu_vm = config['provider'].get('_has_tpus', False)
+
+        # Avoid possibly unbound warnings. Code below must overwrite these vars:
+        returncode = 0
+        stdout = ''
+        stderr = ''
+
         if terminate and isinstance(cloud, clouds.Azure):
             # Here we handle termination of Azure by ourselves instead of Ray
             # autoscaler.
             resource_group = config['provider']['resource_group']
             terminate_cmd = f'az group delete -y --name {resource_group}'
             with log_utils.safe_rich_status(f'[bold cyan]Terminating '
                                             f'[green]{cluster_name}'):
@@ -3151,15 +3354,15 @@
                     terminate_cmd,
                     log_abs_path,
                     shell=True,
                     stream_logs=False,
                     require_outputs=True)
 
         elif (isinstance(cloud, clouds.IBM) and terminate and
-              prev_cluster_status == global_user_state.ClusterStatus.STOPPED):
+              prev_cluster_status == status_lib.ClusterStatus.STOPPED):
             # pylint: disable= W0622 W0703 C0415
             from sky.adaptors import ibm
             from sky.skylet.providers.ibm.vpc_provider import IBMVPCProvider
 
             config_provider = common_utils.read_yaml(
                 handle.cluster_yaml)['provider']
             region = config_provider['region']
@@ -3167,14 +3370,15 @@
             search_client = ibm.search_client()
             vpc_found = False
             # pylint: disable=unsubscriptable-object
             vpcs_filtered_by_tags_and_region = search_client.search(
                 query=f'type:vpc AND tags:{cluster_name} AND region:{region}',
                 fields=['tags', 'region', 'type'],
                 limit=1000).get_result()['items']
+            vpc_id = None
             try:
                 # pylint: disable=line-too-long
                 vpc_id = vpcs_filtered_by_tags_and_region[0]['crn'].rsplit(
                     ':', 1)[-1]
                 vpc_found = True
             except Exception:
                 logger.critical('failed to locate vpc for ibm cloud')
@@ -3185,46 +3389,87 @@
                 # Delete VPC and it's associated resources
                 vpc_provider = IBMVPCProvider(
                     config_provider['resource_group_id'], region, cluster_name)
                 vpc_provider.delete_vpc(vpc_id, region)
                 # successfully removed cluster as no exception was raised
                 returncode = 0
 
+        elif terminate and isinstance(cloud, clouds.SCP):
+            config['provider']['cache_stopped_nodes'] = not terminate
+            provider = SCPNodeProvider(config['provider'], handle.cluster_name)
+            try:
+                if not os.path.exists(provider.metadata.path):
+                    raise SCPError('SKYPILOT_ERROR_NO_NODES_LAUNCHED: '
+                                   'Metadata file does not exist.')
+
+                with open(provider.metadata.path, 'r') as f:
+                    metadata = json.load(f)
+                    node_id = next(iter(metadata.values())).get(
+                        'creation', {}).get('virtualServerId', None)
+                    provider.terminate_node(node_id)
+                returncode = 0
+            except SCPError as e:
+                returncode = 1
+                stdout = ''
+                stderr = str(e)
+
+        # Apr, 2023 by Hysun(hysun.he@oracle.com): Added support for OCI
+        # May, 2023 by Hysun: Allow terminate INIT cluster which may have
+        # some instances provisioning in background but not completed.
+        elif (isinstance(cloud, clouds.OCI) and terminate and
+              prev_cluster_status in (status_lib.ClusterStatus.STOPPED,
+                                      status_lib.ClusterStatus.INIT)):
+            region = config['provider']['region']
+
+            # pylint: disable=import-outside-toplevel
+            from sky.skylet.providers.oci.query_helper import oci_query_helper
+            from ray.autoscaler.tags import TAG_RAY_CLUSTER_NAME
+
+            # 0: All terminated successfully, failed count otherwise
+            returncode = oci_query_helper.terminate_instances_by_tags(
+                {TAG_RAY_CLUSTER_NAME: cluster_name}, region)
+
+            # To avoid undefined local variables error.
+            stdout = stderr = ''
         elif (terminate and
-              (prev_cluster_status == global_user_state.ClusterStatus.STOPPED or
+              (prev_cluster_status == status_lib.ClusterStatus.STOPPED or
                use_tpu_vm)):
             # For TPU VMs, gcloud CLI is used for VM termination.
             if isinstance(cloud, clouds.AWS):
                 # TODO(zhwu): Room for optimization. We can move these cloud
                 # specific handling to the cloud class.
                 # The stopped instance on AWS will not be correctly terminated
                 # due to ray's bug.
                 region = config['provider']['region']
                 query_cmd = (
                     f'aws ec2 describe-instances --region {region} --filters '
                     f'Name=tag:ray-cluster-name,Values={handle.cluster_name} '
-                    f'--query Reservations[].Instances[].InstanceId '
+                    '--query Reservations[].Instances[].InstanceId '
                     '--output text')
                 terminate_cmd = (
+                    f'VMS=$({query_cmd}) && [ -n "$VMS" ] && '
                     f'aws ec2 terminate-instances --region {region} '
-                    f'--instance-ids $({query_cmd})')
+                    '--instance-ids $VMS || echo "No instances to delete."')
             elif isinstance(cloud, clouds.GCP):
                 zone = config['provider']['availability_zone']
                 # TODO(wei-lin): refactor by calling functions of node provider
                 # that uses Python API rather than CLI
                 if use_tpu_vm:
                     terminate_cmd = tpu_utils.terminate_tpu_vm_cluster_cmd(
                         cluster_name, zone, log_abs_path)
                 else:
                     query_cmd = (f'gcloud compute instances list --filter='
                                  f'"(labels.ray-cluster-name={cluster_name})" '
                                  f'--zones={zone} --format=value\\(name\\)')
+                    # If there are no instances, exit with 0 rather than causing
+                    # the delete command to fail.
                     terminate_cmd = (
-                        f'gcloud compute instances delete --zone={zone}'
-                        f' --quiet $({query_cmd})')
+                        f'VMS=$({query_cmd}) && [ -n "$VMS" ] && '
+                        f'gcloud compute instances delete --zone={zone} --quiet'
+                        ' $VMS || echo "No instances to delete."')
             else:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(f'Unsupported cloud {cloud} for stopped '
                                      f'cluster {cluster_name!r}.')
             with log_utils.safe_rich_status(f'[bold cyan]Terminating '
                                             f'[green]{cluster_name}'):
                 returncode, stdout, stderr = log_lib.run_with_log(
@@ -3331,14 +3576,32 @@
                 else:
                     raise RuntimeError(
                         _TEARDOWN_FAILURE_MESSAGE.format(
                             extra_reason='It is caused by TPU failure.',
                             cluster_name=handle.cluster_name,
                             stdout=tpu_stdout,
                             stderr=tpu_stderr))
+        if (terminate and handle.launched_resources.is_image_managed is True):
+            # Delete the image when terminating a "cloned" cluster, i.e.,
+            # whose image is created by SkyPilot (--clone-disk-from)
+            logger.debug(f'Deleting image {handle.launched_resources.image_id}')
+            cluster_resources = handle.launched_resources
+            cluster_cloud = cluster_resources.cloud
+            image_dict = cluster_resources.image_id
+            assert cluster_cloud is not None, cluster_resources
+            assert image_dict is not None and len(image_dict) == 1
+            image_id = list(image_dict.values())[0]
+            try:
+                cluster_cloud.delete_image(image_id,
+                                           handle.launched_resources.region)
+            except exceptions.CommandError as e:
+                logger.warning(
+                    f'Failed to delete cloned image {image_id}. Please '
+                    'remove it manually to avoid image leakage. Details: '
+                    f'{common_utils.format_exception(e, use_bracket=True)}')
 
         # The cluster file must exist because the cluster_yaml will only
         # be removed after the cluster entry in the database is removed.
         config = common_utils.read_yaml(handle.cluster_yaml)
         auth_config = config['auth']
         backend_utils.SSHConfigHelper.remove_cluster(handle.cluster_name,
                                                      handle.head_ip,
@@ -3410,27 +3673,46 @@
     def run_on_head(
         self,
         handle: CloudVmRayResourceHandle,
         cmd: str,
         *,
         port_forward: Optional[List[int]] = None,
         log_path: str = '/dev/null',
-        process_stream: bool = True,
         stream_logs: bool = False,
-        use_cached_head_ip: bool = True,
         ssh_mode: command_runner.SshMode = command_runner.SshMode.
         NON_INTERACTIVE,
         under_remote_workdir: bool = False,
         require_outputs: bool = False,
         separate_stderr: bool = False,
+        process_stream: bool = True,
         **kwargs,
     ) -> Union[int, Tuple[int, str, str]]:
-        """Runs 'cmd' on the cluster's head node."""
-        head_ip = backend_utils.get_head_ip(handle, use_cached_head_ip,
-                                            _FETCH_IP_MAX_ATTEMPTS)
+        """Runs 'cmd' on the cluster's head node.
+
+        Args:
+            handle: The ResourceHandle to the cluster.
+            cmd: The command to run.
+
+            Advanced options:
+
+            port_forward: A list of ports to forward.
+            log_path: The path to the log file.
+            stream_logs: Whether to stream the logs to stdout/stderr.
+            ssh_mode: The mode to use for ssh.
+                See command_runner.SSHCommandRunner.SSHMode for more details.
+            under_remote_workdir: Whether to run the command under the remote
+                workdir ~/sky_workdir.
+            require_outputs: Whether to return the stdout and stderr of the
+                command.
+            separate_stderr: Whether to separate stderr from stdout.
+            process_stream: Whether to post-process the stdout/stderr of the
+                command, such as replacing or skipping lines on the fly. If
+                enabled, lines are printed only when '\r' or '\n' is found.
+        """
+        head_ip = backend_utils.get_head_ip(handle, _FETCH_IP_MAX_ATTEMPTS)
         ssh_credentials = backend_utils.ssh_credential_from_yaml(
             handle.cluster_yaml)
         runner = command_runner.SSHCommandRunner(head_ip, **ssh_credentials)
         if under_remote_workdir:
             cmd = f'cd {SKY_REMOTE_WORKDIR} && {cmd}'
 
         return runner.run(
@@ -3445,24 +3727,27 @@
             **kwargs,
         )
 
     # --- Utilities ---
 
     @timeline.event
     def _check_existing_cluster(
-            self, task: task_lib.Task, to_provision: resources_lib.Resources,
+            self, task: task_lib.Task,
+            to_provision: Optional[resources_lib.Resources],
             cluster_name: str) -> RetryingVmProvisioner.ToProvisionConfig:
         """Checks if the cluster exists and returns the provision config.
 
         Raises:
             exceptions.ResourcesMismatchError: If the resources in the task
                 does not match the existing cluster.
             exceptions.InvalidClusterNameError: If the cluster name is invalid.
             # TODO(zhwu): complete the list of exceptions.
         """
+        handle_before_refresh = global_user_state.get_handle_from_cluster_name(
+            cluster_name)
         prev_cluster_status, handle = (
             backend_utils.refresh_cluster_status_handle(
                 cluster_name, acquire_per_cluster_status_lock=False))
         if prev_cluster_status is not None:
             assert handle is not None
             # Cluster already exists.
             self.check_resources_fit_cluster(handle, task)
@@ -3478,14 +3763,30 @@
         # Use the task_cloud, because the cloud in `to_provision` can be changed
         # later during the retry.
         resources = list(task.resources)[0]
         task_cloud = (resources.cloud
                       if resources.cloud is not None else clouds.Cloud)
         task_cloud.check_cluster_name_is_valid(cluster_name)
 
+        if to_provision is None:
+            logger.info(
+                f'The cluster {cluster_name!r} was autodowned or manually '
+                'terminated on the cloud console. Using the same resources '
+                'as the previously terminated one to provision a new cluster.')
+            # The cluster is recently terminated either by autostop or manually
+            # terminated on the cloud. We should use the previously terminated
+            # resources to provision the cluster.
+            assert isinstance(
+                handle_before_refresh, CloudVmRayResourceHandle), (
+                    f'Trying to launch cluster {cluster_name!r} recently '
+                    'terminated  on the cloud, but the handle is not a '
+                    f'CloudVmRayResourceHandle ({handle_before_refresh}).')
+            to_provision = handle_before_refresh.launched_resources
+            self.check_resources_fit_cluster(handle_before_refresh, task)
+
         cloud = to_provision.cloud
         if isinstance(cloud, clouds.Local):
             # The field ssh_user is specified in the cluster config file.
             ssh_user = onprem_utils.get_local_cluster_config_or_error(
                 cluster_name)['auth']['ssh_user']
             logger.info(f'{colorama.Fore.CYAN}Connecting to local cluster: '
                         f'{cluster_name!r} [Username: {ssh_user}].'
@@ -3725,14 +4026,19 @@
                                   f'{colorama.Style.RESET_ALL}')
                     error_msg = (f'Mount path {mount_path} is non-empty.'
                                  f' {mount_path} may be a standard unix '
                                  f'path or may contain files from a previous'
                                  f' task. To fix, change the mount path'
                                  f' to an empty or non-existent path.')
                     raise RuntimeError(error_msg) from None
+                else:
+                    # Strip the command (a big heredoc) from the exception
+                    raise exceptions.CommandError(
+                        e.returncode, command='to mount',
+                        error_msg=e.error_msg) from None
 
         end = time.time()
         logger.debug(f'Storage mount sync took {end - start} seconds.')
 
     def _execute_task_one_node(self, handle: CloudVmRayResourceHandle,
                                task: task_lib.Task, job_id: int,
                                detach_run: bool) -> None:
@@ -3741,32 +4047,33 @@
 
         accelerator_dict = backend_utils.get_task_demands_dict(task)
         internal_ips = handle.internal_ips()
         assert internal_ips is not None, 'internal_ips is not cached in handle'
 
         codegen = RayCodeGen()
         is_local = isinstance(handle.launched_resources.cloud, clouds.Local)
-        codegen.add_prologue(job_id,
-                             spot_task=task.spot_task,
-                             setup_cmd=self._setup_cmd,
-                             envs=task.envs,
-                             setup_log_path=os.path.join(log_dir, 'setup.log'),
-                             is_local=is_local)
-        codegen.add_gang_scheduling_placement_group(
-            1, accelerator_dict, stable_cluster_internal_ips=internal_ips)
+        codegen.add_prologue(job_id, is_local=is_local)
+        codegen.add_gang_scheduling_placement_group_and_setup(
+            1,
+            accelerator_dict,
+            stable_cluster_internal_ips=internal_ips,
+            setup_cmd=self._setup_cmd,
+            setup_log_path=os.path.join(log_dir, 'setup.log'),
+            envs=task.envs,
+        )
 
         if callable(task.run):
             run_fn_code = textwrap.dedent(inspect.getsource(task.run))
             run_fn_name = task.run.__name__
             codegen.register_run_fn(run_fn_code, run_fn_name)
 
-        # If it is a managed spot job, the JOB_ID_ENV_VAR will have been already
-        # set by the controller.
+        # If it is a managed spot job, the TASK_ID_ENV_VAR will have been
+        # already set by the controller.
         job_run_id = task.envs.get(
-            constants.JOB_ID_ENV_VAR,
+            constants.TASK_ID_ENV_VAR,
             common_utils.get_global_job_id(self.run_timestamp,
                                            cluster_name=handle.cluster_name,
                                            job_id=str(job_id)))
 
         command_for_node = task.run if isinstance(task.run, str) else None
         use_sudo = isinstance(handle.launched_resources.cloud, clouds.Local)
         codegen.add_ray_task(
@@ -3780,15 +4087,16 @@
 
         codegen.add_epilogue()
 
         self._exec_code_on_head(handle,
                                 codegen.build(),
                                 job_id,
                                 executable='python3',
-                                detach_run=detach_run)
+                                detach_run=detach_run,
+                                spot_dag=task.spot_dag)
 
     def _execute_task_n_nodes(self, handle: CloudVmRayResourceHandle,
                               task: task_lib.Task, job_id: int,
                               detach_run: bool) -> None:
         # Strategy:
         #   ray.init(...)
         #   for node:
@@ -3806,34 +4114,32 @@
                 handle.launched_resources)
         else:
             num_actual_nodes = task.num_nodes
         assert isinstance(num_actual_nodes, int), num_actual_nodes
 
         codegen = RayCodeGen()
         is_local = isinstance(handle.launched_resources.cloud, clouds.Local)
-        codegen.add_prologue(job_id,
-                             spot_task=task.spot_task,
-                             setup_cmd=self._setup_cmd,
-                             envs=task.envs,
-                             setup_log_path=os.path.join(log_dir, 'setup.log'),
-                             is_local=is_local)
-        codegen.add_gang_scheduling_placement_group(
+        codegen.add_prologue(job_id, is_local=is_local)
+        codegen.add_gang_scheduling_placement_group_and_setup(
             num_actual_nodes,
             accelerator_dict,
-            stable_cluster_internal_ips=internal_ips)
+            stable_cluster_internal_ips=internal_ips,
+            setup_cmd=self._setup_cmd,
+            setup_log_path=os.path.join(log_dir, 'setup.log'),
+            envs=task.envs)
 
         if callable(task.run):
             run_fn_code = textwrap.dedent(inspect.getsource(task.run))
             run_fn_name = task.run.__name__
             codegen.register_run_fn(run_fn_code, run_fn_name)
 
-        # If it is a managed spot job, the JOB_ID_ENV_VAR will have been already
-        # set by the controller.
+        # If it is a managed spot job, the TASK_ID_ENV_VAR will have been
+        # already set by the controller.
         job_run_id = task.envs.get(
-            constants.JOB_ID_ENV_VAR,
+            constants.TASK_ID_ENV_VAR,
             common_utils.get_global_job_id(self.run_timestamp,
                                            cluster_name=handle.cluster_name,
                                            job_id=str(job_id)))
 
         # TODO(zhwu): The resources limitation for multi-node ray.tune and
         # horovod should be considered.
         for i in range(num_actual_nodes):
@@ -3855,8 +4161,9 @@
 
         codegen.add_epilogue()
         # TODO(zhanghao): Add help info for downloading logs.
         self._exec_code_on_head(handle,
                                 codegen.build(),
                                 job_id,
                                 executable='python3',
-                                detach_run=detach_run)
+                                detach_run=detach_run,
+                                spot_dag=task.spot_dag)
```

### Comparing `skypilot-0.3.1/sky/backends/docker_utils.py` & `skypilot-0.3.2/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/backends/local_docker_backend.py` & `skypilot-0.3.2/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot-0.3.2/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/backends/onprem_utils.py` & `skypilot-0.3.2/sky/backends/onprem_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/backends/wheel_utils.py` & `skypilot-0.3.2/sky/backends/wheel_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/benchmark/benchmark_state.py` & `skypilot-0.3.2/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/benchmark/benchmark_utils.py` & `skypilot-0.3.2/sky/benchmark/benchmark_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -20,14 +20,15 @@
 from rich import progress as rich_progress
 
 import sky
 from sky import backends
 from sky import data
 from sky import global_user_state
 from sky import sky_logging
+from sky import status_lib
 from sky.backends import backend_utils
 from sky.benchmark import benchmark_state
 from sky.skylet import constants
 from sky.skylet import log_lib
 from sky.skylet import job_lib
 from sky.utils import log_utils
 from sky.utils import common_utils
@@ -309,29 +310,29 @@
     job_status = None
     if record is not None:
         cluster_status, handle = backend_utils.refresh_cluster_status_handle(
             cluster)
         backend = backend_utils.get_backend_from_handle(handle)
         assert isinstance(backend, backends.CloudVmRayBackend)
 
-        if cluster_status == global_user_state.ClusterStatus.UP:
+        if cluster_status == status_lib.ClusterStatus.UP:
             # NOTE: The id of the benchmarking job must be 1.
             # TODO(woosuk): Handle exceptions.
             job_status = backend.get_job_status(handle,
                                                 job_ids=['1'],
                                                 stream_logs=False)['1']
 
     # Update the benchmark status.
-    if (cluster_status == global_user_state.ClusterStatus.INIT or
+    if (cluster_status == status_lib.ClusterStatus.INIT or
             job_status < job_lib.JobStatus.RUNNING):
         benchmark_status = benchmark_state.BenchmarkStatus.INIT
     elif job_status == job_lib.JobStatus.RUNNING:
         benchmark_status = benchmark_state.BenchmarkStatus.RUNNING
     elif (cluster_status is None or
-          cluster_status == global_user_state.ClusterStatus.STOPPED or
+          cluster_status == status_lib.ClusterStatus.STOPPED or
           (job_status is not None and job_status.is_terminal())):
         # The cluster has terminated or stopped, or
         # the cluster is UP and the job has terminated.
         if end_time is not None:
             # The job has terminated with zero exit code.
             benchmark_status = benchmark_state.BenchmarkStatus.FINISHED
         elif job_status == job_lib.JobStatus.SUCCEEDED:
```

### Comparing `skypilot-0.3.1/sky/check.py` & `skypilot-0.3.2/sky/check.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/cli.py` & `skypilot-0.3.2/sky/cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -15,58 +15,59 @@
 
   # Tear down a specific cluster.
   >> sky down cluster_name
 
   # Tear down all existing clusters.
   >> sky down -a
 
-TODO:
-- Add support for local Docker backend.  Currently this module is very coupled
-  with CloudVmRayBackend, as seen by the many use of ray commands.
-
 NOTE: the order of command definitions in this file corresponds to how they are
 listed in "sky --help".  Take care to put logically connected commands close to
 each other.
 """
 import copy
 import datetime
 import functools
 import multiprocessing
 import os
 import shlex
+import signal
 import subprocess
 import sys
 import textwrap
+import time
 import typing
-from typing import Any, Dict, List, Optional, Tuple
+from typing import Any, Dict, List, Optional, Tuple, Union
+import webbrowser
 
 import click
 import colorama
 from rich import progress as rich_progress
 import yaml
 
 import sky
 from sky import backends
 from sky import check as sky_check
 from sky import clouds
+from sky import core
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import spot as spot_lib
-from sky import core
+from sky import status_lib
 from sky.backends import backend_utils
 from sky.backends import onprem_utils
 from sky.benchmark import benchmark_state
 from sky.benchmark import benchmark_utils
 from sky.clouds import service_catalog
 from sky.data import storage_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.utils import log_utils
 from sky.utils import common_utils
+from sky.utils import dag_utils
 from sky.utils import command_runner
 from sky.utils import schemas
 from sky.utils import subprocess_utils
 from sky.utils import timeline
 from sky.utils import ux_utils
 from sky.utils.cli_utils import status_utils
 from sky.usage import usage_lib
@@ -719,20 +720,29 @@
     detach_setup: bool = False,
     no_confirm: bool = False,
     idle_minutes_to_autostop: Optional[int] = None,
     down: bool = False,  # pylint: disable=redefined-outer-name
     retry_until_up: bool = False,
     no_setup: bool = False,
     node_type: Optional[str] = None,
+    clone_disk_from: Optional[str] = None,
 ):
     """Launch a cluster with a Task."""
-    with sky.Dag() as dag:
-        dag.add(task)
     if cluster is None:
         cluster = backend_utils.generate_cluster_name()
+
+    clone_source_str = ''
+    if clone_disk_from is not None:
+        clone_source_str = f' from the disk of {clone_disk_from!r}'
+        task, _ = backend_utils.check_can_clone_disk_and_override_task(
+            clone_disk_from, cluster, task)
+
+    with sky.Dag() as dag:
+        dag.add(task)
+
     maybe_status, _ = backend_utils.refresh_cluster_status_handle(cluster)
     if maybe_status is None:
         # Show the optimize log before the prompt if the cluster does not exist.
         try:
             backend_utils.check_public_cloud_enabled()
         except exceptions.NoCloudAccessError as e:
             # Catch the exception where the public cloud is not enabled, and
@@ -750,50 +760,53 @@
         # it exists but is STOPPED.
         prompt = None
         if maybe_status is None:
             cluster_str = '' if cluster is None else f' {cluster!r}'
             if onprem_utils.check_if_local_cloud(cluster):
                 prompt = f'Initializing local cluster{cluster_str}. Proceed?'
             else:
-                prompt = f'Launching a new cluster{cluster_str}. Proceed?'
-        elif maybe_status == global_user_state.ClusterStatus.STOPPED:
+                prompt = (
+                    f'Launching a new cluster{cluster_str}{clone_source_str}. '
+                    'Proceed?')
+        elif maybe_status == status_lib.ClusterStatus.STOPPED:
             prompt = f'Restarting the stopped cluster {cluster!r}. Proceed?'
         if prompt is not None:
             confirm_shown = True
             click.confirm(prompt, default=True, abort=True, show_default=True)
 
     if node_type is not None:
-        if maybe_status != global_user_state.ClusterStatus.UP:
+        if maybe_status != status_lib.ClusterStatus.UP:
             click.secho(f'Setting up interactive node {cluster}...',
                         fg='yellow')
 
         # We do not sky.launch if interactive node is already up, so we need
         # to update idle timeout and autodown here.
         elif idle_minutes_to_autostop is not None:
             core.autostop(cluster, idle_minutes_to_autostop, down)
         elif down:
             core.autostop(cluster, 1, down)
 
     elif not confirm_shown:
         click.secho(f'Running task on cluster {cluster}...', fg='yellow')
 
-    if node_type is None or maybe_status != global_user_state.ClusterStatus.UP:
+    if node_type is None or maybe_status != status_lib.ClusterStatus.UP:
         # No need to sky.launch again when interactive node is already up.
         sky.launch(
             dag,
             dryrun=dryrun,
             stream_logs=True,
             cluster_name=cluster,
             detach_setup=detach_setup,
             detach_run=detach_run,
             backend=backend,
             idle_minutes_to_autostop=idle_minutes_to_autostop,
             down=down,
             retry_until_up=retry_until_up,
             no_setup=no_setup,
+            clone_disk_from=clone_disk_from,
         )
 
 
 # TODO: skip installing ray to speed up provisioning.
 def _create_and_ssh_into_node(
     node_type: str,
     resources: sky.Resources,
@@ -924,23 +937,31 @@
 def _check_yaml(entrypoint: str) -> Tuple[bool, Optional[Dict[str, Any]]]:
     """Checks if entrypoint is a readable YAML file.
 
     Args:
         entrypoint: Path to a YAML file.
     """
     is_yaml = True
-    config = None
+    config: Optional[List[Dict[str, Any]]] = None
+    result = None
     shell_splits = shlex.split(entrypoint)
-    yaml_file_provided = len(shell_splits) == 1 and \
-        (shell_splits[0].endswith('yaml') or shell_splits[0].endswith('.yml'))
+    yaml_file_provided = (len(shell_splits) == 1 and
+                          (shell_splits[0].endswith('yaml') or
+                           shell_splits[0].endswith('.yml')))
     try:
         with open(entrypoint, 'r') as f:
             try:
-                config = yaml.safe_load(f)
-                if isinstance(config, str):
+                config = list(yaml.safe_load_all(f))
+                if config:
+                    # FIXME(zongheng): in a chain DAG YAML it only returns the
+                    # first section. OK for downstream but is weird.
+                    result = config[0]
+                else:
+                    result = {}
+                if isinstance(result, str):
                     # 'sky exec cluster ./my_script.sh'
                     is_yaml = False
             except yaml.YAMLError as e:
                 if yaml_file_provided:
                     logger.debug(e)
                     invalid_reason = ('contains an invalid configuration. '
                                       ' Please check syntax.')
@@ -960,18 +981,18 @@
         is_yaml = False
     if not is_yaml:
         if yaml_file_provided:
             click.confirm(
                 f'{entrypoint!r} looks like a yaml path but {invalid_reason}\n'
                 'It will be treated as a command to be run remotely. Continue?',
                 abort=True)
-    return is_yaml, config
+    return is_yaml, result
 
 
-def _make_task_from_entrypoint_with_overrides(
+def _make_task_or_dag_from_entrypoint_with_overrides(
     entrypoint: List[str],
     *,
     name: Optional[str] = None,
     cluster: Optional[str] = None,
     workdir: Optional[str] = None,
     cloud: Optional[str] = None,
     region: Optional[str] = None,
@@ -984,15 +1005,21 @@
     use_spot: Optional[bool] = None,
     image_id: Optional[str] = None,
     disk_size: Optional[int] = None,
     disk_tier: Optional[str] = None,
     env: Optional[List[Tuple[str, str]]] = None,
     # spot launch specific
     spot_recovery: Optional[str] = None,
-) -> sky.Task:
+) -> Union[sky.Task, sky.Dag]:
+    """Creates a task or a dag from an entrypoint with overrides.
+
+    Returns:
+        A dag iff the entrypoint is YAML and contains more than 1 task.
+        Otherwise, a task.
+    """
     entrypoint = ' '.join(entrypoint)
     is_yaml, yaml_config = _check_yaml(entrypoint)
     entrypoint: Optional[str]
     if is_yaml:
         # Treat entrypoint as a yaml.
         click.secho('Task from YAML spec: ', fg='yellow', nl=False)
         click.secho(entrypoint, bold=True)
@@ -1000,46 +1027,57 @@
         if not entrypoint:
             entrypoint = None
         else:
             # Treat entrypoint as a bash command.
             click.secho('Task from command: ', fg='yellow', nl=False)
             click.secho(entrypoint, bold=True)
 
-    if is_yaml:
-        assert entrypoint is not None
-        usage_lib.messages.usage.update_user_task_yaml(entrypoint)
-        task = sky.Task.from_yaml(entrypoint)
-    else:
-        task = sky.Task(name='sky-cmd', run=entrypoint)
-        task.set_resources({sky.Resources()})
-
-    # Override.
-    if workdir is not None:
-        task.workdir = workdir
-
     if onprem_utils.check_local_cloud_args(cloud, cluster, yaml_config):
         cloud = 'local'
 
     override_params = _parse_override_params(cloud=cloud,
                                              region=region,
                                              zone=zone,
                                              gpus=gpus,
                                              cpus=cpus,
                                              memory=memory,
                                              instance_type=instance_type,
                                              use_spot=use_spot,
                                              image_id=image_id,
                                              disk_size=disk_size,
                                              disk_tier=disk_tier)
+
+    if is_yaml:
+        assert entrypoint is not None
+        usage_lib.messages.usage.update_user_task_yaml(entrypoint)
+        dag = dag_utils.load_chain_dag_from_yaml(entrypoint, env_overrides=env)
+        if len(dag.tasks) > 1:
+            # When the dag has more than 1 task. It is unclear how to
+            # override the params for the dag. So we just ignore the
+            # override params.
+            if override_params:
+                click.secho(
+                    f'WARNING: override params {override_params} are ignored, '
+                    'since the yaml file contains multiple tasks.',
+                    fg='yellow')
+            return dag
+        assert len(dag.tasks) == 1, (
+            f'If you see this, please file an issue; tasks: {dag.tasks}')
+        task = dag.tasks[0]
+    else:
+        task = sky.Task(name='sky-cmd', run=entrypoint)
+        task.set_resources({sky.Resources()})
+
+    # Override.
+    if workdir is not None:
+        task.workdir = workdir
+
     # Spot launch specific.
     if spot_recovery is not None:
-        if spot_recovery.lower() == 'none':
-            override_params['spot_recovery'] = None
-        else:
-            override_params['spot_recovery'] = spot_recovery
+        override_params['spot_recovery'] = spot_recovery
 
     assert len(task.resources) == 1
     old_resources = list(task.resources)[0]
     new_resources = old_resources.copy(**override_params)
 
     task.set_resources({new_resources})
 
@@ -1235,14 +1273,23 @@
               required=False,
               help='Skip confirmation prompt.')
 @click.option('--no-setup',
               is_flag=True,
               default=False,
               required=False,
               help='Skip setup phase when (re-)launching cluster.')
+@click.option(
+    '--clone-disk-from',
+    '--clone',
+    default=None,
+    type=str,
+    **_get_shell_complete_args(_complete_cluster_name),
+    help=('[Experimental] Clone disk from an existing cluster to launch '
+          'a new one. This is useful when the new cluster needs to have '
+          'the same data on the boot disk as an existing cluster.'))
 @usage_lib.entrypoint
 def launch(
     entrypoint: List[str],
     cluster: Optional[str],
     dryrun: bool,
     detach_setup: bool,
     detach_run: bool,
@@ -1263,14 +1310,15 @@
     disk_size: Optional[int],
     disk_tier: Optional[str],
     idle_minutes_to_autostop: Optional[int],
     down: bool,  # pylint: disable=redefined-outer-name
     retry_until_up: bool,
     yes: bool,
     no_setup: bool,
+    clone_disk_from: Optional[str],
 ):
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Launch a task from a YAML or a command (rerun setup if cluster exists).
 
     If ENTRYPOINT points to a valid YAML file, it is read in as the task
     specification. Otherwise, it is interpreted as a bash command.
 
@@ -1287,15 +1335,15 @@
     if (cloud is not None and cloud.lower() == 'azure' and
             use_spot is not None and use_spot):
         raise click.UsageError(
             'SkyPilot currently has not implemented '
             'support for spot instances on Azure. Please file '
             'an issue if you need this feature.')
 
-    task = _make_task_from_entrypoint_with_overrides(
+    task_or_dag = _make_task_or_dag_from_entrypoint_with_overrides(
         entrypoint=entrypoint,
         name=name,
         cluster=cluster,
         workdir=workdir,
         cloud=cloud,
         region=region,
         zone=zone,
@@ -1306,14 +1354,20 @@
         num_nodes=num_nodes,
         use_spot=use_spot,
         image_id=image_id,
         env=env,
         disk_size=disk_size,
         disk_tier=disk_tier,
     )
+    if isinstance(task_or_dag, sky.Dag):
+        raise click.UsageError(
+            'YAML specifies a DAG which is only supported by '
+            '`sky spot launch`. `sky launch` supports a '
+            'single task only.')
+    task = task_or_dag
 
     backend: backends.Backend
     if backend_name == backends.LocalDockerBackend.NAME:
         backend = backends.LocalDockerBackend()
     elif backend_name == backends.CloudVmRayBackend.NAME:
         backend = backends.CloudVmRayBackend()
     else:
@@ -1326,15 +1380,16 @@
                          dryrun=dryrun,
                          detach_setup=detach_setup,
                          detach_run=detach_run,
                          no_confirm=yes,
                          idle_minutes_to_autostop=idle_minutes_to_autostop,
                          down=down,
                          retry_until_up=retry_until_up,
-                         no_setup=no_setup)
+                         no_setup=no_setup,
+                         clone_disk_from=clone_disk_from)
 
 
 @cli.command(cls=_DocumentedCodeCommand)
 @click.argument('cluster',
                 required=True,
                 type=str,
                 **_get_shell_complete_args(_complete_cluster_name))
@@ -1435,15 +1490,15 @@
             raise click.BadParameter(
                 constants.UNINITIALIZED_ONPREM_CLUSTER_MESSAGE.format(
                     cluster=cluster))
         raise click.BadParameter(f'Cluster {cluster!r} not found. '
                                  'Use `sky launch` to provision first.')
     backend = backend_utils.get_backend_from_handle(handle)
 
-    task = _make_task_from_entrypoint_with_overrides(
+    task_or_dag = _make_task_or_dag_from_entrypoint_with_overrides(
         entrypoint=entrypoint,
         name=name,
         cluster=cluster,
         workdir=workdir,
         cloud=cloud,
         region=region,
         zone=zone,
@@ -1453,14 +1508,19 @@
         instance_type=instance_type,
         use_spot=use_spot,
         image_id=image_id,
         num_nodes=num_nodes,
         env=env,
     )
 
+    if isinstance(task_or_dag, sky.Dag):
+        raise click.UsageError('YAML specifies a DAG, while `sky exec` '
+                               'supports a single task only.')
+    task = task_or_dag
+
     click.secho(f'Executing task on cluster {cluster}...', fg='yellow')
     sky.exec(task, backend=backend, cluster_name=cluster, detach_run=detach_run)
 
 
 def _get_spot_jobs(
         refresh: bool,
         skip_finished: bool,
@@ -1493,28 +1553,27 @@
         with sky_logging.silent():
             # Make the call silent
             spot_jobs = core.spot_queue(refresh=refresh,
                                         skip_finished=skip_finished)
         num_in_progress_jobs = len(spot_jobs)
     except exceptions.ClusterNotUpError as e:
         controller_status = e.cluster_status
-        if controller_status == global_user_state.ClusterStatus.INIT:
+        if controller_status == status_lib.ClusterStatus.INIT:
             msg = ('Controller\'s latest status is INIT; jobs '
                    'will not be shown until it becomes UP.')
         else:
-            assert controller_status in [
-                None, global_user_state.ClusterStatus.STOPPED
-            ]
+            assert controller_status in [None, status_lib.ClusterStatus.STOPPED]
             msg = 'No in progress jobs.'
             if controller_status is None:
                 msg += (f' (See: {colorama.Style.BRIGHT}sky spot -h'
                         f'{colorama.Style.RESET_ALL})')
-    except RuntimeError:
+    except RuntimeError as e:
         msg = ('Failed to query spot jobs due to connection '
-               'issues. Try again later.')
+               'issues. Try again later. '
+               f'Details: {common_utils.format_exception(e, use_bracket=True)}')
     except Exception as e:  # pylint: disable=broad-except
         msg = ('Failed to query spot jobs: '
                f'{common_utils.format_exception(e, use_bracket=True)}')
     else:
         max_jobs_to_show = (_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS
                             if limit_num_jobs_to_show else None)
         msg = spot_lib.format_job_table(spot_jobs,
@@ -1678,15 +1737,17 @@
                             f' ({_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS} latest ones '
                             'shown)')
                     job_info += '. '
                 hints.append(
                     f'* {job_info}To see all spot jobs: {colorama.Style.BRIGHT}'
                     f'sky spot queue{colorama.Style.RESET_ALL}')
 
-        if num_pending_autostop > 0:
+        if num_pending_autostop > 0 and not refresh:
+            # Don't print this hint if there's no pending autostop or user has
+            # already passed --refresh.
             plural_and_verb = ' has'
             if num_pending_autostop > 1:
                 plural_and_verb = 's have'
             hints.append(f'* {num_pending_autostop} cluster{plural_and_verb} '
                          'auto{stop,down} scheduled. Refresh statuses with: '
                          f'{colorama.Style.BRIGHT}sky status --refresh'
                          f'{colorama.Style.RESET_ALL}')
@@ -2180,15 +2241,15 @@
     '--down',
     default=False,
     is_flag=True,
     required=False,
     help=
     ('Autodown the cluster: tear down the cluster after specified minutes of '
      'idle time after all jobs finish (successfully or abnormally). Requires '
-     ' --idle-minutes-to-autostop to be set.'),
+     '--idle-minutes-to-autostop to be set.'),
 )
 @click.option(
     '--retry-until-up',
     '-r',
     default=False,
     is_flag=True,
     required=False,
@@ -2295,32 +2356,31 @@
             #
             #    2. It can be an up cluster that failed one of the setup steps.
             #      This way 'sky start' can change its status to UP, enabling
             #      'sky ssh' to debug things (otherwise `sky ssh` will fail an
             #      INIT state cluster due to head_ip not being cached).
             #
             #      This can be replicated by adding `exit 1` to Task.setup.
-            if (not force and
-                    cluster_status == global_user_state.ClusterStatus.UP):
+            if (not force and cluster_status == status_lib.ClusterStatus.UP):
                 # An UP cluster; skipping 'sky start' because:
                 #  1. For a really up cluster, this has no effects (ray up -y
                 #    --no-restart) anyway.
                 #  2. A cluster may show as UP but is manually stopped in the
                 #    UI.  If Azure/GCP: ray autoscaler doesn't support reusing,
                 #    so 'sky start existing' will actually launch a new
                 #    cluster with this name, leaving the original cluster
                 #    zombied (remains as stopped in the cloud's UI).
                 #
                 #    This is dangerous and unwanted behavior!
                 click.echo(f'Cluster {name} already has status UP.')
                 continue
 
             assert force or cluster_status in (
-                global_user_state.ClusterStatus.INIT,
-                global_user_state.ClusterStatus.STOPPED), cluster_status
+                status_lib.ClusterStatus.INIT,
+                status_lib.ClusterStatus.STOPPED), cluster_status
             to_start.append(name)
     if not to_start:
         return
 
     # Checks for reserved clusters (spot controller).
     reserved, non_reserved = [], []
     for name in to_start:
@@ -2441,15 +2501,15 @@
     # spot_jobs will be empty when the spot cluster is not running.
     cluster_status, _ = backend_utils.refresh_cluster_status_handle(
         controller_name)
     if cluster_status is None:
         click.echo('Managed spot controller has already been torn down.')
         return
 
-    if cluster_status == global_user_state.ClusterStatus.INIT:
+    if cluster_status == status_lib.ClusterStatus.INIT:
         with ux_utils.print_exception_no_traceback():
             raise exceptions.NotSupportedError(
                 f'{colorama.Fore.RED}Tearing down the spot controller while '
                 'it is in INIT state is not supported (this means a spot '
                 'launch is in progress or the previous launch failed), as we '
                 'cannot '
                 'guarantee that all the spot jobs are finished. Please wait '
@@ -2458,15 +2518,15 @@
                 f'{spot_lib.SPOT_CONTROLLER_NAME}{colorama.Style.RESET_ALL}.')
     msg = (f'{colorama.Fore.YELLOW}WARNING: Tearing down the managed '
            f'spot controller ({cluster_status.value}). Please be '
            f'aware of the following:{colorama.Style.RESET_ALL}'
            '\n * All logs and status information of the spot '
            'jobs (output of `sky spot queue`) will be lost.')
     click.echo(msg)
-    if cluster_status == global_user_state.ClusterStatus.UP:
+    if cluster_status == status_lib.ClusterStatus.UP:
         with log_utils.safe_rich_status(
                 '[bold cyan]Checking for in-progress spot jobs[/]'):
             try:
                 spot_jobs = core.spot_queue(refresh=False)
             except exceptions.ClusterNotUpError:
                 # The spot controller cluster status changed during querying
                 # the spot jobs, use the latest cluster status, so that the
@@ -2476,15 +2536,15 @@
                     controller_name)
                 spot_jobs = []
 
         # Find in-progress spot jobs, and hint users to cancel them.
         non_terminal_jobs = [
             job for job in spot_jobs if not job['status'].is_terminal()
         ]
-        if (cluster_status == global_user_state.ClusterStatus.UP and
+        if (cluster_status == status_lib.ClusterStatus.UP and
                 non_terminal_jobs):
             job_table = spot_lib.format_job_table(non_terminal_jobs,
                                                   show_all=False)
             msg = (f'{colorama.Fore.RED}In-progress spot jobs found. '
                    'To avoid resource leakage, cancel all jobs first: '
                    f'{colorama.Style.BRIGHT}sky spot cancel -a'
                    f'{colorama.Style.RESET_ALL}\n')
@@ -3216,16 +3276,15 @@
     if all:
         click.echo('Deleting all storage objects.')
         storages = sky.storage_ls()
         names = [s['name'] for s in storages]
     else:
         names = _get_glob_storages(names)
 
-    for name in names:
-        sky.storage_delete(name)
+    subprocess_utils.run_in_parallel(sky.storage_delete, names)
 
 
 @cli.group(cls=_NaturalOrderGroup)
 def admin():
     """SkyPilot On-prem administrator CLI."""
     pass
 
@@ -3403,18 +3462,15 @@
     .. code-block:: bash
 
       # You can use normal task YAMLs.
       sky spot launch task.yaml
 
       sky spot launch 'echo hello!'
     """
-    if name is None:
-        name = backend_utils.generate_cluster_name()
-
-    task = _make_task_from_entrypoint_with_overrides(
+    task_or_dag = _make_task_or_dag_from_entrypoint_with_overrides(
         entrypoint,
         name=name,
         workdir=workdir,
         cloud=cloud,
         region=region,
         zone=zone,
         gpus=gpus,
@@ -3438,29 +3494,44 @@
             f'Flag {flag_str} is deprecated and will be removed in a '
             'future release (managed spot jobs will always be retried). '
             'Please file an issue if this does not work for you.',
             fg='yellow')
     else:
         retry_until_up = True
 
+    if not isinstance(task_or_dag, sky.Dag):
+        assert isinstance(task_or_dag, sky.Task), task_or_dag
+        with sky.Dag() as dag:
+            dag.add(task_or_dag)
+            dag.name = task_or_dag.name
+    else:
+        dag = task_or_dag
+
+    if name is not None:
+        dag.name = name
+
+    dag_utils.maybe_infer_and_fill_dag_and_task_names(dag)
+
     if not yes:
-        prompt = f'Launching a new spot task {name!r}. Proceed?'
+        prompt = f'Launching a new spot job {dag.name!r}. Proceed?'
         if prompt is not None:
             click.confirm(prompt, default=True, abort=True, show_default=True)
 
-    # We try our best to validate the cluster name before we launch the task.
-    # If the cloud is not specified, this will only validate the cluster name
-    # against the regex, and the cloud-specific validation will be done by
-    # the spot controller when actually launching the spot cluster.
-    resources = list(task.resources)[0]
-    task_cloud = (resources.cloud
-                  if resources.cloud is not None else clouds.Cloud)
-    task_cloud.check_cluster_name_is_valid(name)
+    for task in dag.tasks:
+        # We try our best to validate the cluster name before we launch the
+        # task. If the cloud is not specified, this will only validate the
+        # cluster name against the regex, and the cloud-specific validation will
+        # be done by the spot controller when actually launching the spot
+        # cluster.
+        resources = list(task.resources)[0]
+        task_cloud = (resources.cloud
+                      if resources.cloud is not None else clouds.Cloud)
+        task_cloud.check_cluster_name_is_valid(name)
 
-    sky.spot_launch(task,
+    sky.spot_launch(dag,
                     name,
                     detach_run=detach_run,
                     retry_until_up=retry_until_up)
 
 
 @spot.command('queue', cls=_DocumentedCodeCommand)
 @click.option('--all',
@@ -3653,14 +3724,71 @@
         else:
             core.spot_tail_logs(name=name, job_id=job_id, follow=follow)
     except exceptions.ClusterNotUpError:
         # Hint messages already printed by the call above.
         sys.exit(1)
 
 
+@spot.command('dashboard', cls=_DocumentedCodeCommand)
+@click.option(
+    '--port',
+    '-p',
+    default=None,
+    type=int,
+    required=False,
+    help=('Local port to use for the dashboard. If None, a free port is '
+          'automatically chosen.'))
+@usage_lib.entrypoint
+def spot_dashboard(port: Optional[int]):
+    """Opens a dashboard for spot jobs (needs controller to be UP)."""
+    # TODO(zongheng): ideally, the controller/dashboard server should expose the
+    # API perhaps via REST. Then here we would (1) not have to use SSH to try to
+    # see if the controller is UP first, which is slow; (2) not have to run SSH
+    # port forwarding first (we'd just launch a local dashboard which would make
+    # REST API calls to the controller dashboard server).
+    click.secho('Checking if spot controller is up...', fg='yellow')
+    hint = (
+        'Dashboard is not available if spot controller is not up. Run a spot '
+        'job first.')
+    _, handle = spot_lib.is_spot_controller_up(stopped_message=hint,
+                                               non_existent_message=hint)
+    if handle is None:
+        sys.exit(1)
+    # SSH forward a free local port to remote's dashboard port.
+    remote_port = constants.SPOT_DASHBOARD_REMOTE_PORT
+    if port is None:
+        free_port = common_utils.find_free_port(remote_port)
+    else:
+        free_port = port
+    ssh_command = (f'ssh -qNL {free_port}:localhost:{remote_port} '
+                   f'{spot_lib.SPOT_CONTROLLER_NAME}')
+    click.echo('Forwarding port: ', nl=False)
+    click.secho(f'{ssh_command}', dim=True)
+
+    with subprocess.Popen(ssh_command, shell=True,
+                          start_new_session=True) as ssh_process:
+        time.sleep(3)  # Added delay for ssh_command to initialize.
+        webbrowser.open(f'http://localhost:{free_port}')
+        click.secho(
+            f'Dashboard is now available at: http://127.0.0.1:{free_port}',
+            fg='green')
+        try:
+            ssh_process.wait()
+        except KeyboardInterrupt:
+            # When user presses Ctrl-C in terminal, exits the previous ssh
+            # command so that <free local port> is freed up.
+            try:
+                os.killpg(os.getpgid(ssh_process.pid), signal.SIGTERM)
+            except ProcessLookupError:
+                # This happens if spot controller is auto-stopped.
+                pass
+        finally:
+            click.echo('Exiting.')
+
+
 # ==============================
 # Sky Benchmark CLIs
 # ==============================
 
 
 @ux_utils.print_exception_no_traceback()
 def _get_candidate_configs(yaml_path: str) -> Optional[List[Dict[str, str]]]:
```

### Comparing `skypilot-0.3.1/sky/cloud_stores.py` & `skypilot-0.3.2/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/clouds/__init__.py` & `skypilot-0.3.2/sky/clouds/__init__.py`

 * *Files 20% similar despite different names*

```diff
@@ -6,21 +6,25 @@
 from sky.clouds.cloud import Zone
 from sky.clouds.aws import AWS
 from sky.clouds.azure import Azure
 from sky.clouds.gcp import GCP
 from sky.clouds.lambda_cloud import Lambda
 from sky.clouds.local import Local
 from sky.clouds.ibm import IBM
+from sky.clouds.scp import SCP
+from sky.clouds.oci import OCI
 
 __all__ = [
     'IBM',
     'AWS',
     'Azure',
     'Cloud',
     'GCP',
     'Lambda',
     'Local',
+    'SCP',
+    'OCI',
     'CloudImplementationFeatures',
     'Region',
     'Zone',
     'CLOUD_REGISTRY',
 ]
```

### Comparing `skypilot-0.3.1/sky/clouds/aws.py` & `skypilot-0.3.2/sky/clouds/aws.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,28 +1,35 @@
 """Amazon Web Services."""
 import enum
 import functools
 import json
 import os
 import re
 import subprocess
+import time
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple, Any
 
 from sky import clouds
 from sky import exceptions
+from sky import sky_logging
+from sky import status_lib
 from sky.adaptors import aws
 from sky.clouds import service_catalog
 from sky.utils import common_utils
+from sky.utils import log_utils
+from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     # renaming to avoid shadowing variables
     from sky import resources as resources_lib
 
+logger = sky_logging.init_logger(__name__)
+
 # This local file (under ~/.aws/) will be uploaded to remote nodes (any
 # cloud), if all of the following conditions hold:
 #   - the current user identity is not using AWS SSO
 #   - this file exists
 # It has the following purposes:
 #   - make all nodes (any cloud) able to access private S3 buckets
 #   - make some remote nodes able to launch new nodes on AWS (i.e., makes
@@ -102,15 +109,15 @@
 
     @classmethod
     def _max_cluster_name_length(cls) -> Optional[int]:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
     @classmethod
     def _sso_credentials_help_str(cls, expired: bool = False) -> str:
-        help_str = 'Run the following commands (must use aws v2 CLI):'
+        help_str = 'Run the following commands (must use AWS CLI v2):'
         if not expired:
             help_str += f'\n{cls._INDENT_PREFIX}  $ aws configure sso'
         help_str += (
             f'\n{cls._INDENT_PREFIX}  $ aws sso login --profile <profile_name>'
             f'\n{cls._INDENT_PREFIX}For more info: '
             'https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html'  # pylint: disable=line-too-long
         )
@@ -405,21 +412,14 @@
             return ([], fuzzy_candidate_list)
         return (_make(instance_list), fuzzy_candidate_list)
 
     @classmethod
     @functools.lru_cache(maxsize=1)  # Cache since getting identity is slow.
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
         """Checks if the user has access credentials to this cloud."""
-        try:
-            # pylint: disable=import-outside-toplevel,unused-import
-            import boto3
-            import botocore
-        except ImportError:
-            raise ImportError('Fail to import dependencies for AWS.'
-                              'Try pip install "skypilot[aws]"') from None
 
         # Checks if the AWS CLI is installed properly
         proc = subprocess.run('aws --version',
                               shell=True,
                               check=False,
                               stdout=subprocess.PIPE,
                               stderr=subprocess.PIPE)
@@ -467,15 +467,15 @@
             # other clouds to access private s3 buckets and resources like EC2.
             # `get_current_user_identity` does not guarantee this file exists.
             if not static_credential_exists:
                 return (False, '~/.aws/credentials does not exist. ' +
                         cls._STATIC_CREDENTIAL_HELP_STR)
 
         # Fetch the AWS catalogs
-        from sky.clouds.service_catalog import aws_catalog  # pylint: disable=import-outside-toplevel,unused-import
+        from sky.clouds.service_catalog import aws_catalog  # pylint: disable=import-outside-toplevel
         # Trigger the fetch of the availability zones mapping.
         aws_catalog.get_default_instance_type()
         return True, hints
 
     @classmethod
     def _current_identity_type(cls) -> Optional[AWSIdentityType]:
         proc = subprocess.run('aws configure list',
@@ -683,7 +683,234 @@
         }
         return {
             'disk_tier': cls._get_disk_type(tier),
             'disk_iops': tier2iops[tier],
             'disk_throughput': tier2iops[tier] // 16,
             'custom_disk_perf': tier != 'low',
         }
+
+    @classmethod
+    def check_quota_available(cls,
+                              region: str,
+                              instance_type: str,
+                              use_spot: bool = False) -> bool:
+        """Check if AWS quota is available for `instance_type` in `region`.
+
+        AWS-specific implementation of check_quota_available. The function works by
+        matching the instance_type to the corresponding AWS quota code, and then using
+        the boto3 Python API to query the region for the specific quota code.
+
+        Returns:
+            False if the quota is found to be zero, and True otherwise.
+        Raises:
+            ImportError: if the dependencies for AWS are not able to be installed.
+            botocore.exceptions.ClientError: error in Boto3 client request.
+        """
+
+        from sky.clouds.service_catalog import aws_catalog  # pylint: disable=import-outside-toplevel,unused-import
+
+        quota_code = aws_catalog.get_quota_code(instance_type, use_spot)
+
+        if quota_code is None:
+            # Quota code not found in the catalog for the chosen instance_type, try provisioning anyway
+            return True
+
+        client = aws.client('service-quotas', region_name=region)
+        try:
+            response = client.get_service_quota(ServiceCode='ec2',
+                                                QuotaCode=quota_code)
+        except aws.botocore_exceptions().ClientError:
+            # Botocore client connection not established, try provisioning anyways
+            return True
+
+        if response['Quota']['Value'] == 0:
+            # Quota found to be zero, do not try provisioning
+            return False
+
+        # Quota found to be greater than zero, try provisioning
+        return True
+
+    @classmethod
+    def _query_instance_property_with_retries(
+        cls,
+        tag_filters: Dict[str, str],
+        region: str,
+        query: str,
+    ) -> Tuple[int, str, str]:
+        filter_str = ' '.join(f'Name=tag:{key},Values={value}'
+                              for key, value in tag_filters.items())
+        query_cmd = (f'aws ec2 describe-instances --filters {filter_str} '
+                     f'--region {region} --query "{query}" --output json')
+        returncode, stdout, stderr = subprocess_utils.run_with_retries(
+            query_cmd,
+            retry_returncode=[255],
+            retry_stderrs=[
+                'Unable to locate credentials. You can configure credentials by '
+                'running "aws configure"'
+            ])
+        return returncode, stdout, stderr
+
+    @classmethod
+    def query_status(cls, name: str, tag_filters: Dict[str, str],
+                     region: Optional[str], zone: Optional[str],
+                     **kwargs) -> List['status_lib.ClusterStatus']:
+        del zone  # unused
+        status_map = {
+            'pending': status_lib.ClusterStatus.INIT,
+            'running': status_lib.ClusterStatus.UP,
+            # TODO(zhwu): stopping and shutting-down could occasionally fail
+            # due to internal errors of AWS. We should cover that case.
+            'stopping': status_lib.ClusterStatus.STOPPED,
+            'stopped': status_lib.ClusterStatus.STOPPED,
+            'shutting-down': None,
+            'terminated': None,
+        }
+
+        assert region is not None, (tag_filters, region)
+        returncode, stdout, stderr = cls._query_instance_property_with_retries(
+            tag_filters, region, query='Reservations[].Instances[].State.Name')
+
+        if returncode != 0:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.ClusterStatusFetchingError(
+                    f'Failed to query AWS cluster {name!r} status: '
+                    f'{stdout + stderr}')
+
+        original_statuses = json.loads(stdout.strip())
+
+        statuses = []
+        for s in original_statuses:
+            node_status = status_map[s]
+            if node_status is not None:
+                statuses.append(node_status)
+        return statuses
+
+    @classmethod
+    def create_image_from_cluster(cls, cluster_name: str,
+                                  tag_filters: Dict[str,
+                                                    str], region: Optional[str],
+                                  zone: Optional[str]) -> str:
+        del zone  # unused
+        assert region is not None, (tag_filters, region)
+        image_name = f'skypilot-{cluster_name}-{int(time.time())}'
+        returncode, stdout, stderr = cls._query_instance_property_with_retries(
+            tag_filters, region, query='Reservations[].Instances[].InstanceId')
+
+        subprocess_utils.handle_returncode(
+            returncode,
+            '',
+            error_msg='Failed to find the source cluster on AWS.',
+            stderr=stderr,
+            stream_logs=False)
+
+        instance_ids = json.loads(stdout.strip())
+        if len(instance_ids) != 1:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.NotSupportedError(
+                    'Only support creating image from single '
+                    f'instance, but got: {instance_ids}')
+
+        instance_id = instance_ids[0]
+        create_image_cmd = (
+            f'aws ec2 create-image --region {region} --instance-id {instance_id} '
+            f'--name {image_name} --output text')
+        returncode, image_id, stderr = subprocess_utils.run_with_retries(
+            create_image_cmd,
+            retry_returncode=[255],
+        )
+        image_id = image_id.strip()
+        subprocess_utils.handle_returncode(
+            returncode,
+            create_image_cmd,
+            error_msg=
+            f'Failed to create image from the source instance {instance_id}.',
+            stderr=stderr,
+            stream_logs=True)
+
+        log_utils.force_update_rich_status(
+            f'Waiting for the source image {cluster_name!r} from {region} to be available on AWS.'
+        )
+        # Wait for the image to be available
+        wait_image_cmd = (
+            f'aws ec2 wait image-available --region {region} --image-ids {image_id}'
+        )
+        returncode, stdout, stderr = subprocess_utils.run_with_retries(
+            wait_image_cmd,
+            retry_returncode=[255],
+        )
+        subprocess_utils.handle_returncode(
+            returncode,
+            wait_image_cmd,
+            error_msg=
+            f'The source image {image_id!r} creation fails to complete.',
+            stderr=stderr,
+            stream_logs=True)
+        sky_logging.print(
+            f'The source image {image_id!r} is created successfully.')
+        return image_id
+
+    @classmethod
+    def maybe_move_image(cls, image_id: str, source_region: str,
+                         target_region: str, source_zone: Optional[str],
+                         target_zone: Optional[str]) -> str:
+        del source_zone, target_zone  # unused
+        if source_region == target_region:
+            return image_id
+        image_name = f'skypilot-cloned-from-{source_region}-{image_id}'
+        copy_image_cmd = (f'aws ec2 copy-image --name {image_name} '
+                          f'--source-image-id {image_id} '
+                          f'--source-region {source_region} '
+                          f'--region {target_region} --output text')
+        returncode, target_image_id, stderr = subprocess_utils.run_with_retries(
+            copy_image_cmd,
+            retry_returncode=[255],
+        )
+        target_image_id = target_image_id.strip()
+        subprocess_utils.handle_returncode(
+            returncode,
+            copy_image_cmd,
+            error_msg=
+            f'Failed to copy image {image_id!r} from {source_region} to {target_region}.',
+            stderr=stderr,
+            stream_logs=True)
+
+        log_utils.force_update_rich_status(
+            f'Waiting for the target image {target_image_id!r} on {target_region} to be '
+            'available on AWS.')
+        wait_image_cmd = (
+            f'aws ec2 wait image-available --region {target_region} '
+            f'--image-ids {target_image_id}')
+        subprocess_utils.run_with_retries(
+            wait_image_cmd,
+            max_retry=5,
+            retry_returncode=[255],
+        )
+        subprocess_utils.handle_returncode(
+            returncode,
+            wait_image_cmd,
+            error_msg=
+            f'The target image {target_image_id!r} creation fails to complete.',
+            stderr=stderr,
+            stream_logs=True)
+
+        sky_logging.print(
+            f'The target image {target_image_id!r} is created successfully.')
+
+        log_utils.force_update_rich_status('Deleting the source image.')
+        cls.delete_image(image_id, source_region)
+        return target_image_id
+
+    @classmethod
+    def delete_image(cls, image_id: str, region: Optional[str]) -> None:
+        assert region is not None, (image_id, region)
+        delete_image_cmd = (f'aws ec2 deregister-image --region {region} '
+                            f'--image-id {image_id}')
+        returncode, _, stderr = subprocess_utils.run_with_retries(
+            delete_image_cmd,
+            retry_returncode=[255],
+        )
+        subprocess_utils.handle_returncode(
+            returncode,
+            delete_image_cmd,
+            error_msg=f'Failed to delete image {image_id!r} on {region}.',
+            stderr=stderr,
+            stream_logs=True)
```

### Comparing `skypilot-0.3.1/sky/clouds/azure.py` & `skypilot-0.3.2/sky/clouds/ibm.py`

 * *Files 11% similar despite different names*

```diff
@@ -1,304 +1,290 @@
-"""Azure."""
-import functools
-import json
+"""IBM Web Services."""
 import os
-import re
-import subprocess
+import yaml
+import json
 import typing
-from typing import Dict, Iterator, List, Optional, Tuple
-
-import colorama
+from typing import Any, Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
-from sky import exceptions
 from sky import sky_logging
-from sky.adaptors import azure
+from sky import status_lib
+from sky.adaptors import ibm
+from sky.adaptors.ibm import CREDENTIAL_FILE
 from sky.clouds import service_catalog
-from sky.utils import common_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
-    from sky import resources
+    # renaming to avoid shadowing variables
+    from sky import resources as resources_lib
 
 logger = sky_logging.init_logger(__name__)
 
-# Minimum set of files under ~/.azure that grant Azure access.
-_CREDENTIAL_FILES = [
-    'azureProfile.json',
-    'clouds.config',
-    'config',
-    'msal_token_cache.json',
-]
-
-_MAX_IDENTITY_FETCH_RETRY = 10
-
-
-def _run_output(cmd):
-    proc = subprocess.run(cmd,
-                          shell=True,
-                          check=True,
-                          stderr=subprocess.PIPE,
-                          stdout=subprocess.PIPE)
-    return proc.stdout.decode('ascii')
-
 
 @clouds.CLOUD_REGISTRY.register
-class Azure(clouds.Cloud):
-    """Azure."""
+class IBM(clouds.Cloud):
+    """IBM Web Services."""
 
-    _REPR = 'Azure'
-    # Azure has a 90 char limit for resource group; however, SkyPilot adds the
-    # suffix `-<region name>`. Azure also has a 64 char limit for VM names, and
-    # ray adds addtional `ray-`, `-worker`, and `-<9 chars hash>` for the VM
-    # names, so the limit is 64 - 4 - 7 - 10 = 43.
-    # Reference: https://azure.github.io/PSRule.Rules.Azure/en/rules/Azure.ResourceGroup.Name/ # pylint: disable=line-too-long
-    _MAX_CLUSTER_NAME_LEN_LIMIT = 42
+    _REPR = 'IBM'
+    # IBM's VPC instance name length is limited to 63 chars.
+    # since Ray names the instances using the following
+    # format: ray-{cluster_name}-{node_type}-{8-char-uuid}
+    # it leaves 63-3-5-8=47 characters for the cluster name.
+    _MAX_CLUSTER_NAME_LEN_LIMIT = 47
+    _regions: List[clouds.Region] = []
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
-        return dict()
+        return {
+            clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
+                (f'Migrating disk is not supported in {cls._REPR}.'),
+        }
 
     @classmethod
-    def _max_cluster_name_length(cls) -> int:
+    def _max_cluster_name_length(cls) -> Optional[int]:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
-    def instance_type_to_hourly_cost(self,
-                                     instance_type: str,
-                                     use_spot: bool,
-                                     region: Optional[str] = None,
-                                     zone: Optional[str] = None) -> float:
-        return service_catalog.get_hourly_cost(instance_type,
-                                               use_spot=use_spot,
-                                               region=region,
-                                               zone=zone,
-                                               clouds='azure')
-
-    def accelerators_to_hourly_cost(self,
-                                    accelerators: Dict[str, int],
-                                    use_spot: bool,
-                                    region: Optional[str] = None,
-                                    zone: Optional[str] = None) -> float:
-        del accelerators, use_spot, region, zone  # unused
-        # Azure includes accelerators as part of the instance type.
-        # Implementing this is also necessary for e.g., the instance may have 4
-        # GPUs, while the task specifies to use 1 GPU.
-        return 0
-
-    def get_egress_cost(self, num_gigabytes):
-        # In general, query this from the cloud:
-        #   https://azure.microsoft.com/en-us/pricing/details/bandwidth/
-        # NOTE: egress from US East.
-        # NOTE: Not accurate as the pricing tier is based on cumulative monthly
-        # usage.
-        if num_gigabytes > 150 * 1024:
-            return 0.05 * num_gigabytes
-        cost = 0.0
-        if num_gigabytes >= 50 * 1024:
-            cost += (num_gigabytes - 50 * 1024) * 0.07
-            num_gigabytes -= 50 * 1024
-
-        if num_gigabytes >= 10 * 1024:
-            cost += (num_gigabytes - 10 * 1024) * 0.083
-            num_gigabytes -= 10 * 1024
-
-        if num_gigabytes > 1:
-            cost += (num_gigabytes - 1) * 0.0875
-
-        cost += 0.0
-        return cost
-
-    def is_same_cloud(self, other):
-        return isinstance(other, Azure)
-
-    @classmethod
-    def get_default_instance_type(
-            cls,
-            cpus: Optional[str] = None,
-            memory: Optional[str] = None,
-            disk_tier: Optional[str] = None) -> Optional[str]:
-        return service_catalog.get_default_instance_type(cpus=cpus,
-                                                         memory=memory,
-                                                         disk_tier=disk_tier,
-                                                         clouds='azure')
-
-    def _get_image_config(self, gen_version, instance_type):
-        # az vm image list \
-        #  --publisher microsoft-dsvm --all --output table
-        # nvidia-driver: 495.29.05, cuda: 11.5
-
-        # The latest image 2022.09.14/2022.08.11/22.06.10/22.05.11/
-        # 22.04.27/22.04.05 has even older nvidia driver 470.57.02,
-        # cuda: 11.4
-        image_config = {
-            'image_publisher': 'microsoft-dsvm',
-            'image_offer': 'ubuntu-2004',
-            'image_sku': '2004-gen2',
-            'image_version': '21.11.04'
-        }
-
-        # ubuntu-2004 v21.10.21 and v21.11.04 do not work on K80
-        # due to an NVIDIA driver issue.
-        acc = self.get_accelerators_from_instance_type(instance_type)
-        if acc is not None:
-            acc_name = list(acc.keys())[0]
-            if acc_name == 'K80':
-                image_config['image_version'] = '21.08.30'
-
-        # ubuntu-2004 does not work on A100
-        if instance_type in [
-                'Standard_ND96asr_v4', 'Standard_ND96amsr_A100_v4'
-        ]:
-            image_config['image_offer'] = 'ubuntu-hpc'
-            image_config['image_sku'] = '2004'
-            image_config['image_version'] = '20.04.2021120101'
-        if gen_version == 'V1':
-            image_config['image_sku'] = '2004'
-        return image_config
-
     @classmethod
     def regions_with_offering(cls, instance_type: str,
                               accelerators: Optional[Dict[str, int]],
                               use_spot: bool, region: Optional[str],
                               zone: Optional[str]) -> List[clouds.Region]:
         del accelerators  # unused
-        assert zone is None, 'Azure does not support zones'
+        if use_spot:
+            return []
         regions = service_catalog.get_region_zones_for_instance_type(
-            instance_type, use_spot, 'azure')
+            instance_type, use_spot, 'ibm')
 
         if region is not None:
             regions = [r for r in regions if r.name == region]
+        if zone is not None:
+            for r in regions:
+                assert r.zones is not None, r
+                r.set_zones([z for z in r.zones if z.name == zone])
+            regions = [r for r in regions if r.zones]
         return regions
 
     @classmethod
     def zones_provision_loop(
         cls,
         *,
         region: str,
         num_nodes: int,
         instance_type: str,
         accelerators: Optional[Dict[str, int]] = None,
         use_spot: bool = False,
-    ) -> Iterator[None]:
+    ) -> Iterator[Optional[List[clouds.Zone]]]:
+        """Loops over (region, zones) to retry for provisioning.
+
+        returning a single zone list with its region,
+        since ibm cloud currently doesn't
+        support retries for list of zones.
+
+        Args:
+            instance_type: The instance type to provision.
+            accelerators: The accelerators to provision.
+            use_spot: Whether to use spot instances.
+        """
+        # del accelerators  # unused
         del num_nodes  # unused
+        assert use_spot is False, (
+            'current IBM implementation doesn\'t support spot instances')
+
         regions = cls.regions_with_offering(instance_type,
                                             accelerators,
                                             use_spot,
                                             region=region,
                                             zone=None)
+        # IBM provisioner currently takes 1 zone per request.
         for r in regions:
-            assert r.zones is None, r
-            yield r.zones
-
-    # TODO: factor the following three methods, as they are the same logic
-    # between Azure and AWS.
-
-    @classmethod
-    def get_accelerators_from_instance_type(
-        cls,
-        instance_type: str,
-    ) -> Optional[Dict[str, int]]:
-        return service_catalog.get_accelerators_from_instance_type(
-            instance_type, clouds='azure')
-
-    @classmethod
-    def get_vcpus_mem_from_instance_type(
-        cls,
-        instance_type: str,
-    ) -> Tuple[Optional[float], Optional[float]]:
-        return service_catalog.get_vcpus_mem_from_instance_type(instance_type,
-                                                                clouds='azure')
+            assert r.zones is not None, r
+            for zone in r.zones:
+                yield [zone]
 
     @classmethod
     def get_zone_shell_cmd(cls) -> Optional[str]:
         return None
 
+    def instance_type_to_hourly_cost(self,
+                                     instance_type: str,
+                                     use_spot: bool,
+                                     region: Optional[str] = None,
+                                     zone: Optional[str] = None) -> float:
+        # Currently doesn't support spot instances, hence use_spot set to False.
+        del use_spot
+        return service_catalog.get_hourly_cost(instance_type,
+                                               use_spot=False,
+                                               region=region,
+                                               zone=zone,
+                                               clouds='ibm')
+
+    def accelerators_to_hourly_cost(self,
+                                    accelerators: Dict[str, int],
+                                    use_spot: bool,
+                                    region: Optional[str] = None,
+                                    zone: Optional[str] = None) -> float:
+        del accelerators, use_spot, region, zone  # unused
+        # Currently Isn't implemented in the same manner by aws and azure.
+        return 0
+
+    def get_egress_cost(self, num_gigabytes):
+        """Returns the egress cost. Currently true for us-south, i.e. Dallas.
+        based on https://cloud.ibm.com/objectstorage/create#pricing. """
+        cost = 0
+        price_thresholds = [{
+            'threshold': 150,
+            'price_per_gb': 0.05
+        }, {
+            'threshold': 50,
+            'price_per_gb': 0.07
+        }, {
+            'threshold': 0,
+            'price_per_gb': 0.09
+        }]
+        for price_threshold in price_thresholds:
+            # pylint: disable=line-too-long
+            cost += (num_gigabytes - price_threshold['threshold']
+                    ) * price_threshold['price_per_gb']
+            num_gigabytes -= (num_gigabytes - price_threshold['threshold'])
+        return cost
+
+    def is_same_cloud(self, other):
+        return isinstance(other, IBM)
+
     def make_deploy_resources_variables(
-            self, resources: 'resources.Resources', region: 'clouds.Region',
-            zones: Optional[List['clouds.Zone']]) -> Dict[str, Optional[str]]:
-        assert zones is None, ('Azure does not support zones', zones)
+        self,
+        resources: 'resources_lib.Resources',
+        region: 'clouds.Region',
+        zones: Optional[List['clouds.Zone']],
+    ) -> Dict[str, Optional[str]]:
+        """Converts planned sky.Resources to cloud-specific resource variables.
+
+        These variables are used to fill the node type section (instance type,
+        any accelerators, etc.) in the cloud's deployment YAML template.
+
+        Cloud-agnostic sections (e.g., commands to run) need not be returned by
+        this function.
+
+        Returns:
+          A dictionary of cloud-specific node type variables.
+        """
+
+        def _get_profile_resources(instance_profile):
+            """returns a dict representing the
+             cpu, memory and gpu of specified instance profile"""
+
+            cpu_num, memory_num = self.get_vcpus_mem_from_instance_type(
+                instance_profile)
+            gpu_num = self.get_accelerators_from_instance_type(instance_profile)
+            gpu_num = list(gpu_num.values())[0] if gpu_num else 0
+            return {'CPU': cpu_num, 'memory': memory_num, 'GPU': gpu_num}
 
         region_name = region.name
+        # zones is guaranteed to be initialized for
+        # clouds implementing 'zones_provision_loop()'
+        zone_names = [zone.name for zone in zones]  # type: ignore[union-attr]
 
         r = resources
         assert not r.use_spot, \
-            'Our subscription offer ID does not support spot instances.'
-        # r.accelerators is cleared but .instance_type encodes the info.
+            'IBM does not currently support spot instances in this framework'
+
         acc_dict = self.get_accelerators_from_instance_type(r.instance_type)
         if acc_dict is not None:
             custom_resources = json.dumps(acc_dict, separators=(',', ':'))
         else:
             custom_resources = None
-        from sky.clouds.service_catalog import azure_catalog  # pylint: disable=import-outside-toplevel
-        gen_version = azure_catalog.get_gen_version_from_instance_type(
-            r.instance_type)
-        image_config = self._get_image_config(gen_version, r.instance_type)
+
+        instance_resources = _get_profile_resources(r.instance_type)
+
+        worker_instance_type = get_cred_file_field('worker_instance_type',
+                                                   r.instance_type)
+        worker_instance_resources = _get_profile_resources(worker_instance_type)
+        # r.image_id: {clouds.Region:image_id} - property of Resources class
+        image_id = r.image_id[
+            region.name] if r.image_id else self.get_default_image(region_name)
+
         return {
             'instance_type': r.instance_type,
+            'instance_resources': instance_resources,
+            'worker_instance_type': worker_instance_type,
+            'worker_instance_resources': worker_instance_resources,
             'custom_resources': custom_resources,
             'use_spot': r.use_spot,
             'region': region_name,
-            # Azure does not support specific zones.
-            'zones': None,
-            **image_config,
-            'disk_tier': Azure._get_disk_type(r.disk_tier)
+            'zones': ','.join(zone_names),
+            'image_id': image_id,
+            'iam_api_key': get_cred_file_field('iam_api_key'),
+            'resource_group_id': get_cred_file_field('resource_group_id'),
+            'disk_capacity': get_cred_file_field('disk_capacity', 100)
         }
 
-    def get_feasible_launchable_resources(self, resources):
+    @classmethod
+    def get_vcpus_mem_from_instance_type(
+        cls,
+        instance_type: str,
+    ) -> Tuple[Optional[float], Optional[float]]:
+        return service_catalog.get_vcpus_mem_from_instance_type(instance_type,
+                                                                clouds='ibm')
 
-        def failover_disk_tier(instance_type: str,
-                               disk_tier: Optional[str]) -> Optional[str]:
-            if disk_tier is None:
-                ok, _ = Azure.check_disk_tier(instance_type,
-                                              clouds.Cloud._DEFAULT_DISK_TIER)
-                if not ok:
-                    # Auto failover to low disk tier when disk tier
-                    # are not specified
-                    return 'low'
-            # The disk_tier specified by the user will be checked in the
-            # initialization of the Resources.
-            return disk_tier
-
-        if resources.use_spot:
-            # TODO(zhwu): our azure subscription offer ID does not support spot.
-            # Need to support it.
-            return ([], [])
+    @classmethod
+    def get_accelerators_from_instance_type(
+        cls,
+        instance_type: str,
+    ) -> Optional[Dict[str, int]]:
+        """Returns {acc: acc_count} held by 'instance_type', if any."""
+        return service_catalog.get_accelerators_from_instance_type(
+            instance_type, clouds='ibm')
+
+    @classmethod
+    def get_default_instance_type(
+            cls,
+            cpus: Optional[str] = None,
+            memory: Optional[str] = None,
+            disk_tier: Optional[str] = None) -> Optional[str]:
+        return service_catalog.get_default_instance_type(cpus=cpus,
+                                                         memory=memory,
+                                                         disk_tier=disk_tier,
+                                                         clouds='ibm')
+
+    def get_feasible_launchable_resources(self,
+                                          resources: 'resources_lib.Resources'):
+        """Returns a list of feasible and launchable resources.
+
+        Feasible resources refer to an offering respecting the resource
+        requirements.  Currently, this function implements "filtering" the
+        cloud's offerings only w.r.t. accelerators constraints.
+
+        Launchable resources require a cloud and an instance type be assigned.
+        """
+        fuzzy_candidate_list: Optional[List[str]] = []
         if resources.instance_type is not None:
             assert resources.is_launchable(), resources
-            # Treat Resources(AWS, p3.2x, V100) as Resources(AWS, p3.2x).
-            resources = resources.copy(
-                accelerators=None,
-                disk_tier=failover_disk_tier(resources.instance_type,
-                                             resources.disk_tier),
-            )
-            return ([resources], [])
+            resources = resources.copy(accelerators=None)
+            return ([resources], fuzzy_candidate_list)
 
         def _make(instance_list):
             resource_list = []
             for instance_type in instance_list:
                 r = resources.copy(
-                    cloud=Azure(),
+                    cloud=IBM(),
                     instance_type=instance_type,
-                    disk_tier=failover_disk_tier(instance_type,
-                                                 resources.disk_tier),
-                    # Setting this to None as Azure doesn't separately bill /
+                    # Setting this to None as IBM doesn't separately bill /
                     # attach the accelerators.  Billed as part of the VM type.
                     accelerators=None,
                     cpus=None,
-                    memory=None,
-                )
+                    memory=None)
                 resource_list.append(r)
             return resource_list
 
         # Currently, handle a filter on accelerators only.
         accelerators = resources.accelerators
         if accelerators is None:
             # Return a default instance type with the given number of vCPUs.
-            default_instance_type = Azure.get_default_instance_type(
+            default_instance_type = IBM.get_default_instance_type(
                 cpus=resources.cpus,
                 memory=resources.memory,
                 disk_tier=resources.disk_tier)
             if default_instance_type is None:
                 return ([], [])
             else:
                 return (_make([default_instance_type]), [])
@@ -307,186 +293,193 @@
         acc, acc_count = list(accelerators.items())[0]
         (instance_list, fuzzy_candidate_list
         ) = service_catalog.get_instance_type_for_accelerator(
             acc,
             acc_count,
             cpus=resources.cpus,
             memory=resources.memory,
-            use_spot=resources.use_spot,
             region=resources.region,
             zone=resources.zone,
-            clouds='azure')
+            clouds='ibm')
         if instance_list is None:
             return ([], fuzzy_candidate_list)
         return (_make(instance_list), fuzzy_candidate_list)
 
     @classmethod
+    def get_default_image(cls, region) -> str:
+        """
+        Returns default image id, currently stock ubuntu 22-04.
+        if user specified 'image_id' in ~/.ibm/credentials.yaml
+            matching this 'region', returns it instead.
+        """
+
+        def _get_image_objects():
+            # pylint: disable=E1136
+            images = []
+            res = client.list_images().get_result()
+            images.extend(res['images'])
+
+            while res.get('next'):
+                link_to_next = res['next']['href'].split('start=')[1].split(
+                    '&limit')[0]
+                res = client.list_images(start=link_to_next).get_result()
+                images.extend(res['images'])
+            return images
+
+        # if user specified an image id for the region, return it.
+        # IBM-TODO take into account user input when --image-id
+        # is implemented
+        user_image = get_cred_file_field('image_id')
+        if user_image and region in user_image:
+            logger.debug(f'using user image: {user_image[region]} '
+                         f'in region: {region}.')
+            return user_image[region]
+
+        client = ibm.client(region=region)
+        # returns default image: "ibm-ubuntu-22-04" with amd architecture
+        return next((img for img in _get_image_objects() if
+         img['name'].startswith('ibm-ubuntu-22-04') \
+            and img['operating_system']['architecture'].startswith(
+                'amd')))['id']
+
+    def get_image_size(self, image_id: str, region: Optional[str]) -> float:
+        assert region is not None, (image_id, region)
+        client = ibm.client(region=region)
+        try:
+            image_data = client.get_image(image_id).get_result()
+        # pylint: disable=line-too-long
+        except ibm.ibm_cloud_sdk_core.ApiException as e:  # type: ignore[union-attr]
+            logger.error(e.message)
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(f'Image {image_id!r} not found in '
+                                 f'IBM region "{region}"') from None
+        try:
+            # image_size['file']['size'] is not relevant, since
+            # the minimum size of a volume onto which this image
+            # may be provisioned is stored in minimum_provisioned_size
+            # pylint: disable=unsubscriptable-object
+            image_size = image_data['minimum_provisioned_size']
+        except KeyError:
+            logger.error('Image missing metadata:"minimum_provisioned_size". '
+                         'Image may be in status: Failed/Pending.')
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    f'IBM image {image_id!r} in '
+                    f'region "{region}", is missing'
+                    'metadata:"minimum_provisioned_size". '
+                    'Image may be in status: Failed/Pending') from None
+        return image_size
+
+    @classmethod
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
         """Checks if the user has access credentials to this cloud."""
-        help_str = (
-            ' Run the following commands:'
-            '\n      $ az login'
-            '\n      $ az account set -s <subscription_id>'
-            '\n    For more info: '
-            'https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli'  # pylint: disable=line-too-long
-        )
-        # This file is required because it will be synced to remote VMs for
-        # `az` to access private storage buckets.
-        # `az account show` does not guarantee this file exists.
-        azure_token_cache_file = '~/.azure/msal_token_cache.json'
-        if not os.path.isfile(os.path.expanduser(azure_token_cache_file)):
-            return (False,
-                    f'{azure_token_cache_file} does not exist.' + help_str)
+        # IBM-TODO - create a configuration script.
+        required_fields = ['iam_api_key', 'resource_group_id']
+        help_str = ('    Store your API key and Resource Group id '
+                    f'in {CREDENTIAL_FILE} in the following format:\n'
+                    '      iam_api_key: <IAM_API_KEY>\n'
+                    '      resource_group_id: <RESOURCE_GROUP_ID>')
+
+        base_config = _read_credential_file()
+        if not base_config:
+            return (False, 'Missing credential file at '
+                    f'{os.path.expanduser(CREDENTIAL_FILE)}.\n' + help_str)
+
+        for field in required_fields:
+            if field not in base_config:
+                return (False, f'Missing field "{field}" in '
+                        f'{os.path.expanduser(CREDENTIAL_FILE)}.\n' + help_str)
 
+        # verifies ability of user to create a client,
+        # e.g. bad API KEY.
         try:
-            _run_output('az --version')
-        except subprocess.CalledProcessError:
-            return False, (
-                # TODO(zhwu): Change the installation hint to from PyPI.
-                'Azure CLI returned error. Run the following commands:'
-                '\n      $ pip install skypilot[azure]'
-                '\n    Credentials may also need to be set.' + help_str)
-        # If Azure is properly logged in, this will return the account email
-        # address + subscription ID.
-        try:
-            cls.get_current_user_identity()
-        except exceptions.CloudUserIdentityError:
-            return False, 'Azure credential is not set.' + help_str
-        return True, None
+            ibm.client()
+            return True, None
+        # pylint: disable=W0703
+        except Exception as e:
+            return (False, f'{str(e)}' + help_str)
+
+    @classmethod
+    def check_disk_tier_enabled(cls, instance_type: str,
+                                disk_tier: str) -> None:
+        del instance_type, disk_tier  # unused
 
     def get_credential_file_mounts(self) -> Dict[str, str]:
-        """Returns a dict of credential file paths to mount paths."""
-        return {
-            f'~/.azure/{filename}': f'~/.azure/{filename}'
-            for filename in _CREDENTIAL_FILES
-        }
+        """Returns a {remote:local} credential path mapping
+         written to the cluster's file_mounts segment
+         of its yaml file (e.g., ibm-ray.yml.j2)
+        """
+        return {CREDENTIAL_FILE: CREDENTIAL_FILE}
 
     def instance_type_exists(self, instance_type):
-        return service_catalog.instance_type_exists(instance_type,
-                                                    clouds='azure')
+        """Returns whether the instance type exists for this cloud."""
+        return service_catalog.instance_type_exists(instance_type, clouds='ibm')
+
+    def validate_region_zone(self, region: Optional[str], zone: Optional[str]):
+        """Validates the region and zone."""
+        return service_catalog.validate_region_zone(region, zone, clouds='ibm')
 
     def accelerator_in_region_or_zone(self,
                                       accelerator: str,
                                       acc_count: int,
                                       region: Optional[str] = None,
                                       zone: Optional[str] = None) -> bool:
+        """Returns whether the accelerator is valid in the region or zone."""
         return service_catalog.accelerator_in_region_or_zone(
-            accelerator, acc_count, region, zone, 'azure')
+            accelerator, acc_count, region, zone, 'ibm')
 
     @classmethod
-    @functools.lru_cache(maxsize=1)  # Cache since getting identity is slow.
-    def get_current_user_identity(cls) -> Optional[List[str]]:
-        """Returns the cloud user identity."""
-        # This returns the user's email address + [subscription_id].
-        retry_cnt = 0
-        while True:
-            retry_cnt += 1
-            try:
-                import knack  # pylint: disable=import-outside-toplevel
-            except ModuleNotFoundError as e:
-                with ux_utils.print_exception_no_traceback():
-                    raise exceptions.CloudUserIdentityError(
-                        'Failed to import \'knack\'. To install the dependencies for Azure, '
-                        'Please install SkyPilot with: '
-                        f'{colorama.Style.BRIGHT}pip install skypilot[azure]'
-                        f'{colorama.Style.RESET_ALL}') from e
-            try:
-                account_email = azure.get_current_account_user()
-                break
-            except (FileNotFoundError, knack.util.CLIError) as e:
-                error = exceptions.CloudUserIdentityError(
-                    'Failed to get activated Azure account.\n'
-                    '  Reason: '
-                    f'{common_utils.format_exception(e, use_bracket=True)}')
-                if retry_cnt <= _MAX_IDENTITY_FETCH_RETRY:
-                    logger.debug(f'{error}.\nRetrying...')
-                    continue
-                with ux_utils.print_exception_no_traceback():
-                    raise error from None
-            except Exception as e:  # pylint: disable=broad-except
-                with ux_utils.print_exception_no_traceback():
-                    raise exceptions.CloudUserIdentityError(
-                        'Failed to get Azure user identity with unknown '
-                        f'exception.\n'
-                        '  Reason: '
-                        f'{common_utils.format_exception(e, use_bracket=True)}'
-                    ) from e
-        try:
-            project_id = cls.get_project_id()
-        except (ModuleNotFoundError, RuntimeError) as e:
-            with ux_utils.print_exception_no_traceback():
-                raise exceptions.CloudUserIdentityError(
-                    'Failed to get Azure project ID.') from e
-        return [f'{account_email} [subscription_id={project_id}]']
-
-    @classmethod
-    def get_project_id(cls, dryrun: bool = False) -> str:
-        if dryrun:
-            return 'dryrun-project-id'
-        try:
-            azure_subscription_id = azure.get_subscription_id()
-            if not azure_subscription_id:
-                raise ValueError  # The error message will be replaced.
-        except ModuleNotFoundError as e:
-            with ux_utils.print_exception_no_traceback():
-                raise ModuleNotFoundError('Unable to import azure python '
-                                          'module. Is azure-cli python package '
-                                          'installed? Try pip install '
-                                          '.[azure] in the sky repo.') from e
-        except Exception as e:  # pylint: disable=broad-except
-            with ux_utils.print_exception_no_traceback():
-                raise RuntimeError(
-                    'Failed to get subscription id from azure cli. '
-                    'Make sure you have logged in and run this Azure '
-                    'cli command: "az account set -s <subscription_id>".'
-                ) from e
-        return azure_subscription_id
-
-    @classmethod
-    def _is_s_series(cls, instance_type: Optional[str]) -> bool:
-        # For azure naming convention, see https://learn.microsoft.com/en-us/azure/virtual-machines/vm-naming-conventions  # pylint: disable=line-too-long
-        if instance_type is None:
-            return True
-        x = re.match(
-            r'(Standard|Basic)_([A-Z]+)([0-9]+)(-[0-9]+)?'
-            r'([a-z]*)(_[A-Z]+[0-9]+)?(_v[0-9])?(_Promo)?', instance_type)
-        assert x is not None, f'Unknown instance type: {instance_type}'
-        return 's' in x.group(5)
-
-    @classmethod
-    def check_disk_tier(cls, instance_type: Optional[str],
-                        disk_tier: Optional[str]) -> Tuple[bool, str]:
-        if disk_tier is None:
-            return True, ''
-        if disk_tier == 'high':
-            return False, ('Azure disk_tier=high is not supported now. '
-                           'Please use disk_tier={low, medium} instead.')
-        # Only S-series supported premium ssd
-        # see https://stackoverflow.com/questions/48590520/azure-requested-operation-cannot-be-performed-because-storage-account-type-pre  # pylint: disable=line-too-long
-        if cls._get_disk_type(
-                disk_tier
-        ) == 'Premium_LRS' and not Azure._is_s_series(instance_type):
-            return False, (
-                'Azure premium SSDs are only supported for S-series '
-                'instances. To use disk_tier=medium, please make sure '
-                'instance_type is specified to an S-series instance.')
-        return True, ''
-
-    @classmethod
-    def check_disk_tier_enabled(cls, instance_type: str,
-                                disk_tier: str) -> None:
-        ok, msg = cls.check_disk_tier(instance_type, disk_tier)
-        if not ok:
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(msg)
-
-    @classmethod
-    def _get_disk_type(cls, disk_tier: Optional[str]) -> str:
-        tier = disk_tier or cls._DEFAULT_DISK_TIER
-        # TODO(tian): Maybe use PremiumV2_LRS/UltraSSD_LRS? Notice these two
-        # cannot be used as OS disks so we might need data disk support
-        tier2name = {
-            'high': 'Disabled',
-            'medium': 'Premium_LRS',
-            'low': 'Standard_LRS',
+    def query_status(cls, name: str, tag_filters: Dict[str, str],
+                     region: Optional[str], zone: Optional[str],
+                     **kwargs) -> List['status_lib.ClusterStatus']:
+        del tag_filters, zone, kwargs  # unused
+
+        status_map: Dict[str, Any] = {
+            'pending': status_lib.ClusterStatus.INIT,
+            'starting': status_lib.ClusterStatus.INIT,
+            'restarting': status_lib.ClusterStatus.INIT,
+            'running': status_lib.ClusterStatus.UP,
+            'stopping': status_lib.ClusterStatus.STOPPED,
+            'stopped': status_lib.ClusterStatus.STOPPED,
+            'deleting': None,
+            'failed': status_lib.ClusterStatus.INIT,
+            'cluster_deleted': []
         }
-        return tier2name[tier]
+
+        client = ibm.client(region=region)
+        search_client = ibm.search_client()
+        # pylint: disable=E1136
+        vpcs_filtered_by_tags_and_region = search_client.search(
+            query=f'type:vpc AND tags:{name} AND region:{region}',
+            fields=['tags', 'region', 'type'],
+            limit=1000).get_result()['items']
+        if not vpcs_filtered_by_tags_and_region:
+            # a vpc could have been removed unkownlingly to skypilot, such as
+            # via `sky autostop --down`, or simply manually (e.g. via console).
+            logger.warning('No vpc exists in '
+                           f'{region} '
+                           f'with tag: {name}')
+            return status_map['cluster_deleted']
+        vpc_id = vpcs_filtered_by_tags_and_region[0]['crn'].rsplit(':', 1)[-1]
+        instances = client.list_instances(
+            vpc_id=vpc_id).get_result()['instances']
+
+        return [status_map[instance['status']] for instance in instances]
+
+
+def _read_credential_file():
+    try:
+        with open(os.path.expanduser(CREDENTIAL_FILE), 'r',
+                  encoding='utf-8') as f:
+            return yaml.safe_load(f)
+    except FileNotFoundError:
+        return False
+
+
+def get_cred_file_field(field, default_val=None) -> str:
+    """returns a the value of a field from the user's
+     credentials file if exists, else default_val"""
+    base_config = _read_credential_file()
+    if not base_config:
+        raise FileNotFoundError('Missing '
+                                f'credential file at {CREDENTIAL_FILE}')
+    return base_config.get(field, default_val)
```

### Comparing `skypilot-0.3.1/sky/clouds/cloud.py` & `skypilot-0.3.2/sky/clouds/cloud.py`

 * *Files 14% similar despite different names*

```diff
@@ -7,14 +7,15 @@
 
 from sky import exceptions
 from sky.clouds import service_catalog
 from sky.utils import log_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
+    from sky import status_lib
     from sky import resources
 
 
 class CloudImplementationFeatures(enum.Enum):
     """Features that might not be implemented for all clouds.
 
     Used by Cloud.check_features_are_supported().
@@ -22,14 +23,15 @@
     Note: If any new feature is added, please check and update
     _cloud_unsupported_features in all clouds to make sure the
     check_features_are_supported() works as expected.
     """
     STOP = 'stop'
     AUTOSTOP = 'autostop'
     MULTI_NODE = 'multi-node'
+    CLONE_DISK_FROM_CLUSTER = 'clone_disk_from_cluster'
 
 
 class Region(collections.namedtuple('Region', ['name'])):
     """A region."""
     name: str
     zones: Optional[List['Zone']] = None
 
@@ -463,9 +465,118 @@
         """Errors out if the disk tier is not supported by the cloud provider.
 
         Raises:
             exceptions.NotSupportedError: If the disk tier is not supported.
         """
         raise NotImplementedError
 
+    @classmethod
+    # pylint: disable=unused-argument
+    def check_quota_available(cls,
+                              region: str,
+                              instance_type: str,
+                              use_spot: bool = False) -> bool:
+        """Check if quota is available for `instance_type` in `region`.
+
+        (Currently, check_quota_available is only implemented for AWS.)
+
+        The _retry_zones function in cloud_vm_ray_backend goes through different
+        candidate regions and attempts to provision the requested instance_type
+        accelerators in the region, until a successful provisioning happens
+        or all regions with the requested accelerator have been looked at.
+        Previously, SkyPilot would attempt to provision resources in all of
+        these regions. However, many regions would have a zero quota or
+        inadequate quota, meaning these attempted provisions were destined
+        to fail from the get-go.
+
+        Checking the quota is substantially faster than attempting a failed
+        provision (~1 second vs 30+ seconds) so this function attempts to
+        check the resource quota and return False if it is found to be zero,
+        or True otherwise. If False is returned, _retry_zones will not attempt
+        a provision in the region, saving time.
+
+        We are only checking for a nonzero quota, instead of also factoring in
+        quota utilization because many cloud providers' APIs don't have a
+        built-in command for checking the real-time utilization. Checking
+        real-time utilization is a more difficult endeavor that involves
+        monitoring etc., so we are holding off on that for now.
+
+        If for at any point the function fails, whether it's because we can't
+        import the necessary dependencies or a query using a cloud provider's
+        API fails, we will return True, because we cannot conclusively say the
+        relevant quota is zero in these cases, and we don't want to
+        preemptively exclude regions from an attempted provision if they may
+        have an adequate quota.
+
+        Design choice: We chose a just-in-time approach where
+        check_quota_available is called immediately before a potential
+        attempted provision, rather than checking all region quotas
+        beforehand, storing them, and using those values on-demand. This is
+        because, for example, _retry_zones may only need to go through one or
+        a few regions before a successful region, and running a query to check
+        *every* region's quota beforehand would cause an unnecessary delay.
+
+        Returns:
+            False if the quota is found to be zero, and true otherwise.
+        """
+
+        return True
+
+    @classmethod
+    def query_status(cls, name: str, tag_filters: Dict[str, str],
+                     region: Optional[str], zone: Optional[str],
+                     **kwargs) -> List['status_lib.ClusterStatus']:
+        """Queries the latest status of the cluster from the cloud.
+
+        The global_user_state caches the status of the clusters, but the
+        actual status of the clusters may change on the cloud, e.g., the
+        autostop happens, or the user manually stops the cluster. This
+        method queries the cloud to get the latest cluster status.
+
+        Returns:
+            A list of ClusterStatus representing the status of all the
+            alive nodes in the cluster.
+        """
+        raise NotImplementedError
+
+    # === Image related methods ===
+    # These three methods are used to create, move and delete images. They
+    # are currently only used in `sky launch --clone-disk-from` to clone a
+    # cluster's disk to launch a new cluster.
+    # It is not required to implement these methods for clouds that do not
+    # support `--clone-disk-from`. If not implemented,
+    # CloudImplementationFeatures.CLONE_DISK_FROM should be added to the
+    # cloud._cloud_unsupported_features().
+
+    @classmethod
+    def create_image_from_cluster(cls, cluster_name: str,
+                                  tag_filters: Dict[str,
+                                                    str], region: Optional[str],
+                                  zone: Optional[str]) -> str:
+        """Creates an image from the cluster.
+
+        Returns: the image ID.
+        """
+        raise NotImplementedError
+
+    @classmethod
+    def maybe_move_image(cls, image_name: str, source_region: str,
+                         target_region: str, source_zone: Optional[str],
+                         target_zone: Optional[str]) -> str:
+        """Move an image if required.
+
+        If the image cannot be accessed in the target region, move the image
+        from the source region to the target region.
+
+        Returns: the image ID in the target region.
+        """
+        raise NotImplementedError
+
+    @classmethod
+    def delete_image(cls, image_id: str, region: Optional[str]) -> None:
+        """Deletes the image with image_id in the region."""
+        raise NotImplementedError
+
+    # === End of image related methods ===
+
     def __repr__(self):
         return self._REPR
```

### Comparing `skypilot-0.3.1/sky/clouds/gcp.py` & `skypilot-0.3.2/sky/clouds/gcp.py`

 * *Files 16% similar despite different names*

```diff
@@ -6,59 +6,67 @@
 import time
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
 from sky import exceptions
 from sky import sky_logging
+from sky import status_lib
 from sky.adaptors import gcp
 from sky.clouds import service_catalog
+from sky.skylet import log_lib
 from sky.utils import common_utils
+from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky import resources
 
 logger = sky_logging.init_logger(__name__)
 
-DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH = os.path.expanduser(
+# Env var pointing to any service account key. If it exists, this path takes
+# priority over the DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH below, and will be
+# used instead for SkyPilot-launched instances. This is the same behavior as
+# gcloud:
+# https://cloud.google.com/docs/authentication/provide-credentials-adc#local-key
+_GCP_APPLICATION_CREDENTIAL_ENV = 'GOOGLE_APPLICATION_CREDENTIALS'
+# NOTE: do not expanduser() on this path. It's used as a destination path on the
+# remote cluster.
+DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH: str = (
     '~/.config/gcloud/'
     'application_default_credentials.json')
 
 # TODO(wei-lin): config_default may not be the config in use.
 # See: https://github.com/skypilot-org/skypilot/pull/1539
+# NOTE: do not expanduser() on this path. It's used as a destination path on the
+# remote cluster.
 GCP_CONFIG_PATH = '~/.config/gcloud/configurations/config_default'
 # Do not place the backup under the gcloud config directory, as ray
 # autoscaler can overwrite that directory on the remote nodes.
+# NOTE: do not expanduser() on this path. It's used as a destination path on the
+# remote cluster.
 GCP_CONFIG_SKY_BACKUP_PATH = '~/.sky/.sky_gcp_config_default'
 
-# A list of permissions required to run SkyPilot on GCP.
-# This is not a complete list but still useful to check first
-# and hint users if not sufficient during sky check.
-GCP_PREMISSION_CHECK_LIST = [
-    'compute.projects.get',
-    'iam.serviceAccounts.actAs',
-]
-
 # Minimum set of files under ~/.config/gcloud that grant GCP access.
 _CREDENTIAL_FILES = [
     'credentials.db',
-    'application_default_credentials.json',
     'access_tokens.db',
     'configurations',
     'legacy_credentials',
     'active_config',
 ]
 
+# NOTE: do not expanduser() on this path. It's used as a destination path on the
+# remote cluster.
 _GCLOUD_INSTALLATION_LOG = '~/.sky/logs/gcloud_installation.log'
 _GCLOUD_VERSION = '424.0.0'
 # Need to be run with /bin/bash
 # We factor out the installation logic to keep it align in both spot
 # controller and cloud stores.
-GOOGLE_SDK_INSTALLATION_COMMAND = f'pushd /tmp &>/dev/null && \
+GOOGLE_SDK_INSTALLATION_COMMAND: str = f'pushd /tmp &>/dev/null && \
     {{ gcloud --help > /dev/null 2>&1 || \
     {{ mkdir -p {os.path.dirname(_GCLOUD_INSTALLATION_LOG)} && \
     wget --quiet https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-{_GCLOUD_VERSION}-linux-x86_64.tar.gz > {_GCLOUD_INSTALLATION_LOG} && \
     tar xzf google-cloud-sdk-{_GCLOUD_VERSION}-linux-x86_64.tar.gz >> {_GCLOUD_INSTALLATION_LOG} && \
     rm -rf ~/google-cloud-sdk >> {_GCLOUD_INSTALLATION_LOG}  && \
     mv google-cloud-sdk ~/ && \
     ~/google-cloud-sdk/install.sh -q >> {_GCLOUD_INSTALLATION_LOG} 2>&1 && \
@@ -105,15 +113,15 @@
     # suffix '-worker'. Here we do not distinguish these cases and take the
     # lower limit.
     _MAX_CLUSTER_NAME_LEN_LIMIT = 35
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
-        return dict()
+        return {}
 
     @classmethod
     def _max_cluster_name_length(cls) -> Optional[int]:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
     #### Regions/Zones ####
     @classmethod
@@ -465,58 +473,79 @@
         cls,
         instance_type: str,
     ) -> Tuple[Optional[float], Optional[float]]:
         return service_catalog.get_vcpus_mem_from_instance_type(instance_type,
                                                                 clouds='gcp')
 
     @classmethod
+    def _find_application_key_path(cls) -> str:
+        # Check the application default credentials in the environment variable.
+        # If the file does not exist, fallback to the default path.
+        application_key_path = os.environ.get(_GCP_APPLICATION_CREDENTIAL_ENV,
+                                              None)
+        if application_key_path is not None:
+            if not os.path.isfile(os.path.expanduser(application_key_path)):
+                raise FileNotFoundError(
+                    f'{_GCP_APPLICATION_CREDENTIAL_ENV}={application_key_path},'
+                    ' but the file does not exist.')
+            return application_key_path
+        if (not os.path.isfile(
+                os.path.expanduser(DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH))):
+            # Fallback to the default application credential path.
+            raise FileNotFoundError(DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH)
+        return DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH
+
+    @classmethod
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
         """Checks if the user has access credentials to this cloud."""
         try:
             # pylint: disable=import-outside-toplevel,unused-import
             from google import auth  # type: ignore
             # Check google-api-python-client installation.
             import googleapiclient
 
             # These files are required because they will be synced to remote
             # VMs for `gsutil` to access private storage buckets.
             # `auth.default()` does not guarantee these files exist.
             for file in [
                     '~/.config/gcloud/access_tokens.db',
                     '~/.config/gcloud/credentials.db',
-                    '~/.config/gcloud/application_default_credentials.json'
             ]:
                 if not os.path.isfile(os.path.expanduser(file)):
                     raise FileNotFoundError(file)
+
+            cls._find_application_key_path()
+
             # Check the installation of google-cloud-sdk.
             _run_output('gcloud --version')
 
             # Check if application default credentials are set.
             project_id = cls.get_project_id()
 
             # Check if the user is activated.
             identity = cls.get_current_user_identity()
         except (auth.exceptions.DefaultCredentialsError,
                 subprocess.CalledProcessError,
                 exceptions.CloudUserIdentityError, FileNotFoundError,
-                ImportError):
+                ImportError) as e:
             # See also: https://stackoverflow.com/a/53307505/1165051
             return False, (
                 'GCP tools are not installed or credentials are not set. '
                 'Run the following commands:\n    '
                 # Install the Google Cloud SDK:
                 '  $ pip install google-api-python-client\n    '
                 '  $ conda install -c conda-forge google-cloud-sdk -y\n    '
                 # This authenticates the CLI to make `gsutil` work:
                 '  $ gcloud init\n    '
                 # This will generate
                 # ~/.config/gcloud/application_default_credentials.json.
                 '  $ gcloud auth application-default login\n    '
                 'For more info: '
                 'https://skypilot.readthedocs.io/en/latest/getting-started/installation.html'  # pylint: disable=line-too-long
+                f'\nDetails: {common_utils.format_exception(e, use_bracket=True)}'
             )
 
         # Check APIs.
         apis = (
             ('compute', 'Compute Engine'),
             ('cloudresourcemanager', 'Cloud Resource Manager'),
             ('iam', 'Identity and Access Management (IAM)'),
@@ -561,41 +590,43 @@
             print('\nHint: Enabled GCP API(s) may take a few minutes to take '
                   'effect. If any SkyPilot commands/calls failed, retry after '
                   'some time.')
 
         # pylint: disable=import-outside-toplevel,unused-import
         import googleapiclient.discovery
         import google.auth
+        from sky.skylet.providers.gcp import constants
 
         # This takes user's credential info from "~/.config/gcloud/application_default_credentials.json".  # pylint: disable=line-too-long
         credentials, project = google.auth.default()
         service = googleapiclient.discovery.build('cloudresourcemanager',
                                                   'v1',
                                                   credentials=credentials)
-        permissions = {'permissions': GCP_PREMISSION_CHECK_LIST}
+        permissions = {'permissions': constants.VM_MINIMAL_PERMISSIONS}
         request = service.projects().testIamPermissions(resource=project,
                                                         body=permissions)
         ret_permissions = request.execute().get('permissions', [])
-        if len(ret_permissions) < len(GCP_PREMISSION_CHECK_LIST):
-            diffs = set(GCP_PREMISSION_CHECK_LIST).difference(
-                set(ret_permissions))
+
+        diffs = set(constants.VM_MINIMAL_PERMISSIONS).difference(
+            set(ret_permissions))
+        if len(diffs) > 0:
             identity_str = identity[0] if identity else None
             return False, (
                 'The following permissions are not enabled for the current '
                 f'GCP identity ({identity_str}):\n    '
                 f'{diffs}\n    '
-                'For more details, visit: https://skypilot.readthedocs.io/en/latest/reference/faq.html#what-are-the-required-iam-permissons-on-gcp-for-skypilot')  # pylint: disable=line-too-long
+                'For more details, visit: https://skypilot.readthedocs.io/en/latest/cloud-setup/cloud-permissions.html#gcp')  # pylint: disable=line-too-long
         return True, None
 
     def get_credential_file_mounts(self) -> Dict[str, str]:
         # Create a backup of the config_default file, as the original file can
         # be modified on the remote cluster by ray causing authentication
         # problems. The backup file will be updated to the remote cluster
         # whenever the original file is not empty and will be applied
-        # appropriately on the remote cluster when neccessary.
+        # appropriately on the remote cluster when necessary.
         if (os.path.exists(os.path.expanduser(GCP_CONFIG_PATH)) and
                 os.path.getsize(os.path.expanduser(GCP_CONFIG_PATH)) > 0):
             subprocess.run(f'cp {GCP_CONFIG_PATH} {GCP_CONFIG_SKY_BACKUP_PATH}',
                            shell=True,
                            check=True)
         elif not os.path.exists(os.path.expanduser(GCP_CONFIG_SKY_BACKUP_PATH)):
             raise RuntimeError(
@@ -605,14 +636,18 @@
         # Excluding the symlink to the python executable created by the gcp
         # credential, which causes problem for ray up multiple nodes, tracked
         # in #494, #496, #483.
         credentials = {
             f'~/.config/gcloud/{filename}': f'~/.config/gcloud/{filename}'
             for filename in _CREDENTIAL_FILES
         }
+        # Upload the application key path to the default path, so that
+        # autostop and GCS can be accessed on the remote cluster.
+        credentials[DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH] = (
+            self._find_application_key_path())
         credentials[GCP_CONFIG_SKY_BACKUP_PATH] = GCP_CONFIG_SKY_BACKUP_PATH
         return credentials
 
     @classmethod
     @functools.lru_cache(maxsize=1)  # Cache since getting identity is slow.
     def get_current_user_identity(cls) -> Optional[List[str]]:
         """Returns the email address + project id of the active user."""
@@ -675,15 +710,16 @@
             return 'dryrun-project-id'
         # pylint: disable=import-outside-toplevel
         from google import auth  # type: ignore
         _, project_id = auth.default()
         if project_id is None:
             raise exceptions.CloudUserIdentityError(
                 'Failed to get GCP project id. Please make sure you have '
-                'run: gcloud init')
+                'run the following: gcloud init; '
+                'gcloud auth application-default login')
         return project_id
 
     @staticmethod
     def check_host_accelerator_compatibility(
             instance_type: str, accelerators: Optional[Dict[str, int]]) -> None:
         service_catalog.check_host_accelerator_compatibility(
             instance_type, accelerators, 'gcp')
@@ -706,7 +742,175 @@
         tier = disk_tier or cls._DEFAULT_DISK_TIER
         tier2name = {
             'high': 'pd-ssd',
             'medium': 'pd-balanced',
             'low': 'pd-standard',
         }
         return tier2name[tier]
+
+    @classmethod
+    def _label_filter_str(cls, tag_filters: Dict[str, str]) -> str:
+        return ' '.join(f'labels.{k}={v}' for k, v in tag_filters.items())
+
+    @classmethod
+    def query_status(cls, name: str, tag_filters: Dict[str, str],
+                     region: Optional[str], zone: Optional[str],
+                     **kwargs) -> List['status_lib.ClusterStatus']:
+        """Query the status of a cluster."""
+        del region  # unused
+
+        from sky.utils import tpu_utils  # pylint: disable=import-outside-toplevel
+        use_tpu_vm = kwargs.pop('use_tpu_vm', False)
+
+        label_filter_str = cls._label_filter_str(tag_filters)
+        if use_tpu_vm:
+            # TPU VM's state definition is different from compute VM
+            # https://cloud.google.com/tpu/docs/reference/rest/v2alpha1/projects.locations.nodes#State # pylint: disable=line-too-long
+            status_map = {
+                'CREATING': status_lib.ClusterStatus.INIT,
+                'STARTING': status_lib.ClusterStatus.INIT,
+                'RESTARTING': status_lib.ClusterStatus.INIT,
+                'READY': status_lib.ClusterStatus.UP,
+                'REPAIRING': status_lib.ClusterStatus.INIT,
+                # 'STOPPED' in GCP TPU VM means stopped, with disk preserved.
+                'STOPPING': status_lib.ClusterStatus.STOPPED,
+                'STOPPED': status_lib.ClusterStatus.STOPPED,
+                'DELETING': None,
+                'PREEMPTED': None,
+            }
+            tpu_utils.check_gcp_cli_include_tpu_vm()
+            query_cmd = ('gcloud compute tpus tpu-vm list '
+                         f'--zone {zone} '
+                         f'--filter="({label_filter_str})" '
+                         '--format="value(state)"')
+        else:
+            # Ref: https://cloud.google.com/compute/docs/instances/instance-life-cycle
+            status_map = {
+                'PROVISIONING': status_lib.ClusterStatus.INIT,
+                'STAGING': status_lib.ClusterStatus.INIT,
+                'RUNNING': status_lib.ClusterStatus.UP,
+                'REPAIRING': status_lib.ClusterStatus.INIT,
+                # 'TERMINATED' in GCP means stopped, with disk preserved.
+                'STOPPING': status_lib.ClusterStatus.STOPPED,
+                'TERMINATED': status_lib.ClusterStatus.STOPPED,
+                # 'SUSPENDED' in GCP means stopped, with disk and OS memory
+                # preserved.
+                'SUSPENDING': status_lib.ClusterStatus.STOPPED,
+                'SUSPENDED': status_lib.ClusterStatus.STOPPED,
+            }
+            # TODO(zhwu): The status of the TPU attached to the cluster should
+            # also be checked, since TPUs are not part of the VMs.
+            query_cmd = ('gcloud compute instances list '
+                         f'--filter="({label_filter_str})" '
+                         '--format="value(status)"')
+        returncode, stdout, stderr = log_lib.run_with_log(query_cmd,
+                                                          '/dev/null',
+                                                          require_outputs=True,
+                                                          shell=True)
+        logger.debug(f'{query_cmd} returned {returncode}.\n'
+                     '**** STDOUT ****\n'
+                     f'{stdout}\n'
+                     '**** STDERR ****\n'
+                     f'{stderr}')
+
+        if returncode != 0:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.ClusterStatusFetchingError(
+                    f'Failed to query GCP cluster {name!r} status: '
+                    f'{stdout + stderr}')
+
+        status_list = []
+        for line in stdout.splitlines():
+            status = status_map.get(line.strip())
+            if status is None:
+                continue
+            status_list.append(status)
+
+        return status_list
+
+    @classmethod
+    def create_image_from_cluster(cls, cluster_name: str,
+                                  tag_filters: Dict[str,
+                                                    str], region: Optional[str],
+                                  zone: Optional[str]) -> str:
+        del region  # unused
+        assert zone is not None
+        label_filter_str = cls._label_filter_str(tag_filters)
+        instance_name_cmd = ('gcloud compute instances list '
+                             f'--filter="({label_filter_str})" '
+                             '--format="json(name)"')
+        returncode, stdout, stderr = subprocess_utils.run_with_retries(
+            instance_name_cmd,
+            retry_returncode=[255],
+        )
+        subprocess_utils.handle_returncode(
+            returncode,
+            instance_name_cmd,
+            error_msg=f'Failed to get instance name for {cluster_name!r}',
+            stderr=stderr,
+            stream_logs=True)
+        instance_names = json.loads(stdout)
+        if len(instance_names) != 1:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.NotSupportedError(
+                    'Only support creating image from single '
+                    f'instance, but got: {instance_names}')
+        instance_name = instance_names[0]['name']
+
+        image_name = f'skypilot-{cluster_name}-{int(time.time())}'
+        create_image_cmd = (f'gcloud compute images create {image_name} '
+                            f'--source-disk  {instance_name} '
+                            f'--source-disk-zone {zone}')
+        logger.debug(create_image_cmd)
+        subprocess_utils.run_with_retries(
+            create_image_cmd,
+            retry_returncode=[255],
+        )
+        subprocess_utils.handle_returncode(
+            returncode,
+            create_image_cmd,
+            error_msg=f'Failed to create image for {cluster_name!r}',
+            stderr=stderr,
+            stream_logs=True)
+
+        image_uri_cmd = (f'gcloud compute images describe {image_name} '
+                         '--format="get(selfLink)"')
+        returncode, stdout, stderr = subprocess_utils.run_with_retries(
+            image_uri_cmd,
+            retry_returncode=[255],
+        )
+
+        subprocess_utils.handle_returncode(
+            returncode,
+            image_uri_cmd,
+            error_msg=f'Failed to get image uri for {cluster_name!r}',
+            stderr=stderr,
+            stream_logs=True)
+
+        image_uri = stdout.strip()
+        image_id = image_uri.partition('projects/')[2]
+        image_id = 'projects/' + image_id
+        return image_id
+
+    @classmethod
+    def maybe_move_image(cls, image_id: str, source_region: str,
+                         target_region: str, source_zone: Optional[str],
+                         target_zone: Optional[str]) -> str:
+        del source_region, target_region, source_zone, target_zone  # Unused.
+        # GCP images are global, so no need to move.
+        return image_id
+
+    @classmethod
+    def delete_image(cls, image_id: str, region: Optional[str]) -> None:
+        del region  # Unused.
+        image_name = image_id.rpartition('/')[2]
+        delete_image_cmd = f'gcloud compute images delete {image_name} --quiet'
+        returncode, _, stderr = subprocess_utils.run_with_retries(
+            delete_image_cmd,
+            retry_returncode=[255],
+        )
+        subprocess_utils.handle_returncode(
+            returncode,
+            delete_image_cmd,
+            error_msg=f'Failed to delete image {image_name!r}',
+            stderr=stderr,
+            stream_logs=True)
```

### Comparing `skypilot-0.3.1/sky/clouds/ibm.py` & `skypilot-0.3.2/sky/clouds/azure.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,286 +1,325 @@
-"""IBM Web Services."""
-import os
-import yaml
+"""Azure."""
+import functools
 import json
-from sky import clouds
-from sky.clouds import service_catalog
-from sky.adaptors import ibm
-from sky import sky_logging
+import os
+import re
+import subprocess
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple
-from sky.adaptors.ibm import CREDENTIAL_FILE
 
-from sky.clouds.cloud import Zone
+import colorama
+
+from sky import clouds
+from sky import exceptions
+from sky import sky_logging
+from sky import status_lib
+from sky.adaptors import azure
+from sky.clouds import service_catalog
+from sky.skylet import log_lib
+from sky.utils import common_utils
 from sky.utils import ux_utils
+
 if typing.TYPE_CHECKING:
-    # renaming to avoid shadowing variables
-    from sky import resources as resources_lib
+    from sky import resources
 
 logger = sky_logging.init_logger(__name__)
 
+# Minimum set of files under ~/.azure that grant Azure access.
+_CREDENTIAL_FILES = [
+    'azureProfile.json',
+    'clouds.config',
+    'config',
+    'msal_token_cache.json',
+]
+
+_MAX_IDENTITY_FETCH_RETRY = 10
+
+
+def _run_output(cmd):
+    proc = subprocess.run(cmd,
+                          shell=True,
+                          check=True,
+                          stderr=subprocess.PIPE,
+                          stdout=subprocess.PIPE)
+    return proc.stdout.decode('ascii')
+
 
 @clouds.CLOUD_REGISTRY.register
-class IBM(clouds.Cloud):
-    """IBM Web Services."""
+class Azure(clouds.Cloud):
+    """Azure."""
 
-    _REPR = 'IBM'
-    # IBM's VPC instance name length is limited to 63 chars.
-    # since Ray names the instances using the following
-    # format: ray-{cluster_name}-{node_type}-{8-char-uuid}
-    # it leaves 63-3-5-8=47 characters for the cluster name.
-    _MAX_CLUSTER_NAME_LEN_LIMIT = 47
-    _regions: List[clouds.Region] = []
+    _REPR = 'Azure'
+    # Azure has a 90 char limit for resource group; however, SkyPilot adds the
+    # suffix `-<region name>`. Azure also has a 64 char limit for VM names, and
+    # ray adds addtional `ray-`, `-worker`, and `-<9 chars hash>` for the VM
+    # names, so the limit is 64 - 4 - 7 - 10 = 43.
+    # Reference: https://azure.github.io/PSRule.Rules.Azure/en/rules/Azure.ResourceGroup.Name/ # pylint: disable=line-too-long
+    _MAX_CLUSTER_NAME_LEN_LIMIT = 42
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
-        return dict()
+        return {
+            clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER: f'Migrating disk is not supported in {cls._REPR}.',
+        }
 
     @classmethod
-    def _max_cluster_name_length(cls) -> Optional[int]:
+    def _max_cluster_name_length(cls) -> int:
         return cls._MAX_CLUSTER_NAME_LEN_LIMIT
 
+    def instance_type_to_hourly_cost(self,
+                                     instance_type: str,
+                                     use_spot: bool,
+                                     region: Optional[str] = None,
+                                     zone: Optional[str] = None) -> float:
+        return service_catalog.get_hourly_cost(instance_type,
+                                               use_spot=use_spot,
+                                               region=region,
+                                               zone=zone,
+                                               clouds='azure')
+
+    def accelerators_to_hourly_cost(self,
+                                    accelerators: Dict[str, int],
+                                    use_spot: bool,
+                                    region: Optional[str] = None,
+                                    zone: Optional[str] = None) -> float:
+        del accelerators, use_spot, region, zone  # unused
+        # Azure includes accelerators as part of the instance type.
+        # Implementing this is also necessary for e.g., the instance may have 4
+        # GPUs, while the task specifies to use 1 GPU.
+        return 0
+
+    def get_egress_cost(self, num_gigabytes):
+        # In general, query this from the cloud:
+        #   https://azure.microsoft.com/en-us/pricing/details/bandwidth/
+        # NOTE: egress from US East.
+        # NOTE: Not accurate as the pricing tier is based on cumulative monthly
+        # usage.
+        if num_gigabytes > 150 * 1024:
+            return 0.05 * num_gigabytes
+        cost = 0.0
+        if num_gigabytes >= 50 * 1024:
+            cost += (num_gigabytes - 50 * 1024) * 0.07
+            num_gigabytes -= 50 * 1024
+
+        if num_gigabytes >= 10 * 1024:
+            cost += (num_gigabytes - 10 * 1024) * 0.083
+            num_gigabytes -= 10 * 1024
+
+        if num_gigabytes > 1:
+            cost += (num_gigabytes - 1) * 0.0875
+
+        cost += 0.0
+        return cost
+
+    def is_same_cloud(self, other):
+        return isinstance(other, Azure)
+
+    @classmethod
+    def get_default_instance_type(
+            cls,
+            cpus: Optional[str] = None,
+            memory: Optional[str] = None,
+            disk_tier: Optional[str] = None) -> Optional[str]:
+        return service_catalog.get_default_instance_type(cpus=cpus,
+                                                         memory=memory,
+                                                         disk_tier=disk_tier,
+                                                         clouds='azure')
+
+    def _get_image_config(self, gen_version, instance_type):
+        # az vm image list \
+        #  --publisher microsoft-dsvm --all --output table
+        # nvidia-driver: 495.29.05, cuda: 11.5
+
+        # The latest image 2022.09.14/2022.08.11/22.06.10/22.05.11/
+        # 22.04.27/22.04.05 has even older nvidia driver 470.57.02,
+        # cuda: 11.4
+        image_config = {
+            'image_publisher': 'microsoft-dsvm',
+            'image_offer': 'ubuntu-2004',
+            'image_sku': '2004-gen2',
+            'image_version': '21.11.04'
+        }
+
+        # ubuntu-2004 v21.10.21 and v21.11.04 do not work on K80
+        # due to an NVIDIA driver issue.
+        acc = self.get_accelerators_from_instance_type(instance_type)
+        if acc is not None:
+            acc_name = list(acc.keys())[0]
+            if acc_name == 'K80':
+                image_config['image_version'] = '21.08.30'
+
+        # ubuntu-2004 does not work on A100
+        if instance_type in [
+                'Standard_ND96asr_v4', 'Standard_ND96amsr_A100_v4'
+        ]:
+            image_config['image_offer'] = 'ubuntu-hpc'
+            image_config['image_sku'] = '2004'
+            image_config['image_version'] = '20.04.2021120101'
+        if gen_version == 'V1':
+            image_config['image_sku'] = '2004'
+        return image_config
+
     @classmethod
     def regions_with_offering(cls, instance_type: str,
                               accelerators: Optional[Dict[str, int]],
                               use_spot: bool, region: Optional[str],
                               zone: Optional[str]) -> List[clouds.Region]:
         del accelerators  # unused
-        if use_spot:
-            return []
+        assert zone is None, 'Azure does not support zones'
         regions = service_catalog.get_region_zones_for_instance_type(
-            instance_type, use_spot, 'ibm')
+            instance_type, use_spot, 'azure')
 
         if region is not None:
             regions = [r for r in regions if r.name == region]
-        if zone is not None:
-            for r in regions:
-                assert r.zones is not None, r
-                r.set_zones([z for z in r.zones if z.name == zone])
-            regions = [r for r in regions if r.zones]
         return regions
 
     @classmethod
     def zones_provision_loop(
         cls,
         *,
         region: str,
         num_nodes: int,
         instance_type: str,
         accelerators: Optional[Dict[str, int]] = None,
         use_spot: bool = False,
-    ) -> Iterator[Optional[List[Zone]]]:
-        """Loops over (region, zones) to retry for provisioning.
-
-        returning a single zone list with its region,
-        since ibm cloud currently doesn't
-        support retries for list of zones.
-
-        Args:
-            instance_type: The instance type to provision.
-            accelerators: The accelerators to provision.
-            use_spot: Whether to use spot instances.
-        """
-        # del accelerators  # unused
+    ) -> Iterator[None]:
         del num_nodes  # unused
-        assert use_spot is False, (
-            'current IBM implementation doesn\'t support spot instances')
-
         regions = cls.regions_with_offering(instance_type,
                                             accelerators,
                                             use_spot,
                                             region=region,
                                             zone=None)
-        # IBM provisioner currently takes 1 zone per request.
         for r in regions:
-            assert r.zones is not None, r
-            for zone in r.zones:
-                yield [zone]
+            assert r.zones is None, r
+            yield r.zones
 
-    @classmethod
-    def get_zone_shell_cmd(cls) -> Optional[str]:
-        return None
-
-    def instance_type_to_hourly_cost(self,
-                                     instance_type: str,
-                                     use_spot: bool,
-                                     region: Optional[str] = None,
-                                     zone: Optional[str] = None) -> float:
-        # Currently doesn't support spot instances, hence use_spot set to False.
-        del use_spot
-        return service_catalog.get_hourly_cost(instance_type,
-                                               use_spot=False,
-                                               region=region,
-                                               zone=zone,
-                                               clouds='ibm')
+    # TODO: factor the following three methods, as they are the same logic
+    # between Azure and AWS.
 
-    def accelerators_to_hourly_cost(self,
-                                    accelerators: Dict[str, int],
-                                    use_spot: bool,
-                                    region: Optional[str] = None,
-                                    zone: Optional[str] = None) -> float:
-        del accelerators, use_spot, region, zone  # unused
-        # Currently Isn't implemented in the same manner by aws and azure.
-        return 0
+    @classmethod
+    def get_accelerators_from_instance_type(
+        cls,
+        instance_type: str,
+    ) -> Optional[Dict[str, int]]:
+        return service_catalog.get_accelerators_from_instance_type(
+            instance_type, clouds='azure')
 
-    def get_egress_cost(self, num_gigabytes):
-        """Returns the egress cost. Currently true for us-south, i.e. Dallas.
-        based on https://cloud.ibm.com/objectstorage/create#pricing. """
-        cost = 0
-        price_thresholds = [{
-            'threshold': 150,
-            'price_per_gb': 0.05
-        }, {
-            'threshold': 50,
-            'price_per_gb': 0.07
-        }, {
-            'threshold': 0,
-            'price_per_gb': 0.09
-        }]
-        for price_threshold in price_thresholds:
-            # pylint: disable=line-too-long
-            cost += (num_gigabytes - price_threshold['threshold']
-                    ) * price_threshold['price_per_gb']
-            num_gigabytes -= (num_gigabytes - price_threshold['threshold'])
-        return cost
+    @classmethod
+    def get_vcpus_mem_from_instance_type(
+        cls,
+        instance_type: str,
+    ) -> Tuple[Optional[float], Optional[float]]:
+        return service_catalog.get_vcpus_mem_from_instance_type(instance_type,
+                                                                clouds='azure')
 
-    def is_same_cloud(self, other):
-        return isinstance(other, IBM)
+    @classmethod
+    def get_zone_shell_cmd(cls) -> Optional[str]:
+        return None
 
     def make_deploy_resources_variables(
-        self,
-        resources: 'resources_lib.Resources',
-        region: 'clouds.Region',
-        zones: Optional[List['clouds.Zone']],
-    ) -> Dict[str, Optional[str]]:
-        """Converts planned sky.Resources to cloud-specific resource variables.
-
-        These variables are used to fill the node type section (instance type,
-        any accelerators, etc.) in the cloud's deployment YAML template.
-
-        Cloud-agnostic sections (e.g., commands to run) need not be returned by
-        this function.
-
-        Returns:
-          A dictionary of cloud-specific node type variables.
-        """
-
-        def _get_profile_resources(instance_profile):
-            """returns a dict representing the
-             cpu, memory and gpu of specified instance profile"""
-
-            cpu_num, memory_num = self.get_vcpus_mem_from_instance_type(
-                instance_profile)
-            gpu_num = self.get_accelerators_from_instance_type(instance_profile)
-            gpu_num = list(gpu_num.values())[0] if gpu_num else 0
-            return {'CPU': cpu_num, 'memory': memory_num, 'GPU': gpu_num}
+            self, resources: 'resources.Resources', region: 'clouds.Region',
+            zones: Optional[List['clouds.Zone']]) -> Dict[str, Optional[str]]:
+        assert zones is None, ('Azure does not support zones', zones)
 
         region_name = region.name
-        # zones is guaranteed to be initialized for
-        # clouds implementing 'zones_provision_loop()'
-        zone_names = [zone.name for zone in zones]  # type: ignore[union-attr]
 
         r = resources
         assert not r.use_spot, \
-            'IBM does not currently support spot instances in this framework'
-
+            'Our subscription offer ID does not support spot instances.'
+        # r.accelerators is cleared but .instance_type encodes the info.
         acc_dict = self.get_accelerators_from_instance_type(r.instance_type)
         if acc_dict is not None:
             custom_resources = json.dumps(acc_dict, separators=(',', ':'))
         else:
             custom_resources = None
-
-        instance_resources = _get_profile_resources(r.instance_type)
-
-        worker_instance_type = get_cred_file_field('worker_instance_type',
-                                                   r.instance_type)
-        worker_instance_resources = _get_profile_resources(worker_instance_type)
-        # r.image_id: {clouds.Region:image_id} - property of Resources class
-        image_id = r.image_id[
-            region.name] if r.image_id else self.get_default_image(region_name)
-
+        from sky.clouds.service_catalog import azure_catalog  # pylint: disable=import-outside-toplevel
+        gen_version = azure_catalog.get_gen_version_from_instance_type(
+            r.instance_type)
+        image_config = self._get_image_config(gen_version, r.instance_type)
         return {
             'instance_type': r.instance_type,
-            'instance_resources': instance_resources,
-            'worker_instance_type': worker_instance_type,
-            'worker_instance_resources': worker_instance_resources,
             'custom_resources': custom_resources,
             'use_spot': r.use_spot,
             'region': region_name,
-            'zones': ','.join(zone_names),
-            'image_id': image_id,
-            'iam_api_key': get_cred_file_field('iam_api_key'),
-            'resource_group_id': get_cred_file_field('resource_group_id'),
-            'disk_capacity': get_cred_file_field('disk_capacity', 100)
+            # Azure does not support specific zones.
+            'zones': None,
+            **image_config,
+            'disk_tier': Azure._get_disk_type(r.disk_tier)
         }
 
-    @classmethod
-    def get_vcpus_mem_from_instance_type(
-        cls,
-        instance_type: str,
-    ) -> Tuple[Optional[float], Optional[float]]:
-        return service_catalog.get_vcpus_mem_from_instance_type(instance_type,
-                                                                clouds='ibm')
-
-    @classmethod
-    def get_accelerators_from_instance_type(
-        cls,
-        instance_type: str,
-    ) -> Optional[Dict[str, int]]:
-        """Returns {acc: acc_count} held by 'instance_type', if any."""
-        return service_catalog.get_accelerators_from_instance_type(
-            instance_type, clouds='ibm')
+    def get_feasible_launchable_resources(self, resources):
 
-    @classmethod
-    def get_default_instance_type(
-            cls,
-            cpus: Optional[str] = None,
-            memory: Optional[str] = None,
-            disk_tier: Optional[str] = None) -> Optional[str]:
-        return service_catalog.get_default_instance_type(cpus=cpus,
-                                                         memory=memory,
-                                                         disk_tier=disk_tier,
-                                                         clouds='ibm')
-
-    def get_feasible_launchable_resources(self,
-                                          resources: 'resources_lib.Resources'):
-        """Returns a list of feasible and launchable resources.
-
-        Feasible resources refer to an offering respecting the resource
-        requirements.  Currently, this function implements "filtering" the
-        cloud's offerings only w.r.t. accelerators constraints.
-
-        Launchable resources require a cloud and an instance type be assigned.
-        """
-        fuzzy_candidate_list: Optional[List[str]] = []
+        def failover_disk_tier(instance_type: str,
+                               disk_tier: Optional[str]) -> Optional[str]:
+            """Figure out the actual disk tier to be used
+
+            Check the disk_tier specified by the user with the instance type to
+            be used. If not valid, return None.
+            When the disk_tier is not specified, failover through the possible
+            disk tiers.
+
+            Returns:
+                The actual disk tier to be used. If None, the specified
+                configuration is not a valid combination, and should not be used
+                for launching a VM.
+            """
+            if disk_tier is not None:
+                ok, _ = Azure.check_disk_tier(instance_type, disk_tier)
+                return disk_tier if ok else None
+            disk_tier = clouds.Cloud._DEFAULT_DISK_TIER
+            all_tiers = {'high', 'medium', 'low'}
+            while not Azure.check_disk_tier(instance_type, disk_tier)[0]:
+                all_tiers.remove(disk_tier)
+                if not all_tiers:
+                    # No available disk_tier found the specified instance_type
+                    return None
+                disk_tier = list(all_tiers)[0]
+            return disk_tier
+
+        if resources.use_spot:
+            # TODO(zhwu): our azure subscription offer ID does not support spot.
+            # Need to support it.
+            return ([], [])
         if resources.instance_type is not None:
             assert resources.is_launchable(), resources
-            resources = resources.copy(accelerators=None)
-            return ([resources], fuzzy_candidate_list)
+            # Treat Resources(AWS, p3.2x, V100) as Resources(AWS, p3.2x).
+            resources = resources.copy(
+                accelerators=None,
+                disk_tier=failover_disk_tier(resources.instance_type,
+                                             resources.disk_tier),
+            )
+            return ([resources], [])
 
         def _make(instance_list):
             resource_list = []
             for instance_type in instance_list:
+                disk_tier = failover_disk_tier(instance_type,
+                                               resources.disk_tier)
+                if not disk_tier:
+                    continue
                 r = resources.copy(
-                    cloud=IBM(),
+                    cloud=Azure(),
                     instance_type=instance_type,
-                    # Setting this to None as IBM doesn't separately bill /
+                    disk_tier=disk_tier,
+                    # Setting this to None as Azure doesn't separately bill /
                     # attach the accelerators.  Billed as part of the VM type.
                     accelerators=None,
                     cpus=None,
-                    memory=None)
+                    memory=None,
+                )
                 resource_list.append(r)
             return resource_list
 
         # Currently, handle a filter on accelerators only.
         accelerators = resources.accelerators
         if accelerators is None:
             # Return a default instance type with the given number of vCPUs.
-            default_instance_type = IBM.get_default_instance_type(
+            default_instance_type = Azure.get_default_instance_type(
                 cpus=resources.cpus,
                 memory=resources.memory,
                 disk_tier=resources.disk_tier)
             if default_instance_type is None:
                 return ([], [])
             else:
                 return (_make([default_instance_type]), [])
@@ -289,155 +328,265 @@
         acc, acc_count = list(accelerators.items())[0]
         (instance_list, fuzzy_candidate_list
         ) = service_catalog.get_instance_type_for_accelerator(
             acc,
             acc_count,
             cpus=resources.cpus,
             memory=resources.memory,
+            use_spot=resources.use_spot,
             region=resources.region,
             zone=resources.zone,
-            clouds='ibm')
+            clouds='azure')
         if instance_list is None:
             return ([], fuzzy_candidate_list)
         return (_make(instance_list), fuzzy_candidate_list)
 
     @classmethod
-    def get_default_image(cls, region) -> str:
-        """
-        Returns default image id, currently stock ubuntu 22-04.
-        if user specified 'image_id' in ~/.ibm/credentials.yaml
-            matching this 'region', returns it instead.
-        """
-
-        def _get_image_objects():
-            # pylint: disable=E1136
-            images = []
-            res = client.list_images().get_result()
-            images.extend(res['images'])
-
-            while res.get('next'):
-                link_to_next = res['next']['href'].split('start=')[1].split(
-                    '&limit')[0]
-                res = client.list_images(start=link_to_next).get_result()
-                images.extend(res['images'])
-            return images
-
-        # if user specified an image id for the region, return it.
-        # IBM-TODO take into account user input when --image-id
-        # is implemented
-        user_image = get_cred_file_field('image_id')
-        if user_image and region in user_image:
-            logger.debug(f'using user image: {user_image[region]} '
-                         f'in region: {region}.')
-            return user_image[region]
-
-        client = ibm.client(region=region)
-        # returns default image: "ibm-ubuntu-22-04" with amd architecture
-        return next((img for img in _get_image_objects() if
-         img['name'].startswith('ibm-ubuntu-22-04') \
-            and img['operating_system']['architecture'].startswith(
-                'amd')))['id']
-
-    def get_image_size(self, image_id: str, region: Optional[str]) -> float:
-        assert region is not None, (image_id, region)
-        client = ibm.client(region=region)
-        try:
-            image_data = client.get_image(image_id).get_result()
-        # pylint: disable=line-too-long
-        except ibm.ibm_cloud_sdk_core.ApiException as e:  # type: ignore[union-attr]
-            logger.error(e.message)
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(f'Image {image_id!r} not found in '
-                                 f'IBM region "{region}"') from None
-        try:
-            # image_size['file']['size'] is not relevant, since
-            # the minimum size of a volume onto which this image
-            # may be provisioned is stored in minimum_provisioned_size
-            # pylint: disable=unsubscriptable-object
-            image_size = image_data['minimum_provisioned_size']
-        except KeyError:
-            logger.error('Image missing metadata:"minimum_provisioned_size". '
-                         'Image may be in status: Failed/Pending.')
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(
-                    f'IBM image {image_id!r} in '
-                    f'region "{region}", is missing'
-                    'metadata:"minimum_provisioned_size". '
-                    'Image may be in status: Failed/Pending') from None
-        return image_size
-
-    @classmethod
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
         """Checks if the user has access credentials to this cloud."""
-        # IBM-TODO - create a configuration script.
-        required_fields = ['iam_api_key', 'resource_group_id']
-        help_str = ('    Store your API key and Resource Group id '
-                    f'in {CREDENTIAL_FILE} in the following format:\n'
-                    '      iam_api_key: <IAM_API_KEY>\n'
-                    '      resource_group_id: <RESOURCE_GROUP_ID>')
-
-        base_config = _read_credential_file()
-        if not base_config:
-            return (False, 'Missing credential file at '
-                    f'{os.path.expanduser(CREDENTIAL_FILE)}.\n' + help_str)
-
-        for field in required_fields:
-            if field not in base_config:
-                return (False, f'Missing field "{field}" in '
-                        f'{os.path.expanduser(CREDENTIAL_FILE)}.\n' + help_str)
+        help_str = (
+            ' Run the following commands:'
+            '\n      $ az login'
+            '\n      $ az account set -s <subscription_id>'
+            '\n    For more info: '
+            'https://docs.microsoft.com/en-us/cli/azure/get-started-with-azure-cli'  # pylint: disable=line-too-long
+        )
+        # This file is required because it will be synced to remote VMs for
+        # `az` to access private storage buckets.
+        # `az account show` does not guarantee this file exists.
+        azure_token_cache_file = '~/.azure/msal_token_cache.json'
+        if not os.path.isfile(os.path.expanduser(azure_token_cache_file)):
+            return (False,
+                    f'{azure_token_cache_file} does not exist.' + help_str)
 
-        # verifies ability of user to create a client,
-        # e.g. bad API KEY.
         try:
-            ibm.client()
-            return True, None
-        # pylint: disable=W0703
-        except Exception as e:
-            return (False, f'{str(e)}' + help_str)
-
-    @classmethod
-    def check_disk_tier_enabled(cls, instance_type: str,
-                                disk_tier: str) -> None:
-        del instance_type, disk_tier  # unused
+            _run_output('az --version')
+        except subprocess.CalledProcessError:
+            return False, (
+                # TODO(zhwu): Change the installation hint to from PyPI.
+                'Azure CLI returned error. Run the following commands:'
+                '\n      $ pip install skypilot[azure]'
+                '\n    Credentials may also need to be set.' + help_str)
+        # If Azure is properly logged in, this will return the account email
+        # address + subscription ID.
+        try:
+            cls.get_current_user_identity()
+        except exceptions.CloudUserIdentityError:
+            return False, 'Azure credential is not set.' + help_str
+        return True, None
 
     def get_credential_file_mounts(self) -> Dict[str, str]:
-        """Returns a {remote:local} credential path mapping
-         written to the cluster's file_mounts segment
-         of its yaml file (e.g., ibm-ray.yml.j2)
-        """
-        return {CREDENTIAL_FILE: CREDENTIAL_FILE}
+        """Returns a dict of credential file paths to mount paths."""
+        return {
+            f'~/.azure/{filename}': f'~/.azure/{filename}'
+            for filename in _CREDENTIAL_FILES
+        }
 
     def instance_type_exists(self, instance_type):
-        """Returns whether the instance type exists for this cloud."""
-        return service_catalog.instance_type_exists(instance_type, clouds='ibm')
-
-    def validate_region_zone(self, region: Optional[str], zone: Optional[str]):
-        """Validates the region and zone."""
-        return service_catalog.validate_region_zone(region, zone, clouds='ibm')
+        return service_catalog.instance_type_exists(instance_type,
+                                                    clouds='azure')
 
     def accelerator_in_region_or_zone(self,
                                       accelerator: str,
                                       acc_count: int,
                                       region: Optional[str] = None,
                                       zone: Optional[str] = None) -> bool:
-        """Returns whether the accelerator is valid in the region or zone."""
         return service_catalog.accelerator_in_region_or_zone(
-            accelerator, acc_count, region, zone, 'ibm')
+            accelerator, acc_count, region, zone, 'azure')
 
+    @classmethod
+    @functools.lru_cache(maxsize=1)  # Cache since getting identity is slow.
+    def get_current_user_identity(cls) -> Optional[List[str]]:
+        """Returns the cloud user identity."""
+        # This returns the user's email address + [subscription_id].
+        retry_cnt = 0
+        while True:
+            retry_cnt += 1
+            try:
+                import knack  # pylint: disable=import-outside-toplevel
+            except ModuleNotFoundError as e:
+                with ux_utils.print_exception_no_traceback():
+                    raise exceptions.CloudUserIdentityError(
+                        'Failed to import \'knack\'. To install the dependencies for Azure, '
+                        'Please install SkyPilot with: '
+                        f'{colorama.Style.BRIGHT}pip install skypilot[azure]'
+                        f'{colorama.Style.RESET_ALL}') from e
+            try:
+                account_email = azure.get_current_account_user()
+                break
+            except (FileNotFoundError, knack.util.CLIError) as e:
+                error = exceptions.CloudUserIdentityError(
+                    'Failed to get activated Azure account.\n'
+                    '  Reason: '
+                    f'{common_utils.format_exception(e, use_bracket=True)}')
+                if retry_cnt <= _MAX_IDENTITY_FETCH_RETRY:
+                    logger.debug(f'{error}.\nRetrying...')
+                    continue
+                with ux_utils.print_exception_no_traceback():
+                    raise error from None
+            except Exception as e:  # pylint: disable=broad-except
+                with ux_utils.print_exception_no_traceback():
+                    raise exceptions.CloudUserIdentityError(
+                        'Failed to get Azure user identity with unknown '
+                        f'exception.\n'
+                        '  Reason: '
+                        f'{common_utils.format_exception(e, use_bracket=True)}'
+                    ) from e
+        try:
+            project_id = cls.get_project_id()
+        except (ModuleNotFoundError, RuntimeError) as e:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.CloudUserIdentityError(
+                    'Failed to get Azure project ID.') from e
+        return [f'{account_email} [subscription_id={project_id}]']
 
-def _read_credential_file():
-    try:
-        with open(os.path.expanduser(CREDENTIAL_FILE), 'r',
-                  encoding='utf-8') as f:
-            return yaml.safe_load(f)
-    except FileNotFoundError:
-        return False
-
-
-def get_cred_file_field(field, default_val=None) -> str:
-    """returns a the value of a field from the user's
-     credentials file if exists, else default_val"""
-    base_config = _read_credential_file()
-    if not base_config:
-        raise FileNotFoundError('Missing '
-                                f'credential file at {CREDENTIAL_FILE}')
-    return base_config.get(field, default_val)
+    @classmethod
+    def get_project_id(cls, dryrun: bool = False) -> str:
+        if dryrun:
+            return 'dryrun-project-id'
+        try:
+            azure_subscription_id = azure.get_subscription_id()
+            if not azure_subscription_id:
+                raise ValueError  # The error message will be replaced.
+        except ModuleNotFoundError as e:
+            with ux_utils.print_exception_no_traceback():
+                raise ModuleNotFoundError('Unable to import azure python '
+                                          'module. Is azure-cli python package '
+                                          'installed? Try pip install '
+                                          '.[azure] in the sky repo.') from e
+        except Exception as e:  # pylint: disable=broad-except
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError(
+                    'Failed to get subscription id from azure cli. '
+                    'Make sure you have logged in and run this Azure '
+                    'cli command: "az account set -s <subscription_id>".'
+                ) from e
+        return azure_subscription_id
+
+    @classmethod
+    def _is_s_series(cls, instance_type: Optional[str]) -> bool:
+        # For azure naming convention, see https://learn.microsoft.com/en-us/azure/virtual-machines/vm-naming-conventions  # pylint: disable=line-too-long
+        if instance_type is None:
+            return True
+        x = re.match(
+            r'(Standard|Basic)_([A-Z]+)([0-9]+)(-[0-9]+)?'
+            r'([a-z]*)(_[A-Z]+[0-9]+)?(_v[0-9])?(_Promo)?', instance_type)
+        assert x is not None, f'Unknown instance type: {instance_type}'
+        return 's' in x.group(5)
+
+    @classmethod
+    def check_disk_tier(cls, instance_type: Optional[str],
+                        disk_tier: Optional[str]) -> Tuple[bool, str]:
+        if disk_tier is None:
+            return True, ''
+        if disk_tier == 'high':
+            return False, ('Azure disk_tier=high is not supported now. '
+                           'Please use disk_tier={low, medium} instead.')
+        # Only S-series supported premium ssd
+        # see https://stackoverflow.com/questions/48590520/azure-requested-operation-cannot-be-performed-because-storage-account-type-pre  # pylint: disable=line-too-long
+        if cls._get_disk_type(
+                disk_tier
+        ) == 'Premium_LRS' and not Azure._is_s_series(instance_type):
+            return False, (
+                'Azure premium SSDs are only supported for S-series '
+                'instances. To use disk_tier=medium, please make sure '
+                'instance_type is specified to an S-series instance.')
+        return True, ''
+
+    @classmethod
+    def check_disk_tier_enabled(cls, instance_type: str,
+                                disk_tier: str) -> None:
+        ok, msg = cls.check_disk_tier(instance_type, disk_tier)
+        if not ok:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(msg)
+
+    @classmethod
+    def _get_disk_type(cls, disk_tier: Optional[str]) -> str:
+        tier = disk_tier or cls._DEFAULT_DISK_TIER
+        # TODO(tian): Maybe use PremiumV2_LRS/UltraSSD_LRS? Notice these two
+        # cannot be used as OS disks so we might need data disk support
+        tier2name = {
+            'high': 'Disabled',
+            'medium': 'Premium_LRS',
+            'low': 'Standard_LRS',
+        }
+        return tier2name[tier]
+
+    @classmethod
+    def query_status(cls, name: str, tag_filters: Dict[str, str],
+                     region: Optional[str], zone: Optional[str],
+                     **kwargs) -> List[status_lib.ClusterStatus]:
+        del zone  # unused
+        status_map = {
+            'VM starting': status_lib.ClusterStatus.INIT,
+            'VM running': status_lib.ClusterStatus.UP,
+            # 'VM stopped' in Azure means Stopped (Allocated), which still bills
+            # for the VM.
+            'VM stopping': status_lib.ClusterStatus.INIT,
+            'VM stopped': status_lib.ClusterStatus.INIT,
+            # 'VM deallocated' in Azure means Stopped (Deallocated), which does not
+            # bill for the VM.
+            'VM deallocating': status_lib.ClusterStatus.STOPPED,
+            'VM deallocated': status_lib.ClusterStatus.STOPPED,
+        }
+        tag_filter_str = ' '.join(
+            f'tags.\\"{k}\\"==\'{v}\'' for k, v in tag_filters.items())
+
+        query_node_id = (f'az vm list --query "[?{tag_filter_str}].id" -o json')
+        returncode, stdout, stderr = log_lib.run_with_log(query_node_id,
+                                                          '/dev/null',
+                                                          require_outputs=True,
+                                                          shell=True)
+        logger.debug(f'{query_node_id} returned {returncode}.\n'
+                     '**** STDOUT ****\n'
+                     f'{stdout}\n'
+                     '**** STDERR ****\n'
+                     f'{stderr}')
+        if returncode == 0:
+            if not stdout.strip():
+                return []
+            node_ids = json.loads(stdout.strip())
+            if not node_ids:
+                return []
+            state_str = '[].powerState'
+            if len(node_ids) == 1:
+                state_str = 'powerState'
+            node_ids_str = '\t'.join(node_ids)
+            query_cmd = (
+                f'az vm show -d --ids {node_ids_str} --query "{state_str}" -o json'
+            )
+            returncode, stdout, stderr = log_lib.run_with_log(
+                query_cmd, '/dev/null', require_outputs=True, shell=True)
+            logger.debug(f'{query_cmd} returned {returncode}.\n'
+                         '**** STDOUT ****\n'
+                         f'{stdout}\n'
+                         '**** STDERR ****\n'
+                         f'{stderr}')
+
+        # NOTE: Azure cli should be handled carefully. The query command above
+        # takes about 1 second to run.
+        # An alternative is the following command, but it will take more than
+        # 20 seconds to run.
+        # query_cmd = (
+        #     f'az vm list --show-details --query "['
+        #     f'?tags.\\"ray-cluster-name\\" == \'{handle.cluster_name}\' '
+        #     '&& tags.\\"ray-node-type\\" == \'head\'].powerState" -o tsv'
+        # )
+
+        if returncode != 0:
+            with ux_utils.print_exception_no_traceback():
+                raise exceptions.ClusterStatusFetchingError(
+                    f'Failed to query Azure cluster {name!r} status: '
+                    f'{stdout + stderr}')
+
+        assert stdout.strip(), f'No status returned for {name!r}'
+
+        original_statuses_list = json.loads(stdout.strip())
+        if not isinstance(original_statuses_list, list):
+            original_statuses_list = [original_statuses_list]
+        statuses = []
+        for s in original_statuses_list:
+            node_status = status_map[s]
+            if node_status is not None:
+                statuses.append(node_status)
+        return statuses
```

### Comparing `skypilot-0.3.1/sky/clouds/lambda_cloud.py` & `skypilot-0.3.2/sky/clouds/lambda_cloud.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """Lambda Cloud."""
 import json
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
 from sky import exceptions
+from sky import status_lib
 from sky.clouds import service_catalog
 from sky.skylet.providers.lambda_cloud import lambda_utils
 
 if typing.TYPE_CHECKING:
     # Renaming to avoid shadowing variables.
     from sky import resources as resources_lib
 
@@ -30,14 +31,15 @@
     _MAX_CLUSTER_NAME_LEN_LIMIT = 57
     # Currently, none of clouds.CloudImplementationFeatures are implemented
     # for Lambda Cloud.
     # STOP/AUTOSTOP: The Lambda cloud provider does not support stopping VMs.
     _CLOUD_UNSUPPORTED_FEATURES = {
         clouds.CloudImplementationFeatures.STOP: 'Lambda cloud does not support stopping VMs.',
         clouds.CloudImplementationFeatures.AUTOSTOP: 'Lambda cloud does not support stopping VMs.',
+        clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER: f'Migrating disk is not supported in {_REPR}.',
     }
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return cls._CLOUD_UNSUPPORTED_FEATURES
 
@@ -259,7 +261,28 @@
         return service_catalog.regions(clouds='lambda')
 
     @classmethod
     def check_disk_tier_enabled(cls, instance_type: str,
                                 disk_tier: str) -> None:
         raise exceptions.NotSupportedError(
             'Lambda does not support disk tiers.')
+
+    @classmethod
+    def query_status(cls, name: str, tag_filters: Dict[str, str],
+                     region: Optional[str], zone: Optional[str],
+                     **kwargs) -> List[status_lib.ClusterStatus]:
+        status_map = {
+            'booting': status_lib.ClusterStatus.INIT,
+            'active': status_lib.ClusterStatus.UP,
+            'unhealthy': status_lib.ClusterStatus.INIT,
+            'terminated': None,
+        }
+        # TODO(ewzeng): filter by hash_filter_string to be safe
+        status_list = []
+        vms = lambda_utils.LambdaCloudClient().list_instances()
+        possible_names = [f'{name}-head', f'{name}-worker']
+        for node in vms:
+            if node.get('name') in possible_names:
+                node_status = status_map[node['status']]
+                if node_status is not None:
+                    status_list.append(node_status)
+        return status_list
```

### Comparing `skypilot-0.3.1/sky/clouds/local.py` & `skypilot-0.3.2/sky/clouds/local.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,29 +1,19 @@
 """Local/On-premise."""
-import subprocess
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
 from sky import exceptions
 
 if typing.TYPE_CHECKING:
     # Renaming to avoid shadowing variables.
     from sky import resources as resources_lib
 
 
-def _run_output(cmd):
-    proc = subprocess.run(cmd,
-                          shell=True,
-                          check=True,
-                          stderr=subprocess.PIPE,
-                          stdout=subprocess.PIPE)
-    return proc.stdout.decode('ascii')
-
-
 @clouds.CLOUD_REGISTRY.register
 class Local(clouds.Cloud):
     """Local/on-premise cloud.
 
     This Cloud has the following special treatment of Cloud concepts:
 
     - Catalog: Does not have service catalog.
@@ -37,15 +27,17 @@
     """
     _DEFAULT_INSTANCE_TYPE = 'on-prem'
     LOCAL_REGION = clouds.Region('Local')
     _CLOUD_UNSUPPORTED_FEATURES = {
         clouds.CloudImplementationFeatures.STOP:
             ('Local cloud does not support stopping instances.'),
         clouds.CloudImplementationFeatures.AUTOSTOP:
-            ('Local cloud does not support stopping instances.')
+            ('Local cloud does not support stopping instances.'),
+        clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
+            ('Migrating disk is not supported for Local.'),
     }
 
     @classmethod
     def _cloud_unsupported_features(
             cls) -> Dict[clouds.CloudImplementationFeatures, str]:
         return cls._CLOUD_UNSUPPORTED_FEATURES
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/__init__.py` & `skypilot-0.3.2/sky/clouds/service_catalog/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -12,15 +12,15 @@
 from sky.clouds.service_catalog.config import use_default_catalog
 
 if typing.TYPE_CHECKING:
     from sky.clouds import cloud
     from sky.clouds.service_catalog import common
 
 CloudFilter = Optional[Union[List[str], str]]
-_ALL_CLOUDS = ('aws', 'azure', 'gcp', 'ibm', 'lambda')
+_ALL_CLOUDS = ('aws', 'azure', 'gcp', 'ibm', 'lambda', 'scp', 'oci')
 
 
 def _map_clouds_catalog(clouds: CloudFilter, method_name: str, *args, **kwargs):
     if clouds is None:
         clouds = list(_ALL_CLOUDS)
     single = isinstance(clouds, str)
     if single:
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/aws_catalog.py` & `skypilot-0.3.2/sky/clouds/service_catalog/aws_catalog.py`

 * *Files 4% similar despite different names*

```diff
@@ -60,14 +60,17 @@
                                   pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 _user_df = None
 _apply_az_mapping_lock = threading.Lock()
 
 _image_df = common.read_catalog('aws/images.csv',
                                 pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
+_quotas_df = common.read_catalog('aws/instance_quota_mapping.csv',
+                                 pull_frequency_hours=_PULL_FREQUENCY_HOURS)
+
 
 def _fetch_and_apply_az_mapping(df: pd.DataFrame) -> pd.DataFrame:
     """Maps zone IDs (use1-az1) to zone names (us-east-1x).
 
     The upper-level functions that use the availability zone information
     should be able to handle the case where the zone name is not correct,
     due to the credentials not being configured.
@@ -144,14 +147,32 @@
         global _user_df
         with _apply_az_mapping_lock:
             if _user_df is None:
                 _user_df = _fetch_and_apply_az_mapping(_default_df)
         return _user_df
 
 
+def get_quota_code(instance_type: str, use_spot: bool) -> Optional[str]:
+    # Get the quota code from the accelerator instance type
+    # This will be used in the botocore command to check for
+    # a non-zero quota
+
+    if use_spot:
+        spot_header = 'SpotInstanceCode'
+    else:
+        spot_header = 'OnDemandInstanceCode'
+    try:
+        quota_code = _quotas_df.loc[_quotas_df['InstanceType'] == instance_type,
+                                    spot_header].values[0]
+        return quota_code
+
+    except IndexError:
+        return None
+
+
 def instance_type_exists(instance_type: str) -> bool:
     return common.instance_type_exists_impl(_get_df(), instance_type)
 
 
 def validate_region_zone(
         region: Optional[str],
         zone: Optional[str]) -> Tuple[Optional[str], Optional[str]]:
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/azure_catalog.py` & `skypilot-0.3.2/sky/clouds/service_catalog/azure_catalog.py`

 * *Files 4% similar despite different names*

```diff
@@ -7,15 +7,22 @@
 from typing import Dict, List, Optional, Tuple
 
 from sky import clouds as cloud_lib
 from sky.clouds import Azure
 from sky.clouds.service_catalog import common
 from sky.utils import ux_utils
 
-_df = common.read_catalog('azure/vms.csv')
+# The frequency of pulling the latest catalog from the cloud provider.
+# Though the catalog update is manual in our skypilot-catalog repo, we
+# still want to pull the latest catalog periodically to make sure the
+# user is using the latest catalog.
+_PULL_FREQUENCY_HOURS = 7
+
+_df = common.read_catalog('azure/vms.csv',
+                          pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 # We will select from the following three instance families:
 _DEFAULT_INSTANCE_FAMILY = [
     # The latest general-purpose instance family as of Mar. 2023.
     # CPU: Intel Ice Lake 8370C.
     # Memory: 4 GiB RAM per 1 vCPU;
     'Ds_v5',
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/common.py` & `skypilot-0.3.2/sky/clouds/service_catalog/common.py`

 * *Files 3% similar despite different names*

```diff
@@ -149,15 +149,15 @@
     df: pd.DataFrame,
     instance_type: str,
     region: Optional[str],
     zone: Optional[str] = None,
 ) -> pd.DataFrame:
     idx = df['InstanceType'] == instance_type
     if region is not None:
-        idx &= df['Region'] == region
+        idx &= df['Region'].str.lower() == region.lower()
     if zone is not None:
         # NOTE: For Azure instances, zone must be None.
         idx &= df['AvailabilityZone'] == zone
     return df[idx]
 
 
 def instance_type_exists_impl(df: pd.DataFrame, instance_type: str) -> bool:
@@ -176,33 +176,35 @@
         candidate_strs = ''
         if len(candidate_loc) > 0:
             candidate_strs = ', '.join(candidate_loc)
             candidate_strs = f'\nDid you mean one of these: {candidate_strs!r}?'
         return candidate_strs
 
     def _get_all_supported_regions_str() -> str:
-        all_regions: List[str] = sorted(df['Region'].unique().tolist())
+        all_regions: List[str] = sorted(
+            df['Region'].str.lower().unique().tolist())
         return (f'\nList of supported {cloud_name} regions: '
                 f'{", ".join(all_regions)!r}')
 
     validated_region, validated_zone = region, zone
 
     filter_df = df
     if region is not None:
-        filter_df = filter_df[filter_df['Region'] == region]
+        filter_df = filter_df[filter_df['Region'].str.lower() == region.lower()]
         if len(filter_df) == 0:
             with ux_utils.print_exception_no_traceback():
                 error_msg = (f'Invalid region {region!r}')
-                candidate_strs = _get_candidate_str(region,
-                                                    df['Region'].unique())
+                candidate_strs = _get_candidate_str(
+                    region.lower(), df['Region'].str.lower().unique())
                 if not candidate_strs:
                     error_msg += _get_all_supported_regions_str()
                     raise ValueError(error_msg)
                 error_msg += candidate_strs
                 raise ValueError(error_msg)
+        validated_region = filter_df['Region'].unique()[0]
 
     if zone is not None:
         maybe_region_df = filter_df
         filter_df = filter_df[filter_df['AvailabilityZone'] == zone]
         if len(filter_df) == 0:
             region_str = f' for region {region!r}' if region else ''
             df = maybe_region_df if region else df
@@ -349,16 +351,16 @@
             If the string ends with "x", then the returned instance type should
             have at least the given number of vCPUs times the given ratio.
     """
     df = _filter_with_cpus(df, cpus)
     df = _filter_with_mem(df, memory_gb_or_ratio)
     if df.empty:
         return None
-    # Sort by the number of vCPUs and then by the price.
-    df = df.sort_values(by=['vCPUs', 'Price'], ascending=True)
+    # Sort by the price.
+    df = df.sort_values(by=['Price'], ascending=True)
     return df['InstanceType'].iloc[0]
 
 
 def get_accelerators_from_instance_type_impl(
     df: pd.DataFrame,
     instance_type: str,
 ) -> Optional[Dict[str, int]]:
@@ -402,15 +404,15 @@
                 fuzzy_candidate_list.append(f'{row["AcceleratorName"]}:'
                                             f'{int(row["AcceleratorCount"])}')
         return (None, fuzzy_candidate_list)
 
     result = _filter_with_cpus(result, cpus)
     result = _filter_with_mem(result, memory)
     if region is not None:
-        result = result[result['Region'] == region]
+        result = result[result['Region'].str.lower() == region]
     if zone is not None:
         # NOTE: For Azure regions, zone must be None.
         result = result[result['AvailabilityZone'] == zone]
     if len(result) == 0:
         return ([], [])
 
     # Current strategy: choose the cheapest instance
@@ -524,15 +526,15 @@
 
 
 def _accelerator_in_region(df: pd.DataFrame, acc_name: str, acc_count: int,
                            region: str) -> bool:
     """Returns True if the accelerator is in the region."""
     return len(df[(df['AcceleratorName'] == acc_name) &
                   (df['AcceleratorCount'] == acc_count) &
-                  (df['Region'] == region)]) > 0
+                  (df['Region'].str.lower() == region.lower())]) > 0
 
 
 def _accelerator_in_zone(df: pd.DataFrame, acc_name: str, acc_count: int,
                          zone: str) -> bool:
     """Returns True if the accelerator is in the zone."""
     return len(df[(df['AcceleratorName'] == acc_name) &
                   (df['AcceleratorCount'] == acc_count) &
@@ -564,15 +566,15 @@
     If region is None, there must be only one image with the given tag.
 
     Returns None if a region (or globally if region is None) does not have
     an image that matches the tag.
     """
     df = df[df['Tag'] == tag]
     if region is not None:
-        df = df[df['Region'] == region]
+        df = df[df['Region'].str.lower() == region.lower()]
     assert len(df) <= 1, ('Multiple images found for tag '
                           f'{tag} in region {region}')
     if len(df) == 0:
         return None
     image_id = df['ImageId'].iloc[0]
     if pd.isna(image_id):
         return None
@@ -580,10 +582,10 @@
 
 
 def is_image_tag_valid_impl(df: pd.DataFrame, tag: str,
                             region: Optional[str]) -> bool:
     """Returns True if the image tag is valid."""
     df = df[df['Tag'] == tag]
     if region is not None:
-        df = df[df['Region'] == region]
+        df = df[df['Region'].str.lower() == region.lower()]
     df = df.dropna(subset=['ImageId'])
     return len(df) > 0
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/config.py` & `skypilot-0.3.2/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files 2% similar despite different names*

```diff
@@ -19,15 +19,15 @@
     'eastus',
     'eastus2',
     'northcentralus',
     'southcentralus',
     'westcentralus',
     'westus',
     'westus2',
-    # 'WestUS3',   # WestUS3 pricing table is broken as of 2021/11.
+    'westus3',
 ]
 
 # Exclude the following regions as they do not have ProductName in the
 # pricing table. Reference: #1768
 EXCLUDED_REGIONS = {
     'eastus2euap',
     'centraluseuap',
@@ -97,32 +97,31 @@
               (df['unitPrice'] > 0)]
 
 
 def get_sku_df(region_set: Set[str]) -> pd.DataFrame:
     print('Fetching SKU list')
     # To get a complete list, --all option is necessary.
     proc = subprocess.run(
-        'az vm list-skus --all',
+        'az vm list-skus --all --resource-type virtualMachines -o json',
         shell=True,
         check=True,
         stdout=subprocess.PIPE,
     )
     print('Done fetching SKUs')
     items = json.loads(proc.stdout.decode('ascii'))
     filtered_items = []
     for item in items:
         # zones = item['locationInfo'][0]['zones']
         region = item['locations'][0]
-        if region not in region_set:
+        if region.lower() not in region_set:
             continue
         item['Region'] = region
         filtered_items.append(item)
 
     df = pd.DataFrame(filtered_items)
-    df = df[(df['resourceType'] == 'virtualMachines')]
     return df
 
 
 def get_gpu_name(family: str) -> Optional[str]:
     gpu_data = {
         'standardNCFamily': 'K80',
         'standardNCSv2Family': 'P100',
@@ -159,36 +158,43 @@
     print('Processing dataframes')
     df.drop_duplicates(inplace=True)
 
     df = df[df['unitPrice'] > 0]
 
     print('Getting price df')
     df['merge_name'] = df['armSkuName']
+    # Use lower case for the Region, as for westus3, the SKU API returns
+    # WestUS3.
+    # This is inconsistent with the region name used in the pricing API, and
+    # the case does not matter for launching instances, so we can safely
+    # discard the case.
+    df['Region'] = df['armRegionName'].str.lower()
     df['is_promo'] = df['skuName'].str.endswith(' Low Priority')
     df.rename(columns={
         'armSkuName': 'InstanceType',
-        'armRegionName': 'Region',
-    },
-              inplace=True)
+    }, inplace=True)
     demand_df = df[~df['skuName'].str.contains(' Spot')][[
         'is_promo', 'InstanceType', 'Region', 'unitPrice'
     ]]
     spot_df = df[df['skuName'].str.contains(' Spot')][[
         'is_promo', 'InstanceType', 'Region', 'unitPrice'
     ]]
+
     demand_df.set_index(['InstanceType', 'Region', 'is_promo'], inplace=True)
     spot_df.set_index(['InstanceType', 'Region', 'is_promo'], inplace=True)
 
     demand_df = demand_df.rename(columns={'unitPrice': 'Price'})
     spot_df = spot_df.rename(columns={'unitPrice': 'SpotPrice'})
 
     print('Getting sku df')
     df_sku['is_promo'] = df_sku['name'].str.endswith('_Promo')
     df_sku.rename(columns={'name': 'InstanceType'}, inplace=True)
+
     df_sku['merge_name'] = df_sku['InstanceType'].str.replace('_Promo', '')
+    df_sku['Region'] = df_sku['Region'].str.lower()
 
     print('Joining')
     df = df_sku.join(demand_df,
                      on=['merge_name', 'Region', 'is_promo'],
                      how='left')
     df = df.join(spot_df, on=['merge_name', 'Region', 'is_promo'], how='left')
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files 3% similar despite different names*

```diff
@@ -28,18 +28,14 @@
 # Service IDs found in https://cloud.google.com/skus
 GCE_SERVICE_ID = '6F81-5844-456A'
 TPU_SERVICE_ID = 'E000-3F24-B8AA'
 
 # The number of digits to round the price to.
 PRICE_ROUNDING = 5
 
-# Refer to: https://github.com/skypilot-org/skypilot/issues/1006
-# G2 series has L4 GPU, which is not supported by SkyPilot yet
-UNSUPPORTED_SERIES = ['f1', 'm2', 'g2']
-
 # This zone is only for TPU v4, and does not appear in the skus yet.
 TPU_V4_ZONES = ['us-central2-b']
 # TPU v3 pods are available in us-east1-d, but hidden in the skus.
 # We assume the TPU prices are the same as us-central1.
 HIDDEN_TPU_DF = pd.read_csv(
     io.StringIO(
         textwrap.dedent("""\
@@ -58,14 +54,17 @@
     io.StringIO(
         textwrap.dedent("""\
  InstanceType,AcceleratorName,AcceleratorCount,vCPUs,MemoryGiB,GpuInfo,Price,SpotPrice,Region,AvailabilityZone
  n1-highmem-8,,,8.0,52.0,,0.473212,0.099624,us-central2,us-central2-b
  """)))
 
 # TODO(woosuk): Make this more robust.
+# Refer to: https://github.com/skypilot-org/skypilot/issues/1006
+# G2 series has L4 GPU, which is not supported by SkyPilot yet
+# Unsupported Series: 'f1', 'm2', 'g2'
 SERIES_TO_DISCRIPTION = {
     'a2': 'A2 Instance',
     'c2': 'Compute optimized',
     'c2d': 'C2D AMD Instance',
     'c3': 'C3 Instance',
     'e2': 'E2 Instance',
     'f1': 'Micro Instance with burstable CPU',
@@ -79,14 +78,16 @@
     't2a': 'T2A Arm Instance',
     't2d': 'T2D AMD Instance',
 }
 creds, project_id = google.auth.default()
 gcp_client = discovery.build('compute', 'v1')
 tpu_client = discovery.build('tpu', 'v1')
 
+SINGLE_THREADED = False
+
 
 def get_skus(service_id: str) -> List[Dict[str, Any]]:
     # Get the SKUs from the GCP API.
     cb = discovery.build('cloudbilling', 'v1')
     service_name = f'services/{service_id}'
 
     skus = []
@@ -171,24 +172,28 @@
     } for machine_type in machine_types]
     return pd.DataFrame(machine_types).reset_index(drop=True)
 
 
 def _get_machine_types(region_prefix: str) -> pd.DataFrame:
     zones = _get_all_zones()
     zones = [zone for zone in zones if zone.startswith(region_prefix)]
-    with multiprocessing.Pool() as pool:
-        all_machine_dfs = pool.map(_get_machine_type_for_zone, zones)
+    if SINGLE_THREADED:
+        all_machine_dfs = [_get_machine_type_for_zone(zone) for zone in zones]
+    else:
+        with multiprocessing.Pool() as pool:
+            all_machine_dfs = pool.map(_get_machine_type_for_zone, zones)
     machine_df = pd.concat(all_machine_dfs, ignore_index=True)
     return machine_df
 
 
 def get_vm_df(skus: List[Dict[str, Any]], region_prefix: str) -> pd.DataFrame:
     df = _get_machine_types(region_prefix)
     # Drop the unsupported series.
-    df = df[~df['InstanceType'].str.startswith(tuple(UNSUPPORTED_SERIES))]
+    df = df[df['InstanceType'].str.startswith(
+        tuple(f'{series}-' for series in SERIES_TO_DISCRIPTION))]
     df = df[~df['AvailabilityZone'].str.startswith(tuple(TPU_V4_ZONES))]
 
     # TODO(woosuk): Make this more efficient.
     def get_vm_price(row: pd.Series, spot: bool) -> float:
         series = row['InstanceType'].split('-')[0].lower()
 
         ondemand_or_spot = 'OnDemand' if not spot else 'Preemptible'
@@ -281,16 +286,19 @@
             })
     return pd.DataFrame(new_gpus).reset_index(drop=True)
 
 
 def _get_gpus(region_prefix: str) -> pd.DataFrame:
     zones = _get_all_zones()
     zones = [zone for zone in zones if zone.startswith(region_prefix)]
-    with multiprocessing.Pool() as pool:
-        all_gpu_dfs = pool.map(_get_gpus_for_zone, zones)
+    if SINGLE_THREADED:
+        all_gpu_dfs = [_get_gpus_for_zone(zone) for zone in zones]
+    else:
+        with multiprocessing.Pool() as pool:
+            all_gpu_dfs = pool.map(_get_gpus_for_zone, zones)
     gpu_df = pd.concat(all_gpu_dfs, ignore_index=True)
     return gpu_df
 
 
 def get_gpu_df(skus: List[Dict[str, Any]], region_prefix: str) -> pd.DataFrame:
     gpu_skus = [
         sku for sku in skus if sku['category']['resourceGroup'] == 'GPU'
@@ -364,16 +372,19 @@
     return pd.DataFrame(new_tpus).reset_index(drop=True)
 
 
 def _get_tpus() -> pd.DataFrame:
     zones = _get_all_zones()
     # Add TPU-v4 zones.
     zones += TPU_V4_ZONES
-    with multiprocessing.Pool() as pool:
-        all_tpu_dfs = pool.map(_get_tpu_for_zone, zones)
+    if SINGLE_THREADED:
+        all_tpu_dfs = [_get_tpu_for_zone(zone) for zone in zones]
+    else:
+        with multiprocessing.Pool() as pool:
+            all_tpu_dfs = pool.map(_get_tpu_for_zone, zones)
     tpu_df = pd.concat(all_tpu_dfs, ignore_index=True)
     return tpu_df
 
 
 # TODO: the TPUs fetched fails to contain us-east1
 def get_tpu_df(skus: List[Dict[str, Any]]) -> pd.DataFrame:
     df = _get_tpus()
@@ -474,15 +485,23 @@
 
 if __name__ == '__main__':
     parser = argparse.ArgumentParser()
     parser.add_argument(
         '--all-regions',
         action='store_true',
         help='Fetch all global regions, not just the U.S. ones.')
+    parser.add_argument('--single-threaded',
+                        action='store_true',
+                        help='Run in single-threaded mode. This is useful when '
+                        'running in github action, as the multiprocessing '
+                        'does not work well with the gcp client due '
+                        'to ssl issues.')
     args = parser.parse_args()
 
+    SINGLE_THREADED = args.single_threaded
+
     region_prefix_filter = '' if args.all_regions else 'us-'
     catalog_df = get_catalog_df(region_prefix_filter)
 
     os.makedirs('gcp', exist_ok=True)
     catalog_df.to_csv('gcp/vms.csv', index=False)
     print('GCP Service Catalog saved to gcp/vms.csv')
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot-0.3.2/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot-0.3.2/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files 2% similar despite different names*

```diff
@@ -12,16 +12,24 @@
 from sky import exceptions
 from sky.clouds.service_catalog import common
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky.clouds import cloud
 
-_df = common.read_catalog('gcp/vms.csv')
-_image_df = common.read_catalog('gcp/images.csv')
+# Pull the latest catalog every week.
+# GCP guarantees that the catalog is updated at most once per 30 days, but
+# different VMs can be updated at different time. Thus, we pull the catalog
+# every 7 hours to make sure we have the latest information.
+_PULL_FREQUENCY_HOURS = 7
+
+_df = common.read_catalog('gcp/vms.csv',
+                          pull_frequency_hours=_PULL_FREQUENCY_HOURS)
+_image_df = common.read_catalog('gcp/images.csv',
+                                pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 _TPU_REGIONS = [
     'us-central1',
     'europe-west4',
     'asia-east1',
 ]
```

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot-0.3.2/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot-0.3.2/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/core.py` & `skypilot-0.3.2/sky/core.py`

 * *Files 1% similar despite different names*

```diff
@@ -10,14 +10,15 @@
 from sky import task
 from sky import backends
 from sky import data
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import spot
+from sky import status_lib
 from sky.backends import backend_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.usage import usage_lib
 from sky.utils import log_utils
 from sky.utils import tpu_utils
 from sky.utils import ux_utils
@@ -164,20 +165,20 @@
     force: bool = False,
 ) -> backends.CloudVmRayResourceHandle:
 
     cluster_status, handle = backend_utils.refresh_cluster_status_handle(
         cluster_name)
     if handle is None:
         raise ValueError(f'Cluster {cluster_name!r} does not exist.')
-    if not force and cluster_status == global_user_state.ClusterStatus.UP:
+    if not force and cluster_status == status_lib.ClusterStatus.UP:
         sky_logging.print(f'Cluster {cluster_name!r} is already up.')
         return handle
     assert force or cluster_status in (
-        global_user_state.ClusterStatus.INIT,
-        global_user_state.ClusterStatus.STOPPED), cluster_status
+        status_lib.ClusterStatus.INIT,
+        status_lib.ClusterStatus.STOPPED), cluster_status
 
     backend = backend_utils.get_backend_from_handle(handle)
     if not isinstance(backend, backends.CloudVmRayBackend):
         raise exceptions.NotSupportedError(
             f'Starting cluster {cluster_name!r} with backend {backend.NAME} '
             'is not supported.')
 
@@ -556,31 +557,36 @@
             'sky cancel requires either a job id '
             f'(see `sky queue {cluster_name} -s`) or the --all flag.')
 
     backend_utils.check_cluster_name_not_reserved(
         cluster_name, operation_str='Cancelling jobs')
 
     # Check the status of the cluster.
+    handle = None
     try:
         handle = backend_utils.check_cluster_available(
             cluster_name,
             operation='cancelling jobs',
         )
     except exceptions.ClusterNotUpError as e:
         if not _try_cancel_if_cluster_is_init:
             raise
         assert (e.handle is None or
                 isinstance(e.handle, backends.CloudVmRayResourceHandle)), e
         if (e.handle is None or e.handle.head_ip is None):
             raise
+        handle = e.handle
         # Even if the cluster is not UP, we can still try to cancel the job if
         # the head node is still alive. This is useful when a spot cluster's
         # worker node is preempted, but we can still cancel the job on the head
         # node.
 
+    assert handle is not None, (
+        f'handle for cluster {cluster_name!r} should not be None')
+
     backend = backend_utils.get_backend_from_handle(handle)
 
     if all:
         sky_logging.print(f'{colorama.Fore.YELLOW}'
                           f'Cancelling all jobs on cluster {cluster_name!r}...'
                           f'{colorama.Style.RESET_ALL}')
         job_ids = None
@@ -772,26 +778,25 @@
 
     stop_msg = ''
     if not refresh:
         stop_msg = 'To view the latest job table: sky spot queue --refresh'
     controller_status, handle = spot.is_spot_controller_up(stop_msg)
 
     if (refresh and controller_status in [
-            global_user_state.ClusterStatus.STOPPED,
-            global_user_state.ClusterStatus.INIT
+            status_lib.ClusterStatus.STOPPED, status_lib.ClusterStatus.INIT
     ]):
         sky_logging.print(f'{colorama.Fore.YELLOW}'
                           'Restarting controller for latest status...'
                           f'{colorama.Style.RESET_ALL}')
 
         log_utils.force_update_rich_status(
             '[cyan] Checking spot jobs - restarting '
             'controller[/]')
         handle = _start(spot.SPOT_CONTROLLER_NAME)
-        controller_status = global_user_state.ClusterStatus.UP
+        controller_status = status_lib.ClusterStatus.UP
         log_utils.force_update_rich_status('[cyan] Checking spot jobs[/]')
 
     if handle is None or handle.head_ip is None:
         # When the controller is STOPPED, the head_ip will be None, as
         # it will be set in global_user_state.remove_cluster().
         # We do not directly check for UP because the controller may be
         # in INIT state during another spot launch, but still have
@@ -817,15 +822,21 @@
                                            stderr,
                                            stream_logs=False)
     except exceptions.CommandError as e:
         raise RuntimeError(e.error_msg) from e
 
     jobs = spot.load_spot_job_queue(job_table_payload)
     if skip_finished:
-        jobs = list(filter(lambda job: not job['status'].is_terminal(), jobs))
+        # Filter out the finished jobs. If a multi-task job is partially
+        # finished, we will include all its tasks.
+        non_finished_tasks = list(
+            filter(lambda job: not job['status'].is_terminal(), jobs))
+        non_finished_job_ids = {job['job_id'] for job in non_finished_tasks}
+        jobs = list(
+            filter(lambda job: job['job_id'] in non_finished_job_ids, jobs))
     return jobs
 
 
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
 def spot_cancel(name: Optional[str] = None,
                 job_ids: Optional[List[int]] = None,
@@ -899,15 +910,15 @@
     """
     # TODO(zhwu): Automatically restart the spot controller
     controller_status, handle = spot.is_spot_controller_up(
         'Please restart the spot controller with '
         f'`sky start {spot.SPOT_CONTROLLER_NAME}`.')
     if handle is None or handle.head_ip is None:
         msg = 'All jobs finished.'
-        if controller_status == global_user_state.ClusterStatus.INIT:
+        if controller_status == status_lib.ClusterStatus.INIT:
             msg = ''
         with ux_utils.print_exception_no_traceback():
             raise exceptions.ClusterNotUpError(msg,
                                                cluster_status=controller_status)
 
     if name is not None and job_id is not None:
         raise ValueError('Cannot specify both name and job_id.')
```

### Comparing `skypilot-0.3.1/sky/dag.py` & `skypilot-0.3.2/sky/dag.py`

 * *Files 2% similar despite different names*

```diff
@@ -14,14 +14,15 @@
     """
 
     def __init__(self):
         self.tasks = []
         import networkx as nx  # pylint: disable=import-outside-toplevel
 
         self.graph = nx.DiGraph()
+        self.name = None
 
     def add(self, task):
         self.graph.add_node(task)
         self.tasks.append(task)
 
     def remove(self, task):
         self.tasks.remove(task)
```

### Comparing `skypilot-0.3.1/sky/data/data_transfer.py` & `skypilot-0.3.2/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/data/data_utils.py` & `skypilot-0.3.2/sky/data/data_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/data/mounting_utils.py` & `skypilot-0.3.2/sky/data/mounting_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/data/storage.py` & `skypilot-0.3.2/sky/data/storage.py`

 * *Files 1% similar despite different names*

```diff
@@ -19,25 +19,26 @@
 from sky.utils import schemas
 from sky.data import data_transfer
 from sky.data import data_utils
 from sky.data import mounting_utils
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
+from sky import status_lib
 from sky.utils import log_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     import boto3  # type: ignore
     from google.cloud import storage  # type: ignore
 
 logger = sky_logging.init_logger(__name__)
 
 StorageHandle = Any
-StorageStatus = global_user_state.StorageStatus
+StorageStatus = status_lib.StorageStatus
 Path = str
 SourceType = Union[Path, List[Path]]
 
 # Clouds with object storage implemented in this module. Azure Blob
 # Storage isn't supported yet (even though Azure is).
 # TODO(Doyoung): need to add clouds.CLOUDFLARE() to support
 # R2 to be an option as preferred store type
@@ -117,14 +118,17 @@
         return StoreType.GCS
     elif isinstance(cloud, clouds.Azure):
         with ux_utils.print_exception_no_traceback():
             raise ValueError('Azure Blob Storage is not supported yet.')
     elif isinstance(cloud, clouds.Lambda):
         with ux_utils.print_exception_no_traceback():
             raise ValueError('Lambda Cloud does not provide cloud storage.')
+    elif isinstance(cloud, clouds.SCP):
+        with ux_utils.print_exception_no_traceback():
+            raise ValueError('SCP does not provide cloud storage.')
     else:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'Unknown cloud type: {cloud}')
 
 
 def get_store_prefix(storetype: StoreType) -> str:
     if storetype == StoreType.S3:
@@ -1313,19 +1317,18 @@
                         'R2 Bucket should exist.')
         # Validate name
         self.name = self.validate_name(self.name)
         # Check if the storage is enabled
         if not _is_storage_cloud_enabled(str(clouds.GCP())):
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.ResourcesUnavailableError(
-                    'Storage \'store: gcs\' specified, but ' \
-                    'GCP access is disabled. To fix, enable '\
-                    'GCP by running `sky check`. '\
-                    'More info: https://skypilot.readthedocs.io/en/latest/getting-started/installation.html.' # pylint: disable=line-too-long
-                    )
+                    'Storage \'store: gcs\' specified, but '
+                    'GCP access is disabled. To fix, enable '
+                    'GCP by running `sky check`. '
+                    'More info: https://skypilot.readthedocs.io/en/latest/getting-started/installation.html.')  # pylint: disable=line-too-long
 
     @classmethod
     def validate_name(cls, name) -> str:
         """Validates the name of the GCS store.
 
         Source for rules: https://cloud.google.com/storage/docs/buckets#naming
         """
```

### Comparing `skypilot-0.3.1/sky/data/storage_utils.py` & `skypilot-0.3.2/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/exceptions.py` & `skypilot-0.3.2/sky/exceptions.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 """Exceptions."""
 import enum
 import typing
 from typing import List, Optional
 
 if typing.TYPE_CHECKING:
-    from sky import global_user_state
+    from sky import status_lib
     from sky.backends import backend
 
 # Return code for keyboard interruption and SIGTSTP
 KEYBOARD_INTERRUPT_CODE = 130
 SIGTSTP_CODE = 146
 RSYNC_FILE_NOT_FOUND_CODE = 23
 # Arbitrarily chosen value. Used in SkyPilot's storage mounting scripts
@@ -93,15 +93,15 @@
 
 
 class ClusterNotUpError(Exception):
     """Raised when a cluster is not up."""
 
     def __init__(self,
                  message: str,
-                 cluster_status: Optional['global_user_state.ClusterStatus'],
+                 cluster_status: Optional['status_lib.ClusterStatus'],
                  handle: Optional['backend.ResourceHandle'] = None) -> None:
         super().__init__(message)
         self.cluster_status = cluster_status
         self.handle = handle
 
 
 class ClusterSetUpError(Exception):
```

### Comparing `skypilot-0.3.1/sky/execution.py` & `skypilot-0.3.2/sky/execution.py`

 * *Files 7% similar despite different names*

```diff
@@ -35,14 +35,16 @@
 from sky.backends import backend_utils
 from sky.clouds import gcp
 from sky.data import data_utils
 from sky.data import storage as storage_lib
 from sky.usage import usage_lib
 from sky.skylet import constants
 from sky.utils import common_utils
+from sky.utils import dag_utils
+from sky.utils import log_utils
 from sky.utils import env_options, timeline
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 logger = sky_logging.init_logger(__name__)
 
 # Message thrown when APIs sky.{exec,launch,spot_launch}() received a string
@@ -80,34 +82,85 @@
         raise TypeError(_ENTRYPOINT_STRING_AS_DAG_MESSAGE)
     elif isinstance(entrypoint, sky.Dag):
         return copy.deepcopy(entrypoint)
     elif isinstance(entrypoint, task_lib.Task):
         entrypoint = copy.deepcopy(entrypoint)
         with sky.Dag() as dag:
             dag.add(entrypoint)
+            dag.name = entrypoint.name
         return dag
     else:
         raise TypeError(
             'Expected a sky.Task or sky.Dag but received argument of type: '
             f'{type(entrypoint)}')
 
 
 class Stage(enum.Enum):
     """Stages for a run of a sky.Task."""
     # TODO: rename actual methods to be consistent.
+    CLONE_DISK = enum.auto()
     OPTIMIZE = enum.auto()
     PROVISION = enum.auto()
     SYNC_WORKDIR = enum.auto()
     SYNC_FILE_MOUNTS = enum.auto()
     SETUP = enum.auto()
     PRE_EXEC = enum.auto()
     EXEC = enum.auto()
     DOWN = enum.auto()
 
 
+def _maybe_clone_disk_from_cluster(clone_disk_from: Optional[str],
+                                   cluster_name: Optional[str],
+                                   task: 'sky.Task') -> 'sky.Task':
+    if clone_disk_from is None:
+        return task
+    task, handle = backend_utils.check_can_clone_disk_and_override_task(
+        clone_disk_from, cluster_name, task)
+    original_cloud = handle.launched_resources.cloud
+    assert original_cloud is not None, handle.launched_resources
+    task_resources = list(task.resources)[0]
+
+    with log_utils.safe_rich_status('Creating image from source cluster '
+                                    f'{clone_disk_from!r}'):
+        image_id = original_cloud.create_image_from_cluster(
+            clone_disk_from,
+            backend_utils.tag_filter_for_cluster(clone_disk_from),
+            region=handle.launched_resources.region,
+            zone=handle.launched_resources.zone,
+        )
+        log_utils.force_update_rich_status(
+            f'Migrating image {image_id} to target region '
+            f'{task_resources.region}...')
+        source_region = handle.launched_resources.region
+        target_region = task_resources.region
+        assert source_region is not None, handle.launched_resources
+        assert target_region is not None, task_resources
+
+        image_id = original_cloud.maybe_move_image(
+            image_id,
+            source_region=source_region,
+            target_region=target_region,
+            source_zone=handle.launched_resources.zone,
+            target_zone=task_resources.zone,
+        )
+    logger.info(
+        f'{colorama.Fore.GREEN}'
+        f'Successfully created image {image_id!r} for {clone_disk_from!r} '
+        f'on {original_cloud}.{colorama.Style.RESET_ALL}\n'
+        'Overriding task\'s image_id.')
+    task_resources = task_resources.copy(image_id=image_id,
+                                         _is_image_managed=True)
+    task.set_resources(task_resources)
+    # Set the best_resources to None to trigger a re-optimization, so that
+    # the new task_resources is used.
+    task.best_resources = None
+    logger.debug(f'Overridden task resources: {task.resources}')
+    return task
+
+
 def _execute(
     entrypoint: Union['sky.Task', 'sky.Dag'],
     dryrun: bool = False,
     down: bool = False,
     stream_logs: bool = True,
     handle: Any = None,
     backend: Optional[backends.Backend] = None,
@@ -115,14 +168,15 @@
     optimize_target: optimizer.OptimizeTarget = optimizer.OptimizeTarget.COST,
     stages: Optional[List[Stage]] = None,
     cluster_name: Optional[str] = None,
     detach_setup: bool = False,
     detach_run: bool = False,
     idle_minutes_to_autostop: Optional[int] = None,
     no_setup: bool = False,
+    clone_disk_from: Optional[str] = None,
     # Internal only:
     # pylint: disable=invalid-name
     _is_launched_by_spot_controller: bool = False,
 ) -> None:
     """Execute an entrypoint.
 
     If sky.Task is given or DAG has not been optimized yet, this will call
@@ -222,14 +276,18 @@
     elif idle_minutes_to_autostop is not None:
         # TODO(zhwu): Autostop is not supported for non-CloudVmRayBackend.
         with ux_utils.print_exception_no_traceback():
             raise ValueError(
                 f'Backend {backend.NAME} does not support autostop, please try '
                 f'{backends.CloudVmRayBackend.NAME}')
 
+    if Stage.CLONE_DISK in stages:
+        task = _maybe_clone_disk_from_cluster(clone_disk_from, cluster_name,
+                                              task)
+
     if not cluster_exists:
         if (Stage.PROVISION in stages and task.use_spot and
                 not _is_launched_by_spot_controller):
             yellow = colorama.Fore.YELLOW
             bold = colorama.Style.BRIGHT
             reset = colorama.Style.RESET_ALL
             logger.info(
@@ -334,14 +392,15 @@
     down: bool = False,
     stream_logs: bool = True,
     backend: Optional[backends.Backend] = None,
     optimize_target: optimizer.OptimizeTarget = optimizer.OptimizeTarget.COST,
     detach_setup: bool = False,
     detach_run: bool = False,
     no_setup: bool = False,
+    clone_disk_from: Optional[str] = None,
     # Internal only:
     # pylint: disable=invalid-name
     _is_launched_by_spot_controller: bool = False,
 ) -> None:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Launch a task.
 
@@ -383,14 +442,17 @@
             will not interrupt the setup process. To see the logs again after
             detaching, use `sky logs`. To cancel setup, cancel the job via
             `sky cancel`. Useful for long-running setup
             commands.
         detach_run: If True, as soon as a job is submitted, return from this
             function and do not stream execution logs.
         no_setup: if True, do not re-run setup commands.
+        clone_disk_from: [Experimental] if set, clone the disk from the
+            specified cluster. This is useful to migrate the cluster to a
+            different availability zone or region.
 
     Example:
         .. code-block:: python
 
             import sky
             task = sky.Task(run='echo hello SkyPilot')
             task.set_resources(
@@ -417,28 +479,30 @@
         exceptions.CommandError: any ssh command error.
         exceptions.NoCloudAccessError: if all clouds are disabled.
     Other exceptions may be raised depending on the backend.
     """
     entrypoint = task
     backend_utils.check_cluster_name_not_reserved(cluster_name,
                                                   operation_str='sky.launch')
+
     _execute(
         entrypoint=entrypoint,
         dryrun=dryrun,
         down=down,
         stream_logs=stream_logs,
         handle=None,
         backend=backend,
         retry_until_up=retry_until_up,
         optimize_target=optimize_target,
         cluster_name=cluster_name,
         detach_setup=detach_setup,
         detach_run=detach_run,
         idle_minutes_to_autostop=idle_minutes_to_autostop,
         no_setup=no_setup,
+        clone_disk_from=clone_disk_from,
         _is_launched_by_spot_controller=_is_launched_by_spot_controller,
     )
 
 
 @usage_lib.entrypoint
 def exec(  # pylint: disable=redefined-builtin
     task: Union['sky.Task', 'sky.Dag'],
@@ -541,74 +605,71 @@
         detach_run: Whether to detach the run.
 
     Raises:
         ValueError: cluster does not exist.
         sky.exceptions.NotSupportedError: the feature is not supported.
     """
     entrypoint = task
-    task_uuid = str(uuid.uuid4().hex[:4])
+    dag_uuid = str(uuid.uuid4().hex[:4])
 
     dag = _convert_to_dag(entrypoint)
-    assert len(dag.tasks) == 1, ('Only one task is allowed in a spot launch.',
-                                 dag)
-    task = dag.tasks[0]
-    assert len(task.resources) == 1, task
-    resources = list(task.resources)[0]
+    assert dag.is_chain(), ('Only single-task or chain DAG is '
+                            'allowed for spot_launch.', dag)
 
-    change_default_value: Dict[str, Any] = {}
-    if not resources.use_spot_specified:
-        change_default_value['use_spot'] = True
-    if resources.spot_recovery is None:
-        change_default_value['spot_recovery'] = spot.SPOT_DEFAULT_STRATEGY
-
-    new_resources = resources.copy(**change_default_value)
-    task.set_resources({new_resources})
-
-    if task.run is None:
-        print(f'{colorama.Fore.GREEN}'
-              'Skipping the managed spot task as the run section is not set.'
-              f'{colorama.Style.RESET_ALL}')
-        return
+    dag_utils.maybe_infer_and_fill_dag_and_task_names(dag)
 
-    task = _maybe_translate_local_file_mounts_and_sync_up(task)
+    task_names = set()
+    for task_ in dag.tasks:
+        if task_.name in task_names:
+            raise ValueError(
+                f'Task name {task_.name!r} is duplicated in the DAG. Either '
+                'change task names to be unique, or specify the DAG name only '
+                'and comment out the task names (so that they will be auto-'
+                'generated) .')
+        task_names.add(task_.name)
+    for task_ in dag.tasks:
+        assert len(task_.resources) == 1, task_
+        resources = list(task_.resources)[0]
+
+        change_default_value: Dict[str, Any] = {}
+        if not resources.use_spot_specified:
+            change_default_value['use_spot'] = True
+        if resources.spot_recovery is None:
+            change_default_value['spot_recovery'] = spot.SPOT_DEFAULT_STRATEGY
 
-    if name is None:
-        if task.name is not None:
-            name = task.name
-        else:
-            name = backend_utils.generate_cluster_name()
-    # Override the task name with the specified name or generated name, so that
-    # the controller process can retrieve the task name from the task config.
-    task.name = name
+        new_resources = resources.copy(**change_default_value)
+        task_.set_resources({new_resources})
 
-    with tempfile.NamedTemporaryFile(prefix=f'spot-task-{name}-',
-                                     mode='w') as f:
-        task_config = task.to_yaml_config()
-        common_utils.dump_yaml(f.name, task_config)
+        _maybe_translate_local_file_mounts_and_sync_up(task_)
 
+    with tempfile.NamedTemporaryFile(prefix=f'spot-dag-{dag.name}-',
+                                     mode='w') as f:
+        dag_utils.dump_chain_dag_to_yaml(dag, f.name)
         controller_name = spot.SPOT_CONTROLLER_NAME
         vars_to_fill = {
             'remote_user_yaml_prefix': spot.SPOT_TASK_YAML_PREFIX,
             'user_yaml_path': f.name,
             'user_config_path': None,
             'spot_controller': controller_name,
-            # Note: actual spot cluster name will be <task_name>-<spot job ID>
-            'task_name': name,
-            'uuid': task_uuid,
+            # Note: actual spot cluster name will be <task.name>-<spot job ID>
+            'dag_name': dag.name,
+            'uuid': dag_uuid,
             'google_sdk_installation_commands':
                 gcp.GOOGLE_SDK_INSTALLATION_COMMAND,
             'is_dev': env_options.Options.IS_DEVELOPER.get(),
             'is_debug': env_options.Options.SHOW_DEBUG_INFO.get(),
             'disable_logging': env_options.Options.DISABLE_LOGGING.get(),
             'logging_user_hash': common_utils.get_user_hash(),
             'retry_until_up': retry_until_up,
             # Should not use $USER here, as that env var can be empty when
             # running in a container.
             'user': getpass.getuser(),
         }
+        controller_resources_config = copy.copy(
+            spot.constants.CONTROLLER_RESOURCES)
         if skypilot_config.loaded():
             # Look up the contents of the already loaded configs via the
             # 'skypilot_config' module. Don't simply read the on-disk file as
             # it may have changed since this process started.
             #
             # Set any proxy command to None, because the controller would've
             # been launched behind the proxy, and in general any nodes we
@@ -655,53 +716,80 @@
                 common_utils.dump_yaml(tmpfile.name, config_dict)
                 vars_to_fill.update({
                     'user_config_path': tmpfile.name,
                     'env_var_skypilot_config':
                         skypilot_config.ENV_VAR_SKYPILOT_CONFIG,
                 })
 
+            # Override the controller resources with the ones specified in the
+            # config.
+            custom_controller_resources_config = skypilot_config.get_nested(
+                ('spot', 'controller', 'resources'), None)
+            if custom_controller_resources_config is not None:
+                controller_resources_config.update(
+                    custom_controller_resources_config)
+        try:
+            controller_resources = sky.Resources.from_yaml_config(
+                controller_resources_config)
+        except ValueError as e:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Spot controller resources is not valid, please check '
+                    '~/.sky/config.yaml file and make sure '
+                    'spot.controller.resources is a valid resources spec. '
+                    'Details:\n'
+                    f'  {common_utils.format_exception(e, use_bracket=True)}'
+                ) from e
+
         yaml_path = os.path.join(spot.SPOT_CONTROLLER_YAML_PREFIX,
-                                 f'{name}-{task_uuid}.yaml')
+                                 f'{name}-{dag_uuid}.yaml')
         backend_utils.fill_template(spot.SPOT_CONTROLLER_TEMPLATE,
                                     vars_to_fill,
                                     output_path=yaml_path)
         controller_task = task_lib.Task.from_yaml(yaml_path)
-        controller_task.spot_task = task
+        assert len(controller_task.resources) == 1, controller_task
+        # Backward compatibility: if the user changed the
+        # spot-controller.yaml.j2 to customize the controller resources,
+        # we should use it.
+        controller_task_resources = list(controller_task.resources)[0]
+        if not controller_task_resources.is_empty():
+            controller_resources = controller_task_resources
+        controller_task.set_resources(controller_resources)
+
+        controller_task.spot_dag = dag
         assert len(controller_task.resources) == 1
 
         print(f'{colorama.Fore.YELLOW}'
-              f'Launching managed spot job {name} from spot controller...'
+              f'Launching managed spot job {dag.name} from spot controller...'
               f'{colorama.Style.RESET_ALL}')
         print('Launching spot controller...')
         _execute(
             entrypoint=controller_task,
             stream_logs=stream_logs,
             cluster_name=controller_name,
             detach_run=detach_run,
             idle_minutes_to_autostop=spot.
             SPOT_CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP,
             retry_until_up=True,
         )
 
 
-def _maybe_translate_local_file_mounts_and_sync_up(
-        task: task_lib.Task) -> task_lib.Task:
+def _maybe_translate_local_file_mounts_and_sync_up(task: task_lib.Task):
     """Translates local->VM mounts into Storage->VM, then syncs up any Storage.
 
     Eagerly syncing up local->Storage ensures Storage->VM would work at task
     launch time.
 
     If there are no local source paths to be translated, this function would
     still sync up any storage mounts with local source paths (which do not
     undergo translation).
     """
     # ================================================================
     # Translate the workdir and local file mounts to cloud file mounts.
     # ================================================================
-    task = copy.deepcopy(task)
     run_id = common_utils.get_usage_run_id()[:8]
     original_file_mounts = task.file_mounts if task.file_mounts else {}
     original_storage_mounts = task.storage_mounts if task.storage_mounts else {}
 
     copy_mounts = task.get_local_to_remote_file_mounts()
     if copy_mounts is None:
         copy_mounts = {}
@@ -849,9 +937,7 @@
             elif store_type == storage_lib.StoreType.R2:
                 storage_obj.source = f'r2://{storage_obj.name}'
             else:
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.NotSupportedError(
                         f'Unsupported store type: {store_type}')
             storage_obj.force_delete = True
-
-    return task
```

### Comparing `skypilot-0.3.1/sky/global_user_state.py` & `skypilot-0.3.2/sky/global_user_state.py`

 * *Files 3% similar despite different names*

```diff
@@ -2,27 +2,25 @@
 
 Concepts:
 - Cluster name: a user-supplied or auto-generated unique name to identify a
   cluster.
 - Cluster handle: (non-user facing) an opaque backend handle for us to
   interact with a cluster.
 """
-import enum
 import json
 import os
 import pathlib
 import pickle
 import sqlite3
 import time
 import typing
 from typing import Any, Dict, List, Tuple, Optional, Set
 import uuid
 
-import colorama
-
+from sky import status_lib
 from sky import clouds
 from sky.adaptors import cloudflare
 from sky.data import storage as storage_lib
 from sky.utils import common_utils
 from sky.utils import db_utils
 
 if typing.TYPE_CHECKING:
@@ -114,60 +112,14 @@
 
     conn.commit()
 
 
 _DB = db_utils.SQLiteConn(_DB_PATH, create_table)
 
 
-class ClusterStatus(enum.Enum):
-    """Cluster status as recorded in table 'clusters'."""
-    # NOTE: these statuses are as recorded in our local cache, the table
-    # 'clusters'.  The actual cluster state may be different (e.g., an UP
-    # cluster getting killed manually by the user or the cloud provider).
-
-    # Initializing.  This means a backend.provision() call has started but has
-    # not successfully finished. The cluster may be undergoing setup, may have
-    # failed setup, may be live or down.
-    INIT = 'INIT'
-
-    # The cluster is recorded as up.  This means a backend.provision() has
-    # previously succeeded.
-    UP = 'UP'
-
-    # Stopped.  This means a `sky stop` call has previously succeeded.
-    STOPPED = 'STOPPED'
-
-    def colored_str(self):
-        color = _STATUS_TO_COLOR[self]
-        return f'{color}{self.value}{colorama.Style.RESET_ALL}'
-
-
-_STATUS_TO_COLOR = {
-    ClusterStatus.INIT: colorama.Fore.BLUE,
-    ClusterStatus.UP: colorama.Fore.GREEN,
-    ClusterStatus.STOPPED: colorama.Fore.YELLOW,
-}
-
-
-class StorageStatus(enum.Enum):
-    """Storage status as recorded in table 'storage'."""
-
-    # Initializing and uploading storage
-    INIT = 'INIT'
-
-    # Initialization failed
-    INIT_FAILED = 'INIT_FAILED'
-
-    # Failed to Upload to Cloud
-    UPLOAD_FAILED = 'UPLOAD_FAILED'
-
-    # Finished uploading, in terminal state
-    READY = 'READY'
-
-
 def add_or_update_cluster(cluster_name: str,
                           cluster_handle: 'backends.ResourceHandle',
                           requested_resources: Optional[Set[Any]],
                           ready: bool,
                           is_launch: bool = True):
     """Adds or updates cluster_name -> cluster_handle mapping.
 
@@ -180,15 +132,17 @@
         is_launch: if the cluster is firstly launched. If True, the launched_at
             and last_use will be updated. Otherwise, use the old value.
     """
     # FIXME: launched_at will be changed when `sky launch -c` is called.
     handle = pickle.dumps(cluster_handle)
     cluster_launched_at = int(time.time()) if is_launch else None
     last_use = common_utils.get_pretty_entry_point() if is_launch else None
-    status = ClusterStatus.UP if ready else ClusterStatus.INIT
+    status = status_lib.ClusterStatus.INIT
+    if ready:
+        status = status_lib.ClusterStatus.UP
 
     # TODO (sumanth): Cluster history table will have multiple entries
     # when the cluster failover through multiple regions (one entry per region).
     # It can be more inaccurate for the multi-node cluster
     # as the failover can have the nodes partially UP.
     cluster_hash = _get_hash_for_existing_cluster(cluster_name) or str(
         uuid.uuid4())
@@ -260,18 +214,18 @@
             # last_use
             last_use,
             cluster_name,
             # status
             status.value,
             # autostop
             cluster_name,
-            ClusterStatus.STOPPED.value,
+            status_lib.ClusterStatus.STOPPED.value,
             # to_down
             cluster_name,
-            ClusterStatus.STOPPED.value,
+            status_lib.ClusterStatus.STOPPED.value,
             # metadata
             cluster_name,
             # owner
             cluster_name,
             # cluster_hash
             cluster_hash,
         ))
@@ -344,15 +298,15 @@
         # on a stopped cpunode will directly try to ssh, which leads to timeout.
         if hasattr(handle, 'stable_internal_external_ips'):
             handle.stable_internal_external_ips = None
         _DB.cursor.execute(
             'UPDATE clusters SET handle=(?), status=(?) '
             'WHERE name=(?)', (
                 pickle.dumps(handle),
-                ClusterStatus.STOPPED.value,
+                status_lib.ClusterStatus.STOPPED.value,
                 cluster_name,
             ))
     _DB.conn.commit()
 
 
 def get_handle_from_cluster_name(
         cluster_name: str) -> Optional['backends.ResourceHandle']:
@@ -367,15 +321,16 @@
 def get_glob_cluster_names(cluster_name: str) -> List[str]:
     assert cluster_name is not None, 'cluster_name cannot be None'
     rows = _DB.cursor.execute('SELECT name FROM clusters WHERE name GLOB (?)',
                               (cluster_name,))
     return [row[0] for row in rows]
 
 
-def set_cluster_status(cluster_name: str, status: ClusterStatus) -> None:
+def set_cluster_status(cluster_name: str,
+                       status: status_lib.ClusterStatus) -> None:
     _DB.cursor.execute('UPDATE clusters SET status=(?) WHERE name=(?)', (
         status.value,
         cluster_name,
     ))
     count = _DB.cursor.rowcount
     _DB.conn.commit()
     assert count <= 1, count
@@ -558,15 +513,15 @@
          to_down, owner, cluster_hash) = row[:10]
         # TODO: use namedtuple instead of dict
         record = {
             'name': name,
             'launched_at': launched_at,
             'handle': pickle.loads(handle),
             'last_use': last_use,
-            'status': ClusterStatus[status],
+            'status': status_lib.ClusterStatus[status],
             'autostop': autostop,
             'to_down': bool(to_down),
             'owner': _load_owner(owner),
             'metadata': json.loads(metadata),
             'cluster_hash': cluster_hash,
         }
         return record
@@ -583,15 +538,15 @@
         # TODO: use namedtuple instead of dict
 
         record = {
             'name': name,
             'launched_at': launched_at,
             'handle': pickle.loads(handle),
             'last_use': last_use,
-            'status': ClusterStatus[status],
+            'status': status_lib.ClusterStatus[status],
             'autostop': autostop,
             'to_down': bool(to_down),
             'owner': _load_owner(owner),
             'metadata': json.loads(metadata),
             'cluster_hash': cluster_hash,
         }
 
@@ -620,15 +575,15 @@
             num_nodes,
             launched_resources,
             usage_intervals,
             status,
         ) = row[:6]
 
         if status is not None:
-            status = ClusterStatus[status]
+            status = status_lib.ClusterStatus[status]
 
         record = {
             'name': name,
             'launched_at': _get_cluster_launch_time(cluster_hash),
             'duration': _get_cluster_duration(cluster_hash),
             'num_nodes': num_nodes,
             'resources': pickle.loads(launched_resources),
@@ -685,21 +640,21 @@
     _DB.cursor.execute('INSERT OR REPLACE INTO config VALUES (?, ?)',
                        (_ENABLED_CLOUDS_KEY, json.dumps(enabled_clouds)))
     _DB.conn.commit()
 
 
 def add_or_update_storage(storage_name: str,
                           storage_handle: 'Storage.StorageMetadata',
-                          storage_status: StorageStatus):
+                          storage_status: status_lib.StorageStatus):
     storage_launched_at = int(time.time())
     handle = pickle.dumps(storage_handle)
     last_use = common_utils.get_pretty_entry_point()
 
     def status_check(status):
-        return status in StorageStatus
+        return status in status_lib.StorageStatus
 
     if not status_check(storage_status):
         raise ValueError(f'Error in updating global state. Storage Status '
                          f'{storage_status} is passed in incorrectly')
     _DB.cursor.execute('INSERT OR REPLACE INTO storage VALUES (?, ?, ?, ?, ?)',
                        (storage_name, storage_launched_at, handle, last_use,
                         storage_status.value))
@@ -708,32 +663,33 @@
 
 def remove_storage(storage_name: str):
     """Removes Storage from Database"""
     _DB.cursor.execute('DELETE FROM storage WHERE name=(?)', (storage_name,))
     _DB.conn.commit()
 
 
-def set_storage_status(storage_name: str, status: StorageStatus) -> None:
+def set_storage_status(storage_name: str,
+                       status: status_lib.StorageStatus) -> None:
     _DB.cursor.execute('UPDATE storage SET status=(?) WHERE name=(?)', (
         status.value,
         storage_name,
     ))
     count = _DB.cursor.rowcount
     _DB.conn.commit()
     assert count <= 1, count
     if count == 0:
         raise ValueError(f'Storage {storage_name} not found.')
 
 
-def get_storage_status(storage_name: str) -> Optional[StorageStatus]:
+def get_storage_status(storage_name: str) -> Optional[status_lib.StorageStatus]:
     assert storage_name is not None, 'storage_name cannot be None'
     rows = _DB.cursor.execute('SELECT status FROM storage WHERE name=(?)',
                               (storage_name,))
     for (status,) in rows:
-        return StorageStatus[status]
+        return status_lib.StorageStatus[status]
     return None
 
 
 def set_storage_handle(storage_name: str,
                        handle: 'Storage.StorageMetadata') -> None:
     _DB.cursor.execute('UPDATE storage SET handle=(?) WHERE name=(?)', (
         pickle.dumps(handle),
@@ -778,10 +734,10 @@
     for name, launched_at, handle, last_use, status in rows:
         # TODO: use namedtuple instead of dict
         records.append({
             'name': name,
             'launched_at': launched_at,
             'handle': pickle.loads(handle),
             'last_use': last_use,
-            'status': StorageStatus[status],
+            'status': status_lib.StorageStatus[status],
         })
     return records
```

### Comparing `skypilot-0.3.1/sky/optimizer.py` & `skypilot-0.3.2/sky/optimizer.py`

 * *Files 2% similar despite different names*

```diff
@@ -965,14 +965,21 @@
             # the above check_accelerator_attachable_to_host() call.
             # If the user has not specified any zone, a launchable will be made
             # for every zone even if some of the zones do not support the
             # host-accelerator combination. Then the provisioner may try to
             # launch the instance, and fail over to other zones. We find this
             # behavior acceptable because this will happen only when the user
             # requested GCP 4:P100 or 8:K80 with a very large host VM.
+            elif isinstance(resources.cloud, clouds.SCP):
+                # Check if the host VM satisfies the min/max disk size limits.
+                is_allowed, launchable[resources] = \
+                    clouds.SCP.is_disk_size_allowed(resources)
+                if not is_allowed:
+                    continue
+
             launchable[resources] = _make_launchables_for_valid_region_zones(
                 resources)
         else:
             clouds_list = ([resources.cloud]
                            if resources.cloud is not None else enabled_clouds)
             # Hack: When >=2 cloud candidates, always remove local cloud from
             # possible candidates. This is so the optimizer will consider
```

### Comparing `skypilot-0.3.1/sky/resources.py` & `skypilot-0.3.2/sky/resources.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,11 +1,13 @@
 """Resources: compute requirements of Tasks."""
 from typing import Dict, List, Optional, Union
 from typing_extensions import Literal
 
+import colorama
+
 from sky import clouds
 from sky import global_user_state
 from sky import sky_logging
 from sky import spot
 from sky.backends import backend_utils
 from sky.utils import accelerator_registry
 from sky.utils import schemas
@@ -15,71 +17,122 @@
 
 logger = sky_logging.init_logger(__name__)
 
 _DEFAULT_DISK_SIZE_GB = 256
 
 
 class Resources:
-    """A cloud resource bundle.
+    """Resources: compute requirements of Tasks.
+
+    Used:
 
-    Used
-      * for representing resource requests for tasks/apps
-      * as a "filter" to get concrete launchable instances
-      * for calculating billing
-      * for provisioning on a cloud
-
-    Examples:
-
-        # Fully specified cloud and instance type (is_launchable() is True).
-        sky.Resources(clouds.AWS(), 'p3.2xlarge')
-        sky.Resources(clouds.GCP(), 'n1-standard-16')
-        sky.Resources(clouds.GCP(), 'n1-standard-8', 'V100')
-
-        # Specifying required resources; the system decides the cloud/instance
-        # type. The below are equivalent:
-        sky.Resources(accelerators='V100')
-        sky.Resources(accelerators='V100:1')
-        sky.Resources(accelerators={'V100': 1})
+    * for representing resource requests for tasks/apps
+    * as a "filter" to get concrete launchable instances
+    * for calculating billing
+    * for provisioning on a cloud
 
-        # TODO:
-        sky.Resources(requests={'mem': '16g', 'cpu': 8})
     """
     # If any fields changed, increment the version. For backward compatibility,
     # modify the __setstate__ method to handle the old version.
-    _VERSION = 9
+    _VERSION = 10
 
     def __init__(
         self,
         cloud: Optional[clouds.Cloud] = None,
         instance_type: Optional[str] = None,
         cpus: Union[None, int, float, str] = None,
         memory: Union[None, int, float, str] = None,
         accelerators: Union[None, str, Dict[str, int]] = None,
         accelerator_args: Optional[Dict[str, str]] = None,
         use_spot: Optional[bool] = None,
         spot_recovery: Optional[str] = None,
-        disk_size: Optional[int] = None,
         region: Optional[str] = None,
         zone: Optional[str] = None,
         image_id: Union[Dict[str, str], str, None] = None,
+        disk_size: Optional[int] = None,
         disk_tier: Optional[Literal['high', 'medium', 'low']] = None,
+        # Internal use only.
+        _is_image_managed: Optional[bool] = None,
     ):
+        """Initialize a Resources object.
+
+        All fields are optional.  ``Resources.is_launchable`` decides whether
+        the Resources is fully specified to launch an instance.
+
+        Examples:
+          .. code-block:: python
+
+            # Fully specified cloud and instance type (is_launchable() is True).
+            sky.Resources(clouds.AWS(), 'p3.2xlarge')
+            sky.Resources(clouds.GCP(), 'n1-standard-16')
+            sky.Resources(clouds.GCP(), 'n1-standard-8', 'V100')
+
+            # Specifying required resources; the system decides the
+            # cloud/instance type. The below are equivalent:
+            sky.Resources(accelerators='V100')
+            sky.Resources(accelerators='V100:1')
+            sky.Resources(accelerators={'V100': 1})
+            sky.Resources(cpus='2+', memory='16+', accelerators='V100')
+
+        Args:
+          cloud: the cloud to use.
+          instance_type: the instance type to use.
+          cpus: the number of CPUs required for the task.
+            If a str, must be a string of the form ``'2'`` or ``'2+'``, where
+            the ``+`` indicates that the task requires at least 2 CPUs.
+          memory: the amount of memory in GiB required. If a
+            str, must be a string of the form ``'16'`` or ``'16+'``, where
+            the ``+`` indicates that the task requires at least 16 GB of memory.
+          accelerators: the accelerators required. If a str, must be
+            a string of the form ``'V100'`` or ``'V100:2'``, where the ``:2``
+            indicates that the task requires 2 V100 GPUs. If a dict, must be a
+            dict of the form ``{'V100': 2}`` or ``{'tpu-v2-8': 1}``.
+          accelerator_args: accelerator-specific arguments. For example,
+            ``{'tpu_vm': True, 'runtime_version': 'tpu-vm-base'}`` for TPUs.
+          use_spot: whether to use spot instances. If None, defaults to
+            False.
+          spot_recovery: the spot recovery strategy to use for the managed
+            spot to recover the cluster from preemption. Refer to
+            `recovery_strategy module <https://github.com/skypilot-org/skypilot/blob/master/sky/spot/recovery_strategy.py>`__ # pylint: disable=line-too-long
+            for more details.
+          region: the region to use.
+          zone: the zone to use.
+          image_id: the image ID to use. If a str, must be a string
+            of the image id from the cloud, such as AWS:
+            ``'ami-1234567890abcdef0'``, GCP:
+            ``'projects/my-project-id/global/images/my-image-name'``;
+            Or, a image tag provided by SkyPilot, such as AWS:
+            ``'skypilot:gpu-ubuntu-2004'``. If a dict, must be a dict mapping
+            from region to image ID, such as:
+
+            .. code-block:: python
+
+              {
+                'us-west1': 'ami-1234567890abcdef0',
+                'us-east1': 'ami-1234567890abcdef0'
+              }
+
+          disk_size: the size of the OS disk in GiB.
+          disk_tier: the disk performance tier to use. If None, defaults to
+            ``'medium'``.
+        """
         self._version = self._VERSION
         self._cloud = cloud
         self._region: Optional[str] = None
         self._zone: Optional[str] = None
         self._set_region_zone(region, zone)
 
         self._instance_type = instance_type
 
         self._use_spot_specified = use_spot is not None
         self._use_spot = use_spot if use_spot is not None else False
         self._spot_recovery = None
         if spot_recovery is not None:
-            self._spot_recovery = spot_recovery.upper()
+            if spot_recovery.strip().lower() != 'none':
+                self._spot_recovery = spot_recovery.upper()
 
         if disk_size is not None:
             if round(disk_size) != disk_size:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'OS disk size must be an integer. Got: {disk_size}.')
             self._disk_size = int(disk_size)
@@ -94,14 +147,15 @@
         elif isinstance(image_id, dict):
             if None in image_id:
                 self._image_id = {self._region: image_id[None].strip()}
             else:
                 self._image_id = {
                     k.strip(): v.strip() for k, v in image_id.items()
                 }
+        self._is_image_managed = _is_image_managed
 
         self._disk_tier = disk_tier
 
         self._set_cpus(cpus)
         self._set_memory(memory)
         self._set_accelerators(accelerators, accelerator_args)
 
@@ -279,14 +333,18 @@
     def image_id(self) -> Optional[Dict[str, str]]:
         return self._image_id
 
     @property
     def disk_tier(self) -> str:
         return self._disk_tier
 
+    @property
+    def is_image_managed(self) -> Optional[bool]:
+        return self._is_image_managed
+
     def _set_cpus(
         self,
         cpus: Union[None, int, float, str],
     ) -> None:
         if cpus is None:
             self._cpus = None
             return
@@ -469,14 +527,26 @@
         filtered_regions = []
         for region in regions:
             region_name = region.name
             if region_name not in ssh_proxy_command_config:
                 continue
             # TODO: filter out the zones not available in the vpc_name
             filtered_regions.append(region)
+
+        # Friendlier UX. Otherwise users only get a generic
+        # ResourcesUnavailableError message without mentioning
+        # ssh_proxy_command.
+        if not filtered_regions:
+            yellow = colorama.Fore.YELLOW
+            reset = colorama.Style.RESET_ALL
+            logger.warning(
+                f'{yellow}Request {self} cannot be satisfied by any feasible '
+                'region. To fix, check that ssh_proxy_command\'s region keys '
+                f'include the regions to use.{reset}')
+
         return filtered_regions
 
     def _try_validate_instance_type(self) -> None:
         if self.instance_type is None:
             return
 
         # Validate instance type
@@ -643,21 +713,23 @@
             return
 
         if self.cloud is None:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
                     'Cloud must be specified when image_id is provided.')
 
+        # Apr, 2023 by Hysun(hysun.he@oracle.com): Added support for OCI
         if not self._cloud.is_same_cloud(
-                clouds.IBM()) and not self._cloud.is_same_cloud(
-                    clouds.AWS()) and not self._cloud.is_same_cloud(
-                        clouds.GCP()):
+                clouds.AWS()) and not self._cloud.is_same_cloud(
+                    clouds.GCP()) and not self._cloud.is_same_cloud(
+                        clouds.IBM()) and not self._cloud.is_same_cloud(
+                            clouds.OCI()):
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
-                    'image_id is only supported for AWS, GCP and IBM, please '
+                    'image_id is only supported for AWS/GCP/IBM/OCI, please '
                     'explicitly specify the cloud.')
 
         if self._region is not None:
             if self._region not in self._image_id:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'image_id {self._image_id} should contain the image '
@@ -825,14 +897,16 @@
             self.cloud is None,
             self._instance_type is None,
             self.cpus is None,
             self.memory is None,
             self.accelerators is None,
             self.accelerator_args is None,
             not self._use_spot_specified,
+            self.disk_size == _DEFAULT_DISK_SIZE_GB,
+            self._image_id is None,
         ])
 
     def copy(self, **override) -> 'Resources':
         """Returns a copy of the given Resources."""
         use_spot = self.use_spot if self._use_spot_specified else None
         resources = Resources(
             cloud=override.pop('cloud', self.cloud),
@@ -845,14 +919,16 @@
             use_spot=override.pop('use_spot', use_spot),
             spot_recovery=override.pop('spot_recovery', self.spot_recovery),
             disk_size=override.pop('disk_size', self.disk_size),
             region=override.pop('region', self.region),
             zone=override.pop('zone', self.zone),
             image_id=override.pop('image_id', self.image_id),
             disk_tier=override.pop('disk_tier', self.disk_tier),
+            _is_image_managed=override.pop('_is_image_managed',
+                                           self._is_image_managed),
         )
         assert len(override) == 0
         return resources
 
     def valid_on_region_zones(self, region: str, zones: List[str]) -> bool:
         """Returns whether this Resources is valid on given region and zones"""
         if self.region is not None and self.region != region:
@@ -894,19 +970,20 @@
         if config.get('disk_size') is not None:
             resources_fields['disk_size'] = int(config.pop('disk_size'))
         if config.get('region') is not None:
             resources_fields['region'] = config.pop('region')
         if config.get('zone') is not None:
             resources_fields['zone'] = config.pop('zone')
         if config.get('image_id') is not None:
-            logger.warning('image_id in resources is experimental. It only '
-                           'supports AWS/GCP/IBM.')
             resources_fields['image_id'] = config.pop('image_id')
         if config.get('disk_tier') is not None:
             resources_fields['disk_tier'] = config.pop('disk_tier')
+        if config.get('_is_image_managed') is not None:
+            resources_fields['_is_image_managed'] = config.pop(
+                '_is_image_managed')
 
         assert not config, f'Invalid resource args: {config.keys()}'
         return Resources(**resources_fields)
 
     def to_yaml_config(self) -> Dict[str, Union[str, int]]:
         """Returns a yaml-style dict of config for this resource bundle."""
         config = {}
@@ -926,14 +1003,16 @@
             add_if_not_none('use_spot', self.use_spot)
         config['spot_recovery'] = self.spot_recovery
         config['disk_size'] = self.disk_size
         add_if_not_none('region', self.region)
         add_if_not_none('zone', self.zone)
         add_if_not_none('image_id', self.image_id)
         add_if_not_none('disk_tier', self.disk_tier)
+        if self._is_image_managed is not None:
+            config['_is_image_managed'] = self._is_image_managed
         return config
 
     def __setstate__(self, state):
         """Set state from pickled state, for backward compatibility."""
         self._version = self._VERSION
 
         # TODO (zhwu): Design our persistent state format with `__getstate__`,
@@ -988,8 +1067,11 @@
         image_id = state.get('_image_id', None)
         if isinstance(image_id, str):
             state['_image_id'] = {state.get('_region', None): image_id}
 
         if version < 9:
             self._disk_tier = None
 
+        if version < 10:
+            self._is_image_managed = None
+
         self.__dict__.update(state)
```

### Comparing `skypilot-0.3.1/sky/setup_files/setup.py` & `skypilot-0.3.2/sky/setup_files/setup.py`

 * *Files 5% similar despite different names*

```diff
@@ -91,33 +91,40 @@
     'ray[default]>=2.2.0,<=2.4.0',
     'rich',
     'tabulate',
     # Light weight requirement, can be replaced with "typing" once
     # we deprecate Python 3.7 (this will take a while).
     "typing_extensions; python_version < '3.8'",
     'filelock>=3.6.0',
-    # Adopted from ray's setup.py:
+    # Adopted from ray's setup.py: https://github.com/ray-project/ray/blob/ray-2.4.0/python/setup.py
+    # SkyPilot: != 1.48.0 is required to avoid the error where ray dashboard fails to start when
+    # ray start is called (#2054).
     # Tracking issue: https://github.com/ray-project/ray/issues/30984
-    "grpcio >= 1.32.0, <= 1.49.1; python_version < '3.10' and sys_platform == 'darwin'",  # noqa:E501
-    "grpcio >= 1.42.0, <= 1.49.1; python_version >= '3.10' and sys_platform == 'darwin'",  # noqa:E501
+    "grpcio >= 1.32.0, <= 1.49.1, != 1.48.0; python_version < '3.10' and sys_platform == 'darwin'",  # noqa:E501
+    "grpcio >= 1.42.0, <= 1.49.1, != 1.48.0; python_version >= '3.10' and sys_platform == 'darwin'",  # noqa:E501
     # Original issue: https://github.com/ray-project/ray/issues/33833
-    "grpcio >= 1.32.0, <= 1.51.3; python_version < '3.10' and sys_platform != 'darwin'",  # noqa:E501
-    "grpcio >= 1.42.0, <= 1.51.3; python_version >= '3.10' and sys_platform != 'darwin'",  # noqa:E501
+    "grpcio >= 1.32.0, <= 1.51.3, != 1.48.0; python_version < '3.10' and sys_platform != 'darwin'",  # noqa:E501
+    "grpcio >= 1.42.0, <= 1.51.3, != 1.48.0; python_version >= '3.10' and sys_platform != 'darwin'",  # noqa:E501
     'packaging',
     # Adopted from ray's setup.py:
     # https://github.com/ray-project/ray/blob/86fab1764e618215d8131e8e5068f0d493c77023/python/setup.py#L326
     'protobuf >= 3.15.3, != 3.19.5',
     'psutil',
     'pulp',
+    # Ray job has an issue with pydantic>2.0.0, due to API changes of pydantic. See
+    # https://github.com/ray-project/ray/issues/36990
+    'pydantic<2.0'
 ]
 
-# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the following
-# packages dependencies are changed.
+# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the
+# following packages dependencies are changed.
 aws_dependencies = [
-    # awscli>=1.27.10 is required for SSO support.
+    # NOTE: this installs CLI V1. To use AWS SSO (e.g., `aws sso login`), users
+    # should instead use CLI V2 which is not pip-installable. See
+    # https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html.
     'awscli',
     'boto3',
     # 'Crypto' module used in authentication.py for AWS.
     'pycryptodome==3.12.0',
 ]
 extras_require: Dict[str, List[str]] = {
     'aws': aws_dependencies,
@@ -130,15 +137,17 @@
         'azure-cli>=2.31.0', 'azure-core', 'azure-identity>=1.13.0',
         'azure-mgmt-network'
     ],
     'gcp': ['google-api-python-client', 'google-cloud-storage'],
     'ibm': ['ibm-cloud-sdk-core', 'ibm-vpc', 'ibm-platform-services'],
     'docker': ['docker'],
     'lambda': [],
-    'cloudflare': aws_dependencies
+    'cloudflare': aws_dependencies,
+    'scp': [],
+    'oci': ['oci'],
 }
 
 extras_require['all'] = sum(extras_require.values(), [])
 
 # Install aws requirements by default, as it is the most common cloud provider,
 # and the installation is quick.
 install_requires += extras_require['aws']
```

### Comparing `skypilot-0.3.1/sky/sky_logging.py` & `skypilot-0.3.2/sky/sky_logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/LICENSE` & `skypilot-0.3.2/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/autostop_lib.py` & `skypilot-0.3.2/sky/skylet/autostop_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/events.py` & `skypilot-0.3.2/sky/skylet/events.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,9 +1,8 @@
 """skylet events"""
-import getpass
 import math
 import os
 import re
 import subprocess
 import sys
 import time
 import traceback
@@ -49,28 +48,20 @@
                 logger.error(f'{self.__class__.__name__} error: {e}')
                 logger.error(traceback.format_exc())
 
     def _run(self):
         raise NotImplementedError
 
 
-class JobUpdateEvent(SkyletEvent):
-    """Skylet event for updating job status."""
+class JobSchedulerEvent(SkyletEvent):
+    """Skylet event for scheduling jobs"""
     EVENT_INTERVAL_SECONDS = 300
 
-    # Only update status of the jobs after this many seconds of job submission,
-    # to avoid race condition with `ray job` to make sure it job has been
-    # correctly updated.
-    # TODO(zhwu): This number should be tuned based on heuristics.
-    _SUBMITTED_GAP_SECONDS = 60
-
     def _run(self):
-        job_owner = getpass.getuser()
-        job_lib.update_status(job_owner,
-                              submitted_gap_sec=self._SUBMITTED_GAP_SECONDS)
+        job_lib.scheduler.schedule_step()
 
 
 class SpotJobUpdateEvent(SkyletEvent):
     """Skylet event for updating spot job status."""
     EVENT_INTERVAL_SECONDS = 300
 
     def _run(self):
```

### Comparing `skypilot-0.3.1/sky/skylet/job_lib.py` & `skypilot-0.3.2/sky/skylet/job_lib.py`

 * *Files 4% similar despite different names*

```diff
@@ -2,21 +2,24 @@
 
 This is a remote utility module that provides job queue functionality.
 """
 import enum
 import json
 import os
 import pathlib
+import psutil
 import shlex
+import subprocess
 import time
 import typing
-from typing import Any, Dict, List, Optional
+from typing import Any, Dict, List, Optional, Tuple
 
 import colorama
 import filelock
+import getpass
 
 from sky import sky_logging
 from sky.skylet import constants
 from sky.utils import common_utils
 from sky.utils import db_utils
 from sky.utils import log_utils
 
@@ -58,14 +61,21 @@
         job_name TEXT,
         username TEXT,
         submitted_at FLOAT,
         status TEXT,
         run_timestamp TEXT CANDIDATE KEY,
         start_at FLOAT DEFAULT -1)""")
 
+    cursor.execute("""CREATE TABLE IF NOT EXISTS pending_jobs(
+        job_id INTEGER,
+        run_cmd TEXT,
+        submit INTEGER,
+        created_time INTEGER
+    )""")
+
     db_utils.add_column_to_table(cursor, conn, 'jobs', 'end_at', 'FLOAT')
     db_utils.add_column_to_table(cursor, conn, 'jobs', 'resources', 'TEXT')
 
     conn.commit()
 
 
 _DB = db_utils.SQLiteConn(_DB_PATH, create_table)
@@ -79,23 +89,23 @@
     # 3 in-flux states: each can transition to any state below it.
     # The `job_id` has been generated, but the generated ray program has
     # not started yet. skylet can transit the state from INIT to FAILED
     # directly, if the ray program fails to start.
     # In the 'jobs' table, the `submitted_at` column will be set to the current
     # time, when the job is firstly created (in the INIT state).
     INIT = 'INIT'
+    # The job is waiting for the required resources. (`ray job status`
+    # shows RUNNING as the generated ray program has started, but blocked
+    # by the placement constraints.)
+    PENDING = 'PENDING'
     # Running the user's setup script (only in effect if --detach-setup is
     # set). Our update_job_status() can temporarily (for a short period) set
     # the status to SETTING_UP, if the generated ray program has not set
     # the status to PENDING or RUNNING yet.
     SETTING_UP = 'SETTING_UP'
-    # The job is waiting for the required resources. (`ray job status`
-    # shows RUNNING as the generated ray program has started, but blocked
-    # by the placement constraints.)
-    PENDING = 'PENDING'
     # The job is running.
     # In the 'jobs' table, the `start_at` column will be set to the current
     # time, when the job is firstly transitioned to RUNNING.
     RUNNING = 'RUNNING'
     # 3 terminal states below: once reached, they do not transition.
     # The job finished successfully.
     SUCCEEDED = 'SUCCEEDED'
@@ -122,43 +132,115 @@
         return list(JobStatus).index(self) < list(JobStatus).index(other)
 
     def colored_str(self):
         color = _JOB_STATUS_TO_COLOR[self]
         return f'{color}{self.value}{colorama.Style.RESET_ALL}'
 
 
+# Only update status of the jobs after this many seconds of job submission,
+# to avoid race condition with `ray job` to make sure it job has been
+# correctly updated.
+# TODO(zhwu): This number should be tuned based on heuristics.
+_PENDING_SUBMIT_GRACE_PERIOD = 60
+
+_PRE_RESOURCE_STATUSES = [JobStatus.PENDING]
+
+
+class JobScheduler:
+    """Base class for job scheduler"""
+
+    def queue(self, job_id: int, cmd: str) -> None:
+        _CURSOR.execute('INSERT INTO pending_jobs VALUES (?,?,?,?)',
+                        (job_id, cmd, 0, int(time.time())))
+        _CONN.commit()
+        set_status(job_id, JobStatus.PENDING)
+        self.schedule_step()
+
+    def remove_job_no_lock(self, job_id: int) -> None:
+        _CURSOR.execute(f'DELETE FROM pending_jobs WHERE job_id={job_id!r}')
+        _CONN.commit()
+
+    def _run_job(self, job_id: int, run_cmd: str):
+        _CURSOR.execute((f'UPDATE pending_jobs SET submit={int(time.time())} '
+                         f'WHERE job_id={job_id!r}'))
+        _CONN.commit()
+        subprocess.Popen(run_cmd, shell=True, stdout=subprocess.DEVNULL)
+
+    def schedule_step(self) -> None:
+        job_owner = getpass.getuser()
+        jobs = self._get_jobs()
+        if len(jobs) > 0:
+            update_status(job_owner)
+        # TODO(zhwu, mraheja): One optimization can be allowing more than one
+        # job staying in the pending state after ray job submit, so that to be
+        # faster to schedule a large amount of jobs.
+        for job_id, run_cmd, submit, created_time in jobs:
+            with filelock.FileLock(_get_lock_path(job_id)):
+                status = get_status_no_lock(job_id)
+                if (status not in _PRE_RESOURCE_STATUSES or
+                        created_time < psutil.boot_time()):
+                    # Job doesn't exist, is running/cancelled, or created
+                    # before the last reboot.
+                    self.remove_job_no_lock(job_id)
+                    continue
+                if submit:
+                    # Next job waiting for resources
+                    return
+                self._run_job(job_id, run_cmd)
+                return
+
+    def _get_jobs(self) -> List[Tuple[int, str, int, int]]:
+        """Returns the metadata for jobs in the pending jobs table
+
+        The information contains job_id, run command, submit time,
+        creation time.
+        """
+        raise NotImplementedError
+
+
+class FIFOScheduler(JobScheduler):
+    """First in first out job scheduler"""
+
+    def _get_jobs(self) -> List[Tuple[int, str, int, int]]:
+        return list(
+            _CURSOR.execute('SELECT * FROM pending_jobs ORDER BY job_id'))
+
+
+scheduler = FIFOScheduler()
+
 _JOB_STATUS_TO_COLOR = {
     JobStatus.INIT: colorama.Fore.BLUE,
     JobStatus.SETTING_UP: colorama.Fore.BLUE,
     JobStatus.PENDING: colorama.Fore.BLUE,
     JobStatus.RUNNING: colorama.Fore.GREEN,
     JobStatus.SUCCEEDED: colorama.Fore.GREEN,
     JobStatus.FAILED: colorama.Fore.RED,
     JobStatus.FAILED_SETUP: colorama.Fore.RED,
     JobStatus.CANCELLED: colorama.Fore.YELLOW,
 }
 
 _RAY_TO_JOB_STATUS_MAP = {
-    # These are intentionally set to one status before, because:
+    # These are intentionally set this way, because:
     # 1. when the ray status indicates the job is PENDING the generated
-    # python program should not be started yet, i.e. the job should be INIT.
+    # python program has been `ray job submit` from the job queue
+    # and is now PENDING
     # 2. when the ray status indicates the job is RUNNING the job can be in
     # setup or resources may not be allocated yet, i.e. the job should be
-    # SETTING_UP.
-    # For case 2, update_job_status() would compare this mapped SETTING_UP to
+    # PENDING.
+    # For case 2, update_job_status() would compare this mapped PENDING to
     # the status in our jobs DB and take the max. This is because the job's
     # generated ray program is the only place that can determine a job has
     # reserved resources and actually started running: it will set the
-    # status in the DB to RUNNING.
+    # status in the DB to SETTING_UP or RUNNING.
     # If there is no setup specified in the task, as soon as it is started
     # (ray's status becomes RUNNING), i.e. it will be very rare that the job
     # will be set to SETTING_UP by the update_job_status, as our generated
     # ray program will set the status to PENDING immediately.
-    'PENDING': JobStatus.INIT,
-    'RUNNING': JobStatus.SETTING_UP,
+    'PENDING': JobStatus.PENDING,
+    'RUNNING': JobStatus.PENDING,
     'SUCCEEDED': JobStatus.SUCCEEDED,
     'FAILED': JobStatus.FAILED,
     'STOPPED': JobStatus.CANCELLED,
 }
 
 
 def _create_ray_job_submission_client():
@@ -364,37 +446,36 @@
             'start_at': row[JobInfoLoc.START_AT.value],
             'end_at': row[JobInfoLoc.END_AT.value],
             'resources': row[JobInfoLoc.RESOURCES.value],
         })
     return records
 
 
-def _get_jobs(username: Optional[str],
-              status_list: Optional[List[JobStatus]] = None,
-              submitted_gap_sec: int = 0) -> List[Dict[str, Any]]:
+def _get_jobs(
+        username: Optional[str],
+        status_list: Optional[List[JobStatus]] = None) -> List[Dict[str, Any]]:
     if status_list is None:
         status_list = list(JobStatus)
     status_str_list = [status.value for status in status_list]
     if username is None:
         rows = _CURSOR.execute(
             f"""\
             SELECT * FROM jobs
             WHERE status IN ({','.join(['?'] * len(status_list))})
-            AND submitted_at <= (?)
             ORDER BY job_id DESC""",
-            (*status_str_list, time.time() - submitted_gap_sec),
+            (*status_str_list,),
         )
     else:
         rows = _CURSOR.execute(
             f"""\
             SELECT * FROM jobs
             WHERE status IN ({','.join(['?'] * len(status_list))})
-            AND username=(?) AND submitted_at <= (?)
+            AND username=(?)
             ORDER BY job_id DESC""",
-            (*status_str_list, username, time.time() - submitted_gap_sec),
+            (*status_str_list, username),
         )
 
     records = _get_records_from_rows(rows)
     return records
 
 
 def _get_jobs_by_ids(job_ids: List[int]) -> List[Dict[str, Any]]:
@@ -405,14 +486,26 @@
         ORDER BY job_id DESC""",
         (*job_ids,),
     )
     records = _get_records_from_rows(rows)
     return records
 
 
+def _get_pending_jobs():
+    rows = _CURSOR.execute(
+        'SELECT job_id, created_time, submit FROM pending_jobs')
+    rows = list(rows)
+    return {
+        job_id: {
+            'created_time': created_time,
+            'submit': submit
+        } for job_id, created_time, submit in rows
+    }
+
+
 def update_job_status(job_owner: str,
                       job_ids: List[int],
                       silent: bool = False) -> List[JobStatus]:
     """Updates and returns the job statuses matching our `JobStatus` semantics.
 
     This function queries `ray job status` and processes those results to match
     our semantics.
@@ -431,35 +524,51 @@
 
     job_client = _create_ray_job_submission_client()
 
     # In ray 2.4.0, job_client.list_jobs returns a list of JobDetails,
     # which contains the job status (str) and submission_id (str).
     job_detail_lists: List['ray_pydantic.JobDetails'] = job_client.list_jobs()
 
+    pending_jobs = _get_pending_jobs()
     job_details = {}
     ray_job_ids_set = set(ray_job_ids)
     for job_detail in job_detail_lists:
         if job_detail.submission_id in ray_job_ids_set:
             job_details[job_detail.submission_id] = job_detail
     job_statuses: List[Optional[JobStatus]] = [None] * len(ray_job_ids)
     for i, ray_job_id in enumerate(ray_job_ids):
+        job_id = job_ids[i]
         if ray_job_id in job_details:
             ray_status = job_details[ray_job_id].status
             job_statuses[i] = _RAY_TO_JOB_STATUS_MAP[ray_status]
+        if job_id in pending_jobs:
+            if pending_jobs[job_id]['created_time'] < psutil.boot_time():
+                # The job is stale as it is created before the instance
+                # is booted, e.g. the instance is rebooted.
+                job_statuses[i] = JobStatus.FAILED
+            # Gives a 60 second grace period between job being submit from
+            # the pending table until appearing in ray jobs.
+            if (pending_jobs[job_id]['submit'] > 0 and
+                    pending_jobs[job_id]['submit'] <
+                    time.time() - _PENDING_SUBMIT_GRACE_PERIOD):
+                # For jobs submitted outside of the grace period, we will
+                # consider the ray job status.
+                continue
+            else:
+                # Reset the job status to PENDING even though it may not appear
+                # in the ray jobs, so that it will not be considered as stale.
+                job_statuses[i] = JobStatus.PENDING
 
     assert len(job_statuses) == len(job_ids), (job_statuses, job_ids)
 
     statuses = []
     for job_id, status in zip(job_ids, job_statuses):
         # Per-job status lock is required because between the job status
         # query and the job status update, the job status in the databse
         # can be modified by the generated ray program.
-        # TODO(mraheja): remove pylint disabling when filelock version
-        # updated
-        # pylint: disable=abstract-class-instantiated
         with filelock.FileLock(_get_lock_path(job_id)):
             original_status = get_status_no_lock(job_id)
             assert original_status is not None, (job_id, status)
             if status is None:
                 status = original_status
                 if (original_status is not None and
                         not original_status.is_terminal()):
@@ -499,24 +608,23 @@
         f"""\
         UPDATE jobs SET status=(?)
         WHERE status IN ({','.join(['?'] * len(in_progress_status))})
         """, (JobStatus.FAILED.value, *in_progress_status))
     _CONN.commit()
 
 
-def update_status(job_owner: str, submitted_gap_sec: int = 0) -> None:
+def update_status(job_owner: str) -> None:
     # This will be called periodically by the skylet to update the status
     # of the jobs in the database, to avoid stale job status.
     # NOTE: there might be a INIT job in the database set to FAILED by this
     # function, as the ray job status does not exist due to the app
     # not submitted yet. It will be then reset to PENDING / RUNNING when the
     # app starts.
     nonterminal_jobs = _get_jobs(username=None,
-                                 status_list=JobStatus.nonterminal_statuses(),
-                                 submitted_gap_sec=submitted_gap_sec)
+                                 status_list=JobStatus.nonterminal_statuses())
     nonterminal_job_ids = [job['job_id'] for job in nonterminal_jobs]
 
     update_job_status(job_owner, nonterminal_job_ids)
 
 
 def is_cluster_idle() -> bool:
     """Returns if the cluster is idle (no in-flight jobs)."""
@@ -599,38 +707,44 @@
     Args:
         jobs: The job ids to cancel. If None, cancel all the jobs.
     """
     # Update the status of the jobs to avoid setting the status of stale
     # jobs to CANCELLED.
     if jobs is None:
         job_records = _get_jobs(
-            None, [JobStatus.SETTING_UP, JobStatus.PENDING, JobStatus.RUNNING])
+            None, [JobStatus.PENDING, JobStatus.SETTING_UP, JobStatus.RUNNING])
     else:
         job_records = _get_jobs_by_ids(jobs)
 
     # TODO(zhwu): `job_client.stop_job` will wait for the jobs to be killed, but
     # when the memory is not enough, this will keep waiting.
     job_client = _create_ray_job_submission_client()
 
     # Sequentially cancel the jobs to avoid the resource number bug caused by
     # ray cluster (tracked in #1262).
     for job in job_records:
         job_id = make_ray_job_id(job['job_id'], job_owner)
-        try:
-            job_client.stop_job(job_id)
-        except RuntimeError as e:
-            # If the job does not exist or if the request to the
-            # job server fails.
-            logger.warning(str(e))
-            continue
-
-        if job['status'] in [
-                JobStatus.SETTING_UP, JobStatus.PENDING, JobStatus.RUNNING
-        ]:
-            set_status(job['job_id'], JobStatus.CANCELLED)
+        # Job is locked to ensure that pending queue does not start it while
+        # it is being cancelled
+        with filelock.FileLock(_get_lock_path(job['job_id'])):
+            try:
+                job_client.stop_job(job_id)
+            except RuntimeError as e:
+                # If the request to the job server fails, we should not
+                # set the job to CANCELLED.
+                if 'does not exist' not in str(e):
+                    logger.warning(str(e))
+                    continue
+
+            if job['status'] in [
+                    JobStatus.PENDING, JobStatus.SETTING_UP, JobStatus.RUNNING
+            ]:
+                _set_status_no_lock(job['job_id'], JobStatus.CANCELLED)
+
+        scheduler.schedule_step()
 
 
 def get_run_timestamp(job_id: Optional[int]) -> Optional[str]:
     """Returns the relative path to the log file for a job."""
     _CURSOR.execute(
         """\
             SELECT * FROM jobs
@@ -680,14 +794,21 @@
             f'{run_timestamp!r}, '
             f'{resources_str!r})',
             'print("Job ID: " + str(job_id), flush=True)',
         ]
         return cls._build(code)
 
     @classmethod
+    def queue_job(cls, job_id: int, cmd: str) -> str:
+        code = ['job_lib.scheduler.queue('
+                f'{job_id!r},'
+                f'{cmd!r})']
+        return cls._build(code)
+
+    @classmethod
     def update_status(cls, job_owner: str) -> str:
         code = [
             f'job_lib.update_status({job_owner!r})',
         ]
         return cls._build(code)
 
     @classmethod
```

### Comparing `skypilot-0.3.1/sky/skylet/log_lib.py` & `skypilot-0.3.2/sky/skylet/log_lib.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """Sky logging library.
 
 This is a remote utility module that provides logging functionality.
 """
+import copy
 import io
+import multiprocessing.pool
 import os
-import selectors
 import subprocess
 import sys
 import time
 import textwrap
 import tempfile
 from typing import Dict, Iterator, List, Optional, Tuple, Union
 
@@ -22,92 +23,109 @@
 _SKY_LOG_WAITING_GAP_SECONDS = 1
 _SKY_LOG_WAITING_MAX_RETRY = 5
 _SKY_LOG_TAILING_GAP_SECONDS = 0.2
 
 logger = sky_logging.init_logger(__name__)
 
 
-def process_subprocess_stream(
-    proc,
-    log_path: str,
-    stream_logs: bool,
-    start_streaming_at: str = '',
-    end_streaming_at: Optional[str] = None,
-    skip_lines: Optional[List[str]] = None,
-    replace_crlf: bool = False,
-    line_processor: Optional[log_utils.LineProcessor] = None,
-    streaming_prefix: Optional[str] = None,
-) -> Tuple[str, str]:
-    """Redirect the process's filtered stdout/stderr to both stream and file"""
-    if line_processor is None:
-        line_processor = log_utils.LineProcessor()
+class _ProcessingArgs:
+    """Arguments for processing logs."""
 
-    sel = selectors.DefaultSelector()
-    out_io = io.TextIOWrapper(proc.stdout,
+    def __init__(self,
+                 log_path: str,
+                 stream_logs: bool,
+                 start_streaming_at: str = '',
+                 end_streaming_at: Optional[str] = None,
+                 skip_lines: Optional[List[str]] = None,
+                 replace_crlf: bool = False,
+                 line_processor: Optional[log_utils.LineProcessor] = None,
+                 streaming_prefix: Optional[str] = None) -> None:
+        self.log_path = log_path
+        self.stream_logs = stream_logs
+        self.start_streaming_at = start_streaming_at
+        self.end_streaming_at = end_streaming_at
+        self.skip_lines = skip_lines
+        self.replace_crlf = replace_crlf
+        self.line_processor = line_processor
+        self.streaming_prefix = streaming_prefix
+
+
+def _handle_io_stream(io_stream, out_stream, args: _ProcessingArgs):
+    """Process the stream of a process."""
+    out_io = io.TextIOWrapper(io_stream,
                               encoding='utf-8',
                               newline='',
-                              errors='replace')
-    sel.register(out_io, selectors.EVENT_READ)
-    if proc.stderr is not None:
-        err_io = io.TextIOWrapper(proc.stderr,
-                                  encoding='utf-8',
-                                  newline='',
-                                  errors='replace')
-        sel.register(err_io, selectors.EVENT_READ)
-
-    stdout = ''
-    stderr = ''
-
-    if streaming_prefix is None:
-        streaming_prefix = ''
+                              errors='replace',
+                              write_through=True)
 
     start_streaming_flag = False
     end_streaming_flag = False
-    with line_processor:
-        with open(log_path, 'a') as fout:
-            while len(sel.get_map()) > 0:
-                events = sel.select()
-                for key, _ in events:
-                    line = key.fileobj.readline()
-                    if not line:
-                        # Unregister the io when EOF reached
-                        sel.unregister(key.fileobj)
-                        continue
-                    # TODO(zhwu,gmittal): Put replace_crlf, skip_lines, and
-                    # start_streaming_at logic in processor.process_line(line)
-                    if replace_crlf and line.endswith('\r\n'):
-                        # Replace CRLF with LF to avoid ray logging to the same
-                        # line due to separating lines with '\n'.
-                        line = line[:-2] + '\n'
-                    if (skip_lines is not None and
-                            any(skip in line for skip in skip_lines)):
-                        continue
-                    if start_streaming_at in line:
-                        start_streaming_flag = True
-                    if (end_streaming_at is not None and
-                            end_streaming_at in line):
-                        # Keep executing the loop, only stop streaming.
-                        # E.g., this is used for `sky bench` to hide the
-                        # redundant messages of `sky launch` while
-                        # saving them in log files.
-                        end_streaming_flag = True
-                    if key.fileobj is out_io:
-                        stdout += line
-                        out_stream = sys.stdout
-                    else:
-                        stderr += line
-                        out_stream = sys.stderr
-                    if (stream_logs and start_streaming_flag and
-                            not end_streaming_flag):
-                        out_stream.write(streaming_prefix + line)
-                        out_stream.flush()
-                    if log_path != '/dev/null':
-                        fout.write(line)
-                        fout.flush()
-                    line_processor.process_line(line)
+    streaming_prefix = args.streaming_prefix if args.streaming_prefix else ''
+    line_processor = (log_utils.LineProcessor()
+                      if args.line_processor is None else args.line_processor)
+
+    out = []
+    with open(args.log_path, 'a') as fout:
+        with line_processor:
+            while True:
+                line = out_io.readline()
+                if not line:
+                    break
+                # start_streaming_at logic in processor.process_line(line)
+                if args.replace_crlf and line.endswith('\r\n'):
+                    # Replace CRLF with LF to avoid ray logging to the same
+                    # line due to separating lines with '\n'.
+                    line = line[:-2] + '\n'
+                if (args.skip_lines is not None and
+                        any(skip in line for skip in args.skip_lines)):
+                    continue
+                if args.start_streaming_at in line:
+                    start_streaming_flag = True
+                if (args.end_streaming_at is not None and
+                        args.end_streaming_at in line):
+                    # Keep executing the loop, only stop streaming.
+                    # E.g., this is used for `sky bench` to hide the
+                    # redundant messages of `sky launch` while
+                    # saving them in log files.
+                    end_streaming_flag = True
+                if (args.stream_logs and start_streaming_flag and
+                        not end_streaming_flag):
+                    print(streaming_prefix + line,
+                          end='',
+                          file=out_stream,
+                          flush=True)
+                if args.log_path != '/dev/null':
+                    fout.write(line)
+                    fout.flush()
+                line_processor.process_line(line)
+                out.append(line)
+    return ''.join(out)
+
+
+def process_subprocess_stream(proc, args: _ProcessingArgs) -> Tuple[str, str]:
+    """Redirect the process's filtered stdout/stderr to both stream and file"""
+    if proc.stderr is not None:
+        # Asyncio does not work as the output processing can be executed in a
+        # different thread.
+        # selectors is possible to handle the multiplexing of stdout/stderr,
+        # but it introduces buffering making the output not streaming.
+        with multiprocessing.pool.ThreadPool(processes=1) as pool:
+            err_args = copy.copy(args)
+            err_args.line_processor = None
+            stderr_fut = pool.apply_async(_handle_io_stream,
+                                          args=(proc.stderr, sys.stderr,
+                                                err_args))
+            # Do not launch a thread for stdout as the rich.status does not
+            # work in a thread, which is used in
+            # log_utils.RayUpLineProcessor.
+            stdout = _handle_io_stream(proc.stdout, sys.stdout, args)
+            stderr = stderr_fut.get()
+    else:
+        stdout = _handle_io_stream(proc.stdout, sys.stdout, args)
+        stderr = ''
     return stdout, stderr
 
 
 def run_with_log(
     cmd: Union[List[str], str],
     log_path: str,
     *,
@@ -129,16 +147,16 @@
 
     Args:
         cmd: The command to run.
         log_path: The path to the log file.
         stream_logs: Whether to stream the logs to stdout/stderr.
         require_outputs: Whether to return the stdout/stderr of the command.
         process_stream: Whether to post-process the stdout/stderr of the
-          command. If enabled, lines are printed only when '\r' or '\n' is
-          found.
+            command, such as replacing or skipping lines on the fly. If
+            enabled, lines are printed only when '\r' or '\n' is found.
         ray_job_id: The id for a ray job.
         use_sudo: Whether to use sudo to create log_path.
 
     Returns the returncode or returncode, stdout and stderr of the command.
       Note that the stdout and stderr is already decoded.
     """
     assert process_stream or not require_outputs, (
@@ -218,26 +236,26 @@
             skip_lines += [
                 'bash: cannot set terminal process group',
                 'bash: no job control in this shell',
             ]
             # We need this even if the log_path is '/dev/null' to ensure the
             # progress bar is shown.
             # NOTE: Lines are printed only when '\r' or '\n' is found.
-            stdout, stderr = process_subprocess_stream(
-                proc,
-                log_path,
-                stream_logs,
+            args = _ProcessingArgs(
+                log_path=log_path,
+                stream_logs=stream_logs,
                 start_streaming_at=start_streaming_at,
                 end_streaming_at=end_streaming_at,
                 skip_lines=skip_lines,
                 line_processor=line_processor,
                 # Replace CRLF when the output is logged to driver by ray.
                 replace_crlf=with_ray,
                 streaming_prefix=streaming_prefix,
             )
+            stdout, stderr = process_subprocess_stream(proc, args)
         proc.wait()
         if require_outputs:
             return proc.returncode, stdout, stderr
         return proc.returncode
 
 
 def make_task_bash_script(codegen: str,
@@ -307,22 +325,24 @@
         if use_sudo:
             subprocess.run(f'chmod a+rwx {script_path}', shell=True, check=True)
             subprocess_cmd = job_lib.make_job_command_with_user_switching(
                 job_owner, inner_command)
         else:
             subprocess_cmd = inner_command
 
-        return run_with_log(subprocess_cmd,
-                            log_path,
-                            ray_job_id=job_lib.make_ray_job_id(
-                                job_id, job_owner),
-                            stream_logs=stream_logs,
-                            with_ray=with_ray,
-                            use_sudo=use_sudo,
-                            shell=True)
+        return run_with_log(
+            subprocess_cmd,
+            log_path,
+            ray_job_id=job_lib.make_ray_job_id(job_id, job_owner),
+            stream_logs=stream_logs,
+            with_ray=with_ray,
+            use_sudo=use_sudo,
+            # Disable input to avoid blocking.
+            stdin=subprocess.DEVNULL,
+            shell=True)
 
 
 def _follow_job_logs(file,
                      job_id: int,
                      start_streaming_at: str = '') -> Iterator[str]:
     """Yield each line from a file as they are written.
```

### Comparing `skypilot-0.3.1/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py` & `skypilot-0.3.2/sky/skylet/providers/aws/cloudwatch/cloudwatch_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/aws/config.py` & `skypilot-0.3.2/sky/skylet/providers/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/aws/node_provider.py` & `skypilot-0.3.2/sky/skylet/providers/aws/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/aws/utils.py` & `skypilot-0.3.2/sky/skylet/providers/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/azure/azure-config-template.json` & `skypilot-0.3.2/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot-0.3.2/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/azure/config.py` & `skypilot-0.3.2/sky/skylet/providers/azure/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/azure/node_provider.py` & `skypilot-0.3.2/sky/skylet/providers/azure/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/gcp/config.py` & `skypilot-0.3.2/sky/skylet/providers/gcp/config.py`

 * *Files 16% similar despite different names*

```diff
@@ -20,14 +20,16 @@
     GCPCompute,
 )
 from sky.skylet.providers.gcp.constants import (
     SKYPILOT_VPC_NAME,
     VPC_TEMPLATE,
     FIREWALL_RULES_TEMPLATE,
     FIREWALL_RULES_REQUIRED,
+    VM_MINIMAL_PERMISSIONS,
+    TPU_MINIMAL_PERMISSIONS,
 )
 from ray.autoscaler._private.util import check_legacy_fields
 
 logger = logging.getLogger(__name__)
 
 VERSION = "v1"
 TPU_VERSION = "v2alpha"  # change once v2 is stable
@@ -35,14 +37,23 @@
 RAY = "ray-autoscaler"
 DEFAULT_SERVICE_ACCOUNT_ID = RAY + "-sa-" + VERSION
 SERVICE_ACCOUNT_EMAIL_TEMPLATE = "{account_id}@{project_id}.iam.gserviceaccount.com"
 DEFAULT_SERVICE_ACCOUNT_CONFIG = {
     "displayName": "Ray Autoscaler Service Account ({})".format(VERSION),
 }
 
+SKYPILOT = "skypilot"
+SKYPILOT_SERVICE_ACCOUNT_ID = SKYPILOT + "-" + VERSION
+SKYPILOT_SERVICE_ACCOUNT_EMAIL_TEMPLATE = (
+    "{account_id}@{project_id}.iam.gserviceaccount.com"
+)
+SKYPILOT_SERVICE_ACCOUNT_CONFIG = {
+    "displayName": "SkyPilot Service Account ({})".format(VERSION),
+}
+
 # Those roles will be always added.
 # NOTE: `serviceAccountUser` allows the head node to create workers with
 # a serviceAccount. `roleViewer` allows the head node to run bootstrap_gcp.
 DEFAULT_SERVICE_ACCOUNT_ROLES = [
     "roles/storage.objectAdmin",
     "roles/compute.admin",
     "roles/iam.serviceAccountUser",
@@ -131,15 +142,15 @@
         time.sleep(POLL_INTERVAL)
 
     return result
 
 
 def key_pair_name(i, region, project_id, ssh_user):
     """Returns the ith default gcp_key_pair_name."""
-    key_name = "{}_gcp_{}_{}_{}_{}".format(RAY, region, project_id, ssh_user, i)
+    key_name = "{}_gcp_{}_{}_{}_{}".format(SKYPILOT, region, project_id, ssh_user, i)
     return key_name
 
 
 def key_pair_paths(key_name):
     """Returns public and private key paths for a given key_name."""
     public_key_path = os.path.expanduser("~/.ssh/{}.pub".format(key_name))
     private_key_path = os.path.expanduser("~/.ssh/{}.pem".format(key_name))
@@ -329,50 +340,161 @@
     ), "Project status needs to be ACTIVE, got {}".format(project["lifecycleState"])
 
     config["provider"]["project_id"] = project["projectId"]
 
     return config
 
 
+def _is_permission_satisfied(
+    service_account, crm, iam, required_permissions, required_roles
+):
+    """Check if either of the roles or permissions are satisfied."""
+    if service_account is None:
+        return False, None
+
+    project_id = service_account["projectId"]
+    email = service_account["email"]
+
+    member_id = "serviceAccount:" + email
+
+    required_permissions = set(required_permissions)
+    policy = crm.projects().getIamPolicy(resource=project_id, body={}).execute()
+    original_policy = copy.deepcopy(policy)
+    already_configured = True
+
+    logger.info(f"_configure_iam_role: Checking permissions for {email}...")
+
+    # Check the roles first, as checking the permission requires more API calls and
+    # permissions.
+    for role in required_roles:
+        role_exists = False
+        for binding in policy["bindings"]:
+            if binding["role"] == role:
+                if member_id not in binding["members"]:
+                    binding["members"].append(member_id)
+                    already_configured = False
+                role_exists = True
+
+        if not role_exists:
+            already_configured = False
+            policy["bindings"].append(
+                {
+                    "members": [member_id],
+                    "role": role,
+                }
+            )
+
+    if already_configured:
+        # In some managed environments, an admin needs to grant the
+        # roles, so only call setIamPolicy if needed.
+        return True, policy
+
+    for binding in original_policy["bindings"]:
+        if member_id in binding["members"]:
+            role = binding["role"]
+            try:
+                role_definition = iam.projects().roles().get(name=role).execute()
+            except TypeError as e:
+                if "does not match the pattern" in str(e):
+                    logger.info(
+                        f"_configure_iam_role: fail to check permission for built-in role {role}. skipped."
+                    )
+                    permissions = []
+                else:
+                    raise
+            else:
+                permissions = role_definition["includedPermissions"]
+            required_permissions -= set(permissions)
+        if not required_permissions:
+            break
+    if not required_permissions:
+        # All required permissions are already granted.
+        return True, policy
+    logger.info(f"_configure_iam_role: missing permisisons {required_permissions}")
+
+    return False, policy
+
+
 def _configure_iam_role(config, crm, iam):
     """Setup a gcp service account with IAM roles.
 
     Creates a gcp service acconut and binds IAM roles which allow it to control
     control storage/compute services. Specifically, the head node needs to have
     an IAM role that allows it to create further gce instances and store items
     in google cloud storage.
 
     TODO: Allow the name/id of the service account to be configured
     """
     config = copy.deepcopy(config)
 
-    email = SERVICE_ACCOUNT_EMAIL_TEMPLATE.format(
-        account_id=DEFAULT_SERVICE_ACCOUNT_ID,
+    email = SKYPILOT_SERVICE_ACCOUNT_EMAIL_TEMPLATE.format(
+        account_id=SKYPILOT_SERVICE_ACCOUNT_ID,
         project_id=config["provider"]["project_id"],
     )
     service_account = _get_service_account(email, config, iam)
 
-    if service_account is None:
+    permissions = VM_MINIMAL_PERMISSIONS
+    roles = DEFAULT_SERVICE_ACCOUNT_ROLES
+    if config["provider"].get(HAS_TPU_PROVIDER_FIELD, False):
+        roles = DEFAULT_SERVICE_ACCOUNT_ROLES + TPU_SERVICE_ACCOUNT_ROLES
+        permissions = VM_MINIMAL_PERMISSIONS + TPU_MINIMAL_PERMISSIONS
+
+    satisfied, policy = _is_permission_satisfied(
+        service_account, crm, iam, permissions, roles
+    )
+
+    if not satisfied:
+        # SkyPilot: Fallback to the old ray service account name for
+        # backwards compatibility. Users using GCP before #2112 have
+        # the old service account setup setup in their GCP project,
+        # and the user may not have the permissions to create the
+        # new service account. This is to ensure that the old service
+        # account is still usable.
+        email = SERVICE_ACCOUNT_EMAIL_TEMPLATE.format(
+            account_id=DEFAULT_SERVICE_ACCOUNT_ID,
+            project_id=config["provider"]["project_id"],
+        )
+        logger.info(f"_configure_iam_role: Fallback to service account {email}")
+
+        ray_service_account = _get_service_account(email, config, iam)
+        ray_satisfied, _ = _is_permission_satisfied(
+            ray_service_account, crm, iam, permissions, roles
+        )
         logger.info(
             "_configure_iam_role: "
-            "Creating new service account {}".format(DEFAULT_SERVICE_ACCOUNT_ID)
+            f"Fallback to service account {email} succeeded? {ray_satisfied}"
         )
 
-        service_account = _create_service_account(
-            DEFAULT_SERVICE_ACCOUNT_ID, DEFAULT_SERVICE_ACCOUNT_CONFIG, config, iam
-        )
+        if ray_satisfied:
+            service_account = ray_service_account
+            satisfied = ray_satisfied
+        elif service_account is None:
+            logger.info(
+                "_configure_iam_role: "
+                "Creating new service account {}".format(SKYPILOT_SERVICE_ACCOUNT_ID)
+            )
+            # SkyPilot: a GCP user without the permission to create a service
+            # account will fail here.
+            service_account = _create_service_account(
+                SKYPILOT_SERVICE_ACCOUNT_ID,
+                SKYPILOT_SERVICE_ACCOUNT_CONFIG,
+                config,
+                iam,
+            )
+            satisfied, policy = _is_permission_satisfied(
+                service_account, crm, iam, permissions, roles
+            )
 
     assert service_account is not None, "Failed to create service account"
 
-    if config["provider"].get(HAS_TPU_PROVIDER_FIELD, False):
-        roles = DEFAULT_SERVICE_ACCOUNT_ROLES + TPU_SERVICE_ACCOUNT_ROLES
-    else:
-        roles = DEFAULT_SERVICE_ACCOUNT_ROLES
-
-    _add_iam_policy_binding(service_account, roles, crm)
+    if not satisfied:
+        logger.info(
+            "_configure_iam_role: " f"Adding roles to service account {email}..."
+        )
+        _add_iam_policy_binding(service_account, policy, crm, iam)
 
     account_dict = {
         "email": service_account["email"],
         # NOTE: The amount of access is determined by the scope + IAM
         # role of the service account. Even if the cloud-platform scope
         # gives (scope) access to the whole cloud-platform, the service
         # account is limited by the IAM rights specified below.
@@ -835,15 +957,18 @@
     project_id = config["provider"]["project_id"]
     full_name = "projects/{project_id}/serviceAccounts/{account}".format(
         project_id=project_id, account=account
     )
     try:
         service_account = iam.projects().serviceAccounts().get(name=full_name).execute()
     except errors.HttpError as e:
-        if e.resp.status != 404:
+        if e.resp.status not in [403, 404]:
+            # SkyPilot: added 403, which means the service account doesn't exist,
+            # or not accessible by the current account, which is fine, as we do the
+            # fallback in the caller.
             raise
         service_account = None
 
     return service_account
 
 
 def _create_service_account(account_id, account_config, config, iam):
@@ -861,45 +986,17 @@
         )
         .execute()
     )
 
     return service_account
 
 
-def _add_iam_policy_binding(service_account, roles, crm):
+def _add_iam_policy_binding(service_account, policy, crm, iam):
     """Add new IAM roles for the service account."""
     project_id = service_account["projectId"]
-    email = service_account["email"]
-    member_id = "serviceAccount:" + email
-
-    policy = crm.projects().getIamPolicy(resource=project_id, body={}).execute()
-
-    already_configured = True
-    for role in roles:
-        role_exists = False
-        for binding in policy["bindings"]:
-            if binding["role"] == role:
-                if member_id not in binding["members"]:
-                    binding["members"].append(member_id)
-                    already_configured = False
-                role_exists = True
-
-        if not role_exists:
-            already_configured = False
-            policy["bindings"].append(
-                {
-                    "members": [member_id],
-                    "role": role,
-                }
-            )
-
-    if already_configured:
-        # In some managed environments, an admin needs to grant the
-        # roles, so only call setIamPolicy if needed.
-        return
 
     result = (
         crm.projects()
         .setIamPolicy(
             resource=project_id,
             body={
                 "policy": policy,
```

### Comparing `skypilot-0.3.1/sky/skylet/providers/gcp/constants.py` & `skypilot-0.3.2/sky/skylet/providers/gcp/constants.py`

 * *Files 27% similar despite different names*

```diff
@@ -74,7 +74,52 @@
             {
                 "IPProtocol": "icmp",
             }
         ],
         "sourceRanges": ["0.0.0.0/0"],
     },
 ]
+
+# A list of permissions required to run SkyPilot on GCP.
+# Keep this in sync with https://skypilot.readthedocs.io/en/latest/cloud-setup/cloud-permissions.html#gcp # pylint: disable=line-too-long
+VM_MINIMAL_PERMISSIONS = [
+    "compute.disks.create",
+    "compute.disks.list",
+    "compute.firewalls.create",
+    "compute.firewalls.delete",
+    "compute.firewalls.get",
+    "compute.instances.create",
+    "compute.instances.delete",
+    "compute.instances.get",
+    "compute.instances.list",
+    "compute.instances.setLabels",
+    "compute.instances.setServiceAccount",
+    "compute.instances.start",
+    "compute.instances.stop",
+    "compute.networks.get",
+    "compute.networks.list",
+    "compute.networks.getEffectiveFirewalls",
+    "compute.globalOperations.get",
+    "compute.subnetworks.use",
+    "compute.subnetworks.list",
+    "compute.subnetworks.useExternalIp",
+    "compute.projects.get",
+    "compute.projects.setCommonInstanceMetadata",
+    "compute.zoneOperations.get",
+    "iam.roles.get",
+    "iam.serviceAccounts.actAs",
+    "iam.serviceAccounts.get",
+    "serviceusage.services.enable",
+    "serviceusage.services.list",
+    "serviceusage.services.use",
+    "resourcemanager.projects.get",
+    "resourcemanager.projects.getIamPolicy",
+]
+
+TPU_MINIMAL_PERMISSIONS = [
+    "tpu.nodes.create",
+    "tpu.nodes.delete",
+    "tpu.nodes.list",
+    "tpu.nodes.get",
+    "tpu.nodes.update",
+    "tpu.operations.get",
+]
```

### Comparing `skypilot-0.3.1/sky/skylet/providers/gcp/node.py` & `skypilot-0.3.2/sky/skylet/providers/gcp/node.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/gcp/node_provider.py` & `skypilot-0.3.2/sky/skylet/providers/gcp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/ibm/node_provider.py` & `skypilot-0.3.2/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/ibm/utils.py` & `skypilot-0.3.2/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/ibm/vpc_provider.py` & `skypilot-0.3.2/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/lambda_cloud/lambda_utils.py` & `skypilot-0.3.2/sky/skylet/providers/lambda_cloud/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/providers/lambda_cloud/node_provider.py` & `skypilot-0.3.2/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/ray_patches/__init__.py` & `skypilot-0.3.2/sky/skylet/ray_patches/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/ray_patches/log_monitor.py.patch` & `skypilot-0.3.2/sky/skylet/ray_patches/log_monitor.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot-0.3.2/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/ray_patches/worker.py.patch` & `skypilot-0.3.2/sky/skylet/ray_patches/worker.py.patch`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skylet/skylet.py` & `skypilot-0.3.2/sky/skylet/skylet.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,20 +1,23 @@
 """skylet: a daemon running on the head node of a cluster."""
 
 import time
 
 from sky import sky_logging
 from sky.skylet import events
 
-logger = sky_logging.init_logger(__name__)
+# Use the explicit logger name so that the logger is under the
+# `sky.skylet.skylet` namespace when executed directly, so as
+# to inherit the setup from the `sky` logger.
+logger = sky_logging.init_logger('sky.skylet.skylet')
 logger.info('skylet started')
 
 EVENTS = [
     events.AutostopEvent(),
-    events.JobUpdateEvent(),
+    events.JobSchedulerEvent(),
     # The spot job update event should be after the job update event.
     # Otherwise, the abnormal spot job status update will be delayed
     # until the next job update event.
     events.SpotJobUpdateEvent(),
 ]
 
 while True:
```

### Comparing `skypilot-0.3.1/sky/skylet/subprocess_daemon.py` & `skypilot-0.3.2/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/skypilot_config.py` & `skypilot-0.3.2/sky/skypilot_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/spot/__init__.py` & `skypilot-0.3.2/sky/spot/__init__.py`

 * *Files 24% similar despite different names*

```diff
@@ -3,38 +3,38 @@
 
 from sky.spot.constants import (
     SPOT_CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP,
     SPOT_CONTROLLER_TEMPLATE,
     SPOT_CONTROLLER_YAML_PREFIX,
     SPOT_TASK_YAML_PREFIX,
 )
-from sky.spot.controller import SpotController
 from sky.spot.recovery_strategy import SPOT_STRATEGIES
 from sky.spot.recovery_strategy import SPOT_DEFAULT_STRATEGY
 from sky.spot.spot_utils import SpotCodeGen
 from sky.spot.spot_utils import SPOT_CONTROLLER_NAME
 from sky.spot.spot_utils import dump_job_table_cache
+from sky.spot.spot_utils import dump_spot_job_queue
 from sky.spot.spot_utils import load_job_table_cache
 from sky.spot.spot_utils import format_job_table
 from sky.spot.spot_utils import is_spot_controller_up
 from sky.spot.spot_utils import load_spot_job_queue
 
 pathlib.Path(SPOT_TASK_YAML_PREFIX).expanduser().parent.mkdir(parents=True,
                                                               exist_ok=True)
 __all__ = [
-    'SpotController',
     'SPOT_STRATEGIES',
     'SPOT_DEFAULT_STRATEGY',
     'SPOT_CONTROLLER_NAME',
     # Constants
     'SPOT_CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP',
     'SPOT_CONTROLLER_TEMPLATE',
     'SPOT_CONTROLLER_YAML_PREFIX',
     'SPOT_TASK_YAML_PREFIX',
     # utils
     'SpotCodeGen',
     'dump_job_table_cache',
     'load_job_table_cache',
     'format_job_table',
     'is_spot_controller_up',
+    'dump_spot_job_queue',
     'load_spot_job_queue',
 ]
```

### Comparing `skypilot-0.3.1/sky/spot/controller.py` & `skypilot-0.3.2/sky/spot/controller.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,77 +1,96 @@
 """Controller: handles the life cycle of a managed spot cluster (job)."""
 import argparse
 import multiprocessing
 import pathlib
 import time
 import traceback
+import typing
 from typing import Tuple
 
 import filelock
 
-import sky
 from sky import exceptions
-from sky import global_user_state
 from sky import sky_logging
+from sky import status_lib
 from sky.backends import backend_utils
 from sky.backends import cloud_vm_ray_backend
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.spot import recovery_strategy
 from sky.spot import spot_state
 from sky.spot import spot_utils
+from sky.usage import usage_lib
 from sky.utils import common_utils
+from sky.utils import dag_utils
 from sky.utils import subprocess_utils
 
+if typing.TYPE_CHECKING:
+    import sky
+
 # Use the explicit logger name so that the logger is under the
 # `sky.spot.controller` namespace when executed directly, so as
 # to inherit the setup from the `sky` logger.
 logger = sky_logging.init_logger('sky.spot.controller')
 
 
-def _get_task_and_name(task_yaml: str) -> Tuple['sky.Task', str]:
-    task = sky.Task.from_yaml(task_yaml)
-    assert task.name is not None, task
-    return task, task.name
+def _get_dag_and_name(dag_yaml: str) -> Tuple['sky.Dag', str]:
+    dag = dag_utils.load_chain_dag_from_yaml(dag_yaml)
+    dag_name = dag.name
+    assert dag_name is not None, dag
+    return dag, dag_name
 
 
 class SpotController:
-    """Each spot controller manages the life cycle of one spot cluster (job)."""
+    """Each spot controller manages the life cycle of one spot job."""
 
-    def __init__(self, job_id: int, task_yaml: str,
+    def __init__(self, job_id: int, dag_yaml: str,
                  retry_until_up: bool) -> None:
         self._job_id = job_id
-        self._task, self._task_name = _get_task_and_name(task_yaml)
+        self._dag, self._dag_name = _get_dag_and_name(dag_yaml)
+        logger.info(self._dag)
 
         self._retry_until_up = retry_until_up
         # TODO(zhwu): this assumes the specific backend.
         self._backend = cloud_vm_ray_backend.CloudVmRayBackend()
 
+        # pylint: disable=line-too-long
         # Add a unique identifier to the task environment variables, so that
         # the user can have the same id for multiple recoveries.
-        #   Example value: sky-2022-10-04-22-46-52-467694_id-17
-        task_envs = self._task.envs or {}
-        job_id_env_var = common_utils.get_global_job_id(
-            self._backend.run_timestamp, 'spot', str(self._job_id))
-        task_envs[constants.JOB_ID_ENV_VAR] = job_id_env_var
-        self._task.update_envs(task_envs)
-
-        spot_state.set_submitted(
-            self._job_id,
-            self._task_name,
-            self._backend.run_timestamp,
-            resources_str=backend_utils.get_task_resources_str(self._task))
-        logger.info(f'Submitted spot job; SKYPILOT_JOB_ID: {job_id_env_var}')
-        self._cluster_name = spot_utils.generate_spot_cluster_name(
-            self._task_name, self._job_id)
-        self._strategy_executor = recovery_strategy.StrategyExecutor.make(
-            self._cluster_name, self._backend, self._task, retry_until_up)
+        #   Example value: sky-2022-10-04-22-46-52-467694_spot_id-17-1
+        job_id_env_vars = []
+        for i in range(len(self._dag.tasks)):
+            job_id_env_var = common_utils.get_global_job_id(
+                self._backend.run_timestamp,
+                'spot',
+                str(self._job_id),
+                task_id=i)
+            job_id_env_vars.append(job_id_env_var)
+
+        for i, task in enumerate(self._dag.tasks):
+            task_envs = task.envs or {}
+            task_envs[constants.TASK_ID_ENV_VAR_DEPRECATED] = job_id_env_vars[i]
+            task_envs[constants.TASK_ID_ENV_VAR] = job_id_env_vars[i]
+            task_envs[constants.TASK_ID_LIST_ENV_VAR] = '\n'.join(
+                job_id_env_vars)
+            task.update_envs(task_envs)
 
-    def _run(self):
+    def _run_one_task(self, task_id: int, task: 'sky.Task') -> bool:
         """Busy loop monitoring spot cluster status and handling recovery.
+        When the task is successfully completed, this function returns True,
+        and will terminate the spot cluster before returning.
+
+        If the user program fails, i.e. the task is set to FAILED or
+        FAILED_SETUP, this function will return False.
+        In other cases, the function will raise exceptions.
+        All the failure cases will rely on the caller to clean up the spot
+        cluster(s) and storages.
+
+        Returns:
+            True if the job is successfully completed; False otherwise.
 
         Raises:
             exceptions.ProvisionPrechecksError: This will be raised when the
                 underlying `sky.launch` fails due to precheck errors only.
                 I.e., none of the failover exceptions, if
                 any, is due to resources unavailability. This exception
                 includes the following cases:
@@ -84,20 +103,56 @@
                 due to:
                 1. Any of the underlying failover exceptions is due to resources
                 unavailability.
                 2. The cluster is preempted before the job is submitted.
                 3. Any unexpected error happens during the `sky.launch`.
         Other exceptions may be raised depending on the backend.
         """
-        logger.info(f'Started monitoring spot job {self._job_id}, '
-                    f'name: {self._task_name!r}.')
-        spot_state.set_starting(self._job_id)
-        job_submitted_at = self._strategy_executor.launch()
+        if task.run is None:
+            logger.info(f'Skip running task {task_id} ({task.name}) due to its '
+                        'run commands being empty.')
+            # Call set_started first to initialize columns in the state table,
+            # including start_at and last_recovery_at to avoid issues for
+            # uninitialized columns.
+            spot_state.set_started(self._job_id,
+                                   task_id,
+                                   start_time=time.time())
+            spot_state.set_succeeded(self._job_id,
+                                     task_id,
+                                     end_time=time.time())
+            return True
+        usage_lib.messages.usage.update_task_id(task_id)
+        task_id_env_var = task.envs[constants.TASK_ID_ENV_VAR]
+        submitted_at = time.time()
+        if task_id == 0:
+            submitted_at = backend_utils.get_timestamp_from_run_timestamp(
+                self._backend.run_timestamp)
+        spot_state.set_submitted(
+            self._job_id,
+            task_id,
+            self._backend.run_timestamp,
+            submitted_at,
+            resources_str=backend_utils.get_task_resources_str(task))
+        logger.info(
+            f'Submitted spot job {self._job_id} (task: {task_id}, name: '
+            f'{task.name!r}); {constants.TASK_ID_ENV_VAR}: {task_id_env_var}')
+        assert task.name is not None, task
+        cluster_name = spot_utils.generate_spot_cluster_name(
+            task.name, self._job_id)
+        self._strategy_executor = recovery_strategy.StrategyExecutor.make(
+            cluster_name, self._backend, task, self._retry_until_up)
 
-        spot_state.set_started(self._job_id, start_time=job_submitted_at)
+        logger.info('Started monitoring.')
+        spot_state.set_starting(self._job_id, task_id)
+        remote_job_submitted_at = self._strategy_executor.launch()
+        assert remote_job_submitted_at is not None, remote_job_submitted_at
+
+        spot_state.set_started(self._job_id,
+                               task_id,
+                               start_time=remote_job_submitted_at)
         while True:
             time.sleep(spot_utils.JOB_STATUS_CHECK_GAP_SECONDS)
 
             # Check the network connection to avoid false alarm for job failure.
             # Network glitch was observed even in the VM.
             try:
                 backend_utils.check_network_connection()
@@ -105,47 +160,54 @@
                 logger.info(
                     'Network is not available. Retrying again in '
                     f'{spot_utils.JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
                 continue
 
             # NOTE: we do not check cluster status first because race condition
             # can occur, i.e. cluster can be down during the job status check.
-            job_status = spot_utils.get_job_status(self._backend,
-                                                   self._cluster_name)
+            job_status = spot_utils.get_job_status(self._backend, cluster_name)
 
             if job_status == job_lib.JobStatus.SUCCEEDED:
                 end_time = spot_utils.get_job_timestamp(self._backend,
-                                                        self._cluster_name,
+                                                        cluster_name,
                                                         get_end_time=True)
                 # The job is done.
-                spot_state.set_succeeded(self._job_id, end_time=end_time)
-                break
+                spot_state.set_succeeded(self._job_id,
+                                         task_id,
+                                         end_time=end_time)
+                logger.info(
+                    f'Spot job {self._job_id} (task: {task_id}) SUCCEEDED. '
+                    f'Cleaning up the spot cluster {cluster_name}.')
+                # Only clean up the spot cluster, not the storages, because
+                # tasks may share storages.
+                recovery_strategy.terminate_cluster(cluster_name=cluster_name)
+                return True
 
             # For single-node jobs, nonterminated job_status indicates a
             # healthy cluster. We can safely continue monitoring.
             # For multi-node jobs, since the job may not be set to FAILED
             # immediately (depending on user program) when only some of the
             # nodes are preempted, need to check the actual cluster status.
             if (job_status is not None and not job_status.is_terminal() and
-                    self._task.num_nodes == 1):
+                    task.num_nodes == 1):
                 continue
 
             if job_status in [
                     job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
             ]:
                 # Add a grace period before the check of preemption to avoid
                 # false alarm for job failure.
                 time.sleep(5)
             # Pull the actual cluster status from the cloud provider to
             # determine whether the cluster is preempted.
             (cluster_status,
              handle) = backend_utils.refresh_cluster_status_handle(
-                 self._cluster_name, force_refresh=True)
+                 cluster_name, force_refresh=True)
 
-            if cluster_status != global_user_state.ClusterStatus.UP:
+            if cluster_status != status_lib.ClusterStatus.UP:
                 # The cluster is (partially) preempted. It can be down, INIT
                 # or STOPPED, based on the interruption behavior of the cloud.
                 # Spot recovery is needed (will be done later in the code).
                 cluster_status_str = ('' if cluster_status is None else
                                       f' (status: {cluster_status.value})')
                 logger.info(
                     f'Cluster is preempted{cluster_status_str}. Recovering...')
@@ -154,15 +216,15 @@
                     # The multi-node job is still running, continue monitoring.
                     continue
                 elif job_status in [
                         job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
                 ]:
                     # The user code has probably crashed, fail immediately.
                     end_time = spot_utils.get_job_timestamp(self._backend,
-                                                            self._cluster_name,
+                                                            cluster_name,
                                                             get_end_time=True)
                     logger.info(
                         'The user job failed. Please check the logs below.\n'
                         f'== Logs of the user job (ID: {self._job_id}) ==\n')
                     # TODO(zhwu): Download the logs, and stream them from the
                     # local disk, instead of streaming them from the spot
                     # cluster, to make it faster and more reliable.
@@ -174,18 +236,19 @@
                     if job_status == job_lib.JobStatus.FAILED_SETUP:
                         spot_status_to_set = spot_state.SpotStatus.FAILED_SETUP
                     failure_reason = (
                         'To see the details, run: '
                         f'sky spot logs --controller {self._job_id}')
 
                     spot_state.set_failed(self._job_id,
+                                          task_id,
                                           failure_type=spot_status_to_set,
                                           failure_reason=failure_reason,
                                           end_time=end_time)
-                    break
+                    return False
                 # Although the cluster is healthy, we fail to access the
                 # job status. Try to recover the job (will not restart the
                 # cluster, if the cluster is healthy).
                 assert job_status is None, job_status
                 logger.info('Failed to fetch the job status while the '
                             'cluster is healthy. Try to recover the job '
                             '(the cluster will not be restarted).')
@@ -194,64 +257,81 @@
             if handle is not None:
                 resources = handle.launched_resources
                 assert resources is not None, handle
                 if resources.need_cleanup_after_preemption():
                     # Some spot resource (e.g., Spot TPU VM) may need to be
                     # cleaned up after preemption.
                     logger.info('Cleaning up the preempted spot cluster...')
-                    recovery_strategy.terminate_cluster(self._cluster_name)
+                    recovery_strategy.terminate_cluster(cluster_name)
 
             # Try to recover the spot jobs, when the cluster is preempted
             # or the job status is failed to be fetched.
-            spot_state.set_recovering(self._job_id)
+            spot_state.set_recovering(self._job_id, task_id)
             recovered_time = self._strategy_executor.recover()
             spot_state.set_recovered(self._job_id,
+                                     task_id,
                                      recovered_time=recovered_time)
 
     def run(self):
         """Run controller logic and handle exceptions."""
+        task_id = 0
         try:
-            self._run()
+            succeeded = True
+            # We support chain DAGs only for now.
+            for task_id, task in enumerate(self._dag.tasks):
+                succeeded = self._run_one_task(task_id, task)
+                if not succeeded:
+                    break
         except exceptions.ProvisionPrechecksError as e:
             # Please refer to the docstring of self._run for the cases when
             # this exception can occur.
             failure_reason = ('; '.join(
                 common_utils.format_exception(reason, use_bracket=True)
                 for reason in e.reasons))
             logger.error(failure_reason)
             spot_state.set_failed(
                 self._job_id,
+                task_id=task_id,
                 failure_type=spot_state.SpotStatus.FAILED_PRECHECKS,
                 failure_reason=failure_reason)
         except exceptions.SpotJobReachedMaxRetriesError as e:
             # Please refer to the docstring of self._run for the cases when
             # this exception can occur.
             logger.error(common_utils.format_exception(e))
             # The spot job should be marked as FAILED_NO_RESOURCE, as the
             # spot job may be able to launch next time.
             spot_state.set_failed(
                 self._job_id,
+                task_id=task_id,
                 failure_type=spot_state.SpotStatus.FAILED_NO_RESOURCE,
                 failure_reason=common_utils.format_exception(e))
         except (Exception, SystemExit) as e:  # pylint: disable=broad-except
             logger.error(traceback.format_exc())
             msg = ('Unexpected error occurred: '
                    f'{common_utils.format_exception(e, use_bracket=True)}')
             logger.error(msg)
             spot_state.set_failed(
                 self._job_id,
+                task_id=task_id,
                 failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
                 failure_reason=msg)
+        finally:
+            # This will set all unfinished tasks to CANCELLING, and will not
+            # affect the jobs in terminal states.
+            # We need to call set_cancelling before set_cancelled to make sure
+            # the table entries are correctly set.
+            spot_state.set_cancelling(self._job_id)
+            spot_state.set_cancelled(self._job_id)
 
 
-def _run_controller(job_id: int, task_yaml: str, retry_until_up: bool):
+def _run_controller(job_id: int, dag_yaml: str, retry_until_up: bool):
     """Runs the controller in a remote process for interruption."""
     # The controller needs to be instantiated in the remote process, since
     # the controller is not serializable.
-    spot_controller = SpotController(job_id, task_yaml, retry_until_up)
+    spot_controller = SpotController(job_id, dag_yaml, retry_until_up)
     spot_controller.run()
 
 
 def _handle_signal(job_id):
     """Handle the signal if the user sent it."""
     signal_file = pathlib.Path(spot_utils.SIGNAL_FILE_PREFIX.format(job_id))
     user_signal = None
@@ -277,40 +357,51 @@
         return
     assert user_signal == spot_utils.UserSignal.CANCEL, (
         f'Only cancel signal is supported, but {user_signal} got.')
     raise exceptions.SpotUserCancelledError(
         f'User sent {user_signal.value} signal.')
 
 
-def _cleanup(job_id: int, task_yaml: str):
+def _cleanup(job_id: int, dag_yaml: str):
+    """Clean up the spot cluster(s) and storages.
+
+    (1) Clean up the succeeded task(s)' ephemeral storage. The storage has
+        to be cleaned up after the whole job is finished, as the tasks
+        may share the same storage.
+    (2) Clean up the spot cluster(s) that are not cleaned up yet, which
+        can happen when the spot task failed or cancelled. At most one
+        spot cluster should be left when reaching here, as we currently
+        only support chain DAGs, and only spot task is executed at a time.
+    """
     # NOTE: The code to get cluster name is same as what we did in the spot
     # controller, we should keep it in sync with SpotController.__init__()
-    task, task_name = _get_task_and_name(task_yaml)
-    cluster_name = spot_utils.generate_spot_cluster_name(task_name, job_id)
-    recovery_strategy.terminate_cluster(cluster_name)
-    # Clean up Storages with persistent=False.
-    # TODO(zhwu): this assumes the specific backend.
-    backend = cloud_vm_ray_backend.CloudVmRayBackend()
-    backend.teardown_ephemeral_storage(task)
+    dag, _ = _get_dag_and_name(dag_yaml)
+    for task in dag.tasks:
+        cluster_name = spot_utils.generate_spot_cluster_name(task.name, job_id)
+        recovery_strategy.terminate_cluster(cluster_name)
+        # Clean up Storages with persistent=False.
+        # TODO(zhwu): this assumes the specific backend.
+        backend = cloud_vm_ray_backend.CloudVmRayBackend()
+        backend.teardown_ephemeral_storage(task)
 
 
-def start(job_id, task_yaml, retry_until_up):
+def start(job_id, dag_yaml, retry_until_up):
     """Start the controller."""
     controller_process = None
     cancelling = False
     try:
         _handle_signal(job_id)
         # TODO(suquark): In theory, we should make controller process a
         #  daemon process so it will be killed after this process exits,
         #  however daemon process cannot launch subprocesses, explained here:
         #  https://docs.python.org/3/library/multiprocessing.html#multiprocessing.Process.daemon  # pylint: disable=line-too-long
         #  So we can only enable daemon after we no longer need to
         #  start daemon processes like Ray.
         controller_process = multiprocessing.Process(target=_run_controller,
-                                                     args=(job_id, task_yaml,
+                                                     args=(job_id, dag_yaml,
                                                            retry_until_up))
         controller_process.start()
         while controller_process.is_alive():
             _handle_signal(job_id)
             time.sleep(1)
     except exceptions.SpotUserCancelledError:
         logger.info(f'Cancelling spot job {job_id}...')
@@ -324,53 +415,54 @@
             # killed first, then the controller process will raise errors.
             # Kill any possible remaining children processes recursively.
             subprocess_utils.kill_children_processes(controller_process.pid,
                                                      force=True)
             controller_process.join()
             logger.info(f'Controller process {controller_process.pid} killed.')
 
-        logger.info(f'Cleaning up spot cluster of job {job_id}.')
+        logger.info(f'Cleaning up any spot cluster for job {job_id}.')
         # NOTE: Originally, we send an interruption signal to the controller
         # process and the controller process handles cleanup. However, we
         # figure out the behavior differs from cloud to cloud
         # (e.g., GCP ignores 'SIGINT'). A possible explanation is
         # https://unix.stackexchange.com/questions/356408/strange-problem-with-trap-and-sigint
         # But anyway, a clean solution is killing the controller process
         # directly, and then cleanup the cluster state.
-        _cleanup(job_id, task_yaml=task_yaml)
-        logger.info(f'Spot cluster of job {job_id} has been taken down.')
+        _cleanup(job_id, dag_yaml=dag_yaml)
+        logger.info(f'Spot cluster of job {job_id} has been cleaned up.')
 
         if cancelling:
             spot_state.set_cancelled(job_id)
 
         # We should check job status after 'set_cancelled', otherwise
         # the job status is not terminal.
         job_status = spot_state.get_status(job_id)
+        assert job_status is not None
         # The job can be non-terminal if the controller exited abnormally,
         # e.g. failed to launch cluster after reaching the MAX_RETRY.
-        assert job_status is not None
         if not job_status.is_terminal():
             logger.info(f'Previous spot job status: {job_status.value}')
             spot_state.set_failed(
                 job_id,
+                task_id=None,
                 failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
                 failure_reason=('Unexpected error occurred. For details, '
                                 f'run: sky spot logs --controller {job_id}'))
 
 
 if __name__ == '__main__':
     parser = argparse.ArgumentParser()
     parser.add_argument('--job-id',
                         required=True,
                         type=int,
                         help='Job id for the controller job.')
     parser.add_argument('--retry-until-up',
                         action='store_true',
                         help='Retry until the spot cluster is up.')
-    parser.add_argument('task_yaml',
+    parser.add_argument('dag_yaml',
                         type=str,
                         help='The path to the user spot task yaml file.')
     args = parser.parse_args()
     # We start process with 'spawn', because 'fork' could result in weird
     # behaviors; 'spawn' is also cross-platform.
     multiprocessing.set_start_method('spawn', force=True)
-    start(args.job_id, args.task_yaml, args.retry_until_up)
+    start(args.job_id, args.dag_yaml, args.retry_until_up)
```

### Comparing `skypilot-0.3.1/sky/spot/recovery_strategy.py` & `skypilot-0.3.2/sky/spot/recovery_strategy.py`

 * *Files 2% similar despite different names*

```diff
@@ -4,14 +4,15 @@
 import typing
 from typing import Optional, Tuple
 
 import sky
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
+from sky import status_lib
 from sky import backends
 from sky.backends import backend_utils
 from sky.skylet import job_lib
 from sky.spot import spot_utils
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import ux_utils
@@ -95,27 +96,32 @@
             'spot_recovery is required to use spot strategy.')
         # Remove the spot_recovery field from the resources, as the strategy
         # will be handled by the strategy class.
         task.set_resources({resources.copy(spot_recovery=None)})
         return SPOT_STRATEGIES[spot_recovery](cluster_name, backend, task,
                                               retry_until_up)
 
-    def launch(self) -> Optional[float]:
+    def launch(self) -> float:
         """Launch the spot cluster for the first time.
 
         It can fail if resource is not available. Need to check the cluster
         status, after calling.
 
-        Returns: The job's submit timestamp, or None if failed.
+        Returns: The job's submit timestamp, on success (otherwise, an
+            exception is raised).
 
         Raises: Please refer to the docstring of self._launch().
         """
+
         if self.retry_until_up:
-            return self._launch(max_retry=None)
-        return self._launch()
+            job_submit_at = self._launch(max_retry=None)
+        else:
+            job_submit_at = self._launch()
+        assert job_submit_at is not None
+        return job_submit_at
 
     def recover(self) -> float:
         """Relaunch the spot cluster after failure and wait until job starts.
 
         When recover() is called the cluster should be in STOPPED status (i.e.
         partially down).
 
@@ -149,21 +155,20 @@
             # should be functional with the `_try_cancel_if_cluster_is_init`
             # flag, i.e. it sends the cancel signal to the head node, which will
             # then kill the user process on remaining worker nodes.
             sky.cancel(cluster_name=self.cluster_name,
                        all=True,
                        _try_cancel_if_cluster_is_init=True)
         except Exception as e:  # pylint: disable=broad-except
-            logger.info(
-                'Failed to cancel the job on the cluster. The cluster '
-                'might be already down or the head node is preempted.'
-                '\n  Detailed exception: '
-                f'{common_utils.format_exception(e)}\n'
-                'Terminating the cluster again to make sure there is no '
-                'remaining job on the worker nodes.')
+            logger.info('Failed to cancel the job on the cluster. The cluster '
+                        'might be already down or the head node is preempted.'
+                        '\n  Detailed exception: '
+                        f'{common_utils.format_exception(e)}\n'
+                        'Terminating the cluster explicitly to ensure no '
+                        'remaining job process interferes with recovery.')
             terminate_cluster(self.cluster_name)
 
     def _wait_until_job_starts_on_cluster(self) -> Optional[float]:
         """Wait for MAX_JOB_CHECKING_RETRY times until job starts on the cluster
 
         Returns:
             The timestamp of when the job is submitted, or None if failed to
@@ -182,15 +187,15 @@
                 # If any unexpected error happens, retry the job checking
                 # loop.
                 # TODO(zhwu): log the unexpected error to usage collection
                 # for future debugging.
                 logger.info(f'Unexpected exception: {e}\nFailed to get the '
                             'refresh the cluster status. Retrying.')
                 continue
-            if cluster_status != global_user_state.ClusterStatus.UP:
+            if cluster_status != status_lib.ClusterStatus.UP:
                 # The cluster can be preempted before the job is
                 # launched.
                 # Break to let the retry launch kick in.
                 logger.info('The cluster is preempted before the job '
                             'is submitted.')
                 # TODO(zhwu): we should recover the preemption with the
                 # recovery strategy instead of the current while loop.
@@ -222,15 +227,17 @@
                     logger.info(f'Unexpected Exception: {e}\nFailed to get '
                                 'the job start timestamp. Retrying.')
                     continue
             # Wait for the job to be started
             time.sleep(spot_utils.JOB_STARTED_STATUS_CHECK_GAP_SECONDS)
         return None
 
-    def _launch(self, max_retry=3, raise_on_failure=True) -> Optional[float]:
+    def _launch(self,
+                max_retry: Optional[int] = 3,
+                raise_on_failure: bool = True) -> Optional[float]:
         """Implementation of launch().
 
         The function will wait until the job starts running, but will leave the
         handling for the preemption to the caller.
 
         Args:
             max_retry: The maximum number of retries. If None, retry forever.
@@ -359,15 +366,17 @@
         # Note down the cloud/region of the launched cluster, so that we can
         # first retry in the same cloud/region. (Inside recover() we may not
         # rely on cluster handle, as it can be None if the cluster is
         # preempted.)
         self._launched_cloud_region: Optional[Tuple['sky.clouds.Cloud',
                                                     'sky.clouds.Region']] = None
 
-    def _launch(self, max_retry=3, raise_on_failure=True) -> Optional[float]:
+    def _launch(self,
+                max_retry: Optional[int] = 3,
+                raise_on_failure: bool = True) -> Optional[float]:
         job_submitted_at = super()._launch(max_retry, raise_on_failure)
         if job_submitted_at is not None:
             # Only record the cloud/region if the launch is successful.
             handle = global_user_state.get_handle_from_cluster_name(
                 self.cluster_name)
             assert isinstance(handle, backends.CloudVmRayResourceHandle), (
                 'Cluster should be launched.', handle)
```

### Comparing `skypilot-0.3.1/sky/spot/spot_utils.py` & `skypilot-0.3.2/sky/spot/spot_utils.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,30 +1,36 @@
 """User interfaces with managed spot jobs."""
 import collections
 import enum
 import json
 import pathlib
 import shlex
 import time
-from typing import Any, Dict, List, Optional, Tuple
+import typing
+from typing import Any, Dict, List, Optional, Tuple, Union
+from typing_extensions import Literal
 
 import colorama
 import filelock
 
 from sky import backends
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
+from sky import status_lib
 from sky.backends import backend_utils
 from sky.skylet import job_lib
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.spot import spot_state
 from sky.utils import subprocess_utils
 
+if typing.TYPE_CHECKING:
+    from sky import dag as dag_lib
+
 logger = sky_logging.init_logger(__name__)
 
 # Add user hash so that two users don't have the same controller VM on
 # shared-account clouds such as GCP.
 SPOT_CONTROLLER_NAME = f'sky-spot-controller-{common_utils.get_user_hash()}'
 SIGNAL_FILE_PREFIX = '/tmp/sky_spot_controller_signal_{}'
 # Controller checks its job's status every this many seconds.
@@ -33,18 +39,19 @@
 # Controller checks if its job has started every this many seconds.
 JOB_STARTED_STATUS_CHECK_GAP_SECONDS = 5
 
 _SPOT_STATUS_CACHE = '~/.sky/spot_status_cache.txt'
 
 _LOG_STREAM_CHECK_CONTROLLER_GAP_SECONDS = 5
 
-_JOB_WAITING_STATUS_MESSAGE = ('[bold cyan]Waiting for the job to start'
+_JOB_WAITING_STATUS_MESSAGE = ('[bold cyan]Waiting for the task to start'
                                '{status_str}.[/] It may take a few minutes.')
-_JOB_CANCELLED_MESSAGE = ('[bold cyan]Waiting for the job status to be updated.'
-                          '[/] It may take a minute.')
+_JOB_CANCELLED_MESSAGE = (
+    '[bold cyan]Waiting for the task status to be updated.'
+    '[/] It may take a minute.')
 
 # The maximum time to wait for the spot job status to transition to terminal
 # state, after the job finished. This is a safeguard to avoid the case where
 # the spot job status fails to be updated and keep the `sky spot logs` blocking
 # for a long time.
 _FINAL_SPOT_STATUS_WAIT_TIMEOUT_SECONDS = 20
 
@@ -94,38 +101,42 @@
     else:
         job_ids = [job_id]
     for job_id_ in job_ids:
         controller_status = job_lib.get_status(job_id_)
         if controller_status is None or controller_status.is_terminal():
             logger.error(f'Controller for job {job_id_} has exited abnormally. '
                          'Setting the job status to FAILED_CONTROLLER.')
-            task_name = spot_state.get_task_name_by_job_id(job_id_)
-
-            # Tear down the abnormal spot cluster to avoid resource leakage.
-            cluster_name = generate_spot_cluster_name(task_name, job_id_)
-            handle = global_user_state.get_handle_from_cluster_name(
-                cluster_name)
-            if handle is not None:
-                backend = backend_utils.get_backend_from_handle(handle)
-                max_retry = 3
-                for retry_cnt in range(max_retry):
-                    try:
-                        backend.teardown(handle, terminate=True)
-                        break
-                    except RuntimeError:
-                        logger.error('Failed to tear down the spot cluster '
-                                     f'{cluster_name!r}. Retrying '
-                                     f'[{retry_cnt}/{max_retry}].')
+            tasks = spot_state.get_spot_jobs(job_id_)
+            for task in tasks:
+                task_name = task['job_name']
+                # Tear down the abnormal spot cluster to avoid resource leakage.
+                cluster_name = generate_spot_cluster_name(task_name, job_id_)
+                handle = global_user_state.get_handle_from_cluster_name(
+                    cluster_name)
+                if handle is not None:
+                    backend = backend_utils.get_backend_from_handle(handle)
+                    max_retry = 3
+                    for retry_cnt in range(max_retry):
+                        try:
+                            backend.teardown(handle, terminate=True)
+                            break
+                        except RuntimeError:
+                            logger.error('Failed to tear down the spot cluster '
+                                         f'{cluster_name!r}. Retrying '
+                                         f'[{retry_cnt}/{max_retry}].')
 
             # The controller job for this spot job is not running: it must
             # have exited abnormally, and we should set the job status to
             # FAILED_CONTROLLER.
+            # The `set_failed` will only update the task's status if the
+            # status is non-terminal.
             spot_state.set_failed(
                 job_id_,
-                spot_state.SpotStatus.FAILED_CONTROLLER,
+                task_id=None,
+                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
                 failure_reason=
                 'Controller process has exited abnormally. For more details,'
                 f' run: sky spot logs --controller {job_id_}')
 
 
 def get_job_timestamp(backend: 'backends.CloudVmRayBackend', cluster_name: str,
                       get_end_time: bool) -> float:
@@ -155,14 +166,15 @@
 def cancel_jobs_by_id(job_ids: Optional[List[int]]) -> str:
     """Cancel jobs by id.
 
     If job_ids is None, cancel all jobs.
     """
     if job_ids is None:
         job_ids = spot_state.get_nonterminal_job_ids_by_name(None)
+    job_ids = list(set(job_ids))
     if len(job_ids) == 0:
         return 'No job to cancel.'
     job_id_str = ', '.join(map(str, job_ids))
     logger.info(f'Cancelling jobs {job_id_str}.')
     cancelled_job_ids = []
     for job_id in job_ids:
         # Check the status of the managed spot job status. If it is in
@@ -213,17 +225,19 @@
     return f'Job {job_name!r} is scheduled to be cancelled.'
 
 
 def stream_logs_by_id(job_id: int, follow: bool = True) -> str:
     """Stream logs by job id."""
     controller_status = job_lib.get_status(job_id)
     status_msg = ('[bold cyan]Waiting for controller process to be RUNNING '
-                  '{status_str}[/]. It may take a few minutes.')
+                  '{status_str}[/].')
     status_display = log_utils.safe_rich_status(
         status_msg.format(status_str=''))
+    num_tasks = spot_state.get_num_tasks(job_id)
+
     with status_display:
         prev_msg = None
         while (controller_status != job_lib.JobStatus.RUNNING and
                (controller_status is None or
                 not controller_status.is_terminal())):
             status_str = 'None'
             if controller_status is not None:
@@ -249,24 +263,27 @@
                 job_msg = (
                     f'\nFailure reason: {spot_state.get_failure_reason(job_id)}'
                 )
             return (f'{colorama.Fore.YELLOW}'
                     f'Job {job_id} is already in terminal state '
                     f'{spot_job_status.value}. Logs will not be shown.'
                     f'{colorama.Style.RESET_ALL}{job_msg}')
-        task_name = spot_state.get_task_name_by_job_id(job_id)
-        cluster_name = generate_spot_cluster_name(task_name, job_id)
         backend = backends.CloudVmRayBackend()
-        spot_status = spot_state.get_status(job_id)
+        task_id, spot_status = spot_state.get_latest_task_id_status(job_id)
 
-        # spot_status can be None if the controller process just started and has
-        # not updated the spot status yet.
+        # task_id and spot_status can be None if the controller process just
+        # started and the spot status has not set to PENDING yet.
         while spot_status is None or not spot_status.is_terminal():
-            handle = global_user_state.get_handle_from_cluster_name(
-                cluster_name)
+            handle = None
+            if task_id is not None:
+                task_name = spot_state.get_task_name(job_id, task_id)
+                cluster_name = generate_spot_cluster_name(task_name, job_id)
+                handle = global_user_state.get_handle_from_cluster_name(
+                    cluster_name)
+
             # Check the handle: The cluster can be preempted and removed from
             # the table before the spot state is updated by the controller. In
             # this case, we should skip the logging, and wait for the next
             # round of status check.
             if handle is None or spot_status != spot_state.SpotStatus.RUNNING:
                 status_str = ''
                 if (spot_status is not None and
@@ -276,15 +293,16 @@
                     f'INFO: The log is not ready yet{status_str}. '
                     f'Waiting for {JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
                 msg = _JOB_WAITING_STATUS_MESSAGE.format(status_str=status_str)
                 if msg != prev_msg:
                     status_display.update(msg)
                     prev_msg = msg
                 time.sleep(JOB_STATUS_CHECK_GAP_SECONDS)
-                spot_status = spot_state.get_status(job_id)
+                task_id, spot_status = (
+                    spot_state.get_latest_task_id_status(job_id))
                 continue
             assert spot_status is not None
             assert isinstance(handle, backends.CloudVmRayResourceHandle), handle
             status_display.stop()
             returncode = backend.tail_logs(handle,
                                            job_id=None,
                                            spot_job_id=job_id,
@@ -294,15 +312,35 @@
                 # SUCCEEDED or FAILED), we can safely break the loop. We use the
                 # status in job queue to show the information, as the spot_state
                 # is not updated yet.
                 job_statuses = backend.get_job_status(handle, stream_logs=False)
                 job_status = list(job_statuses.values())[0]
                 assert job_status is not None, 'No job found.'
                 if job_status != job_lib.JobStatus.CANCELLED:
-                    break
+                    assert task_id is not None, job_id
+                    if task_id < num_tasks - 1 and follow:
+                        # The log for the current job is finished. We need to
+                        # wait until next job to be started.
+                        logger.debug(
+                            f'INFO: Log for the current task ({task_id}) '
+                            'is finished. Waiting for the next task\'s log '
+                            'to be started.')
+                        status_display.update('Waiting for the next task: '
+                                              f'{task_id + 1}.')
+                        status_display.start()
+                        original_task_id = task_id
+                        while True:
+                            task_id, spot_status = (
+                                spot_state.get_latest_task_id_status(job_id))
+                            if original_task_id != task_id:
+                                break
+                            time.sleep(JOB_STATUS_CHECK_GAP_SECONDS)
+                        continue
+                    else:
+                        break
                 # The job can be cancelled by the user or the controller (when
                 # the cluster is partially preempted).
                 logger.debug(
                     'INFO: Job is cancelled. Waiting for the status update in '
                     f'{JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
             else:
                 logger.debug(
@@ -376,104 +414,209 @@
         else:
             # When job_start_at <= 0, that means the last_recovered_at is not
             # set yet, i.e. the job is not started.
             job_duration = 0
         job['job_duration'] = job_duration
         job['status'] = job['status'].value
 
-        cluster_name = generate_spot_cluster_name(job['job_name'],
+        cluster_name = generate_spot_cluster_name(job['task_name'],
                                                   job['job_id'])
         handle = global_user_state.get_handle_from_cluster_name(cluster_name)
         if handle is not None:
             assert isinstance(handle, backends.CloudVmRayResourceHandle)
             job['cluster_resources'] = (
                 f'{handle.launched_nodes}x {handle.launched_resources}')
             job['region'] = handle.launched_resources.region
         else:
+            # FIXME(zongheng): display the last cached values for these.
             job['cluster_resources'] = '-'
             job['region'] = '-'
 
     return common_utils.encode_payload(jobs)
 
 
 def load_spot_job_queue(payload: str) -> List[Dict[str, Any]]:
     """Load job queue from json string."""
     jobs = common_utils.decode_payload(payload)
     for job in jobs:
         job['status'] = spot_state.SpotStatus(job['status'])
     return jobs
 
 
-def format_job_table(jobs: List[Dict[str, Any]],
+@typing.overload
+def format_job_table(tasks: List[Dict[str, Any]],
                      show_all: bool,
+                     return_rows: Literal[False] = False,
                      max_jobs: Optional[int] = None) -> str:
+    ...
+
+
+@typing.overload
+def format_job_table(tasks: List[Dict[str, Any]],
+                     show_all: bool,
+                     return_rows: Literal[True],
+                     max_jobs: Optional[int] = None) -> List[List[str]]:
+    ...
+
+
+def format_job_table(
+        tasks: List[Dict[str, Any]],
+        show_all: bool,
+        return_rows: bool = False,
+        max_jobs: Optional[int] = None) -> Union[str, List[List[str]]]:
     """Returns spot jobs as a formatted string.
 
     Args:
         jobs: A list of spot jobs.
         show_all: Whether to show all columns.
         max_jobs: The maximum number of jobs to show in the table.
+        return_rows: If True, return the rows as a list of strings instead of
+          all rows concatenated into a single string.
+
+    Returns: A formatted string of spot jobs, if not `return_rows`; otherwise a
+      list of "rows" (each of which is a list of str).
     """
     columns = [
-        'ID', 'NAME', 'RESOURCES', 'SUBMITTED', 'TOT. DURATION', 'JOB DURATION',
-        '#RECOVERIES', 'STATUS'
+        'ID', 'TASK', 'NAME', 'RESOURCES', 'SUBMITTED', 'TOT. DURATION',
+        'JOB DURATION', '#RECOVERIES', 'STATUS'
     ]
     if show_all:
         columns += ['STARTED', 'CLUSTER', 'REGION', 'FAILURE']
     job_table = log_utils.create_table(columns)
 
     status_counts: Dict[str, int] = collections.defaultdict(int)
-    for job in jobs:
-        if not job['status'].is_terminal():
-            status_counts[job['status'].value] += 1
+    for task in tasks:
+        if not task['status'].is_terminal():
+            status_counts[task['status'].value] += 1
 
+    all_tasks = tasks
     if max_jobs is not None:
-        jobs = jobs[:max_jobs]
-    for job in jobs:
-        # The job['job_duration'] is already calculated in
-        # dump_spot_job_queue().
-        job_duration = log_utils.readable_time_duration(0,
-                                                        job['job_duration'],
-                                                        absolute=True)
-        submitted = log_utils.readable_time_duration(job['submitted_at'])
-        values = [
-            job['job_id'],
-            job['job_name'],
-            job['resources'],
-            # SUBMITTED
-            submitted if submitted != '-' else submitted,
-            # TOT. DURATION
-            log_utils.readable_time_duration(job['submitted_at'],
-                                             job['end_at'],
-                                             absolute=True),
-            job_duration,
-            job['recovery_count'],
-            job['status'].colored_str(),
-        ]
-        if show_all:
-            values.extend([
-                # STARTED
-                log_utils.readable_time_duration(job['start_at']),
-                job['cluster_resources'],
-                job['region'],
-                job['failure_reason']
-                if job['failure_reason'] is not None else '-',
-            ])
-        job_table.add_row(values)
-
+        all_tasks = tasks[:max_jobs]
+    jobs = collections.defaultdict(list)
+    for task in all_tasks:
+        # The tasks within the same job_id are already sorted
+        # by the task_id.
+        jobs[task['job_id']].append(task)
+
+    for job_id, job_tasks in jobs.items():
+        if len(job_tasks) > 1:
+            # Aggregate the tasks into a new row in the table.
+            job_name = job_tasks[0]['job_name']
+            job_duration = 0
+            submitted_at = None
+            end_at: Optional[int] = 0
+            recovery_cnt = 0
+            spot_status = spot_state.SpotStatus.SUCCEEDED
+            failure_reason = None
+            current_task_id = len(job_tasks) - 1
+            for task in job_tasks:
+                job_duration += task['job_duration']
+                if task['submitted_at'] is not None:
+                    if (submitted_at is None or
+                            submitted_at > task['submitted_at']):
+                        submitted_at = task['submitted_at']
+                if task['end_at'] is not None:
+                    if end_at is not None and end_at < task['end_at']:
+                        end_at = task['end_at']
+                else:
+                    end_at = None
+                recovery_cnt += task['recovery_count']
+                if spot_status == spot_state.SpotStatus.SUCCEEDED:
+                    # Use the first non-succeeded status.
+                    # TODO(zhwu): we should not blindly use the first non-
+                    # succeeded as the status could be changed to SUBMITTED
+                    # when going from one task to the next one, which can be
+                    # confusing.
+                    spot_status = task['status']
+                    current_task_id = task['task_id']
+
+                if (failure_reason is None and
+                        task['status'] > spot_state.SpotStatus.SUCCEEDED):
+                    failure_reason = task['failure_reason']
+
+            job_duration = log_utils.readable_time_duration(0,
+                                                            job_duration,
+                                                            absolute=True)
+            submitted = log_utils.readable_time_duration(submitted_at)
+            total_duration = log_utils.readable_time_duration(submitted_at,
+                                                              end_at,
+                                                              absolute=True)
+
+            status_str = spot_status.colored_str()
+            if (spot_status < spot_state.SpotStatus.RUNNING and
+                    current_task_id > 0):
+                status_str += f' (task: {current_task_id})'
+
+            job_values = [
+                job_id,
+                '',
+                job_name,
+                '-',
+                submitted,
+                total_duration,
+                job_duration,
+                recovery_cnt,
+                status_str,
+            ]
+            if show_all:
+                job_values.extend([
+                    '-',
+                    '-',
+                    '-',
+                    failure_reason if failure_reason is not None else '-',
+                ])
+            job_table.add_row(job_values)
+
+        for task in job_tasks:
+            # The job['job_duration'] is already calculated in
+            # dump_spot_job_queue().
+            job_duration = log_utils.readable_time_duration(
+                0, task['job_duration'], absolute=True)
+            submitted = log_utils.readable_time_duration(task['submitted_at'])
+            values = [
+                task['job_id'] if len(job_tasks) == 1 else ' \u21B3',
+                task['task_id'] if len(job_tasks) > 1 else '-',
+                task['task_name'],
+                task['resources'],
+                # SUBMITTED
+                submitted if submitted != '-' else submitted,
+                # TOT. DURATION
+                log_utils.readable_time_duration(task['submitted_at'],
+                                                 task['end_at'],
+                                                 absolute=True),
+                job_duration,
+                task['recovery_count'],
+                task['status'].colored_str(),
+            ]
+            if show_all:
+                values.extend([
+                    # STARTED
+                    log_utils.readable_time_duration(task['start_at']),
+                    task['cluster_resources'],
+                    task['region'],
+                    task['failure_reason']
+                    if task['failure_reason'] is not None else '-',
+                ])
+            job_table.add_row(values)
+
+        if len(job_tasks) > 1:
+            # Add a row to separate the aggregated job from the next job.
+            job_table.add_row([''] * len(columns))
     status_str = ', '.join([
         f'{count} {status}' for status, count in sorted(status_counts.items())
     ])
     if status_str:
         status_str = f'In progress jobs: {status_str}'
     else:
         status_str = 'No in progress jobs.'
     output = status_str
     if str(job_table):
         output += f'\n{job_table}'
+    if return_rows:
+        return job_table.rows
     return output
 
 
 class SpotCodeGen:
     """Code generator for managed spot job utility functions.
 
     Usage:
@@ -527,14 +670,31 @@
             'else spot_state.get_latest_job_id()',
             f'msg = spot_utils.stream_logs_by_id(job_id, follow={follow})',
             'print(msg, flush=True)',
         ]
         return cls._build(code)
 
     @classmethod
+    def set_pending(cls, job_id: int, spot_dag: 'dag_lib.Dag') -> str:
+        dag_name = spot_dag.name
+        # Add the spot job to spot queue table.
+        code = [
+            f'spot_state.set_job_name('
+            f'{job_id}, {dag_name!r})',
+        ]
+        for task_id, task in enumerate(spot_dag.tasks):
+            resources_str = backend_utils.get_task_resources_str(task)
+            code += [
+                f'spot_state.set_pending('
+                f'{job_id}, {task_id}, {task.name!r}, '
+                f'{resources_str!r})',
+            ]
+        return cls._build(code)
+
+    @classmethod
     def _build(cls, code: List[str]) -> str:
         code = cls._PREFIX + code
         generated_code = '; '.join(code)
         return f'python3 -u -c {shlex.quote(generated_code)}'
 
 
 def dump_job_table_cache(job_table: str):
@@ -558,22 +718,27 @@
         return None
     with cache_file.open('r') as f:
         return json.load(f)
 
 
 def is_spot_controller_up(
     stopped_message: str,
-) -> Tuple[Optional[global_user_state.ClusterStatus],
+    non_existent_message: str = 'No managed spot jobs are found.',
+) -> Tuple[Optional[status_lib.ClusterStatus],
            Optional['backends.CloudVmRayResourceHandle']]:
     """Check if the spot controller is up.
 
     It can be used to check the actual controller status (since the autostop is
     set for the controller) before the spot commands interact with the
     controller.
 
+    Args:
+        stopped_message: Message to print if the controller is STOPPED.
+        non_existent_message: Message to show if the controller does not exist.
+
     Returns:
         controller_status: The status of the spot controller. If it fails during
           refreshing the status, it will be the cached status. None if the
           controller does not exist.
         handle: The ResourceHandle of the spot controller. None if the
           controller is not UP or does not exist.
 
@@ -602,18 +767,18 @@
             f'  Details: {common_utils.format_exception(e, use_bracket=True)}')
         record = global_user_state.get_cluster_from_name(SPOT_CONTROLLER_NAME)
         controller_status, handle = None, None
         if record is not None:
             controller_status, handle = record['status'], record['handle']
 
     if controller_status is None:
-        sky_logging.print('No managed spot jobs are found.')
-    elif controller_status != global_user_state.ClusterStatus.UP:
+        sky_logging.print(non_existent_message)
+    elif controller_status != status_lib.ClusterStatus.UP:
         msg = (f'Spot controller {SPOT_CONTROLLER_NAME} '
                f'is {controller_status.value}.')
-        if controller_status == global_user_state.ClusterStatus.STOPPED:
+        if controller_status == status_lib.ClusterStatus.STOPPED:
             msg += f'\n{stopped_message}'
-        if controller_status == global_user_state.ClusterStatus.INIT:
+        if controller_status == status_lib.ClusterStatus.INIT:
             msg += '\nPlease wait for the controller to be ready.'
         sky_logging.print(msg)
         handle = None
     return controller_status, handle
```

### Comparing `skypilot-0.3.1/sky/task.py` & `skypilot-0.3.2/sky/task.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,9 +1,10 @@
 """Task: a coarse-grained stage in an application."""
 import inspect
+import json
 import os
 import re
 import typing
 from typing import Any, Callable, Dict, List, Optional, Set, Tuple, Union
 
 import yaml
 
@@ -64,14 +65,48 @@
 
 
 def _is_valid_env_var(name: str) -> bool:
     """Checks if the task environment variable name is valid."""
     return bool(re.fullmatch(_VALID_ENV_VAR_REGEX, name))
 
 
+def _fill_in_env_vars_in_file_mounts(
+    file_mounts: Dict[str, Any],
+    task_envs: Dict[str, str],
+) -> Dict[str, Any]:
+    """Detects env vars in file_mounts and fills them with task_envs.
+
+    Use cases of env vars in file_mounts:
+    - dst/src paths; e.g.,
+        /model_path/llama-${SIZE}b: s3://llama-weights/llama-${SIZE}b
+    - storage's name (bucket name)
+    - storage's source (local path)
+
+    We simply dump file_mounts into a json string, and replace env vars using
+    regex. This should be safe as file_mounts has been schema-validated.
+
+    Env vars of the following forms are detected:
+        - ${ENV}
+        - $ENV
+    where <ENV> must appear in task.envs.
+    """
+    # TODO(zongheng): support ${ENV:-default}?
+    file_mounts_str = json.dumps(file_mounts)
+
+    def replace_var(match):
+        var_name = match.group(1)
+        # If the variable isn't in the dictionary, return it unchanged
+        return task_envs.get(var_name, match.group(0))
+
+    # Pattern for valid env var names in bash.
+    pattern = r'\$\{?\b([a-zA-Z_][a-zA-Z0-9_]*)\b\}?'
+    file_mounts_str = re.sub(pattern, replace_var, file_mounts_str)
+    return json.loads(file_mounts_str)
+
+
 class Task:
     """Task: a computation to be run on the cloud."""
 
     def __init__(
         self,
         name: Optional[str] = None,
         *,
@@ -157,17 +192,17 @@
         self.estimated_outputs_size_gigabytes = None
         # Default to CPUNode
         self.resources = {sky.Resources()}
         self.time_estimator_func: Optional[Callable[['sky.Resources'],
                                                     int]] = None
         self.file_mounts: Optional[Dict[str, str]] = None
 
-        # Only set when 'self' is a spot controller task: 'self.spot_task' is
-        # the underlying managed spot task (Task object).
-        self.spot_task: Optional['Task'] = None
+        # Only set when 'self' is a spot controller task: 'self.spot_dag' is
+        # the underlying managed spot dag (sky.Dag object).
+        self.spot_dag: Optional['sky.Dag'] = None
 
         # Filled in by the optimizer.  If None, this Task is not planned.
         self.best_resources = None
         # Check if the task is legal.
         self._validate()
 
         dag = sky.dag.get_current_dag()
@@ -227,46 +262,45 @@
                 # Symlink to a dir is legal (isdir() follows symlinks).
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         'Workdir must exist and must be a directory (or '
                         f'a symlink to a directory). {self.workdir} not found.')
 
     @staticmethod
-    def from_yaml(yaml_path: str) -> 'Task':
-        """Initializes a task from a task YAML.
-
-        Example:
-            .. code-block:: python
-
-                task = sky.Task.from_yaml('/path/to/task.yaml')
-
-        Args:
-          yaml_path: file path to a valid task yaml file.
-
-        Raises:
-          ValueError: if the path gets loaded into a str instead of a dict; or
-            if there are any other parsing errors.
-        """
-        with open(os.path.expanduser(yaml_path), 'r') as f:
-            # TODO(zongheng): use
-            #  https://github.com/yaml/pyyaml/issues/165#issuecomment-430074049
-            # to raise errors on duplicate keys.
-            config = yaml.safe_load(f)
-
-        if isinstance(config, str):
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError('YAML loaded as str, not as dict. '
-                                 f'Is it correct? Path: {yaml_path}')
-
-        if config is None:
-            config = {}
+    def from_yaml_config(
+        config: Dict[str, Any],
+        env_overrides: Optional[List[Tuple[str, str]]] = None,
+    ) -> 'Task':
+        if env_overrides is not None:
+            # We must override env vars before constructing the Task, because
+            # the Storage object creation is eager and it (its name/source
+            # fields) may depend on env vars.
+            #
+            # FIXME(zongheng): The eagerness / how we construct Task's from
+            # entrypoint (YAML, CLI args) should be fixed.
+            new_envs = config.get('envs', {})
+            new_envs.update(env_overrides)
+            config['envs'] = new_envs
+
+        # More robust handling for 'envs': explicitly convert keys and values to
+        # str, since users may pass '123' as keys/values which will get parsed
+        # as int causing validate_schema() to fail.
+        envs = config.get('envs')
+        if envs is not None and isinstance(envs, dict):
+            config['envs'] = {str(k): str(v) for k, v in envs.items()}
 
         backend_utils.validate_schema(config, schemas.get_task_schema(),
                                       'Invalid task YAML: ')
 
+        # Fill in any Task.envs into file_mounts (src/dst paths, storage
+        # name/source).
+        if config.get('file_mounts') is not None:
+            config['file_mounts'] = _fill_in_env_vars_in_file_mounts(
+                config['file_mounts'], config.get('envs', {}))
+
         task = Task(
             config.pop('name', None),
             run=config.pop('run', None),
             workdir=config.pop('workdir', None),
             setup=config.pop('setup', None),
             num_nodes=config.pop('num_nodes', None),
             envs=config.pop('envs', None),
@@ -293,16 +327,15 @@
                                          f'{dst_path}:{src}')
             task.set_file_mounts(copy_mounts)
 
         task_storage_mounts: Dict[str, storage_lib.Storage] = {}
         all_storages = fm_storages
         for storage in all_storages:
             mount_path = storage[0]
-            assert mount_path, \
-                'Storage mount path cannot be empty.'
+            assert mount_path, 'Storage mount path cannot be empty.'
             try:
                 storage_obj = storage_lib.Storage.from_yaml_config(storage[1])
             except exceptions.StorageSourceError as e:
                 # Patch the error message to include the mount path, if included
                 e.args = (e.args[0].replace('<destination_path>',
                                             mount_path),) + e.args[1:]
                 raise e
@@ -329,14 +362,45 @@
         resources = config.pop('resources', None)
         resources = sky.Resources.from_yaml_config(resources)
 
         task.set_resources({resources})
         assert not config, f'Invalid task args: {config.keys()}'
         return task
 
+    @staticmethod
+    def from_yaml(yaml_path: str) -> 'Task':
+        """Initializes a task from a task YAML.
+
+        Example:
+            .. code-block:: python
+
+                task = sky.Task.from_yaml('/path/to/task.yaml')
+
+        Args:
+          yaml_path: file path to a valid task yaml file.
+
+        Raises:
+          ValueError: if the path gets loaded into a str instead of a dict; or
+            if there are any other parsing errors.
+        """
+        with open(os.path.expanduser(yaml_path), 'r') as f:
+            # TODO(zongheng): use
+            #  https://github.com/yaml/pyyaml/issues/165#issuecomment-430074049
+            # to raise errors on duplicate keys.
+            config = yaml.safe_load(f)
+
+        if isinstance(config, str):
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('YAML loaded as str, not as dict. '
+                                 f'Is it correct? Path: {yaml_path}')
+
+        if config is None:
+            config = {}
+        return Task.from_yaml_config(config)
+
     @property
     def num_nodes(self) -> int:
         return self._num_nodes
 
     @num_nodes.setter
     def num_nodes(self, num_nodes: Optional[int]) -> None:
         if num_nodes is None:
@@ -642,15 +706,15 @@
 
     def update_storage_mounts(
             self, storage_mounts: Dict[str, storage_lib.Storage]) -> 'Task':
         """Updates the storage mounts for this task.
 
         Different from set_storage_mounts(), this function updates into the
         existing storage_mounts (calls ``dict.update()``), rather than
-        overwritting it.
+        overwriting it.
 
         This should be called before provisioning in order to take effect.
 
         Args:
           storage_mounts: an optional dict of ``{mount_path: sky.Storage
             object}``, where mount_path is the path inside the remote VM(s)
             where the Storage object will be mounted on.
```

### Comparing `skypilot-0.3.1/sky/templates/aws-ray.yml.j2` & `skypilot-0.3.2/sky/templates/aws-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/templates/azure-ray.yml.j2` & `skypilot-0.3.2/sky/templates/azure-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/templates/gcp-ray.yml.j2` & `skypilot-0.3.2/sky/templates/gcp-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/templates/ibm-ray.yml.j2` & `skypilot-0.3.2/sky/templates/ibm-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/templates/lambda-ray.yml.j2` & `skypilot-0.3.2/sky/templates/lambda-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/templates/local-ray.yml.j2` & `skypilot-0.3.2/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/templates/spot-controller.yaml.j2` & `skypilot-0.3.2/sky/templates/spot-controller.yaml.j2`

 * *Files 26% similar despite different names*

```diff
@@ -1,57 +1,53 @@
 # The template for the spot controller
 
-name: {{task_name}}
-
-resources:
-  disk_size: 50
-# It is now using default CPU instance type hard-coded in code for spot controller,
-# i.e. m6i.2xlarge (8vCPUs, 32 GB) for AWS, Standard_D8s_v4 (8vCPUs, 32 GB) for Azure, and n1-highmem-8 (8 vCPUs, 52 GB) for GCP.
-# This allows users without the credits for some of the clouds available to use managed spot instances.
-# TODO(zhwu): Fix this to be able to failvoer across clouds with cheaper instance.
-#  instance_type: t3.xlarge
+name: {{dag_name}}
 
 file_mounts:
-  {{remote_user_yaml_prefix}}/{{task_name}}-{{uuid}}.yaml: {{user_yaml_path}}
+  {{remote_user_yaml_prefix}}/{{dag_name}}-{{uuid}}.yaml: {{user_yaml_path}}
 {% if user_config_path is not none %}
-  {{remote_user_yaml_prefix}}/{{task_name}}-{{uuid}}.config_yaml: {{user_config_path}}
+  {{remote_user_yaml_prefix}}/{{dag_name}}-{{uuid}}.config_yaml: {{user_config_path}}
 {% endif %}
 
 setup: |
   # Install cli dependencies
   # Not using SkyPilot wheels because the wheel can be cleaned up by another process.
   # TODO(zhwu): Keep the dependencies align with the ones in setup.py
-  echo Check and install AWS SDK
   (pip list | grep boto3 > /dev/null 2>&1 && \
    pip list | grep google-api-python-client > /dev/null 2>&1 ) || \
    pip install boto3 awscli pycryptodome==3.12.0 google-api-python-client google-cloud-storage 2>&1 > /dev/null
 
   # We do not install azure dependencies for now since our subscription does not support spot instances.
   # pip list | grep azure-cli > /dev/null 2>&1 || \
   #  pip3 install azure-cli==2.31.0 azure-core
-  echo Check and install Google SDK
   {{google_sdk_installation_commands}}
 
+  pip list | grep oci  > /dev/null 2>&1 || pip install oci 2>&1 > /dev/null
+
   # Internal: disable logging for manually logging into the spot controller for debugging.
   {% if is_dev %}
   echo 'export SKYPILOT_DEV=1' >> ~/.bashrc
   {% endif %}
 
+  # Dashboard.
+  pip list | grep flask  > /dev/null 2>&1 || pip install flask 2>&1 > /dev/null
+  ((ps aux | grep -v nohup | grep -v grep | grep -q -- "python3 -m sky.spot.dashboard.dashboard") || (nohup python3 -m sky.spot.dashboard.dashboard >> ~/.sky/spot-dashboard.log 2>&1 &));
+
 run: |
   python -u -m sky.spot.controller \
-    {{remote_user_yaml_prefix}}/{{task_name}}-{{uuid}}.yaml \
+    {{remote_user_yaml_prefix}}/{{dag_name}}-{{uuid}}.yaml \
     --job-id $SKYPILOT_INTERNAL_JOB_ID {% if retry_until_up %}--retry-until-up{% endif %}
 
 envs:
   SKYPILOT_USAGE_USER_ID: {{logging_user_hash}}
   # skip cloud identity check for spot controller to avoid the overhead.
   SKYPILOT_SKIP_CLOUD_IDENTITY_CHECK: 1
   SKYPILOT_USER: {{user}}
 {% if user_config_path is not none %}
-  {{env_var_skypilot_config}}: {{remote_user_yaml_prefix}}/{{task_name}}-{{uuid}}.config_yaml
+  {{env_var_skypilot_config}}: {{remote_user_yaml_prefix}}/{{dag_name}}-{{uuid}}.config_yaml
 {% endif %}
 {% if is_dev %}
   SKYPILOT_DEV: 1
 {% endif %}
 {% if is_debug %}
   SKYPILOT_DEBUG: 1
 {% endif %}
```

### Comparing `skypilot-0.3.1/sky/usage/constants.py` & `skypilot-0.3.2/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/usage/usage_lib.py` & `skypilot-0.3.2/sky/usage/usage_lib.py`

 * *Files 1% similar despite different names*

```diff
@@ -17,15 +17,15 @@
 import sky
 from sky import sky_logging
 from sky.usage import constants
 from sky.utils import common_utils
 from sky.utils import env_options
 
 if typing.TYPE_CHECKING:
-    from sky import global_user_state
+    from sky import status_lib
     from sky import resources as resources_lib
     from sky import task as task_lib
 
 logger = sky_logging.init_logger(__name__)
 
 
 def _get_current_timestamp_ns() -> int:
@@ -117,14 +117,15 @@
         self._original_cluster_status_specified: Optional[
             bool] = False  # update_cluster_status
         self.final_cluster_status: Optional[
             str] = None  # update_final_cluster_status
         #: Whether the cluster is newly launched.
         self.is_new_cluster: bool = False  # set_new_cluster
 
+        self.task_id: Optional[int] = None  # update_task_id
         # Task requested
         #: The number of nodes requested by the task.
         #: Requested cloud
         self.task_cloud: Optional[str] = None  # update_actual_task
         #: Requested region
         self.task_region: Optional[str] = None  # update_actual_task
         #: Requested zone
@@ -139,16 +140,18 @@
         self.task_use_spot: Optional[bool] = None  # update_actual_task
         #: Requested resources
         self.task_resources: Optional[Dict[str,
                                            Any]] = None  # update_actual_task
         #: Requested number of nodes
         self.task_num_nodes: Optional[int] = None  # update_actual_task
         # YAMLs converted to JSON.
-        self.user_task_yaml: Optional[str] = None  # update_user_task_yaml
-        self.actual_task: Optional[Dict[str, Any]] = None  # update_actual_task
+        self.user_task_yaml: Optional[List[Dict[
+            str, Any]]] = None  # update_user_task_yaml
+        self.actual_task: Optional[List[Dict[str,
+                                             Any]]] = None  # update_actual_task
         self.ray_yamls: Optional[List[Dict[str, Any]]] = None
         #: Number of Ray YAML files.
         self.num_tried_regions: Optional[int] = None  # update_ray_yaml
         self.runtimes: Dict[str, float] = {}  # update_runtime
         self.stacktrace: Optional[str] = None  # entrypoint_context
 
     def __repr__(self) -> str:
@@ -187,18 +190,21 @@
                 if len(resources.accelerators) > 1:
                     logger.debug('Multiple accelerators are not supported: '
                                  f'{resources.accelerators}.')
                 self.task_accelerators = list(resources.accelerators.keys())[0]
                 self.task_num_accelerators = resources.accelerators[
                     self.task_accelerators]
 
+    def update_task_id(self, task_id: int):
+        self.task_id = task_id
+
     def update_ray_yaml(self, yaml_config_or_path: Union[Dict, str]):
         if self.ray_yamls is None:
             self.ray_yamls = []
-        self.ray_yamls.append(
+        self.ray_yamls.extend(
             prepare_json_from_yaml_config(yaml_config_or_path))
         self.num_tried_regions = len(self.ray_yamls)
 
     def update_cluster_name(self, cluster_name: Union[List[str], str]):
         if isinstance(cluster_name, str):
             self.cluster_names = [cluster_name]
         else:
@@ -226,32 +232,32 @@
         self.resources = resources.to_yaml_config()
 
     def update_local_cluster_resources(
             self, local_resources: List['resources_lib.Resources']):
         self.local_resources = [r.to_yaml_config() for r in local_resources]
 
     def update_cluster_status(
-            self, original_status: Optional['global_user_state.ClusterStatus']):
+            self, original_status: Optional['status_lib.ClusterStatus']):
         status = original_status.value if original_status else None
         if not self._original_cluster_status_specified:
             self.original_cluster_status = status
             self._original_cluster_status_specified = True
         self.final_cluster_status = status
 
     def update_final_cluster_status(
-            self, status: Optional['global_user_state.ClusterStatus']):
+            self, status: Optional['status_lib.ClusterStatus']):
         self.final_cluster_status = status.value if status is not None else None
 
     def set_new_cluster(self):
         self.is_new_cluster = True
 
     @contextlib.contextmanager
     def update_runtime_context(self, name: str):
+        start = time.time()
         try:
-            start = time.time()
             yield
         finally:
             self.runtimes[name] = time.time() - start
 
     def update_runtime(self, name_or_fn: str):
         return common_utils.make_decorator(self.update_runtime_context,
                                            name_or_fn)
@@ -347,27 +353,31 @@
                 logger.debug(message)
 
             cleaned_yaml_info[redact_type] = message
 
     return cleaned_yaml_info
 
 
-def prepare_json_from_yaml_config(yaml_config_or_path: Union[Dict, str]):
+def prepare_json_from_yaml_config(
+        yaml_config_or_path: Union[Dict, str]) -> List[Dict[str, Any]]:
     """Upload safe contents of YAML file to Loki."""
     if isinstance(yaml_config_or_path, dict):
-        yaml_info = yaml_config_or_path
+        yaml_info = [yaml_config_or_path]
         comment_lines = []
     else:
         with open(yaml_config_or_path, 'r') as f:
             lines = f.readlines()
             comment_lines = [line for line in lines if line.startswith('#')]
-        yaml_info = common_utils.read_yaml(yaml_config_or_path)
+        yaml_info = common_utils.read_yaml_all(yaml_config_or_path)
 
-    yaml_info = _clean_yaml(yaml_info)
-    yaml_info['__redacted_comment_lines'] = len(comment_lines)
+    for i in range(len(yaml_info)):
+        if yaml_info[i] is None:
+            yaml_info[i] = {}
+        yaml_info[i] = _clean_yaml(yaml_info[i])
+        yaml_info[i]['__redacted_comment_lines'] = len(comment_lines)
     return yaml_info
 
 
 def _send_local_messages():
     """Send all messages not been uploaded to Loki."""
     for msg_type, message in messages.items():
         if not message.message_sent:
```

### Comparing `skypilot-0.3.1/sky/utils/accelerator_registry.py` & `skypilot-0.3.2/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/cli_utils/status_utils.py` & `skypilot-0.3.2/sky/utils/cli_utils/status_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,17 @@
 """Utilities for sky status."""
+import re
 from typing import Any, Callable, Dict, List, Optional
+
 import click
 import colorama
 
 from sky import backends
-from sky import global_user_state
 from sky import spot
+from sky import status_lib
 from sky.backends import backend_utils
 from sky.utils import common_utils
 from sky.utils import log_utils
 
 _COMMAND_TRUNC_LENGTH = 25
 NUM_COST_REPORT_LINES = 5
 
@@ -303,16 +305,15 @@
 _get_region = (
     lambda clusters_status: clusters_status['handle'].launched_resources.region)
 _get_command = (lambda cluster_record: cluster_record['last_use'])
 _get_duration = (lambda cluster_record: log_utils.readable_time_duration(
     0, cluster_record['duration'], absolute=True))
 
 
-def _get_status(
-        cluster_record: _ClusterRecord) -> global_user_state.ClusterStatus:
+def _get_status(cluster_record: _ClusterRecord) -> status_lib.ClusterStatus:
     return cluster_record['status']
 
 
 def _get_status_colored(cluster_record: _ClusterRecord) -> str:
     return _get_status(cluster_record).colored_str()
 
 
@@ -321,14 +322,22 @@
     resources_str = '<initializing>'
     if isinstance(handle, backends.LocalDockerResourceHandle):
         resources_str = 'docker'
     elif isinstance(handle, backends.CloudVmRayResourceHandle):
         if (handle.launched_nodes is not None and
                 handle.launched_resources is not None):
             launched_resource_str = str(handle.launched_resources)
+            # accelerator_args is way too long.
+            # Convert from:
+            #  GCP(n1-highmem-8, {'tpu-v2-8': 1}, accelerator_args={'runtime_version': '2.5.0'}  # pylint: disable=line-too-long
+            # to:
+            #  GCP(n1-highmem-8, {'tpu-v2-8': 1}...)
+            pattern = ', accelerator_args={.*}'
+            launched_resource_str = re.sub(pattern, '...',
+                                           launched_resource_str)
             resources_str = (f'{handle.launched_nodes}x '
                              f'{launched_resource_str}')
     else:
         raise ValueError(f'Unknown handle type {type(handle)} encountered.')
     return resources_str
 
 
@@ -337,31 +346,31 @@
     if zone_str is None:
         zone_str = '-'
     return zone_str
 
 
 def _get_autostop(cluster_record: _ClusterRecord) -> str:
     autostop_str = ''
-    separtion = ''
+    separation = ''
     if cluster_record['autostop'] >= 0:
         # TODO(zhwu): check the status of the autostop cluster.
         autostop_str = str(cluster_record['autostop']) + 'm'
-        separtion = ' '
+        separation = ' '
 
     if cluster_record['to_down']:
-        autostop_str += f'{separtion}(down)'
+        autostop_str += f'{separation}(down)'
     if autostop_str == '':
         autostop_str = '-'
     return autostop_str
 
 
 def _is_pending_autostop(cluster_record: _ClusterRecord) -> bool:
     # autostop < 0 means nothing scheduled.
     return cluster_record['autostop'] >= 0 and _get_status(
-        cluster_record) != global_user_state.ClusterStatus.STOPPED
+        cluster_record) != status_lib.ClusterStatus.STOPPED
 
 
 # ---- 'sky cost-report' helper functions below ----
 
 
 def _get_status_value_for_cost_report(
         cluster_cost_report_record: _ClusterCostReportRecord) -> int:
```

### Comparing `skypilot-0.3.1/sky/utils/command_runner.py` & `skypilot-0.3.2/sky/utils/command_runner.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/common_utils.py` & `skypilot-0.3.2/sky/utils/common_utils.py`

 * *Files 5% similar despite different names*

```diff
@@ -8,15 +8,15 @@
 import os
 import platform
 import random
 import re
 import socket
 import sys
 import time
-from typing import Any, Callable, Dict, Optional, Union
+from typing import Any, Callable, Dict, List, Optional, Union
 import uuid
 import yaml
 
 import colorama
 
 from sky import sky_logging
 
@@ -82,21 +82,26 @@
         user_hash = uuid.uuid4().hex[:USER_HASH_LENGTH]
     os.makedirs(os.path.dirname(_USER_HASH_FILE), exist_ok=True)
     with open(_USER_HASH_FILE, 'w') as f:
         f.write(user_hash)
     return user_hash
 
 
-def get_global_job_id(job_timestamp: str, cluster_name: Optional[str],
-                      job_id: str) -> str:
+def get_global_job_id(job_timestamp: str,
+                      cluster_name: Optional[str],
+                      job_id: str,
+                      task_id: Optional[int] = None) -> str:
     """Returns a unique job run id for each job run.
 
     A job run is defined as the lifetime of a job that has been launched.
     """
-    return f'{job_timestamp}_{cluster_name}_id-{job_id}'
+    global_job_id = f'{job_timestamp}_{cluster_name}_id-{job_id}'
+    if task_id is not None:
+        global_job_id += f'-{task_id}'
+    return global_job_id
 
 
 class Backoff:
     """Exponential backoff with jittering."""
     MULTIPLIER = 1.6
     JITTER = 0.4
 
@@ -170,29 +175,43 @@
 
 def read_yaml(path) -> Dict[str, Any]:
     with open(path, 'r') as f:
         config = yaml.safe_load(f)
     return config
 
 
+def read_yaml_all(path: str) -> List[Dict[str, Any]]:
+    with open(path, 'r') as f:
+        config = yaml.safe_load_all(f)
+        configs = list(config)
+        if not configs:
+            # Empty YAML file.
+            return [{}]
+        return configs
+
+
 def dump_yaml(path, config) -> None:
     with open(path, 'w') as f:
         f.write(dump_yaml_str(config))
 
 
 def dump_yaml_str(config):
     # https://github.com/yaml/pyyaml/issues/127
     class LineBreakDumper(yaml.SafeDumper):
 
         def write_line_break(self, data=None):
             super().write_line_break(data)
             if len(self.indents) == 1:
                 super().write_line_break()
 
-    return yaml.dump(config,
+    if isinstance(config, list):
+        dump_func = yaml.dump_all
+    else:
+        dump_func = yaml.dump
+    return dump_func(config,
                      Dumper=LineBreakDumper,
                      sort_keys=False,
                      default_flow_style=False)
 
 
 def make_decorator(cls, name_or_fn: Union[str, Callable], **ctx_kwargs):
     """Make the cls a decorator.
@@ -359,7 +378,25 @@
         logger.debug(f'Tried to remove {path} but failed to find it. Skip.')
         pass
 
 
 def is_wsl() -> bool:
     """Detect if running under Windows Subsystem for Linux (WSL)."""
     return 'microsoft' in platform.uname()[3].lower()
+
+
+def find_free_port(start_port: int) -> int:
+    """Finds first free local port starting with 'start_port'.
+
+    Returns: a free local port.
+
+    Raises:
+      OSError: If no free ports are available.
+    """
+    for port in range(start_port, 65535):
+        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
+            try:
+                s.bind(('', port))
+                return port
+            except OSError:
+                pass
+    raise OSError('No free ports available.')
```

### Comparing `skypilot-0.3.1/sky/utils/env_options.py` & `skypilot-0.3.2/sky/utils/env_options.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/log_utils.py` & `skypilot-0.3.2/sky/utils/log_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/schemas.py` & `skypilot-0.3.2/sky/utils/schemas.py`

 * *Files 5% similar despite different names*

```diff
@@ -166,15 +166,21 @@
             },
             'run': {
                 'type': 'string',
             },
             'envs': {
                 'type': 'object',
                 'required': [],
-                'additionalProperties': True,
+                'patternProperties': {
+                    # Checks env keys are valid env var names.
+                    '^[a-zA-Z_][a-zA-Z0-9_]*$': {
+                        'type': 'string'
+                    }
+                },
+                'additionalProperties': False,
             },
             # inputs and outputs are experimental
             'inputs': {
                 'type': 'object',
                 'required': [],
                 'maxProperties': 1,
                 'additionalProperties': {
```

### Comparing `skypilot-0.3.1/sky/utils/timeline.py` & `skypilot-0.3.2/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/tpu_utils.py` & `skypilot-0.3.2/sky/utils/tpu_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/ux_utils.py` & `skypilot-0.3.2/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/sky/utils/validator.py` & `skypilot-0.3.2/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/skypilot.egg-info/PKG-INFO` & `skypilot-0.3.2/skypilot.egg-info/PKG-INFO`

 * *Files 6% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: skypilot
-Version: 0.3.1
+Version: 0.3.2
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
@@ -20,14 +20,16 @@
 Provides-Extra: aws
 Provides-Extra: azure
 Provides-Extra: gcp
 Provides-Extra: ibm
 Provides-Extra: docker
 Provides-Extra: lambda
 Provides-Extra: cloudflare
+Provides-Extra: scp
+Provides-Extra: oci
 Provides-Extra: all
 License-File: LICENSE
 
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/skypilot-wide-light-1k.png" width=55%>
 </p>
 
@@ -48,39 +50,45 @@
 
 
 <h3 align="center">
     Run jobs on any cloud, easily and cost effectively
 </h3>
 
 ----
-:fire: :dromedary_camel: *News* :dromedary_camel: :fire: 
+:fire: *News* :fire:
+- [June, 2023] Serving LLM **24x Faster On the Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
+- [June, 2023] [**Two new clouds supported**](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung SCP and Oracle OCI!
 - [April, 2023] **[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the Vicuna model with a single command**!
 - [March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!** 
 - [March, 2023] *Serve* your own LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama)
 ----
 
 SkyPilot is a framework for easily and cost effectively running ML workloads<sup>[1]</sup> on any cloud. 
 
 SkyPilot abstracts away the cloud infra burden:
-- Launch jobs & clusters on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung)
+- Launch jobs & clusters on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung, OCI)
 - Find scarce resources across zones/regions/clouds
 - Queue jobs & use cloud object stores
 
 SkyPilot cuts your cloud costs:
 * [Managed Spot](https://skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): **3x cost savings** using spot VMs, with auto-recovery from preemptions
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters 
 * [Benchmark](https://skypilot.readthedocs.io/en/latest/reference/benchmark/index.html): find best VM types for your jobs
 * Optimizer: **2x cost savings** by auto-picking best prices across zones/regions/clouds
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes. 
 
 Install with pip or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html):
 ```
-pip install "skypilot[aws,gcp,azure,lambda,ibm,scp]"  # choose your clouds
+pip install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]"  # choose your clouds
 ```
+<p align="center">
+  <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=80%>
+</p>
+
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
 - [Installation](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)
 - [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/quickstart.html)
 - [CLI reference](https://skypilot.readthedocs.io/en/latest/reference/cli.html)
```

#### html2text {}

```diff
@@ -1,73 +1,81 @@
-Metadata-Version: 2.1 Name: skypilot Version: 0.3.1 Summary: SkyPilot: An
+Metadata-Version: 2.1 Name: skypilot Version: 0.3.2 Summary: SkyPilot: An
 intercloud broker for the clouds Author: SkyPilot Team License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot Project-URL:
 Issues, https://github.com/skypilot-org/skypilot/issues Project-URL:
 Discussion, https://github.com/skypilot-org/skypilot/discussions Project-URL:
 Documentation, https://skypilot.readthedocs.io/en/latest/ Classifier:
 Programming Language :: Python :: 3.7 Classifier: Programming Language ::
 Python :: 3.8 Classifier: Programming Language :: Python :: 3.9 Classifier:
 Programming Language :: Python :: 3.10 Classifier: License :: OSI Approved ::
 Apache Software License Classifier: Operating System :: OS Independent
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
 Classifier: Topic :: System :: Distributed Computing Description-Content-Type:
 text/markdown Provides-Extra: aws Provides-Extra: azure Provides-Extra: gcp
 Provides-Extra: ibm Provides-Extra: docker Provides-Extra: lambda Provides-
-Extra: cloudflare Provides-Extra: all License-File: LICENSE
+Extra: cloudflare Provides-Extra: scp Provides-Extra: oci Provides-Extra: all
+License-File: LICENSE
                                   [SkyPilot]
                  [Documentation] [GitHub_Release] [Join_Slack]
          **** Run jobs on any cloud, easily and cost effectively ****
----- :fire: :dromedary_camel: *News* :dromedary_camel: :fire: - [April, 2023]
-**[**SkyPilot YAMLs released**](./llm/vicuna/) for finetuning & serving the
-Vicuna model with a single command**! - [March, 2023] **[Vicuna LLM chatbot]
-(https://lmsys.org/blog/2023-03-30-vicuna/) trained** [**using SkyPilot**](./
-llm/vicuna/) **for $300 on spot instances!** - [March, 2023] *Serve* your own
-LLaMA LLM chatbot (not finetuned) on any cloud: [**example**](./llm/llama-
-chatbots/), [**repo**](https://github.com/skypilot-org/sky-llama) ---- SkyPilot
-is a framework for easily and cost effectively running ML workloads[1] on any
-cloud. SkyPilot abstracts away the cloud infra burden: - Launch jobs & clusters
-on any cloud (AWS, Azure, GCP, Lambda Cloud, IBM, Samsung) - Find scarce
-resources across zones/regions/clouds - Queue jobs & use cloud object stores
-SkyPilot cuts your cloud costs: * [Managed Spot](https://
-skypilot.readthedocs.io/en/latest/examples/spot-jobs.html): **3x cost savings**
-using spot VMs, with auto-recovery from preemptions * [Autostop](https://
-skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
-of idle clusters * [Benchmark](https://skypilot.readthedocs.io/en/latest/
-reference/benchmark/index.html): find best VM types for your jobs * Optimizer:
-**2x cost savings** by auto-picking best prices across zones/regions/clouds
-SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code
-changes. Install with pip or [from source](https://skypilot.readthedocs.io/en/
-latest/getting-started/installation.html): ``` pip install "skypilot
-[aws,gcp,azure,lambda,ibm,scp]" # choose your clouds ``` ## Getting Started You
-can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
-- [Installation](https://skypilot.readthedocs.io/en/latest/getting-started/
-installation.html) - [Quickstart](https://skypilot.readthedocs.io/en/latest/
-getting-started/quickstart.html) - [CLI reference](https://
-skypilot.readthedocs.io/en/latest/reference/cli.html) ## SkyPilot in 1 minute A
-SkyPilot task specifies: resource requirements, data to be synced, setup
-commands, and the task commands. Once written in this [**unified interface**]
-(https://skypilot.readthedocs.io/en/latest/reference/yaml-spec.html) (YAML or
-Python API), the task can be launched on any available cloud. This avoids
-vendor lock-in, and allows easily moving jobs to a different provider. Paste
-the following into a file `my_task.yaml`: ```yaml resources: accelerators:
-V100:1 # 1x NVIDIA V100 GPU num_nodes: 1 # Number of VMs to launch # Working
-directory (optional) containing the project codebase. # Its contents are synced
-to ~/sky_workdir/ on the cluster. workdir: ~/torch_examples # Commands to be
-run before executing the job. # Typical use: pip install -r requirements.txt,
-git clone, etc. setup: | pip install torch torchvision # Commands to run as a
-job. # Typical use: launch the main program. run: | cd mnist python main.py --
-epochs 1 ``` Prepare the workdir by cloning: ```bash git clone https://
-github.com/pytorch/examples.git ~/torch_examples ``` Launch with `sky launch`
-(note: [access to GPU instances](https://skypilot.readthedocs.io/en/latest/
-reference/quota.html) is needed for this example): ```bash sky launch
-my_task.yaml ``` SkyPilot then performs the heavy-lifting for you, including:
-1. Find the lowest priced VM instance type across different clouds 2. Provision
-the VM, with auto-failover if the cloud returned capacity errors 3. Sync the
-local `workdir` to the VM 4. Run the task's `setup` commands to prepare the VM
-for running the task 5. Run the task's `run` commands
+---- :fire: *News* :fire: - [June, 2023] Serving LLM **24x Faster On the
+Cloud** with vLLM and SkyPilot: [**example**](./llm/vllm/), [**blog post**]
+(https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-
+skypilot/) - [June, 2023] [**Two new clouds supported**](https://
+skypilot.readthedocs.io/en/latest/getting-started/installation.html): Samsung
+SCP and Oracle OCI! - [April, 2023] **[**SkyPilot YAMLs released**](./llm/
+vicuna/) for finetuning & serving the Vicuna model with a single command**! -
+[March, 2023] **[Vicuna LLM chatbot](https://lmsys.org/blog/2023-03-30-vicuna/
+) trained** [**using SkyPilot**](./llm/vicuna/) **for $300 on spot instances!**
+- [March, 2023] *Serve* your own LLaMA LLM chatbot (not finetuned) on any
+cloud: [**example**](./llm/llama-chatbots/), [**repo**](https://github.com/
+skypilot-org/sky-llama) ---- SkyPilot is a framework for easily and cost
+effectively running ML workloads[1] on any cloud. SkyPilot abstracts away the
+cloud infra burden: - Launch jobs & clusters on any cloud (AWS, Azure, GCP,
+Lambda Cloud, IBM, Samsung, OCI) - Find scarce resources across zones/regions/
+clouds - Queue jobs & use cloud object stores SkyPilot cuts your cloud costs: *
+[Managed Spot](https://skypilot.readthedocs.io/en/latest/examples/spot-
+jobs.html): **3x cost savings** using spot VMs, with auto-recovery from
+preemptions * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/
+auto-stop.html): hands-free cleanup of idle clusters * [Benchmark](https://
+skypilot.readthedocs.io/en/latest/reference/benchmark/index.html): find best VM
+types for your jobs * Optimizer: **2x cost savings** by auto-picking best
+prices across zones/regions/clouds SkyPilot supports your existing GPU, TPU,
+and CPU workloads, with no code changes. Install with pip or [from source]
+(https://skypilot.readthedocs.io/en/latest/getting-started/installation.html):
+``` pip install "skypilot[aws,gcp,azure,ibm,oci,scp,lambda]" # choose your
+clouds ```
+                                  [SkyPilot]
+## Getting Started You can find our documentation [here](https://
+skypilot.readthedocs.io/en/latest/). - [Installation](https://
+skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
+[Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
+quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
+reference/cli.html) ## SkyPilot in 1 minute A SkyPilot task specifies: resource
+requirements, data to be synced, setup commands, and the task commands. Once
+written in this [**unified interface**](https://skypilot.readthedocs.io/en/
+latest/reference/yaml-spec.html) (YAML or Python API), the task can be launched
+on any available cloud. This avoids vendor lock-in, and allows easily moving
+jobs to a different provider. Paste the following into a file `my_task.yaml`:
+```yaml resources: accelerators: V100:1 # 1x NVIDIA V100 GPU num_nodes: 1 #
+Number of VMs to launch # Working directory (optional) containing the project
+codebase. # Its contents are synced to ~/sky_workdir/ on the cluster. workdir:
+~/torch_examples # Commands to be run before executing the job. # Typical use:
+pip install -r requirements.txt, git clone, etc. setup: | pip install torch
+torchvision # Commands to run as a job. # Typical use: launch the main program.
+run: | cd mnist python main.py --epochs 1 ``` Prepare the workdir by cloning:
+```bash git clone https://github.com/pytorch/examples.git ~/torch_examples ```
+Launch with `sky launch` (note: [access to GPU instances](https://
+skypilot.readthedocs.io/en/latest/reference/quota.html) is needed for this
+example): ```bash sky launch my_task.yaml ``` SkyPilot then performs the heavy-
+lifting for you, including: 1. Find the lowest priced VM instance type across
+different clouds 2. Provision the VM, with auto-failover if the cloud returned
+capacity errors 3. Sync the local `workdir` to the VM 4. Run the task's `setup`
+commands to prepare the VM for running the task 5. Run the task's `run`
+commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## Learn more -
 [Documentation](https://skypilot.readthedocs.io/en/latest/) - [Example:
 HuggingFace](https://skypilot.readthedocs.io/en/latest/getting-started/
 tutorial.html) - [Tutorials](https://github.com/skypilot-org/skypilot-tutorial)
 - [YAML reference](https://skypilot.readthedocs.io/en/latest/reference/yaml-
```

### Comparing `skypilot-0.3.1/skypilot.egg-info/SOURCES.txt` & `skypilot-0.3.2/skypilot.egg-info/SOURCES.txt`

 * *Files 4% similar despite different names*

```diff
@@ -4,32 +4,33 @@
 pyproject.toml
 setup.py
 sky/__init__.py
 sky/authentication.py
 sky/check.py
 sky/cli.py
 sky/cloud_stores.py
-sky/config.py
 sky/core.py
 sky/dag.py
 sky/exceptions.py
 sky/execution.py
 sky/global_user_state.py
 sky/optimizer.py
 sky/resources.py
 sky/sky_logging.py
 sky/skypilot_config.py
+sky/status_lib.py
 sky/task.py
 sky/adaptors/__init__.py
 sky/adaptors/aws.py
 sky/adaptors/azure.py
 sky/adaptors/cloudflare.py
 sky/adaptors/docker.py
 sky/adaptors/gcp.py
 sky/adaptors/ibm.py
+sky/adaptors/oci.py
 sky/backends/__init__.py
 sky/backends/backend.py
 sky/backends/backend_utils.py
 sky/backends/cloud_vm_ray_backend.py
 sky/backends/docker_utils.py
 sky/backends/local_docker_backend.py
 sky/backends/onprem_utils.py
@@ -42,23 +43,27 @@
 sky/clouds/aws.py
 sky/clouds/azure.py
 sky/clouds/cloud.py
 sky/clouds/gcp.py
 sky/clouds/ibm.py
 sky/clouds/lambda_cloud.py
 sky/clouds/local.py
+sky/clouds/oci.py
+sky/clouds/scp.py
 sky/clouds/service_catalog/__init__.py
 sky/clouds/service_catalog/aws_catalog.py
 sky/clouds/service_catalog/azure_catalog.py
 sky/clouds/service_catalog/common.py
 sky/clouds/service_catalog/config.py
 sky/clouds/service_catalog/constants.py
 sky/clouds/service_catalog/gcp_catalog.py
 sky/clouds/service_catalog/ibm_catalog.py
 sky/clouds/service_catalog/lambda_catalog.py
+sky/clouds/service_catalog/oci_catalog.py
+sky/clouds/service_catalog/scp_catalog.py
 sky/clouds/service_catalog/data_fetchers/__init__.py
 sky/clouds/service_catalog/data_fetchers/fetch_aws.py
 sky/clouds/service_catalog/data_fetchers/fetch_azure.py
 sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
 sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
 sky/data/__init__.py
 sky/data/data_transfer.py
@@ -66,14 +71,15 @@
 sky/data/mounting_utils.py
 sky/data/storage.py
 sky/data/storage_utils.py
 sky/setup_files/MANIFEST.in
 sky/setup_files/setup.py
 sky/skylet/LICENSE
 sky/skylet/__init__.py
+sky/skylet/attempt_skylet.py
 sky/skylet/autostop_lib.py
 sky/skylet/configs.py
 sky/skylet/constants.py
 sky/skylet/events.py
 sky/skylet/job_lib.py
 sky/skylet/log_lib.py
 sky/skylet/skylet.py
@@ -97,44 +103,59 @@
 sky/skylet/providers/ibm/__init__.py
 sky/skylet/providers/ibm/node_provider.py
 sky/skylet/providers/ibm/utils.py
 sky/skylet/providers/ibm/vpc_provider.py
 sky/skylet/providers/lambda_cloud/__init__.py
 sky/skylet/providers/lambda_cloud/lambda_utils.py
 sky/skylet/providers/lambda_cloud/node_provider.py
+sky/skylet/providers/oci/__init__.py
+sky/skylet/providers/oci/config.py
+sky/skylet/providers/oci/node_provider.py
+sky/skylet/providers/oci/query_helper.py
+sky/skylet/providers/oci/utils.py
+sky/skylet/providers/scp/__init__.py
+sky/skylet/providers/scp/config.py
+sky/skylet/providers/scp/node_provider.py
+sky/skylet/providers/scp/scp_utils.py
 sky/skylet/ray_patches/__init__.py
 sky/skylet/ray_patches/autoscaler.py.patch
 sky/skylet/ray_patches/cli.py.patch
 sky/skylet/ray_patches/command_runner.py.patch
 sky/skylet/ray_patches/log_monitor.py.patch
 sky/skylet/ray_patches/resource_demand_scheduler.py.patch
 sky/skylet/ray_patches/updater.py.patch
 sky/skylet/ray_patches/worker.py.patch
 sky/spot/__init__.py
 sky/spot/constants.py
 sky/spot/controller.py
 sky/spot/recovery_strategy.py
 sky/spot/spot_state.py
 sky/spot/spot_utils.py
+sky/spot/dashboard/dashboard.py
+sky/spot/dashboard/static/favicon.ico
+sky/spot/dashboard/templates/index.html
 sky/templates/aws-ray.yml.j2
 sky/templates/azure-ray.yml.j2
 sky/templates/gcp-ray.yml.j2
 sky/templates/gcp-tpu-create.sh.j2
 sky/templates/gcp-tpu-delete.sh.j2
 sky/templates/ibm-ray.yml.j2
 sky/templates/lambda-ray.yml.j2
 sky/templates/local-ray.yml.j2
+sky/templates/oci-ray.yml.j2
+sky/templates/scp-ray.yml.j2
 sky/templates/spot-controller.yaml.j2
 sky/usage/__init__.py
 sky/usage/constants.py
 sky/usage/usage_lib.py
 sky/utils/__init__.py
 sky/utils/accelerator_registry.py
 sky/utils/command_runner.py
 sky/utils/common_utils.py
+sky/utils/dag_utils.py
 sky/utils/db_utils.py
 sky/utils/env_options.py
 sky/utils/log_utils.py
 sky/utils/schemas.py
 sky/utils/subprocess_utils.py
 sky/utils/timeline.py
 sky/utils/tpu_utils.py
@@ -146,15 +167,14 @@
 skypilot.egg-info/SOURCES.txt
 skypilot.egg-info/dependency_links.txt
 skypilot.egg-info/entry_points.txt
 skypilot.egg-info/requires.txt
 skypilot.egg-info/top_level.txt
 tests/test_cli.py
 tests/test_config.py
-tests/test_file_mount_helper.py
 tests/test_global_user_state.py
 tests/test_list_accelerators.py
 tests/test_onprem.py
 tests/test_optimizer_dryruns.py
 tests/test_optimizer_random_dag.py
 tests/test_pycryptodome_version.py
 tests/test_smoke.py
```

### Comparing `skypilot-0.3.1/skypilot.egg-info/requires.txt` & `skypilot-0.3.2/skypilot.egg-info/requires.txt`

 * *Files 7% similar despite different names*

```diff
@@ -13,32 +13,33 @@
 rich
 tabulate
 filelock>=3.6.0
 packaging
 protobuf!=3.19.5,>=3.15.3
 psutil
 pulp
+pydantic<2.0
 awscli
 boto3
 pycryptodome==3.12.0
 
 [:python_version < "3.10" and sys_platform != "darwin"]
-grpcio<=1.51.3,>=1.32.0
+grpcio!=1.48.0,<=1.51.3,>=1.32.0
 
 [:python_version < "3.10" and sys_platform == "darwin"]
-grpcio<=1.49.1,>=1.32.0
+grpcio!=1.48.0,<=1.49.1,>=1.32.0
 
 [:python_version < "3.8"]
 typing_extensions
 
 [:python_version >= "3.10" and sys_platform != "darwin"]
-grpcio<=1.51.3,>=1.42.0
+grpcio!=1.48.0,<=1.51.3,>=1.42.0
 
 [:python_version >= "3.10" and sys_platform == "darwin"]
-grpcio<=1.49.1,>=1.42.0
+grpcio!=1.48.0,<=1.49.1,>=1.42.0
 
 [all]
 awscli
 boto3
 pycryptodome==3.12.0
 azure-cli>=2.31.0
 azure-core
@@ -46,14 +47,15 @@
 azure-mgmt-network
 google-api-python-client
 google-cloud-storage
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
 docker
+oci
 
 [aws]
 awscli
 boto3
 pycryptodome==3.12.0
 
 [azure]
@@ -76,7 +78,12 @@
 
 [ibm]
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
 
 [lambda]
+
+[oci]
+oci
+
+[scp]
```

### Comparing `skypilot-0.3.1/tests/test_config.py` & `skypilot-0.3.2/tests/test_config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/tests/test_onprem.py` & `skypilot-0.3.2/tests/test_onprem.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/tests/test_optimizer_dryruns.py` & `skypilot-0.3.2/tests/test_optimizer_dryruns.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,51 +1,61 @@
 import tempfile
 import textwrap
-from typing import List
+from typing import Callable, List, Optional
 
 import pytest
 
 import sky
 from sky import clouds
 from sky import exceptions
 
 
-def _test_parse_cpus(spec, expected_cpus):
+def _test_parse_task_yaml(spec: str, test_fn: Optional[Callable] = None):
+    """Tests parsing a task from a YAML spec and running a test_fn."""
     with tempfile.NamedTemporaryFile('w') as f:
         f.write(spec)
         f.flush()
         with sky.Dag():
             task = sky.Task.from_yaml(f.name)
-            assert list(task.resources)[0].cpus == expected_cpus
+            if test_fn is not None:
+                test_fn(task)
+
+
+def _test_parse_cpus(spec, expected_cpus):
+
+    def test_fn(task):
+        assert list(task.resources)[0].cpus == expected_cpus
+
+    _test_parse_task_yaml(spec, test_fn)
 
 
 def _test_parse_memory(spec, expected_memory):
-    with tempfile.NamedTemporaryFile('w') as f:
-        f.write(spec)
-        f.flush()
-        with sky.Dag():
-            task = sky.Task.from_yaml(f.name)
-            assert list(task.resources)[0].memory == expected_memory
+
+    def test_fn(task):
+        assert list(task.resources)[0].memory == expected_memory
+
+    _test_parse_task_yaml(spec, test_fn)
 
 
 def _test_parse_accelerators(spec, expected_accelerators):
-    with tempfile.NamedTemporaryFile('w') as f:
-        f.write(spec)
-        f.flush()
-        with sky.Dag():
-            task = sky.Task.from_yaml(f.name)
-            assert list(task.resources)[0].accelerators == expected_accelerators
+
+    def test_fn(task):
+        assert list(task.resources)[0].accelerators == expected_accelerators
+
+    _test_parse_task_yaml(spec, test_fn)
 
 
 # Monkey-patching is required because in the test environment, no cloud is
 # enabled. The optimizer checks the environment to find enabled clouds, and
 # only generates plans within these clouds. The tests assume that all three
 # clouds are enabled, so we monkeypatch the `sky.global_user_state` module
 # to return all three clouds. We also monkeypatch `sky.check.check` so that
 # when the optimizer tries calling it to update enabled_clouds, it does not
+# TODO: Keep the cloud enabling in sync with the fixture enable_all_clouds
+# in tests/conftest.py
 # raise exceptions.
 def _make_resources(
     monkeypatch,
     *resources_args,
     enabled_clouds: List[str] = None,
     **resources_kwargs,
 ):
@@ -57,14 +67,18 @@
     )
     monkeypatch.setattr('sky.check.check', lambda *_args, **_kwargs: None)
 
     config_file_backup = tempfile.NamedTemporaryFile(
         prefix='tmp_backup_config_default', delete=False)
     monkeypatch.setattr('sky.clouds.gcp.GCP_CONFIG_SKY_BACKUP_PATH',
                         config_file_backup.name)
+    monkeypatch.setattr(
+        'sky.clouds.gcp.DEFAULT_GCP_APPLICATION_CREDENTIAL_PATH',
+        config_file_backup.name)
+    monkeypatch.setenv('OCI_CONFIG', config_file_backup.name)
 
     # Should create Resources here, since it uses the enabled clouds.
     return sky.Resources(*resources_args, **resources_kwargs)
 
 
 def _test_resources(monkeypatch,
                     *resources_args,
@@ -266,15 +280,15 @@
 
     _test_resources_launch(monkeypatch, memory='64+')
     stdout, _ = capfd.readouterr()
     # Choose memory-optimized instance types
     assert 'r6i.2xlarge' in stdout  # AWS, 8 vCPUs, 64 GB memory
     assert 'Standard_E8s_v5' in stdout  # Azure, 8 vCPUs, 64 GB memory
     assert 'n2-highmem-8' in stdout  # GCP, 8 vCPUs, 64 GB memory
-    assert 'gpu_1x_a6000' in stdout  # Lambda, 14 vCPUs, 100 GB memory
+    assert 'gpu_1x_a10' in stdout  # Lambda, 30 vCPUs, 200 GB memory
 
     _test_resources_launch(monkeypatch, cpus='4+', memory='4+')
     stdout, _ = capfd.readouterr()
     # Choose compute-optimized instance types, when the memory
     # requirement is less than the memory of General Purpose
     # instance types.
     assert 'n2-highcpu-4' in stdout  # GCP, 4 vCPUs, 4 GB memory
@@ -433,15 +447,15 @@
 
     with pytest.raises(ValueError) as e:
         _test_resources(monkeypatch, image_id='ami-0868a20f5a3bf9702')
     assert 'Cloud must be specified' in str(e.value)
 
     with pytest.raises(ValueError) as e:
         _test_resources(monkeypatch, cloud=sky.Azure(), image_id='some-image')
-    assert 'only supported for AWS, GCP and IBM' in str(e.value)
+    assert 'only supported for AWS/GCP/IBM/OCI' in str(e.value)
 
 
 def test_valid_image(monkeypatch):
     _test_resources(monkeypatch,
                     cloud=sky.AWS(),
                     region='us-east-1',
                     image_id='ami-0868a20f5a3bf9702')
@@ -537,7 +551,51 @@
 def test_invalid_num_nodes():
     for invalid_value in (-1, 2.2, 1.0):
         with pytest.raises(ValueError) as e:
             with sky.Dag():
                 task = sky.Task()
                 task.num_nodes = invalid_value
             assert 'num_nodes should be a positive int' in str(e.value)
+
+
+def test_parse_empty_yaml():
+    spec = textwrap.dedent("""\
+        """)
+
+    def test_fn(task):
+        assert task.num_nodes == 1
+
+    _test_parse_task_yaml(spec, test_fn)
+
+
+def test_parse_name_only_yaml():
+    spec = textwrap.dedent("""\
+        name: test_task
+        """)
+
+    def test_fn(task):
+        assert task.name == 'test_task'
+
+    _test_parse_task_yaml(spec, test_fn)
+
+
+def test_parse_invalid_envs_yaml(monkeypatch):
+    spec = textwrap.dedent("""\
+        envs:
+          hello world: 1  # invalid key
+          123: val  # invalid key
+          good_key: val
+        """)
+    with pytest.raises(ValueError) as e:
+        _test_parse_task_yaml(spec)
+    assert '\'123\', \'hello world\' do not match any of the regexes' in str(
+        e.value)
+
+
+def test_parse_valid_envs_yaml(monkeypatch):
+    spec = textwrap.dedent("""\
+        envs:
+          hello_world: 1
+          HELLO: val
+          GOOD123: 123
+        """)
+    _test_parse_task_yaml(spec)
```

### Comparing `skypilot-0.3.1/tests/test_optimizer_random_dag.py` & `skypilot-0.3.2/tests/test_optimizer_random_dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/tests/test_smoke.py` & `skypilot-0.3.2/tests/test_smoke.py`

 * *Files 12% similar despite different names*

```diff
@@ -6,15 +6,15 @@
 00000050: 2075 7361 6765 3a0a 2320 5275 6e20 616c   usage:.# Run al
 00000060: 6c20 7465 7374 7320 6578 6365 7074 2066  l tests except f
 00000070: 6f72 2041 5753 2061 6e64 204c 616d 6264  or AWS and Lambd
 00000080: 6120 436c 6f75 640a 2320 3e20 7079 7465  a Cloud.# > pyte
 00000090: 7374 2074 6573 7473 2f74 6573 745f 736d  st tests/test_sm
 000000a0: 6f6b 652e 7079 0a23 0a23 2054 6572 6d69  oke.py.#.# Termi
 000000b0: 6e61 7465 2066 6169 6c65 6420 636c 7573  nate failed clus
-000000c0: 6574 7273 2061 6674 6572 2074 6573 7420  etrs after test 
+000000c0: 7465 7273 2061 6674 6572 2074 6573 7420  ters after test 
 000000d0: 6669 6e69 7368 6573 0a23 203e 2070 7974  finishes.# > pyt
 000000e0: 6573 7420 7465 7374 732f 7465 7374 5f73  est tests/test_s
 000000f0: 6d6f 6b65 2e70 7920 2d2d 7465 726d 696e  moke.py --termin
 00000100: 6174 652d 6f6e 2d66 6169 6c75 7265 0a23  ate-on-failure.#
 00000110: 0a23 2052 652d 7275 6e20 6c61 7374 2066  .# Re-run last f
 00000120: 6169 6c65 6420 7465 7374 730a 2320 3e20  ailed tests.# > 
 00000130: 7079 7465 7374 202d 2d6c 660a 230a 2320  pytest --lf.#.# 
@@ -103,6231 +103,7628 @@
 00000660: 6520 636c 7573 7465 7220 6e61 6d65 2062  e cluster name b
 00000670: 7574 2061 2064 6966 6665 7265 6e74 206a  ut a different j
 00000680: 6f62 0a23 2069 642e 0a74 6573 745f 6964  ob.# id..test_id
 00000690: 203d 2073 7472 2875 7569 642e 7575 6964   = str(uuid.uuid
 000006a0: 3428 2929 5b2d 323a 5d0a 0a4c 414d 4244  4())[-2:]..LAMBD
 000006b0: 415f 5459 5045 203d 2027 2d2d 636c 6f75  A_TYPE = '--clou
 000006c0: 6420 6c61 6d62 6461 202d 2d67 7075 7320  d lambda --gpus 
-000006d0: 4131 3027 0a0a 7374 6f72 6167 655f 7365  A10'..storage_se
-000006e0: 7475 705f 636f 6d6d 616e 6473 203d 205b  tup_commands = [
-000006f0: 0a20 2020 2027 746f 7563 6820 7e2f 746d  .    'touch ~/tm
-00000700: 7066 696c 6527 2c20 276d 6b64 6972 202d  pfile', 'mkdir -
-00000710: 7020 7e2f 746d 702d 776f 726b 6469 7227  p ~/tmp-workdir'
-00000720: 2c0a 2020 2020 2774 6f75 6368 207e 2f74  ,.    'touch ~/t
-00000730: 6d70 2d77 6f72 6b64 6972 2f74 6d70 5c20  mp-workdir/tmp\ 
-00000740: 6669 6c65 272c 2027 746f 7563 6820 7e2f  file', 'touch ~/
-00000750: 746d 702d 776f 726b 6469 722f 746d 705c  tmp-workdir/tmp\
-00000760: 2066 696c 6532 272c 0a20 2020 2027 746f   file2',.    'to
-00000770: 7563 6820 7e2f 746d 702d 776f 726b 6469  uch ~/tmp-workdi
-00000780: 722f 666f 6f27 2c0a 2020 2020 276c 6e20  r/foo',.    'ln 
-00000790: 2d66 202d 7320 7e2f 746d 702d 776f 726b  -f -s ~/tmp-work
-000007a0: 6469 722f 207e 2f74 6d70 2d77 6f72 6b64  dir/ ~/tmp-workd
-000007b0: 6972 2f63 6972 636c 652d 6c69 6e6b 272c  ir/circle-link',
-000007c0: 0a20 2020 2027 746f 7563 6820 7e2f 2e73  .    'touch ~/.s
-000007d0: 7368 2f69 645f 7273 612e 7075 6227 0a5d  sh/id_rsa.pub'.]
-000007e0: 0a0a 2320 5761 6974 2075 6e74 696c 2074  ..# Wait until t
-000007f0: 6865 2073 706f 7420 636f 6e74 726f 6c6c  he spot controll
-00000800: 6572 2069 7320 6e6f 7420 696e 2049 4e49  er is not in INI
-00000810: 5420 7374 6174 652e 0a23 2054 6869 7320  T state..# This 
-00000820: 6973 2061 2077 6f72 6b61 726f 756e 6420  is a workaround 
-00000830: 666f 7220 7468 6520 6973 7375 6520 7468  for the issue th
-00000840: 6174 2077 6865 6e20 6d75 6c74 6970 6c65  at when multiple
-00000850: 2073 706f 7420 7465 7374 730a 2320 6172   spot tests.# ar
-00000860: 6520 7275 6e6e 696e 6720 696e 2070 6172  e running in par
-00000870: 616c 6c65 6c2c 2074 6865 2073 706f 7420  allel, the spot 
-00000880: 636f 6e74 726f 6c6c 6572 206d 6179 2062  controller may b
-00000890: 6520 696e 2049 4e49 5420 616e 640a 2320  e in INIT and.# 
-000008a0: 7468 6520 7370 6f74 2071 7565 7565 2f63  the spot queue/c
-000008b0: 616e 6365 6c20 636f 6d6d 616e 6420 7769  ancel command wi
-000008c0: 6c6c 2072 6574 7572 6e20 7374 616c 6564  ll return staled
-000008d0: 2074 6162 6c65 2e0a 5f53 504f 545f 5155   table.._SPOT_QU
-000008e0: 4555 455f 5741 4954 203d 2028 2773 3d24  EUE_WAIT = ('s=$
-000008f0: 2873 6b79 2073 706f 7420 7175 6575 6529  (sky spot queue)
-00000900: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
-00000910: 2020 2020 2020 2020 2775 6e74 696c 205b          'until [
-00000920: 2060 6563 686f 2022 2473 2220 270a 2020   `echo "$s" '.  
-00000930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000940: 2020 277c 2067 7265 7020 226a 6f62 7320    '| grep "jobs 
-00000950: 7769 6c6c 206e 6f74 2062 6520 7368 6f77  will not be show
-00000960: 6e20 756e 7469 6c20 6974 2062 6563 6f6d  n until it becom
-00000970: 6573 2055 502e 2220 270a 2020 2020 2020  es UP." '.      
-00000980: 2020 2020 2020 2020 2020 2020 2020 277c                '|
-00000990: 2077 6320 2d6c 6020 2d65 7120 3020 5d3b   wc -l` -eq 0 ];
-000009a0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000009b0: 2020 2020 2020 2027 646f 2065 6368 6f20         'do echo 
-000009c0: 2257 6169 7469 6e67 2066 6f72 2073 706f  "Waiting for spo
-000009d0: 7420 7175 6575 6520 746f 2062 6520 7265  t queue to be re
-000009e0: 6164 792e 2e2e 223b 2027 0a20 2020 2020  ady..."; '.     
-000009f0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00000a00: 736c 6565 7020 353b 2073 3d24 2873 6b79  sleep 5; s=$(sky
-00000a10: 2073 706f 7420 7175 6575 6529 3b20 646f   spot queue); do
-00000a20: 6e65 3b20 6563 686f 2022 2473 223b 2027  ne; echo "$s"; '
-00000a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000a40: 2020 2020 2027 6563 686f 3b20 6563 686f       'echo; echo
-00000a50: 3b20 6563 686f 2022 2473 2227 290a 5f53  ; echo "$s"')._S
-00000a60: 504f 545f 4341 4e43 454c 5f57 4149 5420  POT_CANCEL_WAIT 
-00000a70: 3d20 280a 2020 2020 2773 3d24 2873 6b79  = (.    's=$(sky
-00000a80: 2073 706f 7420 6361 6e63 656c 202d 7920   spot cancel -y 
-00000a90: 2d6e 207b 6a6f 625f 6e61 6d65 7d29 3b20  -n {job_name}); 
-00000aa0: 756e 7469 6c20 5b20 6065 6368 6f20 2224  until [ `echo "$
-00000ab0: 7322 2027 0a20 2020 2027 7c20 6772 6570  s" '.    '| grep
-00000ac0: 2022 506c 6561 7365 2077 6169 7420 666f   "Please wait fo
-00000ad0: 7220 7468 6520 636f 6e74 726f 6c6c 6572  r the controller
-00000ae0: 2074 6f20 6265 2072 6561 6479 2e22 2027   to be ready." '
-00000af0: 0a20 2020 2027 7c20 7763 202d 6c60 202d  .    '| wc -l` -
-00000b00: 6571 2030 205d 3b20 646f 2065 6368 6f20  eq 0 ]; do echo 
-00000b10: 2257 6169 7469 6e67 2066 6f72 2074 6865  "Waiting for the
-00000b20: 2073 706f 7420 636f 6e74 726f 6c6c 6572   spot controller
-00000b30: 2027 0a20 2020 2027 746f 2062 6520 7265   '.    'to be re
-00000b40: 6164 7922 3b20 736c 6565 7020 353b 2073  ady"; sleep 5; s
-00000b50: 3d24 2873 6b79 2073 706f 7420 6361 6e63  =$(sky spot canc
-00000b60: 656c 202d 7920 2d6e 207b 6a6f 625f 6e61  el -y -n {job_na
-00000b70: 6d65 7d29 3b20 270a 2020 2020 2764 6f6e  me}); '.    'don
-00000b80: 653b 2065 6368 6f20 2224 7322 3b20 6563  e; echo "$s"; ec
-00000b90: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-00000ba0: 2473 2227 290a 2320 544f 444f 287a 6877  $s"').# TODO(zhw
-00000bb0: 7529 3a20 6d61 6b65 2074 6865 2073 706f  u): make the spo
-00000bc0: 7420 636f 6e74 726f 6c6c 6572 206f 6e20  t controller on 
-00000bd0: 4743 502e 0a0a 0a63 6c61 7373 2054 6573  GCP....class Tes
-00000be0: 7428 4e61 6d65 6454 7570 6c65 293a 0a20  t(NamedTuple):. 
-00000bf0: 2020 206e 616d 653a 2073 7472 0a20 2020     name: str.   
-00000c00: 2023 2045 6163 6820 636f 6d6d 616e 6420   # Each command 
-00000c10: 6973 2065 7865 6375 7465 6420 7365 7269  is executed seri
-00000c20: 616c 6c79 2e20 2049 6620 616e 7920 6661  ally.  If any fa
-00000c30: 696c 6564 2c20 7468 6520 7265 6d61 696e  iled, the remain
-00000c40: 696e 6720 636f 6d6d 616e 6473 0a20 2020  ing commands.   
-00000c50: 2023 2061 7265 206e 6f74 2072 756e 2061   # are not run a
-00000c60: 6e64 2074 6865 2074 6573 7420 6973 2074  nd the test is t
-00000c70: 7265 6174 6564 2061 7320 6661 696c 6564  reated as failed
-00000c80: 2e0a 2020 2020 636f 6d6d 616e 6473 3a20  ..    commands: 
-00000c90: 4c69 7374 5b73 7472 5d0a 2020 2020 7465  List[str].    te
-00000ca0: 6172 646f 776e 3a20 4f70 7469 6f6e 616c  ardown: Optional
-00000cb0: 5b73 7472 5d20 3d20 4e6f 6e65 0a20 2020  [str] = None.   
-00000cc0: 2023 2054 696d 656f 7574 2066 6f72 2065   # Timeout for e
-00000cd0: 6163 6820 636f 6d6d 616e 6420 696e 2073  ach command in s
-00000ce0: 6563 6f6e 6473 2e0a 2020 2020 7469 6d65  econds..    time
-00000cf0: 6f75 743a 2069 6e74 203d 2031 3520 2a20  out: int = 15 * 
-00000d00: 3630 0a0a 2020 2020 6465 6620 6563 686f  60..    def echo
-00000d10: 2873 656c 662c 206d 6573 7361 6765 3a20  (self, message: 
-00000d20: 7374 7229 3a0a 2020 2020 2020 2020 2320  str):.        # 
-00000d30: 7079 7465 7374 2773 2078 6469 7374 2070  pytest's xdist p
-00000d40: 6c75 6769 6e20 6361 7074 7572 6573 2073  lugin captures s
-00000d50: 7464 6f75 743b 2070 7269 6e74 2074 6f20  tdout; print to 
-00000d60: 7374 6465 7272 2073 6f20 7468 6174 2074  stderr so that t
-00000d70: 6865 0a20 2020 2020 2020 2023 206c 6f67  he.        # log
-00000d80: 7320 6172 6520 7374 7265 616d 696e 6720  s are streaming 
-00000d90: 7768 696c 6520 7468 6520 7465 7374 7320  while the tests 
-00000da0: 6172 6520 7275 6e6e 696e 672e 0a20 2020  are running..   
-00000db0: 2020 2020 2070 7265 6669 7820 3d20 6627       prefix = f'
-00000dc0: 5b7b 7365 6c66 2e6e 616d 657d 5d27 0a20  [{self.name}]'. 
-00000dd0: 2020 2020 2020 206d 6573 7361 6765 203d         message =
-00000de0: 2066 277b 7072 6566 6978 7d20 7b6d 6573   f'{prefix} {mes
-00000df0: 7361 6765 7d27 0a20 2020 2020 2020 206d  sage}'.        m
-00000e00: 6573 7361 6765 203d 206d 6573 7361 6765  essage = message
-00000e10: 2e72 6570 6c61 6365 2827 5c6e 272c 2066  .replace('\n', f
-00000e20: 275c 6e7b 7072 6566 6978 7d20 2729 0a20  '\n{prefix} '). 
-00000e30: 2020 2020 2020 2070 7269 6e74 286d 6573         print(mes
-00000e40: 7361 6765 2c20 6669 6c65 3d73 7973 2e73  sage, file=sys.s
-00000e50: 7464 6572 722c 2066 6c75 7368 3d54 7275  tderr, flush=Tru
-00000e60: 6529 0a0a 0a64 6566 205f 6765 745f 636c  e)...def _get_cl
-00000e70: 7573 7465 725f 6e61 6d65 2829 202d 3e20  uster_name() -> 
-00000e80: 7374 723a 0a20 2020 2022 2222 5265 7475  str:.    """Retu
-00000e90: 726e 7320 6120 7573 6572 2d75 6e69 7175  rns a user-uniqu
-00000ea0: 6520 636c 7573 7465 7220 6e61 6d65 2066  e cluster name f
-00000eb0: 6f72 2065 6163 6820 7465 7374 5f3c 6e61  or each test_<na
-00000ec0: 6d65 3e28 292e 0a0a 2020 2020 4d75 7374  me>()...    Must
-00000ed0: 2062 6520 6361 6c6c 6564 2066 726f 6d20   be called from 
-00000ee0: 6561 6368 2074 6573 745f 3c6e 616d 653e  each test_<name>
-00000ef0: 2829 2e0a 2020 2020 2222 220a 2020 2020  ()..    """.    
-00000f00: 6361 6c6c 6572 5f66 756e 635f 6e61 6d65  caller_func_name
-00000f10: 203d 2069 6e73 7065 6374 2e73 7461 636b   = inspect.stack
-00000f20: 2829 5b31 5d5b 335d 0a20 2020 2074 6573  ()[1][3].    tes
-00000f30: 745f 6e61 6d65 203d 2063 616c 6c65 725f  t_name = caller_
-00000f40: 6675 6e63 5f6e 616d 652e 7265 706c 6163  func_name.replac
-00000f50: 6528 275f 272c 2027 2d27 292e 7265 706c  e('_', '-').repl
-00000f60: 6163 6528 2774 6573 742d 272c 2027 742d  ace('test-', 't-
-00000f70: 2729 0a20 2020 2069 6620 6c65 6e28 7465  ').    if len(te
-00000f80: 7374 5f6e 616d 6529 203e 2031 383a 0a20  st_name) > 18:. 
-00000f90: 2020 2020 2020 2074 6573 745f 6e61 6d65         test_name
-00000fa0: 203d 2074 6573 745f 6e61 6d65 5b3a 3138   = test_name[:18
-00000fb0: 5d20 2b20 6861 7368 6c69 622e 6d64 3528  ] + hashlib.md5(
-00000fc0: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
-00000fd0: 745f 6e61 6d65 2e65 6e63 6f64 6528 2929  t_name.encode())
-00000fe0: 2e68 6578 6469 6765 7374 2829 5b3a 335d  .hexdigest()[:3]
-00000ff0: 0a20 2020 2072 6574 7572 6e20 6627 7b74  .    return f'{t
-00001000: 6573 745f 6e61 6d65 7d2d 7b5f 736d 6f6b  est_name}-{_smok
-00001010: 655f 7465 7374 5f68 6173 687d 2d7b 7465  e_test_hash}-{te
-00001020: 7374 5f69 647d 270a 0a0a 6465 6620 7275  st_id}'...def ru
-00001030: 6e5f 6f6e 655f 7465 7374 2874 6573 743a  n_one_test(test:
-00001040: 2054 6573 7429 202d 3e20 5475 706c 655b   Test) -> Tuple[
-00001050: 696e 742c 2073 7472 2c20 7374 725d 3a0a  int, str, str]:.
-00001060: 2020 2020 2320 4661 696c 2066 6173 7420      # Fail fast 
-00001070: 6966 2060 736b 7960 2043 4c49 2073 6f6d  if `sky` CLI som
-00001080: 6568 6f77 2065 7272 6f72 7320 6f75 742e  ehow errors out.
-00001090: 0a20 2020 2073 7562 7072 6f63 6573 732e  .    subprocess.
-000010a0: 7275 6e28 5b27 736b 7927 2c20 2773 7461  run(['sky', 'sta
-000010b0: 7475 7327 5d2c 2073 7464 6f75 743d 7375  tus'], stdout=su
-000010c0: 6270 726f 6365 7373 2e44 4556 4e55 4c4c  bprocess.DEVNULL
-000010d0: 2c20 6368 6563 6b3d 5472 7565 290a 2020  , check=True).  
-000010e0: 2020 6c6f 675f 6669 6c65 203d 2074 656d    log_file = tem
-000010f0: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
-00001100: 7261 7279 4669 6c65 2827 6127 2c0a 2020  raryFile('a',.  
-00001110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001130: 2020 2020 2020 2020 2070 7265 6669 783d           prefix=
-00001140: 6627 7b74 6573 742e 6e61 6d65 7d2d 272c  f'{test.name}-',
-00001150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000006d0: 4131 3027 0a0a 5343 505f 5459 5045 203d  A10'..SCP_TYPE =
+000006e0: 2027 2d2d 636c 6f75 6420 7363 7027 0a53   '--cloud scp'.S
+000006f0: 4350 5f47 5055 5f56 3130 3020 3d20 272d  CP_GPU_V100 = '-
+00000700: 2d67 7075 7320 5631 3030 2d33 3247 4227  -gpus V100-32GB'
+00000710: 0a0a 7374 6f72 6167 655f 7365 7475 705f  ..storage_setup_
+00000720: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
+00000730: 2027 746f 7563 6820 7e2f 746d 7066 696c   'touch ~/tmpfil
+00000740: 6527 2c20 276d 6b64 6972 202d 7020 7e2f  e', 'mkdir -p ~/
+00000750: 746d 702d 776f 726b 6469 7227 2c0a 2020  tmp-workdir',.  
+00000760: 2020 2774 6f75 6368 207e 2f74 6d70 2d77    'touch ~/tmp-w
+00000770: 6f72 6b64 6972 2f74 6d70 5c20 6669 6c65  orkdir/tmp\ file
+00000780: 272c 2027 746f 7563 6820 7e2f 746d 702d  ', 'touch ~/tmp-
+00000790: 776f 726b 6469 722f 746d 705c 2066 696c  workdir/tmp\ fil
+000007a0: 6532 272c 0a20 2020 2027 746f 7563 6820  e2',.    'touch 
+000007b0: 7e2f 746d 702d 776f 726b 6469 722f 666f  ~/tmp-workdir/fo
+000007c0: 6f27 2c0a 2020 2020 276c 6e20 2d66 202d  o',.    'ln -f -
+000007d0: 7320 7e2f 746d 702d 776f 726b 6469 722f  s ~/tmp-workdir/
+000007e0: 207e 2f74 6d70 2d77 6f72 6b64 6972 2f63   ~/tmp-workdir/c
+000007f0: 6972 636c 652d 6c69 6e6b 272c 0a20 2020  ircle-link',.   
+00000800: 2027 746f 7563 6820 7e2f 2e73 7368 2f69   'touch ~/.ssh/i
+00000810: 645f 7273 612e 7075 6227 0a5d 0a0a 2320  d_rsa.pub'.]..# 
+00000820: 5761 6974 2075 6e74 696c 2074 6865 2073  Wait until the s
+00000830: 706f 7420 636f 6e74 726f 6c6c 6572 2069  pot controller i
+00000840: 7320 6e6f 7420 696e 2049 4e49 5420 7374  s not in INIT st
+00000850: 6174 652e 0a23 2054 6869 7320 6973 2061  ate..# This is a
+00000860: 2077 6f72 6b61 726f 756e 6420 666f 7220   workaround for 
+00000870: 7468 6520 6973 7375 6520 7468 6174 2077  the issue that w
+00000880: 6865 6e20 6d75 6c74 6970 6c65 2073 706f  hen multiple spo
+00000890: 7420 7465 7374 730a 2320 6172 6520 7275  t tests.# are ru
+000008a0: 6e6e 696e 6720 696e 2070 6172 616c 6c65  nning in paralle
+000008b0: 6c2c 2074 6865 2073 706f 7420 636f 6e74  l, the spot cont
+000008c0: 726f 6c6c 6572 206d 6179 2062 6520 696e  roller may be in
+000008d0: 2049 4e49 5420 616e 640a 2320 7468 6520   INIT and.# the 
+000008e0: 7370 6f74 2071 7565 7565 2f63 616e 6365  spot queue/cance
+000008f0: 6c20 636f 6d6d 616e 6420 7769 6c6c 2072  l command will r
+00000900: 6574 7572 6e20 7374 616c 6564 2074 6162  eturn staled tab
+00000910: 6c65 2e0a 5f53 504f 545f 5155 4555 455f  le.._SPOT_QUEUE_
+00000920: 5741 4954 203d 2028 2773 3d24 2873 6b79  WAIT = ('s=$(sky
+00000930: 2073 706f 7420 7175 6575 6529 3b20 270a   spot queue); '.
+00000940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000950: 2020 2020 2775 6e74 696c 205b 2060 6563      'until [ `ec
+00000960: 686f 2022 2473 2220 270a 2020 2020 2020  ho "$s" '.      
+00000970: 2020 2020 2020 2020 2020 2020 2020 277c                '|
+00000980: 2067 7265 7020 226a 6f62 7320 7769 6c6c   grep "jobs will
+00000990: 206e 6f74 2062 6520 7368 6f77 6e20 756e   not be shown un
+000009a0: 7469 6c20 6974 2062 6563 6f6d 6573 2055  til it becomes U
+000009b0: 502e 2220 270a 2020 2020 2020 2020 2020  P." '.          
+000009c0: 2020 2020 2020 2020 2020 277c 2077 6320            '| wc 
+000009d0: 2d6c 6020 2d65 7120 3020 5d3b 2027 0a20  -l` -eq 0 ]; '. 
+000009e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000009f0: 2020 2027 646f 2065 6368 6f20 2257 6169     'do echo "Wai
+00000a00: 7469 6e67 2066 6f72 2073 706f 7420 7175  ting for spot qu
+00000a10: 6575 6520 746f 2062 6520 7265 6164 792e  eue to be ready.
+00000a20: 2e2e 223b 2027 0a20 2020 2020 2020 2020  .."; '.         
+00000a30: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00000a40: 7020 353b 2073 3d24 2873 6b79 2073 706f  p 5; s=$(sky spo
+00000a50: 7420 7175 6575 6529 3b20 646f 6e65 3b20  t queue); done; 
+00000a60: 6563 686f 2022 2473 223b 2027 0a20 2020  echo "$s"; '.   
+00000a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000a80: 2027 6563 686f 3b20 6563 686f 3b20 6563   'echo; echo; ec
+00000a90: 686f 2022 2473 2227 290a 5f53 504f 545f  ho "$s"')._SPOT_
+00000aa0: 4341 4e43 454c 5f57 4149 5420 3d20 280a  CANCEL_WAIT = (.
+00000ab0: 2020 2020 2773 3d24 2873 6b79 2073 706f      's=$(sky spo
+00000ac0: 7420 6361 6e63 656c 202d 7920 2d6e 207b  t cancel -y -n {
+00000ad0: 6a6f 625f 6e61 6d65 7d29 3b20 756e 7469  job_name}); unti
+00000ae0: 6c20 5b20 6065 6368 6f20 2224 7322 2027  l [ `echo "$s" '
+00000af0: 0a20 2020 2027 7c20 6772 6570 2022 506c  .    '| grep "Pl
+00000b00: 6561 7365 2077 6169 7420 666f 7220 7468  ease wait for th
+00000b10: 6520 636f 6e74 726f 6c6c 6572 2074 6f20  e controller to 
+00000b20: 6265 2072 6561 6479 2e22 2027 0a20 2020  be ready." '.   
+00000b30: 2027 7c20 7763 202d 6c60 202d 6571 2030   '| wc -l` -eq 0
+00000b40: 205d 3b20 646f 2065 6368 6f20 2257 6169   ]; do echo "Wai
+00000b50: 7469 6e67 2066 6f72 2074 6865 2073 706f  ting for the spo
+00000b60: 7420 636f 6e74 726f 6c6c 6572 2027 0a20  t controller '. 
+00000b70: 2020 2027 746f 2062 6520 7265 6164 7922     'to be ready"
+00000b80: 3b20 736c 6565 7020 353b 2073 3d24 2873  ; sleep 5; s=$(s
+00000b90: 6b79 2073 706f 7420 6361 6e63 656c 202d  ky spot cancel -
+00000ba0: 7920 2d6e 207b 6a6f 625f 6e61 6d65 7d29  y -n {job_name})
+00000bb0: 3b20 270a 2020 2020 2764 6f6e 653b 2065  ; '.    'done; e
+00000bc0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+00000bd0: 6563 686f 3b20 6563 686f 2022 2473 2227  echo; echo "$s"'
+00000be0: 290a 2320 544f 444f 287a 6877 7529 3a20  ).# TODO(zhwu): 
+00000bf0: 6d61 6b65 2074 6865 2073 706f 7420 636f  make the spot co
+00000c00: 6e74 726f 6c6c 6572 206f 6e20 4743 502e  ntroller on GCP.
+00000c10: 0a0a 0a63 6c61 7373 2054 6573 7428 4e61  ...class Test(Na
+00000c20: 6d65 6454 7570 6c65 293a 0a20 2020 206e  medTuple):.    n
+00000c30: 616d 653a 2073 7472 0a20 2020 2023 2045  ame: str.    # E
+00000c40: 6163 6820 636f 6d6d 616e 6420 6973 2065  ach command is e
+00000c50: 7865 6375 7465 6420 7365 7269 616c 6c79  xecuted serially
+00000c60: 2e20 2049 6620 616e 7920 6661 696c 6564  .  If any failed
+00000c70: 2c20 7468 6520 7265 6d61 696e 696e 6720  , the remaining 
+00000c80: 636f 6d6d 616e 6473 0a20 2020 2023 2061  commands.    # a
+00000c90: 7265 206e 6f74 2072 756e 2061 6e64 2074  re not run and t
+00000ca0: 6865 2074 6573 7420 6973 2074 7265 6174  he test is treat
+00000cb0: 6564 2061 7320 6661 696c 6564 2e0a 2020  ed as failed..  
+00000cc0: 2020 636f 6d6d 616e 6473 3a20 4c69 7374    commands: List
+00000cd0: 5b73 7472 5d0a 2020 2020 7465 6172 646f  [str].    teardo
+00000ce0: 776e 3a20 4f70 7469 6f6e 616c 5b73 7472  wn: Optional[str
+00000cf0: 5d20 3d20 4e6f 6e65 0a20 2020 2023 2054  ] = None.    # T
+00000d00: 696d 656f 7574 2066 6f72 2065 6163 6820  imeout for each 
+00000d10: 636f 6d6d 616e 6420 696e 2073 6563 6f6e  command in secon
+00000d20: 6473 2e0a 2020 2020 7469 6d65 6f75 743a  ds..    timeout:
+00000d30: 2069 6e74 203d 2031 3520 2a20 3630 0a0a   int = 15 * 60..
+00000d40: 2020 2020 6465 6620 6563 686f 2873 656c      def echo(sel
+00000d50: 662c 206d 6573 7361 6765 3a20 7374 7229  f, message: str)
+00000d60: 3a0a 2020 2020 2020 2020 2320 7079 7465  :.        # pyte
+00000d70: 7374 2773 2078 6469 7374 2070 6c75 6769  st's xdist plugi
+00000d80: 6e20 6361 7074 7572 6573 2073 7464 6f75  n captures stdou
+00000d90: 743b 2070 7269 6e74 2074 6f20 7374 6465  t; print to stde
+00000da0: 7272 2073 6f20 7468 6174 2074 6865 0a20  rr so that the. 
+00000db0: 2020 2020 2020 2023 206c 6f67 7320 6172         # logs ar
+00000dc0: 6520 7374 7265 616d 696e 6720 7768 696c  e streaming whil
+00000dd0: 6520 7468 6520 7465 7374 7320 6172 6520  e the tests are 
+00000de0: 7275 6e6e 696e 672e 0a20 2020 2020 2020  running..       
+00000df0: 2070 7265 6669 7820 3d20 6627 5b7b 7365   prefix = f'[{se
+00000e00: 6c66 2e6e 616d 657d 5d27 0a20 2020 2020  lf.name}]'.     
+00000e10: 2020 206d 6573 7361 6765 203d 2066 277b     message = f'{
+00000e20: 7072 6566 6978 7d20 7b6d 6573 7361 6765  prefix} {message
+00000e30: 7d27 0a20 2020 2020 2020 206d 6573 7361  }'.        messa
+00000e40: 6765 203d 206d 6573 7361 6765 2e72 6570  ge = message.rep
+00000e50: 6c61 6365 2827 5c6e 272c 2066 275c 6e7b  lace('\n', f'\n{
+00000e60: 7072 6566 6978 7d20 2729 0a20 2020 2020  prefix} ').     
+00000e70: 2020 2070 7269 6e74 286d 6573 7361 6765     print(message
+00000e80: 2c20 6669 6c65 3d73 7973 2e73 7464 6572  , file=sys.stder
+00000e90: 722c 2066 6c75 7368 3d54 7275 6529 0a0a  r, flush=True)..
+00000ea0: 0a64 6566 205f 6765 745f 636c 7573 7465  .def _get_cluste
+00000eb0: 725f 6e61 6d65 2829 202d 3e20 7374 723a  r_name() -> str:
+00000ec0: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
+00000ed0: 6120 7573 6572 2d75 6e69 7175 6520 636c  a user-unique cl
+00000ee0: 7573 7465 7220 6e61 6d65 2066 6f72 2065  uster name for e
+00000ef0: 6163 6820 7465 7374 5f3c 6e61 6d65 3e28  ach test_<name>(
+00000f00: 292e 0a0a 2020 2020 4d75 7374 2062 6520  )...    Must be 
+00000f10: 6361 6c6c 6564 2066 726f 6d20 6561 6368  called from each
+00000f20: 2074 6573 745f 3c6e 616d 653e 2829 2e0a   test_<name>()..
+00000f30: 2020 2020 2222 220a 2020 2020 6361 6c6c      """.    call
+00000f40: 6572 5f66 756e 635f 6e61 6d65 203d 2069  er_func_name = i
+00000f50: 6e73 7065 6374 2e73 7461 636b 2829 5b31  nspect.stack()[1
+00000f60: 5d5b 335d 0a20 2020 2074 6573 745f 6e61  ][3].    test_na
+00000f70: 6d65 203d 2063 616c 6c65 725f 6675 6e63  me = caller_func
+00000f80: 5f6e 616d 652e 7265 706c 6163 6528 275f  _name.replace('_
+00000f90: 272c 2027 2d27 292e 7265 706c 6163 6528  ', '-').replace(
+00000fa0: 2774 6573 742d 272c 2027 742d 2729 0a20  'test-', 't-'). 
+00000fb0: 2020 2069 6620 6c65 6e28 7465 7374 5f6e     if len(test_n
+00000fc0: 616d 6529 203e 2031 363a 0a20 2020 2020  ame) > 16:.     
+00000fd0: 2020 2074 6573 745f 6e61 6d65 203d 2074     test_name = t
+00000fe0: 6573 745f 6e61 6d65 5b3a 3136 5d20 2b20  est_name[:16] + 
+00000ff0: 6861 7368 6c69 622e 6d64 3528 0a20 2020  hashlib.md5(.   
+00001000: 2020 2020 2020 2020 2074 6573 745f 6e61           test_na
+00001010: 6d65 2e65 6e63 6f64 6528 2929 2e68 6578  me.encode()).hex
+00001020: 6469 6765 7374 2829 5b3a 335d 0a20 2020  digest()[:3].   
+00001030: 2072 6574 7572 6e20 6627 7b74 6573 745f   return f'{test_
+00001040: 6e61 6d65 7d2d 7b5f 736d 6f6b 655f 7465  name}-{_smoke_te
+00001050: 7374 5f68 6173 687d 2d7b 7465 7374 5f69  st_hash}-{test_i
+00001060: 647d 270a 0a0a 6465 6620 7275 6e5f 6f6e  d}'...def run_on
+00001070: 655f 7465 7374 2874 6573 743a 2054 6573  e_test(test: Tes
+00001080: 7429 202d 3e20 5475 706c 655b 696e 742c  t) -> Tuple[int,
+00001090: 2073 7472 2c20 7374 725d 3a0a 2020 2020   str, str]:.    
+000010a0: 2320 4661 696c 2066 6173 7420 6966 2060  # Fail fast if `
+000010b0: 736b 7960 2043 4c49 2073 6f6d 6568 6f77  sky` CLI somehow
+000010c0: 2065 7272 6f72 7320 6f75 742e 0a20 2020   errors out..   
+000010d0: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
+000010e0: 5b27 736b 7927 2c20 2773 7461 7475 7327  ['sky', 'status'
+000010f0: 5d2c 2073 7464 6f75 743d 7375 6270 726f  ], stdout=subpro
+00001100: 6365 7373 2e44 4556 4e55 4c4c 2c20 6368  cess.DEVNULL, ch
+00001110: 6563 6b3d 5472 7565 290a 2020 2020 6c6f  eck=True).    lo
+00001120: 675f 6669 6c65 203d 2074 656d 7066 696c  g_file = tempfil
+00001130: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
+00001140: 4669 6c65 2827 6127 2c0a 2020 2020 2020  File('a',.      
+00001150: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001170: 2020 2020 2020 2020 2020 2020 7375 6666              suff
-00001180: 6978 3d27 2e6c 6f67 272c 0a20 2020 2020  ix='.log',.     
+00001170: 2020 2020 2070 7265 6669 783d 6627 7b74       prefix=f'{t
+00001180: 6573 742e 6e61 6d65 7d2d 272c 0a20 2020  est.name}-',.   
 00001190: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000011a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011b0: 2020 2020 2020 6465 6c65 7465 3d46 616c        delete=Fal
-000011c0: 7365 290a 2020 2020 7465 7374 2e65 6368  se).    test.ech
-000011d0: 6f28 6627 5465 7374 2073 7461 7274 6564  o(f'Test started
-000011e0: 2e20 4c6f 673a 206c 6573 7320 7b6c 6f67  . Log: less {log
-000011f0: 5f66 696c 652e 6e61 6d65 7d27 290a 2020  _file.name}').  
-00001200: 2020 666f 7220 636f 6d6d 616e 6420 696e    for command in
-00001210: 2074 6573 742e 636f 6d6d 616e 6473 3a0a   test.commands:.
-00001220: 2020 2020 2020 2020 6c6f 675f 6669 6c65          log_file
-00001230: 2e77 7269 7465 2866 272b 207b 636f 6d6d  .write(f'+ {comm
-00001240: 616e 647d 5c6e 2729 0a20 2020 2020 2020  and}\n').       
-00001250: 206c 6f67 5f66 696c 652e 666c 7573 6828   log_file.flush(
-00001260: 290a 2020 2020 2020 2020 7072 6f63 203d  ).        proc =
-00001270: 2073 7562 7072 6f63 6573 732e 506f 7065   subprocess.Pope
-00001280: 6e28 0a20 2020 2020 2020 2020 2020 2063  n(.            c
-00001290: 6f6d 6d61 6e64 2c0a 2020 2020 2020 2020  ommand,.        
-000012a0: 2020 2020 7374 646f 7574 3d6c 6f67 5f66      stdout=log_f
-000012b0: 696c 652c 0a20 2020 2020 2020 2020 2020  ile,.           
-000012c0: 2073 7464 6572 723d 7375 6270 726f 6365   stderr=subproce
-000012d0: 7373 2e53 5444 4f55 542c 0a20 2020 2020  ss.STDOUT,.     
-000012e0: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-000012f0: 652c 0a20 2020 2020 2020 2020 2020 2065  e,.            e
-00001300: 7865 6375 7461 626c 653d 272f 6269 6e2f  xecutable='/bin/
-00001310: 6261 7368 272c 0a20 2020 2020 2020 2029  bash',.        )
-00001320: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00001330: 2020 2020 2020 2020 2020 7072 6f63 2e77            proc.w
-00001340: 6169 7428 7469 6d65 6f75 743d 7465 7374  ait(timeout=test
-00001350: 2e74 696d 656f 7574 290a 2020 2020 2020  .timeout).      
-00001360: 2020 6578 6365 7074 2073 7562 7072 6f63    except subproc
-00001370: 6573 732e 5469 6d65 6f75 7445 7870 6972  ess.TimeoutExpir
-00001380: 6564 2061 7320 653a 0a20 2020 2020 2020  ed as e:.       
-00001390: 2020 2020 206c 6f67 5f66 696c 652e 666c       log_file.fl
-000013a0: 7573 6828 290a 2020 2020 2020 2020 2020  ush().          
-000013b0: 2020 7465 7374 2e65 6368 6f28 6627 5469    test.echo(f'Ti
-000013c0: 6d65 6f75 7420 6166 7465 7220 7b74 6573  meout after {tes
-000013d0: 742e 7469 6d65 6f75 747d 2073 6563 6f6e  t.timeout} secon
-000013e0: 6473 2e27 290a 2020 2020 2020 2020 2020  ds.').          
-000013f0: 2020 7465 7374 2e65 6368 6f28 6529 0a20    test.echo(e). 
-00001400: 2020 2020 2020 2020 2020 206c 6f67 5f66             log_f
-00001410: 696c 652e 7772 6974 6528 6627 5469 6d65  ile.write(f'Time
-00001420: 6f75 7420 6166 7465 7220 7b74 6573 742e  out after {test.
-00001430: 7469 6d65 6f75 747d 2073 6563 6f6e 6473  timeout} seconds
-00001440: 2e5c 6e27 290a 2020 2020 2020 2020 2020  .\n').          
-00001450: 2020 6c6f 675f 6669 6c65 2e66 6c75 7368    log_file.flush
-00001460: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
-00001470: 204b 696c 6c20 7468 6520 6375 7272 656e   Kill the curren
-00001480: 7420 7072 6f63 6573 732e 0a20 2020 2020  t process..     
-00001490: 2020 2020 2020 2070 726f 632e 7465 726d         proc.term
-000014a0: 696e 6174 6528 290a 2020 2020 2020 2020  inate().        
-000014b0: 2020 2020 7072 6f63 2e72 6574 7572 6e63      proc.returnc
-000014c0: 6f64 6520 3d20 3120 2023 204e 6f6e 6520  ode = 1  # None 
-000014d0: 6966 2077 6520 646f 6e27 7420 7365 7420  if we don't set 
-000014e0: 6974 2e0a 2020 2020 2020 2020 2020 2020  it..            
-000014f0: 6272 6561 6b0a 0a20 2020 2020 2020 2069  break..        i
-00001500: 6620 7072 6f63 2e72 6574 7572 6e63 6f64  f proc.returncod
-00001510: 653a 0a20 2020 2020 2020 2020 2020 2062  e:.            b
-00001520: 7265 616b 0a0a 2020 2020 7374 796c 6520  reak..    style 
-00001530: 3d20 636f 6c6f 7261 6d61 2e53 7479 6c65  = colorama.Style
-00001540: 0a20 2020 2066 6f72 6520 3d20 636f 6c6f  .    fore = colo
-00001550: 7261 6d61 2e46 6f72 650a 2020 2020 6f75  rama.Fore.    ou
-00001560: 7463 6f6d 6520 3d20 2866 277b 666f 7265  tcome = (f'{fore
-00001570: 2e52 4544 7d46 6169 6c65 647b 7374 796c  .RED}Failed{styl
-00001580: 652e 5245 5345 545f 414c 4c7d 270a 2020  e.RESET_ALL}'.  
-00001590: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000015a0: 7072 6f63 2e72 6574 7572 6e63 6f64 6520  proc.returncode 
-000015b0: 656c 7365 2066 277b 666f 7265 2e47 5245  else f'{fore.GRE
-000015c0: 454e 7d50 6173 7365 647b 7374 796c 652e  EN}Passed{style.
-000015d0: 5245 5345 545f 414c 4c7d 2729 0a20 2020  RESET_ALL}').   
-000015e0: 2072 6561 736f 6e20 3d20 6627 5c6e 5265   reason = f'\nRe
-000015f0: 6173 6f6e 3a20 7b63 6f6d 6d61 6e64 7d27  ason: {command}'
-00001600: 2069 6620 7072 6f63 2e72 6574 7572 6e63   if proc.returnc
-00001610: 6f64 6520 656c 7365 2027 270a 2020 2020  ode else ''.    
-00001620: 6d73 6720 3d20 2866 277b 6f75 7463 6f6d  msg = (f'{outcom
-00001630: 657d 2e27 0a20 2020 2020 2020 2020 2020  e}.'.           
-00001640: 6627 7b72 6561 736f 6e7d 270a 2020 2020  f'{reason}'.    
-00001650: 2020 2020 2020 2066 275c 6e4c 6f67 3a20         f'\nLog: 
-00001660: 6c65 7373 207b 6c6f 675f 6669 6c65 2e6e  less {log_file.n
-00001670: 616d 657d 5c6e 2729 0a20 2020 2074 6573  ame}\n').    tes
-00001680: 742e 6563 686f 286d 7367 290a 2020 2020  t.echo(msg).    
-00001690: 6c6f 675f 6669 6c65 2e77 7269 7465 286d  log_file.write(m
-000016a0: 7367 290a 2020 2020 6966 2028 7072 6f63  sg).    if (proc
-000016b0: 2e72 6574 7572 6e63 6f64 6520 3d3d 2030  .returncode == 0
-000016c0: 206f 720a 2020 2020 2020 2020 2020 2020   or.            
-000016d0: 7079 7465 7374 2e74 6572 6d69 6e61 7465  pytest.terminate
-000016e0: 5f6f 6e5f 6661 696c 7572 6529 2061 6e64  _on_failure) and
-000016f0: 2074 6573 742e 7465 6172 646f 776e 2069   test.teardown i
-00001700: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00001710: 2020 2020 7375 6270 726f 6365 7373 5f75      subprocess_u
-00001720: 7469 6c73 2e72 756e 280a 2020 2020 2020  tils.run(.      
-00001730: 2020 2020 2020 7465 7374 2e74 6561 7264        test.teard
-00001740: 6f77 6e2c 0a20 2020 2020 2020 2020 2020  own,.           
-00001750: 2073 7464 6f75 743d 6c6f 675f 6669 6c65   stdout=log_file
-00001760: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-00001770: 6465 7272 3d73 7562 7072 6f63 6573 732e  derr=subprocess.
-00001780: 5354 444f 5554 2c0a 2020 2020 2020 2020  STDOUT,.        
-00001790: 2020 2020 7469 6d65 6f75 743d 3130 202a      timeout=10 *
-000017a0: 2036 302c 2020 2320 3130 206d 696e 730a   60,  # 10 mins.
-000017b0: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-000017c0: 6c3d 5472 7565 2c0a 2020 2020 2020 2020  l=True,.        
-000017d0: 290a 0a20 2020 2069 6620 7072 6f63 2e72  )..    if proc.r
-000017e0: 6574 7572 6e63 6f64 653a 0a20 2020 2020  eturncode:.     
-000017f0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00001800: 6f6e 2866 2774 6573 7420 6661 696c 6564  on(f'test failed
-00001810: 3a20 6c65 7373 207b 6c6f 675f 6669 6c65  : less {log_file
-00001820: 2e6e 616d 657d 2729 0a0a 0a23 202d 2d2d  .name}')...# ---
-00001830: 2d2d 2d2d 2d2d 2d20 4472 7920 7275 6e3a  ------- Dry run:
-00001840: 2032 2054 6173 6b73 2069 6e20 6120 6368   2 Tasks in a ch
-00001850: 6169 6e2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ain. ----------.
-00001860: 6465 6620 7465 7374 5f65 7861 6d70 6c65  def test_example
-00001870: 5f61 7070 2829 3a0a 2020 2020 7465 7374  _app():.    test
-00001880: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00001890: 2027 6578 616d 706c 655f 6170 7027 2c0a   'example_app',.
-000018a0: 2020 2020 2020 2020 5b27 7079 7468 6f6e          ['python
-000018b0: 2065 7861 6d70 6c65 732f 6578 616d 706c   examples/exampl
-000018c0: 655f 6170 702e 7079 275d 2c0a 2020 2020  e_app.py'],.    
-000018d0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-000018e0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-000018f0: 2d2d 2d2d 2d2d 2d20 4120 6d69 6e69 6d61  ------- A minima
-00001900: 6c20 7461 736b 202d 2d2d 2d2d 2d2d 2d2d  l task ---------
-00001910: 2d0a 6465 6620 7465 7374 5f6d 696e 696d  -.def test_minim
-00001920: 616c 2867 656e 6572 6963 5f63 6c6f 7564  al(generic_cloud
-00001930: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
-00001940: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00001950: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00001960: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00001970: 276d 696e 696d 616c 272c 0a20 2020 2020  'minimal',.     
-00001980: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00001990: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000019a0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000019b0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-000019c0: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
-000019d0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-000019e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000019f0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00001a00: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-00001a10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00001a20: 6c6f 6773 207b 6e61 6d65 7d20 2d2d 7374  logs {name} --st
-00001a30: 6174 7573 207c 2067 7265 7020 224a 6f62  atus | grep "Job
-00001a40: 2031 3a20 5355 4343 4545 4445 4422 272c   1: SUCCEEDED"',
-00001a50: 2020 2320 4571 7569 7661 6c65 6e74 2e0a    # Equivalent..
-00001a60: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
-00001a70: 6563 6b20 7468 6520 6c6f 6773 2064 6f77  eck the logs dow
-00001a80: 6e6c 6f61 6469 6e67 0a20 2020 2020 2020  nloading.       
-00001a90: 2020 2020 2066 276c 6f67 5f70 6174 683d       f'log_path=
-00001aa0: 2428 736b 7920 6c6f 6773 207b 6e61 6d65  $(sky logs {name
-00001ab0: 7d20 3120 2d2d 7379 6e63 2d64 6f77 6e20  } 1 --sync-down 
-00001ac0: 7c20 6772 6570 2022 4a6f 6220 3120 6c6f  | grep "Job 1 lo
-00001ad0: 6773 3a22 207c 2073 6564 202d 4520 2273  gs:" | sed -E "s
-00001ae0: 2f5e 2e2a 4a6f 6220 3120 6c6f 6773 3a20  /^.*Job 1 logs: 
-00001af0: 282e 2a29 5c5c 7831 625c 5c5b 306d 2f5c  (.*)\\x1b\\[0m/\
-00001b00: 5c31 2f67 2229 2026 2620 6563 686f 2024  \1/g") && echo $
-00001b10: 6c6f 675f 7061 7468 2026 2620 7465 7374  log_path && test
-00001b20: 202d 6620 246c 6f67 5f70 6174 682f 7275   -f $log_path/ru
-00001b30: 6e2e 6c6f 6727 2c0a 2020 2020 2020 2020  n.log',.        
-00001b40: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-00001b50: 2072 6179 6c65 7420 7072 6f63 6573 7320   raylet process 
-00001b60: 6861 7320 7468 6520 636f 7272 6563 7420  has the correct 
-00001b70: 6669 6c65 2064 6573 6372 6970 746f 7220  file descriptor 
-00001b80: 6c69 6d69 742e 0a20 2020 2020 2020 2020  limit..         
-00001b90: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00001ba0: 616d 657d 2022 7072 6c69 6d69 7420 2d6e  ame} "prlimit -n
-00001bb0: 202d 2d70 6964 3d5c 2428 7067 7265 7020   --pid=\$(pgrep 
-00001bc0: 2d66 205c 2772 6179 6c65 742f 7261 796c  -f \'raylet/rayl
-00001bd0: 6574 202d 2d72 6179 6c65 745f 736f 636b  et --raylet_sock
-00001be0: 6574 5f6e 616d 655c 2729 207c 2067 7265  et_name\') | gre
-00001bf0: 7020 5c27 225c 2731 3034 3835 3736 2031  p \'"\'1048576 1
-00001c00: 3034 3835 3736 5c27 225c 2722 272c 0a20  048576\'"\'"',. 
-00001c10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00001c20: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-00001c30: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00001c40: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00001c50: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-00001c60: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00001c70: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00001c80: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00001c90: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00001ca0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-00001cb0: 7420 7265 6769 6f6e 202d 2d2d 2d2d 2d2d  t region -------
-00001cc0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00001cd0: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
-00001ce0: 735f 7265 6769 6f6e 2829 3a0a 2020 2020  s_region():.    
-00001cf0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00001d00: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00001d10: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00001d20: 2020 2020 2761 7773 5f72 6567 696f 6e27      'aws_region'
-00001d30: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00001d40: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00001d50: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00001d60: 7d20 2d2d 7265 6769 6f6e 2075 732d 7765  } --region us-we
-00001d70: 7374 2d32 2065 7861 6d70 6c65 732f 6d69  st-2 examples/mi
-00001d80: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00001d90: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00001da0: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-00001db0: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00001dc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00001dd0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00001de0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00001df0: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00001e00: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00001e10: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00001e20: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
-00001e30: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
-00001e40: 732d 7765 7374 2d32 272c 2020 2320 456e  s-west-2',  # En
-00001e50: 7375 7265 2074 6865 2072 6567 696f 6e20  sure the region 
-00001e60: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
-00001e70: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00001e80: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00001e90: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00001ea0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00001eb0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00001ec0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-00001ed0: 6370 5f72 6567 696f 6e28 293a 0a20 2020  cp_region():.   
-00001ee0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00001ef0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00001f00: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00001f10: 2020 2020 2027 6763 705f 7265 6769 6f6e       'gcp_region
-00001f20: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00001f30: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00001f40: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00001f50: 657d 202d 2d72 6567 696f 6e20 7573 2d63  e} --region us-c
-00001f60: 656e 7472 616c 3120 2d2d 636c 6f75 6420  entral1 --cloud 
-00001f70: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
-00001f80: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00001f90: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00001fa0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00001fb0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-00001fc0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00001fd0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00001fe0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00001ff0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00002000: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00002010: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00002020: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-00002030: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
-00002040: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
-00002050: 2d63 656e 7472 616c 3127 2c20 2023 2045  -central1',  # E
-00002060: 6e73 7572 6520 7468 6520 7265 6769 6f6e  nsure the region
-00002070: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
-00002080: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00002090: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-000020a0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-000020b0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000020c0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-000020d0: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
-000020e0: 6962 6d5f 7265 6769 6f6e 2829 3a0a 2020  ibm_region():.  
-000020f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00002100: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00002110: 2072 6567 696f 6e20 3d20 2765 752d 6465   region = 'eu-de
-00002120: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
-00002130: 7428 0a20 2020 2020 2020 2027 7265 6769  t(.        'regi
-00002140: 6f6e 272c 0a20 2020 2020 2020 205b 0a20  on',.        [. 
-00002150: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00002160: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00002170: 616d 657d 202d 2d63 6c6f 7564 2069 626d  ame} --cloud ibm
-00002180: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00002190: 6e7d 2065 7861 6d70 6c65 732f 6d69 6e69  n} examples/mini
-000021a0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-000021b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000021c0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-000021d0: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
-000021e0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-000021f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00002200: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00002210: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00002220: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00002230: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00002240: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00002250: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
-00002260: 7d20 7c20 6772 6570 207b 7265 6769 6f6e  } | grep {region
-00002270: 7d27 2c20 2023 2045 6e73 7572 6520 7468  }',  # Ensure th
-00002280: 6520 7265 6769 6f6e 2069 7320 636f 7272  e region is corr
-00002290: 6563 742e 0a20 2020 2020 2020 205d 2c0a  ect..        ],.
-000022a0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000022b0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000022c0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000022d0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000022e0: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
-000022f0: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
-00002300: 7265 6769 6f6e 2829 3a0a 2020 2020 6e61  region():.    na
-00002310: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00002320: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00002330: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00002340: 2020 2761 7a75 7265 5f72 6567 696f 6e27    'azure_region'
-00002350: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00002360: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00002370: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00002380: 7d20 2d2d 7265 6769 6f6e 2065 6173 7475  } --region eastu
-00002390: 7332 202d 2d63 6c6f 7564 2061 7a75 7265  s2 --cloud azure
-000023a0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-000023b0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-000023c0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000023d0: 6b79 2065 7865 6320 7b6e 616d 657d 2074  ky exec {name} t
-000023e0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-000023f0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00002400: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00002410: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00002420: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-00002430: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-00002440: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-00002450: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-00002460: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
-00002470: 6d65 7d20 7c20 6772 6570 2065 6173 7475  me} | grep eastu
-00002480: 7332 272c 2020 2320 456e 7375 7265 2074  s2',  # Ensure t
-00002490: 6865 2072 6567 696f 6e20 6973 2063 6f72  he region is cor
-000024a0: 7265 6374 2e0a 2020 2020 2020 2020 5d2c  rect..        ],
-000024b0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-000024c0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-000024d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-000024e0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-000024f0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00002500: 207a 6f6e 6520 2d2d 2d2d 2d2d 2d2d 2d2d   zone ----------
-00002510: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00002520: 730a 6465 6620 7465 7374 5f61 7773 5f7a  s.def test_aws_z
-00002530: 6f6e 6528 293a 0a20 2020 206e 616d 6520  one():.    name 
-00002540: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00002550: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00002560: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00002570: 6177 735f 7a6f 6e65 272c 0a20 2020 2020  aws_zone',.     
-00002580: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00002590: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000025a0: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
-000025b0: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-000025c0: 202d 2d7a 6f6e 6520 7573 2d77 6573 742d   --zone us-west-
-000025d0: 3262 272c 0a20 2020 2020 2020 2020 2020  2b',.           
-000025e0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000025f0: 657d 2065 7861 6d70 6c65 732f 6d69 6e69  e} examples/mini
-00002600: 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e 6520  mal.yaml --zone 
-00002610: 7573 2d77 6573 742d 3262 272c 0a20 2020  us-west-2b',.   
-00002620: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00002630: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00002640: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00002650: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00002660: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-00002670: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
-00002680: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
-00002690: 7d20 7c20 6772 6570 2075 732d 7765 7374  } | grep us-west
-000026a0: 2d32 6227 2c20 2023 2045 6e73 7572 6520  -2b',  # Ensure 
-000026b0: 7468 6520 7a6f 6e65 2069 7320 636f 7272  the zone is corr
-000026c0: 6563 742e 0a20 2020 2020 2020 205d 2c0a  ect..        ],.
-000026d0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000026e0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000026f0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00002700: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00002710: 7974 6573 742e 6d61 726b 2e69 626d 0a64  ytest.mark.ibm.d
-00002720: 6566 2074 6573 745f 6962 6d5f 7a6f 6e65  ef test_ibm_zone
-00002730: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00002740: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00002750: 2829 0a20 2020 207a 6f6e 6520 3d20 2765  ().    zone = 'e
-00002760: 752d 6465 2d32 270a 2020 2020 7465 7374  u-de-2'.    test
-00002770: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00002780: 2027 7a6f 6e65 272c 0a20 2020 2020 2020   'zone',.       
-00002790: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000027a0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000027b0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-000027c0: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
-000027d0: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
-000027e0: 6520 7b7a 6f6e 657d 272c 0a20 2020 2020  e {zone}',.     
-000027f0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00002800: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00002810: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
-00002820: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
-00002830: 6520 7b7a 6f6e 657d 272c 0a20 2020 2020  e {zone}',.     
-00002840: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00002850: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00002860: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00002870: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00002880: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00002890: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-000028a0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-000028b0: 7c20 6772 6570 207b 7a6f 6e65 7d27 2c20  | grep {zone}', 
-000028c0: 2023 2045 6e73 7572 6520 7468 6520 7a6f   # Ensure the zo
-000028d0: 6e65 2069 7320 636f 7272 6563 742e 0a20  ne is correct.. 
-000028e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-000028f0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00002900: 7b6e 616d 657d 207b 6e61 6d65 7d2d 3220  {name} {name}-2 
-00002910: 7b6e 616d 657d 2d33 272c 0a20 2020 2029  {name}-3',.    )
-00002920: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00002930: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-00002940: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00002950: 6573 745f 6763 705f 7a6f 6e65 2829 3a0a  est_gcp_zone():.
-00002960: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00002970: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00002980: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00002990: 2020 2020 2020 2020 2767 6370 5f7a 6f6e          'gcp_zon
-000029a0: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-000029b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000029c0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-000029d0: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 6365  me} --zone us-ce
-000029e0: 6e74 7261 6c31 2d61 202d 2d63 6c6f 7564  ntral1-a --cloud
-000029f0: 2067 6370 2074 6573 7473 2f74 6573 745f   gcp tests/test_
-00002a00: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00002a10: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00002a20: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00002a30: 657d 202d 2d7a 6f6e 6520 7573 2d63 656e  e} --zone us-cen
-00002a40: 7472 616c 312d 6120 2d2d 636c 6f75 6420  tral1-a --cloud 
-00002a50: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
-00002a60: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00002a70: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00002a80: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00002a90: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00002aa0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00002ab0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00002ac0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00002ad0: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
-00002ae0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00002af0: 7573 2d63 656e 7472 616c 312d 6127 2c20  us-central1-a', 
-00002b00: 2023 2045 6e73 7572 6520 7468 6520 7a6f   # Ensure the zo
-00002b10: 6e65 2069 7320 636f 7272 6563 742e 0a20  ne is correct.. 
-00002b20: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00002b30: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00002b40: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00002b50: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00002b60: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00002b70: 2d2d 2d2d 2054 6573 7420 7468 6520 696d  ---- Test the im
-00002b80: 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  age ----------.@
-00002b90: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00002ba0: 6465 6620 7465 7374 5f61 7773 5f69 6d61  def test_aws_ima
-00002bb0: 6765 7328 293a 0a20 2020 206e 616d 6520  ges():.    name 
-00002bc0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00002bd0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00002be0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00002bf0: 6177 735f 696d 6167 6573 272c 0a20 2020  aws_images',.   
-00002c00: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00002c10: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00002c20: 2d79 202d 6320 7b6e 616d 657d 202d 2d69  -y -c {name} --i
-00002c30: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00002c40: 3a67 7075 2d75 6275 6e74 752d 3138 3034  :gpu-ubuntu-1804
-00002c50: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-00002c60: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00002c70: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00002c80: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00002c90: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00002ca0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00002cb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002cc0: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-00002cd0: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
-00002ce0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
-00002cf0: 7475 2d32 3030 3420 6578 616d 706c 6573  tu-2004 examples
-00002d00: 2f6d 696e 696d 616c 2e79 616d 6c20 2626  /minimal.yaml &&
-00002d10: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
-00002d20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00002d30: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00002d40: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-00002d50: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00002d60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00002d70: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-00002d80: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00002d90: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00002da0: 7320 7b6e 616d 657d 202d 2d73 7461 7475  s {name} --statu
-00002db0: 7320 7c20 6772 6570 2022 4a6f 6220 323a  s | grep "Job 2:
-00002dc0: 2053 5543 4345 4544 4544 2227 2c20 2023   SUCCEEDED"',  #
-00002dd0: 2045 7175 6976 616c 656e 742e 0a20 2020   Equivalent..   
-00002de0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00002df0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00002e00: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-00002e10: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00002e20: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00002e30: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
-00002e40: 6763 705f 696d 6167 6573 2829 3a0a 2020  gcp_images():.  
-00002e50: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00002e60: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00002e70: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00002e80: 2020 2020 2020 2767 6370 5f69 6d61 6765        'gcp_image
-00002e90: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-00002ea0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00002eb0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00002ec0: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
-00002ed0: 6b79 7069 6c6f 743a 6770 752d 6465 6269  kypilot:gpu-debi
-00002ee0: 616e 2d31 3020 2d2d 636c 6f75 6420 6763  an-10 --cloud gc
-00002ef0: 7020 7465 7374 732f 7465 7374 5f79 616d  p tests/test_yam
-00002f00: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-00002f10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00002f20: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00002f30: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00002f40: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00002f50: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00002f60: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00002f70: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
-00002f80: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-00002f90: 3a63 7075 2d64 6562 6961 6e2d 3130 202d  :cpu-debian-10 -
-00002fa0: 2d63 6c6f 7564 2067 6370 2074 6573 7473  -cloud gcp tests
-00002fb0: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00002fc0: 6d61 6c2e 7961 6d6c 2026 2620 6578 6974  mal.yaml && exit
-00002fd0: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
-00002fe0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00002ff0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00003000: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
-00003010: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00003020: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003030: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00003040: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-00003050: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003060: 6c6f 6773 207b 6e61 6d65 7d20 2d2d 7374  logs {name} --st
-00003070: 6174 7573 207c 2067 7265 7020 224a 6f62  atus | grep "Job
-00003080: 2032 3a20 5355 4343 4545 4445 4422 272c   2: SUCCEEDED"',
-00003090: 2020 2320 4571 7569 7661 6c65 6e74 2e0a    # Equivalent..
-000030a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000030b0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-000030c0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-000030d0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-000030e0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-000030f0: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-00003100: 7374 5f61 7773 5f69 6d61 6765 5f69 645f  st_aws_image_id_
-00003110: 6469 6374 2829 3a0a 2020 2020 6e61 6d65  dict():.    name
-00003120: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00003130: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00003140: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00003150: 2761 7773 5f69 6d61 6765 5f69 645f 6469  'aws_image_id_di
-00003160: 6374 272c 0a20 2020 2020 2020 205b 0a20  ct',.        [. 
-00003170: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-00003180: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
-00003190: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000031a0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000031b0: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
-000031c0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-000031d0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-000031e0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-000031f0: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
-00003200: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-00003210: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00003220: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00003230: 6e61 6d65 7d20 226c 7320 7e22 272c 0a20  name} "ls ~"',. 
-00003240: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003250: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00003260: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00003270: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00003280: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00003290: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000032a0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000032b0: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-000032c0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-000032d0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-000032e0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-000032f0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00003300: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00003310: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-00003320: 7374 5f67 6370 5f69 6d61 6765 5f69 645f  st_gcp_image_id_
-00003330: 6469 6374 2829 3a0a 2020 2020 6e61 6d65  dict():.    name
-00003340: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00003350: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00003360: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00003370: 2767 6370 5f69 6d61 6765 5f69 645f 6469  'gcp_image_id_di
-00003380: 6374 272c 0a20 2020 2020 2020 205b 0a20  ct',.        [. 
-00003390: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-000033a0: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
-000033b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000033c0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000033d0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-000033e0: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
-000033f0: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-00003400: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00003410: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00003420: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-00003430: 6c73 2f67 6370 5f70 6572 5f72 6567 696f  ls/gcp_per_regio
-00003440: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
-00003450: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003460: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
-00003470: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
-00003480: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00003490: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-000034a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000034b0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000034c0: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-000034d0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000034e0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-000034f0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00003500: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00003510: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00003520: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00003530: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00003540: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00003550: 730a 6465 6620 7465 7374 5f61 7773 5f69  s.def test_aws_i
-00003560: 6d61 6765 5f69 645f 6469 6374 5f72 6567  mage_id_dict_reg
-00003570: 696f 6e28 293a 0a20 2020 206e 616d 6520  ion():.    name 
-00003580: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00003590: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-000035a0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000035b0: 6177 735f 696d 6167 655f 6964 5f64 6963  aws_image_id_dic
-000035c0: 745f 7265 6769 6f6e 272c 0a20 2020 2020  t_region',.     
-000035d0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000035e0: 2023 2055 7365 2072 6567 696f 6e20 746f   # Use region to
-000035f0: 2066 696c 7465 7220 696d 6167 655f 6964   filter image_id
-00003600: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
-00003610: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00003620: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
-00003630: 6567 696f 6e20 7573 2d65 6173 742d 3120  egion us-east-1 
-00003640: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
-00003650: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
-00003660: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00003670: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00003680: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-00003690: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
-000036a0: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
-000036b0: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-000036c0: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
-000036d0: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-000036e0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000036f0: 202d 6320 7b6e 616d 657d 202d 2d72 6567   -c {name} --reg
-00003700: 696f 6e20 7573 2d77 6573 742d 3220 6578  ion us-west-2 ex
-00003710: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
-00003720: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
-00003730: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
-00003740: 6f75 6c64 2073 7563 6365 7373 2062 6563  ould success bec
-00003750: 6175 7365 2074 6865 2069 6d61 6765 2069  ause the image i
-00003760: 6420 6d61 7463 6820 666f 7220 7468 6520  d match for the 
-00003770: 7265 6769 6f6e 2e0a 2020 2020 2020 2020  region..        
-00003780: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00003790: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
-000037a0: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-000037b0: 7075 2d75 6275 6e74 752d 3138 3034 2065  pu-ubuntu-1804 e
-000037c0: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-000037d0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000037e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000037f0: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
-00003800: 736b 7970 696c 6f74 3a67 7075 2d75 6275  skypilot:gpu-ubu
-00003810: 6e74 752d 3138 3034 2065 7861 6d70 6c65  ntu-1804 example
-00003820: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00003830: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003840: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00003850: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00003860: 6f74 3a67 7075 2d75 6275 6e74 752d 3230  ot:gpu-ubuntu-20
-00003870: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
-00003880: 6d61 6c2e 7961 6d6c 2026 2620 6578 6974  mal.yaml && exit
-00003890: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
-000038a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000038b0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-000038c0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000038d0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000038e0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-000038f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003900: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00003910: 2033 202d 2d73 7461 7475 7327 2c0a 2020   3 --status',.  
-00003920: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003930: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-00003940: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00003950: 7020 7573 2d77 6573 742d 3227 2c20 2023  p us-west-2',  #
-00003960: 2045 6e73 7572 6520 7468 6520 7265 6769   Ensure the regi
-00003970: 6f6e 2069 7320 636f 7272 6563 742e 0a20  on is correct.. 
-00003980: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-00003990: 7572 6520 6578 6563 2077 6f72 6b73 2e0a  ure exec works..
-000039a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000039b0: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-000039c0: 7265 6769 6f6e 2075 732d 7765 7374 2d32  region us-west-2
-000039d0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-000039e0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-000039f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003a00: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00003a10: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-00003a20: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00003a30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003a40: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00003a50: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-00003a60: 6567 696f 6e20 7573 2d77 6573 742d 3220  egion us-west-2 
-00003a70: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
-00003a80: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00003a90: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
-00003aa0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003ab0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
-00003ac0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00003ad0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00003ae0: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
-00003af0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00003b00: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00003b10: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
-00003b20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003b30: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
-00003b40: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00003b50: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00003b60: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00003b70: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00003b80: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00003b90: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00003ba0: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-00003bb0: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
-00003bc0: 5f72 6567 696f 6e28 293a 0a20 2020 206e  _region():.    n
-00003bd0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00003be0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00003bf0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00003c00: 2020 2027 6763 705f 696d 6167 655f 6964     'gcp_image_id
-00003c10: 5f64 6963 745f 7265 6769 6f6e 272c 0a20  _dict_region',. 
-00003c20: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00003c30: 2020 2020 2023 2055 7365 2072 6567 696f       # Use regio
-00003c40: 6e20 746f 2066 696c 7465 7220 696d 6167  n to filter imag
-00003c50: 655f 6964 2064 6963 742e 0a20 2020 2020  e_id dict..     
-00003c60: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00003c70: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00003c80: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
-00003c90: 7431 2074 6573 7473 2f74 6573 745f 7961  t1 tests/test_ya
-00003ca0: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
-00003cb0: 6f6e 5f69 6d61 6765 732e 7961 6d6c 2026  on_images.yaml &
-00003cc0: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+000011b0: 2020 2020 2020 2020 7375 6666 6978 3d27          suffix='
+000011c0: 2e6c 6f67 272c 0a20 2020 2020 2020 2020  .log',.         
+000011d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011f0: 2020 6465 6c65 7465 3d46 616c 7365 290a    delete=False).
+00001200: 2020 2020 7465 7374 2e65 6368 6f28 6627      test.echo(f'
+00001210: 5465 7374 2073 7461 7274 6564 2e20 4c6f  Test started. Lo
+00001220: 673a 206c 6573 7320 7b6c 6f67 5f66 696c  g: less {log_fil
+00001230: 652e 6e61 6d65 7d27 290a 2020 2020 666f  e.name}').    fo
+00001240: 7220 636f 6d6d 616e 6420 696e 2074 6573  r command in tes
+00001250: 742e 636f 6d6d 616e 6473 3a0a 2020 2020  t.commands:.    
+00001260: 2020 2020 6c6f 675f 6669 6c65 2e77 7269      log_file.wri
+00001270: 7465 2866 272b 207b 636f 6d6d 616e 647d  te(f'+ {command}
+00001280: 5c6e 2729 0a20 2020 2020 2020 206c 6f67  \n').        log
+00001290: 5f66 696c 652e 666c 7573 6828 290a 2020  _file.flush().  
+000012a0: 2020 2020 2020 7072 6f63 203d 2073 7562        proc = sub
+000012b0: 7072 6f63 6573 732e 506f 7065 6e28 0a20  process.Popen(. 
+000012c0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+000012d0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
+000012e0: 7374 646f 7574 3d6c 6f67 5f66 696c 652c  stdout=log_file,
+000012f0: 0a20 2020 2020 2020 2020 2020 2073 7464  .            std
+00001300: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
+00001310: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
+00001320: 2020 2073 6865 6c6c 3d54 7275 652c 0a20     shell=True,. 
+00001330: 2020 2020 2020 2020 2020 2065 7865 6375             execu
+00001340: 7461 626c 653d 272f 6269 6e2f 6261 7368  table='/bin/bash
+00001350: 272c 0a20 2020 2020 2020 2029 0a20 2020  ',.        ).   
+00001360: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00001370: 2020 2020 2020 7072 6f63 2e77 6169 7428        proc.wait(
+00001380: 7469 6d65 6f75 743d 7465 7374 2e74 696d  timeout=test.tim
+00001390: 656f 7574 290a 2020 2020 2020 2020 6578  eout).        ex
+000013a0: 6365 7074 2073 7562 7072 6f63 6573 732e  cept subprocess.
+000013b0: 5469 6d65 6f75 7445 7870 6972 6564 2061  TimeoutExpired a
+000013c0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+000013d0: 206c 6f67 5f66 696c 652e 666c 7573 6828   log_file.flush(
+000013e0: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+000013f0: 7374 2e65 6368 6f28 6627 5469 6d65 6f75  st.echo(f'Timeou
+00001400: 7420 6166 7465 7220 7b74 6573 742e 7469  t after {test.ti
+00001410: 6d65 6f75 747d 2073 6563 6f6e 6473 2e27  meout} seconds.'
+00001420: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+00001430: 7374 2e65 6368 6f28 7374 7228 6529 290a  st.echo(str(e)).
+00001440: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+00001450: 6669 6c65 2e77 7269 7465 2866 2754 696d  file.write(f'Tim
+00001460: 656f 7574 2061 6674 6572 207b 7465 7374  eout after {test
+00001470: 2e74 696d 656f 7574 7d20 7365 636f 6e64  .timeout} second
+00001480: 732e 5c6e 2729 0a20 2020 2020 2020 2020  s.\n').         
+00001490: 2020 206c 6f67 5f66 696c 652e 666c 7573     log_file.flus
+000014a0: 6828 290a 2020 2020 2020 2020 2020 2020  h().            
+000014b0: 2320 4b69 6c6c 2074 6865 2063 7572 7265  # Kill the curre
+000014c0: 6e74 2070 726f 6365 7373 2e0a 2020 2020  nt process..    
+000014d0: 2020 2020 2020 2020 7072 6f63 2e74 6572          proc.ter
+000014e0: 6d69 6e61 7465 2829 0a20 2020 2020 2020  minate().       
+000014f0: 2020 2020 2070 726f 632e 7265 7475 726e       proc.return
+00001500: 636f 6465 203d 2031 2020 2320 4e6f 6e65  code = 1  # None
+00001510: 2069 6620 7765 2064 6f6e 2774 2073 6574   if we don't set
+00001520: 2069 742e 0a20 2020 2020 2020 2020 2020   it..           
+00001530: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+00001540: 6966 2070 726f 632e 7265 7475 726e 636f  if proc.returnco
+00001550: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
+00001560: 6272 6561 6b0a 0a20 2020 2073 7479 6c65  break..    style
+00001570: 203d 2063 6f6c 6f72 616d 612e 5374 796c   = colorama.Styl
+00001580: 650a 2020 2020 666f 7265 203d 2063 6f6c  e.    fore = col
+00001590: 6f72 616d 612e 466f 7265 0a20 2020 206f  orama.Fore.    o
+000015a0: 7574 636f 6d65 203d 2028 6627 7b66 6f72  utcome = (f'{for
+000015b0: 652e 5245 447d 4661 696c 6564 7b73 7479  e.RED}Failed{sty
+000015c0: 6c65 2e52 4553 4554 5f41 4c4c 7d27 0a20  le.RESET_ALL}'. 
+000015d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000015e0: 2070 726f 632e 7265 7475 726e 636f 6465   proc.returncode
+000015f0: 2065 6c73 6520 6627 7b66 6f72 652e 4752   else f'{fore.GR
+00001600: 4545 4e7d 5061 7373 6564 7b73 7479 6c65  EEN}Passed{style
+00001610: 2e52 4553 4554 5f41 4c4c 7d27 290a 2020  .RESET_ALL}').  
+00001620: 2020 7265 6173 6f6e 203d 2066 275c 6e52    reason = f'\nR
+00001630: 6561 736f 6e3a 207b 636f 6d6d 616e 647d  eason: {command}
+00001640: 2720 6966 2070 726f 632e 7265 7475 726e  ' if proc.return
+00001650: 636f 6465 2065 6c73 6520 2727 0a20 2020  code else ''.   
+00001660: 206d 7367 203d 2028 6627 7b6f 7574 636f   msg = (f'{outco
+00001670: 6d65 7d2e 270a 2020 2020 2020 2020 2020  me}.'.          
+00001680: 2066 277b 7265 6173 6f6e 7d27 0a20 2020   f'{reason}'.   
+00001690: 2020 2020 2020 2020 6627 5c6e 4c6f 673a          f'\nLog:
+000016a0: 206c 6573 7320 7b6c 6f67 5f66 696c 652e   less {log_file.
+000016b0: 6e61 6d65 7d5c 6e27 290a 2020 2020 7465  name}\n').    te
+000016c0: 7374 2e65 6368 6f28 6d73 6729 0a20 2020  st.echo(msg).   
+000016d0: 206c 6f67 5f66 696c 652e 7772 6974 6528   log_file.write(
+000016e0: 6d73 6729 0a20 2020 2069 6620 2870 726f  msg).    if (pro
+000016f0: 632e 7265 7475 726e 636f 6465 203d 3d20  c.returncode == 
+00001700: 3020 6f72 0a20 2020 2020 2020 2020 2020  0 or.           
+00001710: 2070 7974 6573 742e 7465 726d 696e 6174   pytest.terminat
+00001720: 655f 6f6e 5f66 6169 6c75 7265 2920 616e  e_on_failure) an
+00001730: 6420 7465 7374 2e74 6561 7264 6f77 6e20  d test.teardown 
+00001740: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00001750: 2020 2020 2073 7562 7072 6f63 6573 735f       subprocess_
+00001760: 7574 696c 732e 7275 6e28 0a20 2020 2020  utils.run(.     
+00001770: 2020 2020 2020 2074 6573 742e 7465 6172         test.tear
+00001780: 646f 776e 2c0a 2020 2020 2020 2020 2020  down,.          
+00001790: 2020 7374 646f 7574 3d6c 6f67 5f66 696c    stdout=log_fil
+000017a0: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+000017b0: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
+000017c0: 2e53 5444 4f55 542c 0a20 2020 2020 2020  .STDOUT,.       
+000017d0: 2020 2020 2074 696d 656f 7574 3d31 3020       timeout=10 
+000017e0: 2a20 3630 2c20 2023 2031 3020 6d69 6e73  * 60,  # 10 mins
+000017f0: 0a20 2020 2020 2020 2020 2020 2073 6865  .            she
+00001800: 6c6c 3d54 7275 652c 0a20 2020 2020 2020  ll=True,.       
+00001810: 2029 0a0a 2020 2020 6966 2070 726f 632e   )..    if proc.
+00001820: 7265 7475 726e 636f 6465 3a0a 2020 2020  returncode:.    
+00001830: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00001840: 696f 6e28 6627 7465 7374 2066 6169 6c65  ion(f'test faile
+00001850: 643a 206c 6573 7320 7b6c 6f67 5f66 696c  d: less {log_fil
+00001860: 652e 6e61 6d65 7d27 290a 0a0a 6465 6620  e.name}')...def 
+00001870: 6765 745f 6177 735f 7265 6769 6f6e 5f66  get_aws_region_f
+00001880: 6f72 5f71 756f 7461 5f66 6169 6c6f 7665  or_quota_failove
+00001890: 7228 2920 2d3e 204f 7074 696f 6e61 6c5b  r() -> Optional[
+000018a0: 7374 725d 3a0a 0a20 2020 2063 616e 6469  str]:..    candi
+000018b0: 6461 7465 5f72 6567 696f 6e73 203d 2041  date_regions = A
+000018c0: 5753 2e72 6567 696f 6e73 5f77 6974 685f  WS.regions_with_
+000018d0: 6f66 6665 7269 6e67 2869 6e73 7461 6e63  offering(instanc
+000018e0: 655f 7479 7065 3d27 7033 2e31 3678 6c61  e_type='p3.16xla
+000018f0: 7267 6527 2c0a 2020 2020 2020 2020 2020  rge',.          
+00001900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001920: 2020 2020 2020 2020 6163 6365 6c65 7261          accelera
+00001930: 746f 7273 3d4e 6f6e 652c 0a20 2020 2020  tors=None,.     
+00001940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001960: 2020 2020 2020 2020 2020 2020 2075 7365               use
+00001970: 5f73 706f 743d 5472 7565 2c0a 2020 2020  _spot=True,.    
+00001980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000019b0: 6769 6f6e 3d4e 6f6e 652c 0a20 2020 2020  gion=None,.     
+000019c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019e0: 2020 2020 2020 2020 2020 2020 207a 6f6e               zon
+000019f0: 653d 4e6f 6e65 290a 0a20 2020 2066 6f72  e=None)..    for
+00001a00: 2072 6567 696f 6e20 696e 2063 616e 6469   region in candi
+00001a10: 6461 7465 5f72 6567 696f 6e73 3a0a 2020  date_regions:.  
+00001a20: 2020 2020 2020 6966 206e 6f74 2041 5753        if not AWS
+00001a30: 2e63 6865 636b 5f71 756f 7461 5f61 7661  .check_quota_ava
+00001a40: 696c 6162 6c65 280a 2020 2020 2020 2020  ilable(.        
+00001a50: 2020 2020 2020 2020 7265 6769 6f6e 3d72          region=r
+00001a60: 6567 696f 6e2e 6e61 6d65 2c20 696e 7374  egion.name, inst
+00001a70: 616e 6365 5f74 7970 653d 2770 332e 3136  ance_type='p3.16
+00001a80: 786c 6172 6765 272c 2075 7365 5f73 706f  xlarge', use_spo
+00001a90: 743d 5472 7565 293a 0a20 2020 2020 2020  t=True):.       
+00001aa0: 2020 2020 2072 6574 7572 6e20 7265 6769       return regi
+00001ab0: 6f6e 2e6e 616d 650a 0a20 2020 2072 6574  on.name..    ret
+00001ac0: 7572 6e20 4e6f 6e65 0a0a 0a23 202d 2d2d  urn None...# ---
+00001ad0: 2d2d 2d2d 2d2d 2d20 4472 7920 7275 6e3a  ------- Dry run:
+00001ae0: 2032 2054 6173 6b73 2069 6e20 6120 6368   2 Tasks in a ch
+00001af0: 6169 6e2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ain. ----------.
+00001b00: 6465 6620 7465 7374 5f65 7861 6d70 6c65  def test_example
+00001b10: 5f61 7070 2829 3a0a 2020 2020 7465 7374  _app():.    test
+00001b20: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00001b30: 2027 6578 616d 706c 655f 6170 7027 2c0a   'example_app',.
+00001b40: 2020 2020 2020 2020 5b27 7079 7468 6f6e          ['python
+00001b50: 2065 7861 6d70 6c65 732f 6578 616d 706c   examples/exampl
+00001b60: 655f 6170 702e 7079 275d 2c0a 2020 2020  e_app.py'],.    
+00001b70: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00001b80: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00001b90: 2d2d 2d2d 2d2d 2d20 4120 6d69 6e69 6d61  ------- A minima
+00001ba0: 6c20 7461 736b 202d 2d2d 2d2d 2d2d 2d2d  l task ---------
+00001bb0: 2d0a 6465 6620 7465 7374 5f6d 696e 696d  -.def test_minim
+00001bc0: 616c 2867 656e 6572 6963 5f63 6c6f 7564  al(generic_cloud
+00001bd0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00001be0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00001bf0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00001c00: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00001c10: 276d 696e 696d 616c 272c 0a20 2020 2020  'minimal',.     
+00001c20: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00001c30: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00001c40: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+00001c50: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00001c60: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+00001c70: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00001c80: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00001c90: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00001ca0: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+00001cb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00001cc0: 6c6f 6773 207b 6e61 6d65 7d20 2d2d 7374  logs {name} --st
+00001cd0: 6174 7573 207c 2067 7265 7020 224a 6f62  atus | grep "Job
+00001ce0: 2031 3a20 5355 4343 4545 4445 4422 272c   1: SUCCEEDED"',
+00001cf0: 2020 2320 4571 7569 7661 6c65 6e74 2e0a    # Equivalent..
+00001d00: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+00001d10: 6563 6b20 7468 6520 6c6f 6773 2064 6f77  eck the logs dow
+00001d20: 6e6c 6f61 6469 6e67 0a20 2020 2020 2020  nloading.       
+00001d30: 2020 2020 2066 276c 6f67 5f70 6174 683d       f'log_path=
+00001d40: 2428 736b 7920 6c6f 6773 207b 6e61 6d65  $(sky logs {name
+00001d50: 7d20 3120 2d2d 7379 6e63 2d64 6f77 6e20  } 1 --sync-down 
+00001d60: 7c20 6772 6570 2022 4a6f 6220 3120 6c6f  | grep "Job 1 lo
+00001d70: 6773 3a22 207c 2073 6564 202d 4520 2273  gs:" | sed -E "s
+00001d80: 2f5e 2e2a 4a6f 6220 3120 6c6f 6773 3a20  /^.*Job 1 logs: 
+00001d90: 282e 2a29 5c5c 7831 625c 5c5b 306d 2f5c  (.*)\\x1b\\[0m/\
+00001da0: 5c31 2f67 2229 2026 2620 6563 686f 2024  \1/g") && echo $
+00001db0: 6c6f 675f 7061 7468 2026 2620 7465 7374  log_path && test
+00001dc0: 202d 6620 246c 6f67 5f70 6174 682f 7275   -f $log_path/ru
+00001dd0: 6e2e 6c6f 6727 2c0a 2020 2020 2020 2020  n.log',.        
+00001de0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00001df0: 2072 6179 6c65 7420 7072 6f63 6573 7320   raylet process 
+00001e00: 6861 7320 7468 6520 636f 7272 6563 7420  has the correct 
+00001e10: 6669 6c65 2064 6573 6372 6970 746f 7220  file descriptor 
+00001e20: 6c69 6d69 742e 0a20 2020 2020 2020 2020  limit..         
+00001e30: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00001e40: 616d 657d 2022 7072 6c69 6d69 7420 2d6e  ame} "prlimit -n
+00001e50: 202d 2d70 6964 3d5c 2428 7067 7265 7020   --pid=\$(pgrep 
+00001e60: 2d66 205c 2772 6179 6c65 742f 7261 796c  -f \'raylet/rayl
+00001e70: 6574 202d 2d72 6179 6c65 745f 736f 636b  et --raylet_sock
+00001e80: 6574 5f6e 616d 655c 2729 207c 2067 7265  et_name\') | gre
+00001e90: 7020 5c27 225c 2731 3034 3835 3736 2031  p \'"\'1048576 1
+00001ea0: 3034 3835 3736 5c27 225c 2722 272c 0a20  048576\'"\'"',. 
+00001eb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00001ec0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00001ed0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00001ee0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00001ef0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+00001f00: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00001f10: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00001f20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00001f30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00001f40: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00001f50: 7420 7265 6769 6f6e 202d 2d2d 2d2d 2d2d  t region -------
+00001f60: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00001f70: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
+00001f80: 735f 7265 6769 6f6e 2829 3a0a 2020 2020  s_region():.    
+00001f90: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00001fa0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00001fb0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00001fc0: 2020 2020 2761 7773 5f72 6567 696f 6e27      'aws_region'
+00001fd0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00001fe0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00001ff0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00002000: 7d20 2d2d 7265 6769 6f6e 2075 732d 7765  } --region us-we
+00002010: 7374 2d32 2065 7861 6d70 6c65 732f 6d69  st-2 examples/mi
+00002020: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00002030: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00002040: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
+00002050: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+00002060: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00002070: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00002080: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00002090: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+000020a0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+000020b0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+000020c0: 7475 7320 2d2d 616c 6c20 7c20 6772 6570  tus --all | grep
+000020d0: 207b 6e61 6d65 7d20 7c20 6772 6570 2075   {name} | grep u
+000020e0: 732d 7765 7374 2d32 272c 2020 2320 456e  s-west-2',  # En
+000020f0: 7375 7265 2074 6865 2072 6567 696f 6e20  sure the region 
+00002100: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
+00002110: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00002120: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00002130: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00002140: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00002150: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00002160: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+00002170: 6370 5f72 6567 696f 6e28 293a 0a20 2020  cp_region():.   
+00002180: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00002190: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+000021a0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000021b0: 2020 2020 2027 6763 705f 7265 6769 6f6e       'gcp_region
+000021c0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000021d0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000021e0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000021f0: 657d 202d 2d72 6567 696f 6e20 7573 2d63  e} --region us-c
+00002200: 656e 7472 616c 3120 2d2d 636c 6f75 6420  entral1 --cloud 
+00002210: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
+00002220: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00002230: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00002240: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00002250: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+00002260: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+00002270: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00002280: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00002290: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+000022a0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+000022b0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+000022c0: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+000022d0: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
+000022e0: 7b6e 616d 657d 207c 2067 7265 7020 7573  {name} | grep us
+000022f0: 2d63 656e 7472 616c 3127 2c20 2023 2045  -central1',  # E
+00002300: 6e73 7572 6520 7468 6520 7265 6769 6f6e  nsure the region
+00002310: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
+00002320: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00002330: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00002340: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00002350: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00002360: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00002370: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
+00002380: 6962 6d5f 7265 6769 6f6e 2829 3a0a 2020  ibm_region():.  
+00002390: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000023a0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000023b0: 2072 6567 696f 6e20 3d20 2765 752d 6465   region = 'eu-de
+000023c0: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
+000023d0: 7428 0a20 2020 2020 2020 2027 7265 6769  t(.        'regi
+000023e0: 6f6e 272c 0a20 2020 2020 2020 205b 0a20  on',.        [. 
+000023f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00002400: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00002410: 616d 657d 202d 2d63 6c6f 7564 2069 626d  ame} --cloud ibm
+00002420: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00002430: 6e7d 2065 7861 6d70 6c65 732f 6d69 6e69  n} examples/mini
+00002440: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00002450: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00002460: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00002470: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
+00002480: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00002490: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000024a0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+000024b0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+000024c0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+000024d0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+000024e0: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
+000024f0: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
+00002500: 7d20 7c20 6772 6570 207b 7265 6769 6f6e  } | grep {region
+00002510: 7d27 2c20 2023 2045 6e73 7572 6520 7468  }',  # Ensure th
+00002520: 6520 7265 6769 6f6e 2069 7320 636f 7272  e region is corr
+00002530: 6563 742e 0a20 2020 2020 2020 205d 2c0a  ect..        ],.
+00002540: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00002550: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00002560: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00002570: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00002580: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
+00002590: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
+000025a0: 7265 6769 6f6e 2829 3a0a 2020 2020 6e61  region():.    na
+000025b0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000025c0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000025d0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000025e0: 2020 2761 7a75 7265 5f72 6567 696f 6e27    'azure_region'
+000025f0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00002600: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00002610: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00002620: 7d20 2d2d 7265 6769 6f6e 2065 6173 7475  } --region eastu
+00002630: 7332 202d 2d63 6c6f 7564 2061 7a75 7265  s2 --cloud azure
+00002640: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00002650: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00002660: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00002670: 6b79 2065 7865 6320 7b6e 616d 657d 2074  ky exec {name} t
+00002680: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00002690: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+000026a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000026b0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000026c0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000026d0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000026e0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+000026f0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00002700: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
+00002710: 6d65 7d20 7c20 6772 6570 2065 6173 7475  me} | grep eastu
+00002720: 7332 272c 2020 2320 456e 7375 7265 2074  s2',  # Ensure t
+00002730: 6865 2072 6567 696f 6e20 6973 2063 6f72  he region is cor
+00002740: 7265 6374 2e0a 2020 2020 2020 2020 5d2c  rect..        ],
+00002750: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00002760: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00002770: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00002780: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00002790: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+000027a0: 207a 6f6e 6520 2d2d 2d2d 2d2d 2d2d 2d2d   zone ----------
+000027b0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+000027c0: 730a 6465 6620 7465 7374 5f61 7773 5f7a  s.def test_aws_z
+000027d0: 6f6e 6528 293a 0a20 2020 206e 616d 6520  one():.    name 
+000027e0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000027f0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00002800: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00002810: 6177 735f 7a6f 6e65 272c 0a20 2020 2020  aws_zone',.     
+00002820: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00002830: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00002840: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
+00002850: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+00002860: 202d 2d7a 6f6e 6520 7573 2d77 6573 742d   --zone us-west-
+00002870: 3262 272c 0a20 2020 2020 2020 2020 2020  2b',.           
+00002880: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00002890: 657d 2065 7861 6d70 6c65 732f 6d69 6e69  e} examples/mini
+000028a0: 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e 6520  mal.yaml --zone 
+000028b0: 7573 2d77 6573 742d 3262 272c 0a20 2020  us-west-2b',.   
+000028c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000028d0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+000028e0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+000028f0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00002900: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00002910: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
+00002920: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
+00002930: 7d20 7c20 6772 6570 2075 732d 7765 7374  } | grep us-west
+00002940: 2d32 6227 2c20 2023 2045 6e73 7572 6520  -2b',  # Ensure 
+00002950: 7468 6520 7a6f 6e65 2069 7320 636f 7272  the zone is corr
+00002960: 6563 742e 0a20 2020 2020 2020 205d 2c0a  ect..        ],.
+00002970: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00002980: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00002990: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+000029a0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+000029b0: 7974 6573 742e 6d61 726b 2e69 626d 0a64  ytest.mark.ibm.d
+000029c0: 6566 2074 6573 745f 6962 6d5f 7a6f 6e65  ef test_ibm_zone
+000029d0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+000029e0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000029f0: 2829 0a20 2020 207a 6f6e 6520 3d20 2765  ().    zone = 'e
+00002a00: 752d 6465 2d32 270a 2020 2020 7465 7374  u-de-2'.    test
+00002a10: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00002a20: 2027 7a6f 6e65 272c 0a20 2020 2020 2020   'zone',.       
+00002a30: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00002a40: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00002a50: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00002a60: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
+00002a70: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
+00002a80: 6520 7b7a 6f6e 657d 272c 0a20 2020 2020  e {zone}',.     
+00002a90: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00002aa0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00002ab0: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
+00002ac0: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
+00002ad0: 6520 7b7a 6f6e 657d 272c 0a20 2020 2020  e {zone}',.     
+00002ae0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00002af0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00002b00: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00002b10: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00002b20: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00002b30: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
+00002b40: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
+00002b50: 7c20 6772 6570 207b 7a6f 6e65 7d27 2c20  | grep {zone}', 
+00002b60: 2023 2045 6e73 7572 6520 7468 6520 7a6f   # Ensure the zo
+00002b70: 6e65 2069 7320 636f 7272 6563 742e 0a20  ne is correct.. 
+00002b80: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00002b90: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00002ba0: 7b6e 616d 657d 207b 6e61 6d65 7d2d 3220  {name} {name}-2 
+00002bb0: 7b6e 616d 657d 2d33 272c 0a20 2020 2029  {name}-3',.    )
+00002bc0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00002bd0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00002be0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
+00002bf0: 6573 745f 6763 705f 7a6f 6e65 2829 3a0a  est_gcp_zone():.
+00002c00: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00002c10: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00002c20: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00002c30: 2020 2020 2020 2020 2767 6370 5f7a 6f6e          'gcp_zon
+00002c40: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
+00002c50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00002c60: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00002c70: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 6365  me} --zone us-ce
+00002c80: 6e74 7261 6c31 2d61 202d 2d63 6c6f 7564  ntral1-a --cloud
+00002c90: 2067 6370 2074 6573 7473 2f74 6573 745f   gcp tests/test_
+00002ca0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00002cb0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00002cc0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00002cd0: 657d 202d 2d7a 6f6e 6520 7573 2d63 656e  e} --zone us-cen
+00002ce0: 7472 616c 312d 6120 2d2d 636c 6f75 6420  tral1-a --cloud 
+00002cf0: 6763 7020 7465 7374 732f 7465 7374 5f79  gcp tests/test_y
+00002d00: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00002d10: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00002d20: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00002d30: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00002d40: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00002d50: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00002d60: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00002d70: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
+00002d80: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00002d90: 7573 2d63 656e 7472 616c 312d 6127 2c20  us-central1-a', 
+00002da0: 2023 2045 6e73 7572 6520 7468 6520 7a6f   # Ensure the zo
+00002db0: 6e65 2069 7320 636f 7272 6563 742e 0a20  ne is correct.. 
+00002dc0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00002dd0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00002de0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00002df0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00002e00: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00002e10: 2d2d 2d2d 2054 6573 7420 7468 6520 696d  ---- Test the im
+00002e20: 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  age ----------.@
+00002e30: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+00002e40: 6465 6620 7465 7374 5f61 7773 5f69 6d61  def test_aws_ima
+00002e50: 6765 7328 293a 0a20 2020 206e 616d 6520  ges():.    name 
+00002e60: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00002e70: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00002e80: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00002e90: 6177 735f 696d 6167 6573 272c 0a20 2020  aws_images',.   
+00002ea0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00002eb0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00002ec0: 2d79 202d 6320 7b6e 616d 657d 202d 2d69  -y -c {name} --i
+00002ed0: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00002ee0: 3a67 7075 2d75 6275 6e74 752d 3138 3034  :gpu-ubuntu-1804
+00002ef0: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
+00002f00: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00002f10: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00002f20: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00002f30: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00002f40: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00002f50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00002f60: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+00002f70: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
+00002f80: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+00002f90: 7475 2d32 3030 3420 6578 616d 706c 6573  tu-2004 examples
+00002fa0: 2f6d 696e 696d 616c 2e79 616d 6c20 2626  /minimal.yaml &&
+00002fb0: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
+00002fc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00002fd0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00002fe0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00002ff0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00003000: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003010: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00003020: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00003030: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00003040: 7320 7b6e 616d 657d 202d 2d73 7461 7475  s {name} --statu
+00003050: 7320 7c20 6772 6570 2022 4a6f 6220 323a  s | grep "Job 2:
+00003060: 2053 5543 4345 4544 4544 2227 2c20 2023   SUCCEEDED"',  #
+00003070: 2045 7175 6976 616c 656e 742e 0a20 2020   Equivalent..   
+00003080: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00003090: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000030a0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+000030b0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+000030c0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+000030d0: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+000030e0: 6763 705f 696d 6167 6573 2829 3a0a 2020  gcp_images():.  
+000030f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00003100: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00003110: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00003120: 2020 2020 2020 2767 6370 5f69 6d61 6765        'gcp_image
+00003130: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+00003140: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003150: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00003160: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
+00003170: 6b79 7069 6c6f 743a 6770 752d 6465 6269  kypilot:gpu-debi
+00003180: 616e 2d31 3020 2d2d 636c 6f75 6420 6763  an-10 --cloud gc
+00003190: 7020 7465 7374 732f 7465 7374 5f79 616d  p tests/test_yam
+000031a0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+000031b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000031c0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000031d0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+000031e0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+000031f0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00003200: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00003210: 6368 202d 6320 7b6e 616d 657d 202d 2d69  ch -c {name} --i
+00003220: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00003230: 3a63 7075 2d64 6562 6961 6e2d 3130 202d  :cpu-debian-10 -
+00003240: 2d63 6c6f 7564 2067 6370 2074 6573 7473  -cloud gcp tests
+00003250: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+00003260: 6d61 6c2e 7961 6d6c 2026 2620 6578 6974  mal.yaml && exit
+00003270: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
+00003280: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003290: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000032a0: 657d 2074 6573 7473 2f74 6573 745f 7961  e} tests/test_ya
+000032b0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+000032c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000032d0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000032e0: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
+000032f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003300: 6c6f 6773 207b 6e61 6d65 7d20 2d2d 7374  logs {name} --st
+00003310: 6174 7573 207c 2067 7265 7020 224a 6f62  atus | grep "Job
+00003320: 2032 3a20 5355 4343 4545 4445 4422 272c   2: SUCCEEDED"',
+00003330: 2020 2320 4571 7569 7661 6c65 6e74 2e0a    # Equivalent..
+00003340: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00003350: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00003360: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00003370: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00003380: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00003390: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+000033a0: 7374 5f61 7773 5f69 6d61 6765 5f69 645f  st_aws_image_id_
+000033b0: 6469 6374 2829 3a0a 2020 2020 6e61 6d65  dict():.    name
+000033c0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000033d0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000033e0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000033f0: 2761 7773 5f69 6d61 6765 5f69 645f 6469  'aws_image_id_di
+00003400: 6374 272c 0a20 2020 2020 2020 205b 0a20  ct',.        [. 
+00003410: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
+00003420: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
+00003430: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003440: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00003450: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
+00003460: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
+00003470: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00003480: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00003490: 6e61 6d65 7d20 6578 616d 706c 6573 2f70  name} examples/p
+000034a0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
+000034b0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000034c0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000034d0: 6e61 6d65 7d20 226c 7320 7e22 272c 0a20  name} "ls ~"',. 
+000034e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000034f0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00003500: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00003510: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00003520: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00003530: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00003540: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00003550: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+00003560: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00003570: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00003580: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+00003590: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+000035a0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+000035b0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
+000035c0: 7374 5f67 6370 5f69 6d61 6765 5f69 645f  st_gcp_image_id_
+000035d0: 6469 6374 2829 3a0a 2020 2020 6e61 6d65  dict():.    name
+000035e0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+000035f0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00003600: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00003610: 2767 6370 5f69 6d61 6765 5f69 645f 6469  'gcp_image_id_di
+00003620: 6374 272c 0a20 2020 2020 2020 205b 0a20  ct',.        [. 
+00003630: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
+00003640: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
+00003650: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003660: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00003670: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00003680: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
+00003690: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+000036a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000036b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+000036c0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+000036d0: 6c73 2f67 6370 5f70 6572 5f72 6567 696f  ls/gcp_per_regio
+000036e0: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
+000036f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003700: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
+00003710: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
+00003720: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00003730: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00003740: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00003750: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00003760: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00003770: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003780: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00003790: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+000037a0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000037b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000037c0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+000037d0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000037e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+000037f0: 730a 6465 6620 7465 7374 5f61 7773 5f69  s.def test_aws_i
+00003800: 6d61 6765 5f69 645f 6469 6374 5f72 6567  mage_id_dict_reg
+00003810: 696f 6e28 293a 0a20 2020 206e 616d 6520  ion():.    name 
+00003820: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00003830: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00003840: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00003850: 6177 735f 696d 6167 655f 6964 5f64 6963  aws_image_id_dic
+00003860: 745f 7265 6769 6f6e 272c 0a20 2020 2020  t_region',.     
+00003870: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00003880: 2023 2055 7365 2072 6567 696f 6e20 746f   # Use region to
+00003890: 2066 696c 7465 7220 696d 6167 655f 6964   filter image_id
+000038a0: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
+000038b0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+000038c0: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
+000038d0: 6567 696f 6e20 7573 2d65 6173 742d 3120  egion us-east-1 
+000038e0: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+000038f0: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
+00003900: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00003910: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00003920: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+00003930: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
+00003940: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
+00003950: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00003960: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
+00003970: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+00003980: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00003990: 202d 6320 7b6e 616d 657d 202d 2d72 6567   -c {name} --reg
+000039a0: 696f 6e20 7573 2d77 6573 742d 3220 6578  ion us-west-2 ex
+000039b0: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
+000039c0: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
+000039d0: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
+000039e0: 6f75 6c64 2073 7563 6365 7373 2062 6563  ould success bec
+000039f0: 6175 7365 2074 6865 2069 6d61 6765 2069  ause the image i
+00003a00: 6420 6d61 7463 6820 666f 7220 7468 6520  d match for the 
+00003a10: 7265 6769 6f6e 2e0a 2020 2020 2020 2020  region..        
+00003a20: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00003a30: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
+00003a40: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
+00003a50: 7075 2d75 6275 6e74 752d 3138 3034 2065  pu-ubuntu-1804 e
+00003a60: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
+00003a70: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00003a80: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00003a90: 616d 657d 202d 2d69 6d61 6765 2d69 6420  ame} --image-id 
+00003aa0: 736b 7970 696c 6f74 3a67 7075 2d75 6275  skypilot:gpu-ubu
+00003ab0: 6e74 752d 3138 3034 2065 7861 6d70 6c65  ntu-1804 example
+00003ac0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
+00003ad0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003ae0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00003af0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+00003b00: 6f74 3a67 7075 2d75 6275 6e74 752d 3230  ot:gpu-ubuntu-20
+00003b10: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
+00003b20: 6d61 6c2e 7961 6d6c 2026 2620 6578 6974  mal.yaml && exit
+00003b30: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
+00003b40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00003b50: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00003b60: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00003b70: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00003b80: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00003b90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00003ba0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00003bb0: 2033 202d 2d73 7461 7475 7327 2c0a 2020   3 --status',.  
+00003bc0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003bd0: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
+00003be0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00003bf0: 7020 7573 2d77 6573 742d 3227 2c20 2023  p us-west-2',  #
+00003c00: 2045 6e73 7572 6520 7468 6520 7265 6769   Ensure the regi
+00003c10: 6f6e 2069 7320 636f 7272 6563 742e 0a20  on is correct.. 
+00003c20: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+00003c30: 7572 6520 6578 6563 2077 6f72 6b73 2e0a  ure exec works..
+00003c40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003c50: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00003c60: 7265 6769 6f6e 2075 732d 7765 7374 2d32  region us-west-2
+00003c70: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00003c80: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+00003c90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00003ca0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00003cb0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
+00003cc0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
 00003cd0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00003ce0: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
-00003cf0: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
-00003d00: 7420 3120 7c7c 2074 7275 6527 2c20 2023  t 1 || true',  #
-00003d10: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
-00003d20: 7465 7220 6973 206e 6f74 2063 7265 6174  ter is not creat
-00003d30: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00003d40: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00003d50: 2d63 207b 6e61 6d65 7d20 2d2d 7265 6769  -c {name} --regi
-00003d60: 6f6e 2075 732d 7765 7374 3320 7465 7374  on us-west3 test
-00003d70: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
-00003d80: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
-00003d90: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
-00003da0: 2020 2020 2020 2320 5368 6f75 6c64 2073        # Should s
-00003db0: 7563 6365 7373 2062 6563 6175 7365 2074  uccess because t
-00003dc0: 6865 2069 6d61 6765 2069 6420 6d61 7463  he image id matc
-00003dd0: 6820 666f 7220 7468 6520 7265 6769 6f6e  h for the region
-00003de0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00003df0: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
-00003e00: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-00003e10: 202d 2d69 6d61 6765 2d69 6420 7072 6f6a   --image-id proj
-00003e20: 6563 7473 2f75 6275 6e74 752d 6f73 2d63  ects/ubuntu-os-c
-00003e30: 6c6f 7564 2f67 6c6f 6261 6c2f 696d 6167  loud/global/imag
-00003e40: 6573 2f75 6275 6e74 752d 3138 3034 2d62  es/ubuntu-1804-b
-00003e50: 696f 6e69 632d 7632 3032 3330 3131 3220  ionic-v20230112 
-00003e60: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00003e70: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00003e80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003e90: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00003ea0: 636c 6f75 6420 6763 7020 2d2d 696d 6167  cloud gcp --imag
-00003eb0: 652d 6964 2070 726f 6a65 6374 732f 7562  e-id projects/ub
-00003ec0: 756e 7475 2d6f 732d 636c 6f75 642f 676c  untu-os-cloud/gl
-00003ed0: 6f62 616c 2f69 6d61 6765 732f 7562 756e  obal/images/ubun
-00003ee0: 7475 2d31 3830 342d 6269 6f6e 6963 2d76  tu-1804-bionic-v
-00003ef0: 3230 3233 3031 3132 2074 6573 7473 2f74  20230112 tests/t
-00003f00: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
-00003f10: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00003f20: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00003f30: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00003f40: 6370 202d 2d69 6d61 6765 2d69 6420 736b  cp --image-id sk
-00003f50: 7970 696c 6f74 3a63 7075 2d64 6562 6961  ypilot:cpu-debia
-00003f60: 6e2d 3130 2074 6573 7473 2f74 6573 745f  n-10 tests/test_
-00003f70: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00003f80: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
-00003f90: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
-00003fa0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00003fb0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00003fc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003fd0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00003fe0: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
-00003ff0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00004000: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-00004010: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00004020: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-00004030: 202d 2d61 6c6c 207c 2067 7265 7020 7b6e   --all | grep {n
-00004040: 616d 657d 207c 2067 7265 7020 7573 2d77  ame} | grep us-w
-00004050: 6573 7433 272c 2020 2320 456e 7375 7265  est3',  # Ensure
-00004060: 2074 6865 2072 6567 696f 6e20 6973 2063   the region is c
-00004070: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
-00004080: 2020 2020 2320 456e 7375 7265 2065 7865      # Ensure exe
-00004090: 6320 776f 726b 732e 0a20 2020 2020 2020  c works..       
-000040a0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-000040b0: 7b6e 616d 657d 202d 2d72 6567 696f 6e20  {name} --region 
-000040c0: 7573 2d77 6573 7433 2074 6573 7473 2f74  us-west3 tests/t
-000040d0: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
-000040e0: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-000040f0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00004100: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00004110: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00004120: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
-00004130: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00004140: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004150: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00004160: 202d 2d63 6c6f 7564 2067 6370 202d 2d72   --cloud gcp --r
-00004170: 6567 696f 6e20 7573 2d77 6573 7433 2022  egion us-west3 "
-00004180: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
-00004190: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-000041a0: 6e61 6d65 7d20 226c 7320 7e22 272c 0a20  name} "ls ~"',. 
-000041b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000041c0: 206c 6f67 7320 7b6e 616d 657d 2034 202d   logs {name} 4 -
-000041d0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000041e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000041f0: 207b 6e61 6d65 7d20 3520 2d2d 7374 6174   {name} 5 --stat
-00004200: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00004210: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004220: 657d 2036 202d 2d73 7461 7475 7327 2c0a  e} 6 --status',.
-00004230: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004240: 7920 6c6f 6773 207b 6e61 6d65 7d20 3720  y logs {name} 7 
-00004250: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00004260: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-00004270: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-00004280: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-00004290: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-000042a0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-000042b0: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
-000042c0: 735f 696d 6167 655f 6964 5f64 6963 745f  s_image_id_dict_
-000042d0: 7a6f 6e65 2829 3a0a 2020 2020 6e61 6d65  zone():.    name
-000042e0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-000042f0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00004300: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00004310: 2761 7773 5f69 6d61 6765 5f69 645f 6469  'aws_image_id_di
-00004320: 6374 5f7a 6f6e 6527 2c0a 2020 2020 2020  ct_zone',.      
-00004330: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00004340: 2320 5573 6520 7a6f 6e65 2074 6f20 6669  # Use zone to fi
-00004350: 6c74 6572 2069 6d61 6765 5f69 6420 6469  lter image_id di
-00004360: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
-00004370: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00004380: 2d63 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  -c {name} --zone
-00004390: 2075 732d 6561 7374 2d31 6220 6578 616d   us-east-1b exam
-000043a0: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
-000043b0: 696d 6167 6573 2e79 616d 6c20 2626 2065  images.yaml && e
-000043c0: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
-000043d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000043e0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-000043f0: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
-00004400: 207c 7c20 7472 7565 272c 2020 2320 456e   || true',  # En
-00004410: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
-00004420: 2069 7320 6e6f 7420 6372 6561 7465 642e   is not created.
-00004430: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004440: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00004450: 7b6e 616d 657d 202d 2d7a 6f6e 6520 7573  {name} --zone us
-00004460: 2d77 6573 742d 3261 2065 7861 6d70 6c65  -west-2a example
-00004470: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-00004480: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00004490: 2020 2020 2020 2023 2053 686f 756c 6420         # Should 
-000044a0: 7375 6363 6573 7320 6265 6361 7573 6520  success because 
-000044b0: 7468 6520 696d 6167 6520 6964 206d 6174  the image id mat
-000044c0: 6368 2066 6f72 2074 6865 207a 6f6e 652e  ch for the zone.
-000044d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000044e0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-000044f0: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
-00004500: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
-00004510: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
-00004520: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00004530: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004540: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00004550: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
-00004560: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00004570: 3138 3034 2065 7861 6d70 6c65 732f 6d69  1804 examples/mi
-00004580: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00004590: 2020 2020 2020 2020 2023 2046 6169 6c20           # Fail 
-000045a0: 6475 6520 746f 2069 6d61 6765 2069 6420  due to image id 
-000045b0: 6d69 736d 6174 6368 2e0a 2020 2020 2020  mismatch..      
-000045c0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000045d0: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
-000045e0: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
-000045f0: 7562 756e 7475 2d32 3030 3420 6578 616d  ubuntu-2004 exam
-00004600: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-00004610: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
-00004620: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
-00004630: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00004640: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00004650: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004660: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00004670: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00004680: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00004690: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
-000046a0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-000046b0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-000046c0: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
-000046d0: 6d65 7d20 7c20 6772 6570 2075 732d 7765  me} | grep us-we
-000046e0: 7374 2d32 6127 2c20 2023 2045 6e73 7572  st-2a',  # Ensur
-000046f0: 6520 7468 6520 7a6f 6e65 2069 7320 636f  e the zone is co
-00004700: 7272 6563 742e 0a20 2020 2020 2020 2020  rrect..         
-00004710: 2020 2023 2045 6e73 7572 6520 6578 6563     # Ensure exec
-00004720: 2077 6f72 6b73 2e0a 2020 2020 2020 2020   works..        
-00004730: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004740: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
-00004750: 7765 7374 2d32 6120 6578 616d 706c 6573  west-2a examples
-00004760: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
-00004770: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
-00004780: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00004790: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-000047a0: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
-000047b0: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
-000047c0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000047d0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000047e0: 6177 7320 2d2d 7265 6769 6f6e 2075 732d  aws --region us-
-000047f0: 7765 7374 2d32 2022 6c73 207e 2227 2c0a  west-2 "ls ~"',.
-00004800: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004810: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
-00004820: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
-00004830: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00004840: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
-00004850: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00004860: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00004870: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
-00004880: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00004890: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
-000048a0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000048b0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000048c0: 6e61 6d65 7d20 3720 2d2d 7374 6174 7573  name} 7 --status
-000048d0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-000048e0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-000048f0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00004900: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00004910: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00004920: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
-00004930: 2074 6573 745f 6763 705f 696d 6167 655f   test_gcp_image_
-00004940: 6964 5f64 6963 745f 7a6f 6e65 2829 3a0a  id_dict_zone():.
-00004950: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00004960: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00004970: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00004980: 2020 2020 2020 2020 2767 6370 5f69 6d61          'gcp_ima
-00004990: 6765 5f69 645f 6469 6374 5f7a 6f6e 6527  ge_id_dict_zone'
-000049a0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000049b0: 2020 2020 2020 2020 2320 5573 6520 7a6f          # Use zo
-000049c0: 6e65 2074 6f20 6669 6c74 6572 2069 6d61  ne to filter ima
-000049d0: 6765 5f69 6420 6469 6374 2e0a 2020 2020  ge_id dict..    
-000049e0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-000049f0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00004a00: 7d20 2d2d 7a6f 6e65 2075 732d 6561 7374  } --zone us-east
-00004a10: 312d 6120 7465 7374 732f 7465 7374 5f79  1-a tests/test_y
-00004a20: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-00004a30: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
-00004a40: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00004a50: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00004a60: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-00004a70: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
-00004a80: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
-00004a90: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-00004aa0: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
-00004ab0: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-00004ac0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00004ad0: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
-00004ae0: 6520 7573 2d63 656e 7472 616c 312d 6120  e us-central1-a 
-00004af0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00004b00: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
-00004b10: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
-00004b20: 2020 2020 2020 2020 2020 2320 5368 6f75            # Shou
-00004b30: 6c64 2073 7563 6365 7373 2062 6563 6175  ld success becau
-00004b40: 7365 2074 6865 2069 6d61 6765 2069 6420  se the image id 
-00004b50: 6d61 7463 6820 666f 7220 7468 6520 7a6f  match for the zo
-00004b60: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
-00004b70: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00004b80: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00004b90: 6420 6763 7020 2d2d 696d 6167 652d 6964  d gcp --image-id
-00004ba0: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
-00004bb0: 6269 616e 2d31 3020 7465 7374 732f 7465  bian-10 tests/te
-00004bc0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00004bd0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00004be0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004bf0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-00004c00: 7020 2d2d 696d 6167 652d 6964 2073 6b79  p --image-id sky
-00004c10: 7069 6c6f 743a 6370 752d 6465 6269 616e  pilot:cpu-debian
-00004c20: 2d31 3020 7465 7374 732f 7465 7374 5f79  -10 tests/test_y
-00004c30: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-00004c40: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00004c50: 2320 4661 696c 2064 7565 2074 6f20 696d  # Fail due to im
-00004c60: 6167 6520 6964 206d 6973 6d61 7463 682e  age id mismatch.
-00004c70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004c80: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00004c90: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
-00004ca0: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-00004cb0: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
-00004cc0: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00004cd0: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00004ce0: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00004cf0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004d00: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00004d10: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00004d20: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00004d30: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00004d40: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00004d50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004d60: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00004d70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004d80: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
-00004d90: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00004da0: 7265 7020 7573 2d63 656e 7472 616c 3127  rep us-central1'
-00004db0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00004dc0: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
-00004dd0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00004de0: 6e73 7572 6520 6578 6563 2077 6f72 6b73  nsure exec works
-00004df0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00004e00: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00004e10: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
-00004e20: 6e65 2075 732d 6365 6e74 7261 6c31 2d61  ne us-central1-a
-00004e30: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00004e40: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
-00004e50: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00004e60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004e70: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
-00004e80: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-00004e90: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-00004ea0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00004eb0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00004ec0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00004ed0: 2067 6370 202d 2d72 6567 696f 6e20 7573   gcp --region us
-00004ee0: 2d63 656e 7472 616c 3120 226c 7320 7e22  -central1 "ls ~"
-00004ef0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004f00: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00004f10: 2022 6c73 207e 2227 2c0a 2020 2020 2020   "ls ~"',.      
-00004f20: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00004f30: 207b 6e61 6d65 7d20 3420 2d2d 7374 6174   {name} 4 --stat
-00004f40: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00004f50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004f60: 657d 2035 202d 2d73 7461 7475 7327 2c0a  e} 5 --status',.
-00004f70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004f80: 7920 6c6f 6773 207b 6e61 6d65 7d20 3620  y logs {name} 6 
-00004f90: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00004fa0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00004fb0: 7320 7b6e 616d 657d 2037 202d 2d73 7461  s {name} 7 --sta
-00004fc0: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-00004fd0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00004fe0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00004ff0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00005000: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00005010: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00005020: 6465 6620 7465 7374 5f69 6d61 6765 5f6e  def test_image_n
-00005030: 6f5f 636f 6e64 6128 293a 0a20 2020 206e  o_conda():.    n
-00005040: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00005050: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00005060: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00005070: 2020 2027 696d 6167 655f 6e6f 5f63 6f6e     'image_no_con
-00005080: 6461 272c 0a20 2020 2020 2020 205b 0a20  da',.        [. 
-00005090: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-000050a0: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
-000050b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000050c0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000050d0: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
-000050e0: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
-000050f0: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-00005100: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00005110: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00005120: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00005130: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00005140: 2020 6627 736b 7920 7374 6f70 207b 6e61    f'sky stop {na
-00005150: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
-00005160: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
-00005170: 207b 6e61 6d65 7d20 2d79 272c 0a20 2020   {name} -y',.   
-00005180: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00005190: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-000051a0: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
-000051b0: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-000051c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000051d0: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-000051e0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-000051f0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00005200: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00005210: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00005220: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00005230: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20  .# ------------ 
-00005240: 5465 7374 2073 7461 6c65 206a 6f62 202d  Test stale job -
-00005250: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974  -----------.@pyt
-00005260: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-00005270: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-00005280: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-00005290: 7420 7375 7070 6f72 7420 7374 6f70 7069  t support stoppi
-000052a0: 6e67 2069 6e73 7461 6e63 6573 0a64 6566  ng instances.def
-000052b0: 2074 6573 745f 7374 616c 655f 6a6f 6228   test_stale_job(
-000052c0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-000052d0: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-000052e0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-000052f0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00005300: 6573 7428 0a20 2020 2020 2020 2027 7374  est(.        'st
-00005310: 616c 655f 6a6f 6227 2c0a 2020 2020 2020  ale_job',.      
-00005320: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00005330: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00005340: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00005350: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-00005360: 7d20 2265 6368 6f20 6869 2227 2c0a 2020  } "echo hi"',.  
-00005370: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005380: 6578 6563 207b 6e61 6d65 7d20 2d64 2022  exec {name} -d "
-00005390: 6563 686f 2073 7461 7274 3b20 736c 6565  echo start; slee
-000053a0: 7020 3130 3030 3022 272c 0a20 2020 2020  p 10000"',.     
-000053b0: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
-000053c0: 7020 7b6e 616d 657d 202d 7927 2c0a 2020  p {name} -y',.  
-000053d0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000053e0: 2031 3030 272c 2020 2320 456e 7375 7265   100',  # Ensure
-000053f0: 2074 6869 7320 6973 206c 6172 6765 2065   this is large e
-00005400: 6e6f 7567 682c 2065 6c73 6520 4743 5020  nough, else GCP 
-00005410: 6c65 616b 732e 0a20 2020 2020 2020 2020  leaks..         
-00005420: 2020 2066 2773 6b79 2073 7461 7274 207b     f'sky start {
-00005430: 6e61 6d65 7d20 2d79 272c 0a20 2020 2020  name} -y',.     
-00005440: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00005450: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00005460: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00005470: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-00005480: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-00005490: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-000054a0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-000054b0: 6570 2046 4149 4c45 4427 2c0a 2020 2020  ep FAILED',.    
-000054c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000054d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-000054e0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000054f0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00005500: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00005510: 6b2e 6177 730a 6465 6620 7465 7374 5f61  k.aws.def test_a
-00005520: 7773 5f73 7461 6c65 5f6a 6f62 5f6d 616e  ws_stale_job_man
-00005530: 7561 6c5f 7265 7374 6172 7428 293a 0a20  ual_restart():. 
-00005540: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00005550: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00005560: 2020 7265 6769 6f6e 203d 2027 7573 2d77    region = 'us-w
-00005570: 6573 742d 3227 0a20 2020 2074 6573 7420  est-2'.    test 
-00005580: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00005590: 2761 7773 5f73 7461 6c65 5f6a 6f62 5f6d  'aws_stale_job_m
-000055a0: 616e 7561 6c5f 7265 7374 6172 7427 2c0a  anual_restart',.
-000055b0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000055c0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000055d0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000055e0: 2d2d 636c 6f75 6420 6177 7320 2d2d 7265  --cloud aws --re
-000055f0: 6769 6f6e 207b 7265 6769 6f6e 7d20 2265  gion {region} "e
-00005600: 6368 6f20 6869 2227 2c0a 2020 2020 2020  cho hi"',.      
-00005610: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00005620: 207b 6e61 6d65 7d20 2d64 2022 6563 686f   {name} -d "echo
-00005630: 2073 7461 7274 3b20 736c 6565 7020 3130   start; sleep 10
-00005640: 3030 3022 272c 0a20 2020 2020 2020 2020  000"',.         
-00005650: 2020 2023 2053 746f 7020 7468 6520 636c     # Stop the cl
-00005660: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-00005670: 2020 2020 2020 2020 2020 2020 6627 6964              f'id
-00005680: 3d60 6177 7320 6563 3220 6465 7363 7269  =`aws ec2 descri
-00005690: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
-000056a0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-000056b0: 2d66 696c 7465 7273 2027 0a20 2020 2020  -filters '.     
-000056c0: 2020 2020 2020 2066 274e 616d 653d 7461         f'Name=ta
-000056d0: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
-000056e0: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
-000056f0: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
-00005700: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
-00005710: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
-00005720: 735b 5d2e 496e 7374 616e 6365 4964 2027  s[].InstanceId '
-00005730: 0a20 2020 2020 2020 2020 2020 2027 2d2d  .            '--
-00005740: 6f75 7470 7574 2074 6578 7460 3b20 270a  output text`; '.
-00005750: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
-00005760: 7320 6563 3220 7374 6f70 2d69 6e73 7461  s ec2 stop-insta
-00005770: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-00005780: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00005790: 2020 2020 2027 2d2d 696e 7374 616e 6365       '--instance
-000057a0: 2d69 6473 2024 6964 272c 0a20 2020 2020  -ids $id',.     
-000057b0: 2020 2020 2020 2027 736c 6565 7020 3430         'sleep 40
-000057c0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000057d0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-000057e0: 6e61 6d65 7d20 2d79 2022 6563 686f 2068  name} -y "echo h
-000057f0: 6922 272c 0a20 2020 2020 2020 2020 2020  i"',.           
-00005800: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00005810: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00005820: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005830: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
-00005840: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00005850: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00005860: 7468 6520 736b 796c 6574 2075 7064 6174  the skylet updat
-00005870: 6564 2074 6865 2073 7461 6c65 206a 6f62  ed the stale job
-00005880: 2073 7461 7475 732e 0a20 2020 2020 2020   status..       
-00005890: 2020 2020 2066 2773 6c65 6570 207b 6576       f'sleep {ev
-000058a0: 656e 7473 2e4a 6f62 5570 6461 7465 4576  ents.JobUpdateEv
-000058b0: 656e 742e 4556 454e 545f 494e 5445 5256  ent.EVENT_INTERV
-000058c0: 414c 5f53 4543 4f4e 4453 7d27 2c0a 2020  AL_SECONDS}',.  
-000058d0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-000058e0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-000058f0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-00005900: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-00005910: 2473 2220 7c20 6772 6570 2046 4149 4c45  $s" | grep FAILE
-00005920: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
-00005930: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00005940: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00005950: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00005960: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00005970: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-00005980: 6620 7465 7374 5f67 6370 5f73 7461 6c65  f test_gcp_stale
-00005990: 5f6a 6f62 5f6d 616e 7561 6c5f 7265 7374  _job_manual_rest
-000059a0: 6172 7428 293a 0a20 2020 206e 616d 6520  art():.    name 
-000059b0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000059c0: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
-000059d0: 2027 7573 2d77 6573 7432 2d61 270a 2020   'us-west2-a'.  
-000059e0: 2020 7175 6572 795f 636d 6420 3d20 2866    query_cmd = (f
-000059f0: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-00005a00: 696e 7374 616e 6365 7320 6c69 7374 202d  instances list -
-00005a10: 2d66 696c 7465 723d 270a 2020 2020 2020  -filter='.      
-00005a20: 2020 2020 2020 2020 2020 2066 2722 286c             f'"(l
-00005a30: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
-00005a40: 722d 6e61 6d65 3d7b 6e61 6d65 7d29 2220  r-name={name})" 
-00005a50: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00005a60: 2020 2066 272d 2d7a 6f6e 6573 3d7b 7a6f     f'--zones={zo
-00005a70: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
-00005a80: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
-00005a90: 2073 746f 705f 636d 6420 3d20 2866 2767   stop_cmd = (f'g
-00005aa0: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
-00005ab0: 7374 616e 6365 7320 7374 6f70 202d 2d7a  stances stop --z
-00005ac0: 6f6e 653d 7b7a 6f6e 657d 270a 2020 2020  one={zone}'.    
-00005ad0: 2020 2020 2020 2020 2020 2020 6627 202d              f' -
-00005ae0: 2d71 7569 6574 2024 287b 7175 6572 795f  -quiet $({query_
-00005af0: 636d 647d 2927 290a 2020 2020 7465 7374  cmd})').    test
-00005b00: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00005b10: 2027 6763 705f 7374 616c 655f 6a6f 625f   'gcp_stale_job_
-00005b20: 6d61 6e75 616c 5f72 6573 7461 7274 272c  manual_restart',
-00005b30: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00005b40: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00005b50: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00005b60: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
-00005b70: 6f6e 6520 7b7a 6f6e 657d 2022 6563 686f  one {zone} "echo
-00005b80: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
-00005b90: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00005ba0: 616d 657d 202d 6420 2265 6368 6f20 7374  ame} -d "echo st
-00005bb0: 6172 743b 2073 6c65 6570 2031 3030 3030  art; sleep 10000
-00005bc0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00005bd0: 2320 5374 6f70 2074 6865 2063 6c75 7374  # Stop the clust
-00005be0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
-00005bf0: 2020 2020 2020 2020 2073 746f 705f 636d           stop_cm
-00005c00: 642c 0a20 2020 2020 2020 2020 2020 2027  d,.            '
-00005c10: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
-00005c20: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00005c30: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d79  nch -c {name} -y
-00005c40: 2022 6563 686f 2068 6922 272c 0a20 2020   "echo hi"',.   
-00005c50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00005c60: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-00005c70: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00005c80: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005c90: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
-00005ca0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00005cb0: 2045 6e73 7572 6520 7468 6520 736b 796c   Ensure the skyl
-00005cc0: 6574 2075 7064 6174 6564 2074 6865 2073  et updated the s
-00005cd0: 7461 6c65 206a 6f62 2073 7461 7475 732e  tale job status.
-00005ce0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005cf0: 6c65 6570 207b 6576 656e 7473 2e4a 6f62  leep {events.Job
-00005d00: 5570 6461 7465 4576 656e 742e 4556 454e  UpdateEvent.EVEN
-00005d10: 545f 494e 5445 5256 414c 5f53 4543 4f4e  T_INTERVAL_SECON
-00005d20: 4453 7d27 2c0a 2020 2020 2020 2020 2020  DS}',.          
-00005d30: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-00005d40: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-00005d50: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00005d60: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-00005d70: 6570 2046 4149 4c45 4427 2c0a 2020 2020  ep FAILED',.    
-00005d80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00005d90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00005da0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00005db0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00005dc0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-00005dd0: 2d20 4368 6563 6b20 536b 7927 7320 656e  - Check Sky's en
-00005de0: 7669 726f 6e6d 656e 7420 7661 7269 6162  vironment variab
-00005df0: 6c65 733b 2077 6f72 6b64 6972 2e20 2d2d  les; workdir. --
-00005e00: 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074 6573  --------.def tes
-00005e10: 745f 656e 765f 6368 6563 6b28 6765 6e65  t_env_check(gene
-00005e20: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00005e30: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00005e40: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00005e50: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00005e60: 0a20 2020 2020 2020 2027 656e 765f 6368  .        'env_ch
-00005e70: 6563 6b27 2c0a 2020 2020 2020 2020 5b0a  eck',.        [.
-00005e80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005e90: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00005ea0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00005eb0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-00005ec0: 6465 7461 6368 2d73 6574 7570 2065 7861  detach-setup exa
-00005ed0: 6d70 6c65 732f 656e 765f 6368 6563 6b2e  mples/env_check.
-00005ee0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00005ef0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00005f00: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00005f10: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00005f20: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00005f30: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00005f40: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00005f50: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00005f60: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00005f70: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00005f80: 2d2d 2d2d 2066 696c 655f 6d6f 756e 7473  ---- file_mounts
-00005f90: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 6465 6620   ----------.def 
-00005fa0: 7465 7374 5f66 696c 655f 6d6f 756e 7473  test_file_mounts
-00005fb0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00005fc0: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
-00005fd0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00005fe0: 6d65 2829 0a20 2020 2074 6573 745f 636f  me().    test_co
-00005ff0: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
-00006000: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
-00006010: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
-00006020: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00006030: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00006040: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00006050: 6c6f 7564 7d20 6578 616d 706c 6573 2f75  loud} examples/u
-00006060: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
-00006070: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00006080: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00006090: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-000060a0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-000060b0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-000060c0: 5d0a 2020 2020 7465 7374 203d 2054 6573  ].    test = Tes
-000060d0: 7428 0a20 2020 2020 2020 2027 7573 696e  t(.        'usin
-000060e0: 675f 6669 6c65 5f6d 6f75 6e74 7327 2c0a  g_file_mounts',.
-000060f0: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
-00006100: 6d61 6e64 732c 0a20 2020 2020 2020 2066  mands,.        f
-00006110: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00006120: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-00006130: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
-00006140: 2320 3230 206d 696e 730a 2020 2020 290a  # 20 mins.    ).
-00006150: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00006160: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00006170: 2d2d 2d2d 2d20 7374 6f72 6167 6520 2d2d  ----- storage --
-00006180: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
-00006190: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
-000061a0: 7374 5f61 7773 5f73 746f 7261 6765 5f6d  st_aws_storage_m
-000061b0: 6f75 6e74 7328 293a 0a20 2020 206e 616d  ounts():.    nam
-000061c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000061d0: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
-000061e0: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
-000061f0: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
-00006200: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
-00006210: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
-00006220: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
-00006230: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
-00006240: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
-00006250: 655f 6d6f 756e 7469 6e67 2e79 616d 6c27  e_mounting.yaml'
-00006260: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
-00006270: 2020 7465 6d70 6c61 7465 203d 206a 696e    template = jin
-00006280: 6a61 322e 5465 6d70 6c61 7465 2874 656d  ja2.Template(tem
-00006290: 706c 6174 655f 7374 7229 0a20 2020 2063  plate_str).    c
-000062a0: 6f6e 7465 6e74 203d 2074 656d 706c 6174  ontent = templat
-000062b0: 652e 7265 6e64 6572 2873 746f 7261 6765  e.render(storage
-000062c0: 5f6e 616d 653d 7374 6f72 6167 655f 6e61  _name=storage_na
-000062d0: 6d65 290a 2020 2020 7769 7468 2074 656d  me).    with tem
-000062e0: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
-000062f0: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
-00006300: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
-00006310: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-00006320: 2066 2e77 7269 7465 2863 6f6e 7465 6e74   f.write(content
-00006330: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
-00006340: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
-00006350: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
-00006360: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
-00006370: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
-00006380: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
-00006390: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
-000063a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000063b0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-000063c0: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
-000063d0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
-000063e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000063f0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00006400: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00006410: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
-00006420: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-00006430: 6177 7320 7333 206c 7320 7b73 746f 7261  aws s3 ls {stora
-00006440: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
-00006450: 7874 272c 0a20 2020 2020 2020 205d 0a20  xt',.        ]. 
-00006460: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
-00006470: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00006480: 2761 7773 5f73 746f 7261 6765 5f6d 6f75  'aws_storage_mou
-00006490: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
-000064a0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-000064b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000064c0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000064d0: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
-000064e0: 656c 6574 6520 7b73 746f 7261 6765 5f6e  elete {storage_n
-000064f0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00006500: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00006510: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
-00006520: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00006530: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00006540: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00006550: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
-00006560: 6763 705f 7374 6f72 6167 655f 6d6f 756e  gcp_storage_moun
-00006570: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
-00006580: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00006590: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
-000065a0: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
-000065b0: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
-000065c0: 6528 2929 7d27 0a20 2020 2074 656d 706c  e())}'.    templ
-000065d0: 6174 655f 7374 7220 3d20 7061 7468 6c69  ate_str = pathli
-000065e0: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
-000065f0: 2774 6573 7473 2f74 6573 745f 7961 6d6c  'tests/test_yaml
-00006600: 732f 7465 7374 5f73 746f 7261 6765 5f6d  s/test_storage_m
-00006610: 6f75 6e74 696e 672e 7961 6d6c 2729 2e72  ounting.yaml').r
-00006620: 6561 645f 7465 7874 2829 0a20 2020 2074  ead_text().    t
-00006630: 656d 706c 6174 6520 3d20 6a69 6e6a 6132  emplate = jinja2
-00006640: 2e54 656d 706c 6174 6528 7465 6d70 6c61  .Template(templa
-00006650: 7465 5f73 7472 290a 2020 2020 636f 6e74  te_str).    cont
-00006660: 656e 7420 3d20 7465 6d70 6c61 7465 2e72  ent = template.r
-00006670: 656e 6465 7228 7374 6f72 6167 655f 6e61  ender(storage_na
-00006680: 6d65 3d73 746f 7261 6765 5f6e 616d 6529  me=storage_name)
-00006690: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
-000066a0: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
-000066b0: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
-000066c0: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
-000066d0: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
-000066e0: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
-000066f0: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
-00006700: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-00006710: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
-00006720: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00006730: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-00006740: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
-00006750: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
-00006760: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00006770: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00006780: 202d 2d63 6c6f 7564 2067 6370 207b 6669   --cloud gcp {fi
-00006790: 6c65 5f70 6174 687d 272c 0a20 2020 2020  le_path}',.     
-000067a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000067b0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-000067c0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000067d0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-000067e0: 2020 2020 2020 2020 2020 2066 2767 7375             f'gsu
-000067f0: 7469 6c20 6c73 2067 733a 2f2f 7b73 746f  til ls gs://{sto
-00006800: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
-00006810: 2e74 7874 272c 0a20 2020 2020 2020 205d  .txt',.        ]
-00006820: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
-00006830: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
-00006840: 2020 2767 6370 5f73 746f 7261 6765 5f6d    'gcp_storage_m
-00006850: 6f75 6e74 7327 2c0a 2020 2020 2020 2020  ounts',.        
-00006860: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-00006870: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
-00006880: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00006890: 6d65 7d3b 2073 6b79 2073 746f 7261 6765  me}; sky storage
-000068a0: 2064 656c 6574 6520 7b73 746f 7261 6765   delete {storage
-000068b0: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
-000068c0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-000068d0: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
-000068e0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000068f0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00006900: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00006910: 6d61 726b 2e63 6c6f 7564 666c 6172 650a  mark.cloudflare.
-00006920: 6465 6620 7465 7374 5f63 6c6f 7564 666c  def test_cloudfl
-00006930: 6172 655f 7374 6f72 6167 655f 6d6f 756e  are_storage_moun
-00006940: 7473 2867 656e 6572 6963 5f63 6c6f 7564  ts(generic_cloud
-00006950: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
-00006960: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00006970: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
-00006980: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
-00006990: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
-000069a0: 696d 6528 2929 7d27 0a20 2020 2074 656d  ime())}'.    tem
-000069b0: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
-000069c0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
-000069d0: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
-000069e0: 6d6c 732f 7465 7374 5f72 325f 7374 6f72  mls/test_r2_stor
-000069f0: 6167 655f 6d6f 756e 7469 6e67 2e79 616d  age_mounting.yam
-00006a00: 6c27 292e 7265 6164 5f74 6578 7428 290a  l').read_text().
-00006a10: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
-00006a20: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
-00006a30: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
-00006a40: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
-00006a50: 6174 652e 7265 6e64 6572 2873 746f 7261  ate.render(stora
-00006a60: 6765 5f6e 616d 653d 7374 6f72 6167 655f  ge_name=storage_
-00006a70: 6e61 6d65 290a 2020 2020 656e 6470 6f69  name).    endpoi
-00006a80: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
-00006a90: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
-00006aa0: 696e 7428 290a 2020 2020 7769 7468 2074  int().    with t
-00006ab0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
-00006ac0: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
-00006ad0: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
-00006ae0: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
-00006af0: 2020 2066 2e77 7269 7465 2863 6f6e 7465     f.write(conte
-00006b00: 6e74 290a 2020 2020 2020 2020 662e 666c  nt).        f.fl
-00006b10: 7573 6828 290a 2020 2020 2020 2020 6669  ush().        fi
-00006b20: 6c65 5f70 6174 6820 3d20 662e 6e61 6d65  le_path = f.name
-00006b30: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
-00006b40: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
-00006b50: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
-00006b60: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
-00006b70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006b80: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00006b90: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-00006ba0: 656e 6572 6963 5f63 6c6f 7564 7d20 7b66  eneric_cloud} {f
-00006bb0: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
-00006bc0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00006bd0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00006be0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00006bf0: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00006c00: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
-00006c10: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
-00006c20: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
-00006c30: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
-00006c40: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
-00006c50: 3320 6c73 2073 333a 2f2f 7b73 746f 7261  3 ls s3://{stora
-00006c60: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
-00006c70: 7874 202d 2d65 6e64 706f 696e 7420 7b65  xt --endpoint {e
-00006c80: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
-00006c90: 726f 6669 6c65 3d72 3227 0a20 2020 2020  rofile=r2'.     
-00006ca0: 2020 205d 0a0a 2020 2020 2020 2020 7465     ]..        te
-00006cb0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00006cc0: 2020 2020 2020 2027 636c 6f75 6466 6c61         'cloudfla
-00006cd0: 7265 5f73 746f 7261 6765 5f6d 6f75 6e74  re_storage_mount
-00006ce0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00006cf0: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
-00006d00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006d10: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d3b   down -y {name};
-00006d20: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
-00006d30: 6574 6520 7b73 746f 7261 6765 5f6e 616d  ete {storage_nam
-00006d40: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-00006d50: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00006d60: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
-00006d70: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00006d80: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00006d90: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00006da0: 2043 4c49 206c 6f67 7320 2d2d 2d2d 2d2d   CLI logs ------
-00006db0: 2d2d 2d2d 0a64 6566 2074 6573 745f 636c  ----.def test_cl
-00006dc0: 695f 6c6f 6773 2867 656e 6572 6963 5f63  i_logs(generic_c
-00006dd0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-00006de0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00006df0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00006e00: 696d 6573 7461 6d70 203d 2074 696d 652e  imestamp = time.
-00006e10: 7469 6d65 2829 0a20 2020 2074 6573 7420  time().    test 
-00006e20: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00006e30: 2763 6c69 5f6c 6f67 7327 2c0a 2020 2020  'cli_logs',.    
-00006e40: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00006e50: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00006e60: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00006e70: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-00006e80: 7564 7d20 2d2d 6e75 6d2d 6e6f 6465 7320  ud} --num-nodes 
-00006e90: 3220 2265 6368 6f20 7b74 696d 6573 7461  2 "echo {timesta
-00006ea0: 6d70 7d20 3122 272c 0a20 2020 2020 2020  mp} 1"',.       
-00006eb0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00006ec0: 7b6e 616d 657d 2022 6563 686f 207b 7469  {name} "echo {ti
-00006ed0: 6d65 7374 616d 707d 2032 2227 2c0a 2020  mestamp} 2"',.  
-00006ee0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006ef0: 6578 6563 207b 6e61 6d65 7d20 2265 6368  exec {name} "ech
-00006f00: 6f20 7b74 696d 6573 7461 6d70 7d20 3322  o {timestamp} 3"
-00006f10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006f20: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00006f30: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
-00006f40: 707d 2034 2227 2c0a 2020 2020 2020 2020  p} 4"',.        
-00006f50: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00006f60: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-00006f70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006f80: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00006f90: 2033 2034 202d 2d73 796e 632d 646f 776e   3 4 --sync-down
-00006fa0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006fb0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00006fc0: 202a 202d 2d73 796e 632d 646f 776e 272c   * --sync-down',
-00006fd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006fe0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00006ff0: 207c 2067 7265 7020 227b 7469 6d65 7374   | grep "{timest
-00007000: 616d 707d 2031 2227 2c0a 2020 2020 2020  amp} 1"',.      
-00007010: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00007020: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
-00007030: 7b74 696d 6573 7461 6d70 7d20 3422 272c  {timestamp} 4"',
-00007040: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00007050: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00007060: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00007070: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00007080: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00007090: 2d2d 2d2d 2d2d 204a 6f62 2051 7565 7565  ------ Job Queue
-000070a0: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
-000070b0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-000070c0: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-000070d0: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-000070e0: 6f74 2068 6176 6520 4b38 3020 6770 7573  ot have K80 gpus
-000070f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00007100: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-00007110: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
-00007120: 4b38 3020 6770 7573 2e20 7275 6e20 7465  K80 gpus. run te
-00007130: 7374 5f69 626d 5f6a 6f62 5f71 7565 7565  st_ibm_job_queue
-00007140: 2069 6e73 7465 6164 0a64 6566 2074 6573   instead.def tes
-00007150: 745f 6a6f 625f 7175 6575 6528 6765 6e65  t_job_queue(gene
-00007160: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-00007170: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00007180: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00007190: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-000071a0: 0a20 2020 2020 2020 2027 6a6f 625f 7175  .        'job_qu
-000071b0: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
-000071c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000071d0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-000071e0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-000071f0: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
-00007200: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-00007210: 2f63 6c75 7374 6572 2e79 616d 6c27 2c0a  /cluster.yaml',.
-00007220: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00007230: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-00007240: 207b 6e61 6d65 7d2d 3120 2d64 2065 7861   {name}-1 -d exa
-00007250: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-00007260: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
-00007270: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00007280: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-00007290: 657d 2d32 202d 6420 6578 616d 706c 6573  e}-2 -d examples
-000072a0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
-000072b0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000072c0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-000072d0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-000072e0: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-000072f0: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
-00007300: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007310: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-00007320: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-00007330: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-00007340: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-00007350: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-00007360: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-00007370: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-00007380: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-00007390: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-000073a0: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-000073b0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-000073c0: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
-000073d0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-000073e0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-000073f0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-00007400: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-00007410: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-00007420: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
-00007430: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-00007440: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-00007450: 7920 7b6e 616d 657d 2032 272c 0a20 2020  y {name} 2',.   
-00007460: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00007470: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-00007480: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-00007490: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-000074a0: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-000074b0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-000074c0: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-000074d0: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-000074e0: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-000074f0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3327  cel -y {name} 3'
-00007500: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00007510: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00007520: 2d2d 6770 7573 204b 3830 3a30 2e32 2022  --gpus K80:0.2 "
-00007530: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
-00007540: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
-00007550: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
-00007560: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
-00007570: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00007580: 6d65 7d20 2d2d 6770 7573 204b 3830 3a31  me} --gpus K80:1
-00007590: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-000075a0: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-000075b0: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-000075c0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-000075d0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000075e0: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
-000075f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00007600: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00007610: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
-00007620: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00007630: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-00007640: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-00007650: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00007660: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00007670: 6172 6b2e 6c61 6d62 6461 5f63 6c6f 7564  ark.lambda_cloud
-00007680: 0a64 6566 2074 6573 745f 6c61 6d62 6461  .def test_lambda
-00007690: 5f6a 6f62 5f71 7565 7565 2829 3a0a 2020  _job_queue():.  
-000076a0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000076b0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000076c0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000076d0: 2020 2020 2020 276c 616d 6264 615f 6a6f        'lambda_jo
-000076e0: 625f 7175 6575 6527 2c0a 2020 2020 2020  b_queue',.      
-000076f0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00007700: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00007710: 2d63 207b 6e61 6d65 7d20 7b4c 414d 4244  -c {name} {LAMBD
-00007720: 415f 5459 5045 7d20 6578 616d 706c 6573  A_TYPE} examples
-00007730: 2f6a 6f62 5f71 7565 7565 2f63 6c75 7374  /job_queue/clust
-00007740: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-00007750: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00007760: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-00007770: 7d2d 3120 2d2d 6770 7573 2041 3130 3a30  }-1 --gpus A10:0
-00007780: 2e35 202d 6420 6578 616d 706c 6573 2f6a  .5 -d examples/j
-00007790: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
-000077a0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000077b0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-000077c0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d2d  } -n {name}-2 --
-000077d0: 6770 7573 2041 3130 3a30 2e35 202d 6420  gpus A10:0.5 -d 
-000077e0: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-000077f0: 7565 2f6a 6f62 2e79 616d 6c27 2c0a 2020  ue/job.yaml',.  
-00007800: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00007810: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-00007820: 6e61 6d65 7d2d 3320 2d2d 6770 7573 2041  name}-3 --gpus A
-00007830: 3130 3a30 2e35 202d 6420 6578 616d 706c  10:0.5 -d exampl
-00007840: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
-00007850: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00007860: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-00007870: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-00007880: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-00007890: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-000078a0: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-000078b0: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-000078c0: 616d 657d 2d32 207c 2067 7265 7020 5255  ame}-2 | grep RU
-000078d0: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-000078e0: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-000078f0: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-00007900: 616d 657d 2d33 207c 2067 7265 7020 5045  ame}-3 | grep PE
-00007910: 4e44 494e 4727 2c0a 2020 2020 2020 2020  NDING',.        
-00007920: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-00007930: 202d 7920 7b6e 616d 657d 2032 272c 0a20   -y {name} 2',. 
-00007940: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00007950: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
-00007960: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
-00007970: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
-00007980: 657d 2d33 207c 2067 7265 7020 5255 4e4e  e}-3 | grep RUNN
-00007990: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-000079a0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
-000079b0: 7920 7b6e 616d 657d 2033 272c 0a20 2020  y {name} 3',.   
-000079c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000079d0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-000079e0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-000079f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00007a00: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00007a10: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
-00007a20: 6962 6d5f 6a6f 625f 7175 6575 6528 293a  ibm_job_queue():
-00007a30: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00007a40: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00007a50: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00007a60: 0a20 2020 2020 2020 2027 6962 6d5f 6a6f  .        'ibm_jo
-00007a70: 625f 7175 6575 6527 2c0a 2020 2020 2020  b_queue',.      
-00007a80: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00007a90: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00007aa0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-00007ab0: 6420 6962 6d20 2d2d 6770 7573 2076 3130  d ibm --gpus v10
-00007ac0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00007ad0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00007ae0: 7d20 2d6e 207b 6e61 6d65 7d2d 3120 2d2d  } -n {name}-1 --
-00007af0: 636c 6f75 6420 6962 6d20 2d64 2065 7861  cloud ibm -d exa
-00007b00: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-00007b10: 6a6f 625f 6962 6d2e 7961 6d6c 272c 0a20  job_ibm.yaml',. 
-00007b20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00007b30: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-00007b40: 7b6e 616d 657d 2d32 202d 2d63 6c6f 7564  {name}-2 --cloud
-00007b50: 2069 626d 202d 6420 6578 616d 706c 6573   ibm -d examples
-00007b60: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f69  /job_queue/job_i
-00007b70: 626d 2e79 616d 6c27 2c0a 2020 2020 2020  bm.yaml',.      
-00007b80: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00007b90: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-00007ba0: 7d2d 3320 2d2d 636c 6f75 6420 6962 6d20  }-3 --cloud ibm 
-00007bb0: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-00007bc0: 7175 6575 652f 6a6f 625f 6962 6d2e 7961  queue/job_ibm.ya
-00007bd0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00007be0: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
-00007bf0: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
-00007c00: 7d2d 3120 7c20 6772 6570 2052 554e 4e49  }-1 | grep RUNNI
-00007c10: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-00007c20: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
-00007c30: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
-00007c40: 7d2d 3220 7c20 6772 6570 2052 554e 4e49  }-2 | grep RUNNI
-00007c50: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-00007c60: 2066 2773 6b79 2071 7565 7565 207b 6e61   f'sky queue {na
-00007c70: 6d65 7d20 7c20 6772 6570 207b 6e61 6d65  me} | grep {name
-00007c80: 7d2d 3320 7c20 6772 6570 2050 454e 4449  }-3 | grep PENDI
-00007c90: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-00007ca0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-00007cb0: 207b 6e61 6d65 7d20 3227 2c0a 2020 2020   {name} 2',.    
-00007cc0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00007cd0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00007ce0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
-00007cf0: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
-00007d00: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
-00007d10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00007d20: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
-00007d30: 6e61 6d65 7d20 3327 2c0a 2020 2020 2020  name} 3',.      
-00007d40: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00007d50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00007d60: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00007d70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00007d80: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00007d90: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-00007da0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-00007db0: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
-00007dc0: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-00007dd0: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-00007de0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-00007df0: 6861 7665 2054 3420 6770 7573 2e20 7275  have T4 gpus. ru
-00007e00: 6e20 7465 7374 5f69 626d 5f6a 6f62 5f71  n test_ibm_job_q
-00007e10: 7565 7565 5f6d 756c 7469 6e6f 6465 2069  ueue_multinode i
-00007e20: 6e73 7465 6164 0a64 6566 2074 6573 745f  nstead.def test_
-00007e30: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
-00007e40: 6f64 6528 6765 6e65 7269 635f 636c 6f75  ode(generic_clou
-00007e50: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00007e60: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00007e70: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00007e80: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00007e90: 2027 6a6f 625f 7175 6575 655f 6d75 6c74   'job_queue_mult
-00007ea0: 696e 6f64 6527 2c0a 2020 2020 2020 2020  inode',.        
-00007eb0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00007ec0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-00007ed0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-00007ee0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-00007ef0: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
-00007f00: 7565 2f63 6c75 7374 6572 5f6d 756c 7469  ue/cluster_multi
-00007f10: 6e6f 6465 2e79 616d 6c27 2c0a 2020 2020  node.yaml',.    
-00007f20: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00007f30: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-00007f40: 6d65 7d2d 3120 2d64 2065 7861 6d70 6c65  me}-1 -d example
-00007f50: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
-00007f60: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
-00007f70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007f80: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00007f90: 6e20 7b6e 616d 657d 2d32 202d 6420 6578  n {name}-2 -d ex
-00007fa0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-00007fb0: 2f6a 6f62 5f6d 756c 7469 6e6f 6465 2e79  /job_multinode.y
-00007fc0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00007fd0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00007fe0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-00007ff0: 657d 2d33 202d 2d64 6574 6163 682d 7365  e}-3 --detach-se
-00008000: 7475 7020 2d64 2065 7861 6d70 6c65 732f  tup -d examples/
-00008010: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
-00008020: 6c74 696e 6f64 652e 7961 6d6c 272c 0a20  ltinode.yaml',. 
-00008030: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00008040: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-00008050: 7d29 2026 2620 6563 686f 2022 2473 2220  }) && echo "$s" 
-00008060: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
-00008070: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
-00008080: 6772 6570 2052 554e 4e49 4e47 2927 2c0a  grep RUNNING)',.
-00008090: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-000080a0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-000080b0: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
-000080c0: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-000080d0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-000080e0: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
-000080f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008100: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-00008110: 6d65 7d29 2026 2620 6563 686f 2022 2473  me}) && echo "$s
-00008120: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
-00008130: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-00008140: 7c20 6772 6570 2053 4554 5449 4e47 5f55  | grep SETTING_U
-00008150: 5029 272c 0a20 2020 2020 2020 2020 2020  P)',.           
-00008160: 2027 736c 6565 7020 3930 272c 0a20 2020   'sleep 90',.   
-00008170: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00008180: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-00008190: 2026 2620 6563 686f 2022 2473 2220 2626   && echo "$s" &&
-000081a0: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
-000081b0: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
-000081c0: 6570 2050 454e 4449 4e47 2927 2c0a 2020  ep PENDING)',.  
-000081d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000081e0: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-000081f0: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00008200: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-00008210: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-00008220: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
-00008230: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-00008240: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-00008250: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-00008260: 3320 7c20 6772 6570 2052 554e 4e49 4e47  3 | grep RUNNING
-00008270: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008280: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
-00008290: 6e61 6d65 7d20 3120 3220 3327 2c0a 2020  name} 1 2 3',.  
-000082a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000082b0: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-000082c0: 202d 6e20 7b6e 616d 657d 2d34 202d 2d64   -n {name}-4 --d
-000082d0: 6574 6163 682d 7365 7475 7020 2d64 2065  etach-setup -d e
-000082e0: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-000082f0: 652f 6a6f 625f 6d75 6c74 696e 6f64 652e  e/job_multinode.
-00008300: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00008310: 2020 2023 2054 6573 7420 7468 6520 6a6f     # Test the jo
-00008320: 6220 7374 6174 7573 2069 7320 636f 7272  b status is corr
-00008330: 6563 746c 7920 7365 7420 746f 2053 4554  ectly set to SET
-00008340: 5449 4e47 5f55 502c 2064 7572 696e 6720  TING_UP, during 
-00008350: 7468 6520 7365 7475 7020 6973 2072 756e  the setup is run
-00008360: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
-00008370: 2020 2320 616e 6420 7468 6520 6a6f 6220    # and the job 
-00008380: 6361 6e20 6265 2063 616e 6365 6c6c 6564  can be cancelled
-00008390: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
-000083a0: 702e 0a20 2020 2020 2020 2020 2020 2066  p..            f
-000083b0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-000083c0: 6e61 6d65 7d29 2026 2620 6563 686f 2022  name}) && echo "
-000083d0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-000083e0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-000083f0: 3420 7c20 6772 6570 2053 4554 5449 4e47  4 | grep SETTING
-00008400: 5f55 5029 272c 0a20 2020 2020 2020 2020  _UP)',.         
-00008410: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-00008420: 2d79 207b 6e61 6d65 7d20 3427 2c0a 2020  -y {name} 4',.  
-00008430: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00008440: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-00008450: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-00008460: 2620 2865 6368 6f20 2224 7322 207c 2067  & (echo "$s" | g
-00008470: 7265 7020 7b6e 616d 657d 2d34 207c 2067  rep {name}-4 | g
-00008480: 7265 7020 4341 4e43 454c 4c45 4429 272c  rep CANCELLED)',
-00008490: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000084a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-000084b0: 2d67 7075 7320 5434 3a30 2e32 2022 5b5b  -gpus T4:0.2 "[[
-000084c0: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
-000084d0: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
-000084e0: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
-000084f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00008500: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00008510: 7d20 2d2d 6770 7573 2054 343a 302e 3220  } --gpus T4:0.2 
-00008520: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 225b  --num-nodes 2 "[
-00008530: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
-00008540: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
-00008550: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
-00008560: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-00008570: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00008580: 657d 202d 2d67 7075 7320 5434 3a31 202d  e} --gpus T4:1 -
-00008590: 2d6e 756d 2d6e 6f64 6573 2032 2022 5b5b  -num-nodes 2 "[[
-000085a0: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
-000085b0: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
-000085c0: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
-000085d0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000085e0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-000085f0: 7d20 3520 2d2d 7374 6174 7573 272c 0a20  } 5 --status',. 
-00008600: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008610: 206c 6f67 7320 7b6e 616d 657d 2036 202d   logs {name} 6 -
-00008620: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00008630: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00008640: 207b 6e61 6d65 7d20 3720 2d2d 7374 6174   {name} 7 --stat
-00008650: 7573 272c 0a20 2020 2020 2020 205d 2c0a  us',.        ],.
-00008660: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00008670: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00008680: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00008690: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000086a0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-000086b0: 6d62 6461 5f63 6c6f 7564 2020 2320 4e6f  mbda_cloud  # No
-000086c0: 204c 616d 6264 6120 436c 6f75 6420 564d   Lambda Cloud VM
-000086d0: 2068 6173 2038 2043 5055 730a 6465 6620   has 8 CPUs.def 
-000086e0: 7465 7374 5f6c 6172 6765 5f6a 6f62 5f71  test_large_job_q
-000086f0: 7565 7565 2867 656e 6572 6963 5f63 6c6f  ueue(generic_clo
-00008700: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-00008710: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00008720: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00008730: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00008740: 2020 276c 6172 6765 5f6a 6f62 5f71 7565    'large_job_que
-00008750: 7565 272c 0a20 2020 2020 2020 205b 0a20  ue',.        [. 
-00008760: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008770: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00008780: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00008790: 6e65 7269 635f 636c 6f75 647d 272c 0a20  neric_cloud}',. 
-000087a0: 2020 2020 2020 2020 2020 2066 2766 6f72             f'for
-000087b0: 2069 2069 6e20 6073 6571 2031 2037 3560   i in `seq 1 75`
-000087c0: 3b20 646f 2073 6b79 2065 7865 6320 7b6e  ; do sky exec {n
-000087d0: 616d 657d 202d 6420 2265 6368 6f20 2469  ame} -d "echo $i
-000087e0: 3b20 736c 6565 7020 3130 3030 3030 3030  ; sleep 10000000
-000087f0: 3022 3b20 646f 6e65 272c 0a20 2020 2020  0"; done',.     
-00008800: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-00008810: 6365 6c20 2d79 207b 6e61 6d65 7d20 3120  cel -y {name} 1 
-00008820: 3220 3320 3420 3520 3620 3720 3820 3920  2 3 4 5 6 7 8 9 
-00008830: 3130 2031 3120 3132 2031 3320 3134 2031  10 11 12 13 14 1
-00008840: 3520 3136 272c 0a20 2020 2020 2020 2020  5 16',.         
-00008850: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
-00008860: 2020 2020 2020 2020 2020 2023 2045 6163             # Eac
-00008870: 6820 6a6f 6220 7461 6b65 7320 302e 3520  h job takes 0.5 
-00008880: 4350 5520 616e 6420 7468 6520 6465 6661  CPU and the defa
-00008890: 756c 7420 564d 2068 6173 2038 2043 5055  ult VM has 8 CPU
-000088a0: 732c 2073 6f20 7468 6572 6520 7368 6f75  s, so there shou
-000088b0: 6c64 2062 6520 3820 2f20 302e 3520 3d20  ld be 8 / 0.5 = 
-000088c0: 3136 206a 6f62 7320 7275 6e6e 696e 672e  16 jobs running.
-000088d0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000088e0: 6865 2066 6972 7374 2031 3620 6a6f 6273  he first 16 jobs
-000088f0: 2061 7265 2063 616e 6365 6c65 642c 2073   are canceled, s
-00008900: 6f20 7468 6572 6520 7368 6f75 6c64 2062  o there should b
-00008910: 6520 3735 202d 2033 3220 3d20 3433 206a  e 75 - 32 = 43 j
-00008920: 6f62 7320 5045 4e44 494e 472e 0a20 2020  obs PENDING..   
-00008930: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00008940: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-00008950: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00008960: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00008970: 7322 207c 2067 7265 7020 2d76 2067 7265  s" | grep -v gre
-00008980: 7020 7c20 6772 6570 2050 454e 4449 4e47  p | grep PENDING
-00008990: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
-000089a0: 3433 272c 0a20 2020 2020 2020 205d 2c0a  43',.        ],.
-000089b0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-000089c0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-000089d0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-000089e0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
-000089f0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00008a00: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00008a10: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
-00008a20: 5f69 626d 5f6a 6f62 5f71 7565 7565 5f6d  _ibm_job_queue_m
-00008a30: 756c 7469 6e6f 6465 2829 3a0a 2020 2020  ultinode():.    
-00008a40: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00008a50: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00008a60: 6173 6b5f 6669 6c65 203d 2027 6578 616d  ask_file = 'exam
-00008a70: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
-00008a80: 6f62 5f6d 756c 7469 6e6f 6465 5f69 626d  ob_multinode_ibm
-00008a90: 2e79 616d 6c27 0a20 2020 2074 6573 7420  .yaml'.    test 
-00008aa0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00008ab0: 2769 626d 5f6a 6f62 5f71 7565 7565 5f6d  'ibm_job_queue_m
-00008ac0: 756c 7469 6e6f 6465 272c 0a20 2020 2020  ultinode',.     
-00008ad0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00008ae0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00008af0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-00008b00: 7564 2069 626d 202d 2d67 7075 7320 7631  ud ibm --gpus v1
-00008b10: 3030 202d 2d6e 756d 2d6e 6f64 6573 2032  00 --num-nodes 2
-00008b20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008b30: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00008b40: 202d 6e20 7b6e 616d 657d 2d31 202d 6420   -n {name}-1 -d 
-00008b50: 7b74 6173 6b5f 6669 6c65 7d27 2c0a 2020  {task_file}',.  
-00008b60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00008b70: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-00008b80: 6e61 6d65 7d2d 3220 2d64 207b 7461 736b  name}-2 -d {task
-00008b90: 5f66 696c 657d 272c 0a20 2020 2020 2020  _file}',.       
-00008ba0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00008bb0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00008bc0: 6e20 7b6e 616d 657d 2d33 202d 2d64 6574  n {name}-3 --det
-00008bd0: 6163 682d 7365 7475 7020 2d64 207b 7461  ach-setup -d {ta
-00008be0: 736b 5f66 696c 657d 272c 0a20 2020 2020  sk_file}',.     
-00008bf0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00008c00: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
-00008c10: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
-00008c20: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
-00008c30: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-00008c40: 6570 2052 554e 4e49 4e47 2927 2c0a 2020  ep RUNNING)',.  
-00008c50: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00008c60: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-00008c70: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
-00008c80: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-00008c90: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-00008ca0: 2067 7265 7020 5255 4e4e 494e 4729 272c   grep RUNNING)',
-00008cb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00008cc0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-00008cd0: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
-00008ce0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-00008cf0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-00008d00: 3320 7c20 6772 6570 2053 4554 5449 4e47  3 | grep SETTING
-00008d10: 5f55 5029 272c 0a20 2020 2020 2020 2020  _UP)',.         
-00008d20: 2020 2027 736c 6565 7020 3930 272c 0a20     'sleep 90',. 
-00008d30: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00008d40: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-00008d50: 7d29 2026 2620 7072 696e 7466 2022 2473  }) && printf "$s
-00008d60: 2220 2626 2028 6563 686f 2022 2473 2220  " && (echo "$s" 
-00008d70: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-00008d80: 7c20 6772 6570 2050 454e 4449 4e47 2927  | grep PENDING)'
-00008d90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00008da0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-00008db0: 616d 657d 2031 272c 0a20 2020 2020 2020  ame} 1',.       
-00008dc0: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
-00008dd0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00008de0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
-00008df0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-00008e00: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
-00008e10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00008e20: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-00008e30: 657d 2031 2032 2033 272c 0a20 2020 2020  e} 1 2 3',.     
-00008e40: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00008e50: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d6e  nch -c {name} -n
-00008e60: 207b 6e61 6d65 7d2d 3420 2d2d 6465 7461   {name}-4 --deta
-00008e70: 6368 2d73 6574 7570 202d 6420 7b74 6173  ch-setup -d {tas
-00008e80: 6b5f 6669 6c65 7d27 2c0a 2020 2020 2020  k_file}',.      
-00008e90: 2020 2020 2020 2320 5465 7374 2074 6865        # Test the
-00008ea0: 206a 6f62 2073 7461 7475 7320 6973 2063   job status is c
-00008eb0: 6f72 7265 6374 6c79 2073 6574 2074 6f20  orrectly set to 
-00008ec0: 5345 5454 494e 475f 5550 2c20 6475 7269  SETTING_UP, duri
-00008ed0: 6e67 2074 6865 2073 6574 7570 2069 7320  ng the setup is 
-00008ee0: 7275 6e6e 696e 672c 0a20 2020 2020 2020  running,.       
-00008ef0: 2020 2020 2023 2061 6e64 2074 6865 206a       # and the j
-00008f00: 6f62 2063 616e 2062 6520 6361 6e63 656c  ob can be cancel
-00008f10: 6c65 6420 6475 7269 6e67 2074 6865 2073  led during the s
-00008f20: 6574 7570 2e0a 2020 2020 2020 2020 2020  etup..          
-00008f30: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-00008f40: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
-00008f50: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
-00008f60: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-00008f70: 616d 657d 2d34 207c 2067 7265 7020 5345  ame}-4 | grep SE
-00008f80: 5454 494e 475f 5550 2927 2c0a 2020 2020  TTING_UP)',.    
-00008f90: 2020 2020 2020 2020 6627 736b 7920 6361          f'sky ca
-00008fa0: 6e63 656c 202d 7920 7b6e 616d 657d 2034  ncel -y {name} 4
-00008fb0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008fc0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-00008fd0: 6e61 6d65 7d29 2026 2620 7072 696e 7466  name}) && printf
-00008fe0: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
-00008ff0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-00009000: 7d2d 3420 7c20 6772 6570 2043 414e 4345  }-4 | grep CANCE
-00009010: 4c4c 4544 2927 2c0a 2020 2020 2020 2020  LLED)',.        
-00009020: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00009030: 6e61 6d65 7d20 2d2d 6770 7573 2076 3130  name} --gpus v10
-00009040: 303a 302e 3220 225b 5b20 5c24 534b 5950  0:0.2 "[[ \$SKYP
-00009050: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
-00009060: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
-00009070: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
-00009080: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00009090: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
-000090a0: 7320 7631 3030 3a30 2e32 202d 2d6e 756d  s v100:0.2 --num
-000090b0: 2d6e 6f64 6573 2032 2022 5b5b 205c 2453  -nodes 2 "[[ \$S
-000090c0: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
-000090d0: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
-000090e0: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+00003ce0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00003cf0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+00003d00: 6567 696f 6e20 7573 2d77 6573 742d 3220  egion us-west-2 
+00003d10: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+00003d20: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00003d30: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
+00003d40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003d50: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
+00003d60: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00003d70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00003d80: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
+00003d90: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00003da0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00003db0: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
+00003dc0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003dd0: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
+00003de0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00003df0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00003e00: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00003e10: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00003e20: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00003e30: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00003e40: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
+00003e50: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
+00003e60: 5f72 6567 696f 6e28 293a 0a20 2020 206e  _region():.    n
+00003e70: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00003e80: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00003e90: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00003ea0: 2020 2027 6763 705f 696d 6167 655f 6964     'gcp_image_id
+00003eb0: 5f64 6963 745f 7265 6769 6f6e 272c 0a20  _dict_region',. 
+00003ec0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00003ed0: 2020 2020 2023 2055 7365 2072 6567 696f       # Use regio
+00003ee0: 6e20 746f 2066 696c 7465 7220 696d 6167  n to filter imag
+00003ef0: 655f 6964 2064 6963 742e 0a20 2020 2020  e_id dict..     
+00003f00: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00003f10: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00003f20: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
+00003f30: 7431 2074 6573 7473 2f74 6573 745f 7961  t1 tests/test_ya
+00003f40: 6d6c 732f 6763 705f 7065 725f 7265 6769  mls/gcp_per_regi
+00003f50: 6f6e 5f69 6d61 6765 732e 7961 6d6c 2026  on_images.yaml &
+00003f60: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+00003f70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00003f80: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+00003f90: 6570 207b 6e61 6d65 7d20 2626 2065 7869  ep {name} && exi
+00003fa0: 7420 3120 7c7c 2074 7275 6527 2c20 2023  t 1 || true',  #
+00003fb0: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+00003fc0: 7465 7220 6973 206e 6f74 2063 7265 6174  ter is not creat
+00003fd0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00003fe0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00003ff0: 2d63 207b 6e61 6d65 7d20 2d2d 7265 6769  -c {name} --regi
+00004000: 6f6e 2075 732d 7765 7374 3320 7465 7374  on us-west3 test
+00004010: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
+00004020: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
+00004030: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00004040: 2020 2020 2020 2320 5368 6f75 6c64 2073        # Should s
+00004050: 7563 6365 7373 2062 6563 6175 7365 2074  uccess because t
+00004060: 6865 2069 6d61 6765 2069 6420 6d61 7463  he image id matc
+00004070: 6820 666f 7220 7468 6520 7265 6769 6f6e  h for the region
+00004080: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00004090: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+000040a0: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+000040b0: 202d 2d69 6d61 6765 2d69 6420 7072 6f6a   --image-id proj
+000040c0: 6563 7473 2f75 6275 6e74 752d 6f73 2d63  ects/ubuntu-os-c
+000040d0: 6c6f 7564 2f67 6c6f 6261 6c2f 696d 6167  loud/global/imag
+000040e0: 6573 2f75 6275 6e74 752d 3138 3034 2d62  es/ubuntu-1804-b
+000040f0: 696f 6e69 632d 7632 3032 3330 3131 3220  ionic-v20230112 
+00004100: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00004110: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00004120: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00004130: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+00004140: 636c 6f75 6420 6763 7020 2d2d 696d 6167  cloud gcp --imag
+00004150: 652d 6964 2070 726f 6a65 6374 732f 7562  e-id projects/ub
+00004160: 756e 7475 2d6f 732d 636c 6f75 642f 676c  untu-os-cloud/gl
+00004170: 6f62 616c 2f69 6d61 6765 732f 7562 756e  obal/images/ubun
+00004180: 7475 2d31 3830 342d 6269 6f6e 6963 2d76  tu-1804-bionic-v
+00004190: 3230 3233 3031 3132 2074 6573 7473 2f74  20230112 tests/t
+000041a0: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+000041b0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+000041c0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+000041d0: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+000041e0: 6370 202d 2d69 6d61 6765 2d69 6420 736b  cp --image-id sk
+000041f0: 7970 696c 6f74 3a63 7075 2d64 6562 6961  ypilot:cpu-debia
+00004200: 6e2d 3130 2074 6573 7473 2f74 6573 745f  n-10 tests/test_
+00004210: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00004220: 6d6c 2026 2620 6578 6974 2031 207c 7c20  ml && exit 1 || 
+00004230: 7472 7565 272c 0a20 2020 2020 2020 2020  true',.         
+00004240: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00004250: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00004260: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004270: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00004280: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00004290: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000042a0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+000042b0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+000042c0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+000042d0: 202d 2d61 6c6c 207c 2067 7265 7020 7b6e   --all | grep {n
+000042e0: 616d 657d 207c 2067 7265 7020 7573 2d77  ame} | grep us-w
+000042f0: 6573 7433 272c 2020 2320 456e 7375 7265  est3',  # Ensure
+00004300: 2074 6865 2072 6567 696f 6e20 6973 2063   the region is c
+00004310: 6f72 7265 6374 2e0a 2020 2020 2020 2020  orrect..        
+00004320: 2020 2020 2320 456e 7375 7265 2065 7865      # Ensure exe
+00004330: 6320 776f 726b 732e 0a20 2020 2020 2020  c works..       
+00004340: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00004350: 7b6e 616d 657d 202d 2d72 6567 696f 6e20  {name} --region 
+00004360: 7573 2d77 6573 7433 2074 6573 7473 2f74  us-west3 tests/t
+00004370: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
+00004380: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+00004390: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000043a0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000043b0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+000043c0: 7961 6d6c 732f 6763 705f 7065 725f 7265  yamls/gcp_per_re
+000043d0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
+000043e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000043f0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00004400: 202d 2d63 6c6f 7564 2067 6370 202d 2d72   --cloud gcp --r
+00004410: 6567 696f 6e20 7573 2d77 6573 7433 2022  egion us-west3 "
+00004420: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
+00004430: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00004440: 6e61 6d65 7d20 226c 7320 7e22 272c 0a20  name} "ls ~"',. 
+00004450: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004460: 206c 6f67 7320 7b6e 616d 657d 2034 202d   logs {name} 4 -
+00004470: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00004480: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00004490: 207b 6e61 6d65 7d20 3520 2d2d 7374 6174   {name} 5 --stat
+000044a0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+000044b0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000044c0: 657d 2036 202d 2d73 7461 7475 7327 2c0a  e} 6 --status',.
+000044d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000044e0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3720  y logs {name} 7 
+000044f0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00004500: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00004510: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00004520: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00004530: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00004540: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00004550: 2e61 7773 0a64 6566 2074 6573 745f 6177  .aws.def test_aw
+00004560: 735f 696d 6167 655f 6964 5f64 6963 745f  s_image_id_dict_
+00004570: 7a6f 6e65 2829 3a0a 2020 2020 6e61 6d65  zone():.    name
+00004580: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00004590: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+000045a0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+000045b0: 2761 7773 5f69 6d61 6765 5f69 645f 6469  'aws_image_id_di
+000045c0: 6374 5f7a 6f6e 6527 2c0a 2020 2020 2020  ct_zone',.      
+000045d0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+000045e0: 2320 5573 6520 7a6f 6e65 2074 6f20 6669  # Use zone to fi
+000045f0: 6c74 6572 2069 6d61 6765 5f69 6420 6469  lter image_id di
+00004600: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
+00004610: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00004620: 2d63 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  -c {name} --zone
+00004630: 2075 732d 6561 7374 2d31 6220 6578 616d   us-east-1b exam
+00004640: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
+00004650: 696d 6167 6573 2e79 616d 6c20 2626 2065  images.yaml && e
+00004660: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
+00004670: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00004680: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+00004690: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
+000046a0: 207c 7c20 7472 7565 272c 2020 2320 456e   || true',  # En
+000046b0: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+000046c0: 2069 7320 6e6f 7420 6372 6561 7465 642e   is not created.
+000046d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000046e0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+000046f0: 7b6e 616d 657d 202d 2d7a 6f6e 6520 7573  {name} --zone us
+00004700: 2d77 6573 742d 3261 2065 7861 6d70 6c65  -west-2a example
+00004710: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+00004720: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00004730: 2020 2020 2020 2023 2053 686f 756c 6420         # Should 
+00004740: 7375 6363 6573 7320 6265 6361 7573 6520  success because 
+00004750: 7468 6520 696d 6167 6520 6964 206d 6174  the image id mat
+00004760: 6368 2066 6f72 2074 6865 207a 6f6e 652e  ch for the zone.
+00004770: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004780: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00004790: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
+000047a0: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
+000047b0: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
+000047c0: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
+000047d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000047e0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000047f0: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
+00004800: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
+00004810: 3138 3034 2065 7861 6d70 6c65 732f 6d69  1804 examples/mi
+00004820: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00004830: 2020 2020 2020 2020 2023 2046 6169 6c20           # Fail 
+00004840: 6475 6520 746f 2069 6d61 6765 2069 6420  due to image id 
+00004850: 6d69 736d 6174 6368 2e0a 2020 2020 2020  mismatch..      
+00004860: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004870: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
+00004880: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
+00004890: 7562 756e 7475 2d32 3030 3420 6578 616d  ubuntu-2004 exam
+000048a0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+000048b0: 6c20 2626 2065 7869 7420 3120 7c7c 2074  l && exit 1 || t
+000048c0: 7275 6527 2c0a 2020 2020 2020 2020 2020  rue',.          
+000048d0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000048e0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000048f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004900: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00004910: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00004920: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00004930: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00004940: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00004950: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00004960: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
+00004970: 6d65 7d20 7c20 6772 6570 2075 732d 7765  me} | grep us-we
+00004980: 7374 2d32 6127 2c20 2023 2045 6e73 7572  st-2a',  # Ensur
+00004990: 6520 7468 6520 7a6f 6e65 2069 7320 636f  e the zone is co
+000049a0: 7272 6563 742e 0a20 2020 2020 2020 2020  rrect..         
+000049b0: 2020 2023 2045 6e73 7572 6520 6578 6563     # Ensure exec
+000049c0: 2077 6f72 6b73 2e0a 2020 2020 2020 2020   works..        
+000049d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000049e0: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
+000049f0: 7765 7374 2d32 6120 6578 616d 706c 6573  west-2a examples
+00004a00: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+00004a10: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00004a20: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004a30: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00004a40: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+00004a50: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00004a60: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00004a70: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00004a80: 6177 7320 2d2d 7265 6769 6f6e 2075 732d  aws --region us-
+00004a90: 7765 7374 2d32 2022 6c73 207e 2227 2c0a  west-2 "ls ~"',.
+00004aa0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00004ab0: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
+00004ac0: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
+00004ad0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00004ae0: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
+00004af0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004b00: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00004b10: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
+00004b20: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004b30: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
+00004b40: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00004b50: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00004b60: 6e61 6d65 7d20 3720 2d2d 7374 6174 7573  name} 7 --status
+00004b70: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00004b80: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00004b90: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00004ba0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00004bb0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00004bc0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00004bd0: 2074 6573 745f 6763 705f 696d 6167 655f   test_gcp_image_
+00004be0: 6964 5f64 6963 745f 7a6f 6e65 2829 3a0a  id_dict_zone():.
+00004bf0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00004c00: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00004c10: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00004c20: 2020 2020 2020 2020 2767 6370 5f69 6d61          'gcp_ima
+00004c30: 6765 5f69 645f 6469 6374 5f7a 6f6e 6527  ge_id_dict_zone'
+00004c40: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00004c50: 2020 2020 2020 2020 2320 5573 6520 7a6f          # Use zo
+00004c60: 6e65 2074 6f20 6669 6c74 6572 2069 6d61  ne to filter ima
+00004c70: 6765 5f69 6420 6469 6374 2e0a 2020 2020  ge_id dict..    
+00004c80: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00004c90: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00004ca0: 7d20 2d2d 7a6f 6e65 2075 732d 6561 7374  } --zone us-east
+00004cb0: 312d 6120 7465 7374 732f 7465 7374 5f79  1-a tests/test_y
+00004cc0: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
+00004cd0: 696f 6e5f 696d 6167 6573 2e79 616d 6c20  ion_images.yaml 
+00004ce0: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00004cf0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00004d00: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+00004d10: 7265 7020 7b6e 616d 657d 2026 2620 6578  rep {name} && ex
+00004d20: 6974 2031 207c 7c20 7472 7565 272c 2020  it 1 || true',  
+00004d30: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+00004d40: 7374 6572 2069 7320 6e6f 7420 6372 6561  ster is not crea
+00004d50: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+00004d60: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00004d70: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
+00004d80: 6520 7573 2d63 656e 7472 616c 312d 6120  e us-central1-a 
+00004d90: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00004da0: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
+00004db0: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+00004dc0: 2020 2020 2020 2020 2020 2320 5368 6f75            # Shou
+00004dd0: 6c64 2073 7563 6365 7373 2062 6563 6175  ld success becau
+00004de0: 7365 2074 6865 2069 6d61 6765 2069 6420  se the image id 
+00004df0: 6d61 7463 6820 666f 7220 7468 6520 7a6f  match for the zo
+00004e00: 6e65 2e0a 2020 2020 2020 2020 2020 2020  ne..            
+00004e10: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00004e20: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00004e30: 6420 6763 7020 2d2d 696d 6167 652d 6964  d gcp --image-id
+00004e40: 2073 6b79 7069 6c6f 743a 6370 752d 6465   skypilot:cpu-de
+00004e50: 6269 616e 2d31 3020 7465 7374 732f 7465  bian-10 tests/te
+00004e60: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+00004e70: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00004e80: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00004e90: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+00004ea0: 7020 2d2d 696d 6167 652d 6964 2073 6b79  p --image-id sky
+00004eb0: 7069 6c6f 743a 6370 752d 6465 6269 616e  pilot:cpu-debian
+00004ec0: 2d31 3020 7465 7374 732f 7465 7374 5f79  -10 tests/test_y
+00004ed0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00004ee0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00004ef0: 2320 4661 696c 2064 7565 2074 6f20 696d  # Fail due to im
+00004f00: 6167 6520 6964 206d 6973 6d61 7463 682e  age id mismatch.
+00004f10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004f20: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00004f30: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
+00004f40: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
+00004f50: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
+00004f60: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00004f70: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
+00004f80: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00004f90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004fa0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00004fb0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00004fc0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00004fd0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+00004fe0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00004ff0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005000: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
+00005010: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005020: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
+00005030: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00005040: 7265 7020 7573 2d63 656e 7472 616c 3127  rep us-central1'
+00005050: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00005060: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
+00005070: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00005080: 6e73 7572 6520 6578 6563 2077 6f72 6b73  nsure exec works
+00005090: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+000050a0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000050b0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+000050c0: 6e65 2075 732d 6365 6e74 7261 6c31 2d61  ne us-central1-a
+000050d0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+000050e0: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
+000050f0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
+00005100: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005110: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
+00005120: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
+00005130: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
+00005140: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00005150: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005160: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00005170: 2067 6370 202d 2d72 6567 696f 6e20 7573   gcp --region us
+00005180: 2d63 656e 7472 616c 3120 226c 7320 7e22  -central1 "ls ~"
+00005190: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000051a0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000051b0: 2022 6c73 207e 2227 2c0a 2020 2020 2020   "ls ~"',.      
+000051c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000051d0: 207b 6e61 6d65 7d20 3420 2d2d 7374 6174   {name} 4 --stat
+000051e0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+000051f0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005200: 657d 2035 202d 2d73 7461 7475 7327 2c0a  e} 5 --status',.
+00005210: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005220: 7920 6c6f 6773 207b 6e61 6d65 7d20 3620  y logs {name} 6 
+00005230: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00005240: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00005250: 7320 7b6e 616d 657d 2037 202d 2d73 7461  s {name} 7 --sta
+00005260: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
+00005270: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00005280: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00005290: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000052a0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000052b0: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+000052c0: 6465 6620 7465 7374 5f63 6c6f 6e65 5f64  def test_clone_d
+000052d0: 6973 6b5f 6177 7328 293a 0a20 2020 206e  isk_aws():.    n
+000052e0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+000052f0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00005300: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00005310: 2020 2027 636c 6f6e 655f 6469 736b 5f61     'clone_disk_a
+00005320: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
+00005330: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005340: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00005350: 616d 657d 202d 2d63 6c6f 7564 2061 7773  ame} --cloud aws
+00005360: 202d 2d72 6567 696f 6e20 7573 2d65 6173   --region us-eas
+00005370: 742d 3220 2d2d 7265 7472 792d 756e 7469  t-2 --retry-unti
+00005380: 6c2d 7570 2022 6563 686f 2068 656c 6c6f  l-up "echo hello
+00005390: 203e 207e 2f75 7365 725f 6669 6c65 2e74   > ~/user_file.t
+000053a0: 7874 2227 2c0a 2020 2020 2020 2020 2020  xt"',.          
+000053b0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000053c0: 2d63 6c6f 6e65 2d64 6973 6b2d 6672 6f6d  -clone-disk-from
+000053d0: 207b 6e61 6d65 7d20 2d79 202d 6320 7b6e   {name} -y -c {n
+000053e0: 616d 657d 2d63 6c6f 6e65 2026 2620 6578  ame}-clone && ex
+000053f0: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00005400: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005410: 2073 746f 7020 7b6e 616d 657d 202d 7927   stop {name} -y'
+00005420: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00005430: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+00005440: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00005450: 6368 202d 2d63 6c6f 6e65 2d64 6973 6b2d  ch --clone-disk-
+00005460: 6672 6f6d 207b 6e61 6d65 7d20 2d79 202d  from {name} -y -
+00005470: 6320 7b6e 616d 657d 2d63 6c6f 6e65 202d  c {name}-clone -
+00005480: 2d63 6c6f 7564 2061 7773 202d 6420 2d2d  -cloud aws -d --
+00005490: 7265 6769 6f6e 2075 732d 7765 7374 2d32  region us-west-2
+000054a0: 2022 6361 7420 7e2f 7573 6572 5f66 696c   "cat ~/user_fil
+000054b0: 652e 7478 7420 7c20 6772 6570 2068 656c  e.txt | grep hel
+000054c0: 6c6f 2227 2c0a 2020 2020 2020 2020 2020  lo"',.          
+000054d0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000054e0: 2d63 6c6f 6e65 2d64 6973 6b2d 6672 6f6d  -clone-disk-from
+000054f0: 207b 6e61 6d65 7d20 2d79 202d 6320 7b6e   {name} -y -c {n
+00005500: 616d 657d 2d63 6c6f 6e65 2d32 202d 2d63  ame}-clone-2 --c
+00005510: 6c6f 7564 2061 7773 202d 6420 2d2d 7265  loud aws -d --re
+00005520: 6769 6f6e 2075 732d 6561 7374 2d32 2022  gion us-east-2 "
+00005530: 6361 7420 7e2f 7573 6572 5f66 696c 652e  cat ~/user_file.
+00005540: 7478 7420 7c20 6772 6570 2068 656c 6c6f  txt | grep hello
+00005550: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00005560: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00005570: 7d2d 636c 6f6e 6520 3120 2d2d 7374 6174  }-clone 1 --stat
+00005580: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00005590: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+000055a0: 657d 2d63 6c6f 6e65 2d32 2031 202d 2d73  e}-clone-2 1 --s
+000055b0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+000055c0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000055d0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d20   down -y {name} 
+000055e0: 7b6e 616d 657d 2d63 6c6f 6e65 207b 6e61  {name}-clone {na
+000055f0: 6d65 7d2d 636c 6f6e 652d 3227 2c0a 2020  me}-clone-2',.  
+00005600: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
+00005610: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00005620: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00005630: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00005640: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+00005650: 636c 6f6e 655f 6469 736b 5f67 6370 2829  clone_disk_gcp()
+00005660: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00005670: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00005680: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00005690: 280a 2020 2020 2020 2020 2763 6c6f 6e65  (.        'clone
+000056a0: 5f64 6973 6b5f 6763 7027 2c0a 2020 2020  _disk_gcp',.    
+000056b0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+000056c0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000056d0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+000056e0: 6f75 6420 6763 7020 2d2d 7a6f 6e65 2075  oud gcp --zone u
+000056f0: 732d 6561 7374 312d 6220 2d2d 7265 7472  s-east1-b --retr
+00005700: 792d 756e 7469 6c2d 7570 2022 6563 686f  y-until-up "echo
+00005710: 2068 656c 6c6f 203e 207e 2f75 7365 725f   hello > ~/user_
+00005720: 6669 6c65 2e74 7874 2227 2c0a 2020 2020  file.txt"',.    
+00005730: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00005740: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
+00005750: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
+00005760: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
+00005770: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
+00005780: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
+00005790: 2066 2773 6b79 2073 746f 7020 7b6e 616d   f'sky stop {nam
+000057a0: 657d 202d 7927 2c0a 2020 2020 2020 2020  e} -y',.        
+000057b0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000057c0: 202d 2d63 6c6f 6e65 2d64 6973 6b2d 6672   --clone-disk-fr
+000057d0: 6f6d 207b 6e61 6d65 7d20 2d79 202d 6320  om {name} -y -c 
+000057e0: 7b6e 616d 657d 2d63 6c6f 6e65 202d 2d63  {name}-clone --c
+000057f0: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+00005800: 7573 2d63 656e 7472 616c 312d 6120 2263  us-central1-a "c
+00005810: 6174 207e 2f75 7365 725f 6669 6c65 2e74  at ~/user_file.t
+00005820: 7874 207c 2067 7265 7020 6865 6c6c 6f22  xt | grep hello"
+00005830: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005840: 2773 6b79 206c 6175 6e63 6820 2d2d 636c  'sky launch --cl
+00005850: 6f6e 652d 6469 736b 2d66 726f 6d20 7b6e  one-disk-from {n
+00005860: 616d 657d 202d 7920 2d63 207b 6e61 6d65  ame} -y -c {name
+00005870: 7d2d 636c 6f6e 652d 3220 2d2d 636c 6f75  }-clone-2 --clou
+00005880: 6420 6763 7020 2d2d 7a6f 6e65 2075 732d  d gcp --zone us-
+00005890: 6561 7374 312d 6220 2263 6174 207e 2f75  east1-b "cat ~/u
+000058a0: 7365 725f 6669 6c65 2e74 7874 207c 2067  ser_file.txt | g
+000058b0: 7265 7020 6865 6c6c 6f22 272c 0a20 2020  rep hello"',.   
+000058c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000058d0: 6f67 7320 7b6e 616d 657d 2d63 6c6f 6e65  ogs {name}-clone
+000058e0: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+000058f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005900: 6c6f 6773 207b 6e61 6d65 7d2d 636c 6f6e  logs {name}-clon
+00005910: 652d 3220 3120 2d2d 7374 6174 7573 272c  e-2 1 --status',
+00005920: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00005930: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00005940: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
+00005950: 636c 6f6e 6520 7b6e 616d 657d 2d63 6c6f  clone {name}-clo
+00005960: 6e65 2d32 272c 0a20 2020 2029 0a20 2020  ne-2',.    ).   
+00005970: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00005980: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00005990: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+000059a0: 696d 6167 655f 6e6f 5f63 6f6e 6461 2829  image_no_conda()
+000059b0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000059c0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000059d0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000059e0: 280a 2020 2020 2020 2020 2769 6d61 6765  (.        'image
+000059f0: 5f6e 6f5f 636f 6e64 6127 2c0a 2020 2020  _no_conda',.    
+00005a00: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00005a10: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
+00005a20: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
+00005a30: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00005a40: 2d79 202d 6320 7b6e 616d 657d 202d 2d72  -y -c {name} --r
+00005a50: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
+00005a60: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+00005a70: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00005a80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005a90: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005aa0: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+00005ab0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00005ac0: 746f 7020 7b6e 616d 657d 202d 7927 2c0a  top {name} -y',.
+00005ad0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005ae0: 7920 7374 6172 7420 7b6e 616d 657d 202d  y start {name} -
+00005af0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00005b00: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00005b10: 7d20 6578 616d 706c 6573 2f70 6572 5f72  } examples/per_r
+00005b20: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
+00005b30: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00005b40: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00005b50: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00005b60: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00005b70: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00005b80: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00005b90: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00005ba0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00005bb0: 2d2d 2d2d 2d2d 2054 6573 7420 7374 616c  ------ Test stal
+00005bc0: 6520 6a6f 6220 2d2d 2d2d 2d2d 2d2d 2d2d  e job ----------
+00005bd0: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00005be0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00005bf0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00005c00: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00005c10: 2073 746f 7070 696e 6720 696e 7374 616e   stopping instan
+00005c20: 6365 730a 6465 6620 7465 7374 5f73 7461  ces.def test_sta
+00005c30: 6c65 5f6a 6f62 2867 656e 6572 6963 5f63  le_job(generic_c
+00005c40: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00005c50: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00005c60: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00005c70: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00005c80: 2020 2020 2773 7461 6c65 5f6a 6f62 272c      'stale_job',
+00005c90: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00005ca0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00005cb0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00005cc0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00005cd0: 635f 636c 6f75 647d 2022 6563 686f 2068  c_cloud} "echo h
+00005ce0: 6922 272c 0a20 2020 2020 2020 2020 2020  i"',.           
+00005cf0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00005d00: 657d 202d 6420 2265 6368 6f20 7374 6172  e} -d "echo star
+00005d10: 743b 2073 6c65 6570 2031 3030 3030 2227  t; sleep 10000"'
+00005d20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005d30: 736b 7920 7374 6f70 207b 6e61 6d65 7d20  sky stop {name} 
+00005d40: 2d79 272c 0a20 2020 2020 2020 2020 2020  -y',.           
+00005d50: 2027 736c 6565 7020 3130 3027 2c20 2023   'sleep 100',  #
+00005d60: 2045 6e73 7572 6520 7468 6973 2069 7320   Ensure this is 
+00005d70: 6c61 7267 6520 656e 6f75 6768 2c20 656c  large enough, el
+00005d80: 7365 2047 4350 206c 6561 6b73 2e0a 2020  se GCP leaks..  
+00005d90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005da0: 7374 6172 7420 7b6e 616d 657d 202d 7927  start {name} -y'
+00005db0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005dc0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005dd0: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+00005de0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00005df0: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+00005e00: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+00005e10: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+00005e20: 7322 207c 2067 7265 7020 4641 494c 4544  s" | grep FAILED
+00005e30: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00005e40: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00005e50: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00005e60: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00005e70: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00005e80: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
+00005e90: 2074 6573 745f 6177 735f 7374 616c 655f   test_aws_stale_
+00005ea0: 6a6f 625f 6d61 6e75 616c 5f72 6573 7461  job_manual_resta
+00005eb0: 7274 2829 3a0a 2020 2020 6e61 6d65 203d  rt():.    name =
+00005ec0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00005ed0: 6d65 2829 0a20 2020 2072 6567 696f 6e20  me().    region 
+00005ee0: 3d20 2775 732d 7765 7374 2d32 270a 2020  = 'us-west-2'.  
+00005ef0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00005f00: 2020 2020 2020 2027 6177 735f 7374 616c         'aws_stal
+00005f10: 655f 6a6f 625f 6d61 6e75 616c 5f72 6573  e_job_manual_res
+00005f20: 7461 7274 272c 0a20 2020 2020 2020 205b  tart',.        [
+00005f30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005f40: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00005f50: 7b6e 616d 657d 202d 2d63 6c6f 7564 2061  {name} --cloud a
+00005f60: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+00005f70: 696f 6e7d 2022 6563 686f 2068 6922 272c  ion} "echo hi"',
+00005f80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005f90: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00005fa0: 6420 2265 6368 6f20 7374 6172 743b 2073  d "echo start; s
+00005fb0: 6c65 6570 2031 3030 3030 2227 2c0a 2020  leep 10000"',.  
+00005fc0: 2020 2020 2020 2020 2020 2320 5374 6f70            # Stop
+00005fd0: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+00005fe0: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00005ff0: 2020 2066 2769 643d 6061 7773 2065 6332     f'id=`aws ec2
+00006000: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
+00006010: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
+00006020: 6769 6f6e 7d20 2d2d 6669 6c74 6572 7320  gion} --filters 
+00006030: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00006040: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
+00006050: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+00006060: 3d7b 6e61 6d65 7d20 270a 2020 2020 2020  ={name} '.      
+00006070: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
+00006080: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
+00006090: 6e73 7461 6e63 6573 5b5d 2e49 6e73 7461  nstances[].Insta
+000060a0: 6e63 6549 6420 270a 2020 2020 2020 2020  nceId '.        
+000060b0: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
+000060c0: 7874 603b 2027 0a20 2020 2020 2020 2020  xt`; '.         
+000060d0: 2020 2066 2761 7773 2065 6332 2073 746f     f'aws ec2 sto
+000060e0: 702d 696e 7374 616e 6365 7320 2d2d 7265  p-instances --re
+000060f0: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+00006100: 2020 2020 2020 2020 2020 2020 272d 2d69              '--i
+00006110: 6e73 7461 6e63 652d 6964 7320 2469 6427  nstance-ids $id'
+00006120: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00006130: 6c65 6570 2034 3027 2c0a 2020 2020 2020  leep 40',.      
+00006140: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00006150: 6368 202d 6320 7b6e 616d 657d 202d 7920  ch -c {name} -y 
+00006160: 2265 6368 6f20 6869 2227 2c0a 2020 2020  "echo hi"',.    
+00006170: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00006180: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00006190: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+000061a0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000061b0: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+000061c0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000061d0: 456e 7375 7265 2074 6865 2073 6b79 6c65  Ensure the skyle
+000061e0: 7420 7570 6461 7465 6420 7468 6520 7374  t updated the st
+000061f0: 616c 6520 6a6f 6220 7374 6174 7573 2e0a  ale job status..
+00006200: 2020 2020 2020 2020 2020 2020 6627 736c              f'sl
+00006210: 6565 7020 7b65 7665 6e74 732e 4a6f 6253  eep {events.JobS
+00006220: 6368 6564 756c 6572 4576 656e 742e 4556  chedulerEvent.EV
+00006230: 454e 545f 494e 5445 5256 414c 5f53 4543  ENT_INTERVAL_SEC
+00006240: 4f4e 4453 7d27 2c0a 2020 2020 2020 2020  ONDS}',.        
+00006250: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+00006260: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+00006270: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+00006280: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+00006290: 6772 6570 2046 4149 4c45 4427 2c0a 2020  grep FAILED',.  
+000062a0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000062b0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+000062c0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+000062d0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000062e0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000062f0: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00006300: 5f67 6370 5f73 7461 6c65 5f6a 6f62 5f6d  _gcp_stale_job_m
+00006310: 616e 7561 6c5f 7265 7374 6172 7428 293a  anual_restart():
+00006320: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00006330: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00006340: 2020 2020 7a6f 6e65 203d 2027 7573 2d77      zone = 'us-w
+00006350: 6573 7432 2d61 270a 2020 2020 7175 6572  est2-a'.    quer
+00006360: 795f 636d 6420 3d20 2866 2767 636c 6f75  y_cmd = (f'gclou
+00006370: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00006380: 6365 7320 6c69 7374 202d 2d66 696c 7465  ces list --filte
+00006390: 723d 270a 2020 2020 2020 2020 2020 2020  r='.            
+000063a0: 2020 2020 2066 2722 286c 6162 656c 732e       f'"(labels.
+000063b0: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+000063c0: 3d7b 6e61 6d65 7d29 2220 270a 2020 2020  ={name})" '.    
+000063d0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+000063e0: 2d7a 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d  -zones={zone} --
+000063f0: 666f 726d 6174 3d22 7661 6c75 6528 6e61  format="value(na
+00006400: 6d65 2922 2729 0a20 2020 2073 746f 705f  me)"').    stop_
+00006410: 636d 6420 3d20 2866 2767 636c 6f75 6420  cmd = (f'gcloud 
+00006420: 636f 6d70 7574 6520 696e 7374 616e 6365  compute instance
+00006430: 7320 7374 6f70 202d 2d7a 6f6e 653d 7b7a  s stop --zone={z
+00006440: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
+00006450: 2020 2020 2020 6627 202d 2d71 7569 6574        f' --quiet
+00006460: 2024 287b 7175 6572 795f 636d 647d 2927   $({query_cmd})'
+00006470: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00006480: 7428 0a20 2020 2020 2020 2027 6763 705f  t(.        'gcp_
+00006490: 7374 616c 655f 6a6f 625f 6d61 6e75 616c  stale_job_manual
+000064a0: 5f72 6573 7461 7274 272c 0a20 2020 2020  _restart',.     
+000064b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000064c0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000064d0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+000064e0: 7564 2067 6370 202d 2d7a 6f6e 6520 7b7a  ud gcp --zone {z
+000064f0: 6f6e 657d 2022 6563 686f 2068 6922 272c  one} "echo hi"',
+00006500: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006510: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00006520: 6420 2265 6368 6f20 7374 6172 743b 2073  d "echo start; s
+00006530: 6c65 6570 2031 3030 3030 2227 2c0a 2020  leep 10000"',.  
+00006540: 2020 2020 2020 2020 2020 2320 5374 6f70            # Stop
+00006550: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
+00006560: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
+00006570: 2020 2073 746f 705f 636d 642c 0a20 2020     stop_cmd,.   
+00006580: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00006590: 3430 272c 0a20 2020 2020 2020 2020 2020  40',.           
+000065a0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+000065b0: 207b 6e61 6d65 7d20 2d79 2022 6563 686f   {name} -y "echo
+000065c0: 2068 6922 272c 0a20 2020 2020 2020 2020   hi"',.         
+000065d0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000065e0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+000065f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00006600: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00006610: 3320 2d2d 7374 6174 7573 272c 0a20 2020  3 --status',.   
+00006620: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00006630: 6520 7468 6520 736b 796c 6574 2075 7064  e the skylet upd
+00006640: 6174 6564 2074 6865 2073 7461 6c65 206a  ated the stale j
+00006650: 6f62 2073 7461 7475 732e 0a20 2020 2020  ob status..     
+00006660: 2020 2020 2020 2066 2773 6c65 6570 207b         f'sleep {
+00006670: 6576 656e 7473 2e4a 6f62 5363 6865 6475  events.JobSchedu
+00006680: 6c65 7245 7665 6e74 2e45 5645 4e54 5f49  lerEvent.EVENT_I
+00006690: 4e54 4552 5641 4c5f 5345 434f 4e44 537d  NTERVAL_SECONDS}
+000066a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000066b0: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+000066c0: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+000066d0: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+000066e0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+000066f0: 4641 494c 4544 272c 0a20 2020 2020 2020  FAILED',.       
+00006700: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00006710: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00006720: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00006730: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00006740: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2043  ..# ---------- C
+00006750: 6865 636b 2053 6b79 2773 2065 6e76 6972  heck Sky's envir
+00006760: 6f6e 6d65 6e74 2076 6172 6961 626c 6573  onment variables
+00006770: 3b20 776f 726b 6469 722e 202d 2d2d 2d2d  ; workdir. -----
+00006780: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00006790: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+000067a0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+000067b0: 7420 6e75 6d5f 6e6f 6465 7320 3e20 3120  t num_nodes > 1 
+000067c0: 7965 740a 6465 6620 7465 7374 5f65 6e76  yet.def test_env
+000067d0: 5f63 6865 636b 2867 656e 6572 6963 5f63  _check(generic_c
+000067e0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+000067f0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00006800: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00006810: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00006820: 2020 2020 2765 6e76 5f63 6865 636b 272c      'env_check',
+00006830: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00006840: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00006850: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00006860: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00006870: 635f 636c 6f75 647d 202d 2d64 6574 6163  c_cloud} --detac
+00006880: 682d 7365 7475 7020 6578 616d 706c 6573  h-setup examples
+00006890: 2f65 6e76 5f63 6865 636b 2e79 616d 6c27  /env_check.yaml'
+000068a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000068b0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000068c0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+000068d0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+000068e0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+000068f0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00006900: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00006910: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00006920: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00006930: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00006940: 6669 6c65 5f6d 6f75 6e74 7320 2d2d 2d2d  file_mounts ----
+00006950: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00006960: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+00006970: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+00006980: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
+00006990: 2079 6574 2e20 5275 6e20 7465 7374 5f73   yet. Run test_s
+000069a0: 6370 5f66 696c 655f 6d6f 756e 7473 2069  cp_file_mounts i
+000069b0: 6e73 7465 6164 2e0a 6465 6620 7465 7374  nstead..def test
+000069c0: 5f66 696c 655f 6d6f 756e 7473 2867 656e  _file_mounts(gen
+000069d0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+000069e0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000069f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00006a00: 0a20 2020 2074 6573 745f 636f 6d6d 616e  .    test_comman
+00006a10: 6473 203d 205b 0a20 2020 2020 2020 202a  ds = [.        *
+00006a20: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+00006a30: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+00006a40: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00006a50: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00006a60: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00006a70: 7d20 6578 616d 706c 6573 2f75 7369 6e67  } examples/using
+00006a80: 5f66 696c 655f 6d6f 756e 7473 2e79 616d  _file_mounts.yam
+00006a90: 6c27 2c0a 2020 2020 2020 2020 6627 736b  l',.        f'sk
+00006aa0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00006ab0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00006ac0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00006ad0: 6365 6564 6564 2e0a 2020 2020 5d0a 2020  ceeded..    ].  
+00006ae0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00006af0: 2020 2020 2020 2027 7573 696e 675f 6669         'using_fi
+00006b00: 6c65 5f6d 6f75 6e74 7327 2c0a 2020 2020  le_mounts',.    
+00006b10: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+00006b20: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
+00006b30: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00006b40: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00006b50: 743d 3230 202a 2036 302c 2020 2320 3230  t=20 * 60,  # 20
+00006b60: 206d 696e 730a 2020 2020 290a 2020 2020   mins.    ).    
+00006b70: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00006b80: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00006b90: 6b2e 7363 700a 6465 6620 7465 7374 5f73  k.scp.def test_s
+00006ba0: 6370 5f66 696c 655f 6d6f 756e 7473 2829  cp_file_mounts()
+00006bb0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00006bc0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00006bd0: 0a20 2020 2074 6573 745f 636f 6d6d 616e  .    test_comman
+00006be0: 6473 203d 205b 0a20 2020 2020 2020 202a  ds = [.        *
+00006bf0: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+00006c00: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+00006c10: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00006c20: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
+00006c30: 5950 457d 202d 2d6e 756d 2d6e 6f64 6573  YPE} --num-nodes
+00006c40: 2031 2065 7861 6d70 6c65 732f 7573 696e   1 examples/usin
+00006c50: 675f 6669 6c65 5f6d 6f75 6e74 732e 7961  g_file_mounts.ya
+00006c60: 6d6c 272c 0a20 2020 2020 2020 2066 2773  ml',.        f's
+00006c70: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00006c80: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00006c90: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00006ca0: 6363 6565 6465 642e 0a20 2020 205d 0a20  cceeded..    ]. 
+00006cb0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00006cc0: 2020 2020 2020 2020 2753 4350 5f75 7369          'SCP_usi
+00006cd0: 6e67 5f66 696c 655f 6d6f 756e 7473 272c  ng_file_mounts',
+00006ce0: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
+00006cf0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+00006d00: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00006d10: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00006d20: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
+00006d30: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
+00006d40: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00006d50: 7428 7465 7374 290a 0a0a 6465 6620 7465  t(test)...def te
+00006d60: 7374 5f75 7369 6e67 5f66 696c 655f 6d6f  st_using_file_mo
+00006d70: 756e 7473 5f77 6974 685f 656e 765f 7661  unts_with_env_va
+00006d80: 7273 2867 656e 6572 6963 5f63 6c6f 7564  rs(generic_cloud
+00006d90: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00006da0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00006db0: 6e61 6d65 2829 0a20 2020 2074 6573 745f  name().    test_
+00006dc0: 636f 6d6d 616e 6473 203d 205b 0a20 2020  commands = [.   
+00006dd0: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
+00006de0: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
+00006df0: 2020 2020 2020 2866 2773 6b79 206c 6175        (f'sky lau
+00006e00: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00006e10: 202d 2d63 7075 7320 322b 202d 2d63 6c6f   --cpus 2+ --clo
+00006e20: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00006e30: 647d 2027 0a20 2020 2020 2020 2020 2765  d} '.         'e
+00006e40: 7861 6d70 6c65 732f 7573 696e 675f 6669  xamples/using_fi
+00006e50: 6c65 5f6d 6f75 6e74 735f 7769 7468 5f65  le_mounts_with_e
+00006e60: 6e76 5f76 6172 732e 7961 6d6c 2729 2c0a  nv_vars.yaml'),.
+00006e70: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00006e80: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00006e90: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00006ea0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00006eb0: 6564 2e0a 2020 2020 2020 2020 2320 4f76  ed..        # Ov
+00006ec0: 6572 7269 6465 2077 6974 6820 2d2d 656e  erride with --en
+00006ed0: 763a 0a20 2020 2020 2020 2028 6627 736b  v:.        (f'sk
+00006ee0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00006ef0: 6e61 6d65 7d2d 3220 2d2d 6370 7573 2032  name}-2 --cpus 2
+00006f00: 2b20 2d2d 636c 6f75 6420 7b67 656e 6572  + --cloud {gener
+00006f10: 6963 5f63 6c6f 7564 7d20 270a 2020 2020  ic_cloud} '.    
+00006f20: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
+00006f30: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+00006f40: 5f77 6974 685f 656e 765f 7661 7273 2e79  _with_env_vars.y
+00006f50: 616d 6c20 270a 2020 2020 2020 2020 2027  aml '.         '
+00006f60: 2d2d 656e 7620 4d59 5f4c 4f43 414c 5f50  --env MY_LOCAL_P
+00006f70: 4154 483d 746d 7066 696c 6527 292c 0a20  ATH=tmpfile'),. 
+00006f80: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006f90: 7320 7b6e 616d 657d 2d32 2031 202d 2d73  s {name}-2 1 --s
+00006fa0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00006fb0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00006fc0: 6465 642e 0a20 2020 205d 0a20 2020 2074  ded..    ].    t
+00006fd0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00006fe0: 2020 2020 2775 7369 6e67 5f66 696c 655f      'using_file_
+00006ff0: 6d6f 756e 7473 5f77 6974 685f 656e 765f  mounts_with_env_
+00007000: 7661 7273 272c 0a20 2020 2020 2020 2074  vars',.        t
+00007010: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
+00007020: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00007030: 202d 7920 7b6e 616d 657d 207b 6e61 6d65   -y {name} {name
+00007040: 7d2d 3227 2c0a 2020 2020 2020 2020 7469  }-2',.        ti
+00007050: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
+00007060: 2320 3230 206d 696e 730a 2020 2020 290a  # 20 mins.    ).
+00007070: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00007080: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+00007090: 2d2d 2d2d 2d20 7374 6f72 6167 6520 2d2d  ----- storage --
+000070a0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+000070b0: 2e6d 6172 6b2e 6177 730a 6465 6620 7465  .mark.aws.def te
+000070c0: 7374 5f61 7773 5f73 746f 7261 6765 5f6d  st_aws_storage_m
+000070d0: 6f75 6e74 7328 293a 0a20 2020 206e 616d  ounts():.    nam
+000070e0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000070f0: 5f6e 616d 6528 290a 2020 2020 7374 6f72  _name().    stor
+00007100: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+00007110: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+00007120: 7469 6d65 2829 297d 270a 2020 2020 7465  time())}'.    te
+00007130: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
+00007140: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
+00007150: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
+00007160: 616d 6c73 2f74 6573 745f 7374 6f72 6167  amls/test_storag
+00007170: 655f 6d6f 756e 7469 6e67 2e79 616d 6c27  e_mounting.yaml'
+00007180: 292e 7265 6164 5f74 6578 7428 290a 2020  ).read_text().  
+00007190: 2020 7465 6d70 6c61 7465 203d 206a 696e    template = jin
+000071a0: 6a61 322e 5465 6d70 6c61 7465 2874 656d  ja2.Template(tem
+000071b0: 706c 6174 655f 7374 7229 0a20 2020 2063  plate_str).    c
+000071c0: 6f6e 7465 6e74 203d 2074 656d 706c 6174  ontent = templat
+000071d0: 652e 7265 6e64 6572 2873 746f 7261 6765  e.render(storage
+000071e0: 5f6e 616d 653d 7374 6f72 6167 655f 6e61  _name=storage_na
+000071f0: 6d65 290a 2020 2020 7769 7468 2074 656d  me).    with tem
+00007200: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
+00007210: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
+00007220: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
+00007230: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+00007240: 2066 2e77 7269 7465 2863 6f6e 7465 6e74   f.write(content
+00007250: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
+00007260: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
+00007270: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
+00007280: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
+00007290: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
+000072a0: 2020 2020 202a 7374 6f72 6167 655f 7365       *storage_se
+000072b0: 7475 705f 636f 6d6d 616e 6473 2c0a 2020  tup_commands,.  
+000072c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000072d0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000072e0: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
+000072f0: 7b66 696c 655f 7061 7468 7d27 2c0a 2020  {file_path}',.  
+00007300: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00007310: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00007320: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00007330: 7265 206a 6f62 2073 7563 6365 6564 6564  re job succeeded
+00007340: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00007350: 6177 7320 7333 206c 7320 7b73 746f 7261  aws s3 ls {stora
+00007360: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
+00007370: 7874 272c 0a20 2020 2020 2020 205d 0a20  xt',.        ]. 
+00007380: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
+00007390: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+000073a0: 2761 7773 5f73 746f 7261 6765 5f6d 6f75  'aws_storage_mou
+000073b0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
+000073c0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
+000073d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000073e0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+000073f0: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
+00007400: 656c 6574 6520 7b73 746f 7261 6765 5f6e  elete {storage_n
+00007410: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00007420: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00007430: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
+00007440: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00007450: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00007460: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00007470: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
+00007480: 6763 705f 7374 6f72 6167 655f 6d6f 756e  gcp_storage_moun
+00007490: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
+000074a0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000074b0: 6d65 2829 0a20 2020 2073 746f 7261 6765  me().    storage
+000074c0: 5f6e 616d 6520 3d20 6627 736b 792d 7465  _name = f'sky-te
+000074d0: 7374 2d7b 696e 7428 7469 6d65 2e74 696d  st-{int(time.tim
+000074e0: 6528 2929 7d27 0a20 2020 2074 656d 706c  e())}'.    templ
+000074f0: 6174 655f 7374 7220 3d20 7061 7468 6c69  ate_str = pathli
+00007500: 622e 5061 7468 280a 2020 2020 2020 2020  b.Path(.        
+00007510: 2774 6573 7473 2f74 6573 745f 7961 6d6c  'tests/test_yaml
+00007520: 732f 7465 7374 5f73 746f 7261 6765 5f6d  s/test_storage_m
+00007530: 6f75 6e74 696e 672e 7961 6d6c 2729 2e72  ounting.yaml').r
+00007540: 6561 645f 7465 7874 2829 0a20 2020 2074  ead_text().    t
+00007550: 656d 706c 6174 6520 3d20 6a69 6e6a 6132  emplate = jinja2
+00007560: 2e54 656d 706c 6174 6528 7465 6d70 6c61  .Template(templa
+00007570: 7465 5f73 7472 290a 2020 2020 636f 6e74  te_str).    cont
+00007580: 656e 7420 3d20 7465 6d70 6c61 7465 2e72  ent = template.r
+00007590: 656e 6465 7228 7374 6f72 6167 655f 6e61  ender(storage_na
+000075a0: 6d65 3d73 746f 7261 6765 5f6e 616d 6529  me=storage_name)
+000075b0: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
+000075c0: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
+000075d0: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
+000075e0: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
+000075f0: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
+00007600: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
+00007610: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
+00007620: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+00007630: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
+00007640: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+00007650: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+00007660: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
+00007670: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+00007680: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00007690: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000076a0: 202d 2d63 6c6f 7564 2067 6370 207b 6669   --cloud gcp {fi
+000076b0: 6c65 5f70 6174 687d 272c 0a20 2020 2020  le_path}',.     
+000076c0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000076d0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+000076e0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+000076f0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00007700: 2020 2020 2020 2020 2020 2066 2767 7375             f'gsu
+00007710: 7469 6c20 6c73 2067 733a 2f2f 7b73 746f  til ls gs://{sto
+00007720: 7261 6765 5f6e 616d 657d 2f68 656c 6c6f  rage_name}/hello
+00007730: 2e74 7874 272c 0a20 2020 2020 2020 205d  .txt',.        ]
+00007740: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
+00007750: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
+00007760: 2020 2767 6370 5f73 746f 7261 6765 5f6d    'gcp_storage_m
+00007770: 6f75 6e74 7327 2c0a 2020 2020 2020 2020  ounts',.        
+00007780: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
+00007790: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
+000077a0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000077b0: 6d65 7d3b 2073 6b79 2073 746f 7261 6765  me}; sky storage
+000077c0: 2064 656c 6574 6520 7b73 746f 7261 6765   delete {storage
+000077d0: 5f6e 616d 657d 272c 0a20 2020 2020 2020  _name}',.       
+000077e0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+000077f0: 2a20 3630 2c20 2023 2032 3020 6d69 6e73  * 60,  # 20 mins
+00007800: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00007810: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00007820: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00007830: 6d61 726b 2e63 6c6f 7564 666c 6172 650a  mark.cloudflare.
+00007840: 6465 6620 7465 7374 5f63 6c6f 7564 666c  def test_cloudfl
+00007850: 6172 655f 7374 6f72 6167 655f 6d6f 756e  are_storage_moun
+00007860: 7473 2867 656e 6572 6963 5f63 6c6f 7564  ts(generic_cloud
+00007870: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00007880: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00007890: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
+000078a0: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
+000078b0: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
+000078c0: 696d 6528 2929 7d27 0a20 2020 2074 656d  ime())}'.    tem
+000078d0: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
+000078e0: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
+000078f0: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
+00007900: 6d6c 732f 7465 7374 5f72 325f 7374 6f72  mls/test_r2_stor
+00007910: 6167 655f 6d6f 756e 7469 6e67 2e79 616d  age_mounting.yam
+00007920: 6c27 292e 7265 6164 5f74 6578 7428 290a  l').read_text().
+00007930: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
+00007940: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
+00007950: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
+00007960: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
+00007970: 6174 652e 7265 6e64 6572 2873 746f 7261  ate.render(stora
+00007980: 6765 5f6e 616d 653d 7374 6f72 6167 655f  ge_name=storage_
+00007990: 6e61 6d65 290a 2020 2020 656e 6470 6f69  name).    endpoi
+000079a0: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
+000079b0: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
+000079c0: 696e 7428 290a 2020 2020 7769 7468 2074  int().    with t
+000079d0: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+000079e0: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+000079f0: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+00007a00: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+00007a10: 2020 2066 2e77 7269 7465 2863 6f6e 7465     f.write(conte
+00007a20: 6e74 290a 2020 2020 2020 2020 662e 666c  nt).        f.fl
+00007a30: 7573 6828 290a 2020 2020 2020 2020 6669  ush().        fi
+00007a40: 6c65 5f70 6174 6820 3d20 662e 6e61 6d65  le_path = f.name
+00007a50: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
+00007a60: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
+00007a70: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
+00007a80: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
+00007a90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00007aa0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00007ab0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00007ac0: 656e 6572 6963 5f63 6c6f 7564 7d20 7b66  eneric_cloud} {f
+00007ad0: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
+00007ae0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00007af0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00007b00: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00007b10: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00007b20: 2020 2020 2020 2020 2020 2020 6627 4157              f'AW
+00007b30: 535f 5348 4152 4544 5f43 5245 4445 4e54  S_SHARED_CREDENT
+00007b40: 4941 4c53 5f46 494c 453d 7b63 6c6f 7564  IALS_FILE={cloud
+00007b50: 666c 6172 652e 5232 5f43 5245 4445 4e54  flare.R2_CREDENT
+00007b60: 4941 4c53 5f50 4154 487d 2061 7773 2073  IALS_PATH} aws s
+00007b70: 3320 6c73 2073 333a 2f2f 7b73 746f 7261  3 ls s3://{stora
+00007b80: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
+00007b90: 7874 202d 2d65 6e64 706f 696e 7420 7b65  xt --endpoint {e
+00007ba0: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+00007bb0: 726f 6669 6c65 3d72 3227 0a20 2020 2020  rofile=r2'.     
+00007bc0: 2020 205d 0a0a 2020 2020 2020 2020 7465     ]..        te
+00007bd0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00007be0: 2020 2020 2020 2027 636c 6f75 6466 6c61         'cloudfla
+00007bf0: 7265 5f73 746f 7261 6765 5f6d 6f75 6e74  re_storage_mount
+00007c00: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00007c10: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
+00007c20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00007c30: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d3b   down -y {name};
+00007c40: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
+00007c50: 6574 6520 7b73 746f 7261 6765 5f6e 616d  ete {storage_nam
+00007c60: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+00007c70: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+00007c80: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
+00007c90: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00007ca0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00007cb0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00007cc0: 2043 4c49 206c 6f67 7320 2d2d 2d2d 2d2d   CLI logs ------
+00007cd0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00007ce0: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00007cf0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00007d00: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+00007d10: 6574 2e20 5275 6e20 7465 7374 5f73 6370  et. Run test_scp
+00007d20: 5f6c 6f67 7320 696e 7374 6561 642e 0a64  _logs instead..d
+00007d30: 6566 2074 6573 745f 636c 695f 6c6f 6773  ef test_cli_logs
+00007d40: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+00007d50: 7374 7229 3a0a 2020 2020 6e61 6d65 203d  str):.    name =
+00007d60: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00007d70: 6d65 2829 0a20 2020 2074 696d 6573 7461  me().    timesta
+00007d80: 6d70 203d 2074 696d 652e 7469 6d65 2829  mp = time.time()
+00007d90: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00007da0: 280a 2020 2020 2020 2020 2763 6c69 5f6c  (.        'cli_l
+00007db0: 6f67 7327 2c0a 2020 2020 2020 2020 5b0a  ogs',.        [.
+00007dc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00007dd0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00007de0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00007df0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+00007e00: 6e75 6d2d 6e6f 6465 7320 3220 2265 6368  num-nodes 2 "ech
+00007e10: 6f20 7b74 696d 6573 7461 6d70 7d20 3122  o {timestamp} 1"
+00007e20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00007e30: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00007e40: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
+00007e50: 707d 2032 2227 2c0a 2020 2020 2020 2020  p} 2"',.        
+00007e60: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00007e70: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
+00007e80: 6573 7461 6d70 7d20 3322 272c 0a20 2020  estamp} 3"',.   
+00007e90: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00007ea0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
+00007eb0: 207b 7469 6d65 7374 616d 707d 2034 2227   {timestamp} 4"'
+00007ec0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00007ed0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00007ee0: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00007ef0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00007f00: 6f67 7320 7b6e 616d 657d 2033 2034 202d  ogs {name} 3 4 -
+00007f10: 2d73 796e 632d 646f 776e 272c 0a20 2020  -sync-down',.   
+00007f20: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00007f30: 6f67 7320 7b6e 616d 657d 202a 202d 2d73  ogs {name} * --s
+00007f40: 796e 632d 646f 776e 272c 0a20 2020 2020  ync-down',.     
+00007f50: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00007f60: 7320 7b6e 616d 657d 2031 207c 2067 7265  s {name} 1 | gre
+00007f70: 7020 227b 7469 6d65 7374 616d 707d 2031  p "{timestamp} 1
+00007f80: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00007f90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00007fa0: 7d20 7c20 6772 6570 2022 7b74 696d 6573  } | grep "{times
+00007fb0: 7461 6d70 7d20 3422 272c 0a20 2020 2020  tamp} 4"',.     
+00007fc0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00007fd0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00007fe0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00007ff0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00008000: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00008010: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
+00008020: 705f 6c6f 6773 2829 3a0a 2020 2020 6e61  p_logs():.    na
+00008030: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00008040: 725f 6e61 6d65 2829 0a20 2020 2074 696d  r_name().    tim
+00008050: 6573 7461 6d70 203d 2074 696d 652e 7469  estamp = time.ti
+00008060: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00008070: 5465 7374 280a 2020 2020 2020 2020 2753  Test(.        'S
+00008080: 4350 5f63 6c69 5f6c 6f67 7327 2c0a 2020  CP_cli_logs',.  
+00008090: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000080a0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000080b0: 202d 7920 2d63 207b 6e61 6d65 7d20 7b53   -y -c {name} {S
+000080c0: 4350 5f54 5950 457d 2022 6563 686f 207b  CP_TYPE} "echo {
+000080d0: 7469 6d65 7374 616d 707d 2031 2227 2c0a  timestamp} 1"',.
+000080e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000080f0: 7920 6578 6563 207b 6e61 6d65 7d20 2265  y exec {name} "e
+00008100: 6368 6f20 7b74 696d 6573 7461 6d70 7d20  cho {timestamp} 
+00008110: 3222 272c 0a20 2020 2020 2020 2020 2020  2"',.           
+00008120: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00008130: 657d 2022 6563 686f 207b 7469 6d65 7374  e} "echo {timest
+00008140: 616d 707d 2033 2227 2c0a 2020 2020 2020  amp} 3"',.      
+00008150: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00008160: 207b 6e61 6d65 7d20 2265 6368 6f20 7b74   {name} "echo {t
+00008170: 696d 6573 7461 6d70 7d20 3422 272c 0a20  imestamp} 4"',. 
+00008180: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00008190: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+000081a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000081b0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000081c0: 207b 6e61 6d65 7d20 3320 3420 2d2d 7379   {name} 3 4 --sy
+000081d0: 6e63 2d64 6f77 6e27 2c0a 2020 2020 2020  nc-down',.      
+000081e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000081f0: 207b 6e61 6d65 7d20 2a20 2d2d 7379 6e63   {name} * --sync
+00008200: 2d64 6f77 6e27 2c0a 2020 2020 2020 2020  -down',.        
+00008210: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00008220: 6e61 6d65 7d20 3120 7c20 6772 6570 2022  name} 1 | grep "
+00008230: 7b74 696d 6573 7461 6d70 7d20 3122 272c  {timestamp} 1"',
+00008240: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008250: 6b79 206c 6f67 7320 7b6e 616d 657d 207c  ky logs {name} |
+00008260: 2067 7265 7020 227b 7469 6d65 7374 616d   grep "{timestam
+00008270: 707d 2034 2227 2c0a 2020 2020 2020 2020  p} 4"',.        
+00008280: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00008290: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000082a0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+000082b0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000082c0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 4a6f  .# ---------- Jo
+000082d0: 6220 5175 6575 652e 202d 2d2d 2d2d 2d2d  b Queue. -------
+000082e0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+000082f0: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+00008300: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+00008310: 2064 6f65 7320 6e6f 7420 6861 7665 204b   does not have K
+00008320: 3830 2067 7075 730a 4070 7974 6573 742e  80 gpus.@pytest.
+00008330: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+00008340: 424d 2043 6c6f 7564 2064 6f65 7320 6e6f  BM Cloud does no
+00008350: 7420 6861 7665 204b 3830 2067 7075 732e  t have K80 gpus.
+00008360: 2072 756e 2074 6573 745f 6962 6d5f 6a6f   run test_ibm_jo
+00008370: 625f 7175 6575 6520 696e 7374 6561 640a  b_queue instead.
+00008380: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00008390: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
+000083a0: 6e6f 7420 6861 7665 204b 3830 2067 7075  not have K80 gpu
+000083b0: 732e 2052 756e 2074 6573 745f 7363 705f  s. Run test_scp_
+000083c0: 6a6f 625f 7175 6575 6520 696e 7374 6561  job_queue instea
+000083d0: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
+000083e0: 6f5f 6f63 6920 2023 204f 4349 2064 6f65  o_oci  # OCI doe
+000083f0: 7320 6e6f 7420 6861 7665 204b 3830 2067  s not have K80 g
+00008400: 7075 730a 6465 6620 7465 7374 5f6a 6f62  pus.def test_job
+00008410: 5f71 7565 7565 2867 656e 6572 6963 5f63  _queue(generic_c
+00008420: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00008430: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00008440: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00008450: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00008460: 2020 2020 276a 6f62 5f71 7565 7565 272c      'job_queue',
+00008470: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00008480: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00008490: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000084a0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000084b0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
+000084c0: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
+000084d0: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
+000084e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000084f0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+00008500: 657d 2d31 202d 6420 6578 616d 706c 6573  e}-1 -d examples
+00008510: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
+00008520: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00008530: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00008540: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  me} -n {name}-2 
+00008550: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+00008560: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+00008570: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008580: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00008590: 6e20 7b6e 616d 657d 2d33 202d 6420 6578  n {name}-3 -d ex
+000085a0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+000085b0: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+000085c0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+000085d0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+000085e0: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+000085f0: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+00008600: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+00008610: 3120 7c20 6772 6570 2052 554e 4e49 4e47  1 | grep RUNNING
+00008620: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008630: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+00008640: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+00008650: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+00008660: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00008670: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
+00008680: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+00008690: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+000086a0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+000086b0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+000086c0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+000086d0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+000086e0: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
+000086f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008700: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+00008710: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
+00008720: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+00008730: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00008740: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+00008750: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+00008760: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+00008770: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00008780: 657d 2d33 207c 2067 7265 7020 5255 4e4e  e}-3 | grep RUNN
+00008790: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+000087a0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+000087b0: 7920 7b6e 616d 657d 2033 272c 0a20 2020  y {name} 3',.   
+000087c0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+000087d0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+000087e0: 7320 4b38 303a 302e 3220 225b 5b20 5c24  s K80:0.2 "[[ \$
+000087f0: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
+00008800: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
+00008810: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
+00008820: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008830: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+00008840: 2d67 7075 7320 4b38 303a 3120 225b 5b20  -gpus K80:1 "[[ 
+00008850: 5c24 534b 5950 494c 4f54 5f4e 554d 5f47  \$SKYPILOT_NUM_G
+00008860: 5055 535f 5045 525f 4e4f 4445 202d 6571  PUS_PER_NODE -eq
+00008870: 2031 205d 5d20 7c7c 2065 7869 7420 3122   1 ]] || exit 1"
+00008880: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008890: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+000088a0: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
+000088b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000088c0: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
+000088d0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+000088e0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+000088f0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00008900: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00008910: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00008920: 0a0a 4070 7974 6573 742e 6d61 726b 2e6c  ..@pytest.mark.l
+00008930: 616d 6264 615f 636c 6f75 640a 6465 6620  ambda_cloud.def 
+00008940: 7465 7374 5f6c 616d 6264 615f 6a6f 625f  test_lambda_job_
+00008950: 7175 6575 6528 293a 0a20 2020 206e 616d  queue():.    nam
+00008960: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00008970: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00008980: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00008990: 2027 6c61 6d62 6461 5f6a 6f62 5f71 7565   'lambda_job_que
+000089a0: 7565 272c 0a20 2020 2020 2020 205b 0a20  ue',.        [. 
+000089b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000089c0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000089d0: 616d 657d 207b 4c41 4d42 4441 5f54 5950  ame} {LAMBDA_TYP
+000089e0: 457d 2065 7861 6d70 6c65 732f 6a6f 625f  E} examples/job_
+000089f0: 7175 6575 652f 636c 7573 7465 722e 7961  queue/cluster.ya
+00008a00: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00008a10: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00008a20: 657d 202d 6e20 7b6e 616d 657d 2d31 202d  e} -n {name}-1 -
+00008a30: 2d67 7075 7320 4131 303a 302e 3520 2d64  -gpus A10:0.5 -d
+00008a40: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+00008a50: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
+00008a60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00008a70: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+00008a80: 7b6e 616d 657d 2d32 202d 2d67 7075 7320  {name}-2 --gpus 
+00008a90: 4131 303a 302e 3520 2d64 2065 7861 6d70  A10:0.5 -d examp
+00008aa0: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+00008ab0: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
+00008ac0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00008ad0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+00008ae0: 2d33 202d 2d67 7075 7320 4131 303a 302e  -3 --gpus A10:0.
+00008af0: 3520 2d64 2065 7861 6d70 6c65 732f 6a6f  5 -d examples/jo
+00008b00: 625f 7175 6575 652f 6a6f 622e 7961 6d6c  b_queue/job.yaml
+00008b10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008b20: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+00008b30: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+00008b40: 3120 7c20 6772 6570 2052 554e 4e49 4e47  1 | grep RUNNING
+00008b50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008b60: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+00008b70: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+00008b80: 3220 7c20 6772 6570 2052 554e 4e49 4e47  2 | grep RUNNING
+00008b90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008ba0: 2773 6b79 2071 7565 7565 207b 6e61 6d65  'sky queue {name
+00008bb0: 7d20 7c20 6772 6570 207b 6e61 6d65 7d2d  } | grep {name}-
+00008bc0: 3320 7c20 6772 6570 2050 454e 4449 4e47  3 | grep PENDING
+00008bd0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008be0: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+00008bf0: 6e61 6d65 7d20 3227 2c0a 2020 2020 2020  name} 2',.      
+00008c00: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
+00008c10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008c20: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
+00008c30: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+00008c40: 7c20 6772 6570 2052 554e 4e49 4e47 272c  | grep RUNNING',
+00008c50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008c60: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+00008c70: 6d65 7d20 3327 2c0a 2020 2020 2020 2020  me} 3',.        
+00008c80: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+00008c90: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+00008ca0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00008cb0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00008cc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6962  .@pytest.mark.ib
+00008cd0: 6d0a 6465 6620 7465 7374 5f69 626d 5f6a  m.def test_ibm_j
+00008ce0: 6f62 5f71 7565 7565 2829 3a0a 2020 2020  ob_queue():.    
+00008cf0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00008d00: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00008d10: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00008d20: 2020 2020 2769 626d 5f6a 6f62 5f71 7565      'ibm_job_que
+00008d30: 7565 272c 0a20 2020 2020 2020 205b 0a20  ue',.        [. 
+00008d40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00008d50: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00008d60: 616d 657d 202d 2d63 6c6f 7564 2069 626d  ame} --cloud ibm
+00008d70: 202d 2d67 7075 7320 7631 3030 272c 0a20   --gpus v100',. 
+00008d80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00008d90: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+00008da0: 7b6e 616d 657d 2d31 202d 2d63 6c6f 7564  {name}-1 --cloud
+00008db0: 2069 626d 202d 6420 6578 616d 706c 6573   ibm -d examples
+00008dc0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f69  /job_queue/job_i
+00008dd0: 626d 2e79 616d 6c27 2c0a 2020 2020 2020  bm.yaml',.      
+00008de0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00008df0: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
+00008e00: 7d2d 3220 2d2d 636c 6f75 6420 6962 6d20  }-2 --cloud ibm 
+00008e10: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+00008e20: 7175 6575 652f 6a6f 625f 6962 6d2e 7961  queue/job_ibm.ya
+00008e30: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00008e40: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00008e50: 657d 202d 6e20 7b6e 616d 657d 2d33 202d  e} -n {name}-3 -
+00008e60: 2d63 6c6f 7564 2069 626d 202d 6420 6578  -cloud ibm -d ex
+00008e70: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+00008e80: 2f6a 6f62 5f69 626d 2e79 616d 6c27 2c0a  /job_ibm.yaml',.
+00008e90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008ea0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+00008eb0: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+00008ec0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+00008ed0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008ee0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+00008ef0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+00008f00: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+00008f10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008f20: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+00008f30: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+00008f40: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
+00008f50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008f60: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+00008f70: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
+00008f80: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+00008f90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008fa0: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
+00008fb0: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
+00008fc0: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
+00008fd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008fe0: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+00008ff0: 2033 272c 0a20 2020 2020 2020 205d 2c0a   3',.        ],.
+00009000: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00009010: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00009020: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00009030: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00009040: 7974 6573 742e 6d61 726b 2e73 6370 0a64  ytest.mark.scp.d
+00009050: 6566 2074 6573 745f 7363 705f 6a6f 625f  ef test_scp_job_
+00009060: 7175 6575 6528 293a 0a20 2020 206e 616d  queue():.    nam
+00009070: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00009080: 5f6e 616d 6528 290a 2020 2020 6e75 6d5f  _name().    num_
+00009090: 6f66 5f67 7075 5f6c 6175 6e63 6820 3d20  of_gpu_launch = 
+000090a0: 310a 2020 2020 6e75 6d5f 6f66 5f67 7075  1.    num_of_gpu
+000090b0: 5f65 7865 6320 3d20 302e 350a 2020 2020  _exec = 0.5.    
+000090c0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000090d0: 2020 2020 2027 5343 505f 6a6f 625f 7175       'SCP_job_qu
+000090e0: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
 000090f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00009100: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00009110: 6770 7573 2076 3130 303a 3120 2d2d 6e75  gpus v100:1 --nu
-00009120: 6d2d 6e6f 6465 7320 3220 225b 5b20 5c24  m-nodes 2 "[[ \$
-00009130: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
-00009140: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
-00009150: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
-00009160: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009170: 6b79 206c 6f67 7320 7b6e 616d 657d 2035  ky logs {name} 5
-00009180: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00009190: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-000091a0: 6773 207b 6e61 6d65 7d20 3620 2d2d 7374  gs {name} 6 --st
-000091b0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-000091c0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000091d0: 616d 657d 2037 202d 2d73 7461 7475 7327  ame} 7 --status'
-000091e0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000091f0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00009200: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00009210: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00009220: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00009230: 2d2d 2d2d 2d2d 2d20 5375 626d 6974 7469  ------- Submitti
-00009240: 6e67 206d 756c 7469 706c 6520 7461 736b  ng multiple task
-00009250: 7320 746f 2074 6865 2073 616d 6520 636c  s to the same cl
-00009260: 7573 7465 722e 202d 2d2d 2d2d 2d2d 2d2d  uster. ---------
-00009270: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-00009280: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-00009290: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-000092a0: 6f65 7320 6e6f 7420 6861 7665 204b 3830  oes not have K80
-000092b0: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
-000092c0: 726b 2e6e 6f5f 6962 6d20 2023 2049 424d  rk.no_ibm  # IBM
-000092d0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-000092e0: 6861 7665 204b 3830 2067 7075 730a 6465  have K80 gpus.de
-000092f0: 6620 7465 7374 5f6d 756c 7469 5f65 6368  f test_multi_ech
-00009300: 6f28 6765 6e65 7269 635f 636c 6f75 643a  o(generic_cloud:
-00009310: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00009320: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00009330: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00009340: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00009350: 6d75 6c74 695f 6563 686f 272c 0a20 2020  multi_echo',.   
-00009360: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00009370: 2020 2066 2770 7974 686f 6e20 6578 616d     f'python exam
-00009380: 706c 6573 2f6d 756c 7469 5f65 6368 6f2e  ples/multi_echo.
-00009390: 7079 207b 6e61 6d65 7d20 7b67 656e 6572  py {name} {gener
-000093a0: 6963 5f63 6c6f 7564 7d27 2c0a 2020 2020  ic_cloud}',.    
-000093b0: 2020 2020 2020 2020 2773 6c65 6570 2039          'sleep 9
-000093c0: 3027 2c0a 2020 2020 2020 2020 5d20 2b0a  0',.        ] +.
-000093d0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-000093e0: 206a 6f62 7320 7375 6363 6565 6465 642e   jobs succeeded.
-000093f0: 0a20 2020 2020 2020 205b 6627 736b 7920  .        [f'sky 
-00009400: 6c6f 6773 207b 6e61 6d65 7d20 7b69 202b  logs {name} {i +
-00009410: 2031 7d20 2d2d 7374 6174 7573 2720 666f   1} --status' fo
-00009420: 7220 6920 696e 2072 616e 6765 2833 3229  r i in range(32)
-00009430: 5d20 2b0a 2020 2020 2020 2020 2320 456e  ] +.        # En
-00009440: 7375 7265 206d 6f6e 6974 6f72 2f61 7574  sure monitor/aut
-00009450: 6f73 6361 6c65 7220 6469 646e 2774 2063  oscaler didn't c
-00009460: 7261 7368 206f 6e20 7468 6520 2761 7373  rash on the 'ass
-00009470: 6572 7420 6e6f 740a 2020 2020 2020 2020  ert not.        
-00009480: 2320 756e 6675 6c66 696c 6c65 6427 2065  # unfulfilled' e
-00009490: 7272 6f72 2e20 2049 6620 7072 6f63 6573  rror.  If proces
-000094a0: 7320 6e6f 7420 666f 756e 642c 2067 7265  s not found, gre
-000094b0: 702d 3e73 7368 2072 6574 7572 6e73 2031  p->ssh returns 1
-000094c0: 2e0a 2020 2020 2020 2020 5b66 2773 7368  ..        [f'ssh
-000094d0: 207b 6e61 6d65 7d20 5c27 7073 2061 7578   {name} \'ps aux
-000094e0: 207c 2067 7265 7020 225b 2f5d 226d 6f6e   | grep "[/]"mon
-000094f0: 6974 6f72 2e70 795c 2727 5d2c 0a20 2020  itor.py\''],.   
-00009500: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00009510: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00009520: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00009530: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00009540: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00009550: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00009560: 2054 6173 6b3a 2031 206e 6f64 6520 7472   Task: 1 node tr
-00009570: 6169 6e69 6e67 2e20 2d2d 2d2d 2d2d 2d2d  aining. --------
-00009580: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00009590: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-000095a0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-000095b0: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
-000095c0: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
-000095d0: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
-000095e0: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
-000095f0: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
-00009600: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
-00009610: 7769 7468 2043 5544 410a 6465 6620 7465  with CUDA.def te
-00009620: 7374 5f68 7567 6769 6e67 6661 6365 2867  st_huggingface(g
-00009630: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-00009640: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-00009650: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00009660: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00009670: 7374 280a 2020 2020 2020 2020 2768 7567  st(.        'hug
-00009680: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
-00009690: 6462 5f61 7070 272c 0a20 2020 2020 2020  db_app',.       
-000096a0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-000096b0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-000096c0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-000096d0: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-000096e0: 2065 7861 6d70 6c65 732f 6875 6767 696e   examples/huggin
-000096f0: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
-00009700: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
-00009710: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00009720: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00009730: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00009740: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00009750: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00009760: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00009770: 2065 7861 6d70 6c65 732f 6875 6767 696e   examples/huggin
-00009780: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
-00009790: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
-000097a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000097b0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-000097c0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000097d0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000097e0: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
-000097f0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00009800: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00009810: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00009820: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00009830: 6573 742e 6d61 726b 2e6c 616d 6264 615f  est.mark.lambda_
-00009840: 636c 6f75 640a 6465 6620 7465 7374 5f6c  cloud.def test_l
-00009850: 616d 6264 615f 6875 6767 696e 6766 6163  ambda_huggingfac
-00009860: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-00009870: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00009880: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00009890: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-000098a0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000098b0: 6c61 6d62 6461 5f68 7567 6769 6e67 6661  lambda_huggingfa
-000098c0: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
-000098d0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-000098e0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000098f0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00009900: 657d 207b 4c41 4d42 4441 5f54 5950 457d  e} {LAMBDA_TYPE}
-00009910: 2065 7861 6d70 6c65 732f 6875 6767 696e   examples/huggin
-00009920: 6766 6163 655f 676c 7565 5f69 6d64 625f  gface_glue_imdb_
-00009930: 6170 702e 7961 6d6c 272c 0a20 2020 2020  app.yaml',.     
-00009940: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00009950: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00009960: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-00009970: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00009980: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00009990: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000099a0: 207b 4c41 4d42 4441 5f54 5950 457d 2065   {LAMBDA_TYPE} e
-000099b0: 7861 6d70 6c65 732f 6875 6767 696e 6766  xamples/huggingf
-000099c0: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
-000099d0: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-000099e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000099f0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00009a00: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00009a10: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00009a20: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00009a30: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00009a40: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00009a50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00009a60: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00009a70: 2d2d 2d2d 2d2d 2054 5055 2e20 2d2d 2d2d  ------ TPU. ----
-00009a80: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00009a90: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-00009aa0: 5f74 7075 2829 3a0a 2020 2020 6e61 6d65  _tpu():.    name
-00009ab0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00009ac0: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00009ad0: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00009ae0: 2774 7075 5f61 7070 272c 0a20 2020 2020  'tpu_app',.     
-00009af0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00009b00: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00009b10: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
-00009b20: 6c65 732f 7470 752f 7470 755f 6170 702e  les/tpu/tpu_app.
-00009b30: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00009b40: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00009b50: 616d 657d 2031 272c 2020 2320 456e 7375  ame} 1',  # Ensu
-00009b60: 7265 2074 6865 206a 6f62 2066 696e 6973  re the job finis
-00009b70: 6865 642e 0a20 2020 2020 2020 2020 2020  hed..           
-00009b80: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00009b90: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-00009ba0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00009bb0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00009bc0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00009bd0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00009be0: 657d 2065 7861 6d70 6c65 732f 7470 752f  e} examples/tpu/
-00009bf0: 7470 755f 6170 702e 7961 6d6c 207c 2067  tpu_app.yaml | g
-00009c00: 7265 7020 2254 5055 202e 2a20 616c 7265  rep "TPU .* alre
-00009c10: 6164 7920 6578 6973 7473 2227 2c20 2023  ady exists"',  #
-00009c20: 2045 6e73 7572 6520 736b 7920 6c61 756e   Ensure sky laun
-00009c30: 6368 2077 6f6e 2774 2063 7265 6174 6520  ch won't create 
-00009c40: 616e 6f74 6865 7220 5450 552e 0a20 2020  another TPU..   
-00009c50: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00009c60: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00009c70: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-00009c80: 696d 656f 7574 3d33 3020 2a20 3630 2c20  imeout=30 * 60, 
-00009c90: 2023 2063 616e 2074 616b 6520 3e32 3020   # can take >20 
-00009ca0: 6d69 6e73 0a20 2020 2029 0a20 2020 2072  mins.    ).    r
-00009cb0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00009cc0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00009cd0: 2054 5055 2056 4d2e 202d 2d2d 2d2d 2d2d   TPU VM. -------
-00009ce0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00009cf0: 2e67 6370 0a64 6566 2074 6573 745f 7470  .gcp.def test_tp
-00009d00: 755f 766d 2829 3a0a 2020 2020 6e61 6d65  u_vm():.    name
-00009d10: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
-00009d20: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
-00009d30: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-00009d40: 2774 7075 5f76 6d5f 6170 7027 2c0a 2020  'tpu_vm_app',.  
-00009d50: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00009d60: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00009d70: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
-00009d80: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
-00009d90: 5f6d 6e69 7374 2e79 616d 6c27 2c0a 2020  _mnist.yaml',.  
-00009da0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00009db0: 6c6f 6773 207b 6e61 6d65 7d20 3127 2c20  logs {name} 1', 
-00009dc0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00009dd0: 6220 6669 6e69 7368 6564 2e0a 2020 2020  b finished..    
-00009de0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00009df0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-00009e00: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-00009e10: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-00009e20: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-00009e30: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
-00009e40: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00009e50: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
-00009e60: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
-00009e70: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
-00009e80: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-00009e90: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
-00009ea0: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
-00009eb0: 4f50 5045 4427 2c20 2023 2045 6e73 7572  OPPED',  # Ensur
-00009ec0: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-00009ed0: 2053 544f 5050 4544 2e0a 2020 2020 2020   STOPPED..      
-00009ee0: 2020 2020 2020 2320 5573 6520 7265 7472        # Use retr
-00009ef0: 793a 2067 7561 7264 2061 6761 696e 7374  y: guard against
-00009f00: 2074 7261 6e73 6965 6e74 2065 7272 6f72   transient error
-00009f10: 7320 6f62 7365 7276 6564 2066 6f72 0a20  s observed for. 
-00009f20: 2020 2020 2020 2020 2020 2023 206a 7573             # jus
-00009f30: 742d 7374 6f70 7065 6420 5450 5520 564d  t-stopped TPU VM
-00009f40: 7320 2823 3936 3229 2e0a 2020 2020 2020  s (#962)..      
-00009f50: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-00009f60: 7420 2d2d 7265 7472 792d 756e 7469 6c2d  t --retry-until-
-00009f70: 7570 202d 7920 7b6e 616d 657d 272c 0a20  up -y {name}',. 
-00009f80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009f90: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
-00009fa0: 6d70 6c65 732f 7470 752f 7470 7576 6d5f  mples/tpu/tpuvm_
-00009fb0: 6d6e 6973 742e 7961 6d6c 272c 0a20 2020  mnist.yaml',.   
-00009fc0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00009fd0: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00009fe0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-00009ff0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000a000: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000a010: 2066 2773 6b79 2073 746f 7020 2d79 207b   f'sky stop -y {
-0000a020: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0000a030: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000a040: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000a050: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0000a060: 743d 3330 202a 2036 302c 2020 2320 6361  t=30 * 60,  # ca
-0000a070: 6e20 7461 6b65 2033 3020 6d69 6e73 0a20  n take 30 mins. 
-0000a080: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000a090: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-0000a0a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2056  ---------- TPU V
-0000a0b0: 4d20 506f 642e 202d 2d2d 2d2d 2d2d 2d2d  M Pod. ---------
-0000a0c0: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
-0000a0d0: 6370 0a64 6566 2074 6573 745f 7470 755f  cp.def test_tpu_
-0000a0e0: 766d 5f70 6f64 2829 3a0a 2020 2020 6e61  vm_pod():.    na
-0000a0f0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000a100: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000a110: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000a120: 2020 2774 7075 5f70 6f64 272c 0a20 2020    'tpu_pod',.   
-0000a130: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0000a140: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0000a150: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-0000a160: 6d70 6c65 732f 7470 752f 7470 7576 6d5f  mples/tpu/tpuvm_
-0000a170: 6d6e 6973 742e 7961 6d6c 202d 2d67 7075  mnist.yaml --gpu
-0000a180: 7320 7470 752d 7632 2d33 3220 2d2d 7573  s tpu-v2-32 --us
-0000a190: 652d 7370 6f74 202d 2d7a 6f6e 6520 6575  e-spot --zone eu
-0000a1a0: 726f 7065 2d77 6573 7434 2d61 272c 0a20  rope-west4-a',. 
-0000a1b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000a1c0: 206c 6f67 7320 7b6e 616d 657d 2031 272c   logs {name} 1',
-0000a1d0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000a1e0: 6f62 2066 696e 6973 6865 642e 0a20 2020  ob finished..   
-0000a1f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000a200: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0000a210: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000a220: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000a230: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-0000a240: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000a250: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000a260: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-0000a270: 3020 2a20 3630 2c20 2023 2063 616e 2074  0 * 60,  # can t
-0000a280: 616b 6520 3330 206d 696e 730a 2020 2020  ake 30 mins.    
-0000a290: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000a2a0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-0000a2b0: 2d2d 2d2d 2d2d 2d20 5369 6d70 6c65 2061  ------- Simple a
-0000a2c0: 7070 732e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  pps. ----------.
-0000a2d0: 6465 6620 7465 7374 5f6d 756c 7469 5f68  def test_multi_h
-0000a2e0: 6f73 746e 616d 6528 6765 6e65 7269 635f  ostname(generic_
-0000a2f0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-0000a300: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000a310: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000a320: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0000a330: 2020 2020 2027 6d75 6c74 695f 686f 7374       'multi_host
-0000a340: 6e61 6d65 272c 0a20 2020 2020 2020 205b  name',.        [
-0000a350: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000a360: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000a370: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-0000a380: 6765 6e65 7269 635f 636c 6f75 647d 2065  generic_cloud} e
-0000a390: 7861 6d70 6c65 732f 6d75 6c74 695f 686f  xamples/multi_ho
-0000a3a0: 7374 6e61 6d65 2e79 616d 6c27 2c0a 2020  stname.yaml',.  
-0000a3b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000a3c0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-0000a3d0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-0000a3e0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-0000a3f0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-0000a400: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000a410: 6d65 7d20 3120 7c20 6772 6570 2022 4d79  me} 1 | grep "My
-0000a420: 2068 6f73 746e 616d 653a 2220 7c20 7763   hostname:" | wc
-0000a430: 202d 6c20 7c20 6772 6570 2032 272c 2020   -l | grep 2',  
-0000a440: 2320 456e 7375 7265 2074 6865 7265 2061  # Ensure there a
-0000a450: 7265 2032 2068 6f73 7473 2e0a 2020 2020  re 2 hosts..    
-0000a460: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000a470: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
-0000a480: 6573 2f6d 756c 7469 5f68 6f73 746e 616d  es/multi_hostnam
-0000a490: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-0000a4a0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000a4b0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-0000a4c0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000a4d0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000a4e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0000a4f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000a500: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-0000a510: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000a520: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0000a530: 2d2d 2d2d 2d2d 2054 6173 6b3a 206e 3d32  ------ Task: n=2
-0000a540: 206e 6f64 6573 2077 6974 6820 7365 7475   nodes with setu
-0000a550: 7073 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ps. ----------.@
-0000a560: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-0000a570: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-0000a580: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-0000a590: 206e 6f74 2068 6176 6520 5631 3030 2067   not have V100 g
-0000a5a0: 7075 730a 4070 7974 6573 742e 6d61 726b  pus.@pytest.mark
-0000a5b0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2063  .no_ibm  # IBM c
-0000a5c0: 6c6f 7564 2063 7572 7265 6e74 6c79 2064  loud currently d
-0000a5d0: 6f65 736e 2774 2070 726f 7669 6465 2070  oesn't provide p
-0000a5e0: 7562 6c69 6320 696d 6167 6520 7769 7468  ublic image with
-0000a5f0: 2043 5544 410a 6465 6620 7465 7374 5f64   CUDA.def test_d
-0000a600: 6973 7472 6962 7574 6564 5f74 6628 6765  istributed_tf(ge
-0000a610: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-0000a620: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000a630: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000a640: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000a650: 7428 0a20 2020 2020 2020 2027 7265 736e  t(.        'resn
-0000a660: 6574 5f64 6973 7472 6962 7574 6564 5f74  et_distributed_t
-0000a670: 665f 6170 7027 2c0a 2020 2020 2020 2020  f_app',.        
-0000a680: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-0000a690: 4e4f 5445 3a20 7275 6e6e 696e 6720 6974  NOTE: running it
-0000a6a0: 2074 7769 6365 2077 696c 6c20 6861 6e67   twice will hang
-0000a6b0: 2028 736f 6d65 7469 6d65 733f 2920 2d20   (sometimes?) - 
-0000a6c0: 616e 2061 7070 2d6c 6576 656c 2062 7567  an app-level bug
-0000a6d0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000a6e0: 7079 7468 6f6e 2065 7861 6d70 6c65 732f  python examples/
-0000a6f0: 7265 736e 6574 5f64 6973 7472 6962 7574  resnet_distribut
-0000a700: 6564 5f74 665f 6170 702e 7079 207b 6e61  ed_tf_app.py {na
-0000a710: 6d65 7d20 7b67 656e 6572 6963 5f63 6c6f  me} {generic_clo
-0000a720: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
-0000a730: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000a740: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-0000a750: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000a760: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000a770: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000a780: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000a790: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0000a7a0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
-0000a7b0: 2020 2320 3235 206d 696e 7320 2869 7420    # 25 mins (it 
-0000a7c0: 7461 6b65 7320 6172 6f75 6e64 207e 3139  takes around ~19
-0000a7d0: 206d 696e 7329 0a20 2020 2029 0a20 2020   mins).    ).   
-0000a7e0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000a7f0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-0000a800: 2d2d 2054 6573 7469 6e67 2047 4350 2073  -- Testing GCP s
-0000a810: 7461 7274 2061 6e64 2073 746f 7020 696e  tart and stop in
-0000a820: 7374 616e 6365 7320 2d2d 2d2d 2d2d 2d2d  stances --------
-0000a830: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-0000a840: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-0000a850: 5f73 7461 7274 5f73 746f 7028 293a 0a20  _start_stop():. 
-0000a860: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000a870: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000a880: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000a890: 2020 2020 2020 2027 6763 702d 7374 6172         'gcp-star
-0000a8a0: 742d 7374 6f70 272c 0a20 2020 2020 2020  t-stop',.       
-0000a8b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000a8c0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000a8d0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000a8e0: 732f 6763 705f 7374 6172 745f 7374 6f70  s/gcp_start_stop
-0000a8f0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000a900: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000a910: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0000a920: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000a930: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000a940: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000a950: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
-0000a960: 616d 706c 6573 2f67 6370 5f73 7461 7274  amples/gcp_start
-0000a970: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
-0000a980: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000a990: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-0000a9a0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000a9b0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000a9c0: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000a9d0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000a9e0: 657d 2022 7072 6c69 6d69 7420 2d6e 202d  e} "prlimit -n -
-0000a9f0: 2d70 6964 3d5c 2428 7067 7265 7020 2d66  -pid=\$(pgrep -f
-0000aa00: 205c 2772 6179 6c65 742f 7261 796c 6574   \'raylet/raylet
-0000aa10: 202d 2d72 6179 6c65 745f 736f 636b 6574   --raylet_socket
-0000aa20: 5f6e 616d 655c 2729 207c 2067 7265 7020  _name\') | grep 
-0000aa30: 5c27 225c 2731 3034 3835 3736 2031 3034  \'"\'1048576 104
-0000aa40: 3835 3736 5c27 225c 2722 272c 2020 2320  8576\'"\'"',  # 
-0000aa50: 456e 7375 7265 2074 6865 2072 6179 6c65  Ensure the rayle
-0000aa60: 7420 7072 6f63 6573 7320 6861 7320 7468  t process has th
-0000aa70: 6520 636f 7272 6563 7420 6669 6c65 2064  e correct file d
-0000aa80: 6573 6372 6970 746f 7220 6c69 6d69 742e  escriptor limit.
-0000aa90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000aaa0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
-0000aab0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000aac0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000aad0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000aae0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-0000aaf0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000ab00: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
-0000ab10: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-0000ab20: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
-0000ab30: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0000ab40: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000ab50: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0000ab60: 6763 705f 7374 6172 745f 7374 6f70 2e79  gcp_start_stop.y
-0000ab70: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000ab80: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000ab90: 6d65 7d20 3420 2d2d 7374 6174 7573 272c  me} 4 --status',
-0000aba0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000abb0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000abc0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000abd0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000abe0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-0000abf0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000ac00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000ac10: 2d2d 2d20 5465 7374 696e 6720 417a 7572  --- Testing Azur
-0000ac20: 6520 7374 6172 7420 616e 6420 7374 6f70  e start and stop
-0000ac30: 2069 6e73 7461 6e63 6573 202d 2d2d 2d2d   instances -----
-0000ac40: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000ac50: 726b 2e61 7a75 7265 0a64 6566 2074 6573  rk.azure.def tes
-0000ac60: 745f 617a 7572 655f 7374 6172 745f 7374  t_azure_start_st
-0000ac70: 6f70 2829 3a0a 2020 2020 6e61 6d65 203d  op():.    name =
-0000ac80: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000ac90: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000aca0: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-0000acb0: 7a75 7265 2d73 7461 7274 2d73 746f 7027  zure-start-stop'
-0000acc0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000acd0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000ace0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000acf0: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-0000ad00: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-0000ad10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000ad20: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000ad30: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
-0000ad40: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-0000ad50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000ad60: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000ad70: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-0000ad80: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0000ad90: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000ada0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000adb0: 207b 6e61 6d65 7d20 2270 726c 696d 6974   {name} "prlimit
-0000adc0: 202d 6e20 2d2d 7069 643d 5c24 2870 6772   -n --pid=\$(pgr
-0000add0: 6570 202d 6620 5c27 7261 796c 6574 2f72  ep -f \'raylet/r
-0000ade0: 6179 6c65 7420 2d2d 7261 796c 6574 5f73  aylet --raylet_s
-0000adf0: 6f63 6b65 745f 6e61 6d65 5c27 2920 7c20  ocket_name\') | 
-0000ae00: 6772 6570 205c 2722 5c27 3130 3438 3537  grep \'"\'104857
-0000ae10: 3620 3130 3438 3537 365c 2722 5c27 2227  6 1048576\'"\'"'
-0000ae20: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000ae30: 7261 796c 6574 2070 726f 6365 7373 2068  raylet process h
-0000ae40: 6173 2074 6865 2063 6f72 7265 6374 2066  as the correct f
-0000ae50: 696c 6520 6465 7363 7269 7074 6f72 206c  ile descriptor l
-0000ae60: 696d 6974 2e0a 2020 2020 2020 2020 2020  imit..          
-0000ae70: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000ae80: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-0000ae90: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000aea0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000aeb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000aec0: 7374 6f70 202d 7920 7b6e 616d 657d 272c  stop -y {name}',
-0000aed0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000aee0: 6b79 2073 7461 7274 202d 7920 7b6e 616d  ky start -y {nam
-0000aef0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0000af00: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000af10: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
-0000af20: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
-0000af30: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000af40: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000af50: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
-0000af60: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-0000af70: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000af80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000af90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000afa0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-0000afb0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
-0000afc0: 2320 3330 206d 696e 730a 2020 2020 290a  # 30 mins.    ).
-0000afd0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000afe0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0000aff0: 2d2d 2d2d 2d20 5465 7374 696e 6720 4175  ----- Testing Au
-0000b000: 746f 7374 6f70 7069 6e67 202d 2d2d 2d2d  tostopping -----
-0000b010: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0000b020: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
-0000b030: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
-0000b040: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0000b050: 6f72 7420 7374 6f70 7069 6e67 2069 6e73  ort stopping ins
-0000b060: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-0000b070: 6172 6b2e 6e6f 5f69 626d 2020 2320 4649  ark.no_ibm  # FI
-0000b080: 5828 4942 4d29 2073 706f 7261 6469 6361  X(IBM) sporadica
-0000b090: 6c6c 7920 6661 696c 732c 2061 7320 7265  lly fails, as re
-0000b0a0: 7374 6172 7465 6420 776f 726b 6572 7320  started workers 
-0000b0b0: 7374 6179 2075 6e69 6e69 7469 616c 697a  stay uninitializ
-0000b0c0: 6564 2069 6e64 6566 696e 6974 656c 790a  ed indefinitely.
-0000b0d0: 6465 6620 7465 7374 5f61 7574 6f73 746f  def test_autosto
-0000b0e0: 7028 6765 6e65 7269 635f 636c 6f75 643a  p(generic_cloud:
-0000b0f0: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000b100: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000b110: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000b120: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000b130: 6175 746f 7374 6f70 272c 0a20 2020 2020  autostop',.     
-0000b140: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000b150: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000b160: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
-0000b170: 6e75 6d2d 6e6f 6465 7320 3220 2d2d 636c  num-nodes 2 --cl
-0000b180: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000b190: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
-0000b1a0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-0000b1b0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000b1c0: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
-0000b1d0: 7920 7b6e 616d 657d 202d 6920 3127 2c0a  y {name} -i 1',.
-0000b1e0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-0000b1f0: 6e73 7572 6520 6175 746f 7374 6f70 2069  nsure autostop i
-0000b200: 7320 7365 742e 0a20 2020 2020 2020 2020  s set..         
-0000b210: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
-0000b220: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0000b230: 6772 6570 2022 316d 2227 2c0a 0a20 2020  grep "1m"',..   
-0000b240: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-0000b250: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-0000b260: 206e 6f74 2073 746f 7070 6564 2065 6172   not stopped ear
-0000b270: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
-0000b280: 2773 6c65 6570 2034 3527 2c0a 2020 2020  'sleep 45',.    
-0000b290: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000b2a0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-0000b2b0: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-0000b2c0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000b2d0: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
-0000b2e0: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-0000b2f0: 6570 2055 5027 2c0a 0a20 2020 2020 2020  ep UP',..       
-0000b300: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-0000b310: 6520 636c 7573 7465 7220 6973 2053 544f  e cluster is STO
-0000b320: 5050 4544 2e0a 2020 2020 2020 2020 2020  PPED..          
-0000b330: 2020 2773 6c65 6570 2032 3530 272c 0a20    'sleep 250',. 
-0000b340: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000b350: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
-0000b360: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
-0000b370: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000b380: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000b390: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-0000b3a0: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
-0000b3b0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-0000b3c0: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-0000b3d0: 7220 6973 2055 5020 616e 6420 7468 6520  r is UP and the 
-0000b3e0: 6175 746f 7374 6f70 2073 6574 7469 6e67  autostop setting
-0000b3f0: 2069 7320 7265 7365 7420 2827 2d27 292e   is reset ('-').
-0000b400: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b410: 6b79 2073 7461 7274 202d 7920 7b6e 616d  ky start -y {nam
-0000b420: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0000b430: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
-0000b440: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-0000b450: 6570 202d 4520 2255 505c 732b 2d22 272c  ep -E "UP\s+-"',
-0000b460: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000b470: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0000b480: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000b490: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000b4a0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-0000b4b0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-0000b4c0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000b4d0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000b4e0: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-0000b4f0: 272c 0a0a 2020 2020 2020 2020 2020 2020  ',..            
-0000b500: 2320 5465 7374 2072 6573 7461 7274 696e  # Test restartin
-0000b510: 6720 7468 6520 6964 6c65 6e65 7373 2074  g the idleness t
-0000b520: 696d 6572 2076 6961 2063 616e 6365 6c20  imer via cancel 
-0000b530: 2b20 7265 7365 743a 0a20 2020 2020 2020  + reset:.       
-0000b540: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
-0000b550: 746f 7020 2d79 207b 6e61 6d65 7d20 2d69  top -y {name} -i
-0000b560: 2031 272c 2020 2320 4964 6c65 6e65 7373   1',  # Idleness
-0000b570: 2073 7461 7274 7320 636f 756e 7469 6e67   starts counting
-0000b580: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-0000b590: 6c65 6570 2034 3527 2c20 2023 2041 6c6d  leep 45',  # Alm
-0000b5a0: 6f73 7420 7265 6163 6865 6420 7468 6520  ost reached the 
-0000b5b0: 7468 7265 7368 6f6c 642e 0a20 2020 2020  threshold..     
-0000b5c0: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
-0000b5d0: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
-0000b5e0: 2d2d 6361 6e63 656c 272c 0a20 2020 2020  --cancel',.     
-0000b5f0: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
-0000b600: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
-0000b610: 2d69 2031 272c 2020 2320 5368 6f75 6c64  -i 1',  # Should
-0000b620: 2072 6573 7461 7274 2074 6865 2074 696d   restart the tim
-0000b630: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-0000b640: 2773 6c65 6570 2034 3527 2c0a 2020 2020  'sleep 45',.    
-0000b650: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000b660: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-0000b670: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-0000b680: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000b690: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000b6a0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000b6b0: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
-0000b6c0: 2020 2027 736c 6565 7020 3235 3027 2c0a     'sleep 250',.
-0000b6d0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000b6e0: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-0000b6f0: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-0000b700: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000b710: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000b720: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-0000b730: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
-0000b740: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000b750: 5465 7374 2072 6573 7461 7274 696e 6720  Test restarting 
-0000b760: 7468 6520 6964 6c65 6e65 7373 2074 696d  the idleness tim
-0000b770: 6572 2076 6961 2065 7865 633a 0a20 2020  er via exec:.   
-0000b780: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000b790: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
-0000b7a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b7b0: 6b79 2073 7461 7475 7320 7c20 6772 6570  ky status | grep
-0000b7c0: 207b 6e61 6d65 7d20 7c20 6772 6570 202d   {name} | grep -
-0000b7d0: 4520 2255 505c 732b 2d22 272c 0a20 2020  E "UP\s+-"',.   
-0000b7e0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-0000b7f0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-0000b800: 7d20 2d69 2031 272c 2020 2320 4964 6c65  } -i 1',  # Idle
-0000b810: 6e65 7373 2073 7461 7274 7320 636f 756e  ness starts coun
-0000b820: 7469 6e67 2e0a 2020 2020 2020 2020 2020  ting..          
-0000b830: 2020 2773 6c65 6570 2034 3527 2c20 2023    'sleep 45',  #
-0000b840: 2041 6c6d 6f73 7420 7265 6163 6865 6420   Almost reached 
-0000b850: 7468 6520 7468 7265 7368 6f6c 642e 0a20  the threshold.. 
-0000b860: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000b870: 2065 7865 6320 7b6e 616d 657d 2065 6368   exec {name} ech
-0000b880: 6f20 6869 272c 2020 2320 5368 6f75 6c64  o hi',  # Should
-0000b890: 2072 6573 7461 7274 2074 6865 2074 696d   restart the tim
-0000b8a0: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-0000b8b0: 2773 6c65 6570 2034 3527 2c0a 2020 2020  'sleep 45',.    
-0000b8c0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000b8d0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-0000b8e0: 2d2d 7265 6672 6573 6829 3b20 6563 686f  --refresh); echo
-0000b8f0: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000b900: 6f3b 2065 6368 6f20 2224 7322 2020 7c20  o; echo "$s"  | 
-0000b910: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-0000b920: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-0000b930: 2020 2020 2773 6c65 6570 2032 3530 272c      'sleep 250',
-0000b940: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000b950: 3d24 2873 6b79 2073 7461 7475 7320 7b6e  =$(sky status {n
-0000b960: 616d 657d 202d 2d72 6566 7265 7368 293b  ame} --refresh);
-0000b970: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
-0000b980: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
-0000b990: 2220 207c 2067 7265 7020 7b6e 616d 657d  "  | grep {name}
-0000b9a0: 207c 2067 7265 7020 5354 4f50 5045 4427   | grep STOPPED'
-0000b9b0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000b9c0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000b9d0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000b9e0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-0000b9f0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-0000ba00: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000ba10: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0000ba20: 2054 6573 7469 6e67 2041 7574 6f64 6f77   Testing Autodow
-0000ba30: 6e69 6e67 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ning ----------.
-0000ba40: 6465 6620 7465 7374 5f61 7574 6f64 6f77  def test_autodow
-0000ba50: 6e28 6765 6e65 7269 635f 636c 6f75 643a  n(generic_cloud:
-0000ba60: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000ba70: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000ba80: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000ba90: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000baa0: 6175 746f 646f 776e 272c 0a20 2020 2020  autodown',.     
-0000bab0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000bac0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000bad0: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
-0000bae0: 6e75 6d2d 6e6f 6465 7320 3220 2d2d 636c  num-nodes 2 --cl
-0000baf0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000bb00: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
-0000bb10: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
-0000bb20: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000bb30: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
-0000bb40: 7920 7b6e 616d 657d 202d 2d64 6f77 6e20  y {name} --down 
-0000bb50: 2d69 2031 272c 0a20 2020 2020 2020 2020  -i 1',.         
-0000bb60: 2020 2023 2045 6e73 7572 6520 6175 746f     # Ensure auto
-0000bb70: 7374 6f70 2069 7320 7365 742e 0a20 2020  stop is set..   
-0000bb80: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000bb90: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-0000bba0: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
-0000bbb0: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
-0000bbc0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-0000bbd0: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-0000bbe0: 2074 6572 6d69 6e61 7465 6420 6561 726c   terminated earl
-0000bbf0: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-0000bc00: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
-0000bc10: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000bc20: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-0000bc30: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-0000bc40: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000bc50: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-0000bc60: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000bc70: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
-0000bc80: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-0000bc90: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
-0000bca0: 6e61 7465 642e 0a20 2020 2020 2020 2020  nated..         
-0000bcb0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-0000bcc0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000bcd0: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
-0000bce0: 3d30 2073 6b79 2073 7461 7475 7320 7b6e  =0 sky status {n
-0000bcf0: 616d 657d 202d 2d72 6566 7265 7368 2920  ame} --refresh) 
-0000bd00: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-0000bd10: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
-0000bd20: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-0000bd30: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
-0000bd40: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
-0000bd50: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
-0000bd60: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
-0000bd70: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000bd80: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
-0000bd90: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
-0000bda0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000bdb0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
-0000bdc0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-0000bdd0: 6e65 7269 635f 636c 6f75 647d 202d 2d6e  neric_cloud} --n
-0000bde0: 756d 2d6e 6f64 6573 2032 202d 2d64 6f77  um-nodes 2 --dow
-0000bdf0: 6e20 7465 7374 732f 7465 7374 5f79 616d  n tests/test_yam
-0000be00: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-0000be10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000be20: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
-0000be30: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-0000be40: 5550 272c 2020 2320 456e 7375 7265 2074  UP',  # Ensure t
-0000be50: 6865 2063 6c75 7374 6572 2069 7320 5550  he cluster is UP
-0000be60: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000be70: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000be80: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-0000be90: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
-0000bea0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-0000beb0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000bec0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
-0000bed0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-0000bee0: 2067 7265 7020 2231 6d20 2864 6f77 6e29   grep "1m (down)
-0000bef0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000bf00: 2773 6c65 6570 2032 3430 272c 0a20 2020  'sleep 240',.   
-0000bf10: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-0000bf20: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-0000bf30: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
-0000bf40: 2020 2020 2020 2020 2066 2773 3d24 2853           f's=$(S
-0000bf50: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
-0000bf60: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
-0000bf70: 7d20 2d2d 7265 6672 6573 6829 2026 2620  } --refresh) && 
-0000bf80: 6563 686f 2022 2473 2220 2626 207b 7b20  echo "$s" && {{ 
-0000bf90: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000bfa0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
-0000bfb0: 4175 746f 646f 776e 6564 2063 6c75 7374  Autodowned clust
-0000bfc0: 6572 5c7c 7465 726d 696e 6174 6564 206f  er\|terminated o
-0000bfd0: 6e20 7468 6520 636c 6f75 6422 3b20 7d7d  n the cloud"; }}
-0000bfe0: 207c 7c20 7b7b 2065 6368 6f20 2224 7322   || {{ echo "$s"
-0000bff0: 207c 2067 7265 7020 7b6e 616d 657d 2026   | grep {name} &
-0000c000: 2620 6578 6974 2031 207c 7c20 6578 6974  & exit 1 || exit
-0000c010: 2030 3b20 7d7d 272c 0a20 2020 2020 2020   0; }}',.       
-0000c020: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000c030: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
-0000c040: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-0000c050: 6963 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d  ic_cloud} --num-
-0000c060: 6e6f 6465 7320 3220 2d2d 646f 776e 2074  nodes 2 --down t
-0000c070: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
-0000c080: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-0000c090: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000c0a0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
-0000c0b0: 6d65 7d20 2d2d 6361 6e63 656c 272c 0a20  me} --cancel',. 
-0000c0c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0000c0d0: 7020 3234 3027 2c0a 2020 2020 2020 2020  p 240',.        
-0000c0e0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-0000c0f0: 2063 6c75 7374 6572 2069 7320 7374 696c   cluster is stil
-0000c100: 6c20 5550 2e0a 2020 2020 2020 2020 2020  l UP..          
-0000c110: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
-0000c120: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
-0000c130: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
-0000c140: 7265 7368 2920 2626 2065 6368 6f20 2224  resh) && echo "$
-0000c150: 7322 2026 2620 6563 686f 2022 2473 2220  s" && echo "$s" 
-0000c160: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0000c170: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
-0000c180: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0000c190: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0000c1a0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-0000c1b0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
-0000c1c0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000c1d0: 6573 7428 7465 7374 290a 0a0a 6465 6620  est(test)...def 
-0000c1e0: 5f67 6574 5f63 616e 6365 6c5f 7461 736b  _get_cancel_task
-0000c1f0: 5f77 6974 685f 636c 6f75 6428 6e61 6d65  _with_cloud(name
-0000c200: 2c20 636c 6f75 642c 2074 696d 656f 7574  , cloud, timeout
-0000c210: 3d31 3520 2a20 3630 293a 0a20 2020 2074  =15 * 60):.    t
-0000c220: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0000c230: 2020 2020 6627 7b63 6c6f 7564 7d2d 6361      f'{cloud}-ca
-0000c240: 6e63 656c 2d74 6173 6b27 2c0a 2020 2020  ncel-task',.    
-0000c250: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000c260: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000c270: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0000c280: 732f 7265 736e 6574 5f61 7070 2e79 616d  s/resnet_app.yam
-0000c290: 6c20 2d2d 636c 6f75 6420 7b63 6c6f 7564  l --cloud {cloud
-0000c2a0: 7d20 2d79 202d 6427 2c0a 2020 2020 2020  } -y -d',.      
-0000c2b0: 2020 2020 2020 2320 5761 6974 2074 6865        # Wait the
-0000c2c0: 2047 5055 2070 726f 6365 7373 2074 6f20   GPU process to 
-0000c2d0: 7374 6172 742e 0a20 2020 2020 2020 2020  start..         
-0000c2e0: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
-0000c2f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000c300: 2065 7865 6320 7b6e 616d 657d 2022 6e76   exec {name} "nv
-0000c310: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
-0000c320: 7079 7468 6f6e 2227 2c0a 2020 2020 2020  python"',.      
-0000c330: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000c340: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-0000c350: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0000c360: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0000c370: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000c380: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000c390: 616d 657d 2031 272c 0a20 2020 2020 2020  ame} 1',.       
-0000c3a0: 2020 2020 2027 736c 6565 7020 3630 272c       'sleep 60',
-0000c3b0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-0000c3c0: 6865 636b 2069 6620 7468 6520 7079 7468  heck if the pyth
-0000c3d0: 6f6e 206a 6f62 2069 7320 676f 6e65 2e0a  on job is gone..
-0000c3e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c3f0: 7920 6578 6563 207b 6e61 6d65 7d20 2221  y exec {name} "!
-0000c400: 206e 7669 6469 612d 736d 6920 7c20 6772   nvidia-smi | gr
-0000c410: 6570 2070 7974 686f 6e22 272c 0a20 2020  ep python"',.   
-0000c420: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000c430: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
-0000c440: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000c450: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000c460: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-0000c470: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000c480: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000c490: 2020 2020 2020 2074 696d 656f 7574 3d74         timeout=t
-0000c4a0: 696d 656f 7574 2c0a 2020 2020 290a 2020  imeout,.    ).  
-0000c4b0: 2020 7265 7475 726e 2074 6573 740a 0a0a    return test...
-0000c4c0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0000c4d0: 7469 6e67 2060 736b 7920 6361 6e63 656c  ting `sky cancel
-0000c4e0: 6020 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  ` ----------.@py
-0000c4f0: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-0000c500: 6620 7465 7374 5f63 616e 6365 6c5f 6177  f test_cancel_aw
-0000c510: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
-0000c520: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000c530: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-0000c540: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
-0000c550: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
-0000c560: 2027 6177 7327 290a 2020 2020 7275 6e5f   'aws').    run_
-0000c570: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0000c580: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-0000c590: 700a 6465 6620 7465 7374 5f63 616e 6365  p.def test_cance
-0000c5a0: 6c5f 6763 7028 293a 0a20 2020 206e 616d  l_gcp():.    nam
-0000c5b0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-0000c5c0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-0000c5d0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
-0000c5e0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
-0000c5f0: 616d 652c 2027 6763 7027 290a 2020 2020  ame, 'gcp').    
-0000c600: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000c610: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-0000c620: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
-0000c630: 5f63 616e 6365 6c5f 617a 7572 6528 293a  _cancel_azure():
-0000c640: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000c650: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000c660: 2020 2020 7465 7374 203d 205f 6765 745f      test = _get_
-0000c670: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
-0000c680: 5f63 6c6f 7564 286e 616d 652c 2027 617a  _cloud(name, 'az
-0000c690: 7572 6527 2c20 7469 6d65 6f75 743d 3330  ure', timeout=30
-0000c6a0: 202a 2036 3029 0a20 2020 2072 756e 5f6f   * 60).    run_o
-0000c6b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000c6c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000c6d0: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
-0000c6e0: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
-0000c6f0: 7320 6e6f 7420 6861 7665 2056 3130 3020  s not have V100 
-0000c700: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
-0000c710: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-0000c720: 636c 6f75 6420 6375 7272 656e 746c 7920  cloud currently 
-0000c730: 646f 6573 6e27 7420 7072 6f76 6964 6520  doesn't provide 
-0000c740: 7075 626c 6963 2069 6d61 6765 2077 6974  public image wit
-0000c750: 6820 4355 4441 0a64 6566 2074 6573 745f  h CUDA.def test_
-0000c760: 6361 6e63 656c 5f70 7974 6f72 6368 2867  cancel_pytorch(g
-0000c770: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000c780: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-0000c790: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000c7a0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000c7b0: 7374 280a 2020 2020 2020 2020 2763 616e  st(.        'can
-0000c7c0: 6365 6c2d 7079 746f 7263 6827 2c0a 2020  cel-pytorch',.  
-0000c7d0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000c7e0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000c7f0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-0000c800: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-0000c810: 647d 2065 7861 6d70 6c65 732f 7265 736e  d} examples/resn
-0000c820: 6574 5f64 6973 7472 6962 7574 6564 5f74  et_distributed_t
-0000c830: 6f72 6368 2e79 616d 6c20 2d79 202d 6427  orch.yaml -y -d'
-0000c840: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0000c850: 5761 6974 2074 6865 2047 5055 2070 726f  Wait the GPU pro
-0000c860: 6365 7373 2074 6f20 7374 6172 742e 0a20  cess to start.. 
-0000c870: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0000c880: 7020 3930 272c 0a20 2020 2020 2020 2020  p 90',.         
-0000c890: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000c8a0: 616d 657d 2022 6e76 6964 6961 2d73 6d69  ame} "nvidia-smi
-0000c8b0: 207c 2067 7265 7020 7079 7468 6f6e 2227   | grep python"'
-0000c8c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000c8d0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000c8e0: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-0000c8f0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0000c900: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000c910: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000c920: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
-0000c930: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000c940: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-0000c950: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000c960: 7b6e 616d 657d 2022 286e 7669 6469 612d  {name} "(nvidia-
-0000c970: 736d 6920 7c20 6772 6570 205c 274e 6f20  smi | grep \'No 
-0000c980: 7275 6e6e 696e 6720 7072 6f63 6573 735c  running process\
-0000c990: 2729 207c 7c20 270a 2020 2020 2020 2020  ') || '.        
-0000c9a0: 2020 2020 2320 456e 7375 7265 2058 6f72      # Ensure Xor
-0000c9b0: 6720 6973 2074 6865 206f 6e6c 7920 7072  g is the only pr
-0000c9c0: 6f63 6573 7320 7275 6e6e 696e 672e 0a20  ocess running.. 
-0000c9d0: 2020 2020 2020 2020 2020 2027 5b20 5c24             '[ \$
-0000c9e0: 286e 7669 6469 612d 736d 6920 7c20 6772  (nvidia-smi | gr
-0000c9f0: 6570 202d 4120 3130 2050 726f 6365 7373  ep -A 10 Process
-0000ca00: 6573 207c 2067 7265 7020 2d41 2031 3020  es | grep -A 10 
-0000ca10: 3d3d 3d20 7c20 6772 6570 202d 7620 586f  === | grep -v Xo
-0000ca20: 7267 2920 2d65 7120 3220 5d22 272c 0a20  rg) -eq 2 ]"',. 
-0000ca30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000ca40: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
-0000ca50: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0000ca60: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0000ca70: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-0000ca80: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000ca90: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0000caa0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0000cab0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-0000cac0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000cad0: 2874 6573 7429 0a0a 0a23 2063 616e 2774  (test)...# can't
-0000cae0: 2075 7365 2060 5f67 6574 5f63 616e 6365   use `_get_cance
-0000caf0: 6c5f 7461 736b 5f77 6974 685f 636c 6f75  l_task_with_clou
-0000cb00: 6428 2960 2c20 6173 2063 6f6d 6d61 6e64  d()`, as command
-0000cb10: 2060 6e76 6964 6961 2d73 6d69 600a 2320   `nvidia-smi`.# 
-0000cb20: 7265 7175 6972 6573 2061 2043 5544 4120  requires a CUDA 
-0000cb30: 7075 626c 6963 2069 6d61 6765 2c20 7768  public image, wh
-0000cb40: 6963 6820 4942 4d20 646f 6573 6e27 7420  ich IBM doesn't 
-0000cb50: 6f66 6665 720a 4070 7974 6573 742e 6d61  offer.@pytest.ma
-0000cb60: 726b 2e69 626d 0a64 6566 2074 6573 745f  rk.ibm.def test_
-0000cb70: 6361 6e63 656c 5f69 626d 2829 3a0a 2020  cancel_ibm():.  
-0000cb80: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0000cb90: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0000cba0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0000cbb0: 2020 2020 2020 2769 626d 2d63 616e 6365        'ibm-cance
-0000cbc0: 6c2d 7461 736b 272c 0a20 2020 2020 2020  l-task',.       
-0000cbd0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000cbe0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000cbf0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-0000cc00: 2069 626d 2065 7861 6d70 6c65 732f 6d69   ibm examples/mi
-0000cc10: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-0000cc20: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-0000cc30: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-0000cc40: 616d 657d 2d31 202d 6420 2022 7768 696c  ame}-1 -d  "whil
-0000cc50: 6520 7472 7565 3b20 646f 2065 6368 6f20  e true; do echo 
-0000cc60: 5c27 4865 6c6c 6f20 536b 7950 696c 6f74  \'Hello SkyPilot
-0000cc70: 5c27 3b20 736c 6565 7020 323b 2064 6f6e  \'; sleep 2; don
-0000cc80: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-0000cc90: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
-0000cca0: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000ccb0: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000ccc0: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-0000ccd0: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
-0000cce0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000ccf0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000cd00: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-0000cd10: 6627 736c 6565 7020 3527 2c0a 2020 2020  f'sleep 5',.    
-0000cd20: 2020 2020 2020 2020 6627 736b 7920 7175          f'sky qu
-0000cd30: 6575 6520 7b6e 616d 657d 207c 2067 7265  eue {name} | gre
-0000cd40: 7020 7b6e 616d 657d 2d31 207c 2067 7265  p {name}-1 | gre
-0000cd50: 7020 4341 4e43 454c 4c45 4427 2c0a 2020  p CANCELLED',.  
-0000cd60: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000cd70: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000cd80: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-0000cd90: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000cda0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000cdb0: 2d2d 2d20 5465 7374 696e 6720 7573 652d  --- Testing use-
-0000cdc0: 7370 6f74 206f 7074 696f 6e20 2d2d 2d2d  spot option ----
-0000cdd0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0000cde0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-0000cdf0: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
-0000ce00: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
-0000ce10: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-0000ce20: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-0000ce30: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
-0000ce40: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-0000ce50: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0000ce60: 6e63 6573 0a64 6566 2074 6573 745f 7573  nces.def test_us
-0000ce70: 655f 7370 6f74 2867 656e 6572 6963 5f63  e_spot(generic_c
-0000ce80: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-0000ce90: 2222 2254 6573 7420 7573 652d 7370 6f74  """Test use-spot
-0000cea0: 2061 6e64 2073 6b79 2065 7865 632e 2222   and sky exec.""
-0000ceb0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-0000cec0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0000ced0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0000cee0: 280a 2020 2020 2020 2020 2775 7365 2d73  (.        'use-s
-0000cef0: 706f 7427 2c0a 2020 2020 2020 2020 5b0a  pot',.        [.
-0000cf00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000cf10: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-0000cf20: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-0000cf30: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
-0000cf40: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-0000cf50: 6d61 6c2e 7961 6d6c 202d 2d75 7365 2d73  mal.yaml --use-s
-0000cf60: 706f 7420 2d79 272c 0a20 2020 2020 2020  pot -y',.       
-0000cf70: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000cf80: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0000cf90: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-0000cfa0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000cfb0: 7d20 6563 686f 2068 6927 2c0a 2020 2020  } echo hi',.    
-0000cfc0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000cfd0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-0000cfe0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-0000cff0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000d000: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0000d010: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0000d020: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000d030: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
-0000d040: 7469 6e67 206d 616e 6167 6564 2073 706f  ting managed spo
-0000d050: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
-0000d060: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
-0000d070: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
-0000d080: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
-0000d090: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-0000d0a0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-0000d0b0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-0000d0c0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-0000d0d0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-0000d0e0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-0000d0f0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
-0000d100: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
-0000d110: 6f74 2867 656e 6572 6963 5f63 6c6f 7564  ot(generic_cloud
-0000d120: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-0000d130: 6573 7420 7468 6520 7370 6f74 2079 616d  est the spot yam
-0000d140: 6c2e 2222 220a 2020 2020 6e61 6d65 203d  l.""".    name =
-0000d150: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000d160: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000d170: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
-0000d180: 616e 6167 6564 2d73 706f 7427 2c0a 2020  anaged-spot',.  
-0000d190: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000d1a0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-0000d1b0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
-0000d1c0: 3120 2d2d 636c 6f75 6420 7b67 656e 6572  1 --cloud {gener
-0000d1d0: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
-0000d1e0: 6573 2f6d 616e 6167 6564 5f73 706f 742e  es/managed_spot.
-0000d1f0: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
-0000d200: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000d210: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
-0000d220: 616d 657d 2d32 202d 2d63 6c6f 7564 207b  ame}-2 --cloud {
-0000d230: 6765 6e65 7269 635f 636c 6f75 647d 2065  generic_cloud} e
-0000d240: 7861 6d70 6c65 732f 6d61 6e61 6765 645f  xamples/managed_
-0000d250: 7370 6f74 2e79 616d 6c20 2d79 202d 6427  spot.yaml -y -d'
-0000d260: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000d270: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0000d280: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0000d290: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0000d2a0: 7b6e 616d 657d 2d31 207c 2068 6561 6420  {name}-1 | head 
-0000d2b0: 2d6e 3120 7c20 6772 6570 2022 5354 4152  -n1 | grep "STAR
-0000d2c0: 5449 4e47 5c7c 5255 4e4e 494e 4722 272c  TING\|RUNNING"',
-0000d2d0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0000d2e0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0000d2f0: 7d7c 2067 7265 7020 7b6e 616d 657d 2d32  }| grep {name}-2
-0000d300: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0000d310: 6570 2022 5354 4152 5449 4e47 5c7c 5255  ep "STARTING\|RU
-0000d320: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-0000d330: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-0000d340: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-0000d350: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
-0000d360: 3127 292c 0a20 2020 2020 2020 2020 2020  1'),.           
-0000d370: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
-0000d380: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0000d390: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0000d3a0: 6570 207b 6e61 6d65 7d2d 3120 7c20 6865  ep {name}-1 | he
-0000d3b0: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
-0000d3c0: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
-0000d3d0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-0000d3e0: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
-0000d3f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0000d400: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0000d410: 7d7c 2067 7265 7020 7b6e 616d 657d 2d31  }| grep {name}-1
-0000d420: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0000d430: 6570 2043 414e 4345 4c4c 4544 272c 0a20  ep CANCELLED',. 
-0000d440: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0000d450: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0000d460: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-0000d470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0000d480: 2022 5255 4e4e 494e 475c 7c53 5543 4345   "RUNNING\|SUCCE
-0000d490: 4544 4544 2227 2c0a 2020 2020 2020 2020  EDED"',.        
-0000d4a0: 5d2c 0a20 2020 2020 2020 2023 2054 4f44  ],.        # TOD
-0000d4b0: 4f28 7a68 7775 293a 2043 6861 6e67 6520  O(zhwu): Change 
-0000d4c0: 746f 205f 5350 4f54 5f43 414e 4345 4c5f  to _SPOT_CANCEL_
-0000d4d0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-0000d4e0: 6e61 6d65 3d66 277b 6e61 6d65 7d2d 3120  name=f'{name}-1 
-0000d4f0: 2d6e 207b 6e61 6d65 7d2d 3227 2920 7768  -n {name}-2') wh
-0000d500: 656e 0a20 2020 2020 2020 2023 2063 616e  en.        # can
-0000d510: 6365 6c69 6e67 206d 756c 7469 706c 6520  celing multiple 
-0000d520: 6a6f 6220 6e61 6d65 7320 6973 2073 7570  job names is sup
-0000d530: 706f 7274 6564 2e0a 2020 2020 2020 2020  ported..        
-0000d540: 285f 5350 4f54 5f43 414e 4345 4c5f 5741  (_SPOT_CANCEL_WA
-0000d550: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0000d560: 6d65 3d66 277b 6e61 6d65 7d2d 3127 2920  me=f'{name}-1') 
-0000d570: 2b20 273b 2027 202b 0a20 2020 2020 2020  + '; ' +.       
-0000d580: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-0000d590: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0000d5a0: 616d 653d 6627 7b6e 616d 657d 2d32 2729  ame=f'{name}-2')
-0000d5b0: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
-0000d5c0: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
-0000d5d0: 6e63 6520 736b 7920 7370 6f74 2071 7565  nce sky spot que
-0000d5e0: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
-0000d5f0: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
-0000d600: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
-0000d610: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000d620: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0000d630: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000d640: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-0000d650: 6f5f 6c61 6d62 6461 5f63 6c6f 7564 2020  o_lambda_cloud  
-0000d660: 2320 4c61 6d62 6461 2043 6c6f 7564 2064  # Lambda Cloud d
-0000d670: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-0000d680: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-0000d690: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f69  pytest.mark.no_i
-0000d6a0: 626d 2020 2320 4942 4d20 436c 6f75 6420  bm  # IBM Cloud 
-0000d6b0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0000d6c0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0000d6d0: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-0000d6e0: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
-0000d6f0: 7374 5f73 706f 745f 6661 696c 6564 5f73  st_spot_failed_s
-0000d700: 6574 7570 2867 656e 6572 6963 5f63 6c6f  etup(generic_clo
-0000d710: 7564 3a20 7374 7229 3a0a 2020 2020 2222  ud: str):.    ""
-0000d720: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-0000d730: 6f74 206a 6f62 2077 6974 6820 6661 696c  ot job with fail
-0000d740: 6564 2073 6574 7570 2e22 2222 0a20 2020  ed setup.""".   
-0000d750: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000d760: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000d770: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0000d780: 2020 2020 2027 7370 6f74 2d66 6169 6c65       'spot-faile
-0000d790: 642d 7365 7475 7027 2c0a 2020 2020 2020  d-setup',.      
-0000d7a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0000d7b0: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0000d7c0: 6820 2d6e 207b 6e61 6d65 7d20 2d2d 636c  h -n {name} --cl
-0000d7d0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000d7e0: 7564 7d20 2d79 202d 6420 7465 7374 732f  ud} -y -d tests/
-0000d7f0: 7465 7374 5f79 616d 6c73 2f66 6169 6c65  test_yamls/faile
-0000d800: 645f 7365 7475 702e 7961 6d6c 272c 0a20  d_setup.yaml',. 
-0000d810: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0000d820: 7020 3333 3027 2c0a 2020 2020 2020 2020  p 330',.        
-0000d830: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-0000d840: 7468 6520 6a6f 6220 6661 696c 6564 2071  the job failed q
-0000d850: 7569 636b 6c79 2e0a 2020 2020 2020 2020  uickly..        
-0000d860: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0000d870: 5545 5f57 4149 547d 207c 2067 7265 7020  UE_WAIT} | grep 
-0000d880: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
-0000d890: 3120 7c20 6772 6570 2022 4641 494c 4544  1 | grep "FAILED
-0000d8a0: 5f53 4554 5550 2227 2c0a 2020 2020 2020  _SETUP"',.      
-0000d8b0: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
-0000d8c0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-0000d8d0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-0000d8e0: 616d 6529 2c0a 2020 2020 2020 2020 2320  ame),.        # 
-0000d8f0: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
-0000d900: 2073 696e 6365 2073 6b79 2073 706f 7420   since sky spot 
-0000d910: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
-0000d920: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
-0000d930: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
-0000d940: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
-0000d950: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-0000d960: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000d970: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000d980: 2d20 5465 7374 696e 6720 6d61 6e61 6765  - Testing manage
-0000d990: 6420 7370 6f74 2072 6563 6f76 6572 7920  d spot recovery 
-0000d9a0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0000d9b0: 7374 2e6d 6172 6b2e 6177 730a 4070 7974  st.mark.aws.@pyt
-0000d9c0: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
-0000d9d0: 5f73 706f 740a 6465 6620 7465 7374 5f73  _spot.def test_s
-0000d9e0: 706f 745f 7265 636f 7665 7279 5f61 7773  pot_recovery_aws
-0000d9f0: 2861 7773 5f63 6f6e 6669 675f 7265 6769  (aws_config_regi
-0000da00: 6f6e 293a 0a20 2020 2022 2222 5465 7374  on):.    """Test
-0000da10: 206d 616e 6167 6564 2073 706f 7420 7265   managed spot re
-0000da20: 636f 7665 7279 2e22 2222 0a20 2020 206e  covery.""".    n
-0000da30: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0000da40: 6572 5f6e 616d 6528 290a 2020 2020 7265  er_name().    re
-0000da50: 6769 6f6e 203d 2061 7773 5f63 6f6e 6669  gion = aws_confi
-0000da60: 675f 7265 6769 6f6e 0a20 2020 2074 6573  g_region.    tes
-0000da70: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000da80: 2020 2773 706f 745f 7265 636f 7665 7279    'spot_recovery
-0000da90: 5f61 7773 272c 0a20 2020 2020 2020 205b  _aws',.        [
-0000daa0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000dab0: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
-0000dac0: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
-0000dad0: 696f 6e20 7b72 6567 696f 6e7d 202d 6e20  ion {region} -n 
-0000dae0: 7b6e 616d 657d 2022 6563 686f 2053 4b59  {name} "echo SKY
-0000daf0: 5049 4c4f 545f 4a4f 425f 4944 3a20 5c24  PILOT_JOB_ID: \$
-0000db00: 534b 5950 494c 4f54 5f4a 4f42 5f49 443b  SKYPILOT_JOB_ID;
-0000db10: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
-0000db20: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-0000db30: 2020 2773 6c65 6570 2033 3630 272c 0a20    'sleep 360',. 
-0000db40: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0000db50: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0000db60: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0000db70: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0000db80: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
-0000db90: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
-0000dba0: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
-0000dbb0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-0000dbc0: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
-0000dbd0: 5049 4c4f 545f 4a4f 425f 4944 207c 2063  PILOT_JOB_ID | c
-0000dbe0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-0000dbf0: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-0000dc00: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-0000dc10: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-0000dc20: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-0000dc30: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
-0000dc40: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-0000dc50: 2028 6627 6177 7320 6563 3220 7465 726d   (f'aws ec2 term
-0000dc60: 696e 6174 652d 696e 7374 616e 6365 7320  inate-instances 
-0000dc70: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0000dc80: 7d20 2d2d 696e 7374 616e 6365 2d69 6473  } --instance-ids
-0000dc90: 2024 2827 0a20 2020 2020 2020 2020 2020   $('.           
-0000dca0: 2020 6627 6177 7320 6563 3220 6465 7363    f'aws ec2 desc
-0000dcb0: 7269 6265 2d69 6e73 7461 6e63 6573 202d  ribe-instances -
-0000dcc0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-0000dcd0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000dce0: 6627 2d2d 6669 6c74 6572 7320 4e61 6d65  f'--filters Name
-0000dcf0: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
-0000dd00: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
-0000dd10: 6d65 7d2a 2027 0a20 2020 2020 2020 2020  me}* '.         
-0000dd20: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-0000dd30: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-0000dd40: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-0000dd50: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-0000dd60: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-0000dd70: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
-0000dd80: 2020 2773 6c65 6570 2031 3030 272c 0a20    'sleep 100',. 
-0000dd90: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0000dda0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0000ddb0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-0000ddc0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
-0000ddd0: 5245 434f 5645 5249 4e47 2227 2c0a 2020  RECOVERING"',.  
-0000dde0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000ddf0: 2032 3030 272c 0a20 2020 2020 2020 2020   200',.         
-0000de00: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0000de10: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0000de20: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-0000de30: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
-0000de40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000de50: 2752 554e 5f49 443d 2428 6361 7420 2f74  'RUN_ID=$(cat /t
-0000de60: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-0000de70: 293b 2065 6368 6f20 2452 554e 5f49 443b  ); echo $RUN_ID;
-0000de80: 2073 6b79 2073 706f 7420 6c6f 6773 202d   sky spot logs -
-0000de90: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-0000dea0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-0000deb0: 494c 4f54 5f4a 4f42 5f49 4420 7c20 6772  ILOT_JOB_ID | gr
-0000dec0: 6570 2022 2452 554e 5f49 4422 272c 0a20  ep "$RUN_ID"',. 
-0000ded0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000dee0: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-0000def0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0000df00: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-0000df10: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
-0000df20: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0000df30: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0000df40: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-0000df50: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-0000df60: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
-0000df70: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
-0000df80: 7665 7279 5f67 6370 2829 3a0a 2020 2020  very_gcp():.    
-0000df90: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-0000dfa0: 7370 6f74 2072 6563 6f76 6572 792e 2222  spot recovery.""
-0000dfb0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-0000dfc0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0000dfd0: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
-0000dfe0: 6561 7374 342d 6227 0a20 2020 2071 7565  east4-b'.    que
-0000dff0: 7279 5f63 6d64 203d 2028 6627 6763 6c6f  ry_cmd = (f'gclo
-0000e000: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-0000e010: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
-0000e020: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
-0000e030: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
-0000e040: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
-0000e050: 653a 7b6e 616d 657d 2922 2027 0a20 2020  e:{name})" '.   
-0000e060: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000e070: 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d 202d  --zones={zone} -
-0000e080: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
-0000e090: 616d 6529 2227 290a 2020 2020 7465 726d  ame)"').    term
-0000e0a0: 696e 6174 655f 636d 6420 3d20 2866 2767  inate_cmd = (f'g
-0000e0b0: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
-0000e0c0: 7374 616e 6365 7320 6465 6c65 7465 202d  stances delete -
-0000e0d0: 2d7a 6f6e 653d 7b7a 6f6e 657d 270a 2020  -zone={zone}'.  
-0000e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0f0: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
-0000e100: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
-0000e110: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000e120: 2020 2020 2020 2020 2773 706f 745f 7265          'spot_re
-0000e130: 636f 7665 7279 5f67 6370 272c 0a20 2020  covery_gcp',.   
-0000e140: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0000e150: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-0000e160: 756e 6368 202d 2d63 6c6f 7564 2067 6370  unch --cloud gcp
-0000e170: 202d 2d7a 6f6e 6520 7b7a 6f6e 657d 202d   --zone {zone} -
-0000e180: 6e20 7b6e 616d 657d 2022 6563 686f 2053  n {name} "echo S
-0000e190: 4b59 5049 4c4f 545f 4a4f 425f 4944 3a20  KYPILOT_JOB_ID: 
-0000e1a0: 5c24 534b 5950 494c 4f54 5f4a 4f42 5f49  \$SKYPILOT_JOB_I
-0000e1b0: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
-0000e1c0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-0000e1d0: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
-0000e1e0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0000e1f0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0000e200: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0000e210: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0000e220: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0000e230: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0000e240: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-0000e250: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-0000e260: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-0000e270: 4b59 5049 4c4f 545f 4a4f 425f 4944 207c  KYPILOT_JOB_ID |
-0000e280: 2063 7574 202d 643a 202d 6632 293b 2065   cut -d: -f2); e
-0000e290: 6368 6f20 2224 5255 4e5f 4944 2220 7c20  cho "$RUN_ID" | 
-0000e2a0: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
-0000e2b0: 7275 6e2d 6964 272c 0a20 2020 2020 2020  run-id',.       
-0000e2c0: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
-0000e2d0: 2074 6865 2063 6c75 7374 6572 206d 616e   the cluster man
-0000e2e0: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
-0000e2f0: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
-0000e300: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000e310: 6c65 6570 2031 3030 272c 0a20 2020 2020  leep 100',.     
-0000e320: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0000e330: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0000e340: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-0000e350: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
-0000e360: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
-0000e370: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
-0000e380: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000e390: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0000e3a0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0000e3b0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-0000e3c0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-0000e3d0: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-0000e3e0: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
-0000e3f0: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
-0000e400: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
-0000e410: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-0000e420: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-0000e430: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-0000e440: 5f4a 4f42 5f49 4420 7c20 6772 6570 2022  _JOB_ID | grep "
-0000e450: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
-0000e460: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
-0000e470: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
-0000e480: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
-0000e490: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-0000e4a0: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
-0000e4b0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000e4c0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0000e4d0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-0000e4e0: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-0000e4f0: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-0000e500: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-0000e510: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-0000e520: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-0000e530: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-0000e540: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-0000e550: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-0000e560: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
-0000e570: 645f 7370 6f74 0a64 6566 2074 6573 745f  d_spot.def test_
-0000e580: 7370 6f74 5f72 6563 6f76 6572 795f 6465  spot_recovery_de
-0000e590: 6661 756c 745f 7265 736f 7572 6365 7328  fault_resources(
-0000e5a0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000e5b0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-0000e5c0: 206d 616e 6167 6564 2073 706f 7420 7265   managed spot re
-0000e5d0: 636f 7665 7279 2066 6f72 2064 6566 6175  covery for defau
-0000e5e0: 6c74 2072 6573 6f75 7263 6573 2e22 2222  lt resources."""
-0000e5f0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000e600: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000e610: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000e620: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
-0000e630: 642d 7370 6f74 2d72 6563 6f76 6572 792d  d-spot-recovery-
-0000e640: 6465 6661 756c 742d 7265 736f 7572 6365  default-resource
-0000e650: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-0000e660: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000e670: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
-0000e680: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-0000e690: 656e 6572 6963 5f63 6c6f 7564 7d20 2273  eneric_cloud} "s
-0000e6a0: 6c65 6570 2033 3020 2626 2073 7564 6f20  leep 30 && sudo 
-0000e6b0: 7368 7574 646f 776e 206e 6f77 2026 2620  shutdown now && 
-0000e6c0: 736c 6565 7020 3130 3030 2220 2d79 202d  sleep 1000" -y -
-0000e6d0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
-0000e6e0: 2773 6c65 6570 2033 3630 272c 0a20 2020  'sleep 360',.   
-0000e6f0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0000e700: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0000e710: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0000e720: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
-0000e730: 4e4e 494e 475c 7c52 4543 4f56 4552 494e  NNING\|RECOVERIN
-0000e740: 4722 272c 0a20 2020 2020 2020 205d 2c0a  G"',.        ],.
-0000e750: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-0000e760: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-0000e770: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
-0000e780: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0000e790: 3d32 3520 2a20 3630 2c0a 2020 2020 290a  =25 * 60,.    ).
-0000e7a0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000e7b0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0000e7c0: 2e6d 6172 6b2e 6177 730a 4070 7974 6573  .mark.aws.@pytes
-0000e7d0: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-0000e7e0: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-0000e7f0: 745f 7265 636f 7665 7279 5f6d 756c 7469  t_recovery_multi
-0000e800: 5f6e 6f64 655f 6177 7328 6177 735f 636f  _node_aws(aws_co
-0000e810: 6e66 6967 5f72 6567 696f 6e29 3a0a 2020  nfig_region):.  
-0000e820: 2020 2222 2254 6573 7420 6d61 6e61 6765    """Test manage
-0000e830: 6420 7370 6f74 2072 6563 6f76 6572 792e  d spot recovery.
-0000e840: 2222 220a 2020 2020 6e61 6d65 203d 205f  """.    name = _
-0000e850: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000e860: 2829 0a20 2020 2072 6567 696f 6e20 3d20  ().    region = 
-0000e870: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
-0000e880: 6e0a 2020 2020 7465 7374 203d 2054 6573  n.    test = Tes
-0000e890: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
-0000e8a0: 5f72 6563 6f76 6572 795f 6d75 6c74 695f  _recovery_multi_
-0000e8b0: 6e6f 6465 5f61 7773 272c 0a20 2020 2020  node_aws',.     
-0000e8c0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000e8d0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
-0000e8e0: 6368 202d 2d63 6c6f 7564 2061 7773 202d  ch --cloud aws -
-0000e8f0: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-0000e900: 202d 6e20 7b6e 616d 657d 202d 2d6e 756d   -n {name} --num
-0000e910: 2d6e 6f64 6573 2032 2022 6563 686f 2053  -nodes 2 "echo S
-0000e920: 4b59 5049 4c4f 545f 4a4f 425f 4944 3a20  KYPILOT_JOB_ID: 
-0000e930: 5c24 534b 5950 494c 4f54 5f4a 4f42 5f49  \$SKYPILOT_JOB_I
-0000e940: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
-0000e950: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-0000e960: 2020 2020 2773 6c65 6570 2034 3530 272c      'sleep 450',
-0000e970: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0000e980: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0000e990: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0000e9a0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0000e9b0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-0000e9c0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-0000e9d0: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-0000e9e0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-0000e9f0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-0000ea00: 4b59 5049 4c4f 545f 4a4f 425f 4944 207c  KYPILOT_JOB_ID |
-0000ea10: 2063 7574 202d 643a 202d 6632 293b 2065   cut -d: -f2); e
-0000ea20: 6368 6f20 2224 5255 4e5f 4944 2220 7c20  cho "$RUN_ID" | 
-0000ea30: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
-0000ea40: 7275 6e2d 6964 272c 0a20 2020 2020 2020  run-id',.       
-0000ea50: 2020 2020 2023 2054 6572 6d69 6e61 7465       # Terminate
-0000ea60: 2074 6865 2077 6f72 6b65 7220 6d61 6e75   the worker manu
-0000ea70: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
-0000ea80: 2020 2866 2761 7773 2065 6332 2074 6572    (f'aws ec2 ter
-0000ea90: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
-0000eaa0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0000eab0: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
-0000eac0: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
-0000ead0: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
-0000eae0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-0000eaf0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0000eb00: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0000eb10: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
-0000eb20: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-0000eb30: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
-0000eb40: 616d 657d 2a20 270a 2020 2020 2020 2020  ame}* '.        
-0000eb50: 2020 2020 2027 4e61 6d65 3d74 6167 3a72       'Name=tag:r
-0000eb60: 6179 2d6e 6f64 652d 7479 7065 2c56 616c  ay-node-type,Val
-0000eb70: 7565 733d 776f 726b 6572 2027 0a20 2020  ues=worker '.   
-0000eb80: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
-0000eb90: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
-0000eba0: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e49  [].Instances[].I
-0000ebb0: 6e73 7461 6e63 6549 6420 270a 2020 2020  nstanceId '.    
-0000ebc0: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-0000ebd0: 7574 2074 6578 7429 2729 2c0a 2020 2020  ut text)'),.    
-0000ebe0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-0000ebf0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000ec00: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0000ec10: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0000ec20: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0000ec30: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
-0000ec40: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000ec50: 736c 6565 7020 3536 3027 2c0a 2020 2020  sleep 560',.    
-0000ec60: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0000ec70: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0000ec80: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
-0000ec90: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-0000eca0: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-0000ecb0: 2020 2020 6627 5255 4e5f 4944 3d24 2863      f'RUN_ID=$(c
-0000ecc0: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
-0000ecd0: 756e 2d69 6429 3b20 6563 686f 2024 5255  un-id); echo $RU
-0000ece0: 4e5f 4944 3b20 736b 7920 7370 6f74 206c  N_ID; sky spot l
-0000ecf0: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
-0000ed00: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
-0000ed10: 2053 4b59 5049 4c4f 545f 4a4f 425f 4944   SKYPILOT_JOB_ID
-0000ed20: 207c 2063 7574 202d 643a 202d 6632 207c   | cut -d: -f2 |
-0000ed30: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
-0000ed40: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000ed50: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-0000ed60: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-0000ed70: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-0000ed80: 2020 2020 2020 7469 6d65 6f75 743d 3330        timeout=30
-0000ed90: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-0000eda0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-0000edb0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-0000edc0: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
-0000edd0: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-0000ede0: 0a64 6566 2074 6573 745f 7370 6f74 5f72  .def test_spot_r
-0000edf0: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
-0000ee00: 6465 5f67 6370 2829 3a0a 2020 2020 2222  de_gcp():.    ""
-0000ee10: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
-0000ee20: 6f74 2072 6563 6f76 6572 792e 2222 220a  ot recovery.""".
-0000ee30: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000ee40: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000ee50: 2020 207a 6f6e 6520 3d20 2775 732d 7765     zone = 'us-we
-0000ee60: 7374 322d 6127 0a20 2020 2023 2055 7365  st2-a'.    # Use
-0000ee70: 2027 3a27 2074 6f20 6d61 7463 6820 6173   ':' to match as
-0000ee80: 2074 6865 2063 6c75 7374 6572 206e 616d   the cluster nam
-0000ee90: 6520 7769 6c6c 2063 6f6e 7461 696e 2074  e will contain t
-0000eea0: 6865 2073 7566 6669 7820 7769 7468 206a  he suffix with j
-0000eeb0: 6f62 2069 640a 2020 2020 7175 6572 795f  ob id.    query_
-0000eec0: 636d 6420 3d20 280a 2020 2020 2020 2020  cmd = (.        
-0000eed0: 6627 6763 6c6f 7564 2063 6f6d 7075 7465  f'gcloud compute
-0000eee0: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
-0000eef0: 2d2d 6669 6c74 6572 3d27 0a20 2020 2020  --filter='.     
-0000ef00: 2020 2066 2722 286c 6162 656c 732e 7261     f'"(labels.ra
-0000ef10: 792d 636c 7573 7465 722d 6e61 6d65 3a7b  y-cluster-name:{
-0000ef20: 6e61 6d65 7d20 414e 4420 6c61 6265 6c73  name} AND labels
-0000ef30: 2e72 6179 2d6e 6f64 652d 7479 7065 3d77  .ray-node-type=w
-0000ef40: 6f72 6b65 7229 2220 270a 2020 2020 2020  orker)" '.      
-0000ef50: 2020 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e    f'--zones={zon
-0000ef60: 657d 202d 2d66 6f72 6d61 743d 2276 616c  e} --format="val
-0000ef70: 7565 286e 616d 6529 2227 290a 2020 2020  ue(name)"').    
-0000ef80: 7465 726d 696e 6174 655f 636d 6420 3d20  terminate_cmd = 
-0000ef90: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
-0000efa0: 6520 696e 7374 616e 6365 7320 6465 6c65  e instances dele
-0000efb0: 7465 202d 2d7a 6f6e 653d 7b7a 6f6e 657d  te --zone={zone}
-0000efc0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000efd0: 2020 2020 2020 2066 2720 2d2d 7175 6965         f' --quie
-0000efe0: 7420 2428 7b71 7565 7279 5f63 6d64 7d29  t $({query_cmd})
-0000eff0: 2729 0a20 2020 2074 6573 7420 3d20 5465  ').    test = Te
-0000f000: 7374 280a 2020 2020 2020 2020 2773 706f  st(.        'spo
-0000f010: 745f 7265 636f 7665 7279 5f6d 756c 7469  t_recovery_multi
-0000f020: 5f6e 6f64 655f 6763 7027 2c0a 2020 2020  _node_gcp',.    
-0000f030: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0000f040: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-0000f050: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
-0000f060: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
-0000f070: 207b 6e61 6d65 7d20 2d2d 6e75 6d2d 6e6f   {name} --num-no
-0000f080: 6465 7320 3220 2265 6368 6f20 534b 5950  des 2 "echo SKYP
-0000f090: 494c 4f54 5f4a 4f42 5f49 443a 205c 2453  ILOT_JOB_ID: \$S
-0000f0a0: 4b59 5049 4c4f 545f 4a4f 425f 4944 3b20  KYPILOT_JOB_ID; 
-0000f0b0: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
-0000f0c0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-0000f0d0: 2027 736c 6565 7020 3430 3027 2c0a 2020   'sleep 400',.  
-0000f0e0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0000f0f0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0000f100: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0000f110: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0000f120: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0000f130: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-0000f140: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-0000f150: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-0000f160: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-0000f170: 494c 4f54 5f4a 4f42 5f49 4420 7c20 6375  ILOT_JOB_ID | cu
-0000f180: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
-0000f190: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
-0000f1a0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-0000f1b0: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
-0000f1c0: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
-0000f1d0: 6520 776f 726b 6572 206d 616e 7561 6c6c  e worker manuall
-0000f1e0: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
-0000f1f0: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
-0000f200: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000f210: 2035 3027 2c0a 2020 2020 2020 2020 2020   50',.          
-0000f220: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-0000f230: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-0000f240: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-0000f250: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
-0000f260: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0000f270: 2027 736c 6565 7020 3432 3027 2c0a 2020   'sleep 420',.  
-0000f280: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0000f290: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0000f2a0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0000f2b0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-0000f2c0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-0000f2d0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-0000f2e0: 2863 6174 202f 746d 702f 7b6e 616d 657d  (cat /tmp/{name}
-0000f2f0: 2d72 756e 2d69 6429 3b20 6563 686f 2024  -run-id); echo $
-0000f300: 5255 4e5f 4944 3b20 736b 7920 7370 6f74  RUN_ID; sky spot
-0000f310: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-0000f320: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-0000f330: 6570 2053 4b59 5049 4c4f 545f 4a4f 425f  ep SKYPILOT_JOB_
-0000f340: 4944 207c 2063 7574 202d 643a 202d 6632  ID | cut -d: -f2
-0000f350: 207c 2067 7265 7020 2224 5255 4e5f 4944   | grep "$RUN_ID
-0000f360: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
-0000f370: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
-0000f380: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
-0000f390: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
-0000f3a0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0000f3b0: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
-0000f3c0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000f3d0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000f3e0: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
-0000f3f0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
-0000f400: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
-0000f410: 5f63 616e 6365 6c6c 6174 696f 6e5f 6177  _cancellation_aw
-0000f420: 7328 6177 735f 636f 6e66 6967 5f72 6567  s(aws_config_reg
-0000f430: 696f 6e29 3a0a 2020 2020 6e61 6d65 203d  ion):.    name =
-0000f440: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000f450: 6d65 2829 0a20 2020 2072 6567 696f 6e20  me().    region 
-0000f460: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
-0000f470: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
-0000f480: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-0000f490: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
-0000f4a0: 6177 7327 2c0a 2020 2020 2020 2020 5b0a  aws',.        [.
-0000f4b0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-0000f4c0: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
-0000f4d0: 6475 7269 6e67 2073 706f 7420 636c 7573  during spot clus
-0000f4e0: 7465 7220 6265 696e 6720 6c61 756e 6368  ter being launch
-0000f4f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0000f500: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0000f510: 6820 2d2d 636c 6f75 6420 6177 7320 2d2d  h --cloud aws --
-0000f520: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0000f530: 2d6e 207b 6e61 6d65 7d20 2273 6c65 6570  -n {name} "sleep
-0000f540: 2031 3030 3022 2020 2d79 202d 6427 2c0a   1000"  -y -d',.
-0000f550: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000f560: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-0000f570: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0000f580: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0000f590: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-0000f5a0: 207c 2067 7265 7020 2253 5441 5254 494e   | grep "STARTIN
-0000f5b0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
-0000f5c0: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-0000f5d0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-0000f5e0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0000f5f0: 2020 2020 2020 2773 6c65 6570 2035 272c        'sleep 5',
-0000f600: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0000f610: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0000f620: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0000f630: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0000f640: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-0000f650: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-0000f660: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-0000f670: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000f680: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0000f690: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0000f6a0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0000f6b0: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
-0000f6c0: 2c0a 2020 2020 2020 2020 2020 2020 2866  ,.            (f
-0000f6d0: 2773 3d24 2861 7773 2065 6332 2064 6573  's=$(aws ec2 des
-0000f6e0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-0000f6f0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0000f700: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0000f710: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
-0000f720: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-0000f730: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
-0000f740: 616d 657d 2d2a 2027 0a20 2020 2020 2020  ame}-* '.       
-0000f750: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
-0000f760: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
-0000f770: 6e73 7461 6e63 6573 5b5d 2e53 7461 7465  nstances[].State
-0000f780: 5b5d 2e4e 616d 6520 270a 2020 2020 2020  [].Name '.      
-0000f790: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-0000f7a0: 2074 6578 7429 2026 2620 6563 686f 2022   text) && echo "
-0000f7b0: 2473 2220 2626 2065 6368 6f3b 205b 5b20  $s" && echo; [[ 
-0000f7c0: 2d7a 2022 2473 2220 5d5d 207c 7c20 5b5b  -z "$s" ]] || [[
-0000f7d0: 2022 2473 2220 3d20 2274 6572 6d69 6e61   "$s" = "termina
-0000f7e0: 7465 6422 205d 5d20 7c7c 205b 5b20 2224  ted" ]] || [[ "$
-0000f7f0: 7322 203d 2022 7368 7574 7469 6e67 2d64  s" = "shutting-d
-0000f800: 6f77 6e22 205d 5d27 0a20 2020 2020 2020  own" ]]'.       
-0000f810: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-0000f820: 2020 2020 2320 5465 7374 2063 616e 6365      # Test cance
-0000f830: 6c6c 696e 6720 7468 6520 7370 6f74 2063  lling the spot c
-0000f840: 6c75 7374 6572 2064 7572 696e 6720 7370  luster during sp
-0000f850: 6f74 206a 6f62 2062 6569 6e67 2073 6574  ot job being set
-0000f860: 7570 2e0a 2020 2020 2020 2020 2020 2020  up..            
-0000f870: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0000f880: 6820 2d2d 636c 6f75 6420 6177 7320 2d2d  h --cloud aws --
-0000f890: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0000f8a0: 2d6e 207b 6e61 6d65 7d2d 3220 7465 7374  -n {name}-2 test
-0000f8b0: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-0000f8c0: 745f 6c6f 6e67 5f73 6574 7570 2e79 616d  t_long_setup.yam
-0000f8d0: 6c20 202d 7920 2d64 272c 0a20 2020 2020  l  -y -d',.     
-0000f8e0: 2020 2020 2020 2027 736c 6565 7020 3330         'sleep 30
-0000f8f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0000f900: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0000f910: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0000f920: 653d 6627 7b6e 616d 657d 2d32 2729 2c0a  e=f'{name}-2'),.
-0000f930: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000f940: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0000f950: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0000f960: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0000f970: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
-0000f980: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0000f990: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-0000f9a0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000f9b0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0000f9c0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0000f9d0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0000f9e0: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
-0000f9f0: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
-0000fa00: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0000fa10: 2020 2020 2020 2020 2866 2773 3d24 2861          (f's=$(a
-0000fa20: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
-0000fa30: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
-0000fa40: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-0000fa50: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
-0000fa60: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
-0000fa70: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
-0000fa80: 2c56 616c 7565 733d 7b6e 616d 657d 2d32  ,Values={name}-2
-0000fa90: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
-0000faa0: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
-0000fab0: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
-0000fac0: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
-0000fad0: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
-0000fae0: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-0000faf0: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
-0000fb00: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
-0000fb10: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
-0000fb20: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
-0000fb30: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
-0000fb40: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
-0000fb50: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
-0000fb60: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-0000fb70: 2320 5465 7374 2063 616e 6365 6c6c 6174  # Test cancellat
-0000fb80: 696f 6e20 6475 7269 6e67 2073 706f 7420  ion during spot 
-0000fb90: 6a6f 6220 6973 2072 6563 6f76 6572 696e  job is recoverin
-0000fba0: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
-0000fbb0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-0000fbc0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-0000fbd0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-0000fbe0: 6e20 7b6e 616d 657d 2d33 2022 736c 6565  n {name}-3 "slee
-0000fbf0: 7020 3130 3030 2220 202d 7920 2d64 272c  p 1000"  -y -d',
-0000fc00: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000fc10: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
-0000fc20: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-0000fc30: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-0000fc40: 207b 6e61 6d65 7d2d 3320 7c20 6865 6164   {name}-3 | head
-0000fc50: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
-0000fc60: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-0000fc70: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
-0000fc80: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
-0000fc90: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
-0000fca0: 2020 2866 2761 7773 2065 6332 2074 6572    (f'aws ec2 ter
-0000fcb0: 6d69 6e61 7465 2d69 6e73 7461 6e63 6573  minate-instances
-0000fcc0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-0000fcd0: 6e7d 202d 2d69 6e73 7461 6e63 652d 6964  n} --instance-id
-0000fce0: 7320 2428 270a 2020 2020 2020 2020 2020  s $('.          
-0000fcf0: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
-0000fd00: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-0000fd10: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-0000fd20: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0000fd30: 2066 272d 2d66 696c 7465 7273 204e 616d   f'--filters Nam
-0000fd40: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
-0000fd50: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
-0000fd60: 616d 657d 2d33 2d2a 2027 0a20 2020 2020  ame}-3-* '.     
-0000fd70: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-0000fd80: 7920 5265 7365 7276 6174 696f 6e73 5b5d  y Reservations[]
-0000fd90: 2e49 6e73 7461 6e63 6573 5b5d 2e49 6e73  .Instances[].Ins
-0000fda0: 7461 6e63 6549 6420 270a 2020 2020 2020  tanceId '.      
-0000fdb0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-0000fdc0: 2074 6578 7429 2729 2c0a 2020 2020 2020   text)'),.      
-0000fdd0: 2020 2020 2020 2773 6c65 6570 2031 3230        'sleep 120
-0000fde0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000fdf0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0000fe00: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0000fe10: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0000fe20: 6772 6570 2022 5245 434f 5645 5249 4e47  grep "RECOVERING
-0000fe30: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-0000fe40: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0000fe50: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0000fe60: 653d 6627 7b6e 616d 657d 2d33 2729 2c0a  e=f'{name}-3'),.
-0000fe70: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-0000fe80: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
-0000fe90: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-0000fea0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-0000feb0: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
-0000fec0: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-0000fed0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
-0000fee0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0000fef0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0000ff00: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-0000ff10: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
-0000ff20: 6570 207b 6e61 6d65 7d2d 3320 7c20 6865  ep {name}-3 | he
-0000ff30: 6164 202d 6e31 207c 2067 7265 7020 2243  ad -n1 | grep "C
-0000ff40: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-0000ff50: 2020 2020 2020 2020 2320 5468 6520 636c          # The cl
-0000ff60: 7573 7465 7220 7368 6f75 6c64 2062 6520  uster should be 
-0000ff70: 7465 726d 696e 6174 6564 2028 7368 7574  terminated (shut
-0000ff80: 7469 6e67 2d64 6f77 6e29 2061 6674 6572  ting-down) after
-0000ff90: 2063 616e 6365 6c6c 6174 696f 6e2e 2057   cancellation. W
-0000ffa0: 6520 646f 6e27 7420 7573 6520 7468 6520  e don't use the 
-0000ffb0: 603d 6020 6f70 6572 6174 6f72 2068 6572  `=` operator her
-0000ffc0: 6520 6265 6361 7573 650a 2020 2020 2020  e because.      
-0000ffd0: 2020 2020 2020 2320 7468 6572 6520 6361        # there ca
-0000ffe0: 6e20 6265 206d 756c 7469 706c 6520 564d  n be multiple VM
-0000fff0: 2077 6974 6820 7468 6520 7361 6d65 206e   with the same n
-00010000: 616d 6520 6475 6520 746f 2074 6865 2072  ame due to the r
-00010010: 6563 6f76 6572 792e 0a20 2020 2020 2020  ecovery..       
-00010020: 2020 2020 2028 6627 733d 2428 6177 7320       (f's=$(aws 
-00010030: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
-00010040: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
-00010050: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
-00010060: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
-00010070: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
-00010080: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
-00010090: 6c75 6573 3d7b 6e61 6d65 7d2d 332d 2a20  lues={name}-3-* 
-000100a0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
-000100b0: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
-000100c0: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
-000100d0: 735b 5d2e 5374 6174 655b 5d2e 4e61 6d65  s[].State[].Name
-000100e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000100f0: 272d 2d6f 7574 7075 7420 7465 7874 2920  '--output text) 
-00010100: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-00010110: 6563 686f 3b20 5b5b 202d 7a20 2224 7322  echo; [[ -z "$s"
-00010120: 205d 5d20 7c7c 2065 6368 6f20 2224 7322   ]] || echo "$s"
-00010130: 207c 2067 7265 7020 2d76 202d 4520 2270   | grep -v -E "p
-00010140: 656e 6469 6e67 7c72 756e 6e69 6e67 7c73  ending|running|s
-00010150: 746f 7070 6564 7c73 746f 7070 696e 6722  topped|stopping"
-00010160: 270a 2020 2020 2020 2020 2020 2020 292c  '.            ),
-00010170: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00010180: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-00010190: 2036 3029 0a20 2020 2072 756e 5f6f 6e65   60).    run_one
-000101a0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-000101b0: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-000101c0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-000101d0: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-000101e0: 745f 7370 6f74 5f63 616e 6365 6c6c 6174  t_spot_cancellat
-000101f0: 696f 6e5f 6763 7028 293a 0a20 2020 206e  ion_gcp():.    n
-00010200: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00010210: 6572 5f6e 616d 6528 290a 2020 2020 7a6f  er_name().    zo
-00010220: 6e65 203d 2027 7573 2d77 6573 7433 2d62  ne = 'us-west3-b
-00010230: 270a 2020 2020 7175 6572 795f 7374 6174  '.    query_stat
-00010240: 655f 636d 6420 3d20 2827 6763 6c6f 7564  e_cmd = ('gcloud
-00010250: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-00010260: 6573 206c 6973 7420 270a 2020 2020 2020  es list '.      
-00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010280: 2066 272d 2d66 696c 7465 723d 2228 6c61   f'--filter="(la
-00010290: 6265 6c73 2e72 6179 2d63 6c75 7374 6572  bels.ray-cluster
-000102a0: 2d6e 616d 653a 7b6e 616d 657d 2922 2027  -name:{name})" '
-000102b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000102c0: 2020 2020 2020 2020 272d 2d66 6f72 6d61          '--forma
-000102d0: 743d 2276 616c 7565 2873 7461 7475 7329  t="value(status)
-000102e0: 2227 290a 2020 2020 7175 6572 795f 636d  "').    query_cm
-000102f0: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
-00010300: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-00010310: 6c69 7374 202d 2d66 696c 7465 723d 270a  list --filter='.
-00010320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010330: 2066 2722 286c 6162 656c 732e 7261 792d   f'"(labels.ray-
-00010340: 636c 7573 7465 722d 6e61 6d65 3a7b 6e61  cluster-name:{na
-00010350: 6d65 7d29 2220 270a 2020 2020 2020 2020  me})" '.        
-00010360: 2020 2020 2020 2020 2066 272d 2d7a 6f6e           f'--zon
-00010370: 6573 3d7b 7a6f 6e65 7d20 2d2d 666f 726d  es={zone} --form
-00010380: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
-00010390: 2729 0a20 2020 2074 6572 6d69 6e61 7465  ').    terminate
-000103a0: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
-000103b0: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
-000103c0: 6573 2064 656c 6574 6520 2d2d 7a6f 6e65  es delete --zone
-000103d0: 3d7b 7a6f 6e65 7d27 0a20 2020 2020 2020  ={zone}'.       
-000103e0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000103f0: 202d 2d71 7569 6574 2024 287b 7175 6572   --quiet $({quer
-00010400: 795f 636d 647d 2927 290a 2020 2020 7465  y_cmd})').    te
-00010410: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00010420: 2020 2027 7370 6f74 5f63 616e 6365 6c6c     'spot_cancell
-00010430: 6174 696f 6e5f 6763 7027 2c0a 2020 2020  ation_gcp',.    
-00010440: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00010450: 2020 2320 5465 7374 2063 616e 6365 6c6c    # Test cancell
-00010460: 6174 696f 6e20 6475 7269 6e67 2073 706f  ation during spo
-00010470: 7420 636c 7573 7465 7220 6265 696e 6720  t cluster being 
-00010480: 6c61 756e 6368 6564 2e0a 2020 2020 2020  launched..      
-00010490: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-000104a0: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
-000104b0: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
-000104c0: 7d20 2d6e 207b 6e61 6d65 7d20 2273 6c65  } -n {name} "sle
-000104d0: 6570 2031 3030 3022 2020 2d79 202d 6427  ep 1000"  -y -d'
-000104e0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-000104f0: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
-00010500: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00010510: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00010520: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-00010530: 6e31 207c 2067 7265 7020 2253 5441 5254  n1 | grep "START
-00010540: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00010550: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00010560: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00010570: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-00010580: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00010590: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000105a0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-000105b0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-000105c0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-000105d0: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-000105e0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-000105f0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00010600: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-00010610: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00010620: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00010630: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00010640: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-00010650: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00010660: 2320 5465 7374 2063 616e 6365 6c6c 696e  # Test cancellin
-00010670: 6720 7468 6520 7370 6f74 2063 6c75 7374  g the spot clust
-00010680: 6572 2064 7572 696e 6720 7370 6f74 206a  er during spot j
-00010690: 6f62 2062 6569 6e67 2073 6574 7570 2e0a  ob being setup..
-000106a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000106b0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
-000106c0: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
-000106d0: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
-000106e0: 7d2d 3220 7465 7374 732f 7465 7374 5f79  }-2 tests/test_y
-000106f0: 616d 6c73 2f74 6573 745f 6c6f 6e67 5f73  amls/test_long_s
-00010700: 6574 7570 2e79 616d 6c20 202d 7920 2d64  etup.yaml  -y -d
-00010710: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-00010720: 736c 6565 7020 3330 3027 2c0a 2020 2020  sleep 300',.    
-00010730: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
-00010740: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
-00010750: 286a 6f62 5f6e 616d 653d 6627 7b6e 616d  (job_name=f'{nam
-00010760: 657d 2d32 2729 2c0a 2020 2020 2020 2020  e}-2'),.        
-00010770: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-00010780: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00010790: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-000107a0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
-000107b0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-000107c0: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
-000107d0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
-000107e0: 2020 2020 2020 2027 736c 6565 7020 3132         'sleep 12
-000107f0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-00010800: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00010810: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00010820: 7d2d 3220 7c20 6865 6164 202d 6e31 207c  }-2 | head -n1 |
-00010830: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-00010840: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00010850: 2320 5465 7374 2063 616e 6365 6c6c 6174  # Test cancellat
-00010860: 696f 6e20 6475 7269 6e67 2073 706f 7420  ion during spot 
-00010870: 6a6f 6220 6973 2072 6563 6f76 6572 696e  job is recoverin
-00010880: 672e 0a20 2020 2020 2020 2020 2020 2066  g..            f
-00010890: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-000108a0: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
-000108b0: 6f6e 6520 7b7a 6f6e 657d 202d 6e20 7b6e  one {zone} -n {n
-000108c0: 616d 657d 2d33 2022 736c 6565 7020 3130  ame}-3 "sleep 10
-000108d0: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
-000108e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000108f0: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
-00010900: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00010910: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00010920: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
-00010930: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
-00010940: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00010950: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
-00010960: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
-00010970: 2e0a 2020 2020 2020 2020 2020 2020 7465  ..            te
-00010980: 726d 696e 6174 655f 636d 642c 0a20 2020  rminate_cmd,.   
-00010990: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-000109a0: 3130 3027 2c0a 2020 2020 2020 2020 2020  100',.          
-000109b0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000109c0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000109d0: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
-000109e0: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
-000109f0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00010a00: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-00010a10: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-00010a20: 6e61 6d65 3d66 277b 6e61 6d65 7d2d 3327  name=f'{name}-3'
-00010a30: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-00010a40: 736c 6565 7020 3527 2c0a 2020 2020 2020  sleep 5',.      
-00010a50: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00010a60: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00010a70: 207b 6e61 6d65 7d2d 3320 7c20 6865 6164   {name}-3 | head
-00010a80: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
-00010a90: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
-00010aa0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-00010ab0: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
-00010ac0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00010ad0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-00010ae0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-00010af0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00010b00: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-00010b10: 2020 2020 2020 2020 2020 2023 2054 6865             # The
-00010b20: 2063 6c75 7374 6572 2073 686f 756c 6420   cluster should 
-00010b30: 6265 2074 6572 6d69 6e61 7465 6420 2853  be terminated (S
-00010b40: 544f 5050 494e 4729 2061 6674 6572 2063  TOPPING) after c
-00010b50: 616e 6365 6c6c 6174 696f 6e2e 2057 6520  ancellation. We 
-00010b60: 646f 6e27 7420 7573 6520 7468 6520 603d  don't use the `=
-00010b70: 6020 6f70 6572 6174 6f72 2068 6572 6520  ` operator here 
-00010b80: 6265 6361 7573 650a 2020 2020 2020 2020  because.        
-00010b90: 2020 2020 2320 7468 6572 6520 6361 6e20      # there can 
-00010ba0: 6265 206d 756c 7469 706c 6520 564d 2077  be multiple VM w
-00010bb0: 6974 6820 7468 6520 7361 6d65 206e 616d  ith the same nam
-00010bc0: 6520 6475 6520 746f 2074 6865 2072 6563  e due to the rec
-00010bd0: 6f76 6572 792e 0a20 2020 2020 2020 2020  overy..         
-00010be0: 2020 2028 6627 733d 2428 7b71 7565 7279     (f's=$({query
-00010bf0: 5f73 7461 7465 5f63 6d64 7d29 2026 2620  _state_cmd}) && 
-00010c00: 6563 686f 2022 2473 2220 2626 2065 6368  echo "$s" && ech
-00010c10: 6f3b 205b 5b20 2d7a 2022 2473 2220 5d5d  o; [[ -z "$s" ]]
-00010c20: 207c 7c20 6563 686f 2022 2473 2220 7c20   || echo "$s" | 
-00010c30: 6772 6570 202d 7620 2d45 2022 5052 4f56  grep -v -E "PROV
-00010c40: 4953 494f 4e49 4e47 7c53 5441 4749 4e47  ISIONING|STAGING
-00010c50: 7c52 554e 4e49 4e47 7c52 4550 4149 5249  |RUNNING|REPAIRI
-00010c60: 4e47 7c54 4552 4d49 4e41 5445 447c 5355  NG|TERMINATED|SU
-00010c70: 5350 454e 4449 4e47 7c53 5553 5045 4e44  SPENDING|SUSPEND
-00010c80: 4544 7c53 5553 5045 4e44 4544 2227 0a20  ED|SUSPENDED"'. 
-00010c90: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
-00010ca0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00010cb0: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
-00010cc0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00010cd0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
-00010ce0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
-00010cf0: 7374 6f72 6167 6520 666f 7220 6d61 6e61  storage for mana
-00010d00: 6765 6420 7370 6f74 202d 2d2d 2d2d 2d2d  ged spot -------
-00010d10: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-00010d20: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00010d30: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-00010d40: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00010d50: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00010d60: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00010d70: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-00010d80: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-00010d90: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00010da0: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
-00010db0: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
-00010dc0: 7465 7374 5f73 706f 745f 7374 6f72 6167  test_spot_storag
-00010dd0: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-00010de0: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00010df0: 7374 2073 746f 7261 6765 2077 6974 6820  st storage with 
-00010e00: 6d61 6e61 6765 6420 7370 6f74 2222 220a  managed spot""".
-00010e10: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00010e20: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00010e30: 2020 2079 616d 6c5f 7374 7220 3d20 7061     yaml_str = pa
-00010e40: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
-00010e50: 2020 2020 2765 7861 6d70 6c65 732f 6d61      'examples/ma
-00010e60: 6e61 6765 645f 7370 6f74 5f77 6974 685f  naged_spot_with_
-00010e70: 7374 6f72 6167 652e 7961 6d6c 2729 2e72  storage.yaml').r
-00010e80: 6561 645f 7465 7874 2829 0a20 2020 2073  ead_text().    s
-00010e90: 746f 7261 6765 5f6e 616d 6520 3d20 6627  torage_name = f'
-00010ea0: 736b 792d 7465 7374 2d7b 696e 7428 7469  sky-test-{int(ti
-00010eb0: 6d65 2e74 696d 6528 2929 7d27 0a20 2020  me.time())}'.   
-00010ec0: 2079 616d 6c5f 7374 7220 3d20 7961 6d6c   yaml_str = yaml
-00010ed0: 5f73 7472 2e72 6570 6c61 6365 2827 736b  _str.replace('sk
-00010ee0: 792d 776f 726b 6469 722d 7a68 7775 272c  y-workdir-zhwu',
-00010ef0: 2073 746f 7261 6765 5f6e 616d 6529 0a20   storage_name). 
-00010f00: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
-00010f10: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
-00010f20: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
-00010f30: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
-00010f40: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
-00010f50: 6974 6528 7961 6d6c 5f73 7472 290a 2020  ite(yaml_str).  
-00010f60: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
-00010f70: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
-00010f80: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
-00010f90: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00010fa0: 2020 2020 2020 2020 2020 2020 2773 706f              'spo
-00010fb0: 745f 7374 6f72 6167 6527 2c0a 2020 2020  t_storage',.    
-00010fc0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00010fd0: 2020 2020 2020 2020 2020 2a73 746f 7261            *stora
-00010fe0: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
-00010ff0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00011000: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-00011010: 756e 6368 202d 6e20 7b6e 616d 657d 202d  unch -n {name} -
-00011020: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00011030: 636c 6f75 647d 207b 6669 6c65 5f70 6174  cloud} {file_pat
-00011040: 687d 202d 7927 2c0a 2020 2020 2020 2020  h} -y',.        
-00011050: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
-00011060: 3027 2c20 2023 2057 6169 7420 7468 6520  0',  # Wait the 
-00011070: 7370 6f74 2071 7565 7565 2074 6f20 6265  spot queue to be
-00011080: 2075 7064 6174 6564 0a20 2020 2020 2020   updated.       
-00011090: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-000110a0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-000110b0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-000110c0: 7020 5355 4343 4545 4445 4427 2c0a 2020  p SUCCEEDED',.  
-000110d0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000110e0: 5b20 2428 6177 7320 7333 6170 6920 6c69  [ $(aws s3api li
-000110f0: 7374 2d62 7563 6b65 7473 202d 2d71 7565  st-buckets --que
-00011100: 7279 2022 4275 636b 6574 735b 3f63 6f6e  ry "Buckets[?con
-00011110: 7461 696e 7328 4e61 6d65 2c20 5c27 7b73  tains(Name, \'{s
-00011120: 746f 7261 6765 5f6e 616d 657d 5c27 295d  torage_name}\')]
-00011130: 2e4e 616d 6522 202d 2d6f 7574 7075 7420  .Name" --output 
-00011140: 7465 7874 207c 2077 6320 2d6c 2920 2d65  text | wc -l) -e
-00011150: 7120 3020 5d27 0a20 2020 2020 2020 2020  q 0 ]'.         
-00011160: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-00011170: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00011180: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00011190: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-000111a0: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
-000111b0: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
-000111c0: 736b 7920 7370 6f74 2071 7565 7565 202d  sky spot queue -
-000111d0: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
-000111e0: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
-000111f0: 6573 7473 2e0a 2020 2020 2020 2020 2020  ests..          
-00011200: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-00011210: 302c 0a20 2020 2020 2020 2029 0a20 2020  0,.        ).   
-00011220: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
-00011230: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00011240: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2073  ------ Testing s
-00011250: 706f 7420 5450 5520 2d2d 2d2d 2d2d 2d2d  pot TPU --------
-00011260: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00011270: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-00011280: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
-00011290: 6620 7465 7374 5f73 706f 745f 7470 7528  f test_spot_tpu(
-000112a0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
-000112b0: 616e 6167 6564 2073 706f 7420 6f6e 2054  anaged spot on T
-000112c0: 5055 2e22 2222 0a20 2020 206e 616d 6520  PU.""".    name 
-000112d0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000112e0: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-000112f0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00011300: 7465 7374 2d73 706f 742d 7470 7527 2c0a  test-spot-tpu',.
-00011310: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00011320: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-00011330: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
-00011340: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
-00011350: 7075 766d 5f6d 6e69 7374 2e79 616d 6c20  puvm_mnist.yaml 
-00011360: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00011370: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
-00011380: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00011390: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-000113a0: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
-000113b0: 6561 6420 2d6e 3120 7c20 6772 6570 2053  ead -n1 | grep S
-000113c0: 5441 5254 494e 4727 2c0a 2020 2020 2020  TARTING',.      
-000113d0: 2020 2020 2020 2773 6c65 6570 2036 3030        'sleep 600
-000113e0: 272c 2020 2320 5450 5520 7461 6b65 7320  ',  # TPU takes 
-000113f0: 6120 7768 696c 6520 746f 206c 6175 6e63  a while to launc
-00011400: 680a 2020 2020 2020 2020 2020 2020 6627  h.            f'
-00011410: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00011420: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
-00011430: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00011440: 7020 2252 554e 4e49 4e47 5c7c 5355 4343  p "RUNNING\|SUCC
-00011450: 4545 4445 4422 272c 0a20 2020 2020 2020  EEDED"',.       
-00011460: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-00011470: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-00011480: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-00011490: 6d65 292c 0a20 2020 2020 2020 2023 2049  me),.        # I
-000114a0: 6e63 7265 6173 6520 7469 6d65 6f75 7420  ncrease timeout 
-000114b0: 7369 6e63 6520 736b 7920 7370 6f74 2071  since sky spot q
-000114c0: 7565 7565 202d 7220 6361 6e20 6265 2062  ueue -r can be b
-000114d0: 6c6f 636b 6564 2062 7920 6f74 6865 7220  locked by other 
-000114e0: 7370 6f74 2074 6573 7473 2e0a 2020 2020  spot tests..    
-000114f0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
-00011500: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00011510: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00011520: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00011530: 2054 6573 7469 6e67 2065 6e76 2066 6f72   Testing env for
-00011540: 2073 706f 7420 2d2d 2d2d 2d2d 2d2d 2d2d   spot ----------
-00011550: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00011560: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
-00011570: 204c 616d 6264 6120 436c 6f75 6420 646f   Lambda Cloud do
-00011580: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00011590: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-000115a0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6962  ytest.mark.no_ib
-000115b0: 6d20 2023 2049 424d 2043 6c6f 7564 2064  m  # IBM Cloud d
-000115c0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-000115d0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-000115e0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-000115f0: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-00011600: 745f 7370 6f74 5f69 6e6c 696e 655f 656e  t_spot_inline_en
-00011610: 7628 6765 6e65 7269 635f 636c 6f75 643a  v(generic_cloud:
-00011620: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00011630: 7374 2073 706f 7420 656e 7622 2222 0a20  st spot env""". 
-00011640: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00011650: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00011660: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00011670: 2020 2020 2020 2027 7465 7374 2d73 706f         'test-spo
-00011680: 742d 696e 6c69 6e65 2d65 6e76 272c 0a20  t-inline-env',. 
-00011690: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000116a0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-000116b0: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-000116c0: 202d 7920 2d2d 636c 6f75 6420 7b67 656e   -y --cloud {gen
-000116d0: 6572 6963 5f63 6c6f 7564 7d20 2d2d 656e  eric_cloud} --en
-000116e0: 7620 5445 5354 5f45 4e56 3d22 6865 6c6c  v TEST_ENV="hell
-000116f0: 6f20 776f 726c 6422 202d 2d20 2228 5b5b  o world" -- "([[
-00011700: 2021 202d 7a20 5c5c 225c 2454 4553 545f   ! -z \\"\$TEST_
-00011710: 454e 565c 5c22 205d 5d20 2626 205b 5b20  ENV\\" ]] && [[ 
-00011720: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
-00011730: 4f54 5f4e 4f44 455f 4950 535c 5c22 205d  OT_NODE_IPS\\" ]
-00011740: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
-00011750: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
-00011760: 5241 4e4b 5c5c 2220 5d5d 2920 7c7c 2065  RANK\\" ]]) || e
-00011770: 7869 7420 3122 272c 0a20 2020 2020 2020  xit 1"',.       
-00011780: 2020 2020 2027 736c 6565 7020 3230 272c       'sleep 20',
-00011790: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-000117a0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-000117b0: 7d20 7c20 6772 6570 207b 6e61 6d65 7d20  } | grep {name} 
-000117c0: 7c20 6772 6570 2053 5543 4345 4544 4544  | grep SUCCEEDED
-000117d0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-000117e0: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
-000117f0: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-00011800: 6f62 5f6e 616d 653d 6e61 6d65 292c 0a20  ob_name=name),. 
-00011810: 2020 2020 2020 2023 2049 6e63 7265 6173         # Increas
-00011820: 6520 7469 6d65 6f75 7420 7369 6e63 6520  e timeout since 
-00011830: 736b 7920 7370 6f74 2071 7565 7565 202d  sky spot queue -
-00011840: 7220 6361 6e20 6265 2062 6c6f 636b 6564  r can be blocked
-00011850: 2062 7920 6f74 6865 7220 7370 6f74 2074   by other spot t
-00011860: 6573 7473 2e0a 2020 2020 2020 2020 7469  ests..        ti
-00011870: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00011880: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00011890: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-000118a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-000118b0: 6e67 2065 6e76 202d 2d2d 2d2d 2d2d 2d2d  ng env ---------
-000118c0: 2d0a 6465 6620 7465 7374 5f69 6e6c 696e  -.def test_inlin
-000118d0: 655f 656e 7628 6765 6e65 7269 635f 636c  e_env(generic_cl
-000118e0: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-000118f0: 2222 5465 7374 2065 6e76 2222 220a 2020  ""Test env""".  
-00011900: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00011910: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00011920: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00011930: 2020 2020 2020 2774 6573 742d 696e 6c69        'test-inli
-00011940: 6e65 2d65 6e76 272c 0a20 2020 2020 2020  ne-env',.       
-00011950: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00011960: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
-00011970: 6e61 6d65 7d20 2d79 202d 2d63 6c6f 7564  name} -y --cloud
-00011980: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00011990: 202d 2d65 6e76 2054 4553 545f 454e 563d   --env TEST_ENV=
-000119a0: 2268 656c 6c6f 2077 6f72 6c64 2220 2d2d  "hello world" --
-000119b0: 2022 285b 5b20 2120 2d7a 205c 5c22 5c24   "([[ ! -z \\"\$
-000119c0: 5445 5354 5f45 4e56 5c5c 2220 5d5d 2026  TEST_ENV\\" ]] &
-000119d0: 2620 5b5b 2021 202d 7a20 5c5c 225c 2453  & [[ ! -z \\"\$S
-000119e0: 4b59 5049 4c4f 545f 4e4f 4445 5f49 5053  KYPILOT_NODE_IPS
-000119f0: 5c5c 2220 5d5d 2026 2620 5b5b 2021 202d  \\" ]] && [[ ! -
-00011a00: 7a20 5c5c 225c 2453 4b59 5049 4c4f 545f  z \\"\$SKYPILOT_
-00011a10: 4e4f 4445 5f52 414e 4b5c 5c22 205d 5d29  NODE_RANK\\" ]])
-00011a20: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
-00011a30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00011a40: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00011a50: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00011a60: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00011a70: 7b6e 616d 657d 202d 2d65 6e76 2054 4553  {name} --env TES
-00011a80: 545f 454e 5632 3d22 7375 6363 6573 7322  T_ENV2="success"
-00011a90: 2022 285b 5b20 2120 2d7a 205c 5c22 5c24   "([[ ! -z \\"\$
-00011aa0: 5445 5354 5f45 4e56 325c 5c22 205d 5d20  TEST_ENV2\\" ]] 
-00011ab0: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
-00011ac0: 534b 5950 494c 4f54 5f4e 4f44 455f 4950  SKYPILOT_NODE_IP
-00011ad0: 535c 5c22 205d 5d20 2626 205b 5b20 2120  S\\" ]] && [[ ! 
-00011ae0: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
-00011af0: 5f4e 4f44 455f 5241 4e4b 5c5c 2220 5d5d  _NODE_RANK\\" ]]
-00011b00: 2920 7c7c 2065 7869 7420 3122 272c 0a20  ) || exit 1"',. 
-00011b10: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00011b20: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-00011b30: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00011b40: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00011b50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00011b60: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00011b70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00011b80: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00011b90: 5465 7374 696e 6720 6375 7374 6f6d 2069  Testing custom i
-00011ba0: 6d61 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a  mage ----------.
-00011bb0: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-00011bc0: 0a64 6566 2074 6573 745f 6375 7374 6f6d  .def test_custom
-00011bd0: 5f69 6d61 6765 2829 3a0a 2020 2020 2222  _image():.    ""
-00011be0: 2254 6573 7420 6375 7374 6f6d 2069 6d61  "Test custom ima
-00011bf0: 6765 2222 220a 2020 2020 6e61 6d65 203d  ge""".    name =
-00011c00: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00011c10: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00011c20: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-00011c30: 6573 742d 6375 7374 6f6d 2d69 6d61 6765  est-custom-image
-00011c40: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00011c50: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00011c60: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
-00011c70: 2d2d 7265 7472 792d 756e 7469 6c2d 7570  --retry-until-up
-00011c80: 202d 7920 6578 616d 706c 6573 2f63 7573   -y examples/cus
-00011c90: 746f 6d5f 696d 6167 652e 7961 6d6c 272c  tom_image.yaml',
-00011ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00011cb0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00011cc0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00011cd0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00011ce0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00011cf0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-00011d00: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
-00011d10: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00011d20: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00011d30: 7974 6573 742e 6d61 726b 2e73 6c6f 770a  ytest.mark.slow.
-00011d40: 6465 6620 7465 7374 5f61 7a75 7265 5f73  def test_azure_s
-00011d50: 7461 7274 5f73 746f 705f 7477 6f5f 6e6f  tart_stop_two_no
-00011d60: 6465 7328 293a 0a20 2020 206e 616d 6520  des():.    name 
-00011d70: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00011d80: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00011d90: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00011da0: 617a 7572 652d 7374 6172 742d 7374 6f70  azure-start-stop
-00011db0: 2d74 776f 2d6e 6f64 6573 272c 0a20 2020  -two-nodes',.   
-00011dc0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-00011dd0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00011de0: 2d2d 6e75 6d2d 6e6f 6465 733d 3220 2d79  --num-nodes=2 -y
-00011df0: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
-00011e00: 6c65 732f 617a 7572 655f 7374 6172 745f  les/azure_start_
-00011e10: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
-00011e20: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00011e30: 6563 202d 2d6e 756d 2d6e 6f64 6573 3d32  ec --num-nodes=2
-00011e40: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
-00011e50: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
-00011e60: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-00011e70: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00011e80: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00011e90: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00011ea0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00011eb0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00011ec0: 6b79 2073 746f 7020 2d79 207b 6e61 6d65  ky stop -y {name
-00011ed0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00011ee0: 6627 736b 7920 7374 6172 7420 2d79 207b  f'sky start -y {
-00011ef0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-00011f00: 2020 2020 6627 736b 7920 6578 6563 202d      f'sky exec -
-00011f10: 2d6e 756d 2d6e 6f64 6573 3d32 207b 6e61  -num-nodes=2 {na
-00011f20: 6d65 7d20 6578 616d 706c 6573 2f61 7a75  me} examples/azu
-00011f30: 7265 5f73 7461 7274 5f73 746f 702e 7961  re_start_stop.ya
-00011f40: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00011f50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00011f60: 657d 2032 202d 2d73 7461 7475 7327 2c20  e} 2 --status', 
-00011f70: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00011f80: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00011f90: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00011fa0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00011fb0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-00011fc0: 696d 656f 7574 3d33 3020 2a20 3630 2c20  imeout=30 * 60, 
-00011fd0: 2023 2033 3020 6d69 6e73 2020 2869 7420   # 30 mins  (it 
-00011fe0: 7461 6b65 7320 6172 6f75 6e64 207e 3233  takes around ~23
-00011ff0: 206d 696e 7329 0a20 2020 2029 0a20 2020   mins).    ).   
-00012000: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00012010: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00012020: 2d2d 2054 6573 7469 6e67 2065 6e76 2066  -- Testing env f
-00012030: 6f72 2064 6973 6b20 7469 6572 202d 2d2d  or disk tier ---
-00012040: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00012050: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00012060: 745f 6177 735f 6469 736b 5f74 6965 7228  t_aws_disk_tier(
-00012070: 293a 0a0a 2020 2020 6465 6620 5f67 6574  ):..    def _get
-00012080: 5f61 7773 5f71 7565 7279 5f63 6f6d 6d61  _aws_query_comma
-00012090: 6e64 2872 6567 696f 6e2c 2069 6e73 7461  nd(region, insta
-000120a0: 6e63 655f 6964 2c20 6669 656c 642c 2065  nce_id, field, e
-000120b0: 7870 6563 7465 6429 3a0a 2020 2020 2020  xpected):.      
-000120c0: 2020 7265 7475 726e 2028 6627 6177 7320    return (f'aws 
-000120d0: 6563 3220 6465 7363 7269 6265 2d76 6f6c  ec2 describe-vol
-000120e0: 756d 6573 202d 2d72 6567 696f 6e20 7b72  umes --region {r
-000120f0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00012100: 2020 2020 2020 2020 2066 272d 2d66 696c           f'--fil
-00012110: 7465 7273 204e 616d 653d 6174 7461 6368  ters Name=attach
-00012120: 6d65 6e74 2e69 6e73 7461 6e63 652d 6964  ment.instance-id
-00012130: 2c56 616c 7565 733d 7b69 6e73 7461 6e63  ,Values={instanc
-00012140: 655f 6964 7d20 270a 2020 2020 2020 2020  e_id} '.        
-00012150: 2020 2020 2020 2020 6627 2d2d 7175 6572          f'--quer
-00012160: 7920 566f 6c75 6d65 735b 2a5d 2e7b 6669  y Volumes[*].{fi
-00012170: 656c 647d 207c 2067 7265 7020 7b65 7870  eld} | grep {exp
-00012180: 6563 7465 647d 203b 2027 290a 0a20 2020  ected} ; ')..   
-00012190: 2066 6f72 2064 6973 6b5f 7469 6572 2069   for disk_tier i
-000121a0: 6e20 5b27 6c6f 7727 2c20 276d 6564 6975  n ['low', 'mediu
-000121b0: 6d27 2c20 2768 6967 6827 5d3a 0a20 2020  m', 'high']:.   
-000121c0: 2020 2020 2073 7065 6373 203d 2041 5753       specs = AWS
-000121d0: 2e5f 6765 745f 6469 736b 5f73 7065 6373  ._get_disk_specs
-000121e0: 2864 6973 6b5f 7469 6572 290a 2020 2020  (disk_tier).    
-000121f0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00012200: 636c 7573 7465 725f 6e61 6d65 2829 202b  cluster_name() +
-00012210: 2027 2d27 202b 2064 6973 6b5f 7469 6572   '-' + disk_tier
-00012220: 0a20 2020 2020 2020 2072 6567 696f 6e20  .        region 
-00012230: 3d20 2775 732d 7765 7374 2d32 270a 2020  = 'us-west-2'.  
-00012240: 2020 2020 2020 7465 7374 203d 2054 6573        test = Tes
-00012250: 7428 0a20 2020 2020 2020 2020 2020 2027  t(.            '
-00012260: 6177 732d 6469 736b 2d74 6965 7227 2c0a  aws-disk-tier',.
-00012270: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
-00012280: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00012290: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-000122a0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000122b0: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
-000122c0: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
-000122d0: 2020 2020 2020 2020 6627 2d2d 6469 736b          f'--disk
-000122e0: 2d74 6965 7220 7b64 6973 6b5f 7469 6572  -tier {disk_tier
-000122f0: 7d20 6563 686f 2022 6865 6c6c 6f20 736b  } echo "hello sk
-00012300: 7922 272c 0a20 2020 2020 2020 2020 2020  y"',.           
-00012310: 2020 2020 2066 2769 643d 6061 7773 2065       f'id=`aws e
-00012320: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
-00012330: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
-00012340: 7265 6769 6f6e 7d20 2d2d 6669 6c74 6572  region} --filter
-00012350: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
-00012360: 2020 2020 6627 4e61 6d65 3d74 6167 3a72      f'Name=tag:r
-00012370: 6179 2d63 6c75 7374 6572 2d6e 616d 652c  ay-cluster-name,
-00012380: 5661 6c75 6573 3d7b 6e61 6d65 7d20 2d2d  Values={name} --
-00012390: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
-000123a0: 2020 2020 2020 2020 6627 5265 7365 7276          f'Reserv
-000123b0: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
-000123c0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
-000123d0: 2d2d 6f75 7470 7574 2074 6578 7460 3b20  --output text`; 
-000123e0: 2720 2b0a 2020 2020 2020 2020 2020 2020  ' +.            
-000123f0: 2020 2020 5f67 6574 5f61 7773 5f71 7565      _get_aws_que
-00012400: 7279 5f63 6f6d 6d61 6e64 2872 6567 696f  ry_command(regio
-00012410: 6e2c 2027 2469 6427 2c20 2756 6f6c 756d  n, '$id', 'Volum
-00012420: 6554 7970 6527 2c0a 2020 2020 2020 2020  eType',.        
-00012430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012440: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00012450: 7065 6373 5b27 6469 736b 5f74 6965 7227  pecs['disk_tier'
-00012460: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
-00012470: 2020 2020 2028 2727 2069 6620 6469 736b       ('' if disk
-00012480: 5f74 6965 7220 3d3d 2027 6c6f 7727 2065  _tier == 'low' e
-00012490: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-000124a0: 2020 2020 2028 5f67 6574 5f61 7773 5f71       (_get_aws_q
-000124b0: 7565 7279 5f63 6f6d 6d61 6e64 2872 6567  uery_command(reg
-000124c0: 696f 6e2c 2027 2469 6427 2c20 2749 6f70  ion, '$id', 'Iop
-000124d0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000124e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124f0: 2020 2020 2020 2020 2020 2020 2073 7065               spe
-00012500: 6373 5b27 6469 736b 5f69 6f70 7327 5d29  cs['disk_iops'])
-00012510: 202b 0a20 2020 2020 2020 2020 2020 2020   +.             
-00012520: 2020 2020 205f 6765 745f 6177 735f 7175       _get_aws_qu
-00012530: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
-00012540: 6f6e 2c20 2724 6964 272c 2027 5468 726f  on, '$id', 'Thro
-00012550: 7567 6870 7574 272c 0a20 2020 2020 2020  ughput',.       
-00012560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012580: 2020 7370 6563 735b 2764 6973 6b5f 7468    specs['disk_th
-00012590: 726f 7567 6870 7574 275d 2929 292c 0a20  roughput']))),. 
-000125a0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-000125b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000125c0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-000125d0: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-000125e0: 656f 7574 3d31 3020 2a20 3630 2c20 2023  eout=10 * 60,  #
-000125f0: 2031 3020 6d69 6e73 2020 2869 7420 7461   10 mins  (it ta
-00012600: 6b65 7320 6172 6f75 6e64 207e 3620 6d69  kes around ~6 mi
-00012610: 6e73 290a 2020 2020 2020 2020 290a 2020  ns).        ).  
-00012620: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
-00012630: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00012640: 7374 2e6d 6172 6b2e 6763 700a 6465 6620  st.mark.gcp.def 
-00012650: 7465 7374 5f67 6370 5f64 6973 6b5f 7469  test_gcp_disk_ti
-00012660: 6572 2829 3a0a 2020 2020 666f 7220 6469  er():.    for di
-00012670: 736b 5f74 6965 7220 696e 205b 276c 6f77  sk_tier in ['low
-00012680: 272c 2027 6d65 6469 756d 272c 2027 6869  ', 'medium', 'hi
-00012690: 6768 275d 3a0a 2020 2020 2020 2020 7479  gh']:.        ty
-000126a0: 7065 203d 2047 4350 2e5f 6765 745f 6469  pe = GCP._get_di
-000126b0: 736b 5f74 7970 6528 6469 736b 5f74 6965  sk_type(disk_tie
-000126c0: 7229 0a20 2020 2020 2020 206e 616d 6520  r).        name 
-000126d0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-000126e0: 616d 6528 2920 2b20 272d 2720 2b20 6469  ame() + '-' + di
-000126f0: 736b 5f74 6965 720a 2020 2020 2020 2020  sk_tier.        
-00012700: 7265 6769 6f6e 203d 2027 7573 2d77 6573  region = 'us-wes
-00012710: 7432 270a 2020 2020 2020 2020 7465 7374  t2'.        test
-00012720: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00012730: 2020 2020 2027 6763 702d 6469 736b 2d74       'gcp-disk-t
-00012740: 6965 7227 2c0a 2020 2020 2020 2020 2020  ier',.          
-00012750: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00012760: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00012770: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00012780: 636c 6f75 6420 6763 7020 2d2d 7265 6769  cloud gcp --regi
-00012790: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
-000127a0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000127b0: 2d2d 6469 736b 2d74 6965 7220 7b64 6973  --disk-tier {dis
-000127c0: 6b5f 7469 6572 7d20 6563 686f 2022 6865  k_tier} echo "he
-000127d0: 6c6c 6f20 736b 7922 272c 0a20 2020 2020  llo sky"',.     
-000127e0: 2020 2020 2020 2020 2020 2066 276e 616d             f'nam
-000127f0: 653d 6067 636c 6f75 6420 636f 6d70 7574  e=`gcloud comput
-00012800: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
-00012810: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
-00012820: 2020 2020 2020 2020 2020 2020 6627 226c              f'"l
-00012830: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
-00012840: 722d 6e61 6d65 3a7b 6e61 6d65 7d22 202d  r-name:{name}" -
-00012850: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
-00012860: 616d 6529 2260 3b20 270a 2020 2020 2020  ame)"`; '.      
-00012870: 2020 2020 2020 2020 2020 6627 6763 6c6f            f'gclo
-00012880: 7564 2063 6f6d 7075 7465 2064 6973 6b73  ud compute disks
-00012890: 206c 6973 7420 2d2d 6669 6c74 6572 3d22   list --filter="
-000128a0: 6e61 6d65 3d24 6e61 6d65 2220 270a 2020  name=$name" '.  
-000128b0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-000128c0: 2d2d 666f 726d 6174 3d22 7661 6c75 6528  --format="value(
-000128d0: 7479 7065 2922 207c 2067 7265 7020 7b74  type)" | grep {t
-000128e0: 7970 657d 2027 0a20 2020 2020 2020 2020  ype} '.         
-000128f0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-00012900: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00012910: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-00012920: 2020 2020 2074 696d 656f 7574 3d36 202a       timeout=6 *
-00012930: 2036 302c 2020 2320 3620 6d69 6e73 2020   60,  # 6 mins  
-00012940: 2869 7420 7461 6b65 7320 6172 6f75 6e64  (it takes around
-00012950: 207e 3320 6d69 6e73 290a 2020 2020 2020   ~3 mins).      
-00012960: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
-00012970: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00012980: 0a40 7079 7465 7374 2e6d 6172 6b2e 617a  .@pytest.mark.az
-00012990: 7572 650a 6465 6620 7465 7374 5f61 7a75  ure.def test_azu
-000129a0: 7265 5f64 6973 6b5f 7469 6572 2829 3a0a  re_disk_tier():.
-000129b0: 2020 2020 666f 7220 6469 736b 5f74 6965      for disk_tie
-000129c0: 7220 696e 205b 276c 6f77 272c 2027 6d65  r in ['low', 'me
-000129d0: 6469 756d 275d 3a0a 2020 2020 2020 2020  dium']:.        
-000129e0: 7479 7065 203d 2041 7a75 7265 2e5f 6765  type = Azure._ge
-000129f0: 745f 6469 736b 5f74 7970 6528 6469 736b  t_disk_type(disk
-00012a00: 5f74 6965 7229 0a20 2020 2020 2020 206e  _tier).        n
-00012a10: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00012a20: 6572 5f6e 616d 6528 2920 2b20 272d 2720  er_name() + '-' 
-00012a30: 2b20 6469 736b 5f74 6965 720a 2020 2020  + disk_tier.    
-00012a40: 2020 2020 7265 6769 6f6e 203d 2027 7765      region = 'we
-00012a50: 7374 7573 3227 0a20 2020 2020 2020 2074  stus2'.        t
-00012a60: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00012a70: 2020 2020 2020 2020 2761 7a75 7265 2d64          'azure-d
-00012a80: 6973 6b2d 7469 6572 272c 0a20 2020 2020  isk-tier',.     
-00012a90: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00012aa0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00012ab0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00012ac0: 657d 202d 2d63 6c6f 7564 2061 7a75 7265  e} --cloud azure
-00012ad0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00012ae0: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-00012af0: 2020 2020 2066 272d 2d64 6973 6b2d 7469       f'--disk-ti
-00012b00: 6572 207b 6469 736b 5f74 6965 727d 2065  er {disk_tier} e
-00012b10: 6368 6f20 2268 656c 6c6f 2073 6b79 2227  cho "hello sky"'
-00012b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012b30: 2020 6627 617a 2072 6573 6f75 7263 6520    f'az resource 
-00012b40: 6c69 7374 202d 2d74 6167 2072 6179 2d63  list --tag ray-c
-00012b50: 6c75 7374 6572 2d6e 616d 653d 7b6e 616d  luster-name={nam
-00012b60: 657d 202d 2d71 7565 7279 2027 0a20 2020  e} --query '.   
-00012b70: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
-00012b80: 5b3f 7479 7065 3d3d 5c27 4d69 6372 6f73  [?type==\'Micros
-00012b90: 6f66 742e 436f 6d70 7574 652f 6469 736b  oft.Compute/disk
-00012ba0: 735c 275d 2e73 6b75 2e6e 616d 6522 2027  s\'].sku.name" '
-00012bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012bc0: 2066 272d 2d6f 7574 7075 7420 7473 7620   f'--output tsv 
-00012bd0: 7c20 6772 6570 207b 7479 7065 7d27 0a20  | grep {type}'. 
-00012be0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
-00012bf0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00012c00: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00012c10: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-00012c20: 656f 7574 3d32 3020 2a20 3630 2c20 2023  eout=20 * 60,  #
-00012c30: 2032 3020 6d69 6e73 2020 2869 7420 7461   20 mins  (it ta
-00012c40: 6b65 7320 6172 6f75 6e64 207e 3132 206d  kes around ~12 m
-00012c50: 696e 7329 0a20 2020 2020 2020 2029 0a20  ins).        ). 
-00012c60: 2020 2020 2020 2072 756e 5f6f 6e65 5f74         run_one_t
-00012c70: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-00012c80: 2d2d 2d2d 2d20 5465 7374 696e 6720 7573  ----- Testing us
-00012c90: 6572 2072 6179 2063 6c75 7374 6572 202d  er ray cluster -
-00012ca0: 2d2d 2d2d 2d2d 2d0a 6465 6620 7465 7374  -------.def test
-00012cb0: 5f75 7365 725f 7261 795f 636c 7573 7465  _user_ray_cluste
-00012cc0: 7228 293a 0a20 2020 206e 616d 6520 3d20  r():.    name = 
-00012cd0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00012ce0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00012cf0: 6573 7428 0a20 2020 2020 2020 2027 7573  est(.        'us
-00012d00: 6572 2d72 6179 2d63 6c75 7374 6572 272c  er-ray-cluster',
-00012d10: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00012d20: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00012d30: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00012d40: 2022 7261 7920 7374 6172 7420 2d2d 6865   "ray start --he
-00012d50: 6164 2227 2c0a 2020 2020 2020 2020 2020  ad"',.          
-00012d60: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00012d70: 6d65 7d20 2265 6368 6f20 6869 2227 2c0a  me} "echo hi"',.
-00012d80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00012d90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00012da0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00012db0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00012dc0: 7475 7320 2d72 207c 2067 7265 7020 7b6e  tus -r | grep {n
-00012dd0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-00012de0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012df0: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00012e00: 6563 686f 2062 7965 2227 2c0a 2020 2020  echo bye"',.    
-00012e10: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00012e20: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-00012e30: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00012e40: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00012e50: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00012e60: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00012e70: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00012e80: 2320 2d2d 2d2d 2d2d 2d20 5465 7374 696e  # ------- Testin
-00012e90: 6720 7468 6520 636f 7265 2041 5049 202d  g the core API -
-00012ea0: 2d2d 2d2d 2d2d 2d0a 2320 4d6f 7374 206f  -------.# Most o
-00012eb0: 6620 7468 6520 636f 7265 2041 5049 7320  f the core APIs 
-00012ec0: 6861 7665 2062 6565 6e20 7465 7374 6564  have been tested
-00012ed0: 2069 6e20 7468 6520 434c 4920 7465 7374   in the CLI test
-00012ee0: 732e 0a23 2054 6865 7365 2074 6573 7473  s..# These tests
-00012ef0: 2061 7265 2066 6f72 2074 6573 7469 6e67   are for testing
-00012f00: 2074 6865 2072 6574 7572 6e20 7661 6c75   the return valu
-00012f10: 6520 6f66 2074 6865 2041 5049 7320 6e6f  e of the APIs no
-00012f20: 7420 6675 6c6c 7920 7573 6564 2069 6e20  t fully used in 
-00012f30: 434c 492e 0a64 6566 2074 6573 745f 636f  CLI..def test_co
-00012f40: 7265 5f61 7069 2829 3a0a 2020 2020 6e61  re_api():.    na
-00012f50: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00012f60: 725f 6e61 6d65 2829 0a20 2020 2073 6b79  r_name().    sky
-00012f70: 2e6c 6175 6e63 680a 2020 2020 2320 544f  .launch.    # TO
-00012f80: 444f 287a 6877 7529 3a20 4164 6420 6120  DO(zhwu): Add a 
-00012f90: 7465 7374 2066 6f72 2063 6f72 6520 6170  test for core ap
-00012fa0: 692e 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  i....# ---------
-00012fb0: 2d20 5465 7374 696e 6720 5374 6f72 6167  - Testing Storag
-00012fc0: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a63 6c61  e ----------.cla
-00012fd0: 7373 2054 6573 7453 746f 7261 6765 5769  ss TestStorageWi
-00012fe0: 7468 4372 6564 656e 7469 616c 733a 0a20  thCredentials:. 
-00012ff0: 2020 2022 2222 5374 6f72 6167 6520 7465     """Storage te
-00013000: 7374 7320 7768 6963 6820 7265 7175 6972  sts which requir
-00013010: 6520 6372 6564 656e 7469 616c 7320 616e  e credentials an
-00013020: 6420 6e65 7477 6f72 6b20 636f 6e6e 6563  d network connec
-00013030: 7469 6f6e 2222 220a 0a20 2020 2041 5753  tion"""..    AWS
-00013040: 5f49 4e56 414c 4944 5f4e 414d 4553 203d  _INVALID_NAMES =
-00013050: 205b 0a20 2020 2020 2020 2027 6162 272c   [.        'ab',
-00013060: 2020 2320 6c65 7373 2074 6861 6e20 3320    # less than 3 
-00013070: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
-00013080: 2020 2027 6162 6364 6566 6768 696a 6b6c     'abcdefghijkl
-00013090: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
-000130a0: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
-000130b0: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-000130c0: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
-000130d0: 797a 3127 2c0a 2020 2020 2020 2020 2320  yz1',.        # 
-000130e0: 6d6f 7265 2074 6861 6e20 3633 2063 6861  more than 63 cha
-000130f0: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00013100: 2741 6263 6465 6627 2c20 2023 2063 6f6e  'Abcdef',  # con
-00013110: 7461 696e 7320 616e 2075 7070 6572 6361  tains an upperca
-00013120: 7365 206c 6574 7465 720a 2020 2020 2020  se letter.      
-00013130: 2020 2761 6263 2064 6566 272c 2020 2320    'abc def',  # 
-00013140: 636f 6e74 6169 6e73 2061 2073 7061 6365  contains a space
-00013150: 0a20 2020 2020 2020 2027 6162 632e 2e64  .        'abc..d
-00013160: 6566 272c 2020 2320 7477 6f20 6164 6a61  ef',  # two adja
-00013170: 6365 6e74 2070 6572 696f 6473 0a20 2020  cent periods.   
-00013180: 2020 2020 2027 3139 322e 3136 382e 352e       '192.168.5.
-00013190: 3427 2c20 2023 2066 6f72 6d61 7474 6564  4',  # formatted
-000131a0: 2061 7320 616e 2049 5020 6164 6472 6573   as an IP addres
-000131b0: 730a 2020 2020 2020 2020 2778 6e2d 2d62  s.        'xn--b
-000131c0: 7563 6b65 7427 2c20 2023 2073 7461 7274  ucket',  # start
-000131d0: 7320 7769 7468 2027 786e 2d2d 2720 7072  s with 'xn--' pr
-000131e0: 6566 6978 0a20 2020 2020 2020 2027 6275  efix.        'bu
-000131f0: 636b 6574 2d73 3361 6c69 6173 272c 2020  cket-s3alias',  
-00013200: 2320 656e 6473 2077 6974 6820 272d 7333  # ends with '-s3
-00013210: 616c 6961 7327 2073 7566 6669 780a 2020  alias' suffix.  
-00013220: 2020 2020 2020 2762 7563 6b65 742d 2d6f        'bucket--o
-00013230: 6c2d 7333 272c 2020 2320 656e 6473 2077  l-s3',  # ends w
-00013240: 6974 6820 272d 2d6f 6c2d 7333 2720 7375  ith '--ol-s3' su
-00013250: 6666 6978 0a20 2020 2020 2020 2027 2e61  ffix.        '.a
-00013260: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
-00013270: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
-00013280: 2020 2761 6263 2e27 2c20 2023 2065 6e64    'abc.',  # end
-00013290: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
-000132a0: 2020 2020 2027 2d61 6263 272c 2020 2320       '-abc',  # 
-000132b0: 7374 6172 7473 2077 6974 6820 6120 6879  starts with a hy
-000132c0: 7068 656e 0a20 2020 2020 2020 2027 6162  phen.        'ab
-000132d0: 632d 272c 2020 2320 656e 6473 2077 6974  c-',  # ends wit
-000132e0: 6820 6120 6879 7068 656e 0a20 2020 205d  h a hyphen.    ]
-000132f0: 0a0a 2020 2020 4743 535f 494e 5641 4c49  ..    GCS_INVALI
-00013300: 445f 4e41 4d45 5320 3d20 5b0a 2020 2020  D_NAMES = [.    
-00013310: 2020 2020 2761 6227 2c20 2023 206c 6573      'ab',  # les
-00013320: 7320 7468 616e 2033 2063 6861 7261 6374  s than 3 charact
-00013330: 6572 730a 2020 2020 2020 2020 2761 6263  ers.        'abc
-00013340: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00013350: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00013360: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00013370: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
-00013380: 7071 7273 7475 7677 7879 7a31 272c 0a20  pqrstuvwxyz1',. 
-00013390: 2020 2020 2020 2023 206d 6f72 6520 7468         # more th
-000133a0: 616e 2036 3320 6368 6172 6163 7465 7273  an 63 characters
-000133b0: 2028 7769 7468 6f75 7420 646f 7473 290a   (without dots).
-000133c0: 2020 2020 2020 2020 2741 6263 6465 6627          'Abcdef'
-000133d0: 2c20 2023 2063 6f6e 7461 696e 7320 616e  ,  # contains an
-000133e0: 2075 7070 6572 6361 7365 206c 6574 7465   uppercase lette
-000133f0: 720a 2020 2020 2020 2020 2761 6263 2064  r.        'abc d
-00013400: 6566 272c 2020 2320 636f 6e74 6169 6e73  ef',  # contains
-00013410: 2061 2073 7061 6365 0a20 2020 2020 2020   a space.       
-00013420: 2027 6162 632e 2e64 6566 272c 2020 2320   'abc..def',  # 
-00013430: 7477 6f20 6164 6a61 6365 6e74 2070 6572  two adjacent per
-00013440: 696f 6473 0a20 2020 2020 2020 2027 6162  iods.        'ab
-00013450: 635f 2e64 6566 2e67 6869 2e6a 6b6c 6d6e  c_.def.ghi.jklmn
-00013460: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
-00013470: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
-00013480: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00013490: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-000134a0: 3127 0a20 2020 2020 2020 2023 204d 6f72  1'.        # Mor
-000134b0: 6520 7468 616e 2036 3320 6368 6172 6163  e than 63 charac
-000134c0: 7465 7273 2062 6574 7765 656e 2064 6f74  ters between dot
-000134d0: 730a 2020 2020 2020 2020 2761 6263 5f2e  s.        'abc_.
-000134e0: 6465 662e 6768 692e 6a6b 6c6d 6e6f 7071  def.ghi.jklmnopq
-000134f0: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00013500: 6869 6a6b 6c6d 6e6f 7071 6667 6869 6a6b  hijklmnopqfghijk
-00013510: 6c6d 6e6f 7071 7273 7475 7677 2720 2a20  lmnopqrstuvw' * 
-00013520: 352c 0a20 2020 2020 2020 2023 206d 6f72  5,.        # mor
-00013530: 6520 7468 616e 2032 3232 2063 6861 7261  e than 222 chara
-00013540: 6374 6572 7320 2877 6974 6820 646f 7473  cters (with dots
-00013550: 290a 2020 2020 2020 2020 2731 3932 2e31  ).        '192.1
-00013560: 3638 2e35 2e34 272c 2020 2320 666f 726d  68.5.4',  # form
-00013570: 6174 7465 6420 6173 2061 6e20 4950 2061  atted as an IP a
-00013580: 6464 7265 7373 0a20 2020 2020 2020 2027  ddress.        '
-00013590: 676f 6f67 6275 636b 6574 272c 2020 2320  googbucket',  # 
-000135a0: 7374 6172 7473 2077 6974 6820 2767 6f6f  starts with 'goo
-000135b0: 6727 2070 7265 6669 780a 2020 2020 2020  g' prefix.      
-000135c0: 2020 2767 6f6f 676c 6562 7563 6b65 7427    'googlebucket'
-000135d0: 2c20 2023 2063 6f6e 7461 696e 7320 2767  ,  # contains 'g
-000135e0: 6f6f 676c 6527 0a20 2020 2020 2020 2027  oogle'.        '
-000135f0: 6730 3067 6c65 6275 636b 6574 272c 2020  g00glebucket',  
-00013600: 2320 7661 7269 616e 7420 6f66 2027 676f  # variant of 'go
-00013610: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
-00013620: 6f30 676c 6562 7563 6b65 7427 2c20 2023  o0glebucket',  #
-00013630: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
-00013640: 676c 6527 0a20 2020 2020 2020 2027 6730  gle'.        'g0
-00013650: 6f67 6c65 6275 636b 6574 272c 2020 2320  oglebucket',  # 
-00013660: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
-00013670: 6c65 270a 2020 2020 2020 2020 272e 6162  le'.        '.ab
-00013680: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00013690: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-000136a0: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
-000136b0: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-000136c0: 2020 2020 275f 6162 6327 2c20 2023 2073      '_abc',  # s
-000136d0: 7461 7274 7320 7769 7468 2061 6e20 756e  tarts with an un
-000136e0: 6465 7273 636f 7265 0a20 2020 2020 2020  derscore.       
-000136f0: 2027 6162 635f 272c 2020 2320 656e 6473   'abc_',  # ends
-00013700: 2077 6974 6820 616e 2075 6e64 6572 7363   with an undersc
-00013710: 6f72 650a 2020 2020 5d0a 0a20 2020 2040  ore.    ]..    @
-00013720: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
-00013730: 2064 6566 2063 6c69 5f64 656c 6574 655f   def cli_delete_
-00013740: 636d 6428 7374 6f72 655f 7479 7065 2c20  cmd(store_type, 
-00013750: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
-00013760: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-00013770: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
-00013780: 6962 2e53 746f 7265 5479 7065 2e53 333a  ib.StoreType.S3:
-00013790: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
-000137a0: 203d 2066 2773 333a 2f2f 7b62 7563 6b65   = f's3://{bucke
-000137b0: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
-000137c0: 2020 2020 2072 6574 7572 6e20 6627 6177       return f'aw
-000137d0: 7320 7333 2072 6220 7b75 726c 7d20 2d2d  s s3 rb {url} --
-000137e0: 666f 7263 6527 0a20 2020 2020 2020 2069  force'.        i
-000137f0: 6620 7374 6f72 655f 7479 7065 203d 3d20  f store_type == 
-00013800: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00013810: 6554 7970 652e 4743 533a 0a20 2020 2020  eType.GCS:.     
-00013820: 2020 2020 2020 2075 726c 203d 2066 2767         url = f'g
-00013830: 733a 2f2f 7b62 7563 6b65 745f 6e61 6d65  s://{bucket_name
-00013840: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-00013850: 6574 7572 6e20 6627 6773 7574 696c 202d  eturn f'gsutil -
-00013860: 6d20 726d 202d 7220 7b75 726c 7d27 0a20  m rm -r {url}'. 
-00013870: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
-00013880: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-00013890: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-000138a0: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
-000138b0: 6470 6f69 6e74 5f75 726c 203d 2063 6c6f  dpoint_url = clo
-000138c0: 7564 666c 6172 652e 6372 6561 7465 5f65  udflare.create_e
-000138d0: 6e64 706f 696e 7428 290a 2020 2020 2020  ndpoint().      
-000138e0: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-000138f0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-00013900: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-00013910: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
-00013920: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-00013930: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-00013940: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-00013950: 5448 7d20 6177 7320 7333 2072 6220 7b75  TH} aws s3 rb {u
-00013960: 726c 7d20 2d2d 666f 7263 6520 2d2d 656e  rl} --force --en
-00013970: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
-00013980: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
-00013990: 7232 270a 0a20 2020 2040 7374 6174 6963  r2'..    @static
-000139a0: 6d65 7468 6f64 0a20 2020 2064 6566 2063  method.    def c
-000139b0: 6c69 5f6c 735f 636d 6428 7374 6f72 655f  li_ls_cmd(store_
-000139c0: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
-000139d0: 652c 2073 7566 6669 783d 2727 293a 0a20  e, suffix=''):. 
-000139e0: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
-000139f0: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-00013a00: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-00013a10: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00013a20: 2073 7566 6669 783a 0a20 2020 2020 2020   suffix:.       
-00013a30: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-00013a40: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
-00013a50: 6d65 7d2f 7b73 7566 6669 787d 270a 2020  me}/{suffix}'.  
-00013a60: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00013a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a80: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-00013a90: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
-00013aa0: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00013ab0: 2761 7773 2073 3320 6c73 207b 7572 6c7d  'aws s3 ls {url}
-00013ac0: 270a 2020 2020 2020 2020 6966 2073 746f  '.        if sto
-00013ad0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-00013ae0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00013af0: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
-00013b00: 2020 6966 2073 7566 6669 783a 0a20 2020    if suffix:.   
-00013b10: 2020 2020 2020 2020 2020 2020 2075 726c               url
-00013b20: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
-00013b30: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
-00013b40: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-00013b50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00013b60: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
-00013b70: 2f7b 6275 636b 6574 5f6e 616d 657d 270a  /{bucket_name}'.
-00013b80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013b90: 726e 2066 2767 7375 7469 6c20 6c73 207b  rn f'gsutil ls {
-00013ba0: 7572 6c7d 270a 2020 2020 2020 2020 6966  url}'.        if
-00013bb0: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-00013bc0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00013bd0: 5479 7065 2e52 323a 0a20 2020 2020 2020  Type.R2:.       
-00013be0: 2020 2020 2065 6e64 706f 696e 745f 7572       endpoint_ur
-00013bf0: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
-00013c00: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
-00013c10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013c20: 7375 6666 6978 3a0a 2020 2020 2020 2020  suffix:.        
-00013c30: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
-00013c40: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
-00013c50: 657d 2f7b 7375 6666 6978 7d27 0a20 2020  e}/{suffix}'.   
-00013c60: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00013c70: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00013c80: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
-00013c90: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-00013ca0: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
-00013cb0: 4157 535f 5348 4152 4544 5f43 5245 4445  AWS_SHARED_CREDE
-00013cc0: 4e54 4941 4c53 5f46 494c 453d 7b63 6c6f  NTIALS_FILE={clo
-00013cd0: 7564 666c 6172 652e 5232 5f43 5245 4445  udflare.R2_CREDE
-00013ce0: 4e54 4941 4c53 5f50 4154 487d 2061 7773  NTIALS_PATH} aws
-00013cf0: 2073 3320 6c73 207b 7572 6c7d 202d 2d65   s3 ls {url} --e
-00013d00: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-00013d10: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-00013d20: 3d72 3227 0a0a 2020 2020 4070 7974 6573  =r2'..    @pytes
-00013d30: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-00013d40: 6620 746d 705f 736f 7572 6365 2873 656c  f tmp_source(sel
-00013d50: 662c 2074 6d70 5f70 6174 6829 3a0a 2020  f, tmp_path):.  
-00013d60: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-00013d70: 6120 7465 6d70 6f72 6172 7920 6469 7265  a temporary dire
-00013d80: 6374 6f72 7920 7769 7468 2061 2066 696c  ctory with a fil
-00013d90: 6520 696e 2069 740a 2020 2020 2020 2020  e in it.        
-00013da0: 746d 705f 6469 7220 3d20 746d 705f 7061  tmp_dir = tmp_pa
-00013db0: 7468 202f 2027 746d 702d 736f 7572 6365  th / 'tmp-source
-00013dc0: 270a 2020 2020 2020 2020 746d 705f 6469  '.        tmp_di
-00013dd0: 722e 6d6b 6469 7228 290a 2020 2020 2020  r.mkdir().      
-00013de0: 2020 746d 705f 6669 6c65 203d 2074 6d70    tmp_file = tmp
-00013df0: 5f64 6972 202f 2027 746d 702d 6669 6c65  _dir / 'tmp-file
-00013e00: 270a 2020 2020 2020 2020 746d 705f 6669  '.        tmp_fi
-00013e10: 6c65 2e77 7269 7465 5f74 6578 7428 2774  le.write_text('t
-00013e20: 6573 7427 290a 2020 2020 2020 2020 6369  est').        ci
-00013e30: 7263 6c65 5f6c 696e 6b20 3d20 746d 705f  rcle_link = tmp_
-00013e40: 6469 7220 2f20 2763 6972 636c 652d 6c69  dir / 'circle-li
-00013e50: 6e6b 270a 2020 2020 2020 2020 6369 7263  nk'.        circ
-00013e60: 6c65 5f6c 696e 6b2e 7379 6d6c 696e 6b5f  le_link.symlink_
-00013e70: 746f 2874 6d70 5f64 6972 2c20 7461 7267  to(tmp_dir, targ
-00013e80: 6574 5f69 735f 6469 7265 6374 6f72 793d  et_is_directory=
-00013e90: 5472 7565 290a 2020 2020 2020 2020 7969  True).        yi
-00013ea0: 656c 6420 7374 7228 746d 705f 6469 7229  eld str(tmp_dir)
-00013eb0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-00013ec0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-00013ed0: 705f 6275 636b 6574 5f6e 616d 6528 7365  p_bucket_name(se
-00013ee0: 6c66 293a 0a20 2020 2020 2020 2023 2043  lf):.        # C
-00013ef0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-00013f00: 7279 2062 7563 6b65 7420 6e61 6d65 0a20  ry bucket name. 
-00013f10: 2020 2020 2020 2023 2074 696d 652e 7469         # time.ti
-00013f20: 6d65 2829 2072 6574 7572 6e73 2076 6172  me() returns var
-00013f30: 7969 6e67 2070 7265 6369 7369 6f6e 206f  ying precision o
-00013f40: 6e20 6469 6666 6572 656e 7420 7379 7374  n different syst
-00013f50: 656d 732c 2073 6f20 7765 0a20 2020 2020  ems, so we.     
-00013f60: 2020 2023 2072 6570 6c61 6365 2074 6865     # replace the
-00013f70: 2064 6563 696d 616c 2070 6f69 6e74 2061   decimal point a
-00013f80: 6e64 2075 7365 2077 6861 7465 7665 7220  nd use whatever 
-00013f90: 7072 6563 6973 696f 6e20 7765 2063 616e  precision we can
-00013fa0: 2067 6574 2e0a 2020 2020 2020 2020 7469   get..        ti
-00013fb0: 6d65 7374 616d 7020 3d20 7374 7228 7469  mestamp = str(ti
-00013fc0: 6d65 2e74 696d 6528 2929 2e72 6570 6c61  me.time()).repla
-00013fd0: 6365 2827 2e27 2c20 2727 290a 2020 2020  ce('.', '').    
-00013fe0: 2020 2020 7969 656c 6420 6627 736b 792d      yield f'sky-
-00013ff0: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
-00014000: 270a 0a20 2020 2040 7374 6174 6963 6d65  '..    @staticme
-00014010: 7468 6f64 0a20 2020 2064 6566 2079 6965  thod.    def yie
-00014020: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-00014030: 7428 0a20 2020 2020 2020 2020 2020 206e  t(.            n
-00014040: 616d 653a 204f 7074 696f 6e61 6c5b 7374  ame: Optional[st
-00014050: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
-00014060: 2020 2020 2020 2073 6f75 7263 653a 204f         source: O
-00014070: 7074 696f 6e61 6c5b 7374 6f72 6167 655f  ptional[storage_
-00014080: 6c69 622e 5061 7468 5d20 3d20 4e6f 6e65  lib.Path] = None
-00014090: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-000140a0: 6f72 6573 3a20 4f70 7469 6f6e 616c 5b44  ores: Optional[D
-000140b0: 6963 745b 7374 6f72 6167 655f 6c69 622e  ict[storage_lib.
-000140c0: 5374 6f72 6554 7970 652c 0a20 2020 2020  StoreType,.     
-000140d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000140e0: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-000140f0: 7261 6765 5f6c 6962 2e41 6273 7472 6163  rage_lib.Abstrac
-00014100: 7453 746f 7265 5d5d 203d 204e 6f6e 652c  tStore]] = None,
-00014110: 0a20 2020 2020 2020 2020 2020 2070 6572  .            per
-00014120: 7369 7374 656e 743a 204f 7074 696f 6e61  sistent: Optiona
-00014130: 6c5b 626f 6f6c 5d20 3d20 5472 7565 2c0a  l[bool] = True,.
-00014140: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-00014150: 3a20 7374 6f72 6167 655f 6c69 622e 5374  : storage_lib.St
-00014160: 6f72 6167 654d 6f64 6520 3d20 7374 6f72  orageMode = stor
-00014170: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
-00014180: 6f64 652e 4d4f 554e 5429 3a0a 2020 2020  ode.MOUNT):.    
-00014190: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-000141a0: 7465 6d70 6f72 6172 7920 7374 6f72 6167  temporary storag
-000141b0: 6520 6f62 6a65 6374 2e20 5374 6f72 6573  e object. Stores
-000141c0: 206d 7573 7420 6265 2061 6464 6564 2069   must be added i
-000141d0: 6e20 7468 6520 7465 7374 2e0a 2020 2020  n the test..    
-000141e0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-000141f0: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00014200: 6f72 6167 6528 6e61 6d65 3d6e 616d 652c  orage(name=name,
-00014210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014230: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00014240: 653d 736f 7572 6365 2c0a 2020 2020 2020  e=source,.      
-00014250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014270: 2020 2020 7374 6f72 6573 3d73 746f 7265      stores=store
-00014280: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142a0: 2020 2020 2020 2020 2020 2020 2070 6572               per
-000142b0: 7369 7374 656e 743d 7065 7273 6973 7465  sistent=persiste
-000142c0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-000142d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142e0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-000142f0: 6465 3d6d 6f64 6529 0a20 2020 2020 2020  de=mode).       
-00014300: 2079 6965 6c64 2073 746f 7261 6765 5f6f   yield storage_o
-00014310: 626a 0a20 2020 2020 2020 2068 616e 646c  bj.        handl
-00014320: 6520 3d20 676c 6f62 616c 5f75 7365 725f  e = global_user_
-00014330: 7374 6174 652e 6765 745f 6861 6e64 6c65  state.get_handle
-00014340: 5f66 726f 6d5f 7374 6f72 6167 655f 6e61  _from_storage_na
-00014350: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
-00014360: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-00014370: 290a 2020 2020 2020 2020 6966 2068 616e  ).        if han
-00014380: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
-00014390: 2023 2049 6620 6861 6e64 6c65 2065 7869   # If handle exi
-000143a0: 7374 732c 2064 656c 6574 6520 6d61 6e75  sts, delete manu
-000143b0: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
-000143c0: 2023 2054 4f44 4f28 726f 6d69 6c62 293a   # TODO(romilb):
-000143d0: 2054 6869 7320 6973 2070 6f74 656e 7469   This is potenti
-000143e0: 616c 6c79 2072 6973 6b79 202d 2069 6620  ally risky - if 
-000143f0: 7468 6520 6465 6c65 7465 206d 6574 686f  the delete metho
-00014400: 6420 6861 730a 2020 2020 2020 2020 2020  d has.          
-00014410: 2020 2320 2020 6275 6773 2c20 7468 6973    #   bugs, this
-00014420: 2063 616e 2063 6175 7365 2072 6573 6f75   can cause resou
-00014430: 7263 6520 6c65 616b 732e 2049 6465 616c  rce leaks. Ideal
-00014440: 6c79 2077 6520 7368 6f75 6c64 206d 616e  ly we should man
-00014450: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-00014460: 2020 2320 2020 656a 6563 7420 7374 6f72    #   eject stor
-00014470: 6167 6520 6672 6f6d 2067 6c6f 6261 6c5f  age from global_
-00014480: 7573 6572 5f73 7461 7465 2061 6e64 2064  user_state and d
-00014490: 656c 6574 6520 7468 6520 6275 636b 6574  elete the bucket
-000144a0: 2075 7369 6e67 0a20 2020 2020 2020 2020   using.         
-000144b0: 2020 2023 2020 2062 6f74 6f33 2064 6972     #   boto3 dir
-000144c0: 6563 746c 792e 0a20 2020 2020 2020 2020  ectly..         
-000144d0: 2020 2073 746f 7261 6765 5f6f 626a 2e64     storage_obj.d
-000144e0: 656c 6574 6528 290a 0a20 2020 2040 7079  elete()..    @py
-000144f0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-00014500: 2064 6566 2074 6d70 5f73 6372 6174 6368   def tmp_scratch
-00014510: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-00014520: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-00014530: 6d65 293a 0a20 2020 2020 2020 2023 2043  me):.        # C
-00014540: 7265 6174 6573 2061 2073 746f 7261 6765  reates a storage
-00014550: 206f 626a 6563 7420 7769 7468 206e 6f20   object with no 
-00014560: 736f 7572 6365 2074 6f20 6372 6561 7465  source to create
-00014570: 2061 2073 6372 6174 6368 2073 746f 7261   a scratch stora
-00014580: 6765 2e0a 2020 2020 2020 2020 2320 5374  ge..        # St
-00014590: 6f72 6573 206d 7573 7420 6265 2061 6464  ores must be add
-000145a0: 6564 2069 6e20 7468 6520 7465 7374 2e0a  ed in the test..
-000145b0: 2020 2020 2020 2020 7969 656c 6420 6672          yield fr
-000145c0: 6f6d 2073 656c 662e 7969 656c 645f 7374  om self.yield_st
-000145d0: 6f72 6167 655f 6f62 6a65 6374 286e 616d  orage_object(nam
-000145e0: 653d 746d 705f 6275 636b 6574 5f6e 616d  e=tmp_bucket_nam
-000145f0: 6529 0a0a 2020 2020 4070 7974 6573 742e  e)..    @pytest.
-00014600: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-00014610: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
-00014620: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
-00014630: 6275 636b 6574 5f6e 616d 652c 2074 6d70  bucket_name, tmp
-00014640: 5f73 6f75 7263 6529 3a0a 2020 2020 2020  _source):.      
-00014650: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
-00014660: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
-00014670: 6f62 6a65 6374 2e20 5374 6f72 6573 206d  object. Stores m
-00014680: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
-00014690: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
-000146a0: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
-000146b0: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
-000146c0: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
-000146d0: 6275 636b 6574 5f6e 616d 652c 0a20 2020  bucket_name,.   
-000146e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014700: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00014710: 3d74 6d70 5f73 6f75 7263 6529 0a0a 2020  =tmp_source)..  
-00014720: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-00014730: 650a 2020 2020 6465 6620 746d 705f 6c6f  e.    def tmp_lo
-00014740: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
-00014750: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
-00014760: 7563 6b65 745f 6e61 6d65 2c20 746d 705f  ucket_name, tmp_
-00014770: 736f 7572 6365 293a 0a20 2020 2020 2020  source):.       
-00014780: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-00014790: 7020 7374 6f72 6167 6520 6f62 6a65 6374  p storage object
-000147a0: 2077 6869 6368 2075 7365 7320 6120 6c69   which uses a li
-000147b0: 7374 206f 6620 7061 7468 7320 6173 2073  st of paths as s
-000147c0: 6f75 7263 652e 0a20 2020 2020 2020 2023  ource..        #
-000147d0: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
-000147e0: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
-000147f0: 742e 2041 6674 6572 2075 706c 6f61 642c  t. After upload,
-00014800: 2074 6865 2062 7563 6b65 7420 7368 6f75   the bucket shou
-00014810: 6c64 0a20 2020 2020 2020 2023 2068 6176  ld.        # hav
-00014820: 6520 7477 6f20 6669 6c65 7320 2d20 2f74  e two files - /t
-00014830: 6d70 2d66 696c 6520 616e 6420 2f74 6d70  mp-file and /tmp
-00014840: 2d73 6f75 7263 652f 746d 702d 6669 6c65  -source/tmp-file
-00014850: 0a20 2020 2020 2020 206c 6973 745f 736f  .        list_so
-00014860: 7572 6365 203d 205b 746d 705f 736f 7572  urce = [tmp_sour
-00014870: 6365 2c20 746d 705f 736f 7572 6365 202b  ce, tmp_source +
-00014880: 2027 2f74 6d70 2d66 696c 6527 5d0a 2020   '/tmp-file'].  
-00014890: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
-000148a0: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
-000148b0: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
-000148c0: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
-000148d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000148e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148f0: 2020 2020 2020 2020 2020 2020 2020 736f                so
-00014900: 7572 6365 3d6c 6973 745f 736f 7572 6365  urce=list_source
-00014910: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-00014920: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-00014930: 6d70 5f63 6f70 795f 6d6e 745f 6578 6973  mp_copy_mnt_exis
-00014940: 7469 6e67 5f73 746f 7261 6765 5f6f 626a  ting_storage_obj
-00014950: 2873 656c 662c 2074 6d70 5f73 6372 6174  (self, tmp_scrat
-00014960: 6368 5f73 746f 7261 6765 5f6f 626a 293a  ch_storage_obj):
-00014970: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-00014980: 6573 2061 2063 6f70 7920 6d6f 756e 7420  es a copy mount 
-00014990: 7374 6f72 6167 6520 7768 6963 6820 7265  storage which re
-000149a0: 7573 6573 2061 6e20 6578 6973 7469 6e67  uses an existing
-000149b0: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
-000149c0: 0a20 2020 2020 2020 2074 6d70 5f73 6372  .        tmp_scr
-000149d0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
-000149e0: 2e61 6464 5f73 746f 7265 2873 746f 7261  .add_store(stora
-000149f0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00014a00: 2e53 3329 0a20 2020 2020 2020 2073 746f  .S3).        sto
-00014a10: 7261 6765 5f6e 616d 6520 3d20 746d 705f  rage_name = tmp_
-00014a20: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-00014a30: 6f62 6a2e 6e61 6d65 0a0a 2020 2020 2020  obj.name..      
-00014a40: 2020 2320 5472 7920 746f 2069 6e69 7469    # Try to initi
-00014a50: 616c 697a 6520 616e 6f74 6865 7220 7374  alize another st
-00014a60: 6f72 6167 6520 7769 7468 2074 6865 2073  orage with the s
-00014a70: 746f 7261 6765 206f 626a 6563 7420 6372  torage object cr
-00014a80: 6561 7465 640a 2020 2020 2020 2020 2320  eated.        # 
-00014a90: 6162 6f76 652c 2062 7574 206e 6f77 2069  above, but now i
-00014aa0: 6e20 434f 5059 206d 6f64 652e 2054 6869  n COPY mode. Thi
-00014ab0: 7320 7368 6f75 6c64 2073 7563 6365 6564  s should succeed
-00014ac0: 2e0a 2020 2020 2020 2020 7969 656c 6420  ..        yield 
-00014ad0: 6672 6f6d 2073 656c 662e 7969 656c 645f  from self.yield_
-00014ae0: 7374 6f72 6167 655f 6f62 6a65 6374 286e  storage_object(n
-00014af0: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
-00014b00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b20: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00014b30: 6f64 653d 7374 6f72 6167 655f 6c69 622e  ode=storage_lib.
-00014b40: 5374 6f72 6167 654d 6f64 652e 434f 5059  StorageMode.COPY
-00014b50: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
-00014b60: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
-00014b70: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
-00014b80: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
-00014b90: 745f 6e61 6d65 293a 0a20 2020 2020 2020  t_name):.       
-00014ba0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
-00014bb0: 706f 7261 7279 2062 7563 6b65 7420 7573  porary bucket us
-00014bc0: 696e 6720 6177 7363 6c69 0a20 2020 2020  ing awscli.     
-00014bd0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-00014be0: 6563 6b5f 6361 6c6c 285b 2761 7773 272c  eck_call(['aws',
-00014bf0: 2027 7333 272c 2027 6d62 272c 2066 2773   's3', 'mb', f's
-00014c00: 333a 2f2f 7b74 6d70 5f62 7563 6b65 745f  3://{tmp_bucket_
-00014c10: 6e61 6d65 7d27 5d29 0a20 2020 2020 2020  name}']).       
-00014c20: 2079 6965 6c64 2074 6d70 5f62 7563 6b65   yield tmp_bucke
-00014c30: 745f 6e61 6d65 0a20 2020 2020 2020 2073  t_name.        s
-00014c40: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00014c50: 6361 6c6c 280a 2020 2020 2020 2020 2020  call(.          
-00014c60: 2020 5b27 6177 7327 2c20 2773 3327 2c20    ['aws', 's3', 
-00014c70: 2772 6227 2c20 6627 7333 3a2f 2f7b 746d  'rb', f's3://{tm
-00014c80: 705f 6275 636b 6574 5f6e 616d 657d 272c  p_bucket_name}',
-00014c90: 2027 2d2d 666f 7263 6527 5d29 0a0a 2020   '--force'])..  
-00014ca0: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
-00014cb0: 650a 2020 2020 6465 6620 746d 705f 6773  e.    def tmp_gs
-00014cc0: 7574 696c 5f62 7563 6b65 7428 7365 6c66  util_bucket(self
-00014cd0: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
-00014ce0: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
-00014cf0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
-00014d00: 7920 6275 636b 6574 2075 7369 6e67 2067  y bucket using g
-00014d10: 7375 7469 6c0a 2020 2020 2020 2020 7375  sutil.        su
-00014d20: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
-00014d30: 616c 6c28 5b27 6773 7574 696c 272c 2027  all(['gsutil', '
-00014d40: 6d62 272c 2066 2767 733a 2f2f 7b74 6d70  mb', f'gs://{tmp
-00014d50: 5f62 7563 6b65 745f 6e61 6d65 7d27 5d29  _bucket_name}'])
-00014d60: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
-00014d70: 6d70 5f62 7563 6b65 745f 6e61 6d65 0a20  mp_bucket_name. 
-00014d80: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-00014d90: 732e 6368 6563 6b5f 6361 6c6c 285b 2767  s.check_call(['g
-00014da0: 7375 7469 6c27 2c20 2772 6d27 2c20 272d  sutil', 'rm', '-
-00014db0: 7227 2c20 6627 6773 3a2f 2f7b 746d 705f  r', f'gs://{tmp_
-00014dc0: 6275 636b 6574 5f6e 616d 657d 275d 290a  bucket_name}']).
-00014dd0: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
-00014de0: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
-00014df0: 5f61 7773 636c 695f 6275 636b 6574 5f72  _awscli_bucket_r
-00014e00: 3228 7365 6c66 2c20 746d 705f 6275 636b  2(self, tmp_buck
-00014e10: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-00014e20: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
-00014e30: 6d70 6f72 6172 7920 6275 636b 6574 2075  mporary bucket u
-00014e40: 7369 6e67 2061 7773 636c 690a 2020 2020  sing awscli.    
-00014e50: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
-00014e60: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
-00014e70: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
-00014e80: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-00014e90: 7373 2e63 6865 636b 5f63 616c 6c28 0a20  ss.check_call(. 
-00014ea0: 2020 2020 2020 2020 2020 2066 2741 5753             f'AWS
-00014eb0: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
-00014ec0: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
-00014ed0: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
-00014ee0: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
-00014ef0: 206d 6220 7333 3a2f 2f7b 746d 705f 6275   mb s3://{tmp_bu
-00014f00: 636b 6574 5f6e 616d 657d 202d 2d65 6e64  cket_name} --end
-00014f10: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
-00014f20: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
-00014f30: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-00014f40: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-00014f50: 2020 2020 7969 656c 6420 746d 705f 6275      yield tmp_bu
-00014f60: 636b 6574 5f6e 616d 650a 2020 2020 2020  cket_name.      
-00014f70: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-00014f80: 636b 5f63 616c 6c28 0a20 2020 2020 2020  ck_call(.       
-00014f90: 2020 2020 2066 2741 5753 5f53 4841 5245       f'AWS_SHARE
-00014fa0: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-00014fb0: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-00014fc0: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-00014fd0: 5448 7d20 6177 7320 7333 2072 6220 7333  TH} aws s3 rb s3
-00014fe0: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
-00014ff0: 616d 657d 202d 2d66 6f72 6365 202d 2d65  ame} --force --e
-00015000: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
-00015010: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
-00015020: 3d72 3227 2c0a 2020 2020 2020 2020 2020  =r2',.          
-00015030: 2020 7368 656c 6c3d 5472 7565 290a 0a20    shell=True).. 
-00015040: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-00015050: 7265 0a20 2020 2064 6566 2074 6d70 5f70  re.    def tmp_p
-00015060: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-00015070: 6a28 7365 6c66 2c20 7265 7175 6573 7429  j(self, request)
-00015080: 3a0a 2020 2020 2020 2020 2320 496e 6974  :.        # Init
-00015090: 6961 6c69 7a65 7320 6120 7374 6f72 6167  ializes a storag
-000150a0: 6520 6f62 6a65 6374 2077 6974 6820 6120  e object with a 
-000150b0: 7075 626c 6963 2062 7563 6b65 740a 2020  public bucket.  
-000150c0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-000150d0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-000150e0: 5374 6f72 6167 6528 736f 7572 6365 3d72  Storage(source=r
-000150f0: 6571 7565 7374 2e70 6172 616d 290a 2020  equest.param).  
-00015100: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
-00015110: 6167 655f 6f62 6a0a 2020 2020 2020 2020  age_obj.        
-00015120: 2320 5468 6973 2064 6f65 7320 6e6f 7420  # This does not 
-00015130: 7265 7175 6972 6520 616e 7920 6465 6c65  require any dele
-00015140: 7469 6f6e 206c 6f67 6963 2062 6563 6175  tion logic becau
-00015150: 7365 2069 7420 6973 2061 2070 7562 6c69  se it is a publi
-00015160: 6320 6275 636b 6574 0a20 2020 2020 2020  c bucket.       
-00015170: 2023 2061 6e64 2073 686f 756c 6420 6e6f   # and should no
-00015180: 7420 6765 7420 6164 6465 6420 746f 2067  t get added to g
-00015190: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-000151a0: 2e0a 0a20 2020 2040 7079 7465 7374 2e6d  ...    @pytest.m
-000151b0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-000151c0: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
-000151d0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-000151e0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-000151f0: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-00015200: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
-00015210: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
-00015220: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
-00015230: 6f72 6554 7970 652e 5232 2c20 6d61 726b  oreType.R2, mark
-00015240: 733d 7079 7465 7374 2e6d 6172 6b2e 636c  s=pytest.mark.cl
-00015250: 6f75 6466 6c61 7265 290a 2020 2020 5d29  oudflare).    ])
-00015260: 0a20 2020 2064 6566 2074 6573 745f 6e65  .    def test_ne
-00015270: 775f 6275 636b 6574 5f63 7265 6174 696f  w_bucket_creatio
-00015280: 6e5f 616e 645f 6465 6c65 7469 6f6e 2873  n_and_deletion(s
-00015290: 656c 662c 2074 6d70 5f6c 6f63 616c 5f73  elf, tmp_local_s
-000152a0: 746f 7261 6765 5f6f 626a 2c0a 2020 2020  torage_obj,.    
-000152b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152d0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-000152e0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
-000152f0: 2043 7265 6174 6573 2061 206e 6577 2062   Creates a new b
-00015300: 7563 6b65 7420 7769 7468 2061 206c 6f63  ucket with a loc
-00015310: 616c 2073 6f75 7263 652c 2075 706c 6f61  al source, uploa
-00015320: 6473 2066 696c 6573 2074 6f20 6974 0a20  ds files to it. 
-00015330: 2020 2020 2020 2023 2061 6e64 2064 656c         # and del
-00015340: 6574 6573 2069 742e 0a20 2020 2020 2020  etes it..       
-00015350: 2074 6d70 5f6c 6f63 616c 5f73 746f 7261   tmp_local_stora
-00015360: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
-00015370: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
-00015380: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-00015390: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-000153a0: 6563 6b20 6966 2073 746f 7261 6765 206f  eck if storage o
-000153b0: 626a 6563 7420 6578 6973 7473 2069 6e20  bject exists in 
-000153c0: 7468 6520 6f75 7470 7574 0a20 2020 2020  the output.     
-000153d0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-000153e0: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-000153f0: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
-00015400: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
-00015410: 2020 2061 7373 6572 7420 746d 705f 6c6f     assert tmp_lo
-00015420: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-00015430: 6e61 6d65 2069 6e20 6f75 742e 6465 636f  name in out.deco
-00015440: 6465 2827 7574 662d 3827 290a 0a20 2020  de('utf-8')..   
-00015450: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-00015460: 746f 7261 6765 2064 656c 6574 6520 746f  torage delete to
-00015470: 2064 656c 6574 6520 7468 6520 7374 6f72   delete the stor
-00015480: 6167 6520 6f62 6a65 6374 0a20 2020 2020  age object.     
-00015490: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-000154a0: 6563 6b5f 6f75 7470 7574 280a 2020 2020  eck_output(.    
-000154b0: 2020 2020 2020 2020 5b27 736b 7927 2c20          ['sky', 
-000154c0: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
-000154d0: 7465 272c 2074 6d70 5f6c 6f63 616c 5f73  te', tmp_local_s
-000154e0: 746f 7261 6765 5f6f 626a 2e6e 616d 655d  torage_obj.name]
-000154f0: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-00015500: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
-00015510: 746f 2063 6865 636b 2069 6620 7374 6f72  to check if stor
-00015520: 6167 6520 6f62 6a65 6374 2069 7320 6465  age object is de
-00015530: 6c65 7465 640a 2020 2020 2020 2020 6f75  leted.        ou
-00015540: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-00015550: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
-00015560: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-00015570: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
-00015580: 7365 7274 2074 6d70 5f6c 6f63 616c 5f73  sert tmp_local_s
-00015590: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-000155a0: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
-000155b0: 6528 2775 7466 2d38 2729 0a0a 2020 2020  e('utf-8')..    
-000155c0: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-000155d0: 616d 6574 7269 7a65 2827 7374 6f72 655f  ametrize('store_
-000155e0: 7479 7065 272c 205b 0a20 2020 2020 2020  type', [.       
-000155f0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00015600: 7265 5479 7065 2e53 332c 2073 746f 7261  reType.S3, stora
-00015610: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00015620: 2e47 4353 2c0a 2020 2020 2020 2020 7079  .GCS,.        py
-00015630: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
-00015640: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00015650: 2e52 322c 206d 6172 6b73 3d70 7974 6573  .R2, marks=pytes
-00015660: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
-00015670: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
-00015680: 6620 7465 7374 5f62 7563 6b65 745f 6578  f test_bucket_ex
-00015690: 7465 726e 616c 5f64 656c 6574 696f 6e28  ternal_deletion(
-000156a0: 7365 6c66 2c20 746d 705f 7363 7261 7463  self, tmp_scratc
-000156b0: 685f 7374 6f72 6167 655f 6f62 6a2c 0a20  h_storage_obj,. 
-000156c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000156e0: 2020 2020 2073 746f 7265 5f74 7970 6529       store_type)
-000156f0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
-00015700: 7465 7320 6120 6275 636b 6574 2c20 6465  tes a bucket, de
-00015710: 6c65 7465 7320 6974 2065 7874 6572 6e61  letes it externa
-00015720: 6c6c 7920 7573 696e 6720 636c 6f75 6420  lly using cloud 
-00015730: 636c 6920 636f 6d6d 616e 6473 0a20 2020  cli commands.   
-00015740: 2020 2020 2023 2061 6e64 2074 6865 6e20       # and then 
-00015750: 7472 6965 7320 746f 2064 656c 6574 6520  tries to delete 
-00015760: 6974 2075 7369 6e67 2073 6b79 2073 746f  it using sky sto
-00015770: 7261 6765 2064 656c 6574 652e 0a20 2020  rage delete..   
-00015780: 2020 2020 2074 6d70 5f73 6372 6174 6368       tmp_scratch
-00015790: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
-000157a0: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
-000157b0: 6529 0a0a 2020 2020 2020 2020 2320 5275  e)..        # Ru
-000157c0: 6e20 736b 7920 7374 6f72 6167 6520 6c73  n sky storage ls
-000157d0: 2074 6f20 6368 6563 6b20 6966 2073 746f   to check if sto
-000157e0: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-000157f0: 7473 2069 6e20 7468 6520 6f75 7470 7574  ts in the output
-00015800: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-00015810: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00015820: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-00015830: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-00015840: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00015850: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-00015860: 6167 655f 6f62 6a2e 6e61 6d65 2069 6e20  age_obj.name in 
-00015870: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-00015880: 3827 290a 0a20 2020 2020 2020 2023 2044  8')..        # D
-00015890: 656c 6574 6520 6275 636b 6574 2065 7874  elete bucket ext
-000158a0: 6572 6e61 6c6c 790a 2020 2020 2020 2020  ernally.        
-000158b0: 636d 6420 3d20 7365 6c66 2e63 6c69 5f64  cmd = self.cli_d
-000158c0: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
-000158d0: 7479 7065 2c20 746d 705f 7363 7261 7463  type, tmp_scratc
-000158e0: 685f 7374 6f72 6167 655f 6f62 6a2e 6e61  h_storage_obj.na
-000158f0: 6d65 290a 2020 2020 2020 2020 7375 6270  me).        subp
-00015900: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-00015910: 7075 7428 636d 642c 2073 6865 6c6c 3d54  put(cmd, shell=T
-00015920: 7275 6529 0a0a 2020 2020 2020 2020 2320  rue)..        # 
-00015930: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
-00015940: 6465 6c65 7465 2074 6f20 6465 6c65 7465  delete to delete
-00015950: 2074 6865 2073 746f 7261 6765 206f 626a   the storage obj
-00015960: 6563 740a 2020 2020 2020 2020 6f75 7420  ect.        out 
-00015970: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00015980: 636b 5f6f 7574 7075 7428 0a20 2020 2020  ck_output(.     
-00015990: 2020 2020 2020 205b 2773 6b79 272c 2027         ['sky', '
-000159a0: 7374 6f72 6167 6527 2c20 2764 656c 6574  storage', 'delet
-000159b0: 6527 2c20 746d 705f 7363 7261 7463 685f  e', tmp_scratch_
-000159c0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-000159d0: 5d29 0a20 2020 2020 2020 2023 204d 616b  ]).        # Mak
-000159e0: 6520 7375 7265 2062 7563 6b65 7420 7761  e sure bucket wa
-000159f0: 7320 6e6f 7420 6372 6561 7465 6420 6475  s not created du
-00015a00: 7269 6e67 2064 656c 6574 696f 6e20 2873  ring deletion (s
-00015a10: 6565 2069 7373 7565 2023 3133 3232 290a  ee issue #1322).
-00015a20: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-00015a30: 6372 6561 7465 6427 206e 6f74 2069 6e20  created' not in 
-00015a40: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-00015a50: 3827 292e 6c6f 7765 7228 290a 0a20 2020  8').lower()..   
-00015a60: 2020 2020 2023 2052 756e 2073 6b79 2073       # Run sky s
-00015a70: 746f 7261 6765 206c 7320 746f 2063 6865  torage ls to che
-00015a80: 636b 2069 6620 7374 6f72 6167 6520 6f62  ck if storage ob
-00015a90: 6a65 6374 2069 7320 6465 6c65 7465 640a  ject is deleted.
-00015aa0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-00015ab0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00015ac0: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
-00015ad0: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
-00015ae0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00015af0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
-00015b00: 6765 5f6f 626a 2e6e 616d 6520 6e6f 7420  ge_obj.name not 
-00015b10: 696e 206f 7574 2e64 6563 6f64 6528 2775  in out.decode('u
-00015b20: 7466 2d38 2729 0a0a 2020 2020 4070 7974  tf-8')..    @pyt
-00015b30: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-00015b40: 7269 7a65 2827 7374 6f72 655f 7479 7065  rize('store_type
-00015b50: 272c 205b 0a20 2020 2020 2020 2073 746f  ', [.        sto
-00015b60: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00015b70: 7065 2e53 332c 2073 746f 7261 6765 5f6c  pe.S3, storage_l
-00015b80: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-00015b90: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-00015ba0: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-00015bb0: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-00015bc0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-00015bd0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
-00015be0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
-00015bf0: 7374 5f62 7563 6b65 745f 6275 6c6b 5f64  st_bucket_bulk_d
-00015c00: 656c 6574 696f 6e28 7365 6c66 2c20 7374  eletion(self, st
-00015c10: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-00015c20: 2020 2023 2043 7265 6174 6520 6120 7465     # Create a te
-00015c30: 6d70 2066 6f6c 6465 7220 7769 7468 206f  mp folder with o
-00015c40: 7665 7220 3235 3620 6669 6c65 7320 616e  ver 256 files an
-00015c50: 6420 666f 6c64 6572 732c 2075 706c 6f61  d folders, uploa
-00015c60: 640a 2020 2020 2020 2020 2320 6669 6c65  d.        # file
-00015c70: 7320 616e 6420 666f 6c64 6572 7320 746f  s and folders to
-00015c80: 2061 206e 6577 2062 7563 6b65 742c 2074   a new bucket, t
-00015c90: 6865 6e20 6465 6c65 7465 2062 7563 6b65  hen delete bucke
-00015ca0: 742e 0a20 2020 2020 2020 2077 6974 6820  t..        with 
-00015cb0: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
-00015cc0: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
-00015cd0: 2074 6d70 6469 723a 0a20 2020 2020 2020   tmpdir:.       
-00015ce0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-00015cf0: 6368 6563 6b5f 6f75 7470 7574 2866 276d  check_output(f'm
-00015d00: 6b64 6972 202d 7020 7b74 6d70 6469 727d  kdir -p {tmpdir}
-00015d10: 2f66 6f6c 6465 727b 7b30 3030 2e2e 3235  /folder{{000..25
-00015d20: 357d 7d27 2c0a 2020 2020 2020 2020 2020  5}}',.          
-00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d40: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-00015d50: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-00015d60: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-00015d70: 636b 5f6f 7574 7075 7428 6627 746f 7563  ck_output(f'touc
-00015d80: 6820 7b74 6d70 6469 727d 2f74 6573 747b  h {tmpdir}/test{
-00015d90: 7b30 3030 2e2e 3235 357d 7d2e 7478 7427  {000..255}}.txt'
-00015da0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dc0: 2020 2020 2020 7368 656c 6c3d 5472 7565        shell=True
-00015dd0: 290a 2020 2020 2020 2020 2020 2020 7375  ).            su
-00015de0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00015df0: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
-00015e00: 2020 2020 2020 2066 2774 6f75 6368 207b         f'touch {
-00015e10: 746d 7064 6972 7d2f 666f 6c64 6572 7b7b  tmpdir}/folder{{
-00015e20: 3030 302e 2e32 3535 7d7d 2f74 6573 742e  000..255}}/test.
-00015e30: 7478 7427 2c20 7368 656c 6c3d 5472 7565  txt', shell=True
-00015e40: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
-00015e50: 696d 6573 7461 6d70 203d 2073 7472 2874  imestamp = str(t
-00015e60: 696d 652e 7469 6d65 2829 292e 7265 706c  ime.time()).repl
-00015e70: 6163 6528 272e 272c 2027 2729 0a20 2020  ace('.', '').   
-00015e80: 2020 2020 2020 2020 2073 746f 7265 5f6f           store_o
-00015e90: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
-00015ea0: 2e53 746f 7261 6765 286e 616d 653d 6627  .Storage(name=f'
-00015eb0: 736b 792d 7465 7374 2d7b 7469 6d65 7374  sky-test-{timest
-00015ec0: 616d 707d 272c 0a20 2020 2020 2020 2020  amp}',.         
-00015ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ef0: 2020 2073 6f75 7263 653d 746d 7064 6972     source=tmpdir
-00015f00: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
-00015f10: 6f72 655f 6f62 6a2e 6164 645f 7374 6f72  ore_obj.add_stor
-00015f20: 6528 7374 6f72 655f 7479 7065 290a 0a20  e(store_type).. 
-00015f30: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-00015f40: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
-00015f50: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-00015f60: 2c20 2764 656c 6574 6527 2c20 7374 6f72  , 'delete', stor
-00015f70: 655f 6f62 6a2e 6e61 6d65 5d29 0a0a 2020  e_obj.name])..  
-00015f80: 2020 2020 2020 6f75 7470 7574 203d 2073        output = s
-00015f90: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00015fa0: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-00015fb0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-00015fc0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00015fd0: 7374 6f72 655f 6f62 6a2e 6e61 6d65 206e  store_obj.name n
-00015fe0: 6f74 2069 6e20 6f75 7470 7574 2e64 6563  ot in output.dec
-00015ff0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
-00016000: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-00016010: 6172 616d 6574 7269 7a65 280a 2020 2020  arametrize(.    
-00016020: 2020 2020 2774 6d70 5f70 7562 6c69 635f      'tmp_public_
-00016030: 7374 6f72 6167 655f 6f62 6a2c 2073 746f  storage_obj, sto
-00016040: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
-00016050: 2020 5b28 2773 333a 2f2f 7463 6761 2d32    [('s3://tcga-2
-00016060: 2d6f 7065 6e27 2c20 7374 6f72 6167 655f  -open', storage_
-00016070: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-00016080: 292c 0a20 2020 2020 2020 2020 2827 7333  ),.         ('s3
-00016090: 3a2f 2f64 6967 6974 616c 636f 7270 6f72  ://digitalcorpor
-000160a0: 6127 2c20 7374 6f72 6167 655f 6c69 622e  a', storage_lib.
-000160b0: 5374 6f72 6554 7970 652e 5333 292c 0a20  StoreType.S3),. 
-000160c0: 2020 2020 2020 2020 2827 6773 3a2f 2f67          ('gs://g
-000160d0: 6370 2d70 7562 6c69 632d 6461 7461 2d73  cp-public-data-s
-000160e0: 656e 7469 6e65 6c2d 3227 2c20 7374 6f72  entinel-2', stor
-000160f0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00016100: 652e 4743 5329 5d2c 0a20 2020 2020 2020  e.GCS)],.       
-00016110: 2069 6e64 6972 6563 743d 5b27 746d 705f   indirect=['tmp_
-00016120: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
-00016130: 626a 275d 290a 2020 2020 6465 6620 7465  bj']).    def te
-00016140: 7374 5f70 7562 6c69 635f 6275 636b 6574  st_public_bucket
-00016150: 2873 656c 662c 2074 6d70 5f70 7562 6c69  (self, tmp_publi
-00016160: 635f 7374 6f72 6167 655f 6f62 6a2c 2073  c_storage_obj, s
-00016170: 746f 7265 5f74 7970 6529 3a0a 2020 2020  tore_type):.    
-00016180: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-00016190: 6e65 7720 6275 636b 6574 2077 6974 6820  new bucket with 
-000161a0: 6120 7075 626c 6963 2073 6f75 7263 6520  a public source 
-000161b0: 616e 6420 7665 7269 6669 6573 2074 6861  and verifies tha
-000161c0: 7420 6974 2069 7320 6e6f 740a 2020 2020  t it is not.    
-000161d0: 2020 2020 2320 6164 6465 6420 746f 2067      # added to g
-000161e0: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
-000161f0: 2e0a 2020 2020 2020 2020 746d 705f 7075  ..        tmp_pu
-00016200: 626c 6963 5f73 746f 7261 6765 5f6f 626a  blic_storage_obj
-00016210: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-00016220: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-00016230: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
-00016240: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
-00016250: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
-00016260: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
-00016270: 7470 7574 0a20 2020 2020 2020 206f 7574  tput.        out
-00016280: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-00016290: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-000162a0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-000162b0: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-000162c0: 6572 7420 746d 705f 7075 626c 6963 5f73  ert tmp_public_s
-000162d0: 746f 7261 6765 5f6f 626a 2e6e 616d 6520  torage_obj.name 
-000162e0: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
-000162f0: 6528 2775 7466 2d38 2729 0a0a 2020 2020  e('utf-8')..    
-00016300: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-00016310: 616d 6574 7269 7a65 2827 6e6f 6e65 7869  ametrize('nonexi
-00016320: 7374 5f62 7563 6b65 745f 7572 6c27 2c20  st_bucket_url', 
-00016330: 5b0a 2020 2020 2020 2020 2773 333a 2f2f  [.        's3://
-00016340: 7b72 616e 646f 6d5f 6e61 6d65 7d27 2c20  {random_name}', 
-00016350: 2767 733a 2f2f 7b72 616e 646f 6d5f 6e61  'gs://{random_na
-00016360: 6d65 7d27 2c0a 2020 2020 2020 2020 7079  me}',.        py
-00016370: 7465 7374 2e70 6172 616d 2827 7232 3a2f  test.param('r2:/
-00016380: 2f7b 7261 6e64 6f6d 5f6e 616d 657d 272c  /{random_name}',
-00016390: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-000163a0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
-000163b0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
-000163c0: 7374 5f6e 6f6e 6578 6973 7465 6e74 5f62  st_nonexistent_b
-000163d0: 7563 6b65 7428 7365 6c66 2c20 6e6f 6e65  ucket(self, none
-000163e0: 7869 7374 5f62 7563 6b65 745f 7572 6c29  xist_bucket_url)
-000163f0: 3a0a 2020 2020 2020 2020 2320 4174 7465  :.        # Atte
-00016400: 6d70 7473 2074 6f20 6372 6561 7465 2066  mpts to create f
-00016410: 6574 6368 2061 2073 7472 6f61 6765 2077  etch a stroage w
-00016420: 6974 6820 6120 6e6f 6e2d 6578 6973 7465  ith a non-existe
-00016430: 6e74 2073 6f75 7263 652e 0a20 2020 2020  nt source..     
-00016440: 2020 2023 2047 656e 6572 6174 6520 6120     # Generate a 
-00016450: 7261 6e64 6f6d 2062 7563 6b65 7420 6e61  random bucket na
-00016460: 6d65 2061 6e64 2076 6572 6966 7920 6974  me and verify it
-00016470: 2064 6f65 736e 2774 2065 7869 7374 3a0a   doesn't exist:.
-00016480: 2020 2020 2020 2020 7265 7472 795f 636f          retry_co
-00016490: 756e 7420 3d20 300a 2020 2020 2020 2020  unt = 0.        
-000164a0: 7768 696c 6520 5472 7565 3a0a 2020 2020  while True:.    
-000164b0: 2020 2020 2020 2020 6e6f 6e65 7869 7374          nonexist
-000164c0: 5f62 7563 6b65 745f 6e61 6d65 203d 2073  _bucket_name = s
-000164d0: 7472 2875 7569 642e 7575 6964 3428 2929  tr(uuid.uuid4())
-000164e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000164f0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-00016500: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
-00016510: 7333 2729 3a0a 2020 2020 2020 2020 2020  s3'):.          
-00016520: 2020 2020 2020 636f 6d6d 616e 6420 3d20        command = 
-00016530: 6627 6177 7320 7333 6170 6920 6865 6164  f'aws s3api head
-00016540: 2d62 7563 6b65 7420 2d2d 6275 636b 6574  -bucket --bucket
-00016550: 207b 6e6f 6e65 7869 7374 5f62 7563 6b65   {nonexist_bucke
-00016560: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
-00016570: 2020 2020 2020 2020 2065 7870 6563 7465           expecte
-00016580: 645f 6f75 7470 7574 203d 2027 3430 3427  d_output = '404'
-00016590: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-000165a0: 6620 6e6f 6e65 7869 7374 5f62 7563 6b65  f nonexist_bucke
-000165b0: 745f 7572 6c2e 7374 6172 7473 7769 7468  t_url.startswith
-000165c0: 2827 6773 2729 3a0a 2020 2020 2020 2020  ('gs'):.        
-000165d0: 2020 2020 2020 2020 636f 6d6d 616e 6420          command 
-000165e0: 3d20 6627 6773 7574 696c 206c 7320 7b6e  = f'gsutil ls {n
-000165f0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
-00016600: 726c 2e66 6f72 6d61 7428 7261 6e64 6f6d  rl.format(random
-00016610: 5f6e 616d 653d 6e6f 6e65 7869 7374 5f62  _name=nonexist_b
-00016620: 7563 6b65 745f 6e61 6d65 297d 270a 2020  ucket_name)}'.  
-00016630: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00016640: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
-00016650: 2742 7563 6b65 744e 6f74 466f 756e 6445  'BucketNotFoundE
-00016660: 7863 6570 7469 6f6e 270a 2020 2020 2020  xception'.      
-00016670: 2020 2020 2020 656c 6966 206e 6f6e 6578        elif nonex
-00016680: 6973 745f 6275 636b 6574 5f75 726c 2e73  ist_bucket_url.s
-00016690: 7461 7274 7377 6974 6828 2772 3227 293a  tartswith('r2'):
-000166a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000166b0: 2065 6e64 706f 696e 745f 7572 6c20 3d20   endpoint_url = 
-000166c0: 636c 6f75 6466 6c61 7265 2e63 7265 6174  cloudflare.creat
-000166d0: 655f 656e 6470 6f69 6e74 2829 0a20 2020  e_endpoint().   
-000166e0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-000166f0: 6d61 6e64 203d 2066 2741 5753 5f53 4841  mand = f'AWS_SHA
-00016700: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
-00016710: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
-00016720: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
-00016730: 5041 5448 7d20 6177 7320 7333 6170 6920  PATH} aws s3api 
-00016740: 6865 6164 2d62 7563 6b65 7420 2d2d 6275  head-bucket --bu
-00016750: 636b 6574 207b 6e6f 6e65 7869 7374 5f62  cket {nonexist_b
-00016760: 7563 6b65 745f 6e61 6d65 7d20 2d2d 656e  ucket_name} --en
-00016770: 6470 6f69 6e74 207b 656e 6470 6f69 6e74  dpoint {endpoint
-00016780: 5f75 726c 7d20 2d2d 7072 6f66 696c 653d  _url} --profile=
-00016790: 7232 270a 2020 2020 2020 2020 2020 2020  r2'.            
-000167a0: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
-000167b0: 7075 7420 3d20 2734 3034 270a 2020 2020  put = '404'.    
-000167c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000167d0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000167e0: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-000167f0: 556e 7375 7070 6f72 7465 6420 6275 636b  Unsupported buck
-00016800: 6574 2074 7970 6520 270a 2020 2020 2020  et type '.      
-00016810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016820: 2020 2020 2020 2020 2020 2066 277b 6e6f             f'{no
-00016830: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
-00016840: 6c7d 2729 0a0a 2020 2020 2020 2020 2020  l}')..          
-00016850: 2020 2320 4368 6563 6b20 6966 2062 7563    # Check if buc
-00016860: 6b65 7420 6578 6973 7473 2075 7369 6e67  ket exists using
-00016870: 2074 6865 2063 6c69 3a0a 2020 2020 2020   the cli:.      
-00016880: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00016890: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-000168a0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-000168b0: 6b5f 6f75 7470 7574 2863 6f6d 6d61 6e64  k_output(command
-000168c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168f0: 7374 6465 7272 3d73 7562 7072 6f63 6573  stderr=subproces
-00016900: 732e 5354 444f 5554 2c0a 2020 2020 2020  s.STDOUT,.      
-00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016930: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
-00016940: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00016950: 6578 6365 7074 2073 7562 7072 6f63 6573  except subproces
-00016960: 732e 4361 6c6c 6564 5072 6f63 6573 7345  s.CalledProcessE
-00016970: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-00016980: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-00016990: 2065 2e6f 7574 7075 740a 2020 2020 2020   e.output.      
-000169a0: 2020 2020 2020 6f75 7420 3d20 6f75 742e        out = out.
-000169b0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-000169c0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-000169d0: 7870 6563 7465 645f 6f75 7470 7574 2069  xpected_output i
-000169e0: 6e20 6f75 743a 0a20 2020 2020 2020 2020  n out:.         
-000169f0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-00016a00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00016a10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00016a20: 6574 7279 5f63 6f75 6e74 202b 3d20 310a  etry_count += 1.
-00016a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a40: 6966 2072 6574 7279 5f63 6f75 6e74 203e  if retry_count >
-00016a50: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
-00016a60: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00016a70: 6e74 696d 6545 7272 6f72 2827 556e 6162  ntimeError('Unab
-00016a80: 6c65 2074 6f20 6669 6e64 2061 206e 6f6e  le to find a non
-00016a90: 6578 6973 7465 6e74 2062 7563 6b65 7420  existent bucket 
-00016aa0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00016ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ac0: 2020 2020 2020 2020 2027 746f 2075 7365           'to use
-00016ad0: 2e20 5468 6973 2069 7320 6869 676c 7920  . This is higly 
-00016ae0: 756e 6c69 6b65 6c79 202d 2027 0a20 2020  unlikely - '.   
-00016af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b10: 2020 2020 2763 6865 636b 2069 6620 7468      'check if th
-00016b20: 6520 7465 7374 7320 6172 6520 636f 7272  e tests are corr
-00016b30: 6563 742e 2729 0a0a 2020 2020 2020 2020  ect.')..        
-00016b40: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-00016b50: 6573 280a 2020 2020 2020 2020 2020 2020  es(.            
-00016b60: 2020 2020 736b 792e 6578 6365 7074 696f      sky.exceptio
-00016b70: 6e73 2e53 746f 7261 6765 4275 636b 6574  ns.StorageBucket
-00016b80: 4765 7445 7272 6f72 2c0a 2020 2020 2020  GetError,.      
-00016b90: 2020 2020 2020 2020 2020 6d61 7463 683d            match=
-00016ba0: 2741 7474 656d 7074 6564 2074 6f20 636f  'Attempted to co
-00016bb0: 6e6e 6563 7420 746f 2061 206e 6f6e 2d65  nnect to a non-e
-00016bc0: 7869 7374 656e 7420 6275 636b 6574 2729  xistent bucket')
-00016bd0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-00016be0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
-00016bf0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
-00016c00: 736f 7572 6365 3d6e 6f6e 6578 6973 745f  source=nonexist_
-00016c10: 6275 636b 6574 5f75 726c 2e66 6f72 6d61  bucket_url.forma
-00016c20: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00016c30: 2020 2072 616e 646f 6d5f 6e61 6d65 3d6e     random_name=n
-00016c40: 6f6e 6578 6973 745f 6275 636b 6574 5f6e  onexist_bucket_n
-00016c50: 616d 6529 290a 0a20 2020 2040 7079 7465  ame))..    @pyte
-00016c60: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
-00016c70: 697a 6528 2770 7269 7661 7465 5f62 7563  ize('private_buc
-00016c80: 6b65 7427 2c0a 2020 2020 2020 2020 2020  ket',.          
-00016c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ca0: 2020 205b 6627 7333 3a2f 2f69 6d61 6765     [f's3://image
-00016cb0: 6e65 7427 2c20 6627 6773 3a2f 2f69 6d61  net', f'gs://ima
-00016cc0: 6765 6e65 7427 5d29 0a20 2020 2064 6566  genet']).    def
-00016cd0: 2074 6573 745f 7072 6976 6174 655f 6275   test_private_bu
-00016ce0: 636b 6574 2873 656c 662c 2070 7269 7661  cket(self, priva
-00016cf0: 7465 5f62 7563 6b65 7429 3a0a 2020 2020  te_bucket):.    
-00016d00: 2020 2020 2320 4174 7465 6d70 7473 2074      # Attempts t
-00016d10: 6f20 6163 6365 7373 2070 7269 7661 7465  o access private
-00016d20: 2062 7563 6b65 7473 206e 6f74 2062 656c   buckets not bel
-00016d30: 6f6e 6769 6e67 2074 6f20 7468 6520 7573  onging to the us
-00016d40: 6572 2e0a 2020 2020 2020 2020 2320 5468  er..        # Th
-00016d50: 6573 6520 6275 636b 6574 7320 6172 6520  ese buckets are 
-00016d60: 6b6e 6f77 6e20 746f 2062 6520 7072 6976  known to be priv
-00016d70: 6174 652c 2062 7574 206d 6179 206e 6565  ate, but may nee
-00016d80: 6420 746f 2062 6520 7570 6461 7465 6420  d to be updated 
-00016d90: 6966 0a20 2020 2020 2020 2023 2074 6865  if.        # the
-00016da0: 7920 6172 6520 7265 6d6f 7665 6420 6279  y are removed by
-00016db0: 2074 6865 6972 206f 776e 6572 732e 0a20   their owners.. 
-00016dc0: 2020 2020 2020 2070 7269 7661 7465 5f62         private_b
-00016dd0: 7563 6b65 745f 6e61 6d65 203d 2075 726c  ucket_name = url
-00016de0: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
-00016df0: 6974 2870 7269 7661 7465 5f62 7563 6b65  it(private_bucke
-00016e00: 7429 2e6e 6574 6c6f 630a 2020 2020 2020  t).netloc.      
-00016e10: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
-00016e20: 6973 6573 280a 2020 2020 2020 2020 2020  ises(.          
-00016e30: 2020 2020 2020 736b 792e 6578 6365 7074        sky.except
-00016e40: 696f 6e73 2e53 746f 7261 6765 4275 636b  ions.StorageBuck
-00016e50: 6574 4765 7445 7272 6f72 2c0a 2020 2020  etGetError,.    
-00016e60: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
-00016e70: 683d 7374 6f72 6167 655f 6c69 622e 5f42  h=storage_lib._B
-00016e80: 5543 4b45 545f 4641 494c 5f54 4f5f 434f  UCKET_FAIL_TO_CO
-00016e90: 4e4e 4543 545f 4d45 5353 4147 452e 666f  NNECT_MESSAGE.fo
-00016ea0: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
-00016eb0: 2020 2020 2020 2020 2020 6e61 6d65 3d70            name=p
-00016ec0: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
-00016ed0: 6d65 2929 3a0a 2020 2020 2020 2020 2020  me)):.          
-00016ee0: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
-00016ef0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00016f00: 6167 6528 736f 7572 6365 3d70 7269 7661  age(source=priva
-00016f10: 7465 5f62 7563 6b65 7429 0a0a 2020 2020  te_bucket)..    
-00016f20: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-00016f30: 616d 6574 7269 7a65 2827 6578 745f 6275  ametrize('ext_bu
-00016f40: 636b 6574 5f66 6978 7475 7265 2c20 7374  cket_fixture, st
-00016f50: 6f72 655f 7479 7065 272c 0a20 2020 2020  ore_type',.     
-00016f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f70: 2020 2020 2020 2020 5b28 2774 6d70 5f61          [('tmp_a
-00016f80: 7773 636c 695f 6275 636b 6574 272c 2073  wscli_bucket', s
-00016f90: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00016fa0: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
+00009100: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00009110: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+00009120: 207b 5343 505f 4750 555f 5631 3030 7d3a   {SCP_GPU_V100}:
+00009130: 7b6e 756d 5f6f 665f 6770 755f 6c61 756e  {num_of_gpu_laun
+00009140: 6368 7d20 6578 616d 706c 6573 2f6a 6f62  ch} examples/job
+00009150: 5f71 7565 7565 2f63 6c75 7374 6572 2e79  _queue/cluster.y
+00009160: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00009170: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00009180: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3120  me} -n {name}-1 
+00009190: 7b53 4350 5f47 5055 5f56 3130 307d 3a7b  {SCP_GPU_V100}:{
+000091a0: 6e75 6d5f 6f66 5f67 7075 5f65 7865 637d  num_of_gpu_exec}
+000091b0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+000091c0: 5f71 7565 7565 2f6a 6f62 2e79 616d 6c27  _queue/job.yaml'
+000091d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000091e0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000091f0: 2d6e 207b 6e61 6d65 7d2d 3220 7b53 4350  -n {name}-2 {SCP
+00009200: 5f47 5055 5f56 3130 307d 3a7b 6e75 6d5f  _GPU_V100}:{num_
+00009210: 6f66 5f67 7075 5f65 7865 637d 202d 6420  of_gpu_exec} -d 
+00009220: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+00009230: 7565 2f6a 6f62 2e79 616d 6c27 2c0a 2020  ue/job.yaml',.  
+00009240: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009250: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
+00009260: 6e61 6d65 7d2d 3320 7b53 4350 5f47 5055  name}-3 {SCP_GPU
+00009270: 5f56 3130 307d 3a7b 6e75 6d5f 6f66 5f67  _V100}:{num_of_g
+00009280: 7075 5f65 7865 637d 202d 6420 6578 616d  pu_exec} -d exam
+00009290: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
+000092a0: 6f62 2e79 616d 6c27 2c0a 2020 2020 2020  ob.yaml',.      
+000092b0: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
+000092c0: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
+000092d0: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
+000092e0: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+000092f0: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
+00009300: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
+00009310: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
+00009320: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+00009330: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
+00009340: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
+00009350: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+00009360: 5045 4e44 494e 4727 2c0a 2020 2020 2020  PENDING',.      
+00009370: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+00009380: 656c 202d 7920 7b6e 616d 657d 2032 272c  el -y {name} 2',
+00009390: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000093a0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+000093b0: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
+000093c0: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
+000093d0: 616d 657d 2d33 207c 2067 7265 7020 5255  ame}-3 | grep RU
+000093e0: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
+000093f0: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
+00009400: 202d 7920 7b6e 616d 657d 2033 272c 0a20   -y {name} 3',. 
+00009410: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00009420: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00009430: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00009440: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00009450: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00009460: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00009470: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00009480: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
+00009490: 7665 2054 3420 6770 7573 0a40 7079 7465  ve T4 gpus.@pyte
+000094a0: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+000094b0: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+000094c0: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+000094d0: 732e 2072 756e 2074 6573 745f 6962 6d5f  s. run test_ibm_
+000094e0: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
+000094f0: 6f64 6520 696e 7374 6561 640a 4070 7974  ode instead.@pyt
+00009500: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00009510: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00009520: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00009530: 7320 3e20 3120 7965 740a 4070 7974 6573  s > 1 yet.@pytes
+00009540: 742e 6d61 726b 2e6e 6f5f 6f63 6920 2023  t.mark.no_oci  #
+00009550: 204f 4349 2043 6c6f 7564 2064 6f65 7320   OCI Cloud does 
+00009560: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+00009570: 2e0a 6465 6620 7465 7374 5f6a 6f62 5f71  ..def test_job_q
+00009580: 7565 7565 5f6d 756c 7469 6e6f 6465 2867  ueue_multinode(g
+00009590: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+000095a0: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+000095b0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+000095c0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+000095d0: 7374 280a 2020 2020 2020 2020 276a 6f62  st(.        'job
+000095e0: 5f71 7565 7565 5f6d 756c 7469 6e6f 6465  _queue_multinode
+000095f0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00009600: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00009610: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00009620: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00009630: 7269 635f 636c 6f75 647d 2065 7861 6d70  ric_cloud} examp
+00009640: 6c65 732f 6a6f 625f 7175 6575 652f 636c  les/job_queue/cl
+00009650: 7573 7465 725f 6d75 6c74 696e 6f64 652e  uster_multinode.
+00009660: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00009670: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00009680: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
+00009690: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+000096a0: 5f71 7565 7565 2f6a 6f62 5f6d 756c 7469  _queue/job_multi
+000096b0: 6e6f 6465 2e79 616d 6c27 2c0a 2020 2020  node.yaml',.    
+000096c0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000096d0: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+000096e0: 6d65 7d2d 3220 2d64 2065 7861 6d70 6c65  me}-2 -d example
+000096f0: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+00009700: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
+00009710: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00009720: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+00009730: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
+00009740: 2d2d 6465 7461 6368 2d73 6574 7570 202d  --detach-setup -
+00009750: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+00009760: 7565 7565 2f6a 6f62 5f6d 756c 7469 6e6f  ueue/job_multino
+00009770: 6465 2e79 616d 6c27 2c0a 2020 2020 2020  de.yaml',.      
+00009780: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+00009790: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
+000097a0: 2065 6368 6f20 2224 7322 2026 2620 2865   echo "$s" && (e
+000097b0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+000097c0: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
+000097d0: 5255 4e4e 494e 4729 272c 0a20 2020 2020  RUNNING)',.     
+000097e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+000097f0: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
+00009800: 2620 6563 686f 2022 2473 2220 2626 2028  & echo "$s" && (
+00009810: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00009820: 207b 6e61 6d65 7d2d 3220 7c20 6772 6570   {name}-2 | grep
+00009830: 2052 554e 4e49 4e47 2927 2c0a 2020 2020   RUNNING)',.    
+00009840: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00009850: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
+00009860: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+00009870: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
+00009880: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
+00009890: 7020 5045 4e44 494e 4729 272c 0a20 2020  p PENDING)',.   
+000098a0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000098b0: 3930 272c 0a20 2020 2020 2020 2020 2020  90',.           
+000098c0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+000098d0: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
+000098e0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+000098f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00009900: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+00009910: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+00009920: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+00009930: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00009940: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+00009950: 5345 5454 494e 475f 5550 272c 0a20 2020  SETTING_UP',.   
+00009960: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+00009970: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+00009980: 3120 3220 3327 2c0a 2020 2020 2020 2020  1 2 3',.        
+00009990: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000099a0: 202d 6320 7b6e 616d 657d 202d 6e20 7b6e   -c {name} -n {n
+000099b0: 616d 657d 2d34 202d 2d64 6574 6163 682d  ame}-4 --detach-
+000099c0: 7365 7475 7020 2d64 2065 7861 6d70 6c65  setup -d example
+000099d0: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+000099e0: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
+000099f0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00009a00: 6573 7420 7468 6520 6a6f 6220 7374 6174  est the job stat
+00009a10: 7573 2069 7320 636f 7272 6563 746c 7920  us is correctly 
+00009a20: 7365 7420 746f 2053 4554 5449 4e47 5f55  set to SETTING_U
+00009a30: 502c 2064 7572 696e 6720 7468 6520 7365  P, during the se
+00009a40: 7475 7020 6973 2072 756e 6e69 6e67 2c0a  tup is running,.
+00009a50: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+00009a60: 6420 7468 6520 6a6f 6220 6361 6e20 6265  d the job can be
+00009a70: 2063 616e 6365 6c6c 6564 2064 7572 696e   cancelled durin
+00009a80: 6720 7468 6520 7365 7475 702e 0a20 2020  g the setup..   
+00009a90: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+00009aa0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+00009ab0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+00009ac0: 7b6e 616d 657d 2920 2626 2065 6368 6f20  {name}) && echo 
+00009ad0: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+00009ae0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+00009af0: 2d34 207c 2067 7265 7020 5345 5454 494e  -4 | grep SETTIN
+00009b00: 475f 5550 2927 2c0a 2020 2020 2020 2020  G_UP)',.        
+00009b10: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
+00009b20: 202d 7920 7b6e 616d 657d 2034 272c 0a20   -y {name} 4',. 
+00009b30: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00009b40: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+00009b50: 7d29 2026 2620 6563 686f 2022 2473 2220  }) && echo "$s" 
+00009b60: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
+00009b70: 6772 6570 207b 6e61 6d65 7d2d 3420 7c20  grep {name}-4 | 
+00009b80: 6772 6570 2043 414e 4345 4c4c 4544 2927  grep CANCELLED)'
+00009b90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00009ba0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00009bb0: 2d2d 6770 7573 2054 343a 302e 3220 225b  --gpus T4:0.2 "[
+00009bc0: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
+00009bd0: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
+00009be0: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
+00009bf0: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
+00009c00: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00009c10: 657d 202d 2d67 7075 7320 5434 3a30 2e32  e} --gpus T4:0.2
+00009c20: 202d 2d6e 756d 2d6e 6f64 6573 2032 2022   --num-nodes 2 "
+00009c30: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
+00009c40: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
+00009c50: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
+00009c60: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+00009c70: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00009c80: 6d65 7d20 2d2d 6770 7573 2054 343a 3120  me} --gpus T4:1 
+00009c90: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 225b  --num-nodes 2 "[
+00009ca0: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
+00009cb0: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
+00009cc0: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
+00009cd0: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
+00009ce0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00009cf0: 657d 2035 202d 2d73 7461 7475 7327 2c0a  e} 5 --status',.
+00009d00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009d10: 7920 6c6f 6773 207b 6e61 6d65 7d20 3620  y logs {name} 6 
+00009d20: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00009d30: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00009d40: 7320 7b6e 616d 657d 2037 202d 2d73 7461  s {name} 7 --sta
+00009d50: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
+00009d60: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00009d70: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00009d80: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00009d90: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00009da0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+00009db0: 616d 6264 615f 636c 6f75 6420 2023 204e  ambda_cloud  # N
+00009dc0: 6f20 4c61 6d62 6461 2043 6c6f 7564 2056  o Lambda Cloud V
+00009dd0: 4d20 6861 7320 3820 4350 5573 0a64 6566  M has 8 CPUs.def
+00009de0: 2074 6573 745f 6c61 7267 655f 6a6f 625f   test_large_job_
+00009df0: 7175 6575 6528 6765 6e65 7269 635f 636c  queue(generic_cl
+00009e00: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
+00009e10: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00009e20: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00009e30: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00009e40: 2020 2027 6c61 7267 655f 6a6f 625f 7175     'large_job_qu
+00009e50: 6575 6527 2c0a 2020 2020 2020 2020 5b0a  eue',.        [.
+00009e60: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00009e70: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00009e80: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00009e90: 656e 6572 6963 5f63 6c6f 7564 7d27 2c0a  eneric_cloud}',.
+00009ea0: 2020 2020 2020 2020 2020 2020 6627 666f              f'fo
+00009eb0: 7220 6920 696e 2060 7365 7120 3120 3735  r i in `seq 1 75
+00009ec0: 603b 2064 6f20 736b 7920 6578 6563 207b  `; do sky exec {
+00009ed0: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+00009ee0: 2469 202d 6420 2265 6368 6f20 2469 3b20  $i -d "echo $i; 
+00009ef0: 736c 6565 7020 3130 3030 3030 3030 3022  sleep 100000000"
+00009f00: 3b20 646f 6e65 272c 0a20 2020 2020 2020  ; done',.       
+00009f10: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+00009f20: 6c20 2d79 207b 6e61 6d65 7d20 3120 3220  l -y {name} 1 2 
+00009f30: 3320 3420 3520 3620 3720 3820 3920 3130  3 4 5 6 7 8 9 10
+00009f40: 2031 3120 3132 2031 3320 3134 2031 3520   11 12 13 14 15 
+00009f50: 3136 272c 0a20 2020 2020 2020 2020 2020  16',.           
+00009f60: 2027 736c 6565 7020 3735 272c 0a20 2020   'sleep 75',.   
+00009f70: 2020 2020 2020 2020 2023 2045 6163 6820           # Each 
+00009f80: 6a6f 6220 7461 6b65 7320 302e 3520 4350  job takes 0.5 CP
+00009f90: 5520 616e 6420 7468 6520 6465 6661 756c  U and the defaul
+00009fa0: 7420 564d 2068 6173 2038 2043 5055 732c  t VM has 8 CPUs,
+00009fb0: 2073 6f20 7468 6572 6520 7368 6f75 6c64   so there should
+00009fc0: 2062 6520 3820 2f20 302e 3520 3d20 3136   be 8 / 0.5 = 16
+00009fd0: 206a 6f62 7320 7275 6e6e 696e 672e 0a20   jobs running.. 
+00009fe0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00009ff0: 2066 6972 7374 2031 3620 6a6f 6273 2061   first 16 jobs a
+0000a000: 7265 2063 616e 6365 6c65 642c 2073 6f20  re canceled, so 
+0000a010: 7468 6572 6520 7368 6f75 6c64 2062 6520  there should be 
+0000a020: 3735 202d 2033 3220 3d20 3433 206a 6f62  75 - 32 = 43 job
+0000a030: 7320 5045 4e44 494e 472e 0a20 2020 2020  s PENDING..     
+0000a040: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000a050: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000a060: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000a070: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000a080: 207c 2067 7265 7020 2d76 2067 7265 7020   | grep -v grep 
+0000a090: 7c20 6772 6570 2050 454e 4449 4e47 207c  | grep PENDING |
+0000a0a0: 2077 6320 2d6c 207c 2067 7265 7020 3433   wc -l | grep 43
+0000a0b0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0000a0c0: 204d 616b 6520 7375 7265 2074 6865 206a   Make sure the j
+0000a0d0: 6f62 7320 6172 6520 7363 6865 6475 6c65  obs are schedule
+0000a0e0: 6420 696e 2046 4946 4f20 6f72 6465 720a  d in FIFO order.
+0000a0f0: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
+0000a100: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000a110: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000a120: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000a130: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000a140: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000a150: 7b6e 616d 657d 2d7b 697d 207c 2067 7265  {name}-{i} | gre
+0000a160: 7020 4341 4e43 454c 4c45 4427 0a20 2020  p CANCELLED'.   
+0000a170: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000a180: 2069 2069 6e20 7261 6e67 6528 312c 2031   i in range(1, 1
+0000a190: 3729 0a20 2020 2020 2020 2020 2020 205d  7).            ]
+0000a1a0: 2c0a 2020 2020 2020 2020 2020 2020 2a5b  ,.            *[
+0000a1b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a1c0: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000a1d0: 207b 6e61 6d65 7d29 3b20 6563 686f 2022   {name}); echo "
+0000a1e0: 2473 223b 2065 6368 6f3b 2065 6368 6f3b  $s"; echo; echo;
+0000a1f0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+0000a200: 7020 7b6e 616d 657d 2d7b 697d 207c 2067  p {name}-{i} | g
+0000a210: 7265 7020 5255 4e4e 494e 4727 0a20 2020  rep RUNNING'.   
+0000a220: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000a230: 2069 2069 6e20 7261 6e67 6528 3137 2c20   i in range(17, 
+0000a240: 3333 290a 2020 2020 2020 2020 2020 2020  33).            
+0000a250: 5d2c 0a20 2020 2020 2020 2020 2020 202a  ],.            *
+0000a260: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0000a270: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000a280: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
+0000a290: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000a2a0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+0000a2b0: 6570 207b 6e61 6d65 7d2d 7b69 7d20 7c20  ep {name}-{i} | 
+0000a2c0: 6772 6570 2050 454e 4449 4e47 270a 2020  grep PENDING'.  
+0000a2d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0000a2e0: 7220 6920 696e 2072 616e 6765 2833 332c  r i in range(33,
+0000a2f0: 2037 3529 0a20 2020 2020 2020 2020 2020   75).           
+0000a300: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+0000a310: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+0000a320: 7b6e 616d 657d 2033 3320 3335 2033 3720  {name} 33 35 37 
+0000a330: 3339 2031 3720 3138 2031 3927 2c0a 2020  39 17 18 19',.  
+0000a340: 2020 2020 2020 2020 2020 2a5b 0a20 2020            *[.   
+0000a350: 2020 2020 2020 2020 2020 2020 2066 2773               f's
+0000a360: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000a370: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+0000a380: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+0000a390: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000a3a0: 616d 657d 2d7b 697d 207c 2067 7265 7020  ame}-{i} | grep 
+0000a3b0: 4341 4e43 454c 4c45 4427 0a20 2020 2020  CANCELLED'.     
+0000a3c0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0000a3d0: 2069 6e20 7261 6e67 6528 3333 2c20 3430   in range(33, 40
+0000a3e0: 2c20 3229 0a20 2020 2020 2020 2020 2020  , 2).           
+0000a3f0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+0000a400: 2773 6c65 6570 2031 3027 2c0a 2020 2020  'sleep 10',.    
+0000a410: 2020 2020 2020 2020 2a5b 0a20 2020 2020          *[.     
+0000a420: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000a430: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000a440: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000a450: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000a460: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000a470: 657d 2d7b 697d 207c 2067 7265 7020 5255  e}-{i} | grep RU
+0000a480: 4e4e 494e 4727 0a20 2020 2020 2020 2020  NNING'.         
+0000a490: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0000a4a0: 5b33 342c 2033 362c 2033 385d 0a20 2020  [34, 36, 38].   
+0000a4b0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
+0000a4c0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000a4d0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000a4e0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000a4f0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+0000a500: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000a510: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0000a520: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+0000a530: 6d62 6461 5f63 6c6f 7564 2020 2320 4e6f  mbda_cloud  # No
+0000a540: 204c 616d 6264 6120 436c 6f75 6420 564d   Lambda Cloud VM
+0000a550: 2068 6173 2038 2043 5055 730a 6465 6620   has 8 CPUs.def 
+0000a560: 7465 7374 5f66 6173 745f 6c61 7267 655f  test_fast_large_
+0000a570: 6a6f 625f 7175 6575 6528 6765 6e65 7269  job_queue(generi
+0000a580: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+0000a590: 2020 2023 2054 6869 7320 6973 2074 6f20     # This is to 
+0000a5a0: 7465 7374 2074 6865 206a 6f62 7320 6361  test the jobs ca
+0000a5b0: 6e20 6265 2073 6368 6564 756c 6564 2071  n be scheduled q
+0000a5c0: 7569 636b 6c79 2077 6865 6e20 7468 6572  uickly when ther
+0000a5d0: 6520 6172 6520 6d61 6e79 206a 6f62 7320  e are many jobs 
+0000a5e0: 696e 2074 6865 2071 7565 7565 2e0a 2020  in the queue..  
+0000a5f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0000a600: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0000a610: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000a620: 2020 2020 2020 2766 6173 745f 6c61 7267        'fast_larg
+0000a630: 655f 6a6f 625f 7175 6575 6527 2c0a 2020  e_job_queue',.  
+0000a640: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000a650: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000a660: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+0000a670: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0000a680: 6c6f 7564 7d27 2c0a 2020 2020 2020 2020  loud}',.        
+0000a690: 2020 2020 6627 666f 7220 6920 696e 2060      f'for i in `
+0000a6a0: 7365 7120 3120 3332 603b 2064 6f20 736b  seq 1 32`; do sk
+0000a6b0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+0000a6c0: 207b 6e61 6d65 7d2d 2469 202d 6420 2265   {name}-$i -d "e
+0000a6d0: 6368 6f20 2469 223b 2064 6f6e 6527 2c0a  cho $i"; done',.
+0000a6e0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000a6f0: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
+0000a700: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000a710: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000a720: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000a730: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000a740: 6772 6570 202d 7620 6772 6570 207c 2067  grep -v grep | g
+0000a750: 7265 7020 5355 4343 4545 4445 4420 7c20  rep SUCCEEDED | 
+0000a760: 7763 202d 6c20 7c20 6772 6570 2033 3227  wc -l | grep 32'
+0000a770: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0000a780: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000a790: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000a7a0: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+0000a7b0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0000a7c0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000a7d0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000a7e0: 2e69 626d 0a64 6566 2074 6573 745f 6962  .ibm.def test_ib
+0000a7f0: 6d5f 6a6f 625f 7175 6575 655f 6d75 6c74  m_job_queue_mult
+0000a800: 696e 6f64 6528 293a 0a20 2020 206e 616d  inode():.    nam
+0000a810: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000a820: 5f6e 616d 6528 290a 2020 2020 7461 736b  _name().    task
+0000a830: 5f66 696c 6520 3d20 2765 7861 6d70 6c65  _file = 'example
+0000a840: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+0000a850: 6d75 6c74 696e 6f64 655f 6962 6d2e 7961  multinode_ibm.ya
+0000a860: 6d6c 270a 2020 2020 7465 7374 203d 2054  ml'.    test = T
+0000a870: 6573 7428 0a20 2020 2020 2020 2027 6962  est(.        'ib
+0000a880: 6d5f 6a6f 625f 7175 6575 655f 6d75 6c74  m_job_queue_mult
+0000a890: 696e 6f64 6527 2c0a 2020 2020 2020 2020  inode',.        
+0000a8a0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000a8b0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000a8c0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+0000a8d0: 6962 6d20 2d2d 6770 7573 2076 3130 3020  ibm --gpus v100 
+0000a8e0: 2d2d 6e75 6d2d 6e6f 6465 7320 3227 2c0a  --num-nodes 2',.
+0000a8f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000a900: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+0000a910: 207b 6e61 6d65 7d2d 3120 2d64 207b 7461   {name}-1 -d {ta
+0000a920: 736b 5f66 696c 657d 272c 0a20 2020 2020  sk_file}',.     
+0000a930: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000a940: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000a950: 657d 2d32 202d 6420 7b74 6173 6b5f 6669  e}-2 -d {task_fi
+0000a960: 6c65 7d27 2c0a 2020 2020 2020 2020 2020  le}',.          
+0000a970: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000a980: 7920 2d63 207b 6e61 6d65 7d20 2d6e 207b  y -c {name} -n {
+0000a990: 6e61 6d65 7d2d 3320 2d2d 6465 7461 6368  name}-3 --detach
+0000a9a0: 2d73 6574 7570 202d 6420 7b74 6173 6b5f  -setup -d {task_
+0000a9b0: 6669 6c65 7d27 2c0a 2020 2020 2020 2020  file}',.        
+0000a9c0: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000a9d0: 6575 6520 7b6e 616d 657d 2920 2626 2070  eue {name}) && p
+0000a9e0: 7269 6e74 6620 2224 7322 2026 2620 2865  rintf "$s" && (e
+0000a9f0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000aa00: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
+0000aa10: 5255 4e4e 494e 4729 272c 0a20 2020 2020  RUNNING)',.     
+0000aa20: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000aa30: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
+0000aa40: 2620 7072 696e 7466 2022 2473 2220 2626  & printf "$s" &&
+0000aa50: 2028 6563 686f 2022 2473 2220 7c20 6772   (echo "$s" | gr
+0000aa60: 6570 207b 6e61 6d65 7d2d 3220 7c20 6772  ep {name}-2 | gr
+0000aa70: 6570 2052 554e 4e49 4e47 2927 2c0a 2020  ep RUNNING)',.  
+0000aa80: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000aa90: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000aaa0: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000aab0: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000aac0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000aad0: 2067 7265 7020 5345 5454 494e 475f 5550   grep SETTING_UP
+0000aae0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000aaf0: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
+0000ab00: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000ab10: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
+0000ab20: 2626 2070 7269 6e74 6620 2224 7322 2026  && printf "$s" &
+0000ab30: 2620 2865 6368 6f20 2224 7322 207c 2067  & (echo "$s" | g
+0000ab40: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
+0000ab50: 7265 7020 5045 4e44 494e 4729 272c 0a20  rep PENDING)',. 
+0000ab60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000ab70: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000ab80: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
+0000ab90: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+0000aba0: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
+0000abb0: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
+0000abc0: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
+0000abd0: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
+0000abe0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
+0000abf0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
+0000ac00: 3120 3220 3327 2c0a 2020 2020 2020 2020  1 2 3',.        
+0000ac10: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000ac20: 202d 6320 7b6e 616d 657d 202d 6e20 7b6e   -c {name} -n {n
+0000ac30: 616d 657d 2d34 202d 2d64 6574 6163 682d  ame}-4 --detach-
+0000ac40: 7365 7475 7020 2d64 207b 7461 736b 5f66  setup -d {task_f
+0000ac50: 696c 657d 272c 0a20 2020 2020 2020 2020  ile}',.         
+0000ac60: 2020 2023 2054 6573 7420 7468 6520 6a6f     # Test the jo
+0000ac70: 6220 7374 6174 7573 2069 7320 636f 7272  b status is corr
+0000ac80: 6563 746c 7920 7365 7420 746f 2053 4554  ectly set to SET
+0000ac90: 5449 4e47 5f55 502c 2064 7572 696e 6720  TING_UP, during 
+0000aca0: 7468 6520 7365 7475 7020 6973 2072 756e  the setup is run
+0000acb0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+0000acc0: 2020 2320 616e 6420 7468 6520 6a6f 6220    # and the job 
+0000acd0: 6361 6e20 6265 2063 616e 6365 6c6c 6564  can be cancelled
+0000ace0: 2064 7572 696e 6720 7468 6520 7365 7475   during the setu
+0000acf0: 702e 0a20 2020 2020 2020 2020 2020 2066  p..            f
+0000ad00: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000ad10: 6e61 6d65 7d29 2026 2620 7072 696e 7466  name}) && printf
+0000ad20: 2022 2473 2220 2626 2028 6563 686f 2022   "$s" && (echo "
+0000ad30: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000ad40: 7d2d 3420 7c20 6772 6570 2053 4554 5449  }-4 | grep SETTI
+0000ad50: 4e47 5f55 5029 272c 0a20 2020 2020 2020  NG_UP)',.       
+0000ad60: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000ad70: 6c20 2d79 207b 6e61 6d65 7d20 3427 2c0a  l -y {name} 4',.
+0000ad80: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000ad90: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000ada0: 657d 2920 2626 2070 7269 6e74 6620 2224  e}) && printf "$
+0000adb0: 7322 2026 2620 2865 6368 6f20 2224 7322  s" && (echo "$s"
+0000adc0: 207c 2067 7265 7020 7b6e 616d 657d 2d34   | grep {name}-4
+0000add0: 207c 2067 7265 7020 4341 4e43 454c 4c45   | grep CANCELLE
+0000ade0: 4429 272c 0a20 2020 2020 2020 2020 2020  D)',.           
+0000adf0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000ae00: 657d 202d 2d67 7075 7320 7631 3030 3a30  e} --gpus v100:0
+0000ae10: 2e32 2022 5b5b 205c 2453 4b59 5049 4c4f  .2 "[[ \$SKYPILO
+0000ae20: 545f 4e55 4d5f 4750 5553 5f50 4552 5f4e  T_NUM_GPUS_PER_N
+0000ae30: 4f44 4520 2d65 7120 3120 5d5d 207c 7c20  ODE -eq 1 ]] || 
+0000ae40: 6578 6974 2031 2227 2c0a 2020 2020 2020  exit 1"',.      
+0000ae50: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000ae60: 207b 6e61 6d65 7d20 2d2d 6770 7573 2076   {name} --gpus v
+0000ae70: 3130 303a 302e 3220 2d2d 6e75 6d2d 6e6f  100:0.2 --num-no
+0000ae80: 6465 7320 3220 225b 5b20 5c24 534b 5950  des 2 "[[ \$SKYP
+0000ae90: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
+0000aea0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
+0000aeb0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
+0000aec0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000aed0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000aee0: 7320 7631 3030 3a31 202d 2d6e 756d 2d6e  s v100:1 --num-n
+0000aef0: 6f64 6573 2032 2022 5b5b 205c 2453 4b59  odes 2 "[[ \$SKY
+0000af00: 5049 4c4f 545f 4e55 4d5f 4750 5553 5f50  PILOT_NUM_GPUS_P
+0000af10: 4552 5f4e 4f44 4520 2d65 7120 3120 5d5d  ER_NODE -eq 1 ]]
+0000af20: 207c 7c20 6578 6974 2031 2227 2c0a 2020   || exit 1"',.  
+0000af30: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000af40: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
+0000af50: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+0000af60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000af70: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
+0000af80: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+0000af90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000afa0: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
+0000afb0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0000afc0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0000afd0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+0000afe0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000aff0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000b000: 2d2d 2d2d 2053 7562 6d69 7474 696e 6720  ---- Submitting 
+0000b010: 6d75 6c74 6970 6c65 2074 6173 6b73 2074  multiple tasks t
+0000b020: 6f20 7468 6520 7361 6d65 2063 6c75 7374  o the same clust
+0000b030: 6572 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  er. ----------.@
+0000b040: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+0000b050: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+0000b060: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+0000b070: 206e 6f74 2068 6176 6520 4b38 3020 6770   not have K80 gp
+0000b080: 7573 0a40 7079 7465 7374 2e6d 6172 6b2e  us.@pytest.mark.
+0000b090: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
+0000b0a0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000b0b0: 6520 4b38 3020 6770 7573 0a40 7079 7465  e K80 gpus.@pyte
+0000b0c0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000b0d0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0000b0e0: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+0000b0f0: 203e 2031 2079 6574 0a40 7079 7465 7374   > 1 yet.@pytest
+0000b100: 2e6d 6172 6b2e 6e6f 5f6f 6369 2020 2320  .mark.no_oci  # 
+0000b110: 4f43 4920 436c 6f75 6420 646f 6573 206e  OCI Cloud does n
+0000b120: 6f74 2068 6176 6520 4b38 3020 6770 7573  ot have K80 gpus
+0000b130: 0a64 6566 2074 6573 745f 6d75 6c74 695f  .def test_multi_
+0000b140: 6563 686f 2867 656e 6572 6963 5f63 6c6f  echo(generic_clo
+0000b150: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+0000b160: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0000b170: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+0000b180: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+0000b190: 2020 276d 756c 7469 5f65 6368 6f27 2c0a    'multi_echo',.
+0000b1a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0000b1b0: 2020 2020 2020 6627 7079 7468 6f6e 2065        f'python e
+0000b1c0: 7861 6d70 6c65 732f 6d75 6c74 695f 6563  xamples/multi_ec
+0000b1d0: 686f 2e70 7920 7b6e 616d 657d 207b 6765  ho.py {name} {ge
+0000b1e0: 6e65 7269 635f 636c 6f75 647d 272c 0a20  neric_cloud}',. 
+0000b1f0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000b200: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+0000b210: 5d20 2b0a 2020 2020 2020 2020 2320 456e  ] +.        # En
+0000b220: 7375 7265 206a 6f62 7320 7375 6363 6565  sure jobs succee
+0000b230: 6465 642e 0a20 2020 2020 2020 205b 6627  ded..        [f'
+0000b240: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000b250: 7b69 202b 2031 7d20 2d2d 7374 6174 7573  {i + 1} --status
+0000b260: 2720 666f 7220 6920 696e 2072 616e 6765  ' for i in range
+0000b270: 2833 3229 5d20 2b0a 2020 2020 2020 2020  (32)] +.        
+0000b280: 2320 456e 7375 7265 206d 6f6e 6974 6f72  # Ensure monitor
+0000b290: 2f61 7574 6f73 6361 6c65 7220 6469 646e  /autoscaler didn
+0000b2a0: 2774 2063 7261 7368 206f 6e20 7468 6520  't crash on the 
+0000b2b0: 2761 7373 6572 7420 6e6f 740a 2020 2020  'assert not.    
+0000b2c0: 2020 2020 2320 756e 6675 6c66 696c 6c65      # unfulfille
+0000b2d0: 6427 2065 7272 6f72 2e20 2049 6620 7072  d' error.  If pr
+0000b2e0: 6f63 6573 7320 6e6f 7420 666f 756e 642c  ocess not found,
+0000b2f0: 2067 7265 702d 3e73 7368 2072 6574 7572   grep->ssh retur
+0000b300: 6e73 2031 2e0a 2020 2020 2020 2020 5b66  ns 1..        [f
+0000b310: 2773 7368 207b 6e61 6d65 7d20 5c27 7073  'ssh {name} \'ps
+0000b320: 2061 7578 207c 2067 7265 7020 225b 2f5d   aux | grep "[/]
+0000b330: 226d 6f6e 6974 6f72 2e70 795c 2727 5d2c  "monitor.py\''],
+0000b340: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+0000b350: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+0000b360: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0000b370: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+0000b380: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000b390: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000b3a0: 2d2d 2d2d 2054 6173 6b3a 2031 206e 6f64  ---- Task: 1 nod
+0000b3b0: 6520 7472 6169 6e69 6e67 2e20 2d2d 2d2d  e training. ----
+0000b3c0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0000b3d0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0000b3e0: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0000b3f0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000b400: 6520 5631 3030 2067 7075 730a 4070 7974  e V100 gpus.@pyt
+0000b410: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+0000b420: 2023 2049 424d 2063 6c6f 7564 2063 7572   # IBM cloud cur
+0000b430: 7265 6e74 6c79 2064 6f65 736e 2774 2070  rently doesn't p
+0000b440: 726f 7669 6465 2070 7562 6c69 6320 696d  rovide public im
+0000b450: 6167 6520 7769 7468 2043 5544 410a 4070  age with CUDA.@p
+0000b460: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0000b470: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0000b480: 7420 6861 7665 2056 3130 3020 2831 3647  t have V100 (16G
+0000b490: 4229 2047 5055 732e 2052 756e 2074 6573  B) GPUs. Run tes
+0000b4a0: 745f 7363 705f 6875 6767 696e 6766 6163  t_scp_huggingfac
+0000b4b0: 6520 696e 7374 6561 642e 0a64 6566 2074  e instead..def t
+0000b4c0: 6573 745f 6875 6767 696e 6766 6163 6528  est_huggingface(
+0000b4d0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+0000b4e0: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+0000b4f0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000b500: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0000b510: 6573 7428 0a20 2020 2020 2020 2027 6875  est(.        'hu
+0000b520: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
+0000b530: 6d64 625f 6170 7027 2c0a 2020 2020 2020  mdb_app',.      
+0000b540: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0000b550: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+0000b560: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+0000b570: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+0000b580: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+0000b590: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+0000b5a0: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+0000b5b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000b5c0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0000b5d0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000b5e0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000b5f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000b600: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000b610: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+0000b620: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+0000b630: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+0000b640: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000b650: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0000b660: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000b670: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000b680: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+0000b690: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000b6a0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0000b6b0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0000b6c0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+0000b6d0: 7465 7374 2e6d 6172 6b2e 6c61 6d62 6461  test.mark.lambda
+0000b6e0: 5f63 6c6f 7564 0a64 6566 2074 6573 745f  _cloud.def test_
+0000b6f0: 6c61 6d62 6461 5f68 7567 6769 6e67 6661  lambda_huggingfa
+0000b700: 6365 2867 656e 6572 6963 5f63 6c6f 7564  ce(generic_cloud
+0000b710: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+0000b720: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000b730: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0000b740: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000b750: 276c 616d 6264 615f 6875 6767 696e 6766  'lambda_huggingf
+0000b760: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
+0000b770: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+0000b780: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000b790: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+0000b7a0: 6d65 7d20 7b4c 414d 4244 415f 5459 5045  me} {LAMBDA_TYPE
+0000b7b0: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+0000b7c0: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+0000b7d0: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+0000b7e0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000b7f0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0000b800: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000b810: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000b820: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+0000b830: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000b840: 7d20 7b4c 414d 4244 415f 5459 5045 7d20  } {LAMBDA_TYPE} 
+0000b850: 6578 616d 706c 6573 2f68 7567 6769 6e67  examples/hugging
+0000b860: 6661 6365 5f67 6c75 655f 696d 6462 5f61  face_glue_imdb_a
+0000b870: 7070 2e79 616d 6c27 2c0a 2020 2020 2020  pp.yaml',.      
+0000b880: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000b890: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+0000b8a0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+0000b8b0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+0000b8c0: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
+0000b8d0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000b8e0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000b8f0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+0000b900: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+0000b910: 7374 2e6d 6172 6b2e 7363 700a 6465 6620  st.mark.scp.def 
+0000b920: 7465 7374 5f73 6370 5f68 7567 6769 6e67  test_scp_hugging
+0000b930: 6661 6365 2867 656e 6572 6963 5f63 6c6f  face(generic_clo
+0000b940: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+0000b950: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+0000b960: 725f 6e61 6d65 2829 0a20 2020 206e 756d  r_name().    num
+0000b970: 5f6f 665f 6770 755f 6c61 756e 6368 203d  _of_gpu_launch =
+0000b980: 2031 0a20 2020 2074 6573 7420 3d20 5465   1.    test = Te
+0000b990: 7374 280a 2020 2020 2020 2020 2753 4350  st(.        'SCP
+0000b9a0: 5f68 7567 6769 6e67 6661 6365 5f67 6c75  _huggingface_glu
+0000b9b0: 655f 696d 6462 5f61 7070 272c 0a20 2020  e_imdb_app',.   
+0000b9c0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0000b9d0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000b9e0: 2d79 202d 6320 7b6e 616d 657d 207b 5343  -y -c {name} {SC
+0000b9f0: 505f 5459 5045 7d20 7b53 4350 5f47 5055  P_TYPE} {SCP_GPU
+0000ba00: 5f56 3130 307d 3a7b 6e75 6d5f 6f66 5f67  _V100}:{num_of_g
+0000ba10: 7075 5f6c 6175 6e63 687d 2065 7861 6d70  pu_launch} examp
+0000ba20: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
+0000ba30: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
+0000ba40: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000ba50: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+0000ba60: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+0000ba70: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+0000ba80: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000ba90: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000baa0: 7865 6320 7b6e 616d 657d 207b 5343 505f  xec {name} {SCP_
+0000bab0: 5459 5045 7d20 7b53 4350 5f47 5055 5f56  TYPE} {SCP_GPU_V
+0000bac0: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
+0000bad0: 5f6c 6175 6e63 687d 2065 7861 6d70 6c65  _launch} example
+0000bae0: 732f 6875 6767 696e 6766 6163 655f 676c  s/huggingface_gl
+0000baf0: 7565 5f69 6d64 625f 6170 702e 7961 6d6c  ue_imdb_app.yaml
+0000bb00: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000bb10: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000bb20: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
+0000bb30: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+0000bb40: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000bb50: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0000bb60: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000bb70: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+0000bb80: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000bb90: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+0000bba0: 2054 5055 2e20 2d2d 2d2d 2d2d 2d2d 2d2d   TPU. ----------
+0000bbb0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+0000bbc0: 700a 6465 6620 7465 7374 5f74 7075 2829  p.def test_tpu()
+0000bbd0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000bbe0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000bbf0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000bc00: 280a 2020 2020 2020 2020 2774 7075 5f61  (.        'tpu_a
+0000bc10: 7070 272c 0a20 2020 2020 2020 205b 0a20  pp',.        [. 
+0000bc20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000bc30: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+0000bc40: 616d 657d 2065 7861 6d70 6c65 732f 7470  ame} examples/tp
+0000bc50: 752f 7470 755f 6170 702e 7961 6d6c 272c  u/tpu_app.yaml',
+0000bc60: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000bc70: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0000bc80: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000bc90: 206a 6f62 2066 696e 6973 6865 642e 0a20   job finished.. 
+0000bca0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000bcb0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0000bcc0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+0000bcd0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+0000bce0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+0000bcf0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000bd00: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
+0000bd10: 6d70 6c65 732f 7470 752f 7470 755f 6170  mples/tpu/tpu_ap
+0000bd20: 702e 7961 6d6c 207c 2067 7265 7020 2254  p.yaml | grep "T
+0000bd30: 5055 202e 2a20 616c 7265 6164 7920 6578  PU .* already ex
+0000bd40: 6973 7473 2227 2c20 2023 2045 6e73 7572  ists"',  # Ensur
+0000bd50: 6520 736b 7920 6c61 756e 6368 2077 6f6e  e sky launch won
+0000bd60: 2774 2063 7265 6174 6520 616e 6f74 6865  't create anothe
+0000bd70: 7220 5450 552e 0a20 2020 2020 2020 205d  r TPU..        ]
+0000bd80: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000bd90: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000bda0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+0000bdb0: 3d33 3020 2a20 3630 2c20 2023 2063 616e  =30 * 60,  # can
+0000bdc0: 2074 616b 6520 3e32 3020 6d69 6e73 0a20   take >20 mins. 
+0000bdd0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000bde0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0000bdf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 5055 2056  ---------- TPU V
+0000be00: 4d2e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  M. ----------.@p
+0000be10: 7974 6573 742e 6d61 726b 2e67 6370 0a64  ytest.mark.gcp.d
+0000be20: 6566 2074 6573 745f 7470 755f 766d 2829  ef test_tpu_vm()
+0000be30: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000be40: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000be50: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000be60: 280a 2020 2020 2020 2020 2774 7075 5f76  (.        'tpu_v
+0000be70: 6d5f 6170 7027 2c0a 2020 2020 2020 2020  m_app',.        
+0000be80: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0000be90: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+0000bea0: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+0000beb0: 2f74 7075 2f74 7075 766d 5f6d 6e69 7374  /tpu/tpuvm_mnist
+0000bec0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000bed0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000bee0: 6e61 6d65 7d20 3127 2c20 2023 2045 6e73  name} 1',  # Ens
+0000bef0: 7572 6520 7468 6520 6a6f 6220 6669 6e69  ure the job fini
+0000bf00: 7368 6564 2e0a 2020 2020 2020 2020 2020  shed..          
+0000bf10: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000bf20: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0000bf30: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000bf40: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000bf50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000bf60: 7374 6f70 202d 7920 7b6e 616d 657d 272c  stop -y {name}',
+0000bf70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000bf80: 3d24 2873 6b79 2073 7461 7475 7320 7b6e  =$(sky status {n
+0000bf90: 616d 657d 202d 2d72 6566 7265 7368 293b  ame} --refresh);
+0000bfa0: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000bfb0: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000bfc0: 2220 207c 2067 7265 7020 7b6e 616d 657d  "  | grep {name}
+0000bfd0: 207c 2067 7265 7020 5354 4f50 5045 4427   | grep STOPPED'
+0000bfe0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000bff0: 636c 7573 7465 7220 6973 2053 544f 5050  cluster is STOPP
+0000c000: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
+0000c010: 2320 5573 6520 7265 7472 793a 2067 7561  # Use retry: gua
+0000c020: 7264 2061 6761 696e 7374 2074 7261 6e73  rd against trans
+0000c030: 6965 6e74 2065 7272 6f72 7320 6f62 7365  ient errors obse
+0000c040: 7276 6564 2066 6f72 0a20 2020 2020 2020  rved for.       
+0000c050: 2020 2020 2023 206a 7573 742d 7374 6f70       # just-stop
+0000c060: 7065 6420 5450 5520 564d 7320 2823 3936  ped TPU VMs (#96
+0000c070: 3229 2e0a 2020 2020 2020 2020 2020 2020  2)..            
+0000c080: 6627 736b 7920 7374 6172 7420 2d2d 7265  f'sky start --re
+0000c090: 7472 792d 756e 7469 6c2d 7570 202d 7920  try-until-up -y 
+0000c0a0: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0000c0b0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000c0c0: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+0000c0d0: 7470 752f 7470 7576 6d5f 6d6e 6973 742e  tpu/tpuvm_mnist.
+0000c0e0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+0000c0f0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000c100: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0000c110: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000c120: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000c130: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000c140: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
+0000c150: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0000c160: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000c170: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000c180: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
+0000c190: 2036 302c 2020 2320 6361 6e20 7461 6b65   60,  # can take
+0000c1a0: 2033 3020 6d69 6e73 0a20 2020 2029 0a20   30 mins.    ). 
+0000c1b0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000c1c0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+0000c1d0: 2d2d 2d2d 2054 5055 2056 4d20 506f 642e  ---- TPU VM Pod.
+0000c1e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0000c1f0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+0000c200: 2074 6573 745f 7470 755f 766d 5f70 6f64   test_tpu_vm_pod
+0000c210: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+0000c220: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000c230: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+0000c240: 7374 280a 2020 2020 2020 2020 2774 7075  st(.        'tpu
+0000c250: 5f70 6f64 272c 0a20 2020 2020 2020 205b  _pod',.        [
+0000c260: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c270: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+0000c280: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
+0000c290: 7470 752f 7470 7576 6d5f 6d6e 6973 742e  tpu/tpuvm_mnist.
+0000c2a0: 7961 6d6c 202d 2d67 7075 7320 7470 752d  yaml --gpus tpu-
+0000c2b0: 7632 2d33 3220 2d2d 7573 652d 7370 6f74  v2-32 --use-spot
+0000c2c0: 202d 2d7a 6f6e 6520 6575 726f 7065 2d77   --zone europe-w
+0000c2d0: 6573 7434 2d61 272c 0a20 2020 2020 2020  est4-a',.       
+0000c2e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000c2f0: 7b6e 616d 657d 2031 272c 2020 2320 456e  {name} 1',  # En
+0000c300: 7375 7265 2074 6865 206a 6f62 2066 696e  sure the job fin
+0000c310: 6973 6865 642e 0a20 2020 2020 2020 2020  ished..         
+0000c320: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000c330: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+0000c340: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000c350: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000c360: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+0000c370: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+0000c380: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+0000c390: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+0000c3a0: 2c20 2023 2063 616e 2074 616b 6520 3330  ,  # can take 30
+0000c3b0: 206d 696e 730a 2020 2020 290a 2020 2020   mins.    ).    
+0000c3c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+0000c3d0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+0000c3e0: 2d20 5369 6d70 6c65 2061 7070 732e 202d  - Simple apps. -
+0000c3f0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+0000c400: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000c410: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+0000c420: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
+0000c430: 3e20 3120 7965 740a 6465 6620 7465 7374  > 1 yet.def test
+0000c440: 5f6d 756c 7469 5f68 6f73 746e 616d 6528  _multi_hostname(
+0000c450: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+0000c460: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+0000c470: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000c480: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0000c490: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+0000c4a0: 6c74 695f 686f 7374 6e61 6d65 272c 0a20  lti_hostname',. 
+0000c4b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000c4c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000c4d0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000c4e0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0000c4f0: 636c 6f75 647d 2065 7861 6d70 6c65 732f  cloud} examples/
+0000c500: 6d75 6c74 695f 686f 7374 6e61 6d65 2e79  multi_hostname.y
+0000c510: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000c520: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000c530: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+0000c540: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000c550: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000c560: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000c570: 6c6f 6773 207b 6e61 6d65 7d20 3120 7c20  logs {name} 1 | 
+0000c580: 6772 6570 2022 4d79 2068 6f73 746e 616d  grep "My hostnam
+0000c590: 653a 2220 7c20 7763 202d 6c20 7c20 6772  e:" | wc -l | gr
+0000c5a0: 6570 2032 272c 2020 2320 456e 7375 7265  ep 2',  # Ensure
+0000c5b0: 2074 6865 7265 2061 7265 2032 2068 6f73   there are 2 hos
+0000c5c0: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
+0000c5d0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000c5e0: 7d20 6578 616d 706c 6573 2f6d 756c 7469  } examples/multi
+0000c5f0: 5f68 6f73 746e 616d 652e 7961 6d6c 272c  _hostname.yaml',
+0000c600: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c610: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0000c620: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000c630: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000c640: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000c650: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0000c660: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000c670: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+0000c680: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0000c690: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+0000c6a0: 6173 6b3a 206e 3d32 206e 6f64 6573 2077  ask: n=2 nodes w
+0000c6b0: 6974 6820 7365 7475 7073 2e20 2d2d 2d2d  ith setups. ----
+0000c6c0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0000c6d0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0000c6e0: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0000c6f0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000c700: 6520 5631 3030 2067 7075 730a 4070 7974  e V100 gpus.@pyt
+0000c710: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+0000c720: 2023 2049 424d 2063 6c6f 7564 2063 7572   # IBM cloud cur
+0000c730: 7265 6e74 6c79 2064 6f65 736e 2774 2070  rently doesn't p
+0000c740: 726f 7669 6465 2070 7562 6c69 6320 696d  rovide public im
+0000c750: 6167 6520 7769 7468 2043 5544 410a 4070  age with CUDA.@p
+0000c760: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0000c770: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0000c780: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+0000c790: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
+0000c7a0: 7465 7374 5f64 6973 7472 6962 7574 6564  test_distributed
+0000c7b0: 5f74 6628 6765 6e65 7269 635f 636c 6f75  _tf(generic_clou
+0000c7c0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+0000c7d0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000c7e0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0000c7f0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0000c800: 2027 7265 736e 6574 5f64 6973 7472 6962   'resnet_distrib
+0000c810: 7574 6564 5f74 665f 6170 7027 2c0a 2020  uted_tf_app',.  
+0000c820: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000c830: 2020 2020 2320 4e4f 5445 3a20 7275 6e6e      # NOTE: runn
+0000c840: 696e 6720 6974 2074 7769 6365 2077 696c  ing it twice wil
+0000c850: 6c20 6861 6e67 2028 736f 6d65 7469 6d65  l hang (sometime
+0000c860: 733f 2920 2d20 616e 2061 7070 2d6c 6576  s?) - an app-lev
+0000c870: 656c 2062 7567 2e0a 2020 2020 2020 2020  el bug..        
+0000c880: 2020 2020 6627 7079 7468 6f6e 2065 7861      f'python exa
+0000c890: 6d70 6c65 732f 7265 736e 6574 5f64 6973  mples/resnet_dis
+0000c8a0: 7472 6962 7574 6564 5f74 665f 6170 702e  tributed_tf_app.
+0000c8b0: 7079 207b 6e61 6d65 7d20 7b67 656e 6572  py {name} {gener
+0000c8c0: 6963 5f63 6c6f 7564 7d27 2c0a 2020 2020  ic_cloud}',.    
+0000c8d0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000c8e0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+0000c8f0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+0000c900: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+0000c910: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+0000c920: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000c930: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0000c940: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0000c950: 202a 2036 302c 2020 2320 3235 206d 696e   * 60,  # 25 min
+0000c960: 7320 2869 7420 7461 6b65 7320 6172 6f75  s (it takes arou
+0000c970: 6e64 207e 3139 206d 696e 7329 0a20 2020  nd ~19 mins).   
+0000c980: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000c990: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0000c9a0: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+0000c9b0: 2047 4350 2073 7461 7274 2061 6e64 2073   GCP start and s
+0000c9c0: 746f 7020 696e 7374 616e 6365 7320 2d2d  top instances --
+0000c9d0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+0000c9e0: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
+0000c9f0: 7374 5f67 6370 5f73 7461 7274 5f73 746f  st_gcp_start_sto
+0000ca00: 7028 293a 0a20 2020 206e 616d 6520 3d20  p():.    name = 
+0000ca10: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000ca20: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0000ca30: 6573 7428 0a20 2020 2020 2020 2027 6763  est(.        'gc
+0000ca40: 702d 7374 6172 742d 7374 6f70 272c 0a20  p-start-stop',. 
+0000ca50: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000ca60: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000ca70: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
+0000ca80: 7861 6d70 6c65 732f 6763 705f 7374 6172  xamples/gcp_star
+0000ca90: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
+0000caa0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000cab0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+0000cac0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+0000cad0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+0000cae0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+0000caf0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000cb00: 6d65 7d20 6578 616d 706c 6573 2f67 6370  me} examples/gcp
+0000cb10: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+0000cb20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000cb30: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000cb40: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
+0000cb50: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+0000cb60: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000cb70: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000cb80: 6320 7b6e 616d 657d 2022 7072 6c69 6d69  c {name} "prlimi
+0000cb90: 7420 2d6e 202d 2d70 6964 3d5c 2428 7067  t -n --pid=\$(pg
+0000cba0: 7265 7020 2d66 205c 2772 6179 6c65 742f  rep -f \'raylet/
+0000cbb0: 7261 796c 6574 202d 2d72 6179 6c65 745f  raylet --raylet_
+0000cbc0: 736f 636b 6574 5f6e 616d 655c 2729 207c  socket_name\') |
+0000cbd0: 2067 7265 7020 5c27 225c 2731 3034 3835   grep \'"\'10485
+0000cbe0: 3736 2031 3034 3835 3736 5c27 225c 2722  76 1048576\'"\'"
+0000cbf0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+0000cc00: 2072 6179 6c65 7420 7072 6f63 6573 7320   raylet process 
+0000cc10: 6861 7320 7468 6520 636f 7272 6563 7420  has the correct 
+0000cc20: 6669 6c65 2064 6573 6372 6970 746f 7220  file descriptor 
+0000cc30: 6c69 6d69 742e 0a20 2020 2020 2020 2020  limit..         
+0000cc40: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000cc50: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+0000cc60: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000cc70: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000cc80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000cc90: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
+0000cca0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000ccb0: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
+0000ccc0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+0000ccd0: 7274 202d 7920 7b6e 616d 657d 202d 6920  rt -y {name} -i 
+0000cce0: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
+0000ccf0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000cd00: 7d20 6578 616d 706c 6573 2f67 6370 5f73  } examples/gcp_s
+0000cd10: 7461 7274 5f73 746f 702e 7961 6d6c 272c  tart_stop.yaml',
+0000cd20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000cd30: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
+0000cd40: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000cd50: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000cd60: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000cd70: 2020 2020 2027 736c 6565 7020 3138 3027       'sleep 180'
+0000cd80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000cd90: 736b 7920 7374 6174 7573 202d 7220 7b6e  sky status -r {n
+0000cda0: 616d 657d 207c 2067 7265 7020 2249 4e49  ame} | grep "INI
+0000cdb0: 545c 7c53 544f 5050 4544 2227 2c0a 2020  T\|STOPPED"',.  
+0000cdc0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000cdd0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000cde0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000cdf0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000ce00: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+0000ce10: 2d2d 2d20 5465 7374 696e 6720 417a 7572  --- Testing Azur
+0000ce20: 6520 7374 6172 7420 616e 6420 7374 6f70  e start and stop
+0000ce30: 2069 6e73 7461 6e63 6573 202d 2d2d 2d2d   instances -----
+0000ce40: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+0000ce50: 726b 2e61 7a75 7265 0a64 6566 2074 6573  rk.azure.def tes
+0000ce60: 745f 617a 7572 655f 7374 6172 745f 7374  t_azure_start_st
+0000ce70: 6f70 2829 3a0a 2020 2020 6e61 6d65 203d  op():.    name =
+0000ce80: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000ce90: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0000cea0: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+0000ceb0: 7a75 7265 2d73 7461 7274 2d73 746f 7027  zure-start-stop'
+0000cec0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0000ced0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000cee0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000cef0: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
+0000cf00: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
+0000cf10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000cf20: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000cf30: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
+0000cf40: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
+0000cf50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000cf60: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000cf70: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+0000cf80: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+0000cf90: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+0000cfa0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000cfb0: 207b 6e61 6d65 7d20 2270 726c 696d 6974   {name} "prlimit
+0000cfc0: 202d 6e20 2d2d 7069 643d 5c24 2870 6772   -n --pid=\$(pgr
+0000cfd0: 6570 202d 6620 5c27 7261 796c 6574 2f72  ep -f \'raylet/r
+0000cfe0: 6179 6c65 7420 2d2d 7261 796c 6574 5f73  aylet --raylet_s
+0000cff0: 6f63 6b65 745f 6e61 6d65 5c27 2920 7c20  ocket_name\') | 
+0000d000: 6772 6570 205c 2722 5c27 3130 3438 3537  grep \'"\'104857
+0000d010: 3620 3130 3438 3537 365c 2722 5c27 2227  6 1048576\'"\'"'
+0000d020: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000d030: 7261 796c 6574 2070 726f 6365 7373 2068  raylet process h
+0000d040: 6173 2074 6865 2063 6f72 7265 6374 2066  as the correct f
+0000d050: 696c 6520 6465 7363 7269 7074 6f72 206c  ile descriptor l
+0000d060: 696d 6974 2e0a 2020 2020 2020 2020 2020  imit..          
+0000d070: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+0000d080: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+0000d090: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+0000d0a0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+0000d0b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000d0c0: 7374 6f70 202d 7920 7b6e 616d 657d 272c  stop -y {name}',
+0000d0d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d0e0: 6b79 2073 7461 7274 202d 7920 7b6e 616d  ky start -y {nam
+0000d0f0: 657d 202d 6920 3127 2c0a 2020 2020 2020  e} -i 1',.      
+0000d100: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000d110: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+0000d120: 2f61 7a75 7265 5f73 7461 7274 5f73 746f  /azure_start_sto
+0000d130: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
+0000d140: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000d150: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+0000d160: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+0000d170: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+0000d180: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0000d190: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
+0000d1a0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000d1b0: 7374 6174 7573 202d 7220 7b6e 616d 657d  status -r {name}
+0000d1c0: 2920 2626 2065 6368 6f20 2473 2026 2620  ) && echo $s && 
+0000d1d0: 6563 686f 2024 7320 7c20 6772 6570 2022  echo $s | grep "
+0000d1e0: 494e 4954 5c7c 5354 4f50 5045 4422 270a  INIT\|STOPPED"'.
+0000d1f0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000d200: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000d210: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+0000d220: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+0000d230: 302c 2020 2320 3330 206d 696e 730a 2020  0,  # 30 mins.  
+0000d240: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0000d250: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0000d260: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+0000d270: 6720 4175 746f 7374 6f70 7069 6e67 202d  g Autostopping -
+0000d280: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+0000d290: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+0000d2a0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+0000d2b0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0000d2c0: 7375 7070 6f72 7420 7374 6f70 7069 6e67  support stopping
+0000d2d0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+0000d2e0: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+0000d2f0: 2320 4649 5828 4942 4d29 2073 706f 7261  # FIX(IBM) spora
+0000d300: 6469 6361 6c6c 7920 6661 696c 732c 2061  dically fails, a
+0000d310: 7320 7265 7374 6172 7465 6420 776f 726b  s restarted work
+0000d320: 6572 7320 7374 6179 2075 6e69 6e69 7469  ers stay uniniti
+0000d330: 616c 697a 6564 2069 6e64 6566 696e 6974  alized indefinit
+0000d340: 656c 790a 4070 7974 6573 742e 6d61 726b  ely.@pytest.mark
+0000d350: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+0000d360: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0000d370: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+0000d380: 740a 6465 6620 7465 7374 5f61 7574 6f73  t.def test_autos
+0000d390: 746f 7028 6765 6e65 7269 635f 636c 6f75  top(generic_clou
+0000d3a0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+0000d3b0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000d3c0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0000d3d0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0000d3e0: 2027 6175 746f 7374 6f70 272c 0a20 2020   'autostop',.   
+0000d3f0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0000d400: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000d410: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
+0000d420: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2d2d  --num-nodes 2 --
+0000d430: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0000d440: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
+0000d450: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+0000d460: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000d470: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
+0000d480: 202d 7920 7b6e 616d 657d 202d 6920 3127   -y {name} -i 1'
+0000d490: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
+0000d4a0: 2045 6e73 7572 6520 6175 746f 7374 6f70   Ensure autostop
+0000d4b0: 2069 7320 7365 742e 0a20 2020 2020 2020   is set..       
+0000d4c0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+0000d4d0: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
+0000d4e0: 7c20 6772 6570 2022 316d 2227 2c0a 0a20  | grep "1m"',.. 
+0000d4f0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+0000d500: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+0000d510: 6973 206e 6f74 2073 746f 7070 6564 2065  is not stopped e
+0000d520: 6172 6c79 2e0a 2020 2020 2020 2020 2020  arly..          
+0000d530: 2020 2773 6c65 6570 2034 3527 2c0a 2020    'sleep 45',.  
+0000d540: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000d550: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+0000d560: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+0000d570: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000d580: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+0000d590: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000d5a0: 6772 6570 2055 5027 2c0a 0a20 2020 2020  grep UP',..     
+0000d5b0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+0000d5c0: 7468 6520 636c 7573 7465 7220 6973 2053  the cluster is S
+0000d5d0: 544f 5050 4544 2e0a 2020 2020 2020 2020  TOPPED..        
+0000d5e0: 2020 2020 2773 6c65 6570 2032 3530 272c      'sleep 250',
+0000d5f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d600: 3d24 2873 6b79 2073 7461 7475 7320 7b6e  =$(sky status {n
+0000d610: 616d 657d 202d 2d72 6566 7265 7368 293b  ame} --refresh);
+0000d620: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000d630: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000d640: 2220 207c 2067 7265 7020 7b6e 616d 657d  "  | grep {name}
+0000d650: 207c 2067 7265 7020 5354 4f50 5045 4427   | grep STOPPED'
+0000d660: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
+0000d670: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+0000d680: 7465 7220 6973 2055 5020 616e 6420 7468  ter is UP and th
+0000d690: 6520 6175 746f 7374 6f70 2073 6574 7469  e autostop setti
+0000d6a0: 6e67 2069 7320 7265 7365 7420 2827 2d27  ng is reset ('-'
+0000d6b0: 292e 0a20 2020 2020 2020 2020 2020 2066  )..            f
+0000d6c0: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
+0000d6d0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+0000d6e0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+0000d6f0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000d700: 6772 6570 202d 4520 2255 505c 732b 2d22  grep -E "UP\s+-"
+0000d710: 272c 0a0a 2020 2020 2020 2020 2020 2020  ',..            
+0000d720: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000d730: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000d740: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000d750: 6563 207b 6e61 6d65 7d20 7465 7374 732f  ec {name} tests/
+0000d760: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
+0000d770: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+0000d780: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+0000d790: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+0000d7a0: 7573 272c 0a0a 2020 2020 2020 2020 2020  us',..          
+0000d7b0: 2020 2320 5465 7374 2072 6573 7461 7274    # Test restart
+0000d7c0: 696e 6720 7468 6520 6964 6c65 6e65 7373  ing the idleness
+0000d7d0: 2074 696d 6572 2076 6961 2063 616e 6365   timer via cance
+0000d7e0: 6c20 2b20 7265 7365 743a 0a20 2020 2020  l + reset:.     
+0000d7f0: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+0000d800: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
+0000d810: 2d69 2031 272c 2020 2320 4964 6c65 6e65  -i 1',  # Idlene
+0000d820: 7373 2073 7461 7274 7320 636f 756e 7469  ss starts counti
+0000d830: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+0000d840: 2773 6c65 6570 2034 3527 2c20 2023 2041  'sleep 45',  # A
+0000d850: 6c6d 6f73 7420 7265 6163 6865 6420 7468  lmost reached th
+0000d860: 6520 7468 7265 7368 6f6c 642e 0a20 2020  e threshold..   
+0000d870: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
+0000d880: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
+0000d890: 7d20 2d2d 6361 6e63 656c 272c 0a20 2020  } --cancel',.   
+0000d8a0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
+0000d8b0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
+0000d8c0: 7d20 2d69 2031 272c 2020 2320 5368 6f75  } -i 1',  # Shou
+0000d8d0: 6c64 2072 6573 7461 7274 2074 6865 2074  ld restart the t
+0000d8e0: 696d 6572 2e0a 2020 2020 2020 2020 2020  imer..          
+0000d8f0: 2020 2773 6c65 6570 2034 3527 2c0a 2020    'sleep 45',.  
+0000d900: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000d910: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+0000d920: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+0000d930: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000d940: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
+0000d950: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+0000d960: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
+0000d970: 2020 2020 2027 736c 6565 7020 3235 3027       'sleep 250'
+0000d980: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000d990: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
+0000d9a0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+0000d9b0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+0000d9c0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+0000d9d0: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
+0000d9e0: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
+0000d9f0: 272c 0a0a 2020 2020 2020 2020 2020 2020  ',..            
+0000da00: 2320 5465 7374 2072 6573 7461 7274 696e  # Test restartin
+0000da10: 6720 7468 6520 6964 6c65 6e65 7373 2074  g the idleness t
+0000da20: 696d 6572 2076 6961 2065 7865 633a 0a20  imer via exec:. 
+0000da30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000da40: 2073 7461 7274 202d 7920 7b6e 616d 657d   start -y {name}
+0000da50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000da60: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+0000da70: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0000da80: 202d 4520 2255 505c 732b 2d22 272c 0a20   -E "UP\s+-"',. 
+0000da90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000daa0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+0000dab0: 6d65 7d20 2d69 2031 272c 2020 2320 4964  me} -i 1',  # Id
+0000dac0: 6c65 6e65 7373 2073 7461 7274 7320 636f  leness starts co
+0000dad0: 756e 7469 6e67 2e0a 2020 2020 2020 2020  unting..        
+0000dae0: 2020 2020 2773 6c65 6570 2034 3527 2c20      'sleep 45', 
+0000daf0: 2023 2041 6c6d 6f73 7420 7265 6163 6865   # Almost reache
+0000db00: 6420 7468 6520 7468 7265 7368 6f6c 642e  d the threshold.
+0000db10: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000db20: 6b79 2065 7865 6320 7b6e 616d 657d 2065  ky exec {name} e
+0000db30: 6368 6f20 6869 272c 2020 2320 5368 6f75  cho hi',  # Shou
+0000db40: 6c64 2072 6573 7461 7274 2074 6865 2074  ld restart the t
+0000db50: 696d 6572 2e0a 2020 2020 2020 2020 2020  imer..          
+0000db60: 2020 2773 6c65 6570 2034 3527 2c0a 2020    'sleep 45',.  
+0000db70: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+0000db80: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+0000db90: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+0000dba0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+0000dbb0: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+0000dbc0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000dbd0: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
+0000dbe0: 2020 2020 2020 2773 6c65 6570 2032 3530        'sleep 250
+0000dbf0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000dc00: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
+0000dc10: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
+0000dc20: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+0000dc30: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+0000dc40: 2473 2220 207c 2067 7265 7020 7b6e 616d  $s"  | grep {nam
+0000dc50: 657d 207c 2067 7265 7020 5354 4f50 5045  e} | grep STOPPE
+0000dc60: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
+0000dc70: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000dc80: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+0000dc90: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+0000dca0: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0000dcb0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0000dcc0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+0000dcd0: 2d2d 2054 6573 7469 6e67 2041 7574 6f64  -- Testing Autod
+0000dce0: 6f77 6e69 6e67 202d 2d2d 2d2d 2d2d 2d2d  owning ---------
+0000dcf0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
+0000dd00: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+0000dd10: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
+0000dd20: 6d5f 6e6f 6465 7320 3e20 3120 7965 742e  m_nodes > 1 yet.
+0000dd30: 2052 756e 2074 6573 745f 7363 705f 6175   Run test_scp_au
+0000dd40: 746f 646f 776e 2069 6e73 7465 6164 2e0a  todown instead..
+0000dd50: 6465 6620 7465 7374 5f61 7574 6f64 6f77  def test_autodow
+0000dd60: 6e28 6765 6e65 7269 635f 636c 6f75 643a  n(generic_cloud:
+0000dd70: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+0000dd80: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0000dd90: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0000dda0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0000ddb0: 6175 746f 646f 776e 272c 0a20 2020 2020  autodown',.     
+0000ddc0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000ddd0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000dde0: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
+0000ddf0: 6e75 6d2d 6e6f 6465 7320 3220 2d2d 636c  num-nodes 2 --cl
+0000de00: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+0000de10: 7564 7d20 7465 7374 732f 7465 7374 5f79  ud} tests/test_y
+0000de20: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+0000de30: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000de40: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
+0000de50: 7920 7b6e 616d 657d 202d 2d64 6f77 6e20  y {name} --down 
+0000de60: 2d69 2031 272c 0a20 2020 2020 2020 2020  -i 1',.         
+0000de70: 2020 2023 2045 6e73 7572 6520 6175 746f     # Ensure auto
+0000de80: 7374 6f70 2069 7320 7365 742e 0a20 2020  stop is set..   
+0000de90: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+0000dea0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
+0000deb0: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
+0000dec0: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
+0000ded0: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
+0000dee0: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
+0000def0: 2074 6572 6d69 6e61 7465 6420 6561 726c   terminated earl
+0000df00: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
+0000df10: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
+0000df20: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000df30: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+0000df40: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+0000df50: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000df60: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+0000df70: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000df80: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
+0000df90: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
+0000dfa0: 636c 7573 7465 7220 6973 2074 6572 6d69  cluster is termi
+0000dfb0: 6e61 7465 642e 0a20 2020 2020 2020 2020  nated..         
+0000dfc0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
+0000dfd0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000dfe0: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
+0000dff0: 3d30 2073 6b79 2073 7461 7475 7320 7b6e  =0 sky status {n
+0000e000: 616d 657d 202d 2d72 6566 7265 7368 2920  ame} --refresh) 
+0000e010: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
+0000e020: 7b7b 2065 6368 6f20 2224 7322 207c 2067  {{ echo "$s" | g
+0000e030: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000e040: 7020 2241 7574 6f64 6f77 6e65 6420 636c  p "Autodowned cl
+0000e050: 7573 7465 725c 7c74 6572 6d69 6e61 7465  uster\|terminate
+0000e060: 6420 6f6e 2074 6865 2063 6c6f 7564 223b  d on the cloud";
+0000e070: 207d 7d20 7c7c 207b 7b20 6563 686f 2022   }} || {{ echo "
+0000e080: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
+0000e090: 7d20 2626 2065 7869 7420 3120 7c7c 2065  } && exit 1 || e
+0000e0a0: 7869 7420 303b 207d 7d27 2c0a 2020 2020  xit 0; }}',.    
+0000e0b0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000e0c0: 756e 6368 202d 7920 2d64 202d 6320 7b6e  unch -y -d -c {n
+0000e0d0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+0000e0e0: 6e65 7269 635f 636c 6f75 647d 202d 2d6e  neric_cloud} --n
+0000e0f0: 756d 2d6e 6f64 6573 2032 202d 2d64 6f77  um-nodes 2 --dow
+0000e100: 6e20 7465 7374 732f 7465 7374 5f79 616d  n tests/test_yam
+0000e110: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
+0000e120: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000e130: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+0000e140: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+0000e150: 5550 272c 2020 2320 456e 7375 7265 2074  UP',  # Ensure t
+0000e160: 6865 2063 6c75 7374 6572 2069 7320 5550  he cluster is UP
+0000e170: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000e180: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000e190: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+0000e1a0: 5f63 6c6f 7564 7d20 7465 7374 732f 7465  _cloud} tests/te
+0000e1b0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
+0000e1c0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000e1d0: 2020 2020 6627 736b 7920 7374 6174 7573      f'sky status
+0000e1e0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000e1f0: 2067 7265 7020 2231 6d20 2864 6f77 6e29   grep "1m (down)
+0000e200: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000e210: 2773 6c65 6570 2032 3430 272c 0a20 2020  'sleep 240',.   
+0000e220: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+0000e230: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+0000e240: 2074 6572 6d69 6e61 7465 642e 0a20 2020   terminated..   
+0000e250: 2020 2020 2020 2020 2066 2773 3d24 2853           f's=$(S
+0000e260: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+0000e270: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+0000e280: 7d20 2d2d 7265 6672 6573 6829 2026 2620  } --refresh) && 
+0000e290: 6563 686f 2022 2473 2220 2626 207b 7b20  echo "$s" && {{ 
+0000e2a0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000e2b0: 207b 6e61 6d65 7d20 7c20 6772 6570 2022   {name} | grep "
+0000e2c0: 4175 746f 646f 776e 6564 2063 6c75 7374  Autodowned clust
+0000e2d0: 6572 5c7c 7465 726d 696e 6174 6564 206f  er\|terminated o
+0000e2e0: 6e20 7468 6520 636c 6f75 6422 3b20 7d7d  n the cloud"; }}
+0000e2f0: 207c 7c20 7b7b 2065 6368 6f20 2224 7322   || {{ echo "$s"
+0000e300: 207c 2067 7265 7020 7b6e 616d 657d 2026   | grep {name} &
+0000e310: 2620 6578 6974 2031 207c 7c20 6578 6974  & exit 1 || exit
+0000e320: 2030 3b20 7d7d 272c 0a20 2020 2020 2020   0; }}',.       
+0000e330: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000e340: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
+0000e350: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0000e360: 6963 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d  ic_cloud} --num-
+0000e370: 6e6f 6465 7320 3220 2d2d 646f 776e 2074  nodes 2 --down t
+0000e380: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0000e390: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+0000e3a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000e3b0: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+0000e3c0: 6d65 7d20 2d2d 6361 6e63 656c 272c 0a20  me} --cancel',. 
+0000e3d0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0000e3e0: 7020 3234 3027 2c0a 2020 2020 2020 2020  p 240',.        
+0000e3f0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+0000e400: 2063 6c75 7374 6572 2069 7320 7374 696c   cluster is stil
+0000e410: 6c20 5550 2e0a 2020 2020 2020 2020 2020  l UP..          
+0000e420: 2020 6627 733d 2428 534b 5950 494c 4f54    f's=$(SKYPILOT
+0000e430: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+0000e440: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+0000e450: 7265 7368 2920 2626 2065 6368 6f20 2224  resh) && echo "$
+0000e460: 7322 2026 2620 6563 686f 2022 2473 2220  s" && echo "$s" 
+0000e470: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0000e480: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
+0000e490: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+0000e4a0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+0000e4b0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+0000e4c0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+0000e4d0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000e4e0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+0000e4f0: 6573 742e 6d61 726b 2e73 6370 0a64 6566  est.mark.scp.def
+0000e500: 2074 6573 745f 7363 705f 6175 746f 646f   test_scp_autodo
+0000e510: 776e 2829 3a0a 2020 2020 6e61 6d65 203d  wn():.    name =
+0000e520: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000e530: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+0000e540: 5465 7374 280a 2020 2020 2020 2020 2753  Test(.        'S
+0000e550: 4350 5f61 7574 6f64 6f77 6e27 2c0a 2020  CP_autodown',.  
+0000e560: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000e570: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000e580: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
+0000e590: 207b 5343 505f 5459 5045 7d20 7465 7374   {SCP_TYPE} test
+0000e5a0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+0000e5b0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+0000e5c0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
+0000e5d0: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
+0000e5e0: 202d 2d64 6f77 6e20 2d69 2031 272c 0a20   --down -i 1',. 
+0000e5f0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
+0000e600: 7572 6520 6175 746f 7374 6f70 2069 7320  ure autostop is 
+0000e610: 7365 742e 0a20 2020 2020 2020 2020 2020  set..           
+0000e620: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
+0000e630: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+0000e640: 6570 2022 316d 2028 646f 776e 2922 272c  ep "1m (down)"',
+0000e650: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+0000e660: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+0000e670: 7220 6973 206e 6f74 2074 6572 6d69 6e61  r is not termina
+0000e680: 7465 6420 6561 726c 792e 0a20 2020 2020  ted early..     
+0000e690: 2020 2020 2020 2027 736c 6565 7020 3435         'sleep 45
+0000e6a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000e6b0: 2773 6b79 2073 7461 7475 7320 2d2d 7265  'sky status --re
+0000e6c0: 6672 6573 6820 7c20 6772 6570 207b 6e61  fresh | grep {na
+0000e6d0: 6d65 7d20 7c20 6772 6570 2055 5027 2c0a  me} | grep UP',.
+0000e6e0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+0000e6f0: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+0000e700: 2069 7320 7465 726d 696e 6174 6564 2e0a   is terminated..
+0000e710: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000e720: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+0000e730: 2020 2020 2066 2773 3d24 2853 4b59 5049       f's=$(SKYPI
+0000e740: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+0000e750: 7374 6174 7573 202d 2d72 6566 7265 7368  status --refresh
+0000e760: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000e770: 2026 2620 7b7b 2065 6368 6f20 2224 7322   && {{ echo "$s"
+0000e780: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000e790: 2067 7265 7020 2241 7574 6f64 6f77 6e65   grep "Autodowne
+0000e7a0: 6420 636c 7573 7465 725c 7c74 6572 6d69  d cluster\|termi
+0000e7b0: 6e61 7465 6420 6f6e 2074 6865 2063 6c6f  nated on the clo
+0000e7c0: 7564 223b 207d 7d20 7c7c 207b 7b20 6563  ud"; }} || {{ ec
+0000e7d0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000e7e0: 6e61 6d65 7d20 2626 2065 7869 7420 3120  name} && exit 1 
+0000e7f0: 7c7c 2065 7869 7420 303b 207d 7d27 2c0a  || exit 0; }}',.
+0000e800: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000e810: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
+0000e820: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+0000e830: 5045 7d20 2d2d 646f 776e 2074 6573 7473  PE} --down tests
+0000e840: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+0000e850: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+0000e860: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+0000e870: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
+0000e880: 7d20 7c20 6772 6570 2055 5027 2c20 2023  } | grep UP',  #
+0000e890: 2045 6e73 7572 6520 7468 6520 636c 7573   Ensure the clus
+0000e8a0: 7465 7220 6973 2055 502e 0a20 2020 2020  ter is UP..     
+0000e8b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000e8c0: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+0000e8d0: 5045 7d20 7465 7374 732f 7465 7374 5f79  PE} tests/test_y
+0000e8e0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+0000e8f0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000e900: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+0000e910: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+0000e920: 7020 2231 6d20 2864 6f77 6e29 2227 2c0a  p "1m (down)"',.
+0000e930: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000e940: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+0000e950: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
+0000e960: 6520 636c 7573 7465 7220 6973 2074 6572  e cluster is ter
+0000e970: 6d69 6e61 7465 642e 0a20 2020 2020 2020  minated..       
+0000e980: 2020 2020 2066 2773 3d24 2853 4b59 5049       f's=$(SKYPI
+0000e990: 4c4f 545f 4445 4255 473d 3020 736b 7920  LOT_DEBUG=0 sky 
+0000e9a0: 7374 6174 7573 202d 2d72 6566 7265 7368  status --refresh
+0000e9b0: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
+0000e9c0: 2026 2620 7b7b 2065 6368 6f20 2224 7322   && {{ echo "$s"
+0000e9d0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+0000e9e0: 2067 7265 7020 2241 7574 6f64 6f77 6e65   grep "Autodowne
+0000e9f0: 6420 636c 7573 7465 725c 7c74 6572 6d69  d cluster\|termi
+0000ea00: 6e61 7465 6420 6f6e 2074 6865 2063 6c6f  nated on the clo
+0000ea10: 7564 223b 207d 7d20 7c7c 207b 7b20 6563  ud"; }} || {{ ec
+0000ea20: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000ea30: 6e61 6d65 7d20 2626 2065 7869 7420 3120  name} && exit 1 
+0000ea40: 7c7c 2065 7869 7420 303b 207d 7d27 2c0a  || exit 0; }}',.
+0000ea50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ea60: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
+0000ea70: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+0000ea80: 5045 7d20 2d2d 646f 776e 2074 6573 7473  PE} --down tests
+0000ea90: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+0000eaa0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+0000eab0: 2020 2020 2020 2066 2773 6b79 2061 7574         f'sky aut
+0000eac0: 6f73 746f 7020 2d79 207b 6e61 6d65 7d20  ostop -y {name} 
+0000ead0: 2d2d 6361 6e63 656c 272c 0a20 2020 2020  --cancel',.     
+0000eae0: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+0000eaf0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0000eb00: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
+0000eb10: 7374 6572 2069 7320 7374 696c 6c20 5550  ster is still UP
+0000eb20: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0000eb30: 733d 2428 534b 5950 494c 4f54 5f44 4542  s=$(SKYPILOT_DEB
+0000eb40: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+0000eb50: 2d2d 7265 6672 6573 6829 2026 2620 7072  --refresh) && pr
+0000eb60: 696e 7466 2022 2473 2220 2626 2065 6368  intf "$s" && ech
+0000eb70: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000eb80: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
+0000eb90: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0000eba0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+0000ebb0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000ebc0: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
+0000ebd0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+0000ebe0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000ebf0: 0a0a 0a64 6566 205f 6765 745f 6361 6e63  ...def _get_canc
+0000ec00: 656c 5f74 6173 6b5f 7769 7468 5f63 6c6f  el_task_with_clo
+0000ec10: 7564 286e 616d 652c 2063 6c6f 7564 2c20  ud(name, cloud, 
+0000ec20: 7469 6d65 6f75 743d 3135 202a 2036 3029  timeout=15 * 60)
+0000ec30: 3a0a 2020 2020 7465 7374 203d 2054 6573  :.    test = Tes
+0000ec40: 7428 0a20 2020 2020 2020 2066 277b 636c  t(.        f'{cl
+0000ec50: 6f75 647d 2d63 616e 6365 6c2d 7461 736b  oud}-cancel-task
+0000ec60: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0000ec70: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000ec80: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0000ec90: 6578 616d 706c 6573 2f72 6573 6e65 745f  examples/resnet_
+0000eca0: 6170 702e 7961 6d6c 202d 2d63 6c6f 7564  app.yaml --cloud
+0000ecb0: 207b 636c 6f75 647d 202d 7920 2d64 272c   {cloud} -y -d',
+0000ecc0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+0000ecd0: 6169 7420 7468 6520 4750 5520 7072 6f63  ait the GPU proc
+0000ece0: 6573 7320 746f 2073 7461 7274 2e0a 2020  ess to start..  
+0000ecf0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000ed00: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+0000ed10: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000ed20: 6d65 7d20 226e 7669 6469 612d 736d 6920  me} "nvidia-smi 
+0000ed30: 7c20 6772 6570 2070 7974 686f 6e22 272c  | grep python"',
+0000ed40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000ed50: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0000ed60: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+0000ed70: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+0000ed80: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+0000ed90: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000eda0: 6c20 2d79 207b 6e61 6d65 7d20 3127 2c0a  l -y {name} 1',.
+0000edb0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000edc0: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
+0000edd0: 2020 2020 2320 6368 6563 6b20 6966 2074      # check if t
+0000ede0: 6865 2070 7974 686f 6e20 6a6f 6220 6973  he python job is
+0000edf0: 2067 6f6e 652e 0a20 2020 2020 2020 2020   gone..         
+0000ee00: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000ee10: 616d 657d 2022 2120 6e76 6964 6961 2d73  ame} "! nvidia-s
+0000ee20: 6d69 207c 2067 7265 7020 7079 7468 6f6e  mi | grep python
+0000ee30: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000ee40: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000ee50: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
+0000ee60: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000ee70: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000ee80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000ee90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000eea0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000eeb0: 6d65 6f75 743d 7469 6d65 6f75 742c 0a20  meout=timeout,. 
+0000eec0: 2020 2029 0a20 2020 2072 6574 7572 6e20     ).    return 
+0000eed0: 7465 7374 0a0a 0a23 202d 2d2d 2d2d 2d2d  test...# -------
+0000eee0: 2d2d 2d20 5465 7374 696e 6720 6073 6b79  --- Testing `sky
+0000eef0: 2063 616e 6365 6c60 202d 2d2d 2d2d 2d2d   cancel` -------
+0000ef00: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+0000ef10: 2e61 7773 0a64 6566 2074 6573 745f 6361  .aws.def test_ca
+0000ef20: 6e63 656c 5f61 7773 2829 3a0a 2020 2020  ncel_aws():.    
+0000ef30: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000ef40: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000ef50: 6573 7420 3d20 5f67 6574 5f63 616e 6365  est = _get_cance
+0000ef60: 6c5f 7461 736b 5f77 6974 685f 636c 6f75  l_task_with_clou
+0000ef70: 6428 6e61 6d65 2c20 2761 7773 2729 0a20  d(name, 'aws'). 
+0000ef80: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000ef90: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0000efa0: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+0000efb0: 745f 6361 6e63 656c 5f67 6370 2829 3a0a  t_cancel_gcp():.
+0000efc0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0000efd0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0000efe0: 2020 2074 6573 7420 3d20 5f67 6574 5f63     test = _get_c
+0000eff0: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
+0000f000: 636c 6f75 6428 6e61 6d65 2c20 2767 6370  cloud(name, 'gcp
+0000f010: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
+0000f020: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+0000f030: 6573 742e 6d61 726b 2e61 7a75 7265 0a64  est.mark.azure.d
+0000f040: 6566 2074 6573 745f 6361 6e63 656c 5f61  ef test_cancel_a
+0000f050: 7a75 7265 2829 3a0a 2020 2020 6e61 6d65  zure():.    name
+0000f060: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000f070: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0000f080: 3d20 5f67 6574 5f63 616e 6365 6c5f 7461  = _get_cancel_ta
+0000f090: 736b 5f77 6974 685f 636c 6f75 6428 6e61  sk_with_cloud(na
+0000f0a0: 6d65 2c20 2761 7a75 7265 272c 2074 696d  me, 'azure', tim
+0000f0b0: 656f 7574 3d33 3020 2a20 3630 290a 2020  eout=30 * 60).  
+0000f0c0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000f0d0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000f0e0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0000f0f0: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0000f100: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+0000f110: 6520 5631 3030 2067 7075 730a 4070 7974  e V100 gpus.@pyt
+0000f120: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+0000f130: 2023 2049 424d 2063 6c6f 7564 2063 7572   # IBM cloud cur
+0000f140: 7265 6e74 6c79 2064 6f65 736e 2774 2070  rently doesn't p
+0000f150: 726f 7669 6465 2070 7562 6c69 6320 696d  rovide public im
+0000f160: 6167 6520 7769 7468 2043 5544 410a 4070  age with CUDA.@p
+0000f170: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0000f180: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0000f190: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+0000f1a0: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
+0000f1b0: 7465 7374 5f63 616e 6365 6c5f 7079 746f  test_cancel_pyto
+0000f1c0: 7263 6828 6765 6e65 7269 635f 636c 6f75  rch(generic_clou
+0000f1d0: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
+0000f1e0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+0000f1f0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+0000f200: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+0000f210: 2027 6361 6e63 656c 2d70 7974 6f72 6368   'cancel-pytorch
+0000f220: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0000f230: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000f240: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0000f250: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+0000f260: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
+0000f270: 2f72 6573 6e65 745f 6469 7374 7269 6275  /resnet_distribu
+0000f280: 7465 645f 746f 7263 682e 7961 6d6c 202d  ted_torch.yaml -
+0000f290: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+0000f2a0: 2020 2023 2057 6169 7420 7468 6520 4750     # Wait the GP
+0000f2b0: 5520 7072 6f63 6573 7320 746f 2073 7461  U process to sta
+0000f2c0: 7274 2e0a 2020 2020 2020 2020 2020 2020  rt..            
+0000f2d0: 2773 6c65 6570 2039 3027 2c0a 2020 2020  'sleep 90',.    
+0000f2e0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000f2f0: 6563 207b 6e61 6d65 7d20 226e 7669 6469  ec {name} "nvidi
+0000f300: 612d 736d 6920 7c20 6772 6570 2070 7974  a-smi | grep pyt
+0000f310: 686f 6e22 272c 0a20 2020 2020 2020 2020  hon"',.         
+0000f320: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000f330: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0000f340: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+0000f350: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000f360: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000f370: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+0000f380: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
+0000f390: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0000f3a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000f3b0: 6578 6563 207b 6e61 6d65 7d20 2228 6e76  exec {name} "(nv
+0000f3c0: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
+0000f3d0: 5c27 4e6f 2072 756e 6e69 6e67 2070 726f  \'No running pro
+0000f3e0: 6365 7373 5c27 2920 7c7c 2027 0a20 2020  cess\') || '.   
+0000f3f0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+0000f400: 6520 586f 7267 2069 7320 7468 6520 6f6e  e Xorg is the on
+0000f410: 6c79 2070 726f 6365 7373 2072 756e 6e69  ly process runni
+0000f420: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+0000f430: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
+0000f440: 207c 2067 7265 7020 2d41 2031 3020 5072   | grep -A 10 Pr
+0000f450: 6f63 6573 7365 7320 7c20 6772 6570 202d  ocesses | grep -
+0000f460: 4120 3130 203d 3d3d 207c 2067 7265 7020  A 10 === | grep 
+0000f470: 2d76 2058 6f72 6729 202d 6571 2032 205d  -v Xorg) -eq 2 ]
+0000f480: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000f490: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+0000f4a0: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
+0000f4b0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+0000f4c0: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000f4d0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000f4e0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000f4f0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000f500: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+0000f510: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000f520: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+0000f530: 6361 6e27 7420 7573 6520 605f 6765 745f  can't use `_get_
+0000f540: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
+0000f550: 5f63 6c6f 7564 2829 602c 2061 7320 636f  _cloud()`, as co
+0000f560: 6d6d 616e 6420 606e 7669 6469 612d 736d  mmand `nvidia-sm
+0000f570: 6960 0a23 2072 6571 7569 7265 7320 6120  i`.# requires a 
+0000f580: 4355 4441 2070 7562 6c69 6320 696d 6167  CUDA public imag
+0000f590: 652c 2077 6869 6368 2049 424d 2064 6f65  e, which IBM doe
+0000f5a0: 736e 2774 206f 6666 6572 0a40 7079 7465  sn't offer.@pyte
+0000f5b0: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
+0000f5c0: 7465 7374 5f63 616e 6365 6c5f 6962 6d28  test_cancel_ibm(
+0000f5d0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000f5e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000f5f0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0000f600: 7428 0a20 2020 2020 2020 2027 6962 6d2d  t(.        'ibm-
+0000f610: 6361 6e63 656c 2d74 6173 6b27 2c0a 2020  cancel-task',.  
+0000f620: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000f630: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000f640: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+0000f650: 636c 6f75 6420 6962 6d20 6578 616d 706c  cloud ibm exampl
+0000f660: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+0000f670: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f680: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000f690: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2020  -n {name}-1 -d  
+0000f6a0: 2277 6869 6c65 2074 7275 653b 2064 6f20  "while true; do 
+0000f6b0: 6563 686f 205c 2748 656c 6c6f 2053 6b79  echo \'Hello Sky
+0000f6c0: 5069 6c6f 745c 273b 2073 6c65 6570 2032  Pilot\'; sleep 2
+0000f6d0: 3b20 646f 6e65 2227 2c0a 2020 2020 2020  ; done"',.      
+0000f6e0: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
+0000f6f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f700: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+0000f710: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000f720: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+0000f730: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f740: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+0000f750: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+0000f760: 2020 2020 2066 2773 6c65 6570 2035 272c       f'sleep 5',
+0000f770: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000f780: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
+0000f790: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
+0000f7a0: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
+0000f7b0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0000f7c0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0000f7d0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000f7e0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+0000f7f0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+0000f800: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+0000f810: 2075 7365 2d73 706f 7420 6f70 7469 6f6e   use-spot option
+0000f820: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0000f830: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
+0000f840: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
+0000f850: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
+0000f860: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+0000f870: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0000f880: 2e6d 6172 6b2e 6e6f 5f69 626d 2020 2320  .mark.no_ibm  # 
+0000f890: 4942 4d20 436c 6f75 6420 646f 6573 206e  IBM Cloud does n
+0000f8a0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+0000f8b0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0000f8c0: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
+0000f8d0: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
+0000f8e0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0000f8f0: 6e63 6573 0a64 6566 2074 6573 745f 7573  nces.def test_us
+0000f900: 655f 7370 6f74 2867 656e 6572 6963 5f63  e_spot(generic_c
+0000f910: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000f920: 2222 2254 6573 7420 7573 652d 7370 6f74  """Test use-spot
+0000f930: 2061 6e64 2073 6b79 2065 7865 632e 2222   and sky exec.""
+0000f940: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+0000f950: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000f960: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000f970: 280a 2020 2020 2020 2020 2775 7365 2d73  (.        'use-s
+0000f980: 706f 7427 2c0a 2020 2020 2020 2020 5b0a  pot',.        [.
+0000f990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f9a0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0000f9b0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+0000f9c0: 7269 635f 636c 6f75 647d 2074 6573 7473  ric_cloud} tests
+0000f9d0: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+0000f9e0: 6d61 6c2e 7961 6d6c 202d 2d75 7365 2d73  mal.yaml --use-s
+0000f9f0: 706f 7420 2d79 272c 0a20 2020 2020 2020  pot -y',.       
+0000fa00: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000fa10: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0000fa20: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+0000fa30: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000fa40: 7d20 6563 686f 2068 6927 2c0a 2020 2020  } echo hi',.    
+0000fa50: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000fa60: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0000fa70: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+0000fa80: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000fa90: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000faa0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000fab0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000fac0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+0000fad0: 7469 6e67 206d 616e 6167 6564 2073 706f  ting managed spo
+0000fae0: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
+0000faf0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+0000fb00: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+0000fb10: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+0000fb20: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+0000fb30: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+0000fb40: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+0000fb50: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+0000fb60: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+0000fb70: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+0000fb80: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000fb90: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0000fba0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+0000fbb0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+0000fbc0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+0000fbd0: 6465 6620 7465 7374 5f73 706f 7428 6765  def test_spot(ge
+0000fbe0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+0000fbf0: 293a 0a20 2020 2022 2222 5465 7374 2074  ):.    """Test t
+0000fc00: 6865 2073 706f 7420 7961 6d6c 2e22 2222  he spot yaml."""
+0000fc10: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+0000fc20: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+0000fc30: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+0000fc40: 0a20 2020 2020 2020 2027 6d61 6e61 6765  .        'manage
+0000fc50: 642d 7370 6f74 272c 0a20 2020 2020 2020  d-spot',.       
+0000fc60: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+0000fc70: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+0000fc80: 202d 6e20 7b6e 616d 657d 2d31 202d 2d63   -n {name}-1 --c
+0000fc90: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+0000fca0: 6f75 647d 2065 7861 6d70 6c65 732f 6d61  oud} examples/ma
+0000fcb0: 6e61 6765 645f 7370 6f74 2e79 616d 6c20  naged_spot.yaml 
+0000fcc0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+0000fcd0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
+0000fce0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d2d  aunch -n {name}-
+0000fcf0: 3220 2d2d 636c 6f75 6420 7b67 656e 6572  2 --cloud {gener
+0000fd00: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
+0000fd10: 6573 2f6d 616e 6167 6564 5f73 706f 742e  es/managed_spot.
+0000fd20: 7961 6d6c 202d 7920 2d64 272c 0a20 2020  yaml -y -d',.   
+0000fd30: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0000fd40: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0000fd50: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+0000fd60: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0000fd70: 7d2d 3120 7c20 6865 6164 202d 6e31 207c  }-1 | head -n1 |
+0000fd80: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+0000fd90: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+0000fda0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+0000fdb0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0000fdc0: 6570 207b 6e61 6d65 7d2d 3220 7c20 6865  ep {name}-2 | he
+0000fdd0: 6164 202d 6e31 207c 2067 7265 7020 2253  ad -n1 | grep "S
+0000fde0: 5441 5254 494e 475c 7c52 554e 4e49 4e47  TARTING\|RUNNING
+0000fdf0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000fe00: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
+0000fe10: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
+0000fe20: 653d 6627 7b6e 616d 657d 2d31 2729 2c0a  e=f'{name}-1'),.
+0000fe30: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000fe40: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0000fe50: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+0000fe60: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0000fe70: 616d 657d 2d31 207c 2068 6561 6420 2d6e  ame}-1 | head -n
+0000fe80: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0000fe90: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0000fea0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0000feb0: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+0000fec0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+0000fed0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0000fee0: 6570 207b 6e61 6d65 7d2d 3120 7c20 6865  ep {name}-1 | he
+0000fef0: 6164 202d 6e31 207c 2067 7265 7020 4341  ad -n1 | grep CA
+0000ff00: 4e43 454c 4c45 4427 2c0a 2020 2020 2020  NCELLED',.      
+0000ff10: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+0000ff20: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0000ff30: 207b 6e61 6d65 7d2d 3220 7c20 6865 6164   {name}-2 | head
+0000ff40: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+0000ff50: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
+0000ff60: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0000ff70: 2020 2020 2020 2320 544f 444f 287a 6877        # TODO(zhw
+0000ff80: 7529 3a20 4368 616e 6765 2074 6f20 5f53  u): Change to _S
+0000ff90: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+0000ffa0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+0000ffb0: 6627 7b6e 616d 657d 2d31 202d 6e20 7b6e  f'{name}-1 -n {n
+0000ffc0: 616d 657d 2d32 2729 2077 6865 6e0a 2020  ame}-2') when.  
+0000ffd0: 2020 2020 2020 2320 6361 6e63 656c 696e        # cancelin
+0000ffe0: 6720 6d75 6c74 6970 6c65 206a 6f62 206e  g multiple job n
+0000fff0: 616d 6573 2069 7320 7375 7070 6f72 7465  ames is supporte
+00010000: 642e 0a20 2020 2020 2020 2028 5f53 504f  d..        (_SPO
+00010010: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00010020: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00010030: 7b6e 616d 657d 2d31 2729 202b 2027 3b20  {name}-1') + '; 
+00010040: 2720 2b0a 2020 2020 2020 2020 205f 5350  ' +.         _SP
+00010050: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00010060: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+00010070: 277b 6e61 6d65 7d2d 3227 2929 2c0a 2020  '{name}-2')),.  
+00010080: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00010090: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+000100a0: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+000100b0: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+000100c0: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+000100d0: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+000100e0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+000100f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00010100: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00010110: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00010120: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00010130: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00010140: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00010150: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00010160: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00010170: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00010180: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00010190: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+000101a0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+000101b0: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+000101c0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000101d0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+000101e0: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+000101f0: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
+00010200: 7065 6c69 6e65 2867 656e 6572 6963 5f63  peline(generic_c
+00010210: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00010220: 2222 2254 6573 7420 6120 7370 6f74 c2a0  """Test a spot..
+00010230: 7069 7065 6c69 6e65 2e22 2222 0a20 2020  pipeline.""".   
+00010240: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00010250: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00010260: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00010270: 2020 2020 2027 7370 6f74 2d70 6970 656c       'spot-pipel
+00010280: 696e 6527 2c0a 2020 2020 2020 2020 5b0a  ine',.        [.
+00010290: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000102a0: 7920 7370 6f74 206c 6175 6e63 6820 2d6e  y spot launch -n
+000102b0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
+000102c0: 7374 5f79 616d 6c73 2f70 6970 656c 696e  st_yamls/pipelin
+000102d0: 652e 7961 6d6c 202d 7920 2d64 272c 0a20  e.yaml -y -d',. 
+000102e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000102f0: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00010300: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00010310: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00010320: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00010330: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00010340: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+00010350: 2020 2020 2020 2020 2320 6067 7265 7020          # `grep 
+00010360: 2d41 2034 207b 6e61 6d65 7d60 2066 696e  -A 4 {name}` fin
+00010370: 6473 2074 6865 206a 6f62 2077 6974 6820  ds the job with 
+00010380: 7b6e 616d 657d 2061 6e64 2074 6865 2034  {name} and the 4
+00010390: 206c 696e 6573 0a20 2020 2020 2020 2020   lines.         
+000103a0: 2020 2023 2061 6674 6572 2069 742c 2069     # after it, i
+000103b0: 2e65 2e20 7468 6520 3420 7461 736b 7320  .e. the 4 tasks 
+000103c0: 7769 7468 696e 2074 6865 206a 6f62 2e0a  within the job..
+000103d0: 2020 2020 2020 2020 2020 2020 2320 6073              # `s
+000103e0: 6564 202d 6e20 3270 6020 6765 7473 2074  ed -n 2p` gets t
+000103f0: 6865 2073 6563 6f6e 6420 6c69 6e65 206f  he second line o
+00010400: 6620 7468 6520 3420 6c69 6e65 732c 2069  f the 4 lines, i
+00010410: 2e65 2e20 7468 6520 6669 7273 740a 2020  .e. the first.  
+00010420: 2020 2020 2020 2020 2020 2320 7461 736b            # task
+00010430: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
+00010440: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00010450: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00010460: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+00010470: 6d65 7d7c 2073 6564 202d 6e20 3270 207c  me}| sed -n 2p |
+00010480: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00010490: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+000104a0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+000104b0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+000104c0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+000104d0: 7365 6420 2d6e 2033 7020 7c20 6772 6570  sed -n 3p | grep
+000104e0: 2022 5045 4e44 494e 4722 272c 0a20 2020   "PENDING"',.   
+000104f0: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+00010500: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+00010510: 7428 6a6f 625f 6e61 6d65 3d66 277b 6e61  t(job_name=f'{na
+00010520: 6d65 7d27 292c 0a20 2020 2020 2020 2020  me}'),.         
+00010530: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+00010540: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00010550: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
+00010560: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00010570: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
+00010580: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+00010590: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+000105a0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+000105b0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+000105c0: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+000105d0: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
+000105e0: 7020 2243 414e 4345 4c4c 494e 475c 7c43  p "CANCELLING\|C
+000105f0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+00010600: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00010610: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+00010620: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00010630: 7365 6420 2d6e 2034 7020 7c20 6772 6570  sed -n 4p | grep
+00010640: 2022 4341 4e43 454c 4c49 4e47 5c7c 4341   "CANCELLING\|CA
+00010650: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+00010660: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00010670: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00010680: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00010690: 6564 202d 6e20 3570 207c 2067 7265 7020  ed -n 5p | grep 
+000106a0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
+000106b0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+000106c0: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
+000106d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000106e0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+000106f0: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
+00010700: 6e61 6d65 7d7c 2073 6564 202d 6e20 3270  name}| sed -n 2p
+00010710: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+00010720: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+00010730: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00010740: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
+00010750: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00010760: 2033 7020 7c20 6772 6570 2022 4341 4e43   3p | grep "CANC
+00010770: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00010780: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00010790: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+000107a0: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
+000107b0: 202d 6e20 3470 207c 2067 7265 7020 2243   -n 4p | grep "C
+000107c0: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
+000107d0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+000107e0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+000107f0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
+00010800: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
+00010810: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+00010820: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00010830: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
+00010840: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+00010850: 616d 653d 6627 7b6e 616d 657d 2729 2c0a  ame=f'{name}'),.
+00010860: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
+00010870: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
+00010880: 2073 6b79 2073 706f 7420 7175 6575 6520   sky spot queue 
+00010890: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
+000108a0: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
+000108b0: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
+000108c0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
+000108d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000108e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000108f0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+00010900: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
+00010910: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
+00010920: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00010930: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00010940: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+00010950: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
+00010960: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00010970: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00010980: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
+00010990: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
+000109a0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+000109b0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+000109c0: 6d61 726b 2e6d 616e 6167 6564 5f73 706f  mark.managed_spo
+000109d0: 740a 6465 6620 7465 7374 5f73 706f 745f  t.def test_spot_
+000109e0: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
+000109f0: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00010a00: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00010a10: 6e61 6765 6420 7370 6f74 206a 6f62 2077  naged spot job w
+00010a20: 6974 6820 6661 696c 6564 2073 6574 7570  ith failed setup
+00010a30: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+00010a40: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00010a50: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00010a60: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
+00010a70: 6f74 5f66 6169 6c65 645f 7365 7475 7027  ot_failed_setup'
+00010a80: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00010a90: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+00010aa0: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
+00010ab0: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
+00010ac0: 6572 6963 5f63 6c6f 7564 7d20 2d79 202d  eric_cloud} -y -
+00010ad0: 6420 7465 7374 732f 7465 7374 5f79 616d  d tests/test_yam
+00010ae0: 6c73 2f66 6169 6c65 645f 7365 7475 702e  ls/failed_setup.
+00010af0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00010b00: 2020 2027 736c 6565 7020 3333 3027 2c0a     'sleep 330',.
+00010b10: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+00010b20: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
+00010b30: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
+00010b40: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00010b50: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00010b60: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00010b70: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00010b80: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00010b90: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00010ba0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
+00010bb0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+00010bc0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+00010bd0: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+00010be0: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+00010bf0: 6b79 2073 706f 7420 7175 6575 6520 2d72  ky spot queue -r
+00010c00: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+00010c10: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+00010c20: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+00010c30: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+00010c40: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00010c50: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00010c60: 7465 7374 2e6d 6172 6b2e 6e6f 5f6c 616d  test.mark.no_lam
+00010c70: 6264 615f 636c 6f75 6420 2023 204c 616d  bda_cloud  # Lam
+00010c80: 6264 6120 436c 6f75 6420 646f 6573 206e  bda Cloud does n
+00010c90: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00010ca0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00010cb0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00010cc0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+00010cd0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00010ce0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00010cf0: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00010d00: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00010d10: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00010d20: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00010d30: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
+00010d40: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
+00010d50: 7065 6c69 6e65 5f66 6169 6c65 645f 7365  peline_failed_se
+00010d60: 7475 7028 6765 6e65 7269 635f 636c 6f75  tup(generic_clou
+00010d70: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00010d80: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00010d90: 7420 6a6f 6220 7769 7468 2066 6169 6c65  t job with faile
+00010da0: 6420 7365 7475 7020 666f 7220 6120 7069  d setup for a pi
+00010db0: 7065 6c69 6e65 2e22 2222 0a20 2020 206e  peline.""".    n
+00010dc0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00010dd0: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00010de0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00010df0: 2020 2027 7370 6f74 5f70 6970 656c 696e     'spot_pipelin
+00010e00: 655f 6661 696c 6564 5f73 6574 7570 272c  e_failed_setup',
+00010e10: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00010e20: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+00010e30: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+00010e40: 657d 202d 7920 2d64 2074 6573 7473 2f74  e} -y -d tests/t
+00010e50: 6573 745f 7961 6d6c 732f 6661 696c 6564  est_yamls/failed
+00010e60: 5f73 6574 7570 5f70 6970 656c 696e 652e  _setup_pipeline.
+00010e70: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00010e80: 2020 2027 736c 6565 7020 3830 3027 2c0a     'sleep 800',.
+00010e90: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+00010ea0: 6b65 2073 7572 6520 7468 6520 6a6f 6220  ke sure the job 
+00010eb0: 6661 696c 6564 2071 7569 636b 6c79 2e0a  failed quickly..
+00010ec0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00010ed0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00010ee0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00010ef0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00010f00: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00010f10: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00010f20: 5461 736b 2030 2073 686f 756c 6420 6265  Task 0 should be
+00010f30: 2053 5543 4345 4544 4544 2e0a 2020 2020   SUCCEEDED..    
+00010f40: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+00010f50: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
+00010f60: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00010f70: 2073 6564 202d 6e20 3270 207c 2067 7265   sed -n 2p | gre
+00010f80: 7020 2253 5543 4345 4544 4544 2227 2c0a  p "SUCCEEDED"',.
+00010f90: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
+00010fa0: 736b 2031 2073 686f 756c 6420 6265 2046  sk 1 should be F
+00010fb0: 4149 4c45 445f 5345 5455 502e 0a20 2020  AILED_SETUP..   
+00010fc0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00010fd0: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
+00010fe0: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
+00010ff0: 7c20 7365 6420 2d6e 2033 7020 7c20 6772  | sed -n 3p | gr
+00011000: 6570 2022 4641 494c 4544 5f53 4554 5550  ep "FAILED_SETUP
+00011010: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00011020: 2320 5461 736b 2032 2073 686f 756c 6420  # Task 2 should 
+00011030: 6265 2043 414e 4345 4c4c 4544 2e0a 2020  be CANCELLED..  
+00011040: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
+00011050: 4f54 5f51 5545 5545 5f57 4149 547d 207c  OT_QUEUE_WAIT} |
+00011060: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00011070: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
+00011080: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+00011090: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000110a0: 5461 736b 2033 2073 686f 756c 6420 6265  Task 3 should be
+000110b0: 2043 414e 4345 4c4c 4544 2e0a 2020 2020   CANCELLED..    
+000110c0: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
+000110d0: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
+000110e0: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+000110f0: 2073 6564 202d 6e20 3570 207c 2067 7265   sed -n 5p | gre
+00011100: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00011110: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00011120: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00011130: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00011140: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00011150: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
+00011160: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
+00011170: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
+00011180: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
+00011190: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
+000111a0: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
+000111b0: 7574 3d33 3020 2a20 3630 2c0a 2020 2020  ut=30 * 60,.    
+000111c0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000111d0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+000111e0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+000111f0: 6d61 6e61 6765 6420 7370 6f74 2072 6563  managed spot rec
+00011200: 6f76 6572 7920 2d2d 2d2d 2d2d 2d2d 2d2d  overy ----------
+00011210: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00011220: 6177 730a 4070 7974 6573 742e 6d61 726b  aws.@pytest.mark
+00011230: 2e6d 616e 6167 6564 5f73 706f 740a 6465  .managed_spot.de
+00011240: 6620 7465 7374 5f73 706f 745f 7265 636f  f test_spot_reco
+00011250: 7665 7279 5f61 7773 2861 7773 5f63 6f6e  very_aws(aws_con
+00011260: 6669 675f 7265 6769 6f6e 293a 0a20 2020  fig_region):.   
+00011270: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
+00011280: 2073 706f 7420 7265 636f 7665 7279 2e22   spot recovery."
+00011290: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+000112a0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+000112b0: 290a 2020 2020 7265 6769 6f6e 203d 2061  ).    region = a
+000112c0: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+000112d0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000112e0: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
+000112f0: 7265 636f 7665 7279 5f61 7773 272c 0a20  recovery_aws',. 
+00011300: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00011310: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+00011320: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
+00011330: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+00011340: 696f 6e7d 202d 6e20 7b6e 616d 657d 2022  ion} -n {name} "
+00011350: 6563 686f 2053 4b59 5049 4c4f 545f 5441  echo SKYPILOT_TA
+00011360: 534b 5f49 443a 205c 2453 4b59 5049 4c4f  SK_ID: \$SKYPILO
+00011370: 545f 5441 534b 5f49 443b 2073 6c65 6570  T_TASK_ID; sleep
+00011380: 2031 3830 3022 2020 2d79 202d 6427 2c0a   1800"  -y -d',.
+00011390: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+000113a0: 6570 2033 3630 272c 0a20 2020 2020 2020  ep 360',.       
+000113b0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+000113c0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+000113d0: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+000113e0: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+000113f0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00011400: 2066 2752 554e 5f49 443d 2428 736b 7920   f'RUN_ID=$(sky 
+00011410: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00011420: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00011430: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+00011440: 5441 534b 5f49 4420 7c20 6375 7420 2d64  TASK_ID | cut -d
+00011450: 3a20 2d66 3229 3b20 6563 686f 2022 2452  : -f2); echo "$R
+00011460: 554e 5f49 4422 207c 2074 6565 202f 746d  UN_ID" | tee /tm
+00011470: 702f 7b6e 616d 657d 2d72 756e 2d69 6427  p/{name}-run-id'
+00011480: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00011490: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
+000114a0: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
+000114b0: 2020 2020 2020 2020 2020 2020 2866 2761              (f'a
+000114c0: 7773 2065 6332 2074 6572 6d69 6e61 7465  ws ec2 terminate
+000114d0: 2d69 6e73 7461 6e63 6573 202d 2d72 6567  -instances --reg
+000114e0: 696f 6e20 7b72 6567 696f 6e7d 202d 2d69  ion {region} --i
+000114f0: 6e73 7461 6e63 652d 6964 7320 2428 270a  nstance-ids $('.
+00011500: 2020 2020 2020 2020 2020 2020 2066 2761               f'a
+00011510: 7773 2065 6332 2064 6573 6372 6962 652d  ws ec2 describe-
+00011520: 696e 7374 616e 6365 7320 2d2d 7265 6769  instances --regi
+00011530: 6f6e 207b 7265 6769 6f6e 7d20 270a 2020  on {region} '.  
+00011540: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+00011550: 696c 7465 7273 204e 616d 653d 7461 673a  ilters Name=tag:
+00011560: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+00011570: 2c56 616c 7565 733d 7b6e 616d 657d 2a20  ,Values={name}* 
+00011580: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+00011590: 272d 2d71 7565 7279 2052 6573 6572 7661  '--query Reserva
+000115a0: 7469 6f6e 735b 5d2e 496e 7374 616e 6365  tions[].Instance
+000115b0: 735b 5d2e 496e 7374 616e 6365 4964 2027  s[].InstanceId '
+000115c0: 0a20 2020 2020 2020 2020 2020 2020 272d  .             '-
+000115d0: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
+000115e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000115f0: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+00011600: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00011610: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00011620: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00011630: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00011640: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00011650: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+00011660: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00011670: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00011680: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00011690: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+000116a0: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+000116b0: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+000116c0: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+000116d0: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+000116e0: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+000116f0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00011700: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00011710: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+00011720: 5441 534b 5f49 4420 7c20 6772 6570 2022  TASK_ID | grep "
+00011730: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
+00011740: 2020 205d 2c0a 2020 2020 2020 2020 5f53     ],.        _S
+00011750: 504f 545f 4341 4e43 454c 5f57 4149 542e  POT_CANCEL_WAIT.
+00011760: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+00011770: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+00011780: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+00011790: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000117a0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000117b0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
+000117c0: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+000117d0: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
+000117e0: 7374 5f73 706f 745f 7265 636f 7665 7279  st_spot_recovery
+000117f0: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
+00011800: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
+00011810: 2072 6563 6f76 6572 792e 2222 220a 2020   recovery.""".  
+00011820: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00011830: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00011840: 207a 6f6e 6520 3d20 2775 732d 6561 7374   zone = 'us-east
+00011850: 342d 6227 0a20 2020 2071 7565 7279 5f63  4-b'.    query_c
+00011860: 6d64 203d 2028 6627 6763 6c6f 7564 2063  md = (f'gcloud c
+00011870: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+00011880: 206c 6973 7420 2d2d 6669 6c74 6572 3d27   list --filter='
+00011890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000118a0: 2020 6627 2228 6c61 6265 6c73 2e72 6179    f'"(labels.ray
+000118b0: 2d63 6c75 7374 6572 2d6e 616d 653a 7b6e  -cluster-name:{n
+000118c0: 616d 657d 2922 2027 0a20 2020 2020 2020  ame})" '.       
+000118d0: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
+000118e0: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+000118f0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+00011900: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
+00011910: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
+00011920: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00011930: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
+00011940: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
+00011950: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011960: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
+00011970: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
+00011980: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00011990: 2020 2020 2773 706f 745f 7265 636f 7665      'spot_recove
+000119a0: 7279 5f67 6370 272c 0a20 2020 2020 2020  ry_gcp',.       
+000119b0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+000119c0: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
+000119d0: 202d 2d63 6c6f 7564 2067 6370 202d 2d7a   --cloud gcp --z
+000119e0: 6f6e 6520 7b7a 6f6e 657d 202d 6e20 7b6e  one {zone} -n {n
+000119f0: 616d 657d 2022 6563 686f 2053 4b59 5049  ame} "echo SKYPI
+00011a00: 4c4f 545f 5441 534b 5f49 443a 205c 2453  LOT_TASK_ID: \$S
+00011a10: 4b59 5049 4c4f 545f 5441 534b 5f49 443b  KYPILOT_TASK_ID;
+00011a20: 2073 6c65 6570 2031 3830 3022 2020 2d79   sleep 1800"  -y
+00011a30: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+00011a40: 2020 2773 6c65 6570 2033 3630 272c 0a20    'sleep 360',. 
+00011a50: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00011a60: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00011a70: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+00011a80: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00011a90: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
+00011aa0: 2020 2020 2020 2066 2752 554e 5f49 443d         f'RUN_ID=
+00011ab0: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
+00011ac0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+00011ad0: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+00011ae0: 5049 4c4f 545f 5441 534b 5f49 4420 7c20  PILOT_TASK_ID | 
+00011af0: 6375 7420 2d64 3a20 2d66 3229 3b20 6563  cut -d: -f2); ec
+00011b00: 686f 2022 2452 554e 5f49 4422 207c 2074  ho "$RUN_ID" | t
+00011b10: 6565 202f 746d 702f 7b6e 616d 657d 2d72  ee /tmp/{name}-r
+00011b20: 756e 2d69 6427 2c0a 2020 2020 2020 2020  un-id',.        
+00011b30: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+00011b40: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+00011b50: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+00011b60: 2020 7465 726d 696e 6174 655f 636d 642c    terminate_cmd,
+00011b70: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00011b80: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+00011b90: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+00011ba0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00011bb0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+00011bc0: 6e31 207c 2067 7265 7020 2252 4543 4f56  n1 | grep "RECOV
+00011bd0: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00011be0: 2020 2020 2027 736c 6565 7020 3230 3027       'sleep 200'
+00011bf0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00011c00: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00011c10: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00011c20: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00011c30: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+00011c40: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+00011c50: 4944 3d24 2863 6174 202f 746d 702f 7b6e  ID=$(cat /tmp/{n
+00011c60: 616d 657d 2d72 756e 2d69 6429 3b20 6563  ame}-run-id); ec
+00011c70: 686f 2024 5255 4e5f 4944 3b20 736b 7920  ho $RUN_ID; sky 
+00011c80: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+00011c90: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+00011ca0: 7c20 6772 6570 2053 4b59 5049 4c4f 545f  | grep SKYPILOT_
+00011cb0: 5441 534b 5f49 443a 207c 2067 7265 7020  TASK_ID: | grep 
+00011cc0: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
+00011cd0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+00011ce0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00011cf0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00011d00: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00011d10: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+00011d20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00011d30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00011d40: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
+00011d50: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00011d60: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00011d70: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
+00011d80: 655f 7265 636f 7665 7279 5f61 7773 2861  e_recovery_aws(a
+00011d90: 7773 5f63 6f6e 6669 675f 7265 6769 6f6e  ws_config_region
+00011da0: 293a 0a20 2020 2022 2222 5465 7374 206d  ):.    """Test m
+00011db0: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
+00011dc0: 7665 7279 2066 6f72 2061 2070 6970 656c  very for a pipel
+00011dd0: 696e 652e 2222 220a 2020 2020 6e61 6d65  ine.""".    name
+00011de0: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00011df0: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
+00011e00: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
+00011e10: 6567 696f 6e0a 2020 2020 6966 2072 6567  egion.    if reg
+00011e20: 696f 6e20 213d 2027 7573 2d77 6573 742d  ion != 'us-west-
+00011e30: 3227 3a0a 2020 2020 2020 2020 7079 7465  2':.        pyte
+00011e40: 7374 2e73 6b69 7028 274f 6e6c 7920 7275  st.skip('Only ru
+00011e50: 6e20 7370 6f74 2070 6970 656c 696e 6520  n spot pipeline 
+00011e60: 7265 636f 7665 7279 2074 6573 7420 696e  recovery test in
+00011e70: 2075 732d 7765 7374 2d32 2729 0a20 2020   us-west-2').   
+00011e80: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00011e90: 2020 2020 2020 2773 706f 745f 7069 7065        'spot_pipe
+00011ea0: 6c69 6e65 5f72 6563 6f76 6572 795f 6177  line_recovery_aw
+00011eb0: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
+00011ec0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00011ed0: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+00011ee0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00011ef0: 5f79 616d 6c73 2f70 6970 656c 696e 655f  _yamls/pipeline_
+00011f00: 6177 732e 7961 6d6c 2020 2d79 202d 6427  aws.yaml  -y -d'
+00011f10: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00011f20: 6c65 6570 2034 3030 272c 0a20 2020 2020  leep 400',.     
+00011f30: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00011f40: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00011f50: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+00011f60: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
+00011f70: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
+00011f80: 2020 2066 2752 554e 5f49 443d 2428 736b     f'RUN_ID=$(sk
+00011f90: 7920 7370 6f74 206c 6f67 7320 2d6e 207b  y spot logs -n {
+00011fa0: 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f  name} --no-follo
+00011fb0: 7720 7c20 6772 6570 2053 4b59 5049 4c4f  w | grep SKYPILO
+00011fc0: 545f 5441 534b 5f49 443a 207c 2063 7574  T_TASK_ID: | cut
+00011fd0: 202d 643a 202d 6632 293b 2065 6368 6f20   -d: -f2); echo 
+00011fe0: 2224 5255 4e5f 4944 2220 7c20 7465 6520  "$RUN_ID" | tee 
+00011ff0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00012000: 6964 272c 0a20 2020 2020 2020 2020 2020  id',.           
+00012010: 2066 2752 554e 5f49 4453 3d24 2873 6b79   f'RUN_IDS=$(sky
+00012020: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+00012030: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+00012040: 207c 2067 7265 7020 2d41 2034 2053 4b59   | grep -A 4 SKY
+00012050: 5049 4c4f 545f 5441 534b 5f49 4453 207c  PILOT_TASK_IDS |
+00012060: 2063 7574 202d 6422 2922 202d 6632 293b   cut -d")" -f2);
+00012070: 2065 6368 6f20 2224 5255 4e5f 4944 5322   echo "$RUN_IDS"
+00012080: 207c 2074 6565 202f 746d 702f 7b6e 616d   | tee /tmp/{nam
+00012090: 657d 2d72 756e 2d69 6473 272c 0a20 2020  e}-run-ids',.   
+000120a0: 2020 2020 2020 2020 2023 2054 6572 6d69           # Termi
+000120b0: 6e61 7465 2074 6865 2063 6c75 7374 6572  nate the cluster
+000120c0: 206d 616e 7561 6c6c 792e 0a20 2020 2020   manually..     
+000120d0: 2020 2020 2020 2023 2054 6865 2060 6361         # The `ca
+000120e0: 7420 2e2e 2e7c 2072 6576 6020 6973 2074  t ...| rev` is t
+000120f0: 6f20 7265 7472 6965 7665 2074 6865 206a  o retrieve the j
+00012100: 6f62 5f69 6420 6672 6f6d 2074 6865 0a20  ob_id from the. 
+00012110: 2020 2020 2020 2020 2020 2023 2053 4b59             # SKY
+00012120: 5049 4c4f 545f 5441 534b 5f49 442c 2077  PILOT_TASK_ID, w
+00012130: 6869 6368 2067 6574 7320 7468 6520 7365  hich gets the se
+00012140: 636f 6e64 2074 6f20 6c61 7374 2066 6965  cond to last fie
+00012150: 6c64 0a20 2020 2020 2020 2020 2020 2023  ld.            #
+00012160: 2073 6570 6172 6174 6564 2062 7920 602d   separated by `-
+00012170: 602e 0a20 2020 2020 2020 2020 2020 2028  `..            (
+00012180: 6627 5350 4f54 5f4a 4f42 5f49 443d 6063  f'SPOT_JOB_ID=`c
+00012190: 6174 202f 746d 702f 7b6e 616d 657d 2d72  at /tmp/{name}-r
+000121a0: 756e 2d69 6420 7c20 7265 7620 7c20 270a  un-id | rev | '.
+000121b0: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
+000121c0: 7420 2d64 5c27 2d5c 2720 2d66 3220 7c20  t -d\'-\' -f2 | 
+000121d0: 7265 7660 3b27 0a20 2020 2020 2020 2020  rev`;'.         
+000121e0: 2020 2020 6627 6177 7320 6563 3220 7465      f'aws ec2 te
+000121f0: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
+00012200: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00012210: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
+00012220: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
+00012230: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
+00012240: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+00012250: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00012260: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
+00012270: 2020 272d 2d66 696c 7465 7273 204e 616d    '--filters Nam
+00012280: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00012290: 722d 6e61 6d65 2c56 616c 7565 733d 2a2d  r-name,Values=*-
+000122a0: 247b 5350 4f54 5f4a 4f42 5f49 447d 2027  ${SPOT_JOB_ID} '
+000122b0: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+000122c0: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
+000122d0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+000122e0: 5b5d 2e49 6e73 7461 6e63 6549 6420 270a  [].InstanceId '.
+000122f0: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+00012300: 6f75 7470 7574 2074 6578 7429 2729 2c0a  output text)'),.
+00012310: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00012320: 6570 2031 3030 272c 0a20 2020 2020 2020  ep 100',.       
+00012330: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00012340: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00012350: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00012360: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
+00012370: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
+00012380: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+00012390: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000123a0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+000123b0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+000123c0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+000123d0: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
+000123e0: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
+000123f0: 443d 2428 6361 7420 2f74 6d70 2f7b 6e61  D=$(cat /tmp/{na
+00012400: 6d65 7d2d 7275 6e2d 6964 293b 2065 6368  me}-run-id); ech
+00012410: 6f20 2452 554e 5f49 443b 2073 6b79 2073  o $RUN_ID; sky s
+00012420: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00012430: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00012440: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+00012450: 4153 4b5f 4944 3a20 7c20 6772 6570 2022  ASK_ID: | grep "
+00012460: 2452 554e 5f49 4422 272c 0a20 2020 2020  $RUN_ID"',.     
+00012470: 2020 2020 2020 2066 2752 554e 5f49 4453         f'RUN_IDS
+00012480: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
+00012490: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+000124a0: 666f 6c6c 6f77 207c 2067 7265 7020 2d41  follow | grep -A
+000124b0: 2034 2053 4b59 5049 4c4f 545f 5441 534b   4 SKYPILOT_TASK
+000124c0: 5f49 4453 207c 2063 7574 202d 6422 2922  _IDS | cut -d")"
+000124d0: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+000124e0: 4e5f 4944 5322 207c 2074 6565 202f 746d  N_IDS" | tee /tm
+000124f0: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+00012500: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+00012510: 2020 2066 2764 6966 6620 2f74 6d70 2f7b     f'diff /tmp/{
+00012520: 6e61 6d65 7d2d 7275 6e2d 6964 7320 2f74  name}-run-ids /t
+00012530: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00012540: 732d 6e65 7727 2c0a 2020 2020 2020 2020  s-new',.        
+00012550: 2020 2020 6627 6361 7420 2f74 6d70 2f7b      f'cat /tmp/{
+00012560: 6e61 6d65 7d2d 7275 6e2d 6964 7320 7c20  name}-run-ids | 
+00012570: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
+00012580: 2060 6361 7420 2f74 6d70 2f7b 6e61 6d65   `cat /tmp/{name
+00012590: 7d2d 7275 6e2d 6964 6027 2c0a 2020 2020  }-run-id`',.    
+000125a0: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+000125b0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+000125c0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+000125d0: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+000125e0: 7469 6d65 6f75 743d 3235 202a 2036 302c  timeout=25 * 60,
+000125f0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00012600: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00012610: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00012620: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00012630: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00012640: 6573 745f 7370 6f74 5f70 6970 656c 696e  est_spot_pipelin
+00012650: 655f 7265 636f 7665 7279 5f67 6370 2829  e_recovery_gcp()
+00012660: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00012670: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+00012680: 6572 7920 666f 7220 6120 7069 7065 6c69  ery for a pipeli
+00012690: 6e65 2e22 2222 0a20 2020 206e 616d 6520  ne.""".    name 
+000126a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+000126b0: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
+000126c0: 2027 7573 2d65 6173 7434 2d62 270a 2020   'us-east4-b'.  
+000126d0: 2020 7175 6572 795f 636d 6420 3d20 2827    query_cmd = ('
+000126e0: 6763 6c6f 7564 2063 6f6d 7075 7465 2069  gcloud compute i
+000126f0: 6e73 7461 6e63 6573 206c 6973 7420 2d2d  nstances list --
+00012700: 6669 6c74 6572 3d27 0a20 2020 2020 2020  filter='.       
+00012710: 2020 2020 2020 2020 2020 2722 286c 6162            '"(lab
+00012720: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+00012730: 6e61 6d65 3a2a 2d24 7b53 504f 545f 4a4f  name:*-${SPOT_JO
+00012740: 425f 4944 7d29 2220 270a 2020 2020 2020  B_ID})" '.      
+00012750: 2020 2020 2020 2020 2020 2066 272d 2d7a             f'--z
+00012760: 6f6e 6573 3d7b 7a6f 6e65 7d20 2d2d 666f  ones={zone} --fo
+00012770: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
+00012780: 2922 2729 0a20 2020 2074 6572 6d69 6e61  )"').    termina
+00012790: 7465 5f63 6d64 203d 2028 6627 6763 6c6f  te_cmd = (f'gclo
+000127a0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+000127b0: 6e63 6573 2064 656c 6574 6520 2d2d 7a6f  nces delete --zo
+000127c0: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
+000127d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127e0: 6627 202d 2d71 7569 6574 2024 287b 7175  f' --quiet $({qu
+000127f0: 6572 795f 636d 647d 2927 290a 2020 2020  ery_cmd})').    
+00012800: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00012810: 2020 2020 2027 7370 6f74 5f70 6970 656c       'spot_pipel
+00012820: 696e 655f 7265 636f 7665 7279 5f67 6370  ine_recovery_gcp
+00012830: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00012840: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00012850: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
+00012860: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
+00012870: 7961 6d6c 732f 7069 7065 6c69 6e65 5f67  yamls/pipeline_g
+00012880: 6370 2e79 616d 6c20 202d 7920 2d64 272c  cp.yaml  -y -d',
+00012890: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000128a0: 6565 7020 3430 3027 2c0a 2020 2020 2020  eep 400',.      
+000128b0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
+000128c0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+000128d0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+000128e0: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+000128f0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+00012900: 2020 6627 5255 4e5f 4944 3d24 2873 6b79    f'RUN_ID=$(sky
+00012910: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+00012920: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+00012930: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+00012940: 5f54 4153 4b5f 4944 3a20 7c20 6375 7420  _TASK_ID: | cut 
+00012950: 2d64 3a20 2d66 3229 3b20 6563 686f 2022  -d: -f2); echo "
+00012960: 2452 554e 5f49 4422 207c 2074 6565 202f  $RUN_ID" | tee /
+00012970: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+00012980: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00012990: 6627 5255 4e5f 4944 533d 2428 736b 7920  f'RUN_IDS=$(sky 
+000129a0: 7370 6f74 206c 6f67 7320 2d6e 207b 6e61  spot logs -n {na
+000129b0: 6d65 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720  me} --no-follow 
+000129c0: 7c20 6772 6570 202d 4120 3420 534b 5950  | grep -A 4 SKYP
+000129d0: 494c 4f54 5f54 4153 4b5f 4944 5320 7c20  ILOT_TASK_IDS | 
+000129e0: 6375 7420 2d64 2229 2220 2d66 3229 3b20  cut -d")" -f2); 
+000129f0: 6563 686f 2022 2452 554e 5f49 4453 2220  echo "$RUN_IDS" 
+00012a00: 7c20 7465 6520 2f74 6d70 2f7b 6e61 6d65  | tee /tmp/{name
+00012a10: 7d2d 7275 6e2d 6964 7327 2c0a 2020 2020  }-run-ids',.    
+00012a20: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
+00012a30: 6174 6520 7468 6520 636c 7573 7465 7220  ate the cluster 
+00012a40: 6d61 6e75 616c 6c79 2e0a 2020 2020 2020  manually..      
+00012a50: 2020 2020 2020 2320 5468 6520 6063 6174        # The `cat
+00012a60: 202e 2e2e 7c20 7265 7660 2069 7320 746f   ...| rev` is to
+00012a70: 2072 6574 7269 6576 6520 7468 6520 6a6f   retrieve the jo
+00012a80: 625f 6964 2066 726f 6d20 7468 650a 2020  b_id from the.  
+00012a90: 2020 2020 2020 2020 2020 2320 534b 5950            # SKYP
+00012aa0: 494c 4f54 5f54 4153 4b5f 4944 2c20 7768  ILOT_TASK_ID, wh
+00012ab0: 6963 6820 6765 7473 2074 6865 2073 6563  ich gets the sec
+00012ac0: 6f6e 6420 746f 206c 6173 7420 6669 656c  ond to last fiel
+00012ad0: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+00012ae0: 7365 7061 7261 7465 6420 6279 2060 2d60  separated by `-`
+00012af0: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
+00012b00: 2753 504f 545f 4a4f 425f 4944 3d60 6361  'SPOT_JOB_ID=`ca
+00012b10: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+00012b20: 6e2d 6964 207c 2072 6576 207c 2027 0a20  n-id | rev | '. 
+00012b30: 2020 2020 2020 2020 2020 2020 6627 6375              f'cu
+00012b40: 7420 2d64 5c27 2d5c 2720 2d66 3220 7c20  t -d\'-\' -f2 | 
+00012b50: 7265 7660 3b7b 7465 726d 696e 6174 655f  rev`;{terminate_
+00012b60: 636d 647d 2729 2c0a 2020 2020 2020 2020  cmd}'),.        
+00012b70: 2020 2020 2773 6c65 6570 2031 3030 272c      'sleep 100',
+00012b80: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00012b90: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00012ba0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00012bb0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00012bc0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00012bd0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00012be0: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+00012bf0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00012c00: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00012c10: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00012c20: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00012c30: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00012c40: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+00012c50: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00012c60: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+00012c70: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+00012c80: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00012c90: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00012ca0: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
+00012cb0: 7c20 6772 6570 2022 2452 554e 5f49 4422  | grep "$RUN_ID"
+00012cc0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00012cd0: 2752 554e 5f49 4453 3d24 2873 6b79 2073  'RUN_IDS=$(sky s
+00012ce0: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00012cf0: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00012d00: 2067 7265 7020 2d41 2034 2053 4b59 5049   grep -A 4 SKYPI
+00012d10: 4c4f 545f 5441 534b 5f49 4453 207c 2063  LOT_TASK_IDS | c
+00012d20: 7574 202d 6422 2922 202d 6632 293b 2065  ut -d")" -f2); e
+00012d30: 6368 6f20 2224 5255 4e5f 4944 5322 207c  cho "$RUN_IDS" |
+00012d40: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
+00012d50: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+00012d60: 2020 2020 2020 2020 2020 2066 2764 6966             f'dif
+00012d70: 6620 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  f /tmp/{name}-ru
+00012d80: 6e2d 6964 7320 2f74 6d70 2f7b 6e61 6d65  n-ids /tmp/{name
+00012d90: 7d2d 7275 6e2d 6964 732d 6e65 7727 2c0a  }-run-ids-new',.
+00012da0: 2020 2020 2020 2020 2020 2020 6627 6361              f'ca
+00012db0: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
+00012dc0: 6e2d 6964 7320 7c20 7365 6420 2d6e 2032  n-ids | sed -n 2
+00012dd0: 7020 7c20 6772 6570 2060 6361 7420 2f74  p | grep `cat /t
+00012de0: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
+00012df0: 6027 2c0a 2020 2020 2020 2020 5d2c 0a20  `',.        ],. 
+00012e00: 2020 2020 2020 205f 5350 4f54 5f43 414e         _SPOT_CAN
+00012e10: 4345 4c5f 5741 4954 2e66 6f72 6d61 7428  CEL_WAIT.format(
+00012e20: 6a6f 625f 6e61 6d65 3d6e 616d 6529 2c0a  job_name=name),.
+00012e30: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00012e40: 3235 202a 2036 302c 0a20 2020 2029 0a20  25 * 60,.    ). 
+00012e50: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00012e60: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00012e70: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00012e80: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00012e90: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+00012ea0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00012eb0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00012ec0: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+00012ed0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00012ee0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00012ef0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00012f00: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+00012f10: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00012f20: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00012f30: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00012f40: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00012f50: 6573 745f 7370 6f74 5f72 6563 6f76 6572  est_spot_recover
+00012f60: 795f 6465 6661 756c 745f 7265 736f 7572  y_default_resour
+00012f70: 6365 7328 6765 6e65 7269 635f 636c 6f75  ces(generic_clou
+00012f80: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00012f90: 5465 7374 206d 616e 6167 6564 2073 706f  Test managed spo
+00012fa0: 7420 7265 636f 7665 7279 2066 6f72 2064  t recovery for d
+00012fb0: 6566 6175 6c74 2072 6573 6f75 7263 6573  efault resources
+00012fc0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+00012fd0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00012fe0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00012ff0: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+00013000: 6e61 6765 642d 7370 6f74 2d72 6563 6f76  naged-spot-recov
+00013010: 6572 792d 6465 6661 756c 742d 7265 736f  ery-default-reso
+00013020: 7572 6365 7327 2c0a 2020 2020 2020 2020  urces',.        
+00013030: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00013040: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
+00013050: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
+00013060: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00013070: 7d20 2273 6c65 6570 2033 3020 2626 2073  } "sleep 30 && s
+00013080: 7564 6f20 7368 7574 646f 776e 206e 6f77  udo shutdown now
+00013090: 2026 2620 736c 6565 7020 3130 3030 2220   && sleep 1000" 
+000130a0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+000130b0: 2020 2020 2773 6c65 6570 2033 3630 272c      'sleep 360',
+000130c0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000130d0: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+000130e0: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+000130f0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013100: 2022 5255 4e4e 494e 475c 7c52 4543 4f56   "RUNNING\|RECOV
+00013110: 4552 494e 4722 272c 0a20 2020 2020 2020  ERING"',.       
+00013120: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
+00013130: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00013140: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
+00013150: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
+00013160: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
+00013170: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00013180: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00013190: 7465 7374 2e6d 6172 6b2e 6177 730a 4070  test.mark.aws.@p
+000131a0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+000131b0: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
+000131c0: 5f73 706f 745f 7265 636f 7665 7279 5f6d  _spot_recovery_m
+000131d0: 756c 7469 5f6e 6f64 655f 6177 7328 6177  ulti_node_aws(aw
+000131e0: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+000131f0: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00013200: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+00013210: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+00013220: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00013230: 6e61 6d65 2829 0a20 2020 2072 6567 696f  name().    regio
+00013240: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
+00013250: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
+00013260: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00013270: 7370 6f74 5f72 6563 6f76 6572 795f 6d75  spot_recovery_mu
+00013280: 6c74 695f 6e6f 6465 5f61 7773 272c 0a20  lti_node_aws',. 
+00013290: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000132a0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
+000132b0: 6c61 756e 6368 202d 2d63 6c6f 7564 2061  launch --cloud a
+000132c0: 7773 202d 2d72 6567 696f 6e20 7b72 6567  ws --region {reg
+000132d0: 696f 6e7d 202d 6e20 7b6e 616d 657d 202d  ion} -n {name} -
+000132e0: 2d6e 756d 2d6e 6f64 6573 2032 2022 6563  -num-nodes 2 "ec
+000132f0: 686f 2053 4b59 5049 4c4f 545f 5441 534b  ho SKYPILOT_TASK
+00013300: 5f49 443a 205c 2453 4b59 5049 4c4f 545f  _ID: \$SKYPILOT_
+00013310: 5441 534b 5f49 443b 2073 6c65 6570 2031  TASK_ID; sleep 1
+00013320: 3830 3022 2020 2d79 202d 6427 2c0a 2020  800"  -y -d',.  
+00013330: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00013340: 2034 3530 272c 0a20 2020 2020 2020 2020   450',.         
+00013350: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
+00013360: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+00013370: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+00013380: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+00013390: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000133a0: 2752 554e 5f49 443d 2428 736b 7920 7370  'RUN_ID=$(sky sp
+000133b0: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
+000133c0: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+000133d0: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+000133e0: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
+000133f0: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+00013400: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+00013410: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+00013420: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+00013430: 726d 696e 6174 6520 7468 6520 776f 726b  rminate the work
+00013440: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+00013450: 2020 2020 2020 2020 2028 6627 6177 7320           (f'aws 
+00013460: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
+00013470: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+00013480: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
+00013490: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
+000134a0: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
+000134b0: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
+000134c0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+000134d0: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+000134e0: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
+000134f0: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+00013500: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+00013510: 6c75 6573 3d7b 6e61 6d65 7d2a 2027 0a20  lues={name}* '. 
+00013520: 2020 2020 2020 2020 2020 2020 274e 616d              'Nam
+00013530: 653d 7461 673a 7261 792d 6e6f 6465 2d74  e=tag:ray-node-t
+00013540: 7970 652c 5661 6c75 6573 3d77 6f72 6b65  ype,Values=worke
+00013550: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
+00013560: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+00013570: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+00013580: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
+00013590: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000135a0: 272d 2d6f 7574 7075 7420 7465 7874 2927  '--output text)'
+000135b0: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
+000135c0: 736c 6565 7020 3530 272c 0a20 2020 2020  sleep 50',.     
+000135d0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+000135e0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+000135f0: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
+00013600: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
+00013610: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
+00013620: 2020 2020 2020 2773 6c65 6570 2035 3630        'sleep 560
+00013630: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00013640: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00013650: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00013660: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00013670: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
+00013680: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
+00013690: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
+000136a0: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
+000136b0: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
+000136c0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
+000136d0: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
+000136e0: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
+000136f0: 5f54 4153 4b5f 4944 207c 2063 7574 202d  _TASK_ID | cut -
+00013700: 643a 202d 6632 207c 2067 7265 7020 2224  d: -f2 | grep "$
+00013710: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
+00013720: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
+00013730: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00013740: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+00013750: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00013760: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
+00013770: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00013780: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00013790: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+000137a0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+000137b0: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
+000137c0: 745f 7370 6f74 5f72 6563 6f76 6572 795f  t_spot_recovery_
+000137d0: 6d75 6c74 695f 6e6f 6465 5f67 6370 2829  multi_node_gcp()
+000137e0: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+000137f0: 6e61 6765 6420 7370 6f74 2072 6563 6f76  naged spot recov
+00013800: 6572 792e 2222 220a 2020 2020 6e61 6d65  ery.""".    name
+00013810: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00013820: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+00013830: 3d20 2775 732d 7765 7374 322d 6127 0a20  = 'us-west2-a'. 
+00013840: 2020 2023 2055 7365 2027 3a27 2074 6f20     # Use ':' to 
+00013850: 6d61 7463 6820 6173 2074 6865 2063 6c75  match as the clu
+00013860: 7374 6572 206e 616d 6520 7769 6c6c 2063  ster name will c
+00013870: 6f6e 7461 696e 2074 6865 2073 7566 6669  ontain the suffi
+00013880: 7820 7769 7468 206a 6f62 2069 640a 2020  x with job id.  
+00013890: 2020 7175 6572 795f 636d 6420 3d20 280a    query_cmd = (.
+000138a0: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
+000138b0: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+000138c0: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+000138d0: 3d27 0a20 2020 2020 2020 2066 2722 286c  ='.        f'"(l
+000138e0: 6162 656c 732e 7261 792d 636c 7573 7465  abels.ray-cluste
+000138f0: 722d 6e61 6d65 3a7b 6e61 6d65 7d20 414e  r-name:{name} AN
+00013900: 4420 6c61 6265 6c73 2e72 6179 2d6e 6f64  D labels.ray-nod
+00013910: 652d 7479 7065 3d77 6f72 6b65 7229 2220  e-type=worker)" 
+00013920: 270a 2020 2020 2020 2020 6627 2d2d 7a6f  '.        f'--zo
+00013930: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+00013940: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+00013950: 2227 290a 2020 2020 7465 726d 696e 6174  "').    terminat
+00013960: 655f 636d 6420 3d20 2866 2767 636c 6f75  e_cmd = (f'gclou
+00013970: 6420 636f 6d70 7574 6520 696e 7374 616e  d compute instan
+00013980: 6365 7320 6465 6c65 7465 202d 2d7a 6f6e  ces delete --zon
+00013990: 653d 7b7a 6f6e 657d 270a 2020 2020 2020  e={zone}'.      
+000139a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000139b0: 2720 2d2d 7175 6965 7420 2428 7b71 7565  ' --quiet $({que
+000139c0: 7279 5f63 6d64 7d29 2729 0a20 2020 2074  ry_cmd})').    t
+000139d0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000139e0: 2020 2020 2773 706f 745f 7265 636f 7665      'spot_recove
+000139f0: 7279 5f6d 756c 7469 5f6e 6f64 655f 6763  ry_multi_node_gc
+00013a00: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+00013a10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00013a20: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
+00013a30: 6f75 6420 6763 7020 2d2d 7a6f 6e65 207b  oud gcp --zone {
+00013a40: 7a6f 6e65 7d20 2d6e 207b 6e61 6d65 7d20  zone} -n {name} 
+00013a50: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
+00013a60: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
+00013a70: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
+00013a80: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
+00013a90: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
+00013aa0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00013ab0: 7020 3430 3027 2c0a 2020 2020 2020 2020  p 400',.        
+00013ac0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+00013ad0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00013ae0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+00013af0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+00013b00: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00013b10: 6627 5255 4e5f 4944 3d24 2873 6b79 2073  f'RUN_ID=$(sky s
+00013b20: 706f 7420 6c6f 6773 202d 6e20 7b6e 616d  pot logs -n {nam
+00013b30: 657d 202d 2d6e 6f2d 666f 6c6c 6f77 207c  e} --no-follow |
+00013b40: 2067 7265 7020 534b 5950 494c 4f54 5f54   grep SKYPILOT_T
+00013b50: 4153 4b5f 4944 207c 2063 7574 202d 643a  ASK_ID | cut -d:
+00013b60: 202d 6632 293b 2065 6368 6f20 2224 5255   -f2); echo "$RU
+00013b70: 4e5f 4944 2220 7c20 7465 6520 2f74 6d70  N_ID" | tee /tmp
+00013b80: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 272c  /{name}-run-id',
+00013b90: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00013ba0: 6572 6d69 6e61 7465 2074 6865 2077 6f72  erminate the wor
+00013bb0: 6b65 7220 6d61 6e75 616c 6c79 2e0a 2020  ker manually..  
+00013bc0: 2020 2020 2020 2020 2020 7465 726d 696e            termin
+00013bd0: 6174 655f 636d 642c 0a20 2020 2020 2020  ate_cmd,.       
+00013be0: 2020 2020 2027 736c 6565 7020 3530 272c       'sleep 50',
+00013bf0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00013c00: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
+00013c10: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+00013c20: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00013c30: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00013c40: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00013c50: 6570 2034 3230 272c 0a20 2020 2020 2020  ep 420',.       
+00013c60: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00013c70: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00013c80: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00013c90: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00013ca0: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00013cb0: 2066 2752 554e 5f49 443d 2428 6361 7420   f'RUN_ID=$(cat 
+00013cc0: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+00013cd0: 6964 293b 2065 6368 6f20 2452 554e 5f49  id); echo $RUN_I
+00013ce0: 443b 2073 6b79 2073 706f 7420 6c6f 6773  D; sky spot logs
+00013cf0: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
+00013d00: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
+00013d10: 5950 494c 4f54 5f54 4153 4b5f 4944 207c  YPILOT_TASK_ID |
+00013d20: 2063 7574 202d 643a 202d 6632 207c 2067   cut -d: -f2 | g
+00013d30: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
+00013d40: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00013d50: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00013d60: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00013d70: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00013d80: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+00013d90: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00013da0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00013db0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00013dc0: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+00013dd0: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
+00013de0: 6566 2074 6573 745f 7370 6f74 5f63 616e  ef test_spot_can
+00013df0: 6365 6c6c 6174 696f 6e5f 6177 7328 6177  cellation_aws(aw
+00013e00: 735f 636f 6e66 6967 5f72 6567 696f 6e29  s_config_region)
+00013e10: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00013e20: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00013e30: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
+00013e40: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
+00013e50: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00013e60: 0a20 2020 2020 2020 2027 7370 6f74 5f63  .        'spot_c
+00013e70: 616e 6365 6c6c 6174 696f 6e5f 6177 7327  ancellation_aws'
+00013e80: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00013e90: 2020 2020 2020 2020 2320 5465 7374 2063          # Test c
+00013ea0: 616e 6365 6c6c 6174 696f 6e20 6475 7269  ancellation duri
+00013eb0: 6e67 2073 706f 7420 636c 7573 7465 7220  ng spot cluster 
+00013ec0: 6265 696e 6720 6c61 756e 6368 6564 2e0a  being launched..
+00013ed0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00013ee0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+00013ef0: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00013f00: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+00013f10: 6e61 6d65 7d20 2273 6c65 6570 2031 3030  name} "sleep 100
+00013f20: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
+00013f30: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
+00013f40: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00013f50: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00013f60: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00013f70: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+00013f80: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
+00013f90: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
+00013fa0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
+00013fb0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+00013fc0: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
+00013fd0: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
+00013fe0: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
+00013ff0: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
+00014000: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00014010: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+00014020: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+00014030: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00014040: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+00014050: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00014060: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+00014070: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014080: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00014090: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
+000140a0: 2020 2020 2020 2020 2020 2866 2773 3d24            (f's=$
+000140b0: 2861 7773 2065 6332 2064 6573 6372 6962  (aws ec2 describ
+000140c0: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
+000140d0: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+000140e0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+000140f0: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
+00014100: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
+00014110: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
+00014120: 2d2a 2027 0a20 2020 2020 2020 2020 2020  -* '.           
+00014130: 2020 6627 2d2d 7175 6572 7920 5265 7365    f'--query Rese
+00014140: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
+00014150: 6e63 6573 5b5d 2e53 7461 7465 5b5d 2e4e  nces[].State[].N
+00014160: 616d 6520 270a 2020 2020 2020 2020 2020  ame '.          
+00014170: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+00014180: 7429 2026 2620 6563 686f 2022 2473 2220  t) && echo "$s" 
+00014190: 2626 2065 6368 6f3b 205b 5b20 2d7a 2022  && echo; [[ -z "
+000141a0: 2473 2220 5d5d 207c 7c20 5b5b 2022 2473  $s" ]] || [[ "$s
+000141b0: 2220 3d20 2274 6572 6d69 6e61 7465 6422  " = "terminated"
+000141c0: 205d 5d20 7c7c 205b 5b20 2224 7322 203d   ]] || [[ "$s" =
+000141d0: 2022 7368 7574 7469 6e67 2d64 6f77 6e22   "shutting-down"
+000141e0: 205d 5d27 0a20 2020 2020 2020 2020 2020   ]]'.           
+000141f0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00014200: 2320 5465 7374 2063 616e 6365 6c6c 696e  # Test cancellin
+00014210: 6720 7468 6520 7370 6f74 2063 6c75 7374  g the spot clust
+00014220: 6572 2064 7572 696e 6720 7370 6f74 206a  er during spot j
+00014230: 6f62 2062 6569 6e67 2073 6574 7570 2e0a  ob being setup..
+00014240: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014250: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
+00014260: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00014270: 6f6e 207b 7265 6769 6f6e 7d20 2d6e 207b  on {region} -n {
+00014280: 6e61 6d65 7d2d 3220 7465 7374 732f 7465  name}-2 tests/te
+00014290: 7374 5f79 616d 6c73 2f74 6573 745f 6c6f  st_yamls/test_lo
+000142a0: 6e67 5f73 6574 7570 2e79 616d 6c20 202d  ng_setup.yaml  -
+000142b0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
+000142c0: 2020 2027 736c 6565 7020 3330 3027 2c0a     'sleep 300',.
+000142d0: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+000142e0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+000142f0: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00014300: 7b6e 616d 657d 2d32 2729 2c0a 2020 2020  {name}-2'),.    
+00014310: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+00014320: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014330: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00014340: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00014350: 2d32 207c 2068 6561 6420 2d6e 3120 7c20  -2 | head -n1 | 
+00014360: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+00014370: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+00014380: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00014390: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+000143a0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+000143b0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+000143c0: 6e61 6d65 7d2d 3220 7c20 6865 6164 202d  name}-2 | head -
+000143d0: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+000143e0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+000143f0: 2020 2020 2866 2773 3d24 2861 7773 2065      (f's=$(aws e
+00014400: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+00014410: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+00014420: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+00014430: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+00014440: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
+00014450: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+00014460: 7565 733d 7b6e 616d 657d 2d32 2d2a 2027  ues={name}-2-* '
+00014470: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+00014480: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
+00014490: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+000144a0: 5b5d 2e53 7461 7465 5b5d 2e4e 616d 6520  [].State[].Name 
+000144b0: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+000144c0: 2d2d 6f75 7470 7574 2074 6578 7429 2026  --output text) &
+000144d0: 2620 6563 686f 2022 2473 2220 2626 2065  & echo "$s" && e
+000144e0: 6368 6f3b 205b 5b20 2d7a 2022 2473 2220  cho; [[ -z "$s" 
+000144f0: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+00014500: 2274 6572 6d69 6e61 7465 6422 205d 5d20  "terminated" ]] 
+00014510: 7c7c 205b 5b20 2224 7322 203d 2022 7368  || [[ "$s" = "sh
+00014520: 7574 7469 6e67 2d64 6f77 6e22 205d 5d27  utting-down" ]]'
+00014530: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00014540: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+00014550: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+00014560: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
+00014570: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
+00014580: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00014590: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+000145a0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+000145b0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+000145c0: 616d 657d 2d33 2022 736c 6565 7020 3130  ame}-3 "sleep 10
+000145d0: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+000145e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+000145f0: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
+00014600: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00014610: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00014620: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
+00014630: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+00014640: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00014650: 2320 5465 726d 696e 6174 6520 7468 6520  # Terminate the 
+00014660: 636c 7573 7465 7220 6d61 6e75 616c 6c79  cluster manually
+00014670: 2e0a 2020 2020 2020 2020 2020 2020 2866  ..            (f
+00014680: 2761 7773 2065 6332 2074 6572 6d69 6e61  'aws ec2 termina
+00014690: 7465 2d69 6e73 7461 6e63 6573 202d 2d72  te-instances --r
+000146a0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+000146b0: 2d69 6e73 7461 6e63 652d 6964 7320 2428  -instance-ids $(
+000146c0: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+000146d0: 2761 7773 2065 6332 2064 6573 6372 6962  'aws ec2 describ
+000146e0: 652d 696e 7374 616e 6365 7320 2d2d 7265  e-instances --re
+000146f0: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+00014700: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00014710: 2d66 696c 7465 7273 204e 616d 653d 7461  -filters Name=ta
+00014720: 673a 7261 792d 636c 7573 7465 722d 6e61  g:ray-cluster-na
+00014730: 6d65 2c56 616c 7565 733d 7b6e 616d 657d  me,Values={name}
+00014740: 2d33 2d2a 2027 0a20 2020 2020 2020 2020  -3-* '.         
+00014750: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
+00014760: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
+00014770: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
+00014780: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
+00014790: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
+000147a0: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
+000147b0: 2020 2773 6c65 6570 2031 3230 272c 0a20    'sleep 120',. 
+000147c0: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+000147d0: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+000147e0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+000147f0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00014800: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+00014810: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
+00014820: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
+00014830: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
+00014840: 7b6e 616d 657d 2d33 2729 2c0a 2020 2020  {name}-3'),.    
+00014850: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+00014860: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014870: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00014880: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+00014890: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+000148a0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+000148b0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+000148c0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+000148d0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+000148e0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
+000148f0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+00014900: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
+00014910: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
+00014920: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
+00014930: 2020 2020 2320 5468 6520 636c 7573 7465      # The cluste
+00014940: 7220 7368 6f75 6c64 2062 6520 7465 726d  r should be term
+00014950: 696e 6174 6564 2028 7368 7574 7469 6e67  inated (shutting
+00014960: 2d64 6f77 6e29 2061 6674 6572 2063 616e  -down) after can
+00014970: 6365 6c6c 6174 696f 6e2e 2057 6520 646f  cellation. We do
+00014980: 6e27 7420 7573 6520 7468 6520 603d 6020  n't use the `=` 
+00014990: 6f70 6572 6174 6f72 2068 6572 6520 6265  operator here be
+000149a0: 6361 7573 650a 2020 2020 2020 2020 2020  cause.          
+000149b0: 2020 2320 7468 6572 6520 6361 6e20 6265    # there can be
+000149c0: 206d 756c 7469 706c 6520 564d 2077 6974   multiple VM wit
+000149d0: 6820 7468 6520 7361 6d65 206e 616d 6520  h the same name 
+000149e0: 6475 6520 746f 2074 6865 2072 6563 6f76  due to the recov
+000149f0: 6572 792e 0a20 2020 2020 2020 2020 2020  ery..           
+00014a00: 2028 6627 733d 2428 6177 7320 6563 3220   (f's=$(aws ec2 
+00014a10: 6465 7363 7269 6265 2d69 6e73 7461 6e63  describe-instanc
+00014a20: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
+00014a30: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+00014a40: 2020 2020 6627 2d2d 6669 6c74 6572 7320      f'--filters 
+00014a50: 4e61 6d65 3d74 6167 3a72 6179 2d63 6c75  Name=tag:ray-clu
+00014a60: 7374 6572 2d6e 616d 652c 5661 6c75 6573  ster-name,Values
+00014a70: 3d7b 6e61 6d65 7d2d 332d 2a20 270a 2020  ={name}-3-* '.  
+00014a80: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
+00014a90: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
+00014aa0: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
+00014ab0: 5374 6174 655b 5d2e 4e61 6d65 2027 0a20  State[].Name '. 
+00014ac0: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
+00014ad0: 7574 7075 7420 7465 7874 2920 2626 2065  utput text) && e
+00014ae0: 6368 6f20 2224 7322 2026 2620 6563 686f  cho "$s" && echo
+00014af0: 3b20 5b5b 202d 7a20 2224 7322 205d 5d20  ; [[ -z "$s" ]] 
+00014b00: 7c7c 2065 6368 6f20 2224 7322 207c 2067  || echo "$s" | g
+00014b10: 7265 7020 2d76 202d 4520 2270 656e 6469  rep -v -E "pendi
+00014b20: 6e67 7c72 756e 6e69 6e67 7c73 746f 7070  ng|running|stopp
+00014b30: 6564 7c73 746f 7070 696e 6722 270a 2020  ed|stopping"'.  
+00014b40: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00014b50: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00014b60: 7469 6d65 6f75 743d 3235 202a 2036 3029  timeout=25 * 60)
+00014b70: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00014b80: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00014b90: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
+00014ba0: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00014bb0: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00014bc0: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
+00014bd0: 6763 7028 293a 0a20 2020 206e 616d 6520  gcp():.    name 
+00014be0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00014bf0: 616d 6528 290a 2020 2020 7a6f 6e65 203d  ame().    zone =
+00014c00: 2027 7573 2d77 6573 7433 2d62 270a 2020   'us-west3-b'.  
+00014c10: 2020 7175 6572 795f 7374 6174 655f 636d    query_state_cm
+00014c20: 6420 3d20 2827 6763 6c6f 7564 2063 6f6d  d = ('gcloud com
+00014c30: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+00014c40: 6973 7420 270a 2020 2020 2020 2020 2020  ist '.          
+00014c50: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+00014c60: 2d66 696c 7465 723d 2228 6c61 6265 6c73  -filter="(labels
+00014c70: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+00014c80: 653a 7b6e 616d 657d 2922 2027 0a20 2020  e:{name})" '.   
+00014c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ca0: 2020 2020 272d 2d66 6f72 6d61 743d 2276      '--format="v
+00014cb0: 616c 7565 2873 7461 7475 7329 2227 290a  alue(status)"').
+00014cc0: 2020 2020 7175 6572 795f 636d 6420 3d20      query_cmd = 
+00014cd0: 2866 2767 636c 6f75 6420 636f 6d70 7574  (f'gcloud comput
+00014ce0: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
+00014cf0: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
+00014d00: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
+00014d10: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
+00014d20: 7465 722d 6e61 6d65 3a7b 6e61 6d65 7d29  ter-name:{name})
+00014d30: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+00014d40: 2020 2020 2066 272d 2d7a 6f6e 6573 3d7b       f'--zones={
+00014d50: 7a6f 6e65 7d20 2d2d 666f 726d 6174 3d22  zone} --format="
+00014d60: 7661 6c75 6528 6e61 6d65 2922 2729 0a20  value(name)"'). 
+00014d70: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+00014d80: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+00014d90: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
+00014da0: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
+00014db0: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
+00014dc0: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
+00014dd0: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
+00014de0: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
+00014df0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00014e00: 7370 6f74 5f63 616e 6365 6c6c 6174 696f  spot_cancellatio
+00014e10: 6e5f 6763 7027 2c0a 2020 2020 2020 2020  n_gcp',.        
+00014e20: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
+00014e30: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
+00014e40: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
+00014e50: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
+00014e60: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
+00014e70: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
+00014e80: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
+00014e90: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
+00014ea0: 207b 6e61 6d65 7d20 2273 6c65 6570 2031   {name} "sleep 1
+00014eb0: 3030 3022 2020 2d79 202d 6427 2c0a 2020  000"  -y -d',.  
+00014ec0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00014ed0: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+00014ee0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00014ef0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00014f00: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00014f10: 2067 7265 7020 2253 5441 5254 494e 4722   grep "STARTING"
+00014f20: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00014f30: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+00014f40: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00014f50: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+00014f60: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+00014f70: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
+00014f80: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
+00014f90: 2067 7265 7020 7b6e 616d 657d 207c 2068   grep {name} | h
+00014fa0: 6561 6420 2d6e 3120 7c20 6772 6570 2022  ead -n1 | grep "
+00014fb0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+00014fc0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+00014fd0: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+00014fe0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014ff0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+00015000: 547d 7c20 6772 6570 207b 6e61 6d65 7d20  T}| grep {name} 
+00015010: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00015020: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00015030: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+00015040: 7374 2063 616e 6365 6c6c 696e 6720 7468  st cancelling th
+00015050: 6520 7370 6f74 2063 6c75 7374 6572 2064  e spot cluster d
+00015060: 7572 696e 6720 7370 6f74 206a 6f62 2062  uring spot job b
+00015070: 6569 6e67 2073 6574 7570 2e0a 2020 2020  eing setup..    
+00015080: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
+00015090: 6f74 206c 6175 6e63 6820 2d2d 636c 6f75  ot launch --clou
+000150a0: 6420 6763 7020 2d2d 7a6f 6e65 207b 7a6f  d gcp --zone {zo
+000150b0: 6e65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  ne} -n {name}-2 
+000150c0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+000150d0: 2f74 6573 745f 6c6f 6e67 5f73 6574 7570  /test_long_setup
+000150e0: 2e79 616d 6c20 202d 7920 2d64 272c 0a20  .yaml  -y -d',. 
+000150f0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015100: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
+00015110: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
+00015120: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00015130: 5f6e 616d 653d 6627 7b6e 616d 657d 2d32  _name=f'{name}-2
+00015140: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00015150: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00015160: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+00015170: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00015180: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+00015190: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+000151a0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+000151b0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+000151c0: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+000151d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+000151e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
+000151f0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
+00015200: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+00015210: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00015220: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+00015230: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+00015240: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
+00015250: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
+00015260: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00015270: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
+00015280: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+00015290: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
+000152a0: 2d33 2022 736c 6565 7020 3130 3030 2220  -3 "sleep 1000" 
+000152b0: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+000152c0: 2020 2020 2027 736c 6565 7020 3330 3027       'sleep 300'
+000152d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000152e0: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+000152f0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+00015300: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
+00015310: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+00015320: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+00015330: 726d 696e 6174 6520 7468 6520 636c 7573  rminate the clus
+00015340: 7465 7220 6d61 6e75 616c 6c79 2e0a 2020  ter manually..  
+00015350: 2020 2020 2020 2020 2020 7465 726d 696e            termin
+00015360: 6174 655f 636d 642c 0a20 2020 2020 2020  ate_cmd,.       
+00015370: 2020 2020 2027 736c 6565 7020 3130 3027       'sleep 100'
+00015380: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00015390: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
+000153a0: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
+000153b0: 3320 7c20 6865 6164 202d 6e31 207c 2067  3 | head -n1 | g
+000153c0: 7265 7020 2252 4543 4f56 4552 494e 4722  rep "RECOVERING"
+000153d0: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+000153e0: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
+000153f0: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00015400: 3d66 277b 6e61 6d65 7d2d 3327 292c 0a20  =f'{name}-3'),. 
+00015410: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015420: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00015430: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00015440: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00015450: 6d65 7d2d 3320 7c20 6865 6164 202d 6e31  me}-3 | head -n1
+00015460: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
+00015470: 494e 475c 7c43 414e 4345 4c4c 4544 2227  ING\|CANCELLED"'
+00015480: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00015490: 6c65 6570 2031 3230 272c 0a20 2020 2020  leep 120',.     
+000154a0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
+000154b0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+000154c0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+000154d0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+000154e0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+000154f0: 2020 2020 2020 2023 2054 6865 2063 6c75         # The clu
+00015500: 7374 6572 2073 686f 756c 6420 6265 2074  ster should be t
+00015510: 6572 6d69 6e61 7465 6420 2853 544f 5050  erminated (STOPP
+00015520: 494e 4729 2061 6674 6572 2063 616e 6365  ING) after cance
+00015530: 6c6c 6174 696f 6e2e 2057 6520 646f 6e27  llation. We don'
+00015540: 7420 7573 6520 7468 6520 603d 6020 6f70  t use the `=` op
+00015550: 6572 6174 6f72 2068 6572 6520 6265 6361  erator here beca
+00015560: 7573 650a 2020 2020 2020 2020 2020 2020  use.            
+00015570: 2320 7468 6572 6520 6361 6e20 6265 206d  # there can be m
+00015580: 756c 7469 706c 6520 564d 2077 6974 6820  ultiple VM with 
+00015590: 7468 6520 7361 6d65 206e 616d 6520 6475  the same name du
+000155a0: 6520 746f 2074 6865 2072 6563 6f76 6572  e to the recover
+000155b0: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
+000155c0: 6627 733d 2428 7b71 7565 7279 5f73 7461  f's=$({query_sta
+000155d0: 7465 5f63 6d64 7d29 2026 2620 6563 686f  te_cmd}) && echo
+000155e0: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
+000155f0: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
+00015600: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00015610: 202d 7620 2d45 2022 5052 4f56 4953 494f   -v -E "PROVISIO
+00015620: 4e49 4e47 7c53 5441 4749 4e47 7c52 554e  NING|STAGING|RUN
+00015630: 4e49 4e47 7c52 4550 4149 5249 4e47 7c54  NING|REPAIRING|T
+00015640: 4552 4d49 4e41 5445 447c 5355 5350 454e  ERMINATED|SUSPEN
+00015650: 4449 4e47 7c53 5553 5045 4e44 4544 7c53  DING|SUSPENDED|S
+00015660: 5553 5045 4e44 4544 2227 0a20 2020 2020  USPENDED"'.     
+00015670: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+00015680: 2020 5d2c 0a20 2020 2020 2020 2074 696d    ],.        tim
+00015690: 656f 7574 3d32 3520 2a20 3630 290a 2020  eout=25 * 60).  
+000156a0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000156b0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+000156c0: 2d2d 2d20 5465 7374 696e 6720 7374 6f72  --- Testing stor
+000156d0: 6167 6520 666f 7220 6d61 6e61 6765 6420  age for managed 
+000156e0: 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a  spot ----------.
+000156f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00015700: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+00015710: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
+00015720: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
+00015730: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
+00015740: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+00015750: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
+00015760: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+00015770: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00015780: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+00015790: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+000157a0: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+000157b0: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+000157c0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 7370  .mark.managed_sp
+000157d0: 6f74 0a64 6566 2074 6573 745f 7370 6f74  ot.def test_spot
+000157e0: 5f73 746f 7261 6765 2867 656e 6572 6963  _storage(generic
+000157f0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00015800: 2020 2222 2254 6573 7420 7374 6f72 6167    """Test storag
+00015810: 6520 7769 7468 206d 616e 6167 6564 2073  e with managed s
+00015820: 706f 7422 2222 0a20 2020 206e 616d 6520  pot""".    name 
+00015830: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00015840: 616d 6528 290a 2020 2020 7961 6d6c 5f73  ame().    yaml_s
+00015850: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+00015860: 6828 0a20 2020 2020 2020 2027 6578 616d  h(.        'exam
+00015870: 706c 6573 2f6d 616e 6167 6564 5f73 706f  ples/managed_spo
+00015880: 745f 7769 7468 5f73 746f 7261 6765 2e79  t_with_storage.y
+00015890: 616d 6c27 292e 7265 6164 5f74 6578 7428  aml').read_text(
+000158a0: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
+000158b0: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
+000158c0: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
+000158d0: 297d 270a 2020 2020 7961 6d6c 5f73 7472  )}'.    yaml_str
+000158e0: 203d 2079 616d 6c5f 7374 722e 7265 706c   = yaml_str.repl
+000158f0: 6163 6528 2773 6b79 2d77 6f72 6b64 6972  ace('sky-workdir
+00015900: 2d7a 6877 7527 2c20 7374 6f72 6167 655f  -zhwu', storage_
+00015910: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
+00015920: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+00015930: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+00015940: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+00015950: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+00015960: 2020 2066 2e77 7269 7465 2879 616d 6c5f     f.write(yaml_
+00015970: 7374 7229 0a20 2020 2020 2020 2066 2e66  str).        f.f
+00015980: 6c75 7368 2829 0a20 2020 2020 2020 2066  lush().        f
+00015990: 696c 655f 7061 7468 203d 2066 2e6e 616d  ile_path = f.nam
+000159a0: 650a 2020 2020 2020 2020 7465 7374 203d  e.        test =
+000159b0: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+000159c0: 2020 2027 7370 6f74 5f73 746f 7261 6765     'spot_storage
+000159d0: 272c 0a20 2020 2020 2020 2020 2020 205b  ',.            [
+000159e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000159f0: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+00015a00: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00015a10: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00015a20: 7370 6f74 206c 6175 6e63 6820 2d6e 207b  spot launch -n {
+00015a30: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00015a40: 656e 6572 6963 5f63 6c6f 7564 7d20 7b66  eneric_cloud} {f
+00015a50: 696c 655f 7061 7468 7d20 2d79 272c 0a20  ile_path} -y',. 
+00015a60: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00015a70: 736c 6565 7020 3630 272c 2020 2320 5761  sleep 60',  # Wa
+00015a80: 6974 2074 6865 2073 706f 7420 7175 6575  it the spot queu
+00015a90: 6520 746f 2062 6520 7570 6461 7465 640a  e to be updated.
+00015aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ab0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
+00015ac0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+00015ad0: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+00015ae0: 4544 272c 0a20 2020 2020 2020 2020 2020  ED',.           
+00015af0: 2020 2020 2066 275b 2024 2861 7773 2073       f'[ $(aws s
+00015b00: 3361 7069 206c 6973 742d 6275 636b 6574  3api list-bucket
+00015b10: 7320 2d2d 7175 6572 7920 2242 7563 6b65  s --query "Bucke
+00015b20: 7473 5b3f 636f 6e74 6169 6e73 284e 616d  ts[?contains(Nam
+00015b30: 652c 205c 277b 7374 6f72 6167 655f 6e61  e, \'{storage_na
+00015b40: 6d65 7d5c 2729 5d2e 4e61 6d65 2220 2d2d  me}\')].Name" --
+00015b50: 6f75 7470 7574 2074 6578 7420 7c20 7763  output text | wc
+00015b60: 202d 6c29 202d 6571 2030 205d 270a 2020   -l) -eq 0 ]'.  
+00015b70: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+00015b80: 2020 2020 2020 2020 205f 5350 4f54 5f43           _SPOT_C
+00015b90: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+00015ba0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+00015bb0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00015bc0: 496e 6372 6561 7365 2074 696d 656f 7574  Increase timeout
+00015bd0: 2073 696e 6365 2073 6b79 2073 706f 7420   since sky spot 
+00015be0: 7175 6575 6520 2d72 2063 616e 2062 6520  queue -r can be 
+00015bf0: 626c 6f63 6b65 6420 6279 206f 7468 6572  blocked by other
+00015c00: 2073 706f 7420 7465 7374 732e 0a20 2020   spot tests..   
+00015c10: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+00015c20: 3d32 3020 2a20 3630 2c0a 2020 2020 2020  =20 * 60,.      
+00015c30: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
+00015c40: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00015c50: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00015c60: 7374 696e 6720 7370 6f74 2054 5055 202d  sting spot TPU -
+00015c70: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+00015c80: 742e 6d61 726b 2e67 6370 0a40 7079 7465  t.mark.gcp.@pyte
+00015c90: 7374 2e6d 6172 6b2e 6d61 6e61 6765 645f  st.mark.managed_
+00015ca0: 7370 6f74 0a64 6566 2074 6573 745f 7370  spot.def test_sp
+00015cb0: 6f74 5f74 7075 2829 3a0a 2020 2020 2222  ot_tpu():.    ""
+00015cc0: 2254 6573 7420 6d61 6e61 6765 6420 7370  "Test managed sp
+00015cd0: 6f74 206f 6e20 5450 552e 2222 220a 2020  ot on TPU.""".  
+00015ce0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00015cf0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00015d00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00015d10: 2020 2020 2020 2774 6573 742d 7370 6f74        'test-spot
+00015d20: 2d74 7075 272c 0a20 2020 2020 2020 205b  -tpu',.        [
+00015d30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00015d40: 6b79 2073 706f 7420 6c61 756e 6368 202d  ky spot launch -
+00015d50: 6e20 7b6e 616d 657d 2065 7861 6d70 6c65  n {name} example
+00015d60: 732f 7470 752f 7470 7576 6d5f 6d6e 6973  s/tpu/tpuvm_mnis
+00015d70: 742e 7961 6d6c 202d 7920 2d64 272c 0a20  t.yaml -y -d',. 
+00015d80: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00015d90: 7020 3527 2c0a 2020 2020 2020 2020 2020  p 5',.          
+00015da0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
+00015db0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00015dc0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00015dd0: 2067 7265 7020 5354 4152 5449 4e47 272c   grep STARTING',
+00015de0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+00015df0: 6565 7020 3630 3027 2c20 2023 2054 5055  eep 600',  # TPU
+00015e00: 2074 616b 6573 2061 2077 6869 6c65 2074   takes a while t
+00015e10: 6f20 6c61 756e 6368 0a20 2020 2020 2020  o launch.       
+00015e20: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
+00015e30: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+00015e40: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+00015e50: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+00015e60: 475c 7c53 5543 4345 4544 4544 2227 2c0a  G\|SUCCEEDED"',.
+00015e70: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00015e80: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
+00015e90: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+00015ea0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+00015eb0: 2020 2020 2320 496e 6372 6561 7365 2074      # Increase t
+00015ec0: 696d 656f 7574 2073 696e 6365 2073 6b79  imeout since sky
+00015ed0: 2073 706f 7420 7175 6575 6520 2d72 2063   spot queue -r c
+00015ee0: 616e 2062 6520 626c 6f63 6b65 6420 6279  an be blocked by
+00015ef0: 206f 7468 6572 2073 706f 7420 7465 7374   other spot test
+00015f00: 732e 0a20 2020 2020 2020 2074 696d 656f  s..        timeo
+00015f10: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+00015f20: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00015f30: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00015f40: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00015f50: 656e 7620 666f 7220 7370 6f74 202d 2d2d  env for spot ---
+00015f60: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00015f70: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+00015f80: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+00015f90: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+00015fa0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00015fb0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00015fc0: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+00015fd0: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00015fe0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00015ff0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00016000: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
+00016010: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00016020: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00016030: 0a40 7079 7465 7374 2e6d 6172 6b2e 6d61  .@pytest.mark.ma
+00016040: 6e61 6765 645f 7370 6f74 0a64 6566 2074  naged_spot.def t
+00016050: 6573 745f 7370 6f74 5f69 6e6c 696e 655f  est_spot_inline_
+00016060: 656e 7628 6765 6e65 7269 635f 636c 6f75  env(generic_clou
+00016070: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
+00016080: 5465 7374 2073 706f 7420 656e 7622 2222  Test spot env"""
+00016090: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+000160a0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+000160b0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+000160c0: 0a20 2020 2020 2020 2027 7465 7374 2d73  .        'test-s
+000160d0: 706f 742d 696e 6c69 6e65 2d65 6e76 272c  pot-inline-env',
+000160e0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+000160f0: 2020 2020 2020 2066 2773 6b79 2073 706f         f'sky spo
+00016100: 7420 6c61 756e 6368 202d 6e20 7b6e 616d  t launch -n {nam
+00016110: 657d 202d 7920 2d2d 636c 6f75 6420 7b67  e} -y --cloud {g
+00016120: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+00016130: 656e 7620 5445 5354 5f45 4e56 3d22 6865  env TEST_ENV="he
+00016140: 6c6c 6f20 776f 726c 6422 202d 2d20 2228  llo world" -- "(
+00016150: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
+00016160: 545f 454e 565c 5c22 205d 5d20 2626 205b  T_ENV\\" ]] && [
+00016170: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
+00016180: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
+00016190: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
+000161a0: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
+000161b0: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
+000161c0: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
+000161d0: 2020 2020 2020 2027 736c 6565 7020 3230         'sleep 20
+000161e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000161f0: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
+00016200: 4954 7d20 7c20 6772 6570 207b 6e61 6d65  IT} | grep {name
+00016210: 7d20 7c20 6772 6570 2053 5543 4345 4544  } | grep SUCCEED
+00016220: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
+00016230: 2020 2020 2020 2020 5f53 504f 545f 4341          _SPOT_CA
+00016240: 4e43 454c 5f57 4149 542e 666f 726d 6174  NCEL_WAIT.format
+00016250: 286a 6f62 5f6e 616d 653d 6e61 6d65 292c  (job_name=name),
+00016260: 0a20 2020 2020 2020 2023 2049 6e63 7265  .        # Incre
+00016270: 6173 6520 7469 6d65 6f75 7420 7369 6e63  ase timeout sinc
+00016280: 6520 736b 7920 7370 6f74 2071 7565 7565  e sky spot queue
+00016290: 202d 7220 6361 6e20 6265 2062 6c6f 636b   -r can be block
+000162a0: 6564 2062 7920 6f74 6865 7220 7370 6f74  ed by other spot
+000162b0: 2074 6573 7473 2e0a 2020 2020 2020 2020   tests..        
+000162c0: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+000162d0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000162e0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000162f0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00016300: 7469 6e67 2065 6e76 202d 2d2d 2d2d 2d2d  ting env -------
+00016310: 2d2d 2d0a 6465 6620 7465 7374 5f69 6e6c  ---.def test_inl
+00016320: 696e 655f 656e 7628 6765 6e65 7269 635f  ine_env(generic_
+00016330: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00016340: 2022 2222 5465 7374 2065 6e76 2222 220a   """Test env""".
+00016350: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00016360: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00016370: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00016380: 2020 2020 2020 2020 2774 6573 742d 696e          'test-in
+00016390: 6c69 6e65 2d65 6e76 272c 0a20 2020 2020  line-env',.     
+000163a0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000163b0: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+000163c0: 207b 6e61 6d65 7d20 2d79 202d 2d63 6c6f   {name} -y --clo
+000163d0: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+000163e0: 647d 202d 2d65 6e76 2054 4553 545f 454e  d} --env TEST_EN
+000163f0: 563d 2268 656c 6c6f 2077 6f72 6c64 2220  V="hello world" 
+00016400: 2d2d 2022 285b 5b20 2120 2d7a 205c 5c22  -- "([[ ! -z \\"
+00016410: 5c24 5445 5354 5f45 4e56 5c5c 2220 5d5d  \$TEST_ENV\\" ]]
+00016420: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+00016430: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
+00016440: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
+00016450: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+00016460: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
+00016470: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
+00016480: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00016490: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+000164a0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+000164b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000164c0: 6320 7b6e 616d 657d 202d 2d65 6e76 2054  c {name} --env T
+000164d0: 4553 545f 454e 5632 3d22 7375 6363 6573  EST_ENV2="succes
+000164e0: 7322 2022 285b 5b20 2120 2d7a 205c 5c22  s" "([[ ! -z \\"
+000164f0: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
+00016500: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+00016510: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+00016520: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+00016530: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+00016540: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+00016550: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+00016560: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016570: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00016580: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00016590: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000165a0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000165b0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+000165c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000165d0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+000165e0: 2d20 5465 7374 696e 6720 6375 7374 6f6d  - Testing custom
+000165f0: 2069 6d61 6765 202d 2d2d 2d2d 2d2d 2d2d   image ---------
+00016600: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
+00016610: 7773 0a64 6566 2074 6573 745f 6375 7374  ws.def test_cust
+00016620: 6f6d 5f69 6d61 6765 2829 3a0a 2020 2020  om_image():.    
+00016630: 2222 2254 6573 7420 6375 7374 6f6d 2069  """Test custom i
+00016640: 6d61 6765 2222 220a 2020 2020 6e61 6d65  mage""".    name
+00016650: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00016660: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00016670: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00016680: 2774 6573 742d 6375 7374 6f6d 2d69 6d61  'test-custom-ima
+00016690: 6765 272c 0a20 2020 2020 2020 205b 0a20  ge',.        [. 
+000166a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000166b0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+000166c0: 7d20 2d2d 7265 7472 792d 756e 7469 6c2d  } --retry-until-
+000166d0: 7570 202d 7920 6578 616d 706c 6573 2f63  up -y examples/c
+000166e0: 7573 746f 6d5f 696d 6167 652e 7961 6d6c  ustom_image.yaml
+000166f0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016700: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00016710: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
+00016720: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00016730: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00016740: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00016750: 7469 6d65 6f75 743d 3330 202a 2036 302c  timeout=30 * 60,
+00016760: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00016770: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00016780: 4070 7974 6573 742e 6d61 726b 2e73 6c6f  @pytest.mark.slo
+00016790: 770a 6465 6620 7465 7374 5f61 7a75 7265  w.def test_azure
+000167a0: 5f73 7461 7274 5f73 746f 705f 7477 6f5f  _start_stop_two_
+000167b0: 6e6f 6465 7328 293a 0a20 2020 206e 616d  nodes():.    nam
+000167c0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000167d0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+000167e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000167f0: 2027 617a 7572 652d 7374 6172 742d 7374   'azure-start-st
+00016800: 6f70 2d74 776f 2d6e 6f64 6573 272c 0a20  op-two-nodes',. 
+00016810: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00016820: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00016830: 6820 2d2d 6e75 6d2d 6e6f 6465 733d 3220  h --num-nodes=2 
+00016840: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
+00016850: 6d70 6c65 732f 617a 7572 655f 7374 6172  mples/azure_star
+00016860: 745f 7374 6f70 2e79 616d 6c27 2c0a 2020  t_stop.yaml',.  
+00016870: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00016880: 6578 6563 202d 2d6e 756d 2d6e 6f64 6573  exec --num-nodes
+00016890: 3d32 207b 6e61 6d65 7d20 6578 616d 706c  =2 {name} exampl
+000168a0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+000168b0: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+000168c0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000168d0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+000168e0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+000168f0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00016900: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00016910: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
+00016920: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+00016930: 2020 6627 736b 7920 7374 6172 7420 2d79    f'sky start -y
+00016940: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00016950: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00016960: 202d 2d6e 756d 2d6e 6f64 6573 3d32 207b   --num-nodes=2 {
+00016970: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
+00016980: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
+00016990: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000169a0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000169b0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+000169c0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000169d0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+000169e0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+000169f0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00016a00: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+00016a10: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+00016a20: 2c20 2023 2033 3020 6d69 6e73 2020 2869  ,  # 30 mins  (i
+00016a30: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
+00016a40: 3233 206d 696e 7329 0a20 2020 2029 0a20  23 mins).    ). 
+00016a50: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00016a60: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00016a70: 2d2d 2d2d 2054 6573 7469 6e67 2065 6e76  ---- Testing env
+00016a80: 2066 6f72 2064 6973 6b20 7469 6572 202d   for disk tier -
+00016a90: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+00016aa0: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
+00016ab0: 6573 745f 6177 735f 6469 736b 5f74 6965  est_aws_disk_tie
+00016ac0: 7228 293a 0a0a 2020 2020 6465 6620 5f67  r():..    def _g
+00016ad0: 6574 5f61 7773 5f71 7565 7279 5f63 6f6d  et_aws_query_com
+00016ae0: 6d61 6e64 2872 6567 696f 6e2c 2069 6e73  mand(region, ins
+00016af0: 7461 6e63 655f 6964 2c20 6669 656c 642c  tance_id, field,
+00016b00: 2065 7870 6563 7465 6429 3a0a 2020 2020   expected):.    
+00016b10: 2020 2020 7265 7475 726e 2028 6627 6177      return (f'aw
+00016b20: 7320 6563 3220 6465 7363 7269 6265 2d76  s ec2 describe-v
+00016b30: 6f6c 756d 6573 202d 2d72 6567 696f 6e20  olumes --region 
+00016b40: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+00016b50: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+00016b60: 696c 7465 7273 204e 616d 653d 6174 7461  ilters Name=atta
+00016b70: 6368 6d65 6e74 2e69 6e73 7461 6e63 652d  chment.instance-
+00016b80: 6964 2c56 616c 7565 733d 7b69 6e73 7461  id,Values={insta
+00016b90: 6e63 655f 6964 7d20 270a 2020 2020 2020  nce_id} '.      
+00016ba0: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
+00016bb0: 6572 7920 566f 6c75 6d65 735b 2a5d 2e7b  ery Volumes[*].{
+00016bc0: 6669 656c 647d 207c 2067 7265 7020 7b65  field} | grep {e
+00016bd0: 7870 6563 7465 647d 203b 2027 290a 0a20  xpected} ; ').. 
+00016be0: 2020 2066 6f72 2064 6973 6b5f 7469 6572     for disk_tier
+00016bf0: 2069 6e20 5b27 6c6f 7727 2c20 276d 6564   in ['low', 'med
+00016c00: 6975 6d27 2c20 2768 6967 6827 5d3a 0a20  ium', 'high']:. 
+00016c10: 2020 2020 2020 2073 7065 6373 203d 2041         specs = A
+00016c20: 5753 2e5f 6765 745f 6469 736b 5f73 7065  WS._get_disk_spe
+00016c30: 6373 2864 6973 6b5f 7469 6572 290a 2020  cs(disk_tier).  
+00016c40: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+00016c50: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00016c60: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
+00016c70: 6572 0a20 2020 2020 2020 2072 6567 696f  er.        regio
+00016c80: 6e20 3d20 2775 732d 7765 7374 2d32 270a  n = 'us-west-2'.
+00016c90: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+00016ca0: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+00016cb0: 2027 6177 732d 6469 736b 2d74 6965 7227   'aws-disk-tier'
+00016cc0: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
+00016cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ce0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00016cf0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00016d00: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
+00016d10: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+00016d20: 2020 2020 2020 2020 2020 6627 2d2d 6469            f'--di
+00016d30: 736b 2d74 6965 7220 7b64 6973 6b5f 7469  sk-tier {disk_ti
+00016d40: 6572 7d20 6563 686f 2022 6865 6c6c 6f20  er} echo "hello 
+00016d50: 736b 7922 272c 0a20 2020 2020 2020 2020  sky"',.         
+00016d60: 2020 2020 2020 2066 2769 643d 6061 7773         f'id=`aws
+00016d70: 2065 6332 2064 6573 6372 6962 652d 696e   ec2 describe-in
+00016d80: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+00016d90: 207b 7265 6769 6f6e 7d20 2d2d 6669 6c74   {region} --filt
+00016da0: 6572 7320 270a 2020 2020 2020 2020 2020  ers '.          
+00016db0: 2020 2020 2020 6627 4e61 6d65 3d74 6167        f'Name=tag
+00016dc0: 3a72 6179 2d63 6c75 7374 6572 2d6e 616d  :ray-cluster-nam
+00016dd0: 652c 5661 6c75 6573 3d7b 6e61 6d65 7d20  e,Values={name} 
+00016de0: 2d2d 7175 6572 7920 270a 2020 2020 2020  --query '.      
+00016df0: 2020 2020 2020 2020 2020 6627 5265 7365            f'Rese
+00016e00: 7276 6174 696f 6e73 5b5d 2e49 6e73 7461  rvations[].Insta
+00016e10: 6e63 6573 5b5d 2e49 6e73 7461 6e63 6549  nces[].InstanceI
+00016e20: 6420 2d2d 6f75 7470 7574 2074 6578 7460  d --output text`
+00016e30: 3b20 2720 2b0a 2020 2020 2020 2020 2020  ; ' +.          
+00016e40: 2020 2020 2020 5f67 6574 5f61 7773 5f71        _get_aws_q
+00016e50: 7565 7279 5f63 6f6d 6d61 6e64 2872 6567  uery_command(reg
+00016e60: 696f 6e2c 2027 2469 6427 2c20 2756 6f6c  ion, '$id', 'Vol
+00016e70: 756d 6554 7970 6527 2c0a 2020 2020 2020  umeType',.      
+00016e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ea0: 2073 7065 6373 5b27 6469 736b 5f74 6965   specs['disk_tie
+00016eb0: 7227 5d29 202b 0a20 2020 2020 2020 2020  r']) +.         
+00016ec0: 2020 2020 2020 2028 2727 2069 6620 6469         ('' if di
+00016ed0: 736b 5f74 6965 7220 3d3d 2027 6c6f 7727  sk_tier == 'low'
+00016ee0: 2065 6c73 650a 2020 2020 2020 2020 2020   else.          
+00016ef0: 2020 2020 2020 2028 5f67 6574 5f61 7773         (_get_aws
+00016f00: 5f71 7565 7279 5f63 6f6d 6d61 6e64 2872  _query_command(r
+00016f10: 6567 696f 6e2c 2027 2469 6427 2c20 2749  egion, '$id', 'I
+00016f20: 6f70 7327 2c0a 2020 2020 2020 2020 2020  ops',.          
+00016f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016f50: 7065 6373 5b27 6469 736b 5f69 6f70 7327  pecs['disk_iops'
+00016f60: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00016f70: 2020 2020 2020 205f 6765 745f 6177 735f         _get_aws_
+00016f80: 7175 6572 795f 636f 6d6d 616e 6428 7265  query_command(re
+00016f90: 6769 6f6e 2c20 2724 6964 272c 2027 5468  gion, '$id', 'Th
+00016fa0: 726f 7567 6870 7574 272c 0a20 2020 2020  roughput',.     
 00016fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fc0: 2020 2020 2020 2020 2827 746d 705f 6773          ('tmp_gs
-00016fd0: 7574 696c 5f62 7563 6b65 7427 2c20 7374  util_bucket', st
-00016fe0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-00016ff0: 7970 652e 4743 5329 2c0a 2020 2020 2020  ype.GCS),.      
-00017000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017010: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-00017020: 6172 616d 2827 746d 705f 6177 7363 6c69  aram('tmp_awscli
-00017030: 5f62 7563 6b65 745f 7232 272c 0a20 2020  _bucket_r2',.   
-00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017060: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-00017070: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-00017080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170a0: 2020 2020 2020 2020 2020 2020 206d 6172               mar
-000170b0: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
-000170c0: 6c6f 7564 666c 6172 6529 5d29 0a20 2020  loudflare)]).   
-000170d0: 2064 6566 2074 6573 745f 7570 6c6f 6164   def test_upload
-000170e0: 5f74 6f5f 6578 6973 7469 6e67 5f62 7563  _to_existing_buc
-000170f0: 6b65 7428 7365 6c66 2c20 6578 745f 6275  ket(self, ext_bu
-00017100: 636b 6574 5f66 6978 7475 7265 2c20 7265  cket_fixture, re
-00017110: 7175 6573 742c 0a20 2020 2020 2020 2020  quest,.         
-00017120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017130: 2020 2020 2020 2020 2020 2020 2020 746d                tm
-00017140: 705f 736f 7572 6365 2c20 7374 6f72 655f  p_source, store_
-00017150: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
-00017160: 2054 7269 6573 2075 706c 6f61 6469 6e67   Tries uploading
-00017170: 2065 7869 7374 696e 6720 6669 6c65 7320   existing files 
-00017180: 746f 206e 6577 6c79 2063 7265 6174 6564  to newly created
-00017190: 2062 7563 6b65 7420 286f 7574 7369 6465   bucket (outside
-000171a0: 206f 660a 2020 2020 2020 2020 2320 736b   of.        # sk
-000171b0: 7929 2061 6e64 2076 6572 6966 6965 7320  y) and verifies 
-000171c0: 7468 6174 2066 696c 6573 2061 7265 2077  that files are w
-000171d0: 7269 7474 656e 2e0a 2020 2020 2020 2020  ritten..        
-000171e0: 6275 636b 6574 5f6e 616d 6520 3d20 7265  bucket_name = re
-000171f0: 7175 6573 742e 6765 7466 6978 7475 7265  quest.getfixture
-00017200: 7661 6c75 6528 6578 745f 6275 636b 6574  value(ext_bucket
-00017210: 5f66 6978 7475 7265 290a 2020 2020 2020  _fixture).      
-00017220: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
-00017230: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
-00017240: 6167 6528 6e61 6d65 3d62 7563 6b65 745f  age(name=bucket_
-00017250: 6e61 6d65 2c20 736f 7572 6365 3d74 6d70  name, source=tmp
-00017260: 5f73 6f75 7263 6529 0a20 2020 2020 2020  _source).       
-00017270: 2073 746f 7261 6765 5f6f 626a 2e61 6464   storage_obj.add
-00017280: 5f73 746f 7265 2873 746f 7265 5f74 7970  _store(store_typ
-00017290: 6529 0a0a 2020 2020 2020 2020 2320 4368  e)..        # Ch
-000172a0: 6563 6b20 6966 2074 6d70 5f73 6f75 7263  eck if tmp_sourc
-000172b0: 652f 746d 702d 6669 6c65 2065 7869 7374  e/tmp-file exist
-000172c0: 7320 696e 2074 6865 2062 7563 6b65 7420  s in the bucket 
-000172d0: 7573 696e 6720 6177 7320 636c 690a 2020  using aws cli.  
-000172e0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
-000172f0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
-00017300: 7075 7428 7365 6c66 2e63 6c69 5f6c 735f  put(self.cli_ls_
-00017310: 636d 6428 7374 6f72 655f 7479 7065 2c20  cmd(store_type, 
-00017320: 6275 636b 6574 5f6e 616d 6529 2c0a 2020  bucket_name),.  
-00017330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017350: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
-00017360: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
-00017370: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
-00017380: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00017390: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
-000173a0: 2746 696c 6520 6e6f 7420 666f 756e 6420  'File not found 
-000173b0: 696e 2062 7563 6b65 7420 2d20 6f75 7470  in bucket - outp
-000173c0: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
-000173d0: 6d61 7428 6f75 742e 6465 636f 6465 0a20  mat(out.decode. 
-000173e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017410: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00017420: 2775 7466 2d38 2729 290a 0a20 2020 2020  'utf-8'))..     
-00017430: 2020 2023 2043 6865 636b 2073 796d 6c69     # Check symli
-00017440: 6e6b 7320 2d20 7379 6d6c 696e 6b73 2064  nks - symlinks d
-00017450: 6f6e 2774 2067 6574 2063 6f70 6965 6420  on't get copied 
-00017460: 6279 2073 6b79 2073 746f 7261 6765 0a20  by sky storage. 
-00017470: 2020 2020 2020 2061 7373 6572 7420 2870         assert (p
-00017480: 6174 686c 6962 2e50 6174 6828 746d 705f  athlib.Path(tmp_
-00017490: 736f 7572 6365 2920 2f20 2763 6972 636c  source) / 'circl
-000174a0: 652d 6c69 6e6b 2729 2e69 735f 7379 6d6c  e-link').is_syml
-000174b0: 696e 6b28 292c 2028 0a20 2020 2020 2020  ink(), (.       
-000174c0: 2020 2020 2027 6369 7263 6c65 2d6c 696e       'circle-lin
-000174d0: 6b20 7761 7320 6e6f 7420 666f 756e 6420  k was not found 
-000174e0: 696e 2074 6865 2075 706c 6f61 6420 736f  in the upload so
-000174f0: 7572 6365 202d 2027 0a20 2020 2020 2020  urce - '.       
-00017500: 2020 2020 2027 6172 6520 7468 6520 7465       'are the te
-00017510: 7374 2066 6978 7475 7265 7320 636f 7272  st fixtures corr
-00017520: 6563 743f 2729 0a20 2020 2020 2020 2061  ect?').        a
-00017530: 7373 6572 7420 2763 6972 636c 652d 6c69  ssert 'circle-li
-00017540: 6e6b 2720 6e6f 7420 696e 206f 7574 2e64  nk' not in out.d
-00017550: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
-00017560: 280a 2020 2020 2020 2020 2020 2020 2753  (.            'S
-00017570: 796d 6c69 6e6b 2066 6f75 6e64 2069 6e20  ymlink found in 
-00017580: 6275 636b 6574 202d 206c 7320 6f75 7470  bucket - ls outp
-00017590: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
-000175a0: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
-000175b0: 2020 2020 206f 7574 2e64 6563 6f64 6528       out.decode(
-000175c0: 2775 7466 2d38 2729 2929 0a0a 2020 2020  'utf-8')))..    
-000175d0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
-000175e0: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
-000175f0: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
-00017600: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
-00017610: 6520 6f75 7470 7574 2e0a 2020 2020 2020  e output..      
-00017620: 2020 2320 4974 2073 686f 756c 6420 6e6f    # It should no
-00017630: 7420 6578 6973 7420 6265 6361 7573 6520  t exist because 
-00017640: 7468 6520 6275 636b 6574 2077 6173 2063  the bucket was c
-00017650: 7265 6174 6564 2065 7874 6572 6e61 6c6c  reated externall
-00017660: 792e 0a20 2020 2020 2020 206f 7574 203d  y..        out =
-00017670: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00017680: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-00017690: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-000176a0: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
-000176b0: 7420 7374 6f72 6167 655f 6f62 6a2e 6e61  t storage_obj.na
-000176c0: 6d65 206e 6f74 2069 6e20 6f75 742e 6465  me not in out.de
-000176d0: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
-000176e0: 2020 2064 6566 2074 6573 745f 636f 7079     def test_copy
-000176f0: 5f6d 6f75 6e74 5f65 7869 7374 696e 675f  _mount_existing_
-00017700: 7374 6f72 6167 6528 7365 6c66 2c0a 2020  storage(self,.  
-00017710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017730: 2020 2020 2020 2074 6d70 5f63 6f70 795f         tmp_copy_
-00017740: 6d6e 745f 6578 6973 7469 6e67 5f73 746f  mnt_existing_sto
-00017750: 7261 6765 5f6f 626a 293a 0a20 2020 2020  rage_obj):.     
-00017760: 2020 2023 2043 7265 6174 6573 2061 2062     # Creates a b
-00017770: 7563 6b65 7420 7769 7468 206e 6f20 736f  ucket with no so
-00017780: 7572 6365 2069 6e20 4d4f 554e 5420 6d6f  urce in MOUNT mo
-00017790: 6465 2028 656d 7074 7920 6275 636b 6574  de (empty bucket
-000177a0: 292c 2061 6e64 0a20 2020 2020 2020 2023  ), and.        #
-000177b0: 2074 6865 6e20 7472 6965 7320 746f 206c   then tries to l
-000177c0: 6f61 6420 7468 6520 7361 6d65 2073 746f  oad the same sto
-000177d0: 7261 6765 2069 6e20 434f 5059 206d 6f64  rage in COPY mod
-000177e0: 652e 0a20 2020 2020 2020 2074 6d70 5f63  e..        tmp_c
-000177f0: 6f70 795f 6d6e 745f 6578 6973 7469 6e67  opy_mnt_existing
-00017800: 5f73 746f 7261 6765 5f6f 626a 2e61 6464  _storage_obj.add
-00017810: 5f73 746f 7265 2873 746f 7261 6765 5f6c  _store(storage_l
-00017820: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-00017830: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
-00017840: 5f6e 616d 6520 3d20 746d 705f 636f 7079  _name = tmp_copy
-00017850: 5f6d 6e74 5f65 7869 7374 696e 675f 7374  _mnt_existing_st
-00017860: 6f72 6167 655f 6f62 6a2e 6e61 6d65 0a0a  orage_obj.name..
-00017870: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00017880: 6073 6b79 2073 746f 7261 6765 206c 7360  `sky storage ls`
-00017890: 2074 6f20 656e 7375 7265 2073 746f 7261   to ensure stora
-000178a0: 6765 206f 626a 6563 7420 6578 6973 7473  ge object exists
-000178b0: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-000178c0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-000178d0: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-000178e0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-000178f0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00017900: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00017910: 7374 6f72 6167 655f 6e61 6d65 2069 6e20  storage_name in 
-00017920: 6f75 742c 2066 2753 746f 7261 6765 207b  out, f'Storage {
-00017930: 7374 6f72 6167 655f 6e61 6d65 7d20 6e6f  storage_name} no
-00017940: 7420 666f 756e 6420 696e 2073 6b79 2073  t found in sky s
-00017950: 746f 7261 6765 206c 732e 270a 0a20 2020  torage ls.'..   
-00017960: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-00017970: 7261 6d65 7472 697a 6528 2773 746f 7265  rametrize('store
-00017980: 5f74 7970 6527 2c20 5b0a 2020 2020 2020  _type', [.      
-00017990: 2020 7374 6f72 6167 655f 6c69 622e 5374    storage_lib.St
-000179a0: 6f72 6554 7970 652e 5333 2c20 7374 6f72  oreType.S3, stor
-000179b0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-000179c0: 652e 4743 532c 0a20 2020 2020 2020 2070  e.GCS,.        p
-000179d0: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
-000179e0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-000179f0: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
-00017a00: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
-00017a10: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
-00017a20: 6566 2074 6573 745f 6c69 7374 5f73 6f75  ef test_list_sou
-00017a30: 7263 6528 7365 6c66 2c20 746d 705f 6c6f  rce(self, tmp_lo
-00017a40: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
-00017a50: 5f6f 626a 2c20 7374 6f72 655f 7479 7065  _obj, store_type
-00017a60: 293a 0a20 2020 2020 2020 2023 2055 7365  ):.        # Use
-00017a70: 7320 6120 6c69 7374 2069 6e20 7468 6520  s a list in the 
-00017a80: 736f 7572 6365 2066 6965 6c64 2074 6f20  source field to 
-00017a90: 7370 6563 6966 7920 6120 6669 6c65 2061  specify a file a
-00017aa0: 6e64 2061 2064 6972 6563 746f 7279 2074  nd a directory t
-00017ab0: 6f0a 2020 2020 2020 2020 2320 6265 2075  o.        # be u
-00017ac0: 706c 6f61 6465 6420 746f 2074 6865 2073  ploaded to the s
-00017ad0: 746f 7261 6765 206f 626a 6563 742e 0a20  torage object.. 
-00017ae0: 2020 2020 2020 2074 6d70 5f6c 6f63 616c         tmp_local
-00017af0: 5f6c 6973 745f 7374 6f72 6167 655f 6f62  _list_storage_ob
-00017b00: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
-00017b10: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
-00017b20: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
-00017b30: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
-00017b40: 6865 2062 7563 6b65 7420 726f 6f74 2075  he bucket root u
-00017b50: 7369 6e67 2063 6c69 0a20 2020 2020 2020  sing cli.       
-00017b60: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
-00017b70: 732e 6368 6563 6b5f 6f75 7470 7574 2873  s.check_output(s
-00017b80: 656c 662e 636c 695f 6c73 5f63 6d64 280a  elf.cli_ls_cmd(.
-00017b90: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00017ba0: 655f 7479 7065 2c20 746d 705f 6c6f 6361  e_type, tmp_loca
-00017bb0: 6c5f 6c69 7374 5f73 746f 7261 6765 5f6f  l_list_storage_o
-00017bc0: 626a 2e6e 616d 6529 2c0a 2020 2020 2020  bj.name),.      
-00017bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017bf0: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-00017c00: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
-00017c10: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
-00017c20: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
-00017c30: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
-00017c40: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
-00017c50: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
-00017c60: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
-00017c70: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
-00017c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cb0: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
-00017cc0: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
-00017cd0: 2043 6865 636b 2069 6620 746d 702d 6669   Check if tmp-fi
-00017ce0: 6c65 2065 7869 7374 7320 696e 2074 6865  le exists in the
-00017cf0: 2062 7563 6b65 742f 746d 702d 736f 7572   bucket/tmp-sour
-00017d00: 6365 2075 7369 6e67 2063 6c69 0a20 2020  ce using cli.   
-00017d10: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00017d20: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00017d30: 7574 2873 656c 662e 636c 695f 6c73 5f63  ut(self.cli_ls_c
-00017d40: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
-00017d50: 7374 6f72 655f 7479 7065 2c20 746d 705f  store_type, tmp_
-00017d60: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
-00017d70: 6765 5f6f 626a 2e6e 616d 652c 2027 746d  ge_obj.name, 'tm
-00017d80: 702d 736f 7572 6365 2f27 292c 0a20 2020  p-source/'),.   
-00017d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017db0: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-00017dc0: 2020 2020 2020 2061 7373 6572 7420 2774         assert 't
-00017dd0: 6d70 2d66 696c 6527 2069 6e20 6f75 742e  mp-file' in out.
-00017de0: 6465 636f 6465 2827 7574 662d 3827 292c  decode('utf-8'),
-00017df0: 205c 0a20 2020 2020 2020 2020 2020 2027   \.            '
-00017e00: 4669 6c65 206e 6f74 2066 6f75 6e64 2069  File not found i
-00017e10: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
-00017e20: 7420 7761 7320 3a20 7b7d 272e 666f 726d  t was : {}'.form
-00017e30: 6174 286f 7574 2e64 6563 6f64 650a 2020  at(out.decode.  
-00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e70: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00017e80: 7574 662d 3827 2929 0a0a 2020 2020 4070  utf-8'))..    @p
-00017e90: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-00017ea0: 6574 7269 7a65 2827 696e 7661 6c69 645f  etrize('invalid_
-00017eb0: 6e61 6d65 5f6c 6973 742c 2073 746f 7265  name_list, store
-00017ec0: 5f74 7970 6527 2c0a 2020 2020 2020 2020  _type',.        
-00017ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ee0: 2020 2020 205b 2841 5753 5f49 4e56 414c       [(AWS_INVAL
-00017ef0: 4944 5f4e 414d 4553 2c20 7374 6f72 6167  ID_NAMES, storag
-00017f00: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00017f10: 5333 292c 0a20 2020 2020 2020 2020 2020  S3),.           
-00017f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f30: 2020 2028 4743 535f 494e 5641 4c49 445f     (GCS_INVALID_
-00017f40: 4e41 4d45 532c 2073 746f 7261 6765 5f6c  NAMES, storage_l
-00017f50: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
-00017f60: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f80: 2070 7974 6573 742e 7061 7261 6d28 4157   pytest.param(AW
-00017f90: 535f 494e 5641 4c49 445f 4e41 4d45 532c  S_INVALID_NAMES,
-00017fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fc0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00017fd0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00017fe0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
-00017ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018010: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-00018020: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
-00018030: 0a20 2020 2064 6566 2074 6573 745f 696e  .    def test_in
-00018040: 7661 6c69 645f 6e61 6d65 7328 7365 6c66  valid_names(self
-00018050: 2c20 696e 7661 6c69 645f 6e61 6d65 5f6c  , invalid_name_l
-00018060: 6973 742c 2073 746f 7265 5f74 7970 6529  ist, store_type)
-00018070: 3a0a 2020 2020 2020 2020 2320 5573 6573  :.        # Uses
-00018080: 2061 206c 6973 7420 696e 2074 6865 2073   a list in the s
-00018090: 6f75 7263 6520 6669 656c 6420 746f 2073  ource field to s
-000180a0: 7065 6369 6679 2061 2066 696c 6520 616e  pecify a file an
-000180b0: 6420 6120 6469 7265 6374 6f72 7920 746f  d a directory to
-000180c0: 0a20 2020 2020 2020 2023 2062 6520 7570  .        # be up
-000180d0: 6c6f 6164 6564 2074 6f20 7468 6520 7374  loaded to the st
-000180e0: 6f72 6167 6520 6f62 6a65 6374 2e0a 2020  orage object..  
-000180f0: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
-00018100: 6e20 696e 7661 6c69 645f 6e61 6d65 5f6c  n invalid_name_l
-00018110: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-00018120: 2077 6974 6820 7079 7465 7374 2e72 6169   with pytest.rai
-00018130: 7365 7328 736b 792e 6578 6365 7074 696f  ses(sky.exceptio
-00018140: 6e73 2e53 746f 7261 6765 4e61 6d65 4572  ns.StorageNameEr
-00018150: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-00018160: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
-00018170: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
-00018180: 5374 6f72 6167 6528 6e61 6d65 3d6e 616d  Storage(name=nam
-00018190: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000181a0: 2020 2073 746f 7261 6765 5f6f 626a 2e61     storage_obj.a
-000181b0: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-000181c0: 7970 6529 0a0a 0a23 202d 2d2d 2d2d 2d2d  ype)...# -------
-000181d0: 2d2d 2d20 5465 7374 696e 6720 5941 4d4c  --- Testing YAML
-000181e0: 2053 7065 6373 202d 2d2d 2d2d 2d2d 2d2d   Specs ---------
-000181f0: 2d0a 2320 4f75 7220 736b 7920 7374 6f72  -.# Our sky stor
-00018200: 6167 6520 7265 7175 6972 6573 2063 7265  age requires cre
-00018210: 6465 6e74 6961 6c73 2074 6f20 6368 6563  dentials to chec
-00018220: 6b20 7468 6520 6275 636b 6574 2065 7869  k the bucket exi
-00018230: 7374 616e 6365 2077 6865 6e0a 2320 6c6f  stance when.# lo
-00018240: 6164 696e 6720 6120 7461 736b 2066 726f  ading a task fro
-00018250: 6d20 7468 6520 7961 6d6c 2066 696c 652c  m the yaml file,
-00018260: 2073 6f20 7765 2063 616e 6e6f 7420 6d61   so we cannot ma
-00018270: 6b65 2069 7420 6120 756e 6974 2074 6573  ke it a unit tes
-00018280: 742e 0a63 6c61 7373 2054 6573 7459 616d  t..class TestYam
-00018290: 6c53 7065 6373 3a0a 2020 2020 2320 544f  lSpecs:.    # TO
-000182a0: 444f 287a 6877 7529 3a20 4164 6420 7465  DO(zhwu): Add te
-000182b0: 7374 2066 6f72 2060 746f 5f79 616d 6c5f  st for `to_yaml_
-000182c0: 636f 6e66 6967 6020 666f 7220 7468 6520  config` for the 
-000182d0: 5374 6f72 6167 6520 6f62 6a65 6374 2e0a  Storage object..
-000182e0: 2020 2020 2320 2057 6520 7368 6f75 6c64      #  We should
-000182f0: 206e 6f74 2075 7365 2060 6578 616d 706c   not use `exampl
-00018300: 6573 2f73 746f 7261 6765 5f64 656d 6f2e  es/storage_demo.
-00018310: 7961 6d6c 6020 6865 7265 2c20 7369 6e63  yaml` here, sinc
-00018320: 6520 6974 2072 6571 7569 7265 730a 2020  e it requires.  
-00018330: 2020 2320 2075 7365 7273 2074 6f20 656e    #  users to en
-00018340: 7375 7265 2062 7563 6b65 7420 6e61 6d65  sure bucket name
-00018350: 7320 746f 206e 6f74 2065 7869 7374 2061  s to not exist a
-00018360: 6e64 2f6f 7220 6265 2075 6e69 7175 652e  nd/or be unique.
-00018370: 0a20 2020 205f 5445 5354 5f59 414d 4c5f  .    _TEST_YAML_
-00018380: 5041 5448 5320 3d20 5b0a 2020 2020 2020  PATHS = [.      
-00018390: 2020 2765 7861 6d70 6c65 732f 6d69 6e69    'examples/mini
-000183a0: 6d61 6c2e 7961 6d6c 272c 2027 6578 616d  mal.yaml', 'exam
-000183b0: 706c 6573 2f6d 616e 6167 6564 5f73 706f  ples/managed_spo
-000183c0: 742e 7961 6d6c 272c 0a20 2020 2020 2020  t.yaml',.       
-000183d0: 2027 6578 616d 706c 6573 2f75 7369 6e67   'examples/using
-000183e0: 5f66 696c 655f 6d6f 756e 7473 2e79 616d  _file_mounts.yam
-000183f0: 6c27 2c20 2765 7861 6d70 6c65 732f 7265  l', 'examples/re
-00018400: 736e 6574 5f61 7070 2e79 616d 6c27 2c0a  snet_app.yaml',.
-00018410: 2020 2020 2020 2020 2765 7861 6d70 6c65          'example
-00018420: 732f 6d75 6c74 695f 686f 7374 6e61 6d65  s/multi_hostname
-00018430: 2e79 616d 6c27 0a20 2020 205d 0a0a 2020  .yaml'.    ]..  
-00018440: 2020 6465 6620 5f69 735f 6469 6374 5f73    def _is_dict_s
-00018450: 7562 7365 7428 7365 6c66 2c20 6431 2c20  ubset(self, d1, 
-00018460: 6432 293a 0a20 2020 2020 2020 2022 2222  d2):.        """
-00018470: 4368 6563 6b20 6966 2064 3120 6973 2074  Check if d1 is t
-00018480: 6865 2073 7562 7365 7420 6f66 2064 322e  he subset of d2.
-00018490: 2222 220a 2020 2020 2020 2020 666f 7220  """.        for 
-000184a0: 6b2c 2076 2069 6e20 6431 2e69 7465 6d73  k, v in d1.items
-000184b0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000184c0: 6966 206b 206e 6f74 2069 6e20 6432 3a0a  if k not in d2:.
-000184d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184e0: 6966 2069 7369 6e73 7461 6e63 6528 762c  if isinstance(v,
-000184f0: 206c 6973 7429 206f 7220 6973 696e 7374   list) or isinst
-00018500: 616e 6365 2876 2c20 6469 6374 293a 0a20  ance(v, dict):. 
-00018510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018520: 2020 2061 7373 6572 7420 6c65 6e28 7629     assert len(v)
-00018530: 203d 3d20 302c 2028 6b2c 2076 290a 2020   == 0, (k, v).  
-00018540: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00018550: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00018560: 2020 2020 2020 2020 6173 7365 7274 2046          assert F
-00018570: 616c 7365 2c20 286b 2c20 7629 0a20 2020  alse, (k, v).   
-00018580: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00018590: 696e 7374 616e 6365 2876 2c20 6469 6374  instance(v, dict
-000185a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000185b0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-000185c0: 616e 6365 2864 325b 6b5d 2c20 6469 6374  ance(d2[k], dict
-000185d0: 292c 2028 6b2c 2076 2c20 6432 290a 2020  ), (k, v, d2).  
-000185e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000185f0: 6c66 2e5f 6973 5f64 6963 745f 7375 6273  lf._is_dict_subs
-00018600: 6574 2876 2c20 6432 5b6b 5d29 0a20 2020  et(v, d2[k]).   
-00018610: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00018620: 696e 7374 616e 6365 2876 2c20 7374 7229  instance(v, str)
-00018630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018640: 2020 6966 206b 203d 3d20 2761 6363 656c    if k == 'accel
-00018650: 6572 6174 6f72 7327 3a0a 2020 2020 2020  erators':.      
-00018660: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00018670: 736f 7572 6365 7320 3d20 736b 792e 5265  sources = sky.Re
-00018680: 736f 7572 6365 7328 290a 2020 2020 2020  sources().      
-00018690: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000186a0: 736f 7572 6365 732e 5f73 6574 5f61 6363  sources._set_acc
-000186b0: 656c 6572 6174 6f72 7328 762c 204e 6f6e  elerators(v, Non
-000186c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000186d0: 2020 2020 2020 2061 7373 6572 7420 7265         assert re
-000186e0: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
-000186f0: 746f 7273 203d 3d20 6432 5b6b 5d2c 2028  tors == d2[k], (
-00018700: 6b2c 2076 2c20 6432 290a 2020 2020 2020  k, v, d2).      
-00018710: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018730: 2020 2020 6173 7365 7274 2076 2e6c 6f77      assert v.low
-00018740: 6572 2829 203d 3d20 6432 5b6b 5d2e 6c6f  er() == d2[k].lo
-00018750: 7765 7228 292c 2028 6b2c 2076 2c20 6432  wer(), (k, v, d2
-00018760: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
-00018770: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00018780: 2020 2020 2020 2061 7373 6572 7420 7620         assert v 
-00018790: 3d3d 2064 325b 6b5d 2c20 286b 2c20 762c  == d2[k], (k, v,
-000187a0: 2064 325b 6b5d 290a 0a20 2020 2064 6566   d2[k])..    def
-000187b0: 205f 6368 6563 6b5f 6571 7569 7661 6c65   _check_equivale
-000187c0: 6e74 2873 656c 662c 2079 616d 6c5f 7061  nt(self, yaml_pa
-000187d0: 7468 293a 0a20 2020 2020 2020 2022 2222  th):.        """
-000187e0: 4368 6563 6b20 6966 2074 6865 2079 616d  Check if the yam
-000187f0: 6c20 6973 2065 7175 6976 616c 656e 7420  l is equivalent 
-00018800: 6166 7465 7220 6c6f 6164 2061 6e64 2064  after load and d
-00018810: 756d 7020 6167 6169 6e2e 2222 220a 2020  ump again.""".  
-00018820: 2020 2020 2020 6f72 6967 696e 5f74 6173        origin_tas
-00018830: 6b5f 636f 6e66 6967 203d 2063 6f6d 6d6f  k_config = commo
-00018840: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
-00018850: 6c28 7961 6d6c 5f70 6174 6829 0a0a 2020  l(yaml_path)..  
-00018860: 2020 2020 2020 7461 736b 203d 2073 6b79        task = sky
-00018870: 2e54 6173 6b2e 6672 6f6d 5f79 616d 6c28  .Task.from_yaml(
-00018880: 7961 6d6c 5f70 6174 6829 0a20 2020 2020  yaml_path).     
-00018890: 2020 206e 6577 5f74 6173 6b5f 636f 6e66     new_task_conf
-000188a0: 6967 203d 2074 6173 6b2e 746f 5f79 616d  ig = task.to_yam
-000188b0: 6c5f 636f 6e66 6967 2829 0a20 2020 2020  l_config().     
-000188c0: 2020 2023 2064 3120 3c3d 2064 320a 2020     # d1 <= d2.  
-000188d0: 2020 2020 2020 7365 6c66 2e5f 6973 5f64        self._is_d
-000188e0: 6963 745f 7375 6273 6574 286f 7269 6769  ict_subset(origi
-000188f0: 6e5f 7461 736b 5f63 6f6e 6669 672c 206e  n_task_config, n
-00018900: 6577 5f74 6173 6b5f 636f 6e66 6967 290a  ew_task_config).
-00018910: 0a20 2020 2064 6566 2074 6573 745f 6c6f  .    def test_lo
-00018920: 6164 5f64 756d 705f 7961 6d6c 5f63 6f6e  ad_dump_yaml_con
-00018930: 6669 675f 6571 7569 7661 6c65 6e74 2873  fig_equivalent(s
-00018940: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00018950: 2254 6573 7420 6966 2074 6865 2079 616d  "Test if the yam
-00018960: 6c20 636f 6e66 6967 2069 7320 6571 7569  l config is equi
-00018970: 7661 6c65 6e74 2061 6674 6572 206c 6f61  valent after loa
-00018980: 6420 616e 6420 6475 6d70 2061 6761 696e  d and dump again
-00018990: 2e22 2222 0a20 2020 2020 2020 2070 6174  .""".        pat
-000189a0: 686c 6962 2e50 6174 6828 277e 2f64 6174  hlib.Path('~/dat
-000189b0: 6173 6574 7327 292e 6578 7061 6e64 7573  asets').expandus
-000189c0: 6572 2829 2e6d 6b64 6972 2865 7869 7374  er().mkdir(exist
-000189d0: 5f6f 6b3d 5472 7565 290a 2020 2020 2020  _ok=True).      
-000189e0: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
-000189f0: 7e2f 746d 7066 696c 6527 292e 6578 7061  ~/tmpfile').expa
-00018a00: 6e64 7573 6572 2829 2e74 6f75 6368 2829  nduser().touch()
-00018a10: 0a20 2020 2020 2020 2070 6174 686c 6962  .        pathlib
-00018a20: 2e50 6174 6828 277e 2f2e 7373 6827 292e  .Path('~/.ssh').
-00018a30: 6578 7061 6e64 7573 6572 2829 2e6d 6b64  expanduser().mkd
-00018a40: 6972 2865 7869 7374 5f6f 6b3d 5472 7565  ir(exist_ok=True
-00018a50: 290a 2020 2020 2020 2020 7061 7468 6c69  ).        pathli
-00018a60: 622e 5061 7468 2827 7e2f 2e73 7368 2f69  b.Path('~/.ssh/i
-00018a70: 645f 7273 612e 7075 6227 292e 6578 7061  d_rsa.pub').expa
-00018a80: 6e64 7573 6572 2829 2e74 6f75 6368 2829  nduser().touch()
-00018a90: 0a20 2020 2020 2020 2070 6174 686c 6962  .        pathlib
-00018aa0: 2e50 6174 6828 277e 2f74 6d70 2d77 6f72  .Path('~/tmp-wor
-00018ab0: 6b64 6972 2729 2e65 7870 616e 6475 7365  kdir').expanduse
-00018ac0: 7228 292e 6d6b 6469 7228 6578 6973 745f  r().mkdir(exist_
-00018ad0: 6f6b 3d54 7275 6529 0a20 2020 2020 2020  ok=True).       
-00018ae0: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
-00018af0: 2f44 6f77 6e6c 6f61 6473 2f74 7075 2729  /Downloads/tpu')
-00018b00: 2e65 7870 616e 6475 7365 7228 292e 6d6b  .expanduser().mk
-00018b10: 6469 7228 7061 7265 6e74 733d 5472 7565  dir(parents=True
-00018b20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b50: 2020 2020 2020 2020 2020 2020 2065 7869               exi
-00018b60: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
-00018b70: 2020 2020 666f 7220 7961 6d6c 5f70 6174      for yaml_pat
-00018b80: 6820 696e 2073 656c 662e 5f54 4553 545f  h in self._TEST_
-00018b90: 5941 4d4c 5f50 4154 4853 3a0a 2020 2020  YAML_PATHS:.    
-00018ba0: 2020 2020 2020 2020 7365 6c66 2e5f 6368          self._ch
-00018bb0: 6563 6b5f 6571 7569 7661 6c65 6e74 2879  eck_equivalent(y
-00018bc0: 616d 6c5f 7061 7468 290a                 aml_path).
+00016fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fd0: 2020 2020 7370 6563 735b 2764 6973 6b5f      specs['disk_
+00016fe0: 7468 726f 7567 6870 7574 275d 2929 292c  throughput']))),
+00016ff0: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+00017000: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017010: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00017020: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+00017030: 696d 656f 7574 3d31 3020 2a20 3630 2c20  imeout=10 * 60, 
+00017040: 2023 2031 3020 6d69 6e73 2020 2869 7420   # 10 mins  (it 
+00017050: 7461 6b65 7320 6172 6f75 6e64 207e 3620  takes around ~6 
+00017060: 6d69 6e73 290a 2020 2020 2020 2020 290a  mins).        ).
+00017070: 2020 2020 2020 2020 7275 6e5f 6f6e 655f          run_one_
+00017080: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00017090: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
+000170a0: 6620 7465 7374 5f67 6370 5f64 6973 6b5f  f test_gcp_disk_
+000170b0: 7469 6572 2829 3a0a 2020 2020 666f 7220  tier():.    for 
+000170c0: 6469 736b 5f74 6965 7220 696e 205b 276c  disk_tier in ['l
+000170d0: 6f77 272c 2027 6d65 6469 756d 272c 2027  ow', 'medium', '
+000170e0: 6869 6768 275d 3a0a 2020 2020 2020 2020  high']:.        
+000170f0: 7479 7065 203d 2047 4350 2e5f 6765 745f  type = GCP._get_
+00017100: 6469 736b 5f74 7970 6528 6469 736b 5f74  disk_type(disk_t
+00017110: 6965 7229 0a20 2020 2020 2020 206e 616d  ier).        nam
+00017120: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00017130: 5f6e 616d 6528 2920 2b20 272d 2720 2b20  _name() + '-' + 
+00017140: 6469 736b 5f74 6965 720a 2020 2020 2020  disk_tier.      
+00017150: 2020 7265 6769 6f6e 203d 2027 7573 2d77    region = 'us-w
+00017160: 6573 7432 270a 2020 2020 2020 2020 7465  est2'.        te
+00017170: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00017180: 2020 2020 2020 2027 6763 702d 6469 736b         'gcp-disk
+00017190: 2d74 6965 7227 2c0a 2020 2020 2020 2020  -tier',.        
+000171a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+000171b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+000171c0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+000171d0: 2d2d 636c 6f75 6420 6763 7020 2d2d 7265  --cloud gcp --re
+000171e0: 6769 6f6e 207b 7265 6769 6f6e 7d20 270a  gion {region} '.
+000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017200: 6627 2d2d 6469 736b 2d74 6965 7220 7b64  f'--disk-tier {d
+00017210: 6973 6b5f 7469 6572 7d20 6563 686f 2022  isk_tier} echo "
+00017220: 6865 6c6c 6f20 736b 7922 272c 0a20 2020  hello sky"',.   
+00017230: 2020 2020 2020 2020 2020 2020 2066 276e               f'n
+00017240: 616d 653d 6067 636c 6f75 6420 636f 6d70  ame=`gcloud comp
+00017250: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
+00017260: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
+00017270: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00017280: 226c 6162 656c 732e 7261 792d 636c 7573  "labels.ray-clus
+00017290: 7465 722d 6e61 6d65 3a7b 6e61 6d65 7d22  ter-name:{name}"
+000172a0: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
+000172b0: 286e 616d 6529 2260 3b20 270a 2020 2020  (name)"`; '.    
+000172c0: 2020 2020 2020 2020 2020 2020 6627 6763              f'gc
+000172d0: 6c6f 7564 2063 6f6d 7075 7465 2064 6973  loud compute dis
+000172e0: 6b73 206c 6973 7420 2d2d 6669 6c74 6572  ks list --filter
+000172f0: 3d22 6e61 6d65 3d24 6e61 6d65 2220 270a  ="name=$name" '.
+00017300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017310: 6627 2d2d 666f 726d 6174 3d22 7661 6c75  f'--format="valu
+00017320: 6528 7479 7065 2922 207c 2067 7265 7020  e(type)" | grep 
+00017330: 7b74 7970 657d 2027 0a20 2020 2020 2020  {type} '.       
+00017340: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00017350: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00017360: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00017370: 2020 2020 2020 2074 696d 656f 7574 3d36         timeout=6
+00017380: 202a 2036 302c 2020 2320 3620 6d69 6e73   * 60,  # 6 mins
+00017390: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
+000173a0: 6e64 207e 3320 6d69 6e73 290a 2020 2020  nd ~3 mins).    
+000173b0: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+000173c0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000173d0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000173e0: 617a 7572 650a 6465 6620 7465 7374 5f61  azure.def test_a
+000173f0: 7a75 7265 5f64 6973 6b5f 7469 6572 2829  zure_disk_tier()
+00017400: 3a0a 2020 2020 666f 7220 6469 736b 5f74  :.    for disk_t
+00017410: 6965 7220 696e 205b 276c 6f77 272c 2027  ier in ['low', '
+00017420: 6d65 6469 756d 275d 3a0a 2020 2020 2020  medium']:.      
+00017430: 2020 7479 7065 203d 2041 7a75 7265 2e5f    type = Azure._
+00017440: 6765 745f 6469 736b 5f74 7970 6528 6469  get_disk_type(di
+00017450: 736b 5f74 6965 7229 0a20 2020 2020 2020  sk_tier).       
+00017460: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00017470: 7374 6572 5f6e 616d 6528 2920 2b20 272d  ster_name() + '-
+00017480: 2720 2b20 6469 736b 5f74 6965 720a 2020  ' + disk_tier.  
+00017490: 2020 2020 2020 7265 6769 6f6e 203d 2027        region = '
+000174a0: 7765 7374 7573 3227 0a20 2020 2020 2020  westus2'.       
+000174b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000174c0: 2020 2020 2020 2020 2020 2761 7a75 7265            'azure
+000174d0: 2d64 6973 6b2d 7469 6572 272c 0a20 2020  -disk-tier',.   
+000174e0: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+000174f0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00017500: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00017510: 616d 657d 202d 2d63 6c6f 7564 2061 7a75  ame} --cloud azu
+00017520: 7265 202d 2d72 6567 696f 6e20 7b72 6567  re --region {reg
+00017530: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
+00017540: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
+00017550: 7469 6572 207b 6469 736b 5f74 6965 727d  tier {disk_tier}
+00017560: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
+00017570: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017580: 2020 2020 6627 617a 2072 6573 6f75 7263      f'az resourc
+00017590: 6520 6c69 7374 202d 2d74 6167 2072 6179  e list --tag ray
+000175a0: 2d63 6c75 7374 6572 2d6e 616d 653d 7b6e  -cluster-name={n
+000175b0: 616d 657d 202d 2d71 7565 7279 2027 0a20  ame} --query '. 
+000175c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000175d0: 2722 5b3f 7479 7065 3d3d 5c27 4d69 6372  '"[?type==\'Micr
+000175e0: 6f73 6f66 742e 436f 6d70 7574 652f 6469  osoft.Compute/di
+000175f0: 736b 735c 275d 2e73 6b75 2e6e 616d 6522  sks\'].sku.name"
+00017600: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00017610: 2020 2066 272d 2d6f 7574 7075 7420 7473     f'--output ts
+00017620: 7620 7c20 6772 6570 207b 7479 7065 7d27  v | grep {type}'
+00017630: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+00017640: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017650: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00017660: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
+00017670: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
+00017680: 2023 2032 3020 6d69 6e73 2020 2869 7420   # 20 mins  (it 
+00017690: 7461 6b65 7320 6172 6f75 6e64 207e 3132  takes around ~12
+000176a0: 206d 696e 7329 0a20 2020 2020 2020 2029   mins).        )
+000176b0: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+000176c0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+000176d0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 205a  ------ Testing Z
+000176e0: 6572 6f20 5175 6f74 6120 4661 696c 6f76  ero Quota Failov
+000176f0: 6572 202d 2d2d 2d2d 2d0a 4070 7974 6573  er ------.@pytes
+00017700: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
+00017710: 6573 745f 6177 735f 7a65 726f 5f71 756f  est_aws_zero_quo
+00017720: 7461 5f66 6169 6c6f 7665 7228 293a 0a0a  ta_failover():..
+00017730: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00017740: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00017750: 2020 2072 6567 696f 6e20 3d20 6765 745f     region = get_
+00017760: 6177 735f 7265 6769 6f6e 5f66 6f72 5f71  aws_region_for_q
+00017770: 756f 7461 5f66 6169 6c6f 7665 7228 290a  uota_failover().
+00017780: 0a20 2020 2069 6620 6e6f 7420 7265 6769  .    if not regi
+00017790: 6f6e 3a0a 2020 2020 2020 2020 7265 7475  on:.        retu
+000177a0: 726e 0a0a 2020 2020 7465 7374 203d 2054  rn..    test = T
+000177b0: 6573 7428 0a20 2020 2020 2020 2027 6177  est(.        'aw
+000177c0: 732d 7a65 726f 2d71 756f 7461 2d66 6169  s-zero-quota-fai
+000177d0: 6c6f 7665 7227 2c0a 2020 2020 2020 2020  lover',.        
+000177e0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000177f0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00017800: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00017810: 6177 7320 2d2d 7265 6769 6f6e 207b 7265  aws --region {re
+00017820: 6769 6f6e 7d20 2d2d 6770 7573 2056 3130  gion} --gpus V10
+00017830: 303a 3820 2d2d 7573 652d 7370 6f74 207c  0:8 --use-spot |
+00017840: 2067 7265 7020 2246 6f75 6e64 206e 6f20   grep "Found no 
+00017850: 7175 6f74 6122 272c 0a20 2020 2020 2020  quota"',.       
+00017860: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00017870: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00017880: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00017890: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000178a0: 0a0a 2320 2d2d 2d2d 2d2d 2d20 5465 7374  ..# ------- Test
+000178b0: 696e 6720 7573 6572 2072 6179 2063 6c75  ing user ray clu
+000178c0: 7374 6572 202d 2d2d 2d2d 2d2d 2d0a 6465  ster --------.de
+000178d0: 6620 7465 7374 5f75 7365 725f 7261 795f  f test_user_ray_
+000178e0: 636c 7573 7465 7228 293a 0a20 2020 206e  cluster():.    n
+000178f0: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00017900: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00017910: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00017920: 2020 2027 7573 6572 2d72 6179 2d63 6c75     'user-ray-clu
+00017930: 7374 6572 272c 0a20 2020 2020 2020 205b  ster',.        [
+00017940: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00017950: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00017960: 7b6e 616d 657d 2022 7261 7920 7374 6172  {name} "ray star
+00017970: 7420 2d2d 6865 6164 2227 2c0a 2020 2020  t --head"',.    
+00017980: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00017990: 6563 207b 6e61 6d65 7d20 2265 6368 6f20  ec {name} "echo 
+000179a0: 6869 2227 2c0a 2020 2020 2020 2020 2020  hi"',.          
+000179b0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000179c0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000179d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000179e0: 6b79 2073 7461 7475 7320 2d72 207c 2067  ky status -r | g
+000179f0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00017a00: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
+00017a10: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00017a20: 616d 657d 2022 6563 686f 2062 7965 2227  ame} "echo bye"'
+00017a30: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00017a40: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00017a50: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00017a60: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00017a70: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00017a80: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00017a90: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00017aa0: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d20  st)...# ------- 
+00017ab0: 5465 7374 696e 6720 7468 6520 636f 7265  Testing the core
+00017ac0: 2041 5049 202d 2d2d 2d2d 2d2d 2d0a 2320   API --------.# 
+00017ad0: 4d6f 7374 206f 6620 7468 6520 636f 7265  Most of the core
+00017ae0: 2041 5049 7320 6861 7665 2062 6565 6e20   APIs have been 
+00017af0: 7465 7374 6564 2069 6e20 7468 6520 434c  tested in the CL
+00017b00: 4920 7465 7374 732e 0a23 2054 6865 7365  I tests..# These
+00017b10: 2074 6573 7473 2061 7265 2066 6f72 2074   tests are for t
+00017b20: 6573 7469 6e67 2074 6865 2072 6574 7572  esting the retur
+00017b30: 6e20 7661 6c75 6520 6f66 2074 6865 2041  n value of the A
+00017b40: 5049 7320 6e6f 7420 6675 6c6c 7920 7573  PIs not fully us
+00017b50: 6564 2069 6e20 434c 492e 0a64 6566 2074  ed in CLI..def t
+00017b60: 6573 745f 636f 7265 5f61 7069 2829 3a0a  est_core_api():.
+00017b70: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00017b80: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00017b90: 2020 2073 6b79 2e6c 6175 6e63 680a 2020     sky.launch.  
+00017ba0: 2020 2320 544f 444f 287a 6877 7529 3a20    # TODO(zhwu): 
+00017bb0: 4164 6420 6120 7465 7374 2066 6f72 2063  Add a test for c
+00017bc0: 6f72 6520 6170 692e 0a0a 0a23 202d 2d2d  ore api....# ---
+00017bd0: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+00017be0: 5374 6f72 6167 6520 2d2d 2d2d 2d2d 2d2d  Storage --------
+00017bf0: 2d2d 0a63 6c61 7373 2054 6573 7453 746f  --.class TestSto
+00017c00: 7261 6765 5769 7468 4372 6564 656e 7469  rageWithCredenti
+00017c10: 616c 733a 0a20 2020 2022 2222 5374 6f72  als:.    """Stor
+00017c20: 6167 6520 7465 7374 7320 7768 6963 6820  age tests which 
+00017c30: 7265 7175 6972 6520 6372 6564 656e 7469  require credenti
+00017c40: 616c 7320 616e 6420 6e65 7477 6f72 6b20  als and network 
+00017c50: 636f 6e6e 6563 7469 6f6e 2222 220a 0a20  connection""".. 
+00017c60: 2020 2041 5753 5f49 4e56 414c 4944 5f4e     AWS_INVALID_N
+00017c70: 414d 4553 203d 205b 0a20 2020 2020 2020  AMES = [.       
+00017c80: 2027 6162 272c 2020 2320 6c65 7373 2074   'ab',  # less t
+00017c90: 6861 6e20 3320 6368 6172 6163 7465 7273  han 3 characters
+00017ca0: 0a20 2020 2020 2020 2027 6162 6364 6566  .        'abcdef
+00017cb0: 6768 696a 6b6c 6d6e 6f70 7172 7374 7576  ghijklmnopqrstuv
+00017cc0: 7778 797a 6162 6364 6566 6768 696a 6b6c  wxyzabcdefghijkl
+00017cd0: 6d6e 6f70 7172 7374 7576 7778 797a 6162  mnopqrstuvwxyzab
+00017ce0: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00017cf0: 7374 7576 7778 797a 3127 2c0a 2020 2020  stuvwxyz1',.    
+00017d00: 2020 2020 2320 6d6f 7265 2074 6861 6e20      # more than 
+00017d10: 3633 2063 6861 7261 6374 6572 730a 2020  63 characters.  
+00017d20: 2020 2020 2020 2741 6263 6465 6627 2c20        'Abcdef', 
+00017d30: 2023 2063 6f6e 7461 696e 7320 616e 2075   # contains an u
+00017d40: 7070 6572 6361 7365 206c 6574 7465 720a  ppercase letter.
+00017d50: 2020 2020 2020 2020 2761 6263 2064 6566          'abc def
+00017d60: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
+00017d70: 2073 7061 6365 0a20 2020 2020 2020 2027   space.        '
+00017d80: 6162 632e 2e64 6566 272c 2020 2320 7477  abc..def',  # tw
+00017d90: 6f20 6164 6a61 6365 6e74 2070 6572 696f  o adjacent perio
+00017da0: 6473 0a20 2020 2020 2020 2027 3139 322e  ds.        '192.
+00017db0: 3136 382e 352e 3427 2c20 2023 2066 6f72  168.5.4',  # for
+00017dc0: 6d61 7474 6564 2061 7320 616e 2049 5020  matted as an IP 
+00017dd0: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
+00017de0: 2778 6e2d 2d62 7563 6b65 7427 2c20 2023  'xn--bucket',  #
+00017df0: 2073 7461 7274 7320 7769 7468 2027 786e   starts with 'xn
+00017e00: 2d2d 2720 7072 6566 6978 0a20 2020 2020  --' prefix.     
+00017e10: 2020 2027 6275 636b 6574 2d73 3361 6c69     'bucket-s3ali
+00017e20: 6173 272c 2020 2320 656e 6473 2077 6974  as',  # ends wit
+00017e30: 6820 272d 7333 616c 6961 7327 2073 7566  h '-s3alias' suf
+00017e40: 6669 780a 2020 2020 2020 2020 2762 7563  fix.        'buc
+00017e50: 6b65 742d 2d6f 6c2d 7333 272c 2020 2320  ket--ol-s3',  # 
+00017e60: 656e 6473 2077 6974 6820 272d 2d6f 6c2d  ends with '--ol-
+00017e70: 7333 2720 7375 6666 6978 0a20 2020 2020  s3' suffix.     
+00017e80: 2020 2027 2e61 6263 272c 2020 2320 7374     '.abc',  # st
+00017e90: 6172 7473 2077 6974 6820 6120 646f 740a  arts with a dot.
+00017ea0: 2020 2020 2020 2020 2761 6263 2e27 2c20          'abc.', 
+00017eb0: 2023 2065 6e64 7320 7769 7468 2061 2064   # ends with a d
+00017ec0: 6f74 0a20 2020 2020 2020 2027 2d61 6263  ot.        '-abc
+00017ed0: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
+00017ee0: 6820 6120 6879 7068 656e 0a20 2020 2020  h a hyphen.     
+00017ef0: 2020 2027 6162 632d 272c 2020 2320 656e     'abc-',  # en
+00017f00: 6473 2077 6974 6820 6120 6879 7068 656e  ds with a hyphen
+00017f10: 0a20 2020 205d 0a0a 2020 2020 4743 535f  .    ]..    GCS_
+00017f20: 494e 5641 4c49 445f 4e41 4d45 5320 3d20  INVALID_NAMES = 
+00017f30: 5b0a 2020 2020 2020 2020 2761 6227 2c20  [.        'ab', 
+00017f40: 2023 206c 6573 7320 7468 616e 2033 2063   # less than 3 c
+00017f50: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
+00017f60: 2020 2761 6263 6465 6667 6869 6a6b 6c6d    'abcdefghijklm
+00017f70: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+00017f80: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00017f90: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+00017fa0: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00017fb0: 7a31 272c 0a20 2020 2020 2020 2023 206d  z1',.        # m
+00017fc0: 6f72 6520 7468 616e 2036 3320 6368 6172  ore than 63 char
+00017fd0: 6163 7465 7273 2028 7769 7468 6f75 7420  acters (without 
+00017fe0: 646f 7473 290a 2020 2020 2020 2020 2741  dots).        'A
+00017ff0: 6263 6465 6627 2c20 2023 2063 6f6e 7461  bcdef',  # conta
+00018000: 696e 7320 616e 2075 7070 6572 6361 7365  ins an uppercase
+00018010: 206c 6574 7465 720a 2020 2020 2020 2020   letter.        
+00018020: 2761 6263 2064 6566 272c 2020 2320 636f  'abc def',  # co
+00018030: 6e74 6169 6e73 2061 2073 7061 6365 0a20  ntains a space. 
+00018040: 2020 2020 2020 2027 6162 632e 2e64 6566         'abc..def
+00018050: 272c 2020 2320 7477 6f20 6164 6a61 6365  ',  # two adjace
+00018060: 6e74 2070 6572 696f 6473 0a20 2020 2020  nt periods.     
+00018070: 2020 2027 6162 635f 2e64 6566 2e67 6869     'abc_.def.ghi
+00018080: 2e6a 6b6c 6d6e 6f70 7172 7374 7576 7778  .jklmnopqrstuvwx
+00018090: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+000180a0: 6f70 7172 7374 7576 7778 797a 6162 6364  opqrstuvwxyzabcd
+000180b0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
+000180c0: 7576 7778 797a 3127 0a20 2020 2020 2020  uvwxyz1'.       
+000180d0: 2023 204d 6f72 6520 7468 616e 2036 3320   # More than 63 
+000180e0: 6368 6172 6163 7465 7273 2062 6574 7765  characters betwe
+000180f0: 656e 2064 6f74 730a 2020 2020 2020 2020  en dots.        
+00018100: 2761 6263 5f2e 6465 662e 6768 692e 6a6b  'abc_.def.ghi.jk
+00018110: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+00018120: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+00018130: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00018140: 7677 2720 2a20 352c 0a20 2020 2020 2020  vw' * 5,.       
+00018150: 2023 206d 6f72 6520 7468 616e 2032 3232   # more than 222
+00018160: 2063 6861 7261 6374 6572 7320 2877 6974   characters (wit
+00018170: 6820 646f 7473 290a 2020 2020 2020 2020  h dots).        
+00018180: 2731 3932 2e31 3638 2e35 2e34 272c 2020  '192.168.5.4',  
+00018190: 2320 666f 726d 6174 7465 6420 6173 2061  # formatted as a
+000181a0: 6e20 4950 2061 6464 7265 7373 0a20 2020  n IP address.   
+000181b0: 2020 2020 2027 676f 6f67 6275 636b 6574       'googbucket
+000181c0: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
+000181d0: 6820 2767 6f6f 6727 2070 7265 6669 780a  h 'goog' prefix.
+000181e0: 2020 2020 2020 2020 2767 6f6f 676c 6562          'googleb
+000181f0: 7563 6b65 7427 2c20 2023 2063 6f6e 7461  ucket',  # conta
+00018200: 696e 7320 2767 6f6f 676c 6527 0a20 2020  ins 'google'.   
+00018210: 2020 2020 2027 6730 3067 6c65 6275 636b       'g00glebuck
+00018220: 6574 272c 2020 2320 7661 7269 616e 7420  et',  # variant 
+00018230: 6f66 2027 676f 6f67 6c65 270a 2020 2020  of 'google'.    
+00018240: 2020 2020 2767 6f30 676c 6562 7563 6b65      'go0glebucke
+00018250: 7427 2c20 2023 2076 6172 6961 6e74 206f  t',  # variant o
+00018260: 6620 2767 6f6f 676c 6527 0a20 2020 2020  f 'google'.     
+00018270: 2020 2027 6730 6f67 6c65 6275 636b 6574     'g0oglebucket
+00018280: 272c 2020 2320 7661 7269 616e 7420 6f66  ',  # variant of
+00018290: 2027 676f 6f67 6c65 270a 2020 2020 2020   'google'.      
+000182a0: 2020 272e 6162 6327 2c20 2023 2073 7461    '.abc',  # sta
+000182b0: 7274 7320 7769 7468 2061 2064 6f74 0a20  rts with a dot. 
+000182c0: 2020 2020 2020 2027 6162 632e 272c 2020         'abc.',  
+000182d0: 2320 656e 6473 2077 6974 6820 6120 646f  # ends with a do
+000182e0: 740a 2020 2020 2020 2020 275f 6162 6327  t.        '_abc'
+000182f0: 2c20 2023 2073 7461 7274 7320 7769 7468  ,  # starts with
+00018300: 2061 6e20 756e 6465 7273 636f 7265 0a20   an underscore. 
+00018310: 2020 2020 2020 2027 6162 635f 272c 2020         'abc_',  
+00018320: 2320 656e 6473 2077 6974 6820 616e 2075  # ends with an u
+00018330: 6e64 6572 7363 6f72 650a 2020 2020 5d0a  nderscore.    ].
+00018340: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+00018350: 6f64 0a20 2020 2064 6566 2063 6c69 5f64  od.    def cli_d
+00018360: 656c 6574 655f 636d 6428 7374 6f72 655f  elete_cmd(store_
+00018370: 7479 7065 2c20 6275 636b 6574 5f6e 616d  type, bucket_nam
+00018380: 6529 3a0a 2020 2020 2020 2020 6966 2073  e):.        if s
+00018390: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+000183a0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+000183b0: 7065 2e53 333a 0a20 2020 2020 2020 2020  pe.S3:.         
+000183c0: 2020 2075 726c 203d 2066 2773 333a 2f2f     url = f's3://
+000183d0: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
+000183e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000183f0: 6e20 6627 6177 7320 7333 2072 6220 7b75  n f'aws s3 rb {u
+00018400: 726c 7d20 2d2d 666f 7263 6527 0a20 2020  rl} --force'.   
+00018410: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
+00018420: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
+00018430: 622e 5374 6f72 6554 7970 652e 4743 533a  b.StoreType.GCS:
+00018440: 0a20 2020 2020 2020 2020 2020 2075 726c  .            url
+00018450: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
+00018460: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+00018470: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
+00018480: 7574 696c 202d 6d20 726d 202d 7220 7b75  util -m rm -r {u
+00018490: 726c 7d27 0a20 2020 2020 2020 2069 6620  rl}'.        if 
+000184a0: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+000184b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000184c0: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
+000184d0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+000184e0: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+000184f0: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+00018500: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+00018510: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+00018520: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+00018530: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
+00018540: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+00018550: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+00018560: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+00018570: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+00018580: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
+00018590: 6520 2d2d 656e 6470 6f69 6e74 207b 656e  e --endpoint {en
+000185a0: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+000185b0: 6f66 696c 653d 7232 270a 0a20 2020 2040  ofile=r2'..    @
+000185c0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+000185d0: 2064 6566 2063 6c69 5f6c 735f 636d 6428   def cli_ls_cmd(
+000185e0: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+000185f0: 6574 5f6e 616d 652c 2073 7566 6669 783d  et_name, suffix=
+00018600: 2727 293a 0a20 2020 2020 2020 2069 6620  ''):.        if 
+00018610: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+00018620: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00018630: 7970 652e 5333 3a0a 2020 2020 2020 2020  ype.S3:.        
+00018640: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
+00018650: 2020 2020 2020 2020 2020 2020 2020 2075                 u
+00018660: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
+00018670: 6b65 745f 6e61 6d65 7d2f 7b73 7566 6669  ket_name}/{suffi
+00018680: 787d 270a 2020 2020 2020 2020 2020 2020  x}'.            
+00018690: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000186a0: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
+000186b0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+000186c0: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
+000186d0: 7475 726e 2066 2761 7773 2073 3320 6c73  turn f'aws s3 ls
+000186e0: 207b 7572 6c7d 270a 2020 2020 2020 2020   {url}'.        
+000186f0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+00018700: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00018710: 7265 5479 7065 2e47 4353 3a0a 2020 2020  reType.GCS:.    
+00018720: 2020 2020 2020 2020 6966 2073 7566 6669          if suffi
+00018730: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
+00018740: 2020 2075 726c 203d 2066 2767 733a 2f2f     url = f'gs://
+00018750: 7b62 7563 6b65 745f 6e61 6d65 7d2f 7b73  {bucket_name}/{s
+00018760: 7566 6669 787d 270a 2020 2020 2020 2020  uffix}'.        
+00018770: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018780: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
+00018790: 6627 6773 3a2f 2f7b 6275 636b 6574 5f6e  f'gs://{bucket_n
+000187a0: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
+000187b0: 2020 7265 7475 726e 2066 2767 7375 7469    return f'gsuti
+000187c0: 6c20 6c73 207b 7572 6c7d 270a 2020 2020  l ls {url}'.    
+000187d0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+000187e0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+000187f0: 2e53 746f 7265 5479 7065 2e52 323a 0a20  .StoreType.R2:. 
+00018800: 2020 2020 2020 2020 2020 2065 6e64 706f             endpo
+00018810: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
+00018820: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
+00018830: 6f69 6e74 2829 0a20 2020 2020 2020 2020  oint().         
+00018840: 2020 2069 6620 7375 6666 6978 3a0a 2020     if suffix:.  
+00018850: 2020 2020 2020 2020 2020 2020 2020 7572                ur
+00018860: 6c20 3d20 6627 7333 3a2f 2f7b 6275 636b  l = f's3://{buck
+00018870: 6574 5f6e 616d 657d 2f7b 7375 6666 6978  et_name}/{suffix
+00018880: 7d27 0a20 2020 2020 2020 2020 2020 2065  }'.            e
+00018890: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000188a0: 2020 2020 2075 726c 203d 2066 2773 333a       url = f's3:
+000188b0: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
+000188c0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000188d0: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+000188e0: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+000188f0: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+00018900: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+00018910: 487d 2061 7773 2073 3320 6c73 207b 7572  H} aws s3 ls {ur
+00018920: 6c7d 202d 2d65 6e64 706f 696e 7420 7b65  l} --endpoint {e
+00018930: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+00018940: 726f 6669 6c65 3d72 3227 0a0a 2020 2020  rofile=r2'..    
+00018950: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+00018960: 2020 2020 6465 6620 746d 705f 736f 7572      def tmp_sour
+00018970: 6365 2873 656c 662c 2074 6d70 5f70 6174  ce(self, tmp_pat
+00018980: 6829 3a0a 2020 2020 2020 2020 2320 4372  h):.        # Cr
+00018990: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+000189a0: 7920 6469 7265 6374 6f72 7920 7769 7468  y directory with
+000189b0: 2061 2066 696c 6520 696e 2069 740a 2020   a file in it.  
+000189c0: 2020 2020 2020 746d 705f 6469 7220 3d20        tmp_dir = 
+000189d0: 746d 705f 7061 7468 202f 2027 746d 702d  tmp_path / 'tmp-
+000189e0: 736f 7572 6365 270a 2020 2020 2020 2020  source'.        
+000189f0: 746d 705f 6469 722e 6d6b 6469 7228 290a  tmp_dir.mkdir().
+00018a00: 2020 2020 2020 2020 746d 705f 6669 6c65          tmp_file
+00018a10: 203d 2074 6d70 5f64 6972 202f 2027 746d   = tmp_dir / 'tm
+00018a20: 702d 6669 6c65 270a 2020 2020 2020 2020  p-file'.        
+00018a30: 746d 705f 6669 6c65 2e77 7269 7465 5f74  tmp_file.write_t
+00018a40: 6578 7428 2774 6573 7427 290a 2020 2020  ext('test').    
+00018a50: 2020 2020 6369 7263 6c65 5f6c 696e 6b20      circle_link 
+00018a60: 3d20 746d 705f 6469 7220 2f20 2763 6972  = tmp_dir / 'cir
+00018a70: 636c 652d 6c69 6e6b 270a 2020 2020 2020  cle-link'.      
+00018a80: 2020 6369 7263 6c65 5f6c 696e 6b2e 7379    circle_link.sy
+00018a90: 6d6c 696e 6b5f 746f 2874 6d70 5f64 6972  mlink_to(tmp_dir
+00018aa0: 2c20 7461 7267 6574 5f69 735f 6469 7265  , target_is_dire
+00018ab0: 6374 6f72 793d 5472 7565 290a 2020 2020  ctory=True).    
+00018ac0: 2020 2020 7969 656c 6420 7374 7228 746d      yield str(tm
+00018ad0: 705f 6469 7229 0a0a 2020 2020 4070 7974  p_dir)..    @pyt
+00018ae0: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+00018af0: 6465 6620 746d 705f 6275 636b 6574 5f6e  def tmp_bucket_n
+00018b00: 616d 6528 7365 6c66 293a 0a20 2020 2020  ame(self):.     
+00018b10: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+00018b20: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
+00018b30: 6e61 6d65 0a20 2020 2020 2020 2023 2074  name.        # t
+00018b40: 696d 652e 7469 6d65 2829 2072 6574 7572  ime.time() retur
+00018b50: 6e73 2076 6172 7969 6e67 2070 7265 6369  ns varying preci
+00018b60: 7369 6f6e 206f 6e20 6469 6666 6572 656e  sion on differen
+00018b70: 7420 7379 7374 656d 732c 2073 6f20 7765  t systems, so we
+00018b80: 0a20 2020 2020 2020 2023 2072 6570 6c61  .        # repla
+00018b90: 6365 2074 6865 2064 6563 696d 616c 2070  ce the decimal p
+00018ba0: 6f69 6e74 2061 6e64 2075 7365 2077 6861  oint and use wha
+00018bb0: 7465 7665 7220 7072 6563 6973 696f 6e20  tever precision 
+00018bc0: 7765 2063 616e 2067 6574 2e0a 2020 2020  we can get..    
+00018bd0: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
+00018be0: 7374 7228 7469 6d65 2e74 696d 6528 2929  str(time.time())
+00018bf0: 2e72 6570 6c61 6365 2827 2e27 2c20 2727  .replace('.', ''
+00018c00: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+00018c10: 6627 736b 792d 7465 7374 2d7b 7469 6d65  f'sky-test-{time
+00018c20: 7374 616d 707d 270a 0a20 2020 2040 7374  stamp}'..    @st
+00018c30: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+00018c40: 6566 2079 6965 6c64 5f73 746f 7261 6765  ef yield_storage
+00018c50: 5f6f 626a 6563 7428 0a20 2020 2020 2020  _object(.       
+00018c60: 2020 2020 206e 616d 653a 204f 7074 696f       name: Optio
+00018c70: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00018c80: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00018c90: 7263 653a 204f 7074 696f 6e61 6c5b 7374  rce: Optional[st
+00018ca0: 6f72 6167 655f 6c69 622e 5061 7468 5d20  orage_lib.Path] 
+00018cb0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00018cc0: 2020 2020 7374 6f72 6573 3a20 4f70 7469      stores: Opti
+00018cd0: 6f6e 616c 5b44 6963 745b 7374 6f72 6167  onal[Dict[storag
+00018ce0: 655f 6c69 622e 5374 6f72 6554 7970 652c  e_lib.StoreType,
+00018cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d10: 2020 2073 746f 7261 6765 5f6c 6962 2e41     storage_lib.A
+00018d20: 6273 7472 6163 7453 746f 7265 5d5d 203d  bstractStore]] =
+00018d30: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00018d40: 2020 2070 6572 7369 7374 656e 743a 204f     persistent: O
+00018d50: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00018d60: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00018d70: 2020 6d6f 6465 3a20 7374 6f72 6167 655f    mode: storage_
+00018d80: 6c69 622e 5374 6f72 6167 654d 6f64 6520  lib.StorageMode 
+00018d90: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
+00018da0: 6f72 6167 654d 6f64 652e 4d4f 554e 5429  orageMode.MOUNT)
+00018db0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+00018dc0: 7465 7320 6120 7465 6d70 6f72 6172 7920  tes a temporary 
+00018dd0: 7374 6f72 6167 6520 6f62 6a65 6374 2e20  storage object. 
+00018de0: 5374 6f72 6573 206d 7573 7420 6265 2061  Stores must be a
+00018df0: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
+00018e00: 2e0a 2020 2020 2020 2020 7374 6f72 6167  ..        storag
+00018e10: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
+00018e20: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
+00018e30: 3d6e 616d 652c 0a20 2020 2020 2020 2020  =name,.         
+00018e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e60: 2073 6f75 7263 653d 736f 7572 6365 2c0a   source=source,.
+00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e90: 2020 2020 2020 2020 2020 7374 6f72 6573            stores
+00018ea0: 3d73 746f 7265 732c 0a20 2020 2020 2020  =stores,.       
+00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ed0: 2020 2070 6572 7369 7374 656e 743d 7065     persistent=pe
+00018ee0: 7273 6973 7465 6e74 2c0a 2020 2020 2020  rsistent,.      
+00018ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f10: 2020 2020 6d6f 6465 3d6d 6f64 6529 0a20      mode=mode). 
+00018f20: 2020 2020 2020 2079 6965 6c64 2073 746f         yield sto
+00018f30: 7261 6765 5f6f 626a 0a20 2020 2020 2020  rage_obj.       
+00018f40: 2068 616e 646c 6520 3d20 676c 6f62 616c   handle = global
+00018f50: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
+00018f60: 6861 6e64 6c65 5f66 726f 6d5f 7374 6f72  handle_from_stor
+00018f70: 6167 655f 6e61 6d65 280a 2020 2020 2020  age_name(.      
+00018f80: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+00018f90: 6a2e 6e61 6d65 290a 2020 2020 2020 2020  j.name).        
+00018fa0: 6966 2068 616e 646c 653a 0a20 2020 2020  if handle:.     
+00018fb0: 2020 2020 2020 2023 2049 6620 6861 6e64         # If hand
+00018fc0: 6c65 2065 7869 7374 732c 2064 656c 6574  le exists, delet
+00018fd0: 6520 6d61 6e75 616c 6c79 0a20 2020 2020  e manually.     
+00018fe0: 2020 2020 2020 2023 2054 4f44 4f28 726f         # TODO(ro
+00018ff0: 6d69 6c62 293a 2054 6869 7320 6973 2070  milb): This is p
+00019000: 6f74 656e 7469 616c 6c79 2072 6973 6b79  otentially risky
+00019010: 202d 2069 6620 7468 6520 6465 6c65 7465   - if the delete
+00019020: 206d 6574 686f 6420 6861 730a 2020 2020   method has.    
+00019030: 2020 2020 2020 2020 2320 2020 6275 6773          #   bugs
+00019040: 2c20 7468 6973 2063 616e 2063 6175 7365  , this can cause
+00019050: 2072 6573 6f75 7263 6520 6c65 616b 732e   resource leaks.
+00019060: 2049 6465 616c 6c79 2077 6520 7368 6f75   Ideally we shou
+00019070: 6c64 206d 616e 7561 6c6c 790a 2020 2020  ld manually.    
+00019080: 2020 2020 2020 2020 2320 2020 656a 6563          #   ejec
+00019090: 7420 7374 6f72 6167 6520 6672 6f6d 2067  t storage from g
+000190a0: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+000190b0: 2061 6e64 2064 656c 6574 6520 7468 6520   and delete the 
+000190c0: 6275 636b 6574 2075 7369 6e67 0a20 2020  bucket using.   
+000190d0: 2020 2020 2020 2020 2023 2020 2062 6f74           #   bot
+000190e0: 6f33 2064 6972 6563 746c 792e 0a20 2020  o3 directly..   
+000190f0: 2020 2020 2020 2020 2073 746f 7261 6765           storage
+00019100: 5f6f 626a 2e64 656c 6574 6528 290a 0a20  _obj.delete().. 
+00019110: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+00019120: 7265 0a20 2020 2064 6566 2074 6d70 5f73  re.    def tmp_s
+00019130: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+00019140: 626a 2873 656c 662c 2074 6d70 5f62 7563  bj(self, tmp_buc
+00019150: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+00019160: 2020 2023 2043 7265 6174 6573 2061 2073     # Creates a s
+00019170: 746f 7261 6765 206f 626a 6563 7420 7769  torage object wi
+00019180: 7468 206e 6f20 736f 7572 6365 2074 6f20  th no source to 
+00019190: 6372 6561 7465 2061 2073 6372 6174 6368  create a scratch
+000191a0: 2073 746f 7261 6765 2e0a 2020 2020 2020   storage..      
+000191b0: 2020 2320 5374 6f72 6573 206d 7573 7420    # Stores must 
+000191c0: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+000191d0: 7465 7374 2e0a 2020 2020 2020 2020 7969  test..        yi
+000191e0: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
+000191f0: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
+00019200: 6374 286e 616d 653d 746d 705f 6275 636b  ct(name=tmp_buck
+00019210: 6574 5f6e 616d 6529 0a0a 2020 2020 4070  et_name)..    @p
+00019220: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
+00019230: 2020 6465 6620 746d 705f 6d75 6c74 6970    def tmp_multip
+00019240: 6c65 5f73 6372 6174 6368 5f73 746f 7261  le_scratch_stora
+00019250: 6765 5f6f 626a 2873 656c 6629 3a0a 2020  ge_obj(self):.  
+00019260: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+00019270: 6120 6c69 7374 206f 6620 3520 7374 6f72  a list of 5 stor
+00019280: 6167 6520 6f62 6a65 6374 7320 7769 7468  age objects with
+00019290: 206e 6f20 736f 7572 6365 2074 6f20 6372   no source to cr
+000192a0: 6561 7465 0a20 2020 2020 2020 2023 206d  eate.        # m
+000192b0: 756c 7469 706c 6520 7363 7261 7463 6820  ultiple scratch 
+000192c0: 7374 6f72 6167 6573 2e0a 2020 2020 2020  storages..      
+000192d0: 2020 2320 5374 6f72 6573 2066 6f72 2065    # Stores for e
+000192e0: 6163 6820 6f62 6a65 6374 2069 6e20 7468  ach object in th
+000192f0: 6520 6c69 7374 206d 7573 7420 6265 2061  e list must be a
+00019300: 6464 6564 2069 6e20 7468 6520 7465 7374  dded in the test
+00019310: 2e0a 2020 2020 2020 2020 7374 6f72 6167  ..        storag
+00019320: 655f 6d75 6c74 5f6f 626a 203d 205b 5d0a  e_mult_obj = [].
+00019330: 2020 2020 2020 2020 666f 7220 5f20 696e          for _ in
+00019340: 2072 616e 6765 2835 293a 0a20 2020 2020   range(5):.     
+00019350: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
+00019360: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
+00019370: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
+00019380: 2027 2729 0a20 2020 2020 2020 2020 2020   '').           
+00019390: 2073 746f 7265 5f6f 626a 203d 2073 746f   store_obj = sto
+000193a0: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
+000193b0: 286e 616d 653d 6627 736b 792d 7465 7374  (name=f'sky-test
+000193c0: 2d7b 7469 6d65 7374 616d 707d 2729 0a20  -{timestamp}'). 
+000193d0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+000193e0: 6765 5f6d 756c 745f 6f62 6a2e 6170 7065  ge_mult_obj.appe
+000193f0: 6e64 2873 746f 7265 5f6f 626a 290a 2020  nd(store_obj).  
+00019400: 2020 2020 2020 7969 656c 6420 7374 6f72        yield stor
+00019410: 6167 655f 6d75 6c74 5f6f 626a 0a20 2020  age_mult_obj.   
+00019420: 2020 2020 2066 6f72 2073 746f 7261 6765       for storage
+00019430: 5f6f 626a 2069 6e20 7374 6f72 6167 655f  _obj in storage_
+00019440: 6d75 6c74 5f6f 626a 3a0a 2020 2020 2020  mult_obj:.      
+00019450: 2020 2020 2020 6861 6e64 6c65 203d 2067        handle = g
+00019460: 6c6f 6261 6c5f 7573 6572 5f73 7461 7465  lobal_user_state
+00019470: 2e67 6574 5f68 616e 646c 655f 6672 6f6d  .get_handle_from
+00019480: 5f73 746f 7261 6765 5f6e 616d 6528 0a20  _storage_name(. 
+00019490: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000194a0: 746f 7261 6765 5f6f 626a 2e6e 616d 6529  torage_obj.name)
+000194b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000194c0: 6861 6e64 6c65 3a0a 2020 2020 2020 2020  handle:.        
+000194d0: 2020 2020 2020 2020 2320 4966 2068 616e          # If han
+000194e0: 646c 6520 6578 6973 7473 2c20 6465 6c65  dle exists, dele
+000194f0: 7465 206d 616e 7561 6c6c 790a 2020 2020  te manually.    
+00019500: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+00019510: 444f 2872 6f6d 696c 6229 3a20 5468 6973  DO(romilb): This
+00019520: 2069 7320 706f 7465 6e74 6961 6c6c 7920   is potentially 
+00019530: 7269 736b 7920 2d20 6966 2074 6865 2064  risky - if the d
+00019540: 656c 6574 6520 6d65 7468 6f64 2068 6173  elete method has
+00019550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019560: 2023 2062 7567 732c 2074 6869 7320 6361   # bugs, this ca
+00019570: 6e20 6361 7573 6520 7265 736f 7572 6365  n cause resource
+00019580: 206c 6561 6b73 2e20 4964 6561 6c6c 7920   leaks. Ideally 
+00019590: 7765 2073 686f 756c 6420 6d61 6e75 616c  we should manual
+000195a0: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
+000195b0: 2020 2023 2065 6a65 6374 2073 746f 7261     # eject stora
+000195c0: 6765 2066 726f 6d20 676c 6f62 616c 5f75  ge from global_u
+000195d0: 7365 725f 7374 6174 6520 616e 6420 6465  ser_state and de
+000195e0: 6c65 7465 2074 6865 2062 7563 6b65 7420  lete the bucket 
+000195f0: 7573 696e 670a 2020 2020 2020 2020 2020  using.          
+00019600: 2020 2020 2020 2320 626f 746f 3320 6469        # boto3 di
+00019610: 7265 6374 6c79 2e0a 2020 2020 2020 2020  rectly..        
+00019620: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+00019630: 6f62 6a2e 6465 6c65 7465 2829 0a0a 2020  obj.delete()..  
+00019640: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+00019650: 650a 2020 2020 6465 6620 746d 705f 6c6f  e.    def tmp_lo
+00019660: 6361 6c5f 7374 6f72 6167 655f 6f62 6a28  cal_storage_obj(
+00019670: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
+00019680: 5f6e 616d 652c 2074 6d70 5f73 6f75 7263  _name, tmp_sourc
+00019690: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+000196a0: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+000196b0: 7920 7374 6f72 6167 6520 6f62 6a65 6374  y storage object
+000196c0: 2e20 5374 6f72 6573 206d 7573 7420 6265  . Stores must be
+000196d0: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+000196e0: 7374 2e0a 2020 2020 2020 2020 7969 656c  st..        yiel
+000196f0: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
+00019700: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
+00019710: 286e 616d 653d 746d 705f 6275 636b 6574  (name=tmp_bucket
+00019720: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+00019730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019750: 2020 2020 736f 7572 6365 3d74 6d70 5f73      source=tmp_s
+00019760: 6f75 7263 6529 0a0a 2020 2020 4070 7974  ource)..    @pyt
+00019770: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+00019780: 6465 6620 746d 705f 6c6f 6361 6c5f 6c69  def tmp_local_li
+00019790: 7374 5f73 746f 7261 6765 5f6f 626a 2873  st_storage_obj(s
+000197a0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
+000197b0: 6e61 6d65 2c20 746d 705f 736f 7572 6365  name, tmp_source
+000197c0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+000197d0: 6174 6573 2061 2074 656d 7020 7374 6f72  ates a temp stor
+000197e0: 6167 6520 6f62 6a65 6374 2077 6869 6368  age object which
+000197f0: 2075 7365 7320 6120 6c69 7374 206f 6620   uses a list of 
+00019800: 7061 7468 7320 6173 2073 6f75 7263 652e  paths as source.
+00019810: 0a20 2020 2020 2020 2023 2053 746f 7265  .        # Store
+00019820: 7320 6d75 7374 2062 6520 6164 6465 6420  s must be added 
+00019830: 696e 2074 6865 2074 6573 742e 2041 6674  in the test. Aft
+00019840: 6572 2075 706c 6f61 642c 2074 6865 2062  er upload, the b
+00019850: 7563 6b65 7420 7368 6f75 6c64 0a20 2020  ucket should.   
+00019860: 2020 2020 2023 2068 6176 6520 7477 6f20       # have two 
+00019870: 6669 6c65 7320 2d20 2f74 6d70 2d66 696c  files - /tmp-fil
+00019880: 6520 616e 6420 2f74 6d70 2d73 6f75 7263  e and /tmp-sourc
+00019890: 652f 746d 702d 6669 6c65 0a20 2020 2020  e/tmp-file.     
+000198a0: 2020 206c 6973 745f 736f 7572 6365 203d     list_source =
+000198b0: 205b 746d 705f 736f 7572 6365 2c20 746d   [tmp_source, tm
+000198c0: 705f 736f 7572 6365 202b 2027 2f74 6d70  p_source + '/tmp
+000198d0: 2d66 696c 6527 5d0a 2020 2020 2020 2020  -file'].        
+000198e0: 7969 656c 6420 6672 6f6d 2073 656c 662e  yield from self.
+000198f0: 7969 656c 645f 7374 6f72 6167 655f 6f62  yield_storage_ob
+00019900: 6a65 6374 286e 616d 653d 746d 705f 6275  ject(name=tmp_bu
+00019910: 636b 6574 5f6e 616d 652c 0a20 2020 2020  cket_name,.     
+00019920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019940: 2020 2020 2020 2020 736f 7572 6365 3d6c          source=l
+00019950: 6973 745f 736f 7572 6365 290a 0a20 2020  ist_source)..   
+00019960: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+00019970: 0a20 2020 2064 6566 2074 6d70 5f62 756c  .    def tmp_bul
+00019980: 6b5f 6465 6c5f 7374 6f72 6167 655f 6f62  k_del_storage_ob
+00019990: 6a28 7365 6c66 2c20 746d 705f 6275 636b  j(self, tmp_buck
+000199a0: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
+000199b0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+000199c0: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
+000199d0: 6f62 6a65 6374 2066 6f72 2074 6573 7469  object for testi
+000199e0: 6e67 2062 756c 6b20 6465 6c65 7469 6f6e  ng bulk deletion
+000199f0: 2e0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
+00019a00: 6573 206d 7573 7420 6265 2061 6464 6564  es must be added
+00019a10: 2069 6e20 7468 6520 7465 7374 2e0a 2020   in the test..  
+00019a20: 2020 2020 2020 7769 7468 2074 656d 7066        with tempf
+00019a30: 696c 652e 5465 6d70 6f72 6172 7944 6972  ile.TemporaryDir
+00019a40: 6563 746f 7279 2829 2061 7320 746d 7064  ectory() as tmpd
+00019a50: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
+00019a60: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+00019a70: 5f6f 7574 7075 7428 6627 6d6b 6469 7220  _output(f'mkdir 
+00019a80: 2d70 207b 746d 7064 6972 7d2f 666f 6c64  -p {tmpdir}/fold
+00019a90: 6572 7b7b 3030 302e 2e32 3535 7d7d 272c  er{{000..255}}',
+00019aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ac0: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00019ad0: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
+00019ae0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00019af0: 7470 7574 2866 2774 6f75 6368 207b 746d  tput(f'touch {tm
+00019b00: 7064 6972 7d2f 7465 7374 7b7b 3030 302e  pdir}/test{{000.
+00019b10: 2e32 3535 7d7d 2e74 7874 272c 0a20 2020  .255}}.txt',.   
+00019b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b40: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+00019b50: 2020 2020 2020 2020 2073 7562 7072 6f63           subproc
+00019b60: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00019b70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00019b80: 2020 6627 746f 7563 6820 7b74 6d70 6469    f'touch {tmpdi
+00019b90: 727d 2f66 6f6c 6465 727b 7b30 3030 2e2e  r}/folder{{000..
+00019ba0: 3235 357d 7d2f 7465 7374 2e74 7874 272c  255}}/test.txt',
+00019bb0: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+00019bc0: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
+00019bd0: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
+00019be0: 746f 7261 6765 5f6f 626a 6563 7428 6e61  torage_object(na
+00019bf0: 6d65 3d74 6d70 5f62 7563 6b65 745f 6e61  me=tmp_bucket_na
+00019c00: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00019c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c30: 2020 2020 2073 6f75 7263 653d 746d 7064       source=tmpd
+00019c40: 6972 290a 0a20 2020 2040 7079 7465 7374  ir)..    @pytest
+00019c50: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
+00019c60: 2074 6d70 5f63 6f70 795f 6d6e 745f 6578   tmp_copy_mnt_ex
+00019c70: 6973 7469 6e67 5f73 746f 7261 6765 5f6f  isting_storage_o
+00019c80: 626a 2873 656c 662c 2074 6d70 5f73 6372  bj(self, tmp_scr
+00019c90: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+00019ca0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+00019cb0: 6174 6573 2061 2063 6f70 7920 6d6f 756e  ates a copy moun
+00019cc0: 7420 7374 6f72 6167 6520 7768 6963 6820  t storage which 
+00019cd0: 7265 7573 6573 2061 6e20 6578 6973 7469  reuses an existi
+00019ce0: 6e67 2073 746f 7261 6765 206f 626a 6563  ng storage objec
+00019cf0: 742e 0a20 2020 2020 2020 2074 6d70 5f73  t..        tmp_s
+00019d00: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+00019d10: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+00019d20: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00019d30: 7065 2e53 3329 0a20 2020 2020 2020 2073  pe.S3).        s
+00019d40: 746f 7261 6765 5f6e 616d 6520 3d20 746d  torage_name = tm
+00019d50: 705f 7363 7261 7463 685f 7374 6f72 6167  p_scratch_storag
+00019d60: 655f 6f62 6a2e 6e61 6d65 0a0a 2020 2020  e_obj.name..    
+00019d70: 2020 2020 2320 5472 7920 746f 2069 6e69      # Try to ini
+00019d80: 7469 616c 697a 6520 616e 6f74 6865 7220  tialize another 
+00019d90: 7374 6f72 6167 6520 7769 7468 2074 6865  storage with the
+00019da0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+00019db0: 6372 6561 7465 640a 2020 2020 2020 2020  created.        
+00019dc0: 2320 6162 6f76 652c 2062 7574 206e 6f77  # above, but now
+00019dd0: 2069 6e20 434f 5059 206d 6f64 652e 2054   in COPY mode. T
+00019de0: 6869 7320 7368 6f75 6c64 2073 7563 6365  his should succe
+00019df0: 6564 2e0a 2020 2020 2020 2020 7969 656c  ed..        yiel
+00019e00: 6420 6672 6f6d 2073 656c 662e 7969 656c  d from self.yiel
+00019e10: 645f 7374 6f72 6167 655f 6f62 6a65 6374  d_storage_object
+00019e20: 286e 616d 653d 7374 6f72 6167 655f 6e61  (name=storage_na
+00019e30: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00019e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e60: 206d 6f64 653d 7374 6f72 6167 655f 6c69   mode=storage_li
+00019e70: 622e 5374 6f72 6167 654d 6f64 652e 434f  b.StorageMode.CO
+00019e80: 5059 290a 0a20 2020 2040 7079 7465 7374  PY)..    @pytest
+00019e90: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
+00019ea0: 2074 6d70 5f61 7773 636c 695f 6275 636b   tmp_awscli_buck
+00019eb0: 6574 2873 656c 662c 2074 6d70 5f62 7563  et(self, tmp_buc
+00019ec0: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+00019ed0: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
+00019ee0: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
+00019ef0: 7573 696e 6720 6177 7363 6c69 0a20 2020  using awscli.   
+00019f00: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+00019f10: 6368 6563 6b5f 6361 6c6c 285b 2761 7773  check_call(['aws
+00019f20: 272c 2027 7333 272c 2027 6d62 272c 2066  ', 's3', 'mb', f
+00019f30: 2773 333a 2f2f 7b74 6d70 5f62 7563 6b65  's3://{tmp_bucke
+00019f40: 745f 6e61 6d65 7d27 5d29 0a20 2020 2020  t_name}']).     
+00019f50: 2020 2079 6965 6c64 2074 6d70 5f62 7563     yield tmp_buc
+00019f60: 6b65 745f 6e61 6d65 0a20 2020 2020 2020  ket_name.       
+00019f70: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00019f80: 6b5f 6361 6c6c 280a 2020 2020 2020 2020  k_call(.        
+00019f90: 2020 2020 5b27 6177 7327 2c20 2773 3327      ['aws', 's3'
+00019fa0: 2c20 2772 6227 2c20 6627 7333 3a2f 2f7b  , 'rb', f's3://{
+00019fb0: 746d 705f 6275 636b 6574 5f6e 616d 657d  tmp_bucket_name}
+00019fc0: 272c 2027 2d2d 666f 7263 6527 5d29 0a0a  ', '--force'])..
+00019fd0: 2020 2020 4070 7974 6573 742e 6669 7874      @pytest.fixt
+00019fe0: 7572 650a 2020 2020 6465 6620 746d 705f  ure.    def tmp_
+00019ff0: 6773 7574 696c 5f62 7563 6b65 7428 7365  gsutil_bucket(se
+0001a000: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
+0001a010: 616d 6529 3a0a 2020 2020 2020 2020 2320  ame):.        # 
+0001a020: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
+0001a030: 6172 7920 6275 636b 6574 2075 7369 6e67  ary bucket using
+0001a040: 2067 7375 7469 6c0a 2020 2020 2020 2020   gsutil.        
+0001a050: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001a060: 5f63 616c 6c28 5b27 6773 7574 696c 272c  _call(['gsutil',
+0001a070: 2027 6d62 272c 2066 2767 733a 2f2f 7b74   'mb', f'gs://{t
+0001a080: 6d70 5f62 7563 6b65 745f 6e61 6d65 7d27  mp_bucket_name}'
+0001a090: 5d29 0a20 2020 2020 2020 2079 6965 6c64  ]).        yield
+0001a0a0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0001a0b0: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
+0001a0c0: 6573 732e 6368 6563 6b5f 6361 6c6c 285b  ess.check_call([
+0001a0d0: 2767 7375 7469 6c27 2c20 2772 6d27 2c20  'gsutil', 'rm', 
+0001a0e0: 272d 7227 2c20 6627 6773 3a2f 2f7b 746d  '-r', f'gs://{tm
+0001a0f0: 705f 6275 636b 6574 5f6e 616d 657d 275d  p_bucket_name}']
+0001a100: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0001a110: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0001a120: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+0001a130: 5f72 3228 7365 6c66 2c20 746d 705f 6275  _r2(self, tmp_bu
+0001a140: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0001a150: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0001a160: 7465 6d70 6f72 6172 7920 6275 636b 6574  temporary bucket
+0001a170: 2075 7369 6e67 2061 7773 636c 690a 2020   using awscli.  
+0001a180: 2020 2020 2020 656e 6470 6f69 6e74 5f75        endpoint_u
+0001a190: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
+0001a1a0: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
+0001a1b0: 290a 2020 2020 2020 2020 7375 6270 726f  ).        subpro
+0001a1c0: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0001a1d0: 0a20 2020 2020 2020 2020 2020 2066 2741  .            f'A
+0001a1e0: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
+0001a1f0: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
+0001a200: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
+0001a210: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
+0001a220: 7333 206d 6220 7333 3a2f 2f7b 746d 705f  s3 mb s3://{tmp_
+0001a230: 6275 636b 6574 5f6e 616d 657d 202d 2d65  bucket_name} --e
+0001a240: 6e64 706f 696e 7420 7b65 6e64 706f 696e  ndpoint {endpoin
+0001a250: 745f 7572 6c7d 202d 2d70 726f 6669 6c65  t_url} --profile
+0001a260: 3d72 3227 2c0a 2020 2020 2020 2020 2020  =r2',.          
+0001a270: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
+0001a280: 2020 2020 2020 7969 656c 6420 746d 705f        yield tmp_
+0001a290: 6275 636b 6574 5f6e 616d 650a 2020 2020  bucket_name.    
+0001a2a0: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+0001a2b0: 6865 636b 5f63 616c 6c28 0a20 2020 2020  heck_call(.     
+0001a2c0: 2020 2020 2020 2066 2741 5753 5f53 4841         f'AWS_SHA
+0001a2d0: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+0001a2e0: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+0001a2f0: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+0001a300: 5041 5448 7d20 6177 7320 7333 2072 6220  PATH} aws s3 rb 
+0001a310: 7333 3a2f 2f7b 746d 705f 6275 636b 6574  s3://{tmp_bucket
+0001a320: 5f6e 616d 657d 202d 2d66 6f72 6365 202d  _name} --force -
+0001a330: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0001a340: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0001a350: 6c65 3d72 3227 2c0a 2020 2020 2020 2020  le=r2',.        
+0001a360: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0001a370: 0a20 2020 2040 7079 7465 7374 2e66 6978  .    @pytest.fix
+0001a380: 7475 7265 0a20 2020 2064 6566 2074 6d70  ture.    def tmp
+0001a390: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0001a3a0: 6f62 6a28 7365 6c66 2c20 7265 7175 6573  obj(self, reques
+0001a3b0: 7429 3a0a 2020 2020 2020 2020 2320 496e  t):.        # In
+0001a3c0: 6974 6961 6c69 7a65 7320 6120 7374 6f72  itializes a stor
+0001a3d0: 6167 6520 6f62 6a65 6374 2077 6974 6820  age object with 
+0001a3e0: 6120 7075 626c 6963 2062 7563 6b65 740a  a public bucket.
+0001a3f0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0001a400: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
+0001a410: 622e 5374 6f72 6167 6528 736f 7572 6365  b.Storage(source
+0001a420: 3d72 6571 7565 7374 2e70 6172 616d 290a  =request.param).
+0001a430: 2020 2020 2020 2020 7969 656c 6420 7374          yield st
+0001a440: 6f72 6167 655f 6f62 6a0a 2020 2020 2020  orage_obj.      
+0001a450: 2020 2320 5468 6973 2064 6f65 7320 6e6f    # This does no
+0001a460: 7420 7265 7175 6972 6520 616e 7920 6465  t require any de
+0001a470: 6c65 7469 6f6e 206c 6f67 6963 2062 6563  letion logic bec
+0001a480: 6175 7365 2069 7420 6973 2061 2070 7562  ause it is a pub
+0001a490: 6c69 6320 6275 636b 6574 0a20 2020 2020  lic bucket.     
+0001a4a0: 2020 2023 2061 6e64 2073 686f 756c 6420     # and should 
+0001a4b0: 6e6f 7420 6765 7420 6164 6465 6420 746f  not get added to
+0001a4c0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+0001a4d0: 7465 2e0a 0a20 2020 2040 7079 7465 7374  te...    @pytest
+0001a4e0: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+0001a4f0: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
+0001a500: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
+0001a510: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0001a520: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
+0001a530: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
+0001a540: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0001a550: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0001a560: 5374 6f72 6554 7970 652e 5232 2c20 6d61  StoreType.R2, ma
+0001a570: 726b 733d 7079 7465 7374 2e6d 6172 6b2e  rks=pytest.mark.
+0001a580: 636c 6f75 6466 6c61 7265 290a 2020 2020  cloudflare).    
+0001a590: 5d29 0a20 2020 2064 6566 2074 6573 745f  ]).    def test_
+0001a5a0: 6e65 775f 6275 636b 6574 5f63 7265 6174  new_bucket_creat
+0001a5b0: 696f 6e5f 616e 645f 6465 6c65 7469 6f6e  ion_and_deletion
+0001a5c0: 2873 656c 662c 2074 6d70 5f6c 6f63 616c  (self, tmp_local
+0001a5d0: 5f73 746f 7261 6765 5f6f 626a 2c0a 2020  _storage_obj,.  
+0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a600: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0001a610: 655f 7479 7065 293a 0a20 2020 2020 2020  e_type):.       
+0001a620: 2023 2043 7265 6174 6573 2061 206e 6577   # Creates a new
+0001a630: 2062 7563 6b65 7420 7769 7468 2061 206c   bucket with a l
+0001a640: 6f63 616c 2073 6f75 7263 652c 2075 706c  ocal source, upl
+0001a650: 6f61 6473 2066 696c 6573 2074 6f20 6974  oads files to it
+0001a660: 0a20 2020 2020 2020 2023 2061 6e64 2064  .        # and d
+0001a670: 656c 6574 6573 2069 742e 0a20 2020 2020  eletes it..     
+0001a680: 2020 2074 6d70 5f6c 6f63 616c 5f73 746f     tmp_local_sto
+0001a690: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0001a6a0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+0001a6b0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0001a6c0: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0001a6d0: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
+0001a6e0: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
+0001a6f0: 6e20 7468 6520 6f75 7470 7574 0a20 2020  n the output.   
+0001a700: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0001a710: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0001a720: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0001a730: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0001a740: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0001a750: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0001a760: 6a2e 6e61 6d65 2069 6e20 6f75 742e 6465  j.name in out.de
+0001a770: 636f 6465 2827 7574 662d 3827 290a 0a20  code('utf-8').. 
+0001a780: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0001a790: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
+0001a7a0: 746f 2064 656c 6574 6520 7468 6520 7374  to delete the st
+0001a7b0: 6f72 6167 6520 6f62 6a65 6374 0a20 2020  orage object.   
+0001a7c0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0001a7d0: 6368 6563 6b5f 6f75 7470 7574 280a 2020  check_output(.  
+0001a7e0: 2020 2020 2020 2020 2020 5b27 736b 7927            ['sky'
+0001a7f0: 2c20 2773 746f 7261 6765 272c 2027 6465  , 'storage', 'de
+0001a800: 6c65 7465 272c 2074 6d70 5f6c 6f63 616c  lete', tmp_local
+0001a810: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0001a820: 655d 290a 0a20 2020 2020 2020 2023 2052  e])..        # R
+0001a830: 756e 2073 6b79 2073 746f 7261 6765 206c  un sky storage l
+0001a840: 7320 746f 2063 6865 636b 2069 6620 7374  s to check if st
+0001a850: 6f72 6167 6520 6f62 6a65 6374 2069 7320  orage object is 
+0001a860: 6465 6c65 7465 640a 2020 2020 2020 2020  deleted.        
+0001a870: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+0001a880: 2e63 6865 636b 5f6f 7574 7075 7428 5b27  .check_output(['
+0001a890: 736b 7927 2c20 2773 746f 7261 6765 272c  sky', 'storage',
+0001a8a0: 2027 6c73 275d 290a 2020 2020 2020 2020   'ls']).        
+0001a8b0: 6173 7365 7274 2074 6d70 5f6c 6f63 616c  assert tmp_local
+0001a8c0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0001a8d0: 6520 6e6f 7420 696e 206f 7574 2e64 6563  e not in out.dec
+0001a8e0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
+0001a8f0: 2020 4070 7974 6573 742e 6d61 726b 2e78    @pytest.mark.x
+0001a900: 6469 7374 5f67 726f 7570 2827 6d75 6c74  dist_group('mult
+0001a910: 6970 6c65 5f62 7563 6b65 745f 6465 6c65  iple_bucket_dele
+0001a920: 7469 6f6e 2729 0a20 2020 2040 7079 7465  tion').    @pyte
+0001a930: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0001a940: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+0001a950: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+0001a960: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001a970: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+0001a980: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+0001a990: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+0001a9a0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+0001a9b0: 622e 5374 6f72 6554 7970 652e 5232 2c20  b.StoreType.R2, 
+0001a9c0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
+0001a9d0: 6b2e 636c 6f75 6466 6c61 7265 290a 2020  k.cloudflare).  
+0001a9e0: 2020 5d29 0a20 2020 2064 6566 2074 6573    ]).    def tes
+0001a9f0: 745f 6d75 6c74 6970 6c65 5f62 7563 6b65  t_multiple_bucke
+0001aa00: 7473 5f63 7265 6174 696f 6e5f 616e 645f  ts_creation_and_
+0001aa10: 6465 6c65 7469 6f6e 280a 2020 2020 2020  deletion(.      
+0001aa20: 2020 2020 2020 7365 6c66 2c20 746d 705f        self, tmp_
+0001aa30: 6d75 6c74 6970 6c65 5f73 6372 6174 6368  multiple_scratch
+0001aa40: 5f73 746f 7261 6765 5f6f 626a 2c20 7374  _storage_obj, st
+0001aa50: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
+0001aa60: 2020 2023 2043 7265 6174 6573 206d 756c     # Creates mul
+0001aa70: 7469 706c 6520 6e65 7720 6275 636b 6574  tiple new bucket
+0001aa80: 7328 3520 6275 636b 6574 7329 2077 6974  s(5 buckets) wit
+0001aa90: 6820 6120 6c6f 6361 6c20 736f 7572 6365  h a local source
+0001aaa0: 0a20 2020 2020 2020 2023 2061 6e64 2064  .        # and d
+0001aab0: 656c 6574 6573 2074 6865 6d2e 0a20 2020  eletes them..   
+0001aac0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0001aad0: 5f6e 616d 6520 3d20 5b5d 0a20 2020 2020  _name = [].     
+0001aae0: 2020 2066 6f72 2073 746f 7265 5f6f 626a     for store_obj
+0001aaf0: 2069 6e20 746d 705f 6d75 6c74 6970 6c65   in tmp_multiple
+0001ab00: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0001ab10: 5f6f 626a 3a0a 2020 2020 2020 2020 2020  _obj:.          
+0001ab20: 2020 7374 6f72 655f 6f62 6a2e 6164 645f    store_obj.add_
+0001ab30: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+0001ab40: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+0001ab50: 6f72 6167 655f 6f62 6a5f 6e61 6d65 2e61  orage_obj_name.a
+0001ab60: 7070 656e 6428 7374 6f72 655f 6f62 6a2e  ppend(store_obj.
+0001ab70: 6e61 6d65 290a 0a20 2020 2020 2020 2023  name)..        #
+0001ab80: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0001ab90: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0001aba0: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0001abb0: 6374 7320 6578 6973 7473 2069 6e20 7468  cts exists in th
+0001abc0: 650a 2020 2020 2020 2020 2320 6f75 7470  e.        # outp
+0001abd0: 7574 2066 696c 7465 7265 6420 6279 2073  ut filtered by s
+0001abe0: 746f 7265 2074 7970 650a 2020 2020 2020  tore type.      
+0001abf0: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0001ac00: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0001ac10: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0001ac20: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0001ac30: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0001ac40: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0001ac50: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0001ac60: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0001ac70: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0001ac80: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0001ac90: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0001aca0: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0001acb0: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0001acc0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0001acd0: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0001ace0: 6d20 696e 206f 7574 2066 6f72 2069 7465  m in out for ite
+0001acf0: 6d20 696e 2073 746f 7261 6765 5f6f 626a  m in storage_obj
+0001ad00: 5f6e 616d 655d 290a 0a20 2020 2020 2020  _name])..       
+0001ad10: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0001ad20: 6765 2064 656c 6574 6520 616c 6c20 746f  ge delete all to
+0001ad30: 2064 656c 6574 6520 616c 6c20 7374 6f72   delete all stor
+0001ad40: 6167 6520 6f62 6a65 6374 730a 2020 2020  age objects.    
+0001ad50: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+0001ad60: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0001ad70: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0001ad80: 6465 6c65 7465 272c 2027 2d61 275d 290a  delete', '-a']).
+0001ad90: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
+0001ada0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
+0001adb0: 2063 6865 636b 2069 6620 616c 6c20 7374   check if all st
+0001adc0: 6f72 6167 6520 6f62 6a65 6374 7320 6669  orage objects fi
+0001add0: 6c74 6572 6564 2062 7920 7374 6f72 650a  ltered by store.
+0001ade0: 2020 2020 2020 2020 2320 7479 7065 2061          # type a
+0001adf0: 7265 2064 656c 6574 6564 0a20 2020 2020  re deleted.     
+0001ae00: 2020 206f 7574 5f61 6c6c 203d 2073 7562     out_all = sub
+0001ae10: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+0001ae20: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
+0001ae30: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
+0001ae40: 2020 2020 2020 206f 7574 203d 205b 0a20         out = [. 
+0001ae50: 2020 2020 2020 2020 2020 2069 7465 6d2e             item.
+0001ae60: 7370 6c69 7428 295b 305d 0a20 2020 2020  split()[0].     
+0001ae70: 2020 2020 2020 2066 6f72 2069 7465 6d20         for item 
+0001ae80: 696e 206f 7574 5f61 6c6c 2e64 6563 6f64  in out_all.decod
+0001ae90: 6528 2775 7466 2d38 2729 2e73 706c 6974  e('utf-8').split
+0001aea0: 6c69 6e65 7328 290a 2020 2020 2020 2020  lines().        
+0001aeb0: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+0001aec0: 652e 7661 6c75 6520 696e 2069 7465 6d0a  e.value in item.
+0001aed0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0001aee0: 2020 6173 7365 7274 2061 6c6c 285b 6974    assert all([it
+0001aef0: 656d 206e 6f74 2069 6e20 6f75 7420 666f  em not in out fo
+0001af00: 7220 6974 656d 2069 6e20 7374 6f72 6167  r item in storag
+0001af10: 655f 6f62 6a5f 6e61 6d65 5d29 0a0a 2020  e_obj_name])..  
+0001af20: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+0001af30: 6172 616d 6574 7269 7a65 2827 7374 6f72  arametrize('stor
+0001af40: 655f 7479 7065 272c 205b 0a20 2020 2020  e_type', [.     
+0001af50: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
+0001af60: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
+0001af70: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0001af80: 7065 2e47 4353 2c0a 2020 2020 2020 2020  pe.GCS,.        
+0001af90: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
+0001afa0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0001afb0: 7065 2e52 322c 206d 6172 6b73 3d70 7974  pe.R2, marks=pyt
+0001afc0: 6573 742e 6d61 726b 2e63 6c6f 7564 666c  est.mark.cloudfl
+0001afd0: 6172 6529 0a20 2020 205d 290a 2020 2020  are).    ]).    
+0001afe0: 6465 6620 7465 7374 5f62 7563 6b65 745f  def test_bucket_
+0001aff0: 6578 7465 726e 616c 5f64 656c 6574 696f  external_deletio
+0001b000: 6e28 7365 6c66 2c20 746d 705f 7363 7261  n(self, tmp_scra
+0001b010: 7463 685f 7374 6f72 6167 655f 6f62 6a2c  tch_storage_obj,
+0001b020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b040: 2020 2020 2020 2073 746f 7265 5f74 7970         store_typ
+0001b050: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0001b060: 6561 7465 7320 6120 6275 636b 6574 2c20  eates a bucket, 
+0001b070: 6465 6c65 7465 7320 6974 2065 7874 6572  deletes it exter
+0001b080: 6e61 6c6c 7920 7573 696e 6720 636c 6f75  nally using clou
+0001b090: 6420 636c 6920 636f 6d6d 616e 6473 0a20  d cli commands. 
+0001b0a0: 2020 2020 2020 2023 2061 6e64 2074 6865         # and the
+0001b0b0: 6e20 7472 6965 7320 746f 2064 656c 6574  n tries to delet
+0001b0c0: 6520 6974 2075 7369 6e67 2073 6b79 2073  e it using sky s
+0001b0d0: 746f 7261 6765 2064 656c 6574 652e 0a20  torage delete.. 
+0001b0e0: 2020 2020 2020 2074 6d70 5f73 6372 6174         tmp_scrat
+0001b0f0: 6368 5f73 746f 7261 6765 5f6f 626a 2e61  ch_storage_obj.a
+0001b100: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
+0001b110: 7970 6529 0a0a 2020 2020 2020 2020 2320  ype)..        # 
+0001b120: 5275 6e20 736b 7920 7374 6f72 6167 6520  Run sky storage 
+0001b130: 6c73 2074 6f20 6368 6563 6b20 6966 2073  ls to check if s
+0001b140: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
+0001b150: 6973 7473 2069 6e20 7468 6520 6f75 7470  ists in the outp
+0001b160: 7574 0a20 2020 2020 2020 206f 7574 203d  ut.        out =
+0001b170: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0001b180: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
+0001b190: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
+0001b1a0: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
+0001b1b0: 7420 746d 705f 7363 7261 7463 685f 7374  t tmp_scratch_st
+0001b1c0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 2069  orage_obj.name i
+0001b1d0: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+0001b1e0: 662d 3827 290a 0a20 2020 2020 2020 2023  f-8')..        #
+0001b1f0: 2044 656c 6574 6520 6275 636b 6574 2065   Delete bucket e
+0001b200: 7874 6572 6e61 6c6c 790a 2020 2020 2020  xternally.      
+0001b210: 2020 636d 6420 3d20 7365 6c66 2e63 6c69    cmd = self.cli
+0001b220: 5f64 656c 6574 655f 636d 6428 7374 6f72  _delete_cmd(stor
+0001b230: 655f 7479 7065 2c20 746d 705f 7363 7261  e_type, tmp_scra
+0001b240: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
+0001b250: 6e61 6d65 290a 2020 2020 2020 2020 7375  name).        su
+0001b260: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+0001b270: 7574 7075 7428 636d 642c 2073 6865 6c6c  utput(cmd, shell
+0001b280: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+0001b290: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
+0001b2a0: 6520 6465 6c65 7465 2074 6f20 6465 6c65  e delete to dele
+0001b2b0: 7465 2074 6865 2073 746f 7261 6765 206f  te the storage o
+0001b2c0: 626a 6563 740a 2020 2020 2020 2020 6f75  bject.        ou
+0001b2d0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0001b2e0: 6865 636b 5f6f 7574 7075 7428 0a20 2020  heck_output(.   
+0001b2f0: 2020 2020 2020 2020 205b 2773 6b79 272c           ['sky',
+0001b300: 2027 7374 6f72 6167 6527 2c20 2764 656c   'storage', 'del
+0001b310: 6574 6527 2c20 746d 705f 7363 7261 7463  ete', tmp_scratc
+0001b320: 685f 7374 6f72 6167 655f 6f62 6a2e 6e61  h_storage_obj.na
+0001b330: 6d65 5d29 0a20 2020 2020 2020 2023 204d  me]).        # M
+0001b340: 616b 6520 7375 7265 2062 7563 6b65 7420  ake sure bucket 
+0001b350: 7761 7320 6e6f 7420 6372 6561 7465 6420  was not created 
+0001b360: 6475 7269 6e67 2064 656c 6574 696f 6e20  during deletion 
+0001b370: 2873 6565 2069 7373 7565 2023 3133 3232  (see issue #1322
+0001b380: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0001b390: 2027 6372 6561 7465 6427 206e 6f74 2069   'created' not i
+0001b3a0: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
+0001b3b0: 662d 3827 292e 6c6f 7765 7228 290a 0a20  f-8').lower().. 
+0001b3c0: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
+0001b3d0: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
+0001b3e0: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
+0001b3f0: 6f62 6a65 6374 2069 7320 6465 6c65 7465  object is delete
+0001b400: 640a 2020 2020 2020 2020 6f75 7420 3d20  d.        out = 
+0001b410: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001b420: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
+0001b430: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
+0001b440: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0001b450: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0001b460: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
+0001b470: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
+0001b480: 2775 7466 2d38 2729 0a0a 2020 2020 4070  'utf-8')..    @p
+0001b490: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
+0001b4a0: 6574 7269 7a65 2827 7374 6f72 655f 7479  etrize('store_ty
+0001b4b0: 7065 272c 205b 0a20 2020 2020 2020 2073  pe', [.        s
+0001b4c0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
+0001b4d0: 5479 7065 2e53 332c 2073 746f 7261 6765  Type.S3, storage
+0001b4e0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
+0001b4f0: 4353 2c0a 2020 2020 2020 2020 7079 7465  CS,.        pyte
+0001b500: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
+0001b510: 5f6c 6962 2e53 746f 7265 5479 7065 2e52  _lib.StoreType.R
+0001b520: 322c 206d 6172 6b73 3d70 7974 6573 742e  2, marks=pytest.
+0001b530: 6d61 726b 2e63 6c6f 7564 666c 6172 6529  mark.cloudflare)
+0001b540: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
+0001b550: 7465 7374 5f62 7563 6b65 745f 6275 6c6b  test_bucket_bulk
+0001b560: 5f64 656c 6574 696f 6e28 7365 6c66 2c20  _deletion(self, 
+0001b570: 7374 6f72 655f 7479 7065 2c20 746d 705f  store_type, tmp_
+0001b580: 6275 6c6b 5f64 656c 5f73 746f 7261 6765  bulk_del_storage
+0001b590: 5f6f 626a 293a 0a20 2020 2020 2020 2023  _obj):.        #
+0001b5a0: 2043 7265 6174 6573 2061 2074 656d 7020   Creates a temp 
+0001b5b0: 666f 6c64 6572 2077 6974 6820 6f76 6572  folder with over
+0001b5c0: 2032 3536 2066 696c 6573 2061 6e64 2066   256 files and f
+0001b5d0: 6f6c 6465 7273 2c20 7570 6c6f 6164 0a20  olders, upload. 
+0001b5e0: 2020 2020 2020 2023 2066 696c 6573 2061         # files a
+0001b5f0: 6e64 2066 6f6c 6465 7273 2074 6f20 6120  nd folders to a 
+0001b600: 6e65 7720 6275 636b 6574 2c20 7468 656e  new bucket, then
+0001b610: 2064 656c 6574 6520 6275 636b 6574 2e0a   delete bucket..
+0001b620: 2020 2020 2020 2020 746d 705f 6275 6c6b          tmp_bulk
+0001b630: 5f64 656c 5f73 746f 7261 6765 5f6f 626a  _del_storage_obj
+0001b640: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
+0001b650: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
+0001b660: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001b670: 5f6f 7574 7075 7428 0a20 2020 2020 2020  _output(.       
+0001b680: 2020 2020 205b 2773 6b79 272c 2027 7374       ['sky', 'st
+0001b690: 6f72 6167 6527 2c20 2764 656c 6574 6527  orage', 'delete'
+0001b6a0: 2c20 746d 705f 6275 6c6b 5f64 656c 5f73  , tmp_bulk_del_s
+0001b6b0: 746f 7261 6765 5f6f 626a 2e6e 616d 655d  torage_obj.name]
+0001b6c0: 290a 0a20 2020 2020 2020 206f 7574 7075  )..        outpu
+0001b6d0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0001b6e0: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0001b6f0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0001b700: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0001b710: 7365 7274 2074 6d70 5f62 756c 6b5f 6465  sert tmp_bulk_de
+0001b720: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0001b730: 6d65 206e 6f74 2069 6e20 6f75 7470 7574  me not in output
+0001b740: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0001b750: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
+0001b760: 726b 2e70 6172 616d 6574 7269 7a65 280a  rk.parametrize(.
+0001b770: 2020 2020 2020 2020 2774 6d70 5f70 7562          'tmp_pub
+0001b780: 6c69 635f 7374 6f72 6167 655f 6f62 6a2c  lic_storage_obj,
+0001b790: 2073 746f 7265 5f74 7970 6527 2c0a 2020   store_type',.  
+0001b7a0: 2020 2020 2020 5b28 2773 333a 2f2f 7463        [('s3://tc
+0001b7b0: 6761 2d32 2d6f 7065 6e27 2c20 7374 6f72  ga-2-open', stor
+0001b7c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001b7d0: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+0001b7e0: 2827 7333 3a2f 2f64 6967 6974 616c 636f  ('s3://digitalco
+0001b7f0: 7270 6f72 6127 2c20 7374 6f72 6167 655f  rpora', storage_
+0001b800: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0001b810: 292c 0a20 2020 2020 2020 2020 2827 6773  ),.         ('gs
+0001b820: 3a2f 2f67 6370 2d70 7562 6c69 632d 6461  ://gcp-public-da
+0001b830: 7461 2d73 656e 7469 6e65 6c2d 3227 2c20  ta-sentinel-2', 
+0001b840: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001b850: 6554 7970 652e 4743 5329 5d2c 0a20 2020  eType.GCS)],.   
+0001b860: 2020 2020 2069 6e64 6972 6563 743d 5b27       indirect=['
+0001b870: 746d 705f 7075 626c 6963 5f73 746f 7261  tmp_public_stora
+0001b880: 6765 5f6f 626a 275d 290a 2020 2020 6465  ge_obj']).    de
+0001b890: 6620 7465 7374 5f70 7562 6c69 635f 6275  f test_public_bu
+0001b8a0: 636b 6574 2873 656c 662c 2074 6d70 5f70  cket(self, tmp_p
+0001b8b0: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
+0001b8c0: 6a2c 2073 746f 7265 5f74 7970 6529 3a0a  j, store_type):.
+0001b8d0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0001b8e0: 7320 6120 6e65 7720 6275 636b 6574 2077  s a new bucket w
+0001b8f0: 6974 6820 6120 7075 626c 6963 2073 6f75  ith a public sou
+0001b900: 7263 6520 616e 6420 7665 7269 6669 6573  rce and verifies
+0001b910: 2074 6861 7420 6974 2069 7320 6e6f 740a   that it is not.
+0001b920: 2020 2020 2020 2020 2320 6164 6465 6420          # added 
+0001b930: 746f 2067 6c6f 6261 6c5f 7573 6572 5f73  to global_user_s
+0001b940: 7461 7465 2e0a 2020 2020 2020 2020 746d  tate..        tm
+0001b950: 705f 7075 626c 6963 5f73 746f 7261 6765  p_public_storage
+0001b960: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+0001b970: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+0001b980: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
+0001b990: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
+0001b9a0: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
+0001b9b0: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
+0001b9c0: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
+0001b9d0: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0001b9e0: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0001b9f0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0001ba00: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0001ba10: 2061 7373 6572 7420 746d 705f 7075 626c   assert tmp_publ
+0001ba20: 6963 5f73 746f 7261 6765 5f6f 626a 2e6e  ic_storage_obj.n
+0001ba30: 616d 6520 6e6f 7420 696e 206f 7574 2e64  ame not in out.d
+0001ba40: 6563 6f64 6528 2775 7466 2d38 2729 0a0a  ecode('utf-8')..
+0001ba50: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0001ba60: 2e70 6172 616d 6574 7269 7a65 2827 6e6f  .parametrize('no
+0001ba70: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+0001ba80: 6c27 2c20 5b0a 2020 2020 2020 2020 2773  l', [.        's
+0001ba90: 333a 2f2f 7b72 616e 646f 6d5f 6e61 6d65  3://{random_name
+0001baa0: 7d27 2c20 2767 733a 2f2f 7b72 616e 646f  }', 'gs://{rando
+0001bab0: 6d5f 6e61 6d65 7d27 2c0a 2020 2020 2020  m_name}',.      
+0001bac0: 2020 7079 7465 7374 2e70 6172 616d 2827    pytest.param('
+0001bad0: 7232 3a2f 2f7b 7261 6e64 6f6d 5f6e 616d  r2://{random_nam
+0001bae0: 657d 272c 206d 6172 6b73 3d70 7974 6573  e}', marks=pytes
+0001baf0: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0001bb00: 6529 0a20 2020 205d 290a 2020 2020 6465  e).    ]).    de
+0001bb10: 6620 7465 7374 5f6e 6f6e 6578 6973 7465  f test_nonexiste
+0001bb20: 6e74 5f62 7563 6b65 7428 7365 6c66 2c20  nt_bucket(self, 
+0001bb30: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+0001bb40: 7572 6c29 3a0a 2020 2020 2020 2020 2320  url):.        # 
+0001bb50: 4174 7465 6d70 7473 2074 6f20 6372 6561  Attempts to crea
+0001bb60: 7465 2066 6574 6368 2061 2073 7472 6f61  te fetch a stroa
+0001bb70: 6765 2077 6974 6820 6120 6e6f 6e2d 6578  ge with a non-ex
+0001bb80: 6973 7465 6e74 2073 6f75 7263 652e 0a20  istent source.. 
+0001bb90: 2020 2020 2020 2023 2047 656e 6572 6174         # Generat
+0001bba0: 6520 6120 7261 6e64 6f6d 2062 7563 6b65  e a random bucke
+0001bbb0: 7420 6e61 6d65 2061 6e64 2076 6572 6966  t name and verif
+0001bbc0: 7920 6974 2064 6f65 736e 2774 2065 7869  y it doesn't exi
+0001bbd0: 7374 3a0a 2020 2020 2020 2020 7265 7472  st:.        retr
+0001bbe0: 795f 636f 756e 7420 3d20 300a 2020 2020  y_count = 0.    
+0001bbf0: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+0001bc00: 2020 2020 2020 2020 2020 2020 6e6f 6e65              none
+0001bc10: 7869 7374 5f62 7563 6b65 745f 6e61 6d65  xist_bucket_name
+0001bc20: 203d 2073 7472 2875 7569 642e 7575 6964   = str(uuid.uuid
+0001bc30: 3428 2929 0a20 2020 2020 2020 2020 2020  4()).           
+0001bc40: 2069 6620 6e6f 6e65 7869 7374 5f62 7563   if nonexist_buc
+0001bc50: 6b65 745f 7572 6c2e 7374 6172 7473 7769  ket_url.startswi
+0001bc60: 7468 2827 7333 2729 3a0a 2020 2020 2020  th('s3'):.      
+0001bc70: 2020 2020 2020 2020 2020 636f 6d6d 616e            comman
+0001bc80: 6420 3d20 6627 6177 7320 7333 6170 6920  d = f'aws s3api 
+0001bc90: 6865 6164 2d62 7563 6b65 7420 2d2d 6275  head-bucket --bu
+0001bca0: 636b 6574 207b 6e6f 6e65 7869 7374 5f62  cket {nonexist_b
+0001bcb0: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
+0001bcc0: 2020 2020 2020 2020 2020 2020 2065 7870               exp
+0001bcd0: 6563 7465 645f 6f75 7470 7574 203d 2027  ected_output = '
+0001bce0: 3430 3427 0a20 2020 2020 2020 2020 2020  404'.           
+0001bcf0: 2065 6c69 6620 6e6f 6e65 7869 7374 5f62   elif nonexist_b
+0001bd00: 7563 6b65 745f 7572 6c2e 7374 6172 7473  ucket_url.starts
+0001bd10: 7769 7468 2827 6773 2729 3a0a 2020 2020  with('gs'):.    
+0001bd20: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+0001bd30: 616e 6420 3d20 6627 6773 7574 696c 206c  and = f'gsutil l
+0001bd40: 7320 7b6e 6f6e 6578 6973 745f 6275 636b  s {nonexist_buck
+0001bd50: 6574 5f75 726c 2e66 6f72 6d61 7428 7261  et_url.format(ra
+0001bd60: 6e64 6f6d 5f6e 616d 653d 6e6f 6e65 7869  ndom_name=nonexi
+0001bd70: 7374 5f62 7563 6b65 745f 6e61 6d65 297d  st_bucket_name)}
+0001bd80: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001bd90: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
+0001bda0: 7420 3d20 2742 7563 6b65 744e 6f74 466f  t = 'BucketNotFo
+0001bdb0: 756e 6445 7863 6570 7469 6f6e 270a 2020  undException'.  
+0001bdc0: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+0001bdd0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+0001bde0: 726c 2e73 7461 7274 7377 6974 6828 2772  rl.startswith('r
+0001bdf0: 3227 293a 0a20 2020 2020 2020 2020 2020  2'):.           
+0001be00: 2020 2020 2065 6e64 706f 696e 745f 7572       endpoint_ur
+0001be10: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
+0001be20: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
+0001be30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be40: 2063 6f6d 6d61 6e64 203d 2066 2741 5753   command = f'AWS
+0001be50: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0001be60: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0001be70: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0001be80: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0001be90: 6170 6920 6865 6164 2d62 7563 6b65 7420  api head-bucket 
+0001bea0: 2d2d 6275 636b 6574 207b 6e6f 6e65 7869  --bucket {nonexi
+0001beb0: 7374 5f62 7563 6b65 745f 6e61 6d65 7d20  st_bucket_name} 
+0001bec0: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
+0001bed0: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
+0001bee0: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
+0001bef0: 2020 2020 2020 2020 6578 7065 6374 6564          expected
+0001bf00: 5f6f 7574 7075 7420 3d20 2734 3034 270a  _output = '404'.
+0001bf10: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001bf20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bf30: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0001bf40: 6f72 2827 556e 7375 7070 6f72 7465 6420  or('Unsupported 
+0001bf50: 6275 636b 6574 2074 7970 6520 270a 2020  bucket type '.  
+0001bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001bf80: 277b 6e6f 6e65 7869 7374 5f62 7563 6b65  '{nonexist_bucke
+0001bf90: 745f 7572 6c7d 2729 0a0a 2020 2020 2020  t_url}')..      
+0001bfa0: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
+0001bfb0: 2062 7563 6b65 7420 6578 6973 7473 2075   bucket exists u
+0001bfc0: 7369 6e67 2074 6865 2063 6c69 3a0a 2020  sing the cli:.  
+0001bfd0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0001bfe0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001bff0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0001c000: 6368 6563 6b5f 6f75 7470 7574 2863 6f6d  check_output(com
+0001c010: 6d61 6e64 2c0a 2020 2020 2020 2020 2020  mand,.          
+0001c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c040: 2020 2020 7374 6465 7272 3d73 7562 7072      stderr=subpr
+0001c050: 6f63 6573 732e 5354 444f 5554 2c0a 2020  ocess.STDOUT,.  
+0001c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c080: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+0001c090: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0001c0a0: 2020 2020 6578 6365 7074 2073 7562 7072      except subpr
+0001c0b0: 6f63 6573 732e 4361 6c6c 6564 5072 6f63  ocess.CalledProc
+0001c0c0: 6573 7345 7272 6f72 2061 7320 653a 0a20  essError as e:. 
+0001c0d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001c0e0: 7574 203d 2065 2e6f 7574 7075 740a 2020  ut = e.output.  
+0001c0f0: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
+0001c100: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0001c110: 3827 290a 2020 2020 2020 2020 2020 2020  8').            
+0001c120: 6966 2065 7870 6563 7465 645f 6f75 7470  if expected_outp
+0001c130: 7574 2069 6e20 6f75 743a 0a20 2020 2020  ut in out:.     
+0001c140: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0001c150: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001c160: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001c170: 2020 2072 6574 7279 5f63 6f75 6e74 202b     retry_count +
+0001c180: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0001c190: 2020 2020 6966 2072 6574 7279 5f63 6f75      if retry_cou
+0001c1a0: 6e74 203e 2033 3a0a 2020 2020 2020 2020  nt > 3:.        
+0001c1b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001c1c0: 6520 5275 6e74 696d 6545 7272 6f72 2827  e RuntimeError('
+0001c1d0: 556e 6162 6c65 2074 6f20 6669 6e64 2061  Unable to find a
+0001c1e0: 206e 6f6e 6578 6973 7465 6e74 2062 7563   nonexistent buc
+0001c1f0: 6b65 7420 270a 2020 2020 2020 2020 2020  ket '.          
+0001c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c210: 2020 2020 2020 2020 2020 2020 2027 746f               'to
+0001c220: 2075 7365 2e20 5468 6973 2069 7320 6869   use. This is hi
+0001c230: 676c 7920 756e 6c69 6b65 6c79 202d 2027  gly unlikely - '
+0001c240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c260: 2020 2020 2020 2020 2763 6865 636b 2069          'check i
+0001c270: 6620 7468 6520 7465 7374 7320 6172 6520  f the tests are 
+0001c280: 636f 7272 6563 742e 2729 0a0a 2020 2020  correct.')..    
+0001c290: 2020 2020 7769 7468 2070 7974 6573 742e      with pytest.
+0001c2a0: 7261 6973 6573 280a 2020 2020 2020 2020  raises(.        
+0001c2b0: 2020 2020 2020 2020 736b 792e 6578 6365          sky.exce
+0001c2c0: 7074 696f 6e73 2e53 746f 7261 6765 4275  ptions.StorageBu
+0001c2d0: 636b 6574 4765 7445 7272 6f72 2c0a 2020  cketGetError,.  
+0001c2e0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0001c2f0: 7463 683d 2741 7474 656d 7074 6564 2074  tch='Attempted t
+0001c300: 6f20 636f 6e6e 6563 7420 746f 2061 206e  o connect to a n
+0001c310: 6f6e 2d65 7869 7374 656e 7420 6275 636b  on-existent buck
+0001c320: 6574 2729 3a0a 2020 2020 2020 2020 2020  et'):.          
+0001c330: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+0001c340: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001c350: 6167 6528 736f 7572 6365 3d6e 6f6e 6578  age(source=nonex
+0001c360: 6973 745f 6275 636b 6574 5f75 726c 2e66  ist_bucket_url.f
+0001c370: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
+0001c380: 2020 2020 2020 2072 616e 646f 6d5f 6e61         random_na
+0001c390: 6d65 3d6e 6f6e 6578 6973 745f 6275 636b  me=nonexist_buck
+0001c3a0: 6574 5f6e 616d 6529 290a 0a20 2020 2040  et_name))..    @
+0001c3b0: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+0001c3c0: 6d65 7472 697a 6528 2770 7269 7661 7465  metrize('private
+0001c3d0: 5f62 7563 6b65 7427 2c0a 2020 2020 2020  _bucket',.      
+0001c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3f0: 2020 2020 2020 205b 6627 7333 3a2f 2f69         [f's3://i
+0001c400: 6d61 6765 6e65 7427 2c20 6627 6773 3a2f  magenet', f'gs:/
+0001c410: 2f69 6d61 6765 6e65 7427 5d29 0a20 2020  /imagenet']).   
+0001c420: 2064 6566 2074 6573 745f 7072 6976 6174   def test_privat
+0001c430: 655f 6275 636b 6574 2873 656c 662c 2070  e_bucket(self, p
+0001c440: 7269 7661 7465 5f62 7563 6b65 7429 3a0a  rivate_bucket):.
+0001c450: 2020 2020 2020 2020 2320 4174 7465 6d70          # Attemp
+0001c460: 7473 2074 6f20 6163 6365 7373 2070 7269  ts to access pri
+0001c470: 7661 7465 2062 7563 6b65 7473 206e 6f74  vate buckets not
+0001c480: 2062 656c 6f6e 6769 6e67 2074 6f20 7468   belonging to th
+0001c490: 6520 7573 6572 2e0a 2020 2020 2020 2020  e user..        
+0001c4a0: 2320 5468 6573 6520 6275 636b 6574 7320  # These buckets 
+0001c4b0: 6172 6520 6b6e 6f77 6e20 746f 2062 6520  are known to be 
+0001c4c0: 7072 6976 6174 652c 2062 7574 206d 6179  private, but may
+0001c4d0: 206e 6565 6420 746f 2062 6520 7570 6461   need to be upda
+0001c4e0: 7465 6420 6966 0a20 2020 2020 2020 2023  ted if.        #
+0001c4f0: 2074 6865 7920 6172 6520 7265 6d6f 7665   they are remove
+0001c500: 6420 6279 2074 6865 6972 206f 776e 6572  d by their owner
+0001c510: 732e 0a20 2020 2020 2020 2070 7269 7661  s..        priva
+0001c520: 7465 5f62 7563 6b65 745f 6e61 6d65 203d  te_bucket_name =
+0001c530: 2075 726c 6c69 622e 7061 7273 652e 7572   urllib.parse.ur
+0001c540: 6c73 706c 6974 2870 7269 7661 7465 5f62  lsplit(private_b
+0001c550: 7563 6b65 7429 2e6e 6574 6c6f 630a 2020  ucket).netloc.  
+0001c560: 2020 2020 2020 7769 7468 2070 7974 6573        with pytes
+0001c570: 742e 7261 6973 6573 280a 2020 2020 2020  t.raises(.      
+0001c580: 2020 2020 2020 2020 2020 736b 792e 6578            sky.ex
+0001c590: 6365 7074 696f 6e73 2e53 746f 7261 6765  ceptions.Storage
+0001c5a0: 4275 636b 6574 4765 7445 7272 6f72 2c0a  BucketGetError,.
+0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5c0: 6d61 7463 683d 7374 6f72 6167 655f 6c69  match=storage_li
+0001c5d0: 622e 5f42 5543 4b45 545f 4641 494c 5f54  b._BUCKET_FAIL_T
+0001c5e0: 4f5f 434f 4e4e 4543 545f 4d45 5353 4147  O_CONNECT_MESSAG
+0001c5f0: 452e 666f 726d 6174 280a 2020 2020 2020  E.format(.      
+0001c600: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+0001c610: 6d65 3d70 7269 7661 7465 5f62 7563 6b65  me=private_bucke
+0001c620: 745f 6e61 6d65 2929 3a0a 2020 2020 2020  t_name)):.      
+0001c630: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0001c640: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0001c650: 5374 6f72 6167 6528 736f 7572 6365 3d70  Storage(source=p
+0001c660: 7269 7661 7465 5f62 7563 6b65 7429 0a0a  rivate_bucket)..
+0001c670: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+0001c680: 2e70 6172 616d 6574 7269 7a65 2827 6578  .parametrize('ex
+0001c690: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
+0001c6a0: 2c20 7374 6f72 655f 7479 7065 272c 0a20  , store_type',. 
+0001c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c6c0: 2020 2020 2020 2020 2020 2020 5b28 2774              [('t
+0001c6d0: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+0001c6e0: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
+0001c6f0: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
+0001c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c710: 2020 2020 2020 2020 2020 2020 2827 746d              ('tm
+0001c720: 705f 6773 7574 696c 5f62 7563 6b65 7427  p_gsutil_bucket'
+0001c730: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0001c740: 6f72 6554 7970 652e 4743 5329 2c0a 2020  oreType.GCS),.  
+0001c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c760: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
+0001c770: 7374 2e70 6172 616d 2827 746d 705f 6177  st.param('tmp_aw
+0001c780: 7363 6c69 5f62 7563 6b65 745f 7232 272c  scli_bucket_r2',
+0001c790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c7b0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0001c7c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0001c7d0: 652e 5232 2c0a 2020 2020 2020 2020 2020  e.R2,.          
+0001c7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c800: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+0001c810: 726b 2e63 6c6f 7564 666c 6172 6529 5d29  rk.cloudflare)])
+0001c820: 0a20 2020 2064 6566 2074 6573 745f 7570  .    def test_up
+0001c830: 6c6f 6164 5f74 6f5f 6578 6973 7469 6e67  load_to_existing
+0001c840: 5f62 7563 6b65 7428 7365 6c66 2c20 6578  _bucket(self, ex
+0001c850: 745f 6275 636b 6574 5f66 6978 7475 7265  t_bucket_fixture
+0001c860: 2c20 7265 7175 6573 742c 0a20 2020 2020  , request,.     
+0001c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c890: 2020 746d 705f 736f 7572 6365 2c20 7374    tmp_source, st
+0001c8a0: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
+0001c8b0: 2020 2023 2054 7269 6573 2075 706c 6f61     # Tries uploa
+0001c8c0: 6469 6e67 2065 7869 7374 696e 6720 6669  ding existing fi
+0001c8d0: 6c65 7320 746f 206e 6577 6c79 2063 7265  les to newly cre
+0001c8e0: 6174 6564 2062 7563 6b65 7420 286f 7574  ated bucket (out
+0001c8f0: 7369 6465 206f 660a 2020 2020 2020 2020  side of.        
+0001c900: 2320 736b 7929 2061 6e64 2076 6572 6966  # sky) and verif
+0001c910: 6965 7320 7468 6174 2066 696c 6573 2061  ies that files a
+0001c920: 7265 2077 7269 7474 656e 2e0a 2020 2020  re written..    
+0001c930: 2020 2020 6275 636b 6574 5f6e 616d 6520      bucket_name 
+0001c940: 3d20 7265 7175 6573 742e 6765 7466 6978  = request.getfix
+0001c950: 7475 7265 7661 6c75 6528 6578 745f 6275  turevalue(ext_bu
+0001c960: 636b 6574 5f66 6978 7475 7265 290a 2020  cket_fixture).  
+0001c970: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+0001c980: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+0001c990: 5374 6f72 6167 6528 6e61 6d65 3d62 7563  Storage(name=buc
+0001c9a0: 6b65 745f 6e61 6d65 2c20 736f 7572 6365  ket_name, source
+0001c9b0: 3d74 6d70 5f73 6f75 7263 6529 0a20 2020  =tmp_source).   
+0001c9c0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0001c9d0: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
+0001c9e0: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
+0001c9f0: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
+0001ca00: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
+0001ca10: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
+0001ca20: 6b65 7420 7573 696e 6720 6177 7320 636c  ket using aws cl
+0001ca30: 690a 2020 2020 2020 2020 6f75 7420 3d20  i.        out = 
+0001ca40: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001ca50: 5f6f 7574 7075 7428 7365 6c66 2e63 6c69  _output(self.cli
+0001ca60: 5f6c 735f 636d 6428 7374 6f72 655f 7479  _ls_cmd(store_ty
+0001ca70: 7065 2c20 6275 636b 6574 5f6e 616d 6529  pe, bucket_name)
+0001ca80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001caa0: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
+0001cab0: 7565 290a 2020 2020 2020 2020 6173 7365  ue).        asse
+0001cac0: 7274 2027 746d 702d 6669 6c65 2720 696e  rt 'tmp-file' in
+0001cad0: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+0001cae0: 2d38 2729 2c20 5c0a 2020 2020 2020 2020  -8'), \.        
+0001caf0: 2020 2020 2746 696c 6520 6e6f 7420 666f      'File not fo
+0001cb00: 756e 6420 696e 2062 7563 6b65 7420 2d20  und in bucket - 
+0001cb10: 6f75 7470 7574 2077 6173 203a 207b 7d27  output was : {}'
+0001cb20: 2e66 6f72 6d61 7428 6f75 742e 6465 636f  .format(out.deco
+0001cb30: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
+0001cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb70: 2020 2028 2775 7466 2d38 2729 290a 0a20     ('utf-8')).. 
+0001cb80: 2020 2020 2020 2023 2043 6865 636b 2073         # Check s
+0001cb90: 796d 6c69 6e6b 7320 2d20 7379 6d6c 696e  ymlinks - symlin
+0001cba0: 6b73 2064 6f6e 2774 2067 6574 2063 6f70  ks don't get cop
+0001cbb0: 6965 6420 6279 2073 6b79 2073 746f 7261  ied by sky stora
+0001cbc0: 6765 0a20 2020 2020 2020 2061 7373 6572  ge.        asser
+0001cbd0: 7420 2870 6174 686c 6962 2e50 6174 6828  t (pathlib.Path(
+0001cbe0: 746d 705f 736f 7572 6365 2920 2f20 2763  tmp_source) / 'c
+0001cbf0: 6972 636c 652d 6c69 6e6b 2729 2e69 735f  ircle-link').is_
+0001cc00: 7379 6d6c 696e 6b28 292c 2028 0a20 2020  symlink(), (.   
+0001cc10: 2020 2020 2020 2020 2027 6369 7263 6c65           'circle
+0001cc20: 2d6c 696e 6b20 7761 7320 6e6f 7420 666f  -link was not fo
+0001cc30: 756e 6420 696e 2074 6865 2075 706c 6f61  und in the uploa
+0001cc40: 6420 736f 7572 6365 202d 2027 0a20 2020  d source - '.   
+0001cc50: 2020 2020 2020 2020 2027 6172 6520 7468           'are th
+0001cc60: 6520 7465 7374 2066 6978 7475 7265 7320  e test fixtures 
+0001cc70: 636f 7272 6563 743f 2729 0a20 2020 2020  correct?').     
+0001cc80: 2020 2061 7373 6572 7420 2763 6972 636c     assert 'circl
+0001cc90: 652d 6c69 6e6b 2720 6e6f 7420 696e 206f  e-link' not in o
+0001cca0: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+0001ccb0: 2729 2c20 280a 2020 2020 2020 2020 2020  '), (.          
+0001ccc0: 2020 2753 796d 6c69 6e6b 2066 6f75 6e64    'Symlink found
+0001ccd0: 2069 6e20 6275 636b 6574 202d 206c 7320   in bucket - ls 
+0001cce0: 6f75 7470 7574 2077 6173 203a 207b 7d27  output was : {}'
+0001ccf0: 2e66 6f72 6d61 7428 0a20 2020 2020 2020  .format(.       
+0001cd00: 2020 2020 2020 2020 206f 7574 2e64 6563           out.dec
+0001cd10: 6f64 6528 2775 7466 2d38 2729 2929 0a0a  ode('utf-8')))..
+0001cd20: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+0001cd30: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+0001cd40: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
+0001cd50: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
+0001cd60: 6e20 7468 6520 6f75 7470 7574 2e0a 2020  n the output..  
+0001cd70: 2020 2020 2020 2320 4974 2073 686f 756c        # It shoul
+0001cd80: 6420 6e6f 7420 6578 6973 7420 6265 6361  d not exist beca
+0001cd90: 7573 6520 7468 6520 6275 636b 6574 2077  use the bucket w
+0001cda0: 6173 2063 7265 6174 6564 2065 7874 6572  as created exter
+0001cdb0: 6e61 6c6c 792e 0a20 2020 2020 2020 206f  nally..        o
+0001cdc0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
+0001cdd0: 6368 6563 6b5f 6f75 7470 7574 285b 2773  check_output(['s
+0001cde0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0001cdf0: 276c 7327 5d29 0a20 2020 2020 2020 2061  'ls']).        a
+0001ce00: 7373 6572 7420 7374 6f72 6167 655f 6f62  ssert storage_ob
+0001ce10: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+0001ce20: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0001ce30: 290a 0a20 2020 2064 6566 2074 6573 745f  )..    def test_
+0001ce40: 636f 7079 5f6d 6f75 6e74 5f65 7869 7374  copy_mount_exist
+0001ce50: 696e 675f 7374 6f72 6167 6528 7365 6c66  ing_storage(self
+0001ce60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce80: 2020 2020 2020 2020 2020 2074 6d70 5f63             tmp_c
+0001ce90: 6f70 795f 6d6e 745f 6578 6973 7469 6e67  opy_mnt_existing
+0001cea0: 5f73 746f 7261 6765 5f6f 626a 293a 0a20  _storage_obj):. 
+0001ceb0: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0001cec0: 2061 2062 7563 6b65 7420 7769 7468 206e   a bucket with n
+0001ced0: 6f20 736f 7572 6365 2069 6e20 4d4f 554e  o source in MOUN
+0001cee0: 5420 6d6f 6465 2028 656d 7074 7920 6275  T mode (empty bu
+0001cef0: 636b 6574 292c 2061 6e64 0a20 2020 2020  cket), and.     
+0001cf00: 2020 2023 2074 6865 6e20 7472 6965 7320     # then tries 
+0001cf10: 746f 206c 6f61 6420 7468 6520 7361 6d65  to load the same
+0001cf20: 2073 746f 7261 6765 2069 6e20 434f 5059   storage in COPY
+0001cf30: 206d 6f64 652e 0a20 2020 2020 2020 2074   mode..        t
+0001cf40: 6d70 5f63 6f70 795f 6d6e 745f 6578 6973  mp_copy_mnt_exis
+0001cf50: 7469 6e67 5f73 746f 7261 6765 5f6f 626a  ting_storage_obj
+0001cf60: 2e61 6464 5f73 746f 7265 2873 746f 7261  .add_store(stora
+0001cf70: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0001cf80: 2e53 3329 0a20 2020 2020 2020 2073 746f  .S3).        sto
+0001cf90: 7261 6765 5f6e 616d 6520 3d20 746d 705f  rage_name = tmp_
+0001cfa0: 636f 7079 5f6d 6e74 5f65 7869 7374 696e  copy_mnt_existin
+0001cfb0: 675f 7374 6f72 6167 655f 6f62 6a2e 6e61  g_storage_obj.na
+0001cfc0: 6d65 0a0a 2020 2020 2020 2020 2320 4368  me..        # Ch
+0001cfd0: 6563 6b20 6073 6b79 2073 746f 7261 6765  eck `sky storage
+0001cfe0: 206c 7360 2074 6f20 656e 7375 7265 2073   ls` to ensure s
+0001cff0: 746f 7261 6765 206f 626a 6563 7420 6578  torage object ex
+0001d000: 6973 7473 0a20 2020 2020 2020 206f 7574  ists.        out
+0001d010: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0001d020: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0001d030: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0001d040: 7327 5d29 2e64 6563 6f64 6528 2775 7466  s']).decode('utf
+0001d050: 2d38 2729 0a20 2020 2020 2020 2061 7373  -8').        ass
+0001d060: 6572 7420 7374 6f72 6167 655f 6e61 6d65  ert storage_name
+0001d070: 2069 6e20 6f75 742c 2066 2753 746f 7261   in out, f'Stora
+0001d080: 6765 207b 7374 6f72 6167 655f 6e61 6d65  ge {storage_name
+0001d090: 7d20 6e6f 7420 666f 756e 6420 696e 2073  } not found in s
+0001d0a0: 6b79 2073 746f 7261 6765 206c 732e 270a  ky storage ls.'.
+0001d0b0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+0001d0c0: 6b2e 7061 7261 6d65 7472 697a 6528 2773  k.parametrize('s
+0001d0d0: 746f 7265 5f74 7970 6527 2c20 5b0a 2020  tore_type', [.  
+0001d0e0: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+0001d0f0: 622e 5374 6f72 6554 7970 652e 5333 2c20  b.StoreType.S3, 
+0001d100: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001d110: 6554 7970 652e 4743 532c 0a20 2020 2020  eType.GCS,.     
+0001d120: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0001d130: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001d140: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0001d150: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0001d160: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0001d170: 2020 2064 6566 2074 6573 745f 6c69 7374     def test_list
+0001d180: 5f73 6f75 7263 6528 7365 6c66 2c20 746d  _source(self, tm
+0001d190: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
+0001d1a0: 7261 6765 5f6f 626a 2c20 7374 6f72 655f  rage_obj, store_
+0001d1b0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0001d1c0: 2055 7365 7320 6120 6c69 7374 2069 6e20   Uses a list in 
+0001d1d0: 7468 6520 736f 7572 6365 2066 6965 6c64  the source field
+0001d1e0: 2074 6f20 7370 6563 6966 7920 6120 6669   to specify a fi
+0001d1f0: 6c65 2061 6e64 2061 2064 6972 6563 746f  le and a directo
+0001d200: 7279 2074 6f0a 2020 2020 2020 2020 2320  ry to.        # 
+0001d210: 6265 2075 706c 6f61 6465 6420 746f 2074  be uploaded to t
+0001d220: 6865 2073 746f 7261 6765 206f 626a 6563  he storage objec
+0001d230: 742e 0a20 2020 2020 2020 2074 6d70 5f6c  t..        tmp_l
+0001d240: 6f63 616c 5f6c 6973 745f 7374 6f72 6167  ocal_list_storag
+0001d250: 655f 6f62 6a2e 6164 645f 7374 6f72 6528  e_obj.add_store(
+0001d260: 7374 6f72 655f 7479 7065 290a 0a20 2020  store_type)..   
+0001d270: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
+0001d280: 746d 702d 6669 6c65 2065 7869 7374 7320  tmp-file exists 
+0001d290: 696e 2074 6865 2062 7563 6b65 7420 726f  in the bucket ro
+0001d2a0: 6f74 2075 7369 6e67 2063 6c69 0a20 2020  ot using cli.   
+0001d2b0: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0001d2c0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0001d2d0: 7574 2873 656c 662e 636c 695f 6c73 5f63  ut(self.cli_ls_c
+0001d2e0: 6d64 280a 2020 2020 2020 2020 2020 2020  md(.            
+0001d2f0: 7374 6f72 655f 7479 7065 2c20 746d 705f  store_type, tmp_
+0001d300: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
+0001d310: 6765 5f6f 626a 2e6e 616d 6529 2c0a 2020  ge_obj.name),.  
+0001d320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d340: 2020 2020 7368 656c 6c3d 5472 7565 290a      shell=True).
+0001d350: 2020 2020 2020 2020 6173 7365 7274 2027          assert '
+0001d360: 746d 702d 6669 6c65 2720 696e 206f 7574  tmp-file' in out
+0001d370: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0001d380: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+0001d390: 2746 696c 6520 6e6f 7420 666f 756e 6420  'File not found 
+0001d3a0: 696e 2062 7563 6b65 7420 2d20 6f75 7470  in bucket - outp
+0001d3b0: 7574 2077 6173 203a 207b 7d27 2e66 6f72  ut was : {}'.for
+0001d3c0: 6d61 7428 6f75 742e 6465 636f 6465 0a20  mat(out.decode. 
+0001d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d400: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+0001d410: 2775 7466 2d38 2729 290a 0a20 2020 2020  'utf-8'))..     
+0001d420: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
+0001d430: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+0001d440: 2074 6865 2062 7563 6b65 742f 746d 702d   the bucket/tmp-
+0001d450: 736f 7572 6365 2075 7369 6e67 2063 6c69  source using cli
+0001d460: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
+0001d470: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001d480: 6f75 7470 7574 2873 656c 662e 636c 695f  output(self.cli_
+0001d490: 6c73 5f63 6d64 280a 2020 2020 2020 2020  ls_cmd(.        
+0001d4a0: 2020 2020 7374 6f72 655f 7479 7065 2c20      store_type, 
+0001d4b0: 746d 705f 6c6f 6361 6c5f 6c69 7374 5f73  tmp_local_list_s
+0001d4c0: 746f 7261 6765 5f6f 626a 2e6e 616d 652c  torage_obj.name,
+0001d4d0: 2027 746d 702d 736f 7572 6365 2f27 292c   'tmp-source/'),
+0001d4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d500: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
+0001d510: 6529 0a20 2020 2020 2020 2061 7373 6572  e).        asser
+0001d520: 7420 2774 6d70 2d66 696c 6527 2069 6e20  t 'tmp-file' in 
+0001d530: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+0001d540: 3827 292c 205c 0a20 2020 2020 2020 2020  8'), \.         
+0001d550: 2020 2027 4669 6c65 206e 6f74 2066 6f75     'File not fou
+0001d560: 6e64 2069 6e20 6275 636b 6574 202d 206f  nd in bucket - o
+0001d570: 7574 7075 7420 7761 7320 3a20 7b7d 272e  utput was : {}'.
+0001d580: 666f 726d 6174 286f 7574 2e64 6563 6f64  format(out.decod
+0001d590: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0001d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5d0: 2020 2827 7574 662d 3827 2929 0a0a 2020    ('utf-8'))..  
+0001d5e0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
+0001d5f0: 6172 616d 6574 7269 7a65 2827 696e 7661  arametrize('inva
+0001d600: 6c69 645f 6e61 6d65 5f6c 6973 742c 2073  lid_name_list, s
+0001d610: 746f 7265 5f74 7970 6527 2c0a 2020 2020  tore_type',.    
+0001d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d630: 2020 2020 2020 2020 205b 2841 5753 5f49           [(AWS_I
+0001d640: 4e56 414c 4944 5f4e 414d 4553 2c20 7374  NVALID_NAMES, st
+0001d650: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0001d660: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+0001d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d680: 2020 2020 2020 2028 4743 535f 494e 5641         (GCS_INVA
+0001d690: 4c49 445f 4e41 4d45 532c 2073 746f 7261  LID_NAMES, stora
+0001d6a0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0001d6b0: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
+0001d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6d0: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0001d6e0: 6d28 4157 535f 494e 5641 4c49 445f 4e41  m(AWS_INVALID_NA
+0001d6f0: 4d45 532c 0a20 2020 2020 2020 2020 2020  MES,.           
+0001d700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d720: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0001d730: 6554 7970 652e 5232 2c0a 2020 2020 2020  eType.R2,.      
+0001d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d760: 2020 2020 206d 6172 6b73 3d70 7974 6573       marks=pytes
+0001d770: 742e 6d61 726b 2e63 6c6f 7564 666c 6172  t.mark.cloudflar
+0001d780: 6529 5d29 0a20 2020 2064 6566 2074 6573  e)]).    def tes
+0001d790: 745f 696e 7661 6c69 645f 6e61 6d65 7328  t_invalid_names(
+0001d7a0: 7365 6c66 2c20 696e 7661 6c69 645f 6e61  self, invalid_na
+0001d7b0: 6d65 5f6c 6973 742c 2073 746f 7265 5f74  me_list, store_t
+0001d7c0: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
+0001d7d0: 5573 6573 2061 206c 6973 7420 696e 2074  Uses a list in t
+0001d7e0: 6865 2073 6f75 7263 6520 6669 656c 6420  he source field 
+0001d7f0: 746f 2073 7065 6369 6679 2061 2066 696c  to specify a fil
+0001d800: 6520 616e 6420 6120 6469 7265 6374 6f72  e and a director
+0001d810: 7920 746f 0a20 2020 2020 2020 2023 2062  y to.        # b
+0001d820: 6520 7570 6c6f 6164 6564 2074 6f20 7468  e uploaded to th
+0001d830: 6520 7374 6f72 6167 6520 6f62 6a65 6374  e storage object
+0001d840: 2e0a 2020 2020 2020 2020 666f 7220 6e61  ..        for na
+0001d850: 6d65 2069 6e20 696e 7661 6c69 645f 6e61  me in invalid_na
+0001d860: 6d65 5f6c 6973 743a 0a20 2020 2020 2020  me_list:.       
+0001d870: 2020 2020 2077 6974 6820 7079 7465 7374       with pytest
+0001d880: 2e72 6169 7365 7328 736b 792e 6578 6365  .raises(sky.exce
+0001d890: 7074 696f 6e73 2e53 746f 7261 6765 4e61  ptions.StorageNa
+0001d8a0: 6d65 4572 726f 7229 3a0a 2020 2020 2020  meError):.      
+0001d8b0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0001d8c0: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
+0001d8d0: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
+0001d8e0: 3d6e 616d 6529 0a20 2020 2020 2020 2020  =name).         
+0001d8f0: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0001d900: 626a 2e61 6464 5f73 746f 7265 2873 746f  bj.add_store(sto
+0001d910: 7265 5f74 7970 6529 0a0a 0a23 202d 2d2d  re_type)...# ---
+0001d920: 2d2d 2d2d 2d2d 2d20 5465 7374 696e 6720  ------- Testing 
+0001d930: 5941 4d4c 2053 7065 6373 202d 2d2d 2d2d  YAML Specs -----
+0001d940: 2d2d 2d2d 2d0a 2320 4f75 7220 736b 7920  -----.# Our sky 
+0001d950: 7374 6f72 6167 6520 7265 7175 6972 6573  storage requires
+0001d960: 2063 7265 6465 6e74 6961 6c73 2074 6f20   credentials to 
+0001d970: 6368 6563 6b20 7468 6520 6275 636b 6574  check the bucket
+0001d980: 2065 7869 7374 616e 6365 2077 6865 6e0a   existance when.
+0001d990: 2320 6c6f 6164 696e 6720 6120 7461 736b  # loading a task
+0001d9a0: 2066 726f 6d20 7468 6520 7961 6d6c 2066   from the yaml f
+0001d9b0: 696c 652c 2073 6f20 7765 2063 616e 6e6f  ile, so we canno
+0001d9c0: 7420 6d61 6b65 2069 7420 6120 756e 6974  t make it a unit
+0001d9d0: 2074 6573 742e 0a63 6c61 7373 2054 6573   test..class Tes
+0001d9e0: 7459 616d 6c53 7065 6373 3a0a 2020 2020  tYamlSpecs:.    
+0001d9f0: 2320 544f 444f 287a 6877 7529 3a20 4164  # TODO(zhwu): Ad
+0001da00: 6420 7465 7374 2066 6f72 2060 746f 5f79  d test for `to_y
+0001da10: 616d 6c5f 636f 6e66 6967 6020 666f 7220  aml_config` for 
+0001da20: 7468 6520 5374 6f72 6167 6520 6f62 6a65  the Storage obje
+0001da30: 6374 2e0a 2020 2020 2320 2057 6520 7368  ct..    #  We sh
+0001da40: 6f75 6c64 206e 6f74 2075 7365 2060 6578  ould not use `ex
+0001da50: 616d 706c 6573 2f73 746f 7261 6765 5f64  amples/storage_d
+0001da60: 656d 6f2e 7961 6d6c 6020 6865 7265 2c20  emo.yaml` here, 
+0001da70: 7369 6e63 6520 6974 2072 6571 7569 7265  since it require
+0001da80: 730a 2020 2020 2320 2075 7365 7273 2074  s.    #  users t
+0001da90: 6f20 656e 7375 7265 2062 7563 6b65 7420  o ensure bucket 
+0001daa0: 6e61 6d65 7320 746f 206e 6f74 2065 7869  names to not exi
+0001dab0: 7374 2061 6e64 2f6f 7220 6265 2075 6e69  st and/or be uni
+0001dac0: 7175 652e 0a20 2020 205f 5445 5354 5f59  que..    _TEST_Y
+0001dad0: 414d 4c5f 5041 5448 5320 3d20 5b0a 2020  AML_PATHS = [.  
+0001dae0: 2020 2020 2020 2765 7861 6d70 6c65 732f        'examples/
+0001daf0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 2027  minimal.yaml', '
+0001db00: 6578 616d 706c 6573 2f6d 616e 6167 6564  examples/managed
+0001db10: 5f73 706f 742e 7961 6d6c 272c 0a20 2020  _spot.yaml',.   
+0001db20: 2020 2020 2027 6578 616d 706c 6573 2f75       'examples/u
+0001db30: 7369 6e67 5f66 696c 655f 6d6f 756e 7473  sing_file_mounts
+0001db40: 2e79 616d 6c27 2c20 2765 7861 6d70 6c65  .yaml', 'example
+0001db50: 732f 7265 736e 6574 5f61 7070 2e79 616d  s/resnet_app.yam
+0001db60: 6c27 2c0a 2020 2020 2020 2020 2765 7861  l',.        'exa
+0001db70: 6d70 6c65 732f 6d75 6c74 695f 686f 7374  mples/multi_host
+0001db80: 6e61 6d65 2e79 616d 6c27 0a20 2020 205d  name.yaml'.    ]
+0001db90: 0a0a 2020 2020 6465 6620 5f69 735f 6469  ..    def _is_di
+0001dba0: 6374 5f73 7562 7365 7428 7365 6c66 2c20  ct_subset(self, 
+0001dbb0: 6431 2c20 6432 293a 0a20 2020 2020 2020  d1, d2):.       
+0001dbc0: 2022 2222 4368 6563 6b20 6966 2064 3120   """Check if d1 
+0001dbd0: 6973 2074 6865 2073 7562 7365 7420 6f66  is the subset of
+0001dbe0: 2064 322e 2222 220a 2020 2020 2020 2020   d2.""".        
+0001dbf0: 666f 7220 6b2c 2076 2069 6e20 6431 2e69  for k, v in d1.i
+0001dc00: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+0001dc10: 2020 2020 6966 206b 206e 6f74 2069 6e20      if k not in 
+0001dc20: 6432 3a0a 2020 2020 2020 2020 2020 2020  d2:.            
+0001dc30: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001dc40: 6528 762c 206c 6973 7429 206f 7220 6973  e(v, list) or is
+0001dc50: 696e 7374 616e 6365 2876 2c20 6469 6374  instance(v, dict
+0001dc60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001dc70: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
+0001dc80: 6e28 7629 203d 3d20 302c 2028 6b2c 2076  n(v) == 0, (k, v
+0001dc90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001dca0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001dcb0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0001dcc0: 7274 2046 616c 7365 2c20 286b 2c20 7629  rt False, (k, v)
+0001dcd0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0001dce0: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+0001dcf0: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+0001dd00: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0001dd10: 696e 7374 616e 6365 2864 325b 6b5d 2c20  instance(d2[k], 
+0001dd20: 6469 6374 292c 2028 6b2c 2076 2c20 6432  dict), (k, v, d2
+0001dd30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001dd40: 2020 7365 6c66 2e5f 6973 5f64 6963 745f    self._is_dict_
+0001dd50: 7375 6273 6574 2876 2c20 6432 5b6b 5d29  subset(v, d2[k])
+0001dd60: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0001dd70: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
+0001dd80: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+0001dd90: 2020 2020 2020 6966 206b 203d 3d20 2761        if k == 'a
+0001dda0: 6363 656c 6572 6174 6f72 7327 3a0a 2020  ccelerators':.  
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddc0: 2020 7265 736f 7572 6365 7320 3d20 736b    resources = sk
+0001ddd0: 792e 5265 736f 7572 6365 7328 290a 2020  y.Resources().  
+0001dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddf0: 2020 7265 736f 7572 6365 732e 5f73 6574    resources._set
+0001de00: 5f61 6363 656c 6572 6174 6f72 7328 762c  _accelerators(v,
+0001de10: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+0001de20: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001de30: 7420 7265 736f 7572 6365 732e 6163 6365  t resources.acce
+0001de40: 6c65 7261 746f 7273 203d 3d20 6432 5b6b  lerators == d2[k
+0001de50: 5d2c 2028 6b2c 2076 2c20 6432 290a 2020  ], (k, v, d2).  
+0001de60: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001de70: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001de80: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
+0001de90: 2e6c 6f77 6572 2829 203d 3d20 6432 5b6b  .lower() == d2[k
+0001dea0: 5d2e 6c6f 7765 7228 292c 2028 6b2c 2076  ].lower(), (k, v
+0001deb0: 2c20 6432 5b6b 5d29 0a20 2020 2020 2020  , d2[k]).       
+0001dec0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001ded0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001dee0: 7420 7620 3d3d 2064 325b 6b5d 2c20 286b  t v == d2[k], (k
+0001def0: 2c20 762c 2064 325b 6b5d 290a 0a20 2020  , v, d2[k])..   
+0001df00: 2064 6566 205f 6368 6563 6b5f 6571 7569   def _check_equi
+0001df10: 7661 6c65 6e74 2873 656c 662c 2079 616d  valent(self, yam
+0001df20: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
+0001df30: 2022 2222 4368 6563 6b20 6966 2074 6865   """Check if the
+0001df40: 2079 616d 6c20 6973 2065 7175 6976 616c   yaml is equival
+0001df50: 656e 7420 6166 7465 7220 6c6f 6164 2061  ent after load a
+0001df60: 6e64 2064 756d 7020 6167 6169 6e2e 2222  nd dump again.""
+0001df70: 220a 2020 2020 2020 2020 6f72 6967 696e  ".        origin
+0001df80: 5f74 6173 6b5f 636f 6e66 6967 203d 2063  _task_config = c
+0001df90: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
+0001dfa0: 5f79 616d 6c28 7961 6d6c 5f70 6174 6829  _yaml(yaml_path)
+0001dfb0: 0a0a 2020 2020 2020 2020 7461 736b 203d  ..        task =
+0001dfc0: 2073 6b79 2e54 6173 6b2e 6672 6f6d 5f79   sky.Task.from_y
+0001dfd0: 616d 6c28 7961 6d6c 5f70 6174 6829 0a20  aml(yaml_path). 
+0001dfe0: 2020 2020 2020 206e 6577 5f74 6173 6b5f         new_task_
+0001dff0: 636f 6e66 6967 203d 2074 6173 6b2e 746f  config = task.to
+0001e000: 5f79 616d 6c5f 636f 6e66 6967 2829 0a20  _yaml_config(). 
+0001e010: 2020 2020 2020 2023 2064 3120 3c3d 2064         # d1 <= d
+0001e020: 320a 2020 2020 2020 2020 7365 6c66 2e5f  2.        self._
+0001e030: 6973 5f64 6963 745f 7375 6273 6574 286f  is_dict_subset(o
+0001e040: 7269 6769 6e5f 7461 736b 5f63 6f6e 6669  rigin_task_confi
+0001e050: 672c 206e 6577 5f74 6173 6b5f 636f 6e66  g, new_task_conf
+0001e060: 6967 290a 0a20 2020 2064 6566 2074 6573  ig)..    def tes
+0001e070: 745f 6c6f 6164 5f64 756d 705f 7961 6d6c  t_load_dump_yaml
+0001e080: 5f63 6f6e 6669 675f 6571 7569 7661 6c65  _config_equivale
+0001e090: 6e74 2873 656c 6629 3a0a 2020 2020 2020  nt(self):.      
+0001e0a0: 2020 2222 2254 6573 7420 6966 2074 6865    """Test if the
+0001e0b0: 2079 616d 6c20 636f 6e66 6967 2069 7320   yaml config is 
+0001e0c0: 6571 7569 7661 6c65 6e74 2061 6674 6572  equivalent after
+0001e0d0: 206c 6f61 6420 616e 6420 6475 6d70 2061   load and dump a
+0001e0e0: 6761 696e 2e22 2222 0a20 2020 2020 2020  gain.""".       
+0001e0f0: 2070 6174 686c 6962 2e50 6174 6828 277e   pathlib.Path('~
+0001e100: 2f64 6174 6173 6574 7327 292e 6578 7061  /datasets').expa
+0001e110: 6e64 7573 6572 2829 2e6d 6b64 6972 2865  nduser().mkdir(e
+0001e120: 7869 7374 5f6f 6b3d 5472 7565 290a 2020  xist_ok=True).  
+0001e130: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
+0001e140: 7468 2827 7e2f 746d 7066 696c 6527 292e  th('~/tmpfile').
+0001e150: 6578 7061 6e64 7573 6572 2829 2e74 6f75  expanduser().tou
+0001e160: 6368 2829 0a20 2020 2020 2020 2070 6174  ch().        pat
+0001e170: 686c 6962 2e50 6174 6828 277e 2f2e 7373  hlib.Path('~/.ss
+0001e180: 6827 292e 6578 7061 6e64 7573 6572 2829  h').expanduser()
+0001e190: 2e6d 6b64 6972 2865 7869 7374 5f6f 6b3d  .mkdir(exist_ok=
+0001e1a0: 5472 7565 290a 2020 2020 2020 2020 7061  True).        pa
+0001e1b0: 7468 6c69 622e 5061 7468 2827 7e2f 2e73  thlib.Path('~/.s
+0001e1c0: 7368 2f69 645f 7273 612e 7075 6227 292e  sh/id_rsa.pub').
+0001e1d0: 6578 7061 6e64 7573 6572 2829 2e74 6f75  expanduser().tou
+0001e1e0: 6368 2829 0a20 2020 2020 2020 2070 6174  ch().        pat
+0001e1f0: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
+0001e200: 2d77 6f72 6b64 6972 2729 2e65 7870 616e  -workdir').expan
+0001e210: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+0001e220: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+0001e230: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
+0001e240: 6828 277e 2f44 6f77 6e6c 6f61 6473 2f74  h('~/Downloads/t
+0001e250: 7075 2729 2e65 7870 616e 6475 7365 7228  pu').expanduser(
+0001e260: 292e 6d6b 6469 7228 7061 7265 6e74 733d  ).mkdir(parents=
+0001e270: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0001e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2b0: 2065 7869 7374 5f6f 6b3d 5472 7565 290a   exist_ok=True).
+0001e2c0: 2020 2020 2020 2020 666f 7220 7961 6d6c          for yaml
+0001e2d0: 5f70 6174 6820 696e 2073 656c 662e 5f54  _path in self._T
+0001e2e0: 4553 545f 5941 4d4c 5f50 4154 4853 3a0a  EST_YAML_PATHS:.
+0001e2f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001e300: 2e5f 6368 6563 6b5f 6571 7569 7661 6c65  ._check_equivale
+0001e310: 6e74 2879 616d 6c5f 7061 7468 290a       nt(yaml_path).
```

### Comparing `skypilot-0.3.1/tests/test_spot.py` & `skypilot-0.3.2/tests/test_spot.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/tests/test_storage.py` & `skypilot-0.3.2/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.3.1/tests/test_wheels.py` & `skypilot-0.3.2/tests/test_wheels.py`

 * *Files identical despite different names*

