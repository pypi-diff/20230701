# Comparing `tmp/yfinance-cache-0.4.3.tar.gz` & `tmp/yfinance-cache-0.4.4.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "yfinance-cache-0.4.3.tar", last modified: Mon Mar 20 13:09:25 2023, max compression
+gzip compressed data, was "yfinance-cache-0.4.4.tar", last modified: Sat Jul  1 19:08:01 2023, max compression
```

## Comparing `yfinance-cache-0.4.3.tar` & `yfinance-cache-0.4.4.tar`

### file list

```diff
@@ -1,49 +1,49 @@
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2023-03-20 13:09:25.580506 yfinance-cache-0.4.3/
--rw-rw-r--   0 gonzo     (1000) gonzo     (1000)     1068 2022-12-11 21:25:36.000000 yfinance-cache-0.4.3/LICENSE
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     4004 2023-03-20 13:09:25.580506 yfinance-cache-0.4.3/PKG-INFO
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     3466 2023-03-19 22:07:12.000000 yfinance-cache-0.4.3/README.md
--rw-rw-r--   0 gonzo     (1000) gonzo     (1000)      104 2022-12-11 21:25:36.000000 yfinance-cache-0.4.3/pyproject.toml
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      768 2023-03-20 13:09:25.581506 yfinance-cache-0.4.3/setup.cfg
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2023-03-20 13:09:25.576506 yfinance-cache-0.4.3/tests/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)       21 2022-12-11 21:25:36.000000 yfinance-cache-0.4.3/tests/__init__.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      328 2022-12-11 21:25:36.000000 yfinance-cache-0.4.3/tests/context.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     8469 2023-02-13 12:03:37.000000 yfinance-cache-0.4.3/tests/test_cache.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      991 2022-12-11 21:25:36.000000 yfinance-cache-0.4.3/tests/test_datetime-assumptions.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    74555 2023-03-02 00:12:42.000000 yfinance-cache-0.4.3/tests/test_market_intervals_asx.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    70793 2023-03-02 00:12:25.000000 yfinance-cache-0.4.3/tests/test_market_intervals_nze.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    74174 2023-03-02 00:12:34.000000 yfinance-cache-0.4.3/tests/test_market_intervals_tlv.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    71006 2023-03-02 00:12:16.000000 yfinance-cache-0.4.3/tests/test_market_intervals_usa.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    24913 2023-02-26 17:24:45.000000 yfinance-cache-0.4.3/tests/test_market_schedules_asx.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    24789 2023-02-26 17:25:05.000000 yfinance-cache-0.4.3/tests/test_market_schedules_nze.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    32509 2023-02-26 17:31:08.000000 yfinance-cache-0.4.3/tests/test_market_schedules_tlv.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    23272 2023-02-26 17:24:17.000000 yfinance-cache-0.4.3/tests/test_market_schedules_usa.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12038 2023-03-02 00:17:33.000000 yfinance-cache-0.4.3/tests/test_missing_intervals_asx.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12079 2023-03-02 00:17:32.000000 yfinance-cache-0.4.3/tests/test_missing_intervals_nze.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13799 2023-03-02 00:18:50.000000 yfinance-cache-0.4.3/tests/test_missing_intervals_tlv.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    12209 2023-03-02 00:17:43.000000 yfinance-cache-0.4.3/tests/test_missing_intervals_usa.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    18450 2023-02-27 17:46:12.000000 yfinance-cache-0.4.3/tests/test_price_data_aging_1d.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    14633 2023-02-23 15:58:13.000000 yfinance-cache-0.4.3/tests/test_price_data_aging_1h.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13006 2023-03-02 00:29:03.000000 yfinance-cache-0.4.3/tests/test_price_data_aging_1w.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2447 2023-02-23 21:03:13.000000 yfinance-cache-0.4.3/tests/test_time_utils.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     1698 2022-12-11 21:25:36.000000 yfinance-cache-0.4.3/tests/test_utils.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     3120 2023-03-02 17:26:02.000000 yfinance-cache-0.4.3/tests/test_yf_assumptions.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    31991 2023-03-02 17:31:26.000000 yfinance-cache-0.4.3/tests/test_yfc_adjust.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    18098 2023-03-04 00:04:43.000000 yfinance-cache-0.4.3/tests/test_yfc_backend.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    39728 2023-03-17 21:51:58.000000 yfinance-cache-0.4.3/tests/test_yfc_interface.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     4267 2023-03-02 17:27:03.000000 yfinance-cache-0.4.3/tests/utils.py
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2023-03-20 13:09:25.578506 yfinance-cache-0.4.3/yfinance_cache/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)      732 2023-03-19 21:48:58.000000 yfinance-cache-0.4.3/yfinance_cache/__init__.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13971 2023-03-16 13:32:53.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_cache_manager.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    13400 2023-03-19 20:52:46.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_dat.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2107 2023-03-20 10:59:32.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_logging.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)   168145 2023-03-20 11:11:16.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_prices_manager.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    31008 2023-03-19 22:06:41.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_ticker.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    78526 2023-03-20 13:07:59.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_time.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    22561 2023-03-17 22:27:43.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_upgrade.py
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)    20363 2023-03-19 22:03:41.000000 yfinance-cache-0.4.3/yfinance_cache/yfc_utils.py
-drwxr-xr-x   0 gonzo     (1000) gonzo     (1000)        0 2023-03-20 13:09:25.579506 yfinance-cache-0.4.3/yfinance_cache.egg-info/
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     4004 2023-03-20 13:09:25.000000 yfinance-cache-0.4.3/yfinance_cache.egg-info/PKG-INFO
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)     2099 2023-03-20 13:09:25.000000 yfinance-cache-0.4.3/yfinance_cache.egg-info/SOURCES.txt
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)        1 2023-03-20 13:09:25.000000 yfinance-cache-0.4.3/yfinance_cache.egg-info/dependency_links.txt
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)       74 2023-03-20 13:09:25.000000 yfinance-cache-0.4.3/yfinance_cache.egg-info/requires.txt
--rw-r--r--   0 gonzo     (1000) gonzo     (1000)       21 2023-03-20 13:09:25.000000 yfinance-cache-0.4.3/yfinance_cache.egg-info/top_level.txt
+drwx------   0 gonzo     (1000) gonzo     (1000)        0 2023-07-01 19:08:01.398037 yfinance-cache-0.4.4/
+-rw-------   0 gonzo     (1000) gonzo     (1000)     1068 2023-07-01 18:54:44.000000 yfinance-cache-0.4.4/LICENSE
+-rw-------   0 gonzo     (1000) gonzo     (1000)     4546 2023-07-01 19:08:01.398037 yfinance-cache-0.4.4/PKG-INFO
+-rw-------   0 gonzo     (1000) gonzo     (1000)     4008 2023-07-01 18:57:48.000000 yfinance-cache-0.4.4/README.md
+-rw-------   0 gonzo     (1000) gonzo     (1000)      104 2023-07-01 18:54:44.000000 yfinance-cache-0.4.4/pyproject.toml
+-rw-------   0 gonzo     (1000) gonzo     (1000)      768 2023-07-01 19:08:01.400037 yfinance-cache-0.4.4/setup.cfg
+drwx------   0 gonzo     (1000) gonzo     (1000)        0 2023-07-01 19:08:01.384037 yfinance-cache-0.4.4/tests/
+-rw-------   0 gonzo     (1000) gonzo     (1000)       21 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/__init__.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     1523 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/context.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     8469 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_cache.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)      991 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_datetime-assumptions.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    74555 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_intervals_asx.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    70793 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_intervals_nze.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    74237 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_intervals_tlv.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    71006 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_intervals_usa.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    24913 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_schedules_asx.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    24789 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_schedules_nze.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    32509 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_schedules_tlv.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    23272 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_market_schedules_usa.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    12038 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_missing_intervals_asx.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    12079 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_missing_intervals_nze.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    13799 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_missing_intervals_tlv.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    12209 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_missing_intervals_usa.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    18520 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_price_data_aging_1d.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    14738 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_price_data_aging_1h.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    13146 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_price_data_aging_1w.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     2447 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_time_utils.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     1698 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_utils.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     2929 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_yf_assumptions.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    31905 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_yfc_adjust.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    21751 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_yfc_backend.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    39230 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/test_yfc_interface.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     4368 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/tests/utils.py
+drwx------   0 gonzo     (1000) gonzo     (1000)        0 2023-07-01 19:08:01.394037 yfinance-cache-0.4.4/yfinance_cache/
+-rw-------   0 gonzo     (1000) gonzo     (1000)      913 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/__init__.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    13971 2023-07-01 18:54:44.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_cache_manager.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    13815 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_dat.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)     2067 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_logging.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)   174051 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_prices_manager.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    33773 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_ticker.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    78933 2023-07-01 18:57:21.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_time.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    27694 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_upgrade.py
+-rw-------   0 gonzo     (1000) gonzo     (1000)    24188 2023-07-01 18:54:01.000000 yfinance-cache-0.4.4/yfinance_cache/yfc_utils.py
+drwx------   0 gonzo     (1000) gonzo     (1000)        0 2023-07-01 19:08:01.397037 yfinance-cache-0.4.4/yfinance_cache.egg-info/
+-rw-------   0 gonzo     (1000) gonzo     (1000)     4546 2023-07-01 19:08:01.000000 yfinance-cache-0.4.4/yfinance_cache.egg-info/PKG-INFO
+-rw-------   0 gonzo     (1000) gonzo     (1000)     2099 2023-07-01 19:08:01.000000 yfinance-cache-0.4.4/yfinance_cache.egg-info/SOURCES.txt
+-rw-------   0 gonzo     (1000) gonzo     (1000)        1 2023-07-01 19:08:01.000000 yfinance-cache-0.4.4/yfinance_cache.egg-info/dependency_links.txt
+-rw-------   0 gonzo     (1000) gonzo     (1000)       74 2023-07-01 19:08:01.000000 yfinance-cache-0.4.4/yfinance_cache.egg-info/requires.txt
+-rw-------   0 gonzo     (1000) gonzo     (1000)       21 2023-07-01 19:08:01.000000 yfinance-cache-0.4.4/yfinance_cache.egg-info/top_level.txt
```

### Comparing `yfinance-cache-0.4.3/LICENSE` & `yfinance-cache-0.4.4/LICENSE`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/PKG-INFO` & `yfinance-cache-0.4.4/PKG-INFO`

 * *Files 9% similar despite different names*

```diff
@@ -1,51 +1,60 @@
 Metadata-Version: 2.1
 Name: yfinance-cache
-Version: 0.4.3
+Version: 0.4.4
 Summary: Smart caching wrapper for 'yfinance' module
 Home-page: https://github.com/ValueRaider/yfinance-cache
 Author: ValueRaider
 Author-email: ValueRaider@protonmail.com
 Project-URL: Bug Tracker, https://github.com/ValueRaider/yfinance-cache/issues
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: OS Independent
 Requires-Python: >=3
 Description-Content-Type: text/markdown
 License-File: LICENSE
 
 # yfinance-cache
-Caching wrapper for `yfinance` module. Intelligent caching, not dumb caching of web requests. This means only updating cache if (i) missing and (ii) new data expected.
+Persistent caching wrapper for `yfinance` module. Intelligent caching, not dumb caching of web requests - only update cache if missing and new data expected.
 
-Only price data fully implemented. Uses [exchange schedule](https://github.com/gerrymanoim/exchange_calendars) to know when new price data available. '1d' price data always fetched from `start` date to today (i.e. ignores `end`), as need to know all dividends and stock splits since `start`.
+Only price data caching fully implemented. Everything else is cached once but never updated (unless you delete their files).
 
-Planning to intelligently cache financials too using Yahoo's earnings calendar to estimate next release (prototype code ready), but `yfinance` decryption issue blocks this.
+Persistent cache stored in your user cache folder:
+- Windows = C:/Users/\<USER\>/AppData/Local/py-yfinance-cache
+- Linux = /home/\<USER\>/.cache/py-yfinance-cache
+- MacOS = /Users/\<USER\>/Library/Caches/py-yfinance-cache
+
+### Price cache
+
+How is my price caching different to other market price caches? Simple - they don't adjust cached data for new stock splits or dividends.
+
+Uses [exchange schedule](https://github.com/gerrymanoim/exchange_calendars) to know when new price data available. '1d' price data always fetched from `start` date to today (i.e. ignores `end`), as need to know all dividends and stock splits since `start`.
 
 ## Interface
 Interaction almost identical to yfinance. Differences highlighted underneath code:
 
 ```python
 import yfinance_cache as yfc
 
 msft = yfc.Ticker("MSFT")
 
 # get stock info
 msft.info
 
 # get historical market data
-hist = msft.history(period="max")
+hist = msft.history(period="1d")
 ...
 # etc. See yfinance documentation for full API
 ```
 
 #### Refreshing cache
 ```python
 msft.history(interval="1d", max_age="1h", trigger_at_market_close=False, ...)
 ```
-`max_age` controls when to yodate cache. If market is still open and `max_age` time has passed since last fetch, then today's cached price data will be refreshed. If `trigger_at_market_close`=True then refresh also triggered if market has closed since last fetch. Must be `Timedelta` or equivalent `str`, defaults to half of interval. 
+`max_age` controls when to update cache. If market is still open and `max_age` time has passed since last fetch, then today's cached price data will be refreshed. If `trigger_at_market_close=True` then refresh also triggered if market has closed since last fetch. Must be `Timedelta` or equivalent `str`, defaults to half of interval. 
 
 #### Adjusting price
 Price can be adjusted for stock splits, dividends, or both.
 ```python
 msft.history(..., adjust_splits=True, adjust_divs=True)
 ```
 
@@ -64,23 +73,34 @@
 
 # Verify prices of entire cache, ticker symbols processed alphabetically. Recommend using `requests_cache` session.
 yfc.verify_cached_tickers_prices(
 	session=None,  # recommend you provide a requests_cache here
 	rtol=0.0001,
 	vol_rtol=0.005,
 	correct=False,
+	halt_on_fail=True,  # stop verifying on first fail
 	resume_from_tkr=None,  # in case you aborted verification, can jump ahead to this ticker symbol. Append '+1' to start AFTER the ticker
 	debug_tkr=None,  # only verify this ticker symbol
 	debug_interval=None)
 ```
 
 With latest version the only genuine differences you should see are tiny Volume differences (~0.5%). Seems Yahoo is still adjusting Volume over 24 hours after that day ended, e.g. updating Monday Volume on Wednesday.
 
 If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong! Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience. Cross-check against TradingView or stock exchange website.
 
+## Performance
+
+For each ticker, YFC basically performs 2 tasks:
+
+1 - check if fetch needed
+
+2 - fetch data and integrate into cache
+
+Throughput on 1 thread decent CPU: task 1 @ ~60/sec, task 2 @ ~5/sec.
+
 ## Installation
 
 Available on PIP: `pip install yfinance_cache`
 
 ## Limitations
 
 - only price data is checked if refresh needed
```

### Comparing `yfinance-cache-0.4.3/README.md` & `yfinance-cache-0.4.4/README.md`

 * *Files 17% similar despite different names*

```diff
@@ -1,36 +1,45 @@
 # yfinance-cache
-Caching wrapper for `yfinance` module. Intelligent caching, not dumb caching of web requests. This means only updating cache if (i) missing and (ii) new data expected.
+Persistent caching wrapper for `yfinance` module. Intelligent caching, not dumb caching of web requests - only update cache if missing and new data expected.
 
-Only price data fully implemented. Uses [exchange schedule](https://github.com/gerrymanoim/exchange_calendars) to know when new price data available. '1d' price data always fetched from `start` date to today (i.e. ignores `end`), as need to know all dividends and stock splits since `start`.
+Only price data caching fully implemented. Everything else is cached once but never updated (unless you delete their files).
 
-Planning to intelligently cache financials too using Yahoo's earnings calendar to estimate next release (prototype code ready), but `yfinance` decryption issue blocks this.
+Persistent cache stored in your user cache folder:
+- Windows = C:/Users/\<USER\>/AppData/Local/py-yfinance-cache
+- Linux = /home/\<USER\>/.cache/py-yfinance-cache
+- MacOS = /Users/\<USER\>/Library/Caches/py-yfinance-cache
+
+### Price cache
+
+How is my price caching different to other market price caches? Simple - they don't adjust cached data for new stock splits or dividends.
+
+Uses [exchange schedule](https://github.com/gerrymanoim/exchange_calendars) to know when new price data available. '1d' price data always fetched from `start` date to today (i.e. ignores `end`), as need to know all dividends and stock splits since `start`.
 
 ## Interface
 Interaction almost identical to yfinance. Differences highlighted underneath code:
 
 ```python
 import yfinance_cache as yfc
 
 msft = yfc.Ticker("MSFT")
 
 # get stock info
 msft.info
 
 # get historical market data
-hist = msft.history(period="max")
+hist = msft.history(period="1d")
 ...
 # etc. See yfinance documentation for full API
 ```
 
 #### Refreshing cache
 ```python
 msft.history(interval="1d", max_age="1h", trigger_at_market_close=False, ...)
 ```
-`max_age` controls when to yodate cache. If market is still open and `max_age` time has passed since last fetch, then today's cached price data will be refreshed. If `trigger_at_market_close`=True then refresh also triggered if market has closed since last fetch. Must be `Timedelta` or equivalent `str`, defaults to half of interval. 
+`max_age` controls when to update cache. If market is still open and `max_age` time has passed since last fetch, then today's cached price data will be refreshed. If `trigger_at_market_close=True` then refresh also triggered if market has closed since last fetch. Must be `Timedelta` or equivalent `str`, defaults to half of interval. 
 
 #### Adjusting price
 Price can be adjusted for stock splits, dividends, or both.
 ```python
 msft.history(..., adjust_splits=True, adjust_divs=True)
 ```
 
@@ -49,23 +58,34 @@
 
 # Verify prices of entire cache, ticker symbols processed alphabetically. Recommend using `requests_cache` session.
 yfc.verify_cached_tickers_prices(
 	session=None,  # recommend you provide a requests_cache here
 	rtol=0.0001,
 	vol_rtol=0.005,
 	correct=False,
+	halt_on_fail=True,  # stop verifying on first fail
 	resume_from_tkr=None,  # in case you aborted verification, can jump ahead to this ticker symbol. Append '+1' to start AFTER the ticker
 	debug_tkr=None,  # only verify this ticker symbol
 	debug_interval=None)
 ```
 
 With latest version the only genuine differences you should see are tiny Volume differences (~0.5%). Seems Yahoo is still adjusting Volume over 24 hours after that day ended, e.g. updating Monday Volume on Wednesday.
 
 If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong! Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience. Cross-check against TradingView or stock exchange website.
 
+## Performance
+
+For each ticker, YFC basically performs 2 tasks:
+
+1 - check if fetch needed
+
+2 - fetch data and integrate into cache
+
+Throughput on 1 thread decent CPU: task 1 @ ~60/sec, task 2 @ ~5/sec.
+
 ## Installation
 
 Available on PIP: `pip install yfinance_cache`
 
 ## Limitations
 
 - only price data is checked if refresh needed
```

### Comparing `yfinance-cache-0.4.3/setup.cfg` & `yfinance-cache-0.4.4/setup.cfg`

 * *Files 24% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 [metadata]
 name = yfinance-cache
-version = 0.4.3
+version = 0.4.4
 author = ValueRaider
 author_email = ValueRaider@protonmail.com
 description = Smart caching wrapper for 'yfinance' module
 long_description = file: README.md
 long_description_content_type = text/markdown
 url = https://github.com/ValueRaider/yfinance-cache
 project_urls = 
@@ -16,15 +16,15 @@
 
 [options]
 package_dir = 
 	= ./
 packages = find:
 python_requires = >=3
 install_requires = 
-	yfinance >= 0.2.10
+	yfinance >= 0.2.21
 	pandas >= 1.5
 	exchange_calendars >= 4.2.5
 	scipy >= 1.6.3
 	click
 
 [options.packages.find]
 where = ./
```

### Comparing `yfinance-cache-0.4.3/tests/test_cache.py` & `yfinance-cache-0.4.4/tests/test_cache.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_datetime-assumptions.py` & `yfinance-cache-0.4.4/tests/test_datetime-assumptions.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_intervals_asx.py` & `yfinance-cache-0.4.4/tests/test_market_intervals_asx.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_intervals_nze.py` & `yfinance-cache-0.4.4/tests/test_market_intervals_nze.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_intervals_tlv.py` & `yfinance-cache-0.4.4/tests/test_market_intervals_tlv.py`

 * *Files 1% similar despite different names*

```diff
@@ -181,120 +181,126 @@
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
 
     def test_GetScheduleIntervals_weekly(self):
-        interval = yfcd.Interval.Week
+        base_args = {'interval': yfcd.Interval.Week,
+                     'exchange': self.exchange,
+                     'weekForceStartMonday': False}
 
         # Simple case: 2 full weeks
-        start_d = date(2022, 9, 4)  # Sunday
-        end_d = date(2022, 9, 18)  # Sunday + 2 weeks
-        week7days = False ; discardTimes = False
+        args = dict(base_args)
+        args["start"] = date(2022, 9, 4)  # Sunday
+        args["end"] = date(2022, 9, 18)  # Sunday + 2 weeks
+        args['week7days'] = False ; args['discardTimes'] = False
         left = [dtc(date(2022, 9, 4), self.market_open, self.market_tz),  # Sunday open
                 dtc(date(2022, 9, 11), self.market_open, self.market_tz)]  # Sunday open
         right = [dtc(date(2022, 9, 8), self.auction_end, self.market_tz),  # Thursday close
                  dtc(date(2022, 9, 15), self.auction_end, self.market_tz)]  # Thursday close
         answer = pd.IntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
-        week7days = False ; discardTimes = True
+        args['week7days'] = False ; args['discardTimes'] = True
         left = [date(2022, 9, 4), date(2022, 9, 11)]  # Sundays
         right = [date(2022, 9, 9), date(2022, 9, 16)]  # Fridays
         answer = yfcd.DateIntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
         week7days = True ; discardTimes = True
+        args['week7days'] = True ; args['discardTimes'] = True
         answer = yfcd.DateIntervalIndex([yfcd.DateInterval(date(2022, 9, 5), date(2022, 9, 12), closed="left")])  # Monday -> next Monday
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
 
         # Weekend cut off
-        start_d = date(2022, 9, 4)  # Sunday
-        end_d = date(2022, 9, 17)  # next Saturday
-        week7days = False ; discardTimes = False
+        args = dict(base_args)
+        args["start"] = date(2022, 9, 4)  # Sunday
+        args["end"] = date(2022, 9, 17)  # next Saturday
+        args['week7days'] = False ; args['discardTimes'] = False
         left = [dtc(date(2022, 9, 4), self.market_open, self.market_tz),  # Sunday opens
                 dtc(date(2022, 9, 11), self.market_open, self.market_tz)]
         right = [dtc(date(2022, 9, 8), self.market_close, self.market_tz),  # Thursday closes
                  dtc(date(2022, 9, 15), self.market_close, self.market_tz)]
         answer = pd.IntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
-        week7days = False ; discardTimes = True
+        args['week7days'] = False ; args['discardTimes'] = True
         left = [date(2022, 9, 4), date(2022, 9, 11)]  # Sundays
         right = [date(2022, 9, 9), date(2022, 9, 16)]  # Fridays
         answer = yfcd.DateIntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
-        week7days = True ; discardTimes = True
+        args['week7days'] = True ; args['discardTimes'] = True
         left = [date(2022, 9, 5)]  # Monday
         right = [date(2022, 9, 12)]  # next Monday
         answer = yfcd.DateIntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
 
         # Monday holiday
-        start_d = date(2022, 9, 28)  # Wednesday (Mon-Tues holidays)
-        end_d = date(2022, 10, 3)  # next Monday
-        week7days = False ; discardTimes = False
+        args = dict(base_args)
+        args["start"] = date(2022, 9, 28)  # Wednesday (Mon-Tues holidays)
+        args["end"] = date(2022, 10, 3)  # next Monday
+        args['week7days'] = False ; args['discardTimes'] = False
         left = [dtc(date(2022, 9, 28), self.market_open, self.market_tz)]  # Wednesday open
         right = [dtc(date(2022, 9, 29), self.market_close, self.market_tz)]  # Thursday close
         answer = pd.IntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
-        week7days = False ; discardTimes = True
+        args['week7days'] = False ; args['discardTimes'] = True
         left = [date(2022, 9, 28)]  # Wednesday (Sun-Tue holidays)
         right = [date(2022, 9, 30)]  # Friday
         answer = yfcd.DateIntervalIndex.from_arrays(left, right, closed="left")
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertTrue(response.equals(answer))
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
-        week7days = True ; discardTimes = True
+        args['week7days'] = True ; args['discardTimes'] = True
         answer = None
-        response = yfct.GetExchangeScheduleIntervals(self.exchange, interval, start_d, end_d, discardTimes, week7days)
+        response = yfct.GetExchangeScheduleIntervals(**args)
         try:
             self.assertEqual(response, answer)
         except:
             print("response:") ; pprint(response)
             print("answer:")   ; pprint(answer)
             raise
 
@@ -1236,43 +1242,43 @@
             d = date(2022, 3, d)
             for t in times:
                 dt = dtc(d, t, self.market_tz)
                 response = yfct.GetTimestampNextInterval(self.exchange, dt, interval, discardTimes, week7days)
                 try:
                     self.assertEqual(response, answer)
                 except:
-                    print(f"interval={interval} dt={dt}")
+                    print(f"interval={interval} dt={dt} discardTimes={discardTimes} week7days={week7days}")
                     print("response:") ; pprint(response)
                     print("answer:") ; pprint(answer)
                     raise
         discardTimes = True ; week7days = False
         answer = {"interval_open": date(2022, 3, 6), "interval_close": date(2022, 3, 11)}  # Sunday -> Friday
         for d in [4, 5]:
             d = date(2022, 3, d)
             for t in times:
                 dt = dtc(d, t, self.market_tz)
                 response = yfct.GetTimestampNextInterval(self.exchange, dt, interval, discardTimes, week7days)
                 try:
                     self.assertEqual(response, answer)
                 except:
-                    print(f"interval={interval} dt={dt}")
+                    print(f"interval={interval} dt={dt} discardTimes={discardTimes} week7days={week7days}")
                     print("response:") ; pprint(response)
                     print("answer:") ; pprint(answer)
                     raise
         discardTimes = True ; week7days = True
         answer = {"interval_open": date(2022, 3, 7), "interval_close": date(2022, 3, 14)}  # Monday -> next Monday
         for d in [4, 5]:
             d = date(2022, 3, d)
             for t in times:
                 dt = dtc(d, t, self.market_tz)
                 response = yfct.GetTimestampNextInterval(self.exchange, dt, interval, discardTimes, week7days)
                 try:
                     self.assertEqual(response, answer)
                 except:
-                    print(f"interval={interval} dt={dt}")
+                    print(f"interval={interval} dt={dt} discardTimes={discardTimes} week7days={week7days}")
                     print("response:") ; pprint(response)
                     print("answer:") ; pprint(answer)
                     raise
 
         # Sunday morning
         dt = dtc(date(2022, 3, 6), time(6), self.market_tz)
         discardTimes = False ; week7days = False
```

### Comparing `yfinance-cache-0.4.3/tests/test_market_intervals_usa.py` & `yfinance-cache-0.4.4/tests/test_market_intervals_usa.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_schedules_asx.py` & `yfinance-cache-0.4.4/tests/test_market_schedules_asx.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_schedules_nze.py` & `yfinance-cache-0.4.4/tests/test_market_schedules_nze.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_schedules_tlv.py` & `yfinance-cache-0.4.4/tests/test_market_schedules_tlv.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_market_schedules_usa.py` & `yfinance-cache-0.4.4/tests/test_market_schedules_usa.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_missing_intervals_asx.py` & `yfinance-cache-0.4.4/tests/test_missing_intervals_asx.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_missing_intervals_nze.py` & `yfinance-cache-0.4.4/tests/test_missing_intervals_nze.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_missing_intervals_tlv.py` & `yfinance-cache-0.4.4/tests/test_missing_intervals_tlv.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_missing_intervals_usa.py` & `yfinance-cache-0.4.4/tests/test_missing_intervals_usa.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_price_data_aging_1d.py` & `yfinance-cache-0.4.4/tests/test_price_data_aging_1d.py`

 * *Files 1% similar despite different names*

```diff
@@ -228,14 +228,15 @@
 
 
     # Test day interval fetched same day
     def test_sameDay(self):
         interval = yfcd.Interval.Days1
 
         intervalStartD = self.monday
+        repaired = False
 
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -361,15 +362,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(intervalStartD, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(intervalStartD, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("expire_on_candle_close = {}".format(expire_on_candle_close))
                 print("yf_lag = {}".format(yf_lag))
                 print("max_age = {0}".format(max_age))
@@ -380,14 +381,15 @@
                 pprint(response)
                 raise
 
     # Test Friday interval fetched same day when dt_now is next day (weekend)
     def test_nextDayWeekend(self):
         interval = yfcd.Interval.Days1
         intervalStart = self.friday
+        repaired = False
 
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -413,15 +415,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(intervalStart, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(intervalStart, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("answer:")
```

### Comparing `yfinance-cache-0.4.3/tests/test_price_data_aging_1h.py` & `yfinance-cache-0.4.4/tests/test_price_data_aging_1h.py`

 * *Files 0% similar despite different names*

```diff
@@ -107,14 +107,15 @@
                     raise
 
 
     # 1h interval, fetched during or v.soon after, tested during or v.soon after
     def test_duringDay(self):
         interval = yfcd.Interval.Hours1
         interval_start_dt = datetime.combine(self.monday, time(12, 30), self.market_tz)
+        repaired = False
 
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -172,15 +173,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start_dt, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start_dt, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("expire_on_candle_close = {0}".format(expire_on_candle_close))
@@ -190,14 +191,15 @@
                 pprint(response)
                 raise
 
     # 1h interval end-of-day, fetched during interval, tested during | soon after | next morning
     def test_endOfDay(self):
         interval = yfcd.Interval.Hours1
         interval_start_dt = datetime.combine(self.monday, time(15, 30), self.market_tz)
+        repaired = False
         
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -247,15 +249,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start_dt, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start_dt, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("expire_on_candle_close = {}".format(expire_on_candle_close))
@@ -266,14 +268,15 @@
                 pprint(response)
                 raise
 
     # 1h interval end-of-Friday, fetched during interval, tested after market close | next Saturday
     def test_endOfFriday(self):
         interval = yfcd.Interval.Hours1
         interval_start_dt = datetime.combine(self.friday, time(15, 30), self.market_tz)
+        repaired = False
         
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -317,15 +320,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start_dt, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start_dt, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("answer:")
```

### Comparing `yfinance-cache-0.4.3/tests/test_price_data_aging_1w.py` & `yfinance-cache-0.4.4/tests/test_price_data_aging_1w.py`

 * *Files 2% similar despite different names*

```diff
@@ -107,14 +107,15 @@
                     raise
 
 
     # Test same day same week
     def test_sameWeek_sameDay(self):
         interval_start = self.monday
         interval = yfcd.Interval.Week
+        repaired = False
 
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -140,15 +141,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("answer:")
@@ -157,14 +158,15 @@
                 pprint(response)
                 raise
 
     # Test different day same week
     def test_sameWeek_diffDay(self):
         interval_start = self.monday
         interval = yfcd.Interval.Week
+        repaired = False
 
         max_ages = []
         fetch_dts = []
         dt_nows = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -220,15 +222,15 @@
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             dt_now = dt_nows[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("answer:")
@@ -237,14 +239,15 @@
                 pprint(response)
                 raise
 
     # Test weekend following week
     def test_sameWeek_weekend(self):
         interval_start = self.monday
         interval = yfcd.Interval.Week
+        repaired = False
 
         dt_now = datetime.combine(self.saturday, time(9, 0), self.market_tz)
         max_ages = []
         fetch_dts = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -261,15 +264,15 @@
 
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("answer:")
@@ -278,14 +281,15 @@
                 pprint(response)
                 raise
 
     # Test next week
     def test_nextWeek(self):
         interval_start = self.monday
         interval = yfcd.Interval.Week
+        repaired = False
 
         dt_now = datetime.combine(self.monday + timedelta(days=8), time(13, 45), self.market_tz)  # next Monday is holiday
         max_ages = []
         fetch_dts = []
         expire_on_candle_closes = []
         yf_lags = []
         answers = []
@@ -302,15 +306,15 @@
 
         for i in range(len(fetch_dts)):
             fetch_dt = fetch_dts[i]
             max_age = max_ages[i]
             expire_on_candle_close = expire_on_candle_closes[i]
             yf_lag = yf_lags[i]
             answer = answers[i]
-            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
+            response = yfct.IsPriceDatapointExpired(interval_start, fetch_dt, repaired, max_age, self.exchange, interval, triggerExpiryOnClose=expire_on_candle_close, yf_lag=yf_lag, dt_now=dt_now)
             try:
                 self.assertEqual(response, answer)
             except:
                 print("fetch_dt = {0}".format(fetch_dt))
                 print("max_age = {0}".format(max_age))
                 print("dt_now = {0}".format(dt_now))
                 print("answer:")
```

### Comparing `yfinance-cache-0.4.3/tests/test_time_utils.py` & `yfinance-cache-0.4.4/tests/test_time_utils.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_utils.py` & `yfinance-cache-0.4.4/tests/test_utils.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/tests/test_yf_assumptions.py` & `yfinance-cache-0.4.4/tests/test_yf_assumptions.py`

 * *Files 11% similar despite different names*

```diff
@@ -2,30 +2,29 @@
 from pprint import pprint
 
 import yfinance as yf
 
 from .context import yfc_dat as yfcd
 from .context import yfc_time as yfct
 from .context import yfc_utils as yfcu
+from .context import session_gbl
 
 from datetime import datetime, date, time, timedelta, timezone
 from zoneinfo import ZoneInfo
 
 import appdirs
 import requests_cache
 
 import sys, os
 
 class TestYfAssumptions(unittest.TestCase):
 	def setUp(self):
 		self.tkr = "INTC"
 
-		self.session = None
-		self.session = requests_cache.CachedSession(os.path.join(appdirs.user_cache_dir(),'yfinance.cache.testing'))
-		self.session.headers['User-agent'] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko/20100101 Firefox/77.0"
+		self.session = session_gbl
 
 		self.dat = yf.Ticker(self.tkr, session=self.session)
 
 		self.day = date(year=2022, month=1, day=10)
 
 		self.exchange = "NMS"
 		self.market_tz = ZoneInfo('US/Eastern')
```

### Comparing `yfinance-cache-0.4.3/tests/test_yfc_adjust.py` & `yfinance-cache-0.4.4/tests/test_yfc_adjust.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 
 import yfinance as yf
 from .context import yfc_dat as yfcd
 from .context import yfc_time as yfct
 from .context import yfc_cache_manager as yfcm
 from .context import yfc_utils as yfcu
 from .context import yfc_ticker as yfc
+from .context import session_gbl
 from .utils import Test_Base
 import pickle as pkl
 
 import tempfile
 import pandas as pd
 import numpy as np
 
@@ -22,15 +23,15 @@
 import appdirs
 
 
 class Test_Unadjust(Test_Base):
     def setUp(self):
         self.tkrs = ["PNL.L", "I3E.L", "INTC", "GME", "AMC", "ESLT.TA"]
 
-        self.session = requests_cache.CachedSession(os.path.join(appdirs.user_cache_dir(),'yfinance.cache.testing'), expire_after=60*60)
+        self.session = session_gbl
 
         self.tempCacheDir = tempfile.TemporaryDirectory()
         yfcm.SetCacheDirpath(self.tempCacheDir.name)
 
     def tearDown(self):
         self.tempCacheDir.cleanup()
         self.session.close()
@@ -63,15 +64,15 @@
 
         dat = yf.Ticker(tkr, self.session)
         answer = dat.history(start=start_d, end=end_d)
 
         dat = yfc.Ticker(tkr, self.session)
         result = dat.history(start=start_d, end=end_d)
 
-        self.verify_df(result, answer, 1e-7)
+        self.verify_df(result, answer, 5e-5)
 
 
     def test_adjust_append1(self):
         # Have Jan->Jul cached. Fetch August (stock split), should append and back-adjust correctly
 
         tkr = "PNL.L"
         dat = yfc.Ticker(tkr, self.session)
@@ -194,21 +195,20 @@
         answer_noadjust.index = answer_noadjust.index.tz_convert(tz)
 
         self.verify_df(df, answer_noadjust, 1e-10)
 
 
     def test_weekly_simple(self):
         start_d = date(2022,1,3)
-        end_d = date(2022,8,20)
+        end_d = date(2022,8,22)
 
         for tkr in self.tkrs:
             dat = yfc.Ticker(tkr, session=self.session)
             tz = ZoneInfo(dat.fast_info["timezone"])
             df_yfc = dat.history(start=start_d, end=end_d, interval="1wk")
-            # print("df_yfc:") ; print(df_yfc.loc["2022-07-25"]) ; quit()
 
             dat_yf = yf.Ticker(tkr, session=self.session)
 
             # First compare against YF daily data (aggregated by week)
             df_yf = dat_yf.history(start=start_d, end=end_d, interval="1d")
             df_yf_weekly = df_yf.copy()
             df_yf_weekly["_weekStart"] = pd.to_datetime(df_yf_weekly.index.tz_localize(None).to_period('W-SUN').start_time).tz_localize(tz)
@@ -220,23 +220,23 @@
                 High=("High", "max"),
                 Volume=("Volume", "sum"),
                 Dividends=("Dividends", "sum"),
                 StockSplits=("Stock Splits", "prod")).rename(columns={"StockSplits":"Stock Splits"})
             df_yf_weekly.loc[df_yf_weekly["Stock Splits"]==1,"Stock Splits"]=0
             # Loose tolerance because just checking that in same ballpark
             self.verify_df(df_yfc, df_yf_weekly, 1e-1)
+            # self.verify_df(df_yfc.drop(['Volume'], axis=1), df_yf_weekly.drop(['Volume'], axis=1), 1e-1)
 
             # Now compare against YF weekly
             if tkr.endswith(".TA"):
                 # YF struggles with TLV exchange
                 df_yf = dat_yf.history(start=start_d-timedelta(days=2), end=end_d, interval="1wk", repair=True)
                 df_yf = df_yf[df_yf.index.date>=start_d]
             else:
                 df_yf = dat_yf.history(start=start_d, end=end_d, interval="1wk", repair=True)
-            # self.verify_df(df_yfc, df_yf, 1e-7)
             self.verify_df(df_yfc, df_yf, 5e-6)
 
     def test_weekly_append(self):
         start1_d = date(2022,1,3)
         end1_d = date(2022,6,27)
 
         start2_d = date(2022,6,27)
```

### Comparing `yfinance-cache-0.4.3/tests/test_yfc_backend.py` & `yfinance-cache-0.4.4/tests/test_yfc_backend.py`

 * *Files 20% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 from pprint import pprint
 
 from .context import yfc_dat as yfcd
 from .context import yfc_time as yfct
 from .context import yfc_cache_manager as yfcm
 from .context import yfc_utils as yfcu
 from .context import yfc_ticker as yfc
+from .context import session_gbl
 
 import yfinance as yf
 
 import tempfile
 
 import pandas as pd
 import numpy as np
@@ -35,14 +36,22 @@
 ##  -- April --
 ##  Mo   Tu   We   Th   Fr   Sa   Su
 ##  4    5    6    7    8    9    10
 ##  11   12   13   14   15*  16   17
 ##  18*  19   20   21   22   23   24
 ##  25*
 ##
+## London
+##  -- April --
+##  Mo   Tu   We   Th   Fr   Sa   Su
+##  4    5    6    7    8    9    10
+##  11   12   13   14   15*  16   17
+##  18*  19   20   21   22   23   24
+##  25
+##
 ## Taiwan
 ##  -- February --
 ##  Mo   Tu   We   Th   Fr   Sa   Su
 ##  -    1*   2*   3*   4*   5*   6*
 ##  7    8    9    10   11   12   13
 ##  14   15   16   17   18   19   20
 ##  21*  22   23   24   25   26   27
@@ -50,18 +59,15 @@
 
 class Test_Yfc_Backend(unittest.TestCase):
 
     def setUp(self):
         self.tempCacheDir = tempfile.TemporaryDirectory()
         yfcm.SetCacheDirpath(self.tempCacheDir.name)
 
-        self.session = None
-        import requests_cache
-        self.session = requests_cache.CachedSession(os.path.join(appdirs.user_cache_dir(),'yfinance.cache.testing'))
-        self.session.headers['User-agent'] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko/20100101 Firefox/77.0"
+        self.session = session_gbl
 
         self.usa_tkr = "INTC"
         self.usa_market = "us_market"
         self.usa_exchange = "NMS"
         self.usa_market_tz_name = 'America/New_York'
         self.usa_market_tz = ZoneInfo('America/New_York')
         self.usa_market_open_time  = time(9, 30)
@@ -73,14 +79,19 @@
         self.nze_exchange = "NZE"
         self.nze_market_tz_name = 'Pacific/Auckland'
         self.nze_market_tz = ZoneInfo('Pacific/Auckland')
         self.nze_market_open_time  = time(10)
         self.nze_market_close_time = time(16, 45)
         self.nze_dat = yfc.Ticker(self.nze_tkr, session=self.session)
 
+        self.uk_exchange = "LSE"
+        self.uk_market_tz_name = "Europe/London"
+        self.uk_market_tz = ZoneInfo(self.uk_market_tz_name)
+        self.uk_market_open_time = time(8)
+
         self.td1h = timedelta(hours=1)
         self.td1d = timedelta(days=1)
 
     def tearDown(self):
         self.tempCacheDir.cleanup()
         self.session.close()
 
@@ -181,44 +192,60 @@
             day = date(2022, 4, d)
             dt = datetime.combine(day, time(14), tz)
             dts.append(dt)
             if d == 8:
                 answers.append(datetime.combine(day+3*self.td1d, time(10), tz))
             else:
                 answers.append(datetime.combine(day+self.td1d, time(10), tz))
+        response_batch = yfct.CalcIntervalLastDataDt_batch(exchange, dts, interval, yf_lag=lag)
         for i in range(len(dts)):
             response = yfct.CalcIntervalLastDataDt(exchange, dts[i], interval, yf_lag=lag)
             try:
                 self.assertEqual(response, answers[i])
             except:
                 print("dt = {}".format(dts[i]))
                 print("response = {}".format(response))
                 print("answer = {}".format(answers[i]))
                 raise
+            try:
+                self.assertEqual(response_batch[i], answers[i])
+            except:
+                print("dt = {}".format(dts[i]))
+                print("response_batch[i] = {}".format(response_batch[i]))
+                print("answer = {}".format(answers[i]))
+                raise
 
         lag = timedelta(minutes=15)
         dts = []
         answers = []
         for d in range(4, 9):
             day = date(2022, 4, d)
             dt = datetime.combine(day, time(14), tz)
             dts.append(dt)
             if d == 8:
                 answers.append(datetime.combine(day+3*self.td1d, time(10), tz) + lag)
             else:
                 answers.append(datetime.combine(day+self.td1d, time(10), tz) + lag)
+        response_batch = yfct.CalcIntervalLastDataDt_batch(exchange, dts, interval, yf_lag=lag)
         for i in range(len(dts)):
             response = yfct.CalcIntervalLastDataDt(exchange, dts[i], interval, yf_lag=lag)
             try:
                 self.assertEqual(response, answers[i])
             except:
                 print("dt = {}".format(dts[i]))
                 print("response = {}".format(response))
                 print("answer = {}".format(answers[i]))
                 raise
+            try:
+                self.assertEqual(response_batch[i], answers[i])
+            except:
+                print("dt = {}".format(dts[i]))
+                print("response_batch[i] = {}".format(response_batch[i]))
+                print("answer = {}".format(answers[i]))
+                raise
 
     def test_CalcIntervalLastDataDt_NZE_weekly(self):
         interval = yfcd.Interval.Week
 
         exchange = self.nze_exchange
         tz = self.nze_market_tz
         yfct.SetExchangeTzName(exchange, self.nze_market_tz_name)
@@ -267,14 +294,78 @@
                 self.assertEqual(response_batch[i], answers[i])
             except:
                 print("dt = {}".format(dts[i]))
                 print("response_batch[i] = {}".format(response_batch[i]))
                 print("answer = {}".format(answers[i]))
                 raise
 
+    def test_CalcIntervalLastDataDt_UK_daily(self):
+        interval = yfcd.Interval.Days1
+
+        exchange = self.uk_exchange
+        tz = self.uk_market_tz
+        yfct.SetExchangeTzName(exchange, self.uk_market_tz_name)
+
+        lag = timedelta(0)
+        dts = []
+        answers = []
+        for d in range(4, 9):
+            day = date(2022, 4, d)
+            dt = datetime.combine(day, time(14), tz)
+            dts.append(dt)
+            if d == 8:
+                answers.append(datetime.combine(day+3*self.td1d, self.uk_market_open_time, tz))
+            else:
+                answers.append(datetime.combine(day+self.td1d, self.uk_market_open_time, tz))
+        response_batch = yfct.CalcIntervalLastDataDt_batch(exchange, dts, interval, yf_lag=lag)
+        for i in range(len(dts)):
+            response = yfct.CalcIntervalLastDataDt(exchange, dts[i], interval, yf_lag=lag)
+            try:
+                self.assertEqual(response, answers[i])
+            except:
+                print("dt = {}".format(dts[i]))
+                print("response = {}".format(response))
+                print("answer = {}".format(answers[i]))
+                raise
+            try:
+                self.assertEqual(response_batch[i], answers[i])
+            except:
+                print("dt = {}".format(dts[i]))
+                print("response_batch[i] = {}".format(response_batch[i]))
+                print("answer = {}".format(answers[i]))
+                raise
+
+        lag = timedelta(minutes=15)
+        dts = []
+        answers = []
+        for d in range(4, 9):
+            day = date(2022, 4, d)
+            dt = datetime.combine(day, time(14), tz)
+            dts.append(dt)
+            if d == 8:
+                answers.append(datetime.combine(day+3*self.td1d, self.uk_market_open_time, tz) + lag)
+            else:
+                answers.append(datetime.combine(day+self.td1d, self.uk_market_open_time, tz) + lag)
+        response_batch = yfct.CalcIntervalLastDataDt_batch(exchange, dts, interval, yf_lag=lag)
+        for i in range(len(dts)):
+            response = yfct.CalcIntervalLastDataDt(exchange, dts[i], interval, yf_lag=lag)
+            try:
+                self.assertEqual(response, answers[i])
+            except:
+                print("dt = {}".format(dts[i]))
+                print("response = {}".format(response))
+                print("answer = {}".format(answers[i]))
+                raise
+            try:
+                self.assertEqual(response_batch[i], answers[i])
+            except:
+                print("dt = {}".format(dts[i]))
+                print("response_batch[i] = {}".format(response_batch[i]))
+                print("answer = {}".format(answers[i]))
+                raise
 
     def test_CalcIntervalLastDataDt_UK_weekly(self):
         interval = yfcd.Interval.Week
 
         exchange = "LSE"
         tz = ZoneInfo("Europe/London")
         yfct.SetExchangeTzName(exchange, "Europe/London")
```

### Comparing `yfinance-cache-0.4.3/tests/test_yfc_interface.py` & `yfinance-cache-0.4.4/tests/test_yfc_interface.py`

 * *Files 1% similar despite different names*

```diff
@@ -3,14 +3,15 @@
 from pprint import pprint
 
 from .context import yfc_dat as yfcd
 from .context import yfc_time as yfct
 from .context import yfc_cache_manager as yfcm
 from .context import yfc_utils as yfcu
 from .context import yfc_ticker as yfc
+from .context import session_gbl
 from .utils import Test_Base
 import pickle as pkl
 
 import yfinance as yf
 
 import pandas as pd
 import numpy as np
@@ -45,18 +46,15 @@
 
 class Test_Yfc_Interface(Test_Base):
 
     def setUp(self):
         self.tempCacheDir = tempfile.TemporaryDirectory()
         yfcm.SetCacheDirpath(self.tempCacheDir.name)
 
-        self.session = None
-        import requests_cache
-        self.session = requests_cache.CachedSession(os.path.join(appdirs.user_cache_dir(),'yfinance.cache.testing'), expire_after=60*60)
-        self.session.headers['User-agent'] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:77.0) Gecko/20100101 Firefox/77.0"
+        self.session = session_gbl
 
         self.tkrs = ["MEL.NZ", "BHG.JO", "INTC"]
         self.tkrs.append("HLTH") # Listed recently
         self.tkrs.append("GME") # Stock split recently
         self.tkrs.append("BHP.AX") # ASX market has auction
         # self.tkrs.append("ICL.TA") # TLV market has auction and odd times  # disabling until I restore 'yahooWeeklyDef'
 
@@ -357,26 +355,25 @@
 
     def test_matches_yf_daily_nze(self):
         dat_yf = yf.Ticker(self.nze_tkr, session=self.session)
 
         start_day_str = "2022-06-13"
         end_day_str = "2022-06-18"
 
-        for aa in [False, True]:
+        for aa in [False,True]:
             df_yf = dat_yf.history(start=start_day_str, end=end_day_str, auto_adjust=aa, back_adjust=False)
             df_yfc = self.nze_dat.history(start=start_day_str, end=end_day_str, adjust_divs=aa)
 
             for c in yfcd.yf_data_cols:
                 if not c in df_yf.columns:
                     continue
                 elif c == "Adj Close" and not c in df_yfc.columns:
                     continue
                 try:
                     if aa or "Adj" in c:
-                        # self.assertTrue(np.isclose(df_yf[c].values, df_yfc[c].values, rtol=1e-10).all())
                         self.assertTrue(np.isclose(df_yf[c].values, df_yfc[c].values, rtol=5e-6).all())
                     else:
                         self.assertTrue(np.equal(df_yf[c].values, df_yfc[c].values).all())
                 except:
                     print("df_yf:")
                     print(df_yf[[c]])
                     print("df_yfc:")
@@ -460,25 +457,22 @@
                 raise
 
 
     def test_periods(self):
         tkrs = self.tkrs
         periods = [p for p in yfcd.Period]
         #
-        # tkrs = ["BHP.AX"]
-        # periods = [yfcd.Period.Max]
         for tkr in tkrs:
             dat_yf = yf.Ticker(tkr, session=self.session)
             for p in periods:
-                # print(tkr, p)
                 self.tempCacheDir.cleanup() ; self.tempCacheDir = tempfile.TemporaryDirectory()
                 yfcm.SetCacheDirpath(self.tempCacheDir.name)
                 dat_yfc = yfc.Ticker(tkr, session=self.session)
                 try:
-                    df_yf = dat_yf.history(period=yfcd.periodToString[p], auto_adjust=False)
+                    df_yf = dat_yf.history(period=yfcd.periodToString[p], auto_adjust=False, repair=True)
                 except Exception as e:
                     if "No data found for this date range" in str(e):
                         # Skip
                         continue
                     else:
                         raise
                 # Remove any rows when exchange was closed. Yahoo can be naughty and fill in rows when exchange closed.
@@ -509,15 +503,14 @@
                     if len(missing_from_yf)>0:
                         print("missing_from_yf:")
                         print(missing_from_yf)
                     if len(missing_from_yfc)>0:
                         print("missing_from_yfc:")
                         # print(missing_from_yfc)
                         print(df_yf.loc[missing_from_yfc])
-                        print(df_yfc["1998-10-25":"1998-11-05"])
                     print("Different shapes")
                     raise
                 try:
                     self.assertTrue(np.equal(df_yf.index, df_yfc.index).all())
                 except:
                     print("df_yf:",df_yf.shape)
                     print(df_yf)
@@ -541,15 +534,15 @@
         periods = [p for p in yfcd.Period]
         #
         for tkr in tkrs:
             dat_yf = yf.Ticker(tkr, session=self.session)
             dat_yfc = yfc.Ticker(tkr, session=self.session)
             for p in periods:
                 try:
-                    df_yf = dat_yf.history(period=yfcd.periodToString[p], auto_adjust=False)
+                    df_yf = dat_yf.history(period=yfcd.periodToString[p], auto_adjust=False, repair=True)
                 except Exception as e:
                     if "No data found for this date range" in str(e):
                         # Skip
                         continue
                     else:
                         raise
                 # Remove any rows when exchange was closed. Yahoo can be naughty and fill in rows when exchange closed.
```

### Comparing `yfinance-cache-0.4.3/tests/utils.py` & `yfinance-cache-0.4.4/tests/utils.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,13 +1,12 @@
 import numpy as np
 import unittest
 from pprint import pprint
 
 class Test_Base(unittest.TestCase):
-# class Test_Base:
     def verify_df(self, df, answer, rtol=None, different=False):
         if (df is None or df.shape[0]==0) and (answer is None or answer.shape[0]==0):
             return
 
         if df is None:
             print("df is None but answer is:")
             print(answer)
@@ -60,15 +59,18 @@
                 continue
 
             # if (rtol is None) or (rtol == 0):
             #     f = np.array_equal(df[dc], answer[dc], equal_nan=True)
             # else:
             if rtol is None:
                 rtol = 0.0
-            f = np.isclose(df[dc].values, answer[dc].values, equal_nan=True, rtol=rtol)
+            if dc == 'Volume':
+                f = np.abs(df[dc].values - answer[dc].values) <= 1
+            else:
+                f = np.isclose(df[dc].values, answer[dc].values, equal_nan=True, rtol=rtol)
 
             if different:
                 # Test requires difference, not equality
                 f = ~f
             else:
                 if not last_row_final:
                     ## Ignore last row because data is live, can change between YF and YFC calls
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/__init__.py` & `yfinance-cache-0.4.4/yfinance_cache/__init__.py`

 * *Files 13% similar despite different names*

```diff
@@ -16,9 +16,15 @@
 _separate_events_from_prices()
 _fix_dividend_adjust()
 
 from .yfc_upgrade import _fix_listing_date, _upgrade_divs_splits_supersede
 _fix_listing_date()
 _upgrade_divs_splits_supersede()
 
-# __all__ = ['Ticker', 'Period', 'Interval']
+from .yfc_upgrade import _add_repaired_column
+_add_repaired_column()
 
+from .yfc_upgrade import _recalc_final_column
+_recalc_final_column()
+
+from .yfc_upgrade import _upgrade_divs_supersede_again
+_upgrade_divs_supersede_again()
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_cache_manager.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_cache_manager.py`

 * *Files identical despite different names*

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_dat.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_dat.py`

 * *Files 1% similar despite different names*

```diff
@@ -216,14 +216,15 @@
 exchangeToXcalExchange["NYQ"] = "XNYS"
 exchangeToXcalExchange["ASE"] = exchangeToXcalExchange["NYQ"]
 exchangeToXcalExchange["PCX"] = exchangeToXcalExchange["NYQ"]  # NYSE Arca
 exchangeToXcalExchange["PNK"] = exchangeToXcalExchange["NYQ"]  # OTC
 exchangeToXcalExchange["NCM"] = "NASDAQ"
 exchangeToXcalExchange["NGM"] = exchangeToXcalExchange["NCM"]
 exchangeToXcalExchange["NMS"] = exchangeToXcalExchange["NCM"]
+exchangeToXcalExchange["BTS"] = exchangeToXcalExchange["NYQ"]  # Cboe BZX formerly known as BATS
 # Canada:
 exchangeToXcalExchange["TOR"] = "XTSE"  # Toronto
 exchangeToXcalExchange["VAN"] = exchangeToXcalExchange["TOR"]  # TSX Venture
 exchangeToXcalExchange["CNQ"] = exchangeToXcalExchange["TOR"]  # CSE. TSX competitor, but has same hours
 # Europe:
 exchangeToXcalExchange["LSE"] = "XLON"  # London
 exchangeToXcalExchange["IOB"] = exchangeToXcalExchange["LSE"]
@@ -240,16 +241,18 @@
 exchangeToXcalExchange["MIL"] = "XMIL"  # Milan
 exchangeToXcalExchange["OSL"] = "XOSL"  # Oslo
 exchangeToXcalExchange["PAR"] = "XPAR"  # Paris
 exchangeToXcalExchange["STO"] = "XSTO"  # Stockholm
 exchangeToXcalExchange["VIE"] = "XWBO"  # Vienna
 # Other:
 exchangeToXcalExchange["TLV"] = "XTAE"  # Israel
-exchangeToXcalExchange["JNB"] = "XJSE"  # Johannesburg
-exchangeToXcalExchange["SAO"] = "BVMF"  # Sao Paulo
+exchangeToXcalExchange["JNB"] = "XJSE"  # Johannesburg, South Africa
+exchangeToXcalExchange["SAO"] = "BVMF"  # Sao Paulo, Brazil
+exchangeToXcalExchange["SGO"] = "XSGO"  # Santiago, Chile
+exchangeToXcalExchange["BVC"] = "XBOG"  # Bogota, Colombia
 exchangeToXcalExchange["JPX"] = "JPX"   # Tokyo
 exchangeToXcalExchange["TAI"] = "XTAI"  # Taiwan
 exchangeToXcalExchange["KSC"] = "XKRX"  # Korea
 exchangeToXcalExchange["SES"] = "XSES"  # Singapore
 exchangeToXcalExchange["HKG"] = "XHKG"  # Hong Kong
 exchangeToXcalExchange["ASX"] = "ASX"   # Australia
 exchangeToXcalExchange["NZE"] = "XNZE"  # New Zealand
@@ -263,14 +266,15 @@
 exchangeToYfLag["NYQ"] = timedelta(seconds=0)
 exchangeToYfLag["ASE"] = exchangeToYfLag["NYQ"]
 exchangeToYfLag["PCX"] = exchangeToYfLag["NYQ"]
 exchangeToYfLag["PNK"] = timedelta(minutes=15)
 exchangeToYfLag["NCM"] = exchangeToYfLag["ASE"]
 exchangeToYfLag["NGM"] = exchangeToYfLag["ASE"]
 exchangeToYfLag["NMS"] = exchangeToYfLag["ASE"]
+exchangeToYfLag["BTS"] = exchangeToYfLag["NYQ"]
 # Canada:
 exchangeToYfLag["TOR"] = timedelta(seconds=0)
 exchangeToYfLag["VAN"] = exchangeToYfLag["TOR"]
 exchangeToYfLag["CNQ"] = exchangeToYfLag["TOR"]
 # Europe:
 exchangeToYfLag["LSE"] = timedelta(minutes=20)
 exchangeToYfLag["IOB"] = timedelta(minutes=20)
@@ -289,14 +293,16 @@
 exchangeToYfLag["PAR"] = timedelta(minutes=15)
 exchangeToYfLag["STO"] = timedelta(0)
 exchangeToYfLag["VIE"] = timedelta(minutes=15)
 # Other:
 exchangeToYfLag["TLV"] = timedelta(minutes=20)
 exchangeToYfLag["JNB"] = timedelta(minutes=15)
 exchangeToYfLag["SAO"] = timedelta(minutes=15)
+exchangeToYfLag["SGO"] = timedelta(minutes=15)
+exchangeToYfLag["BVC"] = timedelta(minutes=15)  # Guess because Yahoo don't specify
 exchangeToYfLag["JPX"] = timedelta(minutes=20)
 exchangeToYfLag["TAI"] = timedelta(minutes=20)
 exchangeToYfLag["KSC"] = timedelta(minutes=20)
 exchangeToYfLag["SES"] = timedelta(minutes=20)
 exchangeToYfLag["HKG"] = timedelta(minutes=15)
 exchangeToYfLag["ASX"] = timedelta(minutes=20)
 exchangeToYfLag["NZE"] = timedelta(minutes=20)
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_logging.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_logging.py`

 * *Files 12% similar despite different names*

```diff
@@ -29,22 +29,21 @@
     log_file_handler = logging.FileHandler(log_fp, mode='a')
     log_file_handler.setFormatter(formatter)
     # screen_handler = logging.StreamHandler(stream=sys.stdout)
     # screen_handler.setFormatter(formatter)
     logger = logging.getLogger(tkr)
     logger.setLevel(logging.DEBUG)
     logger.addHandler(log_file_handler)
-    # self.logger.addHandler(screen_handler)
+    logger.propagate = False
 
     loggers[tkr] = logger
     return logger
 
 
 yfc_trace_mode = False
-# yfc_trace_mode = True
 
 def EnableTracing():
     global yfc_trace_mode
     yfc_trace_mode = True
 
 def DisableTracing():
     global yfc_trace_mode
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_prices_manager.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_prices_manager.py`

 * *Files 2% similar despite different names*

```diff
@@ -21,10490 +21,10859 @@
 00000140: 6461 7465 7469 6d65 2c20 6461 7465 2c20  datetime, date, 
 00000150: 7469 6d65 2c20 7469 6d65 6465 6c74 610a  time, timedelta.
 00000160: 696d 706f 7274 2064 6174 6575 7469 6c0a  import dateutil.
 00000170: 6672 6f6d 207a 6f6e 6569 6e66 6f20 696d  from zoneinfo im
 00000180: 706f 7274 205a 6f6e 6549 6e66 6f0a 6672  port ZoneInfo.fr
 00000190: 6f6d 2070 7072 696e 7420 696d 706f 7274  om pprint import
 000001a0: 2070 7072 696e 740a 696d 706f 7274 2063   pprint.import c
-000001b0: 6c69 636b 0a0a 0a23 2054 4f44 4f73 3a0a  lick...# TODOs:.
-000001c0: 2320 2d20 7768 656e 2066 696c 6c69 6e67  # - when filling
-000001d0: 2061 206d 6973 7369 6e67 2069 6e74 6572   a missing inter
-000001e0: 7661 6c20 7769 7468 204e 614e 732c 2074  val with NaNs, t
-000001f0: 7279 2074 6f20 7265 636f 6e73 7472 7563  ry to reconstruc
-00000200: 7420 6669 7273 740a 0a0a 636c 6173 7320  t first...class 
-00000210: 4869 7374 6f72 6965 734d 616e 6167 6572  HistoriesManager
-00000220: 3a0a 2020 2020 2320 496e 7465 6e64 6564  :.    # Intended
-00000230: 2061 7320 7369 6e67 6c65 2074 6f20 636c   as single to cl
-00000240: 6173 7320 746f 2065 6e73 7572 653a 0a20  ass to ensure:. 
-00000250: 2020 2023 202d 206f 6e6c 7920 6f6e 6520     # - only one 
-00000260: 4869 7374 6f72 7928 2920 6f62 6a65 6374  History() object
-00000270: 2065 7869 7374 7320 666f 7220 6561 6368   exists for each
-00000280: 2074 696d 6573 6361 6c65 2f64 6174 6120   timescale/data 
-00000290: 7479 7065 0a20 2020 2023 202d 2064 6966  type.    # - dif
-000002a0: 6665 7265 6e74 2048 6973 746f 7279 2829  ferent History()
-000002b0: 206f 626a 6563 7473 2061 6e64 2063 6f6d   objects and com
-000002c0: 6d75 6e69 6361 7465 0a0a 2020 2020 6465  municate..    de
-000002d0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-000002e0: 2074 6963 6b65 722c 2065 7863 6861 6e67   ticker, exchang
-000002f0: 652c 2074 7a4e 616d 652c 2073 6573 7369  e, tzName, sessi
-00000300: 6f6e 2c20 7072 6f78 7929 3a0a 2020 2020  on, proxy):.    
-00000310: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-00000320: 636b 5374 7228 7469 636b 6572 2c20 2274  ckStr(ticker, "t
-00000330: 6963 6b65 7222 290a 2020 2020 2020 2020  icker").        
-00000340: 7966 6375 2e54 7970 6543 6865 636b 5374  yfcu.TypeCheckSt
-00000350: 7228 6578 6368 616e 6765 2c20 2265 7863  r(exchange, "exc
-00000360: 6861 6e67 6522 290a 2020 2020 2020 2020  hange").        
-00000370: 7966 6375 2e54 7970 6543 6865 636b 5374  yfcu.TypeCheckSt
-00000380: 7228 747a 4e61 6d65 2c20 2274 7a4e 616d  r(tzName, "tzNam
-00000390: 6522 290a 0a20 2020 2020 2020 2073 656c  e")..        sel
-000003a0: 662e 7469 636b 6572 203d 2074 6963 6b65  f.ticker = ticke
-000003b0: 720a 2020 2020 2020 2020 7365 6c66 2e65  r.        self.e
-000003c0: 7863 6861 6e67 6520 3d20 6578 6368 616e  xchange = exchan
-000003d0: 6765 0a20 2020 2020 2020 2073 656c 662e  ge.        self.
-000003e0: 747a 4e61 6d65 203d 2074 7a4e 616d 650a  tzName = tzName.
-000003f0: 2020 2020 2020 2020 7365 6c66 2e68 6973          self.his
-00000400: 746f 7269 6573 203d 207b 7d0a 2020 2020  tories = {}.    
-00000410: 2020 2020 7365 6c66 2e73 6573 7369 6f6e      self.session
-00000420: 203d 2073 6573 7369 6f6e 0a20 2020 2020   = session.     
-00000430: 2020 2073 656c 662e 7072 6f78 7920 3d20     self.proxy = 
-00000440: 7072 6f78 790a 0a20 2020 2020 2020 2073  proxy..        s
-00000450: 656c 662e 6c6f 6767 6572 203d 204e 6f6e  elf.logger = Non
-00000460: 650a 0a20 2020 2064 6566 2047 6574 4869  e..    def GetHi
-00000470: 7374 6f72 7928 7365 6c66 2c20 6b65 7929  story(self, key)
-00000480: 3a0a 2020 2020 2020 2020 7065 726d 6974  :.        permit
-00000490: 7465 645f 6b65 7973 203d 2073 6574 2879  ted_keys = set(y
-000004a0: 6663 642e 696e 7465 7276 616c 546f 5374  fcd.intervalToSt
-000004b0: 7269 6e67 2e6b 6579 7328 2929 207c 207b  ring.keys()) | {
-000004c0: 2245 7665 6e74 7322 7d0a 2020 2020 2020  "Events"}.      
-000004d0: 2020 6966 206b 6579 206e 6f74 2069 6e20    if key not in 
-000004e0: 7065 726d 6974 7465 645f 6b65 7973 3a0a  permitted_keys:.
-000004f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00000500: 6520 5661 6c75 6545 7272 6f72 2866 226b  e ValueError(f"k
-00000510: 6579 3d27 7b6b 6579 7d27 2069 7320 696e  ey='{key}' is in
-00000520: 7661 6c69 642c 206d 7573 7420 6265 206f  valid, must be o
-00000530: 6e65 206f 663a 207b 7065 726d 6974 7465  ne of: {permitte
-00000540: 645f 6b65 7973 7d22 290a 0a20 2020 2020  d_keys}")..     
-00000550: 2020 2069 6620 6b65 7920 6e6f 7420 696e     if key not in
-00000560: 2073 656c 662e 6869 7374 6f72 6965 733a   self.histories:
-00000570: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00000580: 6b65 7920 696e 2079 6663 642e 696e 7465  key in yfcd.inte
-00000590: 7276 616c 546f 5374 7269 6e67 2e6b 6579  rvalToString.key
-000005a0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000005b0: 2020 2020 2069 6620 6b65 7920 3d3d 2079       if key == y
-000005c0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-000005d0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-000005e0: 2020 2020 2020 2020 7365 6c66 2e68 6973          self.his
-000005f0: 746f 7269 6573 5b6b 6579 5d20 3d20 5072  tories[key] = Pr
-00000600: 6963 6548 6973 746f 7279 2873 656c 662c  iceHistory(self,
-00000610: 2073 656c 662e 7469 636b 6572 2c20 7365   self.ticker, se
-00000620: 6c66 2e65 7863 6861 6e67 652c 2073 656c  lf.exchange, sel
-00000630: 662e 747a 4e61 6d65 2c20 6b65 792c 2073  f.tzName, key, s
-00000640: 656c 662e 7365 7373 696f 6e2c 2073 656c  elf.session, sel
-00000650: 662e 7072 6f78 792c 2072 6570 6169 723d  f.proxy, repair=
-00000660: 5472 7565 2c20 636f 6e74 6967 756f 7573  True, contiguous
-00000670: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00000680: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00000690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000006a0: 2073 656c 662e 6869 7374 6f72 6965 735b   self.histories[
-000006b0: 6b65 795d 203d 2050 7269 6365 4869 7374  key] = PriceHist
-000006c0: 6f72 7928 7365 6c66 2c20 7365 6c66 2e74  ory(self, self.t
-000006d0: 6963 6b65 722c 2073 656c 662e 6578 6368  icker, self.exch
-000006e0: 616e 6765 2c20 7365 6c66 2e74 7a4e 616d  ange, self.tzNam
-000006f0: 652c 206b 6579 2c20 7365 6c66 2e73 6573  e, key, self.ses
-00000700: 7369 6f6e 2c20 7365 6c66 2e70 726f 7879  sion, self.proxy
-00000710: 2c20 7265 7061 6972 3d54 7275 652c 2063  , repair=True, c
-00000720: 6f6e 7469 6775 6f75 733d 4661 6c73 6529  ontiguous=False)
-00000730: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00000740: 6620 6b65 7920 3d3d 2022 4576 656e 7473  f key == "Events
-00000750: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00000760: 2020 2073 656c 662e 6869 7374 6f72 6965     self.historie
-00000770: 735b 6b65 795d 203d 2045 7665 6e74 7348  s[key] = EventsH
-00000780: 6973 746f 7279 2873 656c 662c 2073 656c  istory(self, sel
-00000790: 662e 7469 636b 6572 2c20 7365 6c66 2e65  f.ticker, self.e
-000007a0: 7863 6861 6e67 652c 2073 656c 662e 747a  xchange, self.tz
-000007b0: 4e61 6d65 2c20 7365 6c66 2e70 726f 7879  Name, self.proxy
-000007c0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-000007d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000007e0: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-000007f0: 696f 6e28 6622 4e6f 7420 696d 706c 656d  ion(f"Not implem
-00000800: 656e 7465 6420 636f 6465 2070 6174 6820  ented code path 
-00000810: 666f 7220 6b65 793d 277b 6b65 797d 2722  for key='{key}'"
-00000820: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00000830: 6e20 7365 6c66 2e68 6973 746f 7269 6573  n self.histories
-00000840: 5b6b 6579 5d0a 0a20 2020 2064 6566 204c  [key]..    def L
-00000850: 6f67 4576 656e 7428 7365 6c66 2c20 6c65  ogEvent(self, le
-00000860: 7665 6c2c 2067 726f 7570 2c20 6d73 6729  vel, group, msg)
-00000870: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00000880: 2079 6663 6c2e 4973 4c6f 6767 696e 6745   yfcl.IsLoggingE
-00000890: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
-000008a0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-000008b0: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-000008c0: 6e73 7461 6e63 6528 6c65 7665 6c2c 2073  nstance(level, s
-000008d0: 7472 2920 6f72 206c 6576 656c 206e 6f74  tr) or level not
-000008e0: 2069 6e20 5b22 6465 6275 6722 2c20 2269   in ["debug", "i
-000008f0: 6e66 6f22 5d3a 0a20 2020 2020 2020 2020  nfo"]:.         
-00000900: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00000910: 6f6e 2822 276c 6576 656c 2720 6d75 7374  on("'level' must
-00000920: 2062 6520 7374 7220 2764 6562 7567 2720   be str 'debug' 
-00000930: 6f72 2027 696e 666f 2722 290a 0a20 2020  or 'info'")..   
-00000940: 2020 2020 2069 6620 7365 6c66 2e6c 6f67       if self.log
-00000950: 6765 7220 6973 204e 6f6e 653a 0a20 2020  ger is None:.   
-00000960: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-00000970: 6767 6572 203d 2079 6663 6c2e 4765 744c  gger = yfcl.GetL
-00000980: 6f67 6765 7228 7365 6c66 2e74 6963 6b65  ogger(self.ticke
-00000990: 7229 0a0a 2020 2020 2020 2020 6675 6c6c  r)..        full
-000009a0: 5f6d 7367 203d 2066 227b 6772 6f75 707d  _msg = f"{group}
-000009b0: 3a20 7b6d 7367 7d22 0a20 2020 2020 2020  : {msg}".       
-000009c0: 2069 6620 6c65 7665 6c20 3d3d 2022 6465   if level == "de
-000009d0: 6275 6722 3a0a 2020 2020 2020 2020 2020  bug":.          
-000009e0: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-000009f0: 6275 6728 6675 6c6c 5f6d 7367 290a 2020  bug(full_msg).  
-00000a00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00000a10: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00000a20: 6765 722e 696e 666f 2866 756c 6c5f 6d73  ger.info(full_ms
-00000a30: 6729 0a0a 0a63 6c61 7373 2045 7665 6e74  g)...class Event
-00000a40: 7348 6973 746f 7279 3a0a 2020 2020 6465  sHistory:.    de
-00000a50: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00000a60: 206d 616e 6167 6572 2c20 7469 636b 6572   manager, ticker
-00000a70: 2c20 6578 6368 616e 6765 2c20 747a 4e61  , exchange, tzNa
-00000a80: 6d65 2c20 7072 6f78 7929 3a0a 2020 2020  me, proxy):.    
-00000a90: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00000aa0: 7461 6e63 6528 6d61 6e61 6765 722c 2048  tance(manager, H
-00000ab0: 6973 746f 7269 6573 4d61 6e61 6765 7229  istoriesManager)
-00000ac0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00000ad0: 6973 6520 5479 7065 4572 726f 7228 6622  ise TypeError(f"
-00000ae0: 276d 616e 6167 6572 2720 6d75 7374 2062  'manager' must b
-00000af0: 6520 4869 7374 6f72 6965 734d 616e 6167  e HistoriesManag
-00000b00: 6572 206e 6f74 207b 7479 7065 286d 616e  er not {type(man
-00000b10: 6167 6572 297d 2229 0a20 2020 2020 2020  ager)}").       
-00000b20: 2079 6663 752e 5479 7065 4368 6563 6b53   yfcu.TypeCheckS
-00000b30: 7472 2874 6963 6b65 722c 2022 7469 636b  tr(ticker, "tick
-00000b40: 6572 2229 0a20 2020 2020 2020 2079 6663  er").        yfc
-00000b50: 752e 5479 7065 4368 6563 6b53 7472 2865  u.TypeCheckStr(e
-00000b60: 7863 6861 6e67 652c 2022 6578 6368 616e  xchange, "exchan
-00000b70: 6765 2229 0a20 2020 2020 2020 2079 6663  ge").        yfc
-00000b80: 752e 5479 7065 4368 6563 6b53 7472 2874  u.TypeCheckStr(t
-00000b90: 7a4e 616d 652c 2022 747a 4e61 6d65 2229  zName, "tzName")
-00000ba0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
-00000bb0: 616e 6167 6572 203d 206d 616e 6167 6572  anager = manager
-00000bc0: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
-00000bd0: 636b 6572 203d 2074 6963 6b65 720a 2020  cker = ticker.  
-00000be0: 2020 2020 2020 7365 6c66 2e65 7863 6861        self.excha
-00000bf0: 6e67 6520 3d20 6578 6368 616e 6765 0a20  nge = exchange. 
-00000c00: 2020 2020 2020 2073 656c 662e 747a 4e61         self.tzNa
-00000c10: 6d65 203d 2074 7a4e 616d 650a 2020 2020  me = tzName.    
-00000c20: 2020 2020 7365 6c66 2e70 726f 7879 203d      self.proxy =
-00000c30: 2070 726f 7879 0a0a 2020 2020 2020 2020   proxy..        
-00000c40: 7365 6c66 2e74 7a20 3d20 5a6f 6e65 496e  self.tz = ZoneIn
-00000c50: 666f 2873 656c 662e 747a 4e61 6d65 290a  fo(self.tzName).
-00000c60: 0a20 2020 2020 2020 2069 6620 7966 636d  .        if yfcm
-00000c70: 2e49 7344 6174 756d 4361 6368 6564 2873  .IsDatumCached(s
-00000c80: 656c 662e 7469 636b 6572 2c20 2264 6976  elf.ticker, "div
-00000c90: 6964 656e 6473 2229 3a0a 2020 2020 2020  idends"):.      
-00000ca0: 2020 2020 2020 7365 6c66 2e64 6976 7320        self.divs 
-00000cb0: 3d20 7966 636d 2e52 6561 6443 6163 6865  = yfcm.ReadCache
-00000cc0: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
-00000cd0: 722c 2022 6469 7669 6465 6e64 7322 290a  r, "dividends").
-00000ce0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00000cf0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00000d00: 6976 7320 3d20 4e6f 6e65 0a0a 2020 2020  ivs = None..    
-00000d10: 2020 2020 6966 2079 6663 6d2e 4973 4461      if yfcm.IsDa
-00000d20: 7475 6d43 6163 6865 6428 7365 6c66 2e74  tumCached(self.t
-00000d30: 6963 6b65 722c 2022 7370 6c69 7473 2229  icker, "splits")
+000001b0: 6c69 636b 0a69 6d70 6f72 7420 6c6f 6767  lick.import logg
+000001c0: 696e 670a 0a0a 2320 544f 444f 733a 0a23  ing...# TODOs:.#
+000001d0: 202d 2077 6865 6e20 6669 6c6c 696e 6720   - when filling 
+000001e0: 6120 6d69 7373 696e 6720 696e 7465 7276  a missing interv
+000001f0: 616c 2077 6974 6820 4e61 4e73 2c20 7472  al with NaNs, tr
+00000200: 7920 746f 2072 6563 6f6e 7374 7275 6374  y to reconstruct
+00000210: 2066 6972 7374 0a0a 0a63 6c61 7373 2048   first...class H
+00000220: 6973 746f 7269 6573 4d61 6e61 6765 723a  istoriesManager:
+00000230: 0a20 2020 2023 2049 6e74 656e 6465 6420  .    # Intended 
+00000240: 6173 2073 696e 676c 6520 746f 2063 6c61  as single to cla
+00000250: 7373 2074 6f20 656e 7375 7265 3a0a 2020  ss to ensure:.  
+00000260: 2020 2320 2d20 6f6e 6c79 206f 6e65 2048    # - only one H
+00000270: 6973 746f 7279 2829 206f 626a 6563 7420  istory() object 
+00000280: 6578 6973 7473 2066 6f72 2065 6163 6820  exists for each 
+00000290: 7469 6d65 7363 616c 652f 6461 7461 2074  timescale/data t
+000002a0: 7970 650a 2020 2020 2320 2d20 6469 6666  ype.    # - diff
+000002b0: 6572 656e 7420 4869 7374 6f72 7928 2920  erent History() 
+000002c0: 6f62 6a65 6374 7320 616e 6420 636f 6d6d  objects and comm
+000002d0: 756e 6963 6174 650a 0a20 2020 2064 6566  unicate..    def
+000002e0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+000002f0: 7469 636b 6572 2c20 6578 6368 616e 6765  ticker, exchange
+00000300: 2c20 747a 4e61 6d65 2c20 7365 7373 696f  , tzName, sessio
+00000310: 6e2c 2070 726f 7879 293a 0a20 2020 2020  n, proxy):.     
+00000320: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+00000330: 6b53 7472 2874 6963 6b65 722c 2022 7469  kStr(ticker, "ti
+00000340: 636b 6572 2229 0a20 2020 2020 2020 2079  cker").        y
+00000350: 6663 752e 5479 7065 4368 6563 6b53 7472  fcu.TypeCheckStr
+00000360: 2865 7863 6861 6e67 652c 2022 6578 6368  (exchange, "exch
+00000370: 616e 6765 2229 0a20 2020 2020 2020 2079  ange").        y
+00000380: 6663 752e 5479 7065 4368 6563 6b53 7472  fcu.TypeCheckStr
+00000390: 2874 7a4e 616d 652c 2022 747a 4e61 6d65  (tzName, "tzName
+000003a0: 2229 0a0a 2020 2020 2020 2020 7365 6c66  ")..        self
+000003b0: 2e74 6963 6b65 7220 3d20 7469 636b 6572  .ticker = ticker
+000003c0: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
+000003d0: 6368 616e 6765 203d 2065 7863 6861 6e67  change = exchang
+000003e0: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
+000003f0: 7a4e 616d 6520 3d20 747a 4e61 6d65 0a20  zName = tzName. 
+00000400: 2020 2020 2020 2073 656c 662e 6869 7374         self.hist
+00000410: 6f72 6965 7320 3d20 7b7d 0a20 2020 2020  ories = {}.     
+00000420: 2020 2073 656c 662e 7365 7373 696f 6e20     self.session 
+00000430: 3d20 7365 7373 696f 6e0a 2020 2020 2020  = session.      
+00000440: 2020 7365 6c66 2e70 726f 7879 203d 2070    self.proxy = p
+00000450: 726f 7879 0a0a 2020 2020 2020 2020 7365  roxy..        se
+00000460: 6c66 2e6c 6f67 6765 7220 3d20 4e6f 6e65  lf.logger = None
+00000470: 0a0a 2020 2020 6465 6620 5f5f 6465 6c5f  ..    def __del_
+00000480: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
+00000490: 2069 6620 7365 6c66 2e6c 6f67 6765 7220   if self.logger 
+000004a0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000004b0: 2020 2020 2020 2020 2023 2046 6978 204f           # Fix O
+000004c0: 5320 6572 726f 7220 2254 6f6f 206d 616e  S error "Too man
+000004d0: 7920 6f70 656e 2066 696c 6573 220a 2020  y open files".  
+000004e0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+000004f0: 6f67 6765 722e 6861 6e64 6c65 7273 5b30  ogger.handlers[0
+00000500: 5d2e 636c 6f73 6528 290a 0a20 2020 2064  ].close()..    d
+00000510: 6566 2047 6574 4869 7374 6f72 7928 7365  ef GetHistory(se
+00000520: 6c66 2c20 6b65 7929 3a0a 2020 2020 2020  lf, key):.      
+00000530: 2020 7065 726d 6974 7465 645f 6b65 7973    permitted_keys
+00000540: 203d 2073 6574 2879 6663 642e 696e 7465   = set(yfcd.inte
+00000550: 7276 616c 546f 5374 7269 6e67 2e6b 6579  rvalToString.key
+00000560: 7328 2929 207c 207b 2245 7665 6e74 7322  s()) | {"Events"
+00000570: 7d0a 2020 2020 2020 2020 6966 206b 6579  }.        if key
+00000580: 206e 6f74 2069 6e20 7065 726d 6974 7465   not in permitte
+00000590: 645f 6b65 7973 3a0a 2020 2020 2020 2020  d_keys:.        
+000005a0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000005b0: 7272 6f72 2866 226b 6579 3d27 7b6b 6579  rror(f"key='{key
+000005c0: 7d27 2069 7320 696e 7661 6c69 642c 206d  }' is invalid, m
+000005d0: 7573 7420 6265 206f 6e65 206f 663a 207b  ust be one of: {
+000005e0: 7065 726d 6974 7465 645f 6b65 7973 7d22  permitted_keys}"
+000005f0: 290a 0a20 2020 2020 2020 2069 6620 6b65  )..        if ke
+00000600: 7920 6e6f 7420 696e 2073 656c 662e 6869  y not in self.hi
+00000610: 7374 6f72 6965 733a 0a20 2020 2020 2020  stories:.       
+00000620: 2020 2020 2069 6620 6b65 7920 696e 2079       if key in y
+00000630: 6663 642e 696e 7465 7276 616c 546f 5374  fcd.intervalToSt
+00000640: 7269 6e67 2e6b 6579 7328 293a 0a20 2020  ring.keys():.   
+00000650: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00000660: 6b65 7920 3d3d 2079 6663 642e 496e 7465  key == yfcd.Inte
+00000670: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
+00000680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000690: 7365 6c66 2e68 6973 746f 7269 6573 5b6b  self.histories[k
+000006a0: 6579 5d20 3d20 5072 6963 6548 6973 746f  ey] = PriceHisto
+000006b0: 7279 2873 656c 662c 2073 656c 662e 7469  ry(self, self.ti
+000006c0: 636b 6572 2c20 7365 6c66 2e65 7863 6861  cker, self.excha
+000006d0: 6e67 652c 2073 656c 662e 747a 4e61 6d65  nge, self.tzName
+000006e0: 2c20 6b65 792c 2073 656c 662e 7365 7373  , key, self.sess
+000006f0: 696f 6e2c 2073 656c 662e 7072 6f78 792c  ion, self.proxy,
+00000700: 2072 6570 6169 723d 5472 7565 2c20 636f   repair=True, co
+00000710: 6e74 6967 756f 7573 3d54 7275 6529 0a20  ntiguous=True). 
+00000720: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00000730: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00000740: 2020 2020 2020 2020 2073 656c 662e 6869           self.hi
+00000750: 7374 6f72 6965 735b 6b65 795d 203d 2050  stories[key] = P
+00000760: 7269 6365 4869 7374 6f72 7928 7365 6c66  riceHistory(self
+00000770: 2c20 7365 6c66 2e74 6963 6b65 722c 2073  , self.ticker, s
+00000780: 656c 662e 6578 6368 616e 6765 2c20 7365  elf.exchange, se
+00000790: 6c66 2e74 7a4e 616d 652c 206b 6579 2c20  lf.tzName, key, 
+000007a0: 7365 6c66 2e73 6573 7369 6f6e 2c20 7365  self.session, se
+000007b0: 6c66 2e70 726f 7879 2c20 7265 7061 6972  lf.proxy, repair
+000007c0: 3d54 7275 652c 2063 6f6e 7469 6775 6f75  =True, contiguou
+000007d0: 733d 4661 6c73 6529 0a20 2020 2020 2020  s=False).       
+000007e0: 2020 2020 2065 6c69 6620 6b65 7920 3d3d       elif key ==
+000007f0: 2022 4576 656e 7473 223a 0a20 2020 2020   "Events":.     
+00000800: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00000810: 6869 7374 6f72 6965 735b 6b65 795d 203d  histories[key] =
+00000820: 2045 7665 6e74 7348 6973 746f 7279 2873   EventsHistory(s
+00000830: 656c 662c 2073 656c 662e 7469 636b 6572  elf, self.ticker
+00000840: 2c20 7365 6c66 2e65 7863 6861 6e67 652c  , self.exchange,
+00000850: 2073 656c 662e 747a 4e61 6d65 2c20 7365   self.tzName, se
+00000860: 6c66 2e70 726f 7879 290a 2020 2020 2020  lf.proxy).      
+00000870: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00000880: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00000890: 6520 4578 6365 7074 696f 6e28 6622 4e6f  e Exception(f"No
+000008a0: 7420 696d 706c 656d 656e 7465 6420 636f  t implemented co
+000008b0: 6465 2070 6174 6820 666f 7220 6b65 793d  de path for key=
+000008c0: 277b 6b65 797d 2722 290a 0a20 2020 2020  '{key}'")..     
+000008d0: 2020 2072 6574 7572 6e20 7365 6c66 2e68     return self.h
+000008e0: 6973 746f 7269 6573 5b6b 6579 5d0a 0a20  istories[key].. 
+000008f0: 2020 2064 6566 204c 6f67 4576 656e 7428     def LogEvent(
+00000900: 7365 6c66 2c20 6c65 7665 6c2c 2067 726f  self, level, gro
+00000910: 7570 2c20 6d73 6729 3a0a 2020 2020 2020  up, msg):.      
+00000920: 2020 6966 206e 6f74 2079 6663 6c2e 4973    if not yfcl.Is
+00000930: 4c6f 6767 696e 6745 6e61 626c 6564 2829  LoggingEnabled()
+00000940: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00000950: 7475 726e 0a0a 2020 2020 2020 2020 6966  turn..        if
+00000960: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00000970: 6c65 7665 6c2c 2073 7472 2920 6f72 206c  level, str) or l
+00000980: 6576 656c 206e 6f74 2069 6e20 5b22 6465  evel not in ["de
+00000990: 6275 6722 2c20 2269 6e66 6f22 5d3a 0a20  bug", "info"]:. 
+000009a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000009b0: 2045 7863 6570 7469 6f6e 2822 276c 6576   Exception("'lev
+000009c0: 656c 2720 6d75 7374 2062 6520 7374 7220  el' must be str 
+000009d0: 2764 6562 7567 2720 6f72 2027 696e 666f  'debug' or 'info
+000009e0: 2722 290a 0a20 2020 2020 2020 2069 6620  '")..        if 
+000009f0: 7365 6c66 2e6c 6f67 6765 7220 6973 204e  self.logger is N
+00000a00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00000a10: 2073 656c 662e 6c6f 6767 6572 203d 2079   self.logger = y
+00000a20: 6663 6c2e 4765 744c 6f67 6765 7228 7365  fcl.GetLogger(se
+00000a30: 6c66 2e74 6963 6b65 7229 0a0a 2020 2020  lf.ticker)..    
+00000a40: 2020 2020 6675 6c6c 5f6d 7367 203d 2066      full_msg = f
+00000a50: 227b 6772 6f75 707d 3a20 7b6d 7367 7d22  "{group}: {msg}"
+00000a60: 0a20 2020 2020 2020 2069 6620 6c65 7665  .        if leve
+00000a70: 6c20 3d3d 2022 6465 6275 6722 3a0a 2020  l == "debug":.  
+00000a80: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+00000a90: 6f67 6765 722e 6465 6275 6728 6675 6c6c  ogger.debug(full
+00000aa0: 5f6d 7367 290a 2020 2020 2020 2020 656c  _msg).        el
+00000ab0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00000ac0: 7365 6c66 2e6c 6f67 6765 722e 696e 666f  self.logger.info
+00000ad0: 2866 756c 6c5f 6d73 6729 0a0a 0a63 6c61  (full_msg)...cla
+00000ae0: 7373 2045 7665 6e74 7348 6973 746f 7279  ss EventsHistory
+00000af0: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+00000b00: 5f5f 2873 656c 662c 206d 616e 6167 6572  __(self, manager
+00000b10: 2c20 7469 636b 6572 2c20 6578 6368 616e  , ticker, exchan
+00000b20: 6765 2c20 747a 4e61 6d65 2c20 7072 6f78  ge, tzName, prox
+00000b30: 7929 3a0a 2020 2020 2020 2020 6966 206e  y):.        if n
+00000b40: 6f74 2069 7369 6e73 7461 6e63 6528 6d61  ot isinstance(ma
+00000b50: 6e61 6765 722c 2048 6973 746f 7269 6573  nager, Histories
+00000b60: 4d61 6e61 6765 7229 3a0a 2020 2020 2020  Manager):.      
+00000b70: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+00000b80: 4572 726f 7228 6622 276d 616e 6167 6572  Error(f"'manager
+00000b90: 2720 6d75 7374 2062 6520 4869 7374 6f72  ' must be Histor
+00000ba0: 6965 734d 616e 6167 6572 206e 6f74 207b  iesManager not {
+00000bb0: 7479 7065 286d 616e 6167 6572 297d 2229  type(manager)}")
+00000bc0: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
+00000bd0: 7065 4368 6563 6b53 7472 2874 6963 6b65  peCheckStr(ticke
+00000be0: 722c 2022 7469 636b 6572 2229 0a20 2020  r, "ticker").   
+00000bf0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00000c00: 6563 6b53 7472 2865 7863 6861 6e67 652c  eckStr(exchange,
+00000c10: 2022 6578 6368 616e 6765 2229 0a20 2020   "exchange").   
+00000c20: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+00000c30: 6563 6b53 7472 2874 7a4e 616d 652c 2022  eckStr(tzName, "
+00000c40: 747a 4e61 6d65 2229 0a0a 2020 2020 2020  tzName")..      
+00000c50: 2020 7365 6c66 2e6d 616e 6167 6572 203d    self.manager =
+00000c60: 206d 616e 6167 6572 0a20 2020 2020 2020   manager.       
+00000c70: 2073 656c 662e 7469 636b 6572 203d 2074   self.ticker = t
+00000c80: 6963 6b65 720a 2020 2020 2020 2020 7365  icker.        se
+00000c90: 6c66 2e65 7863 6861 6e67 6520 3d20 6578  lf.exchange = ex
+00000ca0: 6368 616e 6765 0a20 2020 2020 2020 2073  change.        s
+00000cb0: 656c 662e 747a 4e61 6d65 203d 2074 7a4e  elf.tzName = tzN
+00000cc0: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
+00000cd0: 2e70 726f 7879 203d 2070 726f 7879 0a0a  .proxy = proxy..
+00000ce0: 2020 2020 2020 2020 7365 6c66 2e74 7a20          self.tz 
+00000cf0: 3d20 5a6f 6e65 496e 666f 2873 656c 662e  = ZoneInfo(self.
+00000d00: 747a 4e61 6d65 290a 0a20 2020 2020 2020  tzName)..       
+00000d10: 2069 6620 7966 636d 2e49 7344 6174 756d   if yfcm.IsDatum
+00000d20: 4361 6368 6564 2873 656c 662e 7469 636b  Cached(self.tick
+00000d30: 6572 2c20 2264 6976 6964 656e 6473 2229  er, "dividends")
 00000d40: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00000d50: 6c66 2e73 706c 6974 7320 3d20 7966 636d  lf.splits = yfcm
-00000d60: 2e52 6561 6443 6163 6865 4461 7475 6d28  .ReadCacheDatum(
-00000d70: 7365 6c66 2e74 6963 6b65 722c 2022 7370  self.ticker, "sp
-00000d80: 6c69 7473 2229 0a20 2020 2020 2020 2065  lits").        e
-00000d90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00000da0: 2073 656c 662e 7370 6c69 7473 203d 204e   self.splits = N
-00000db0: 6f6e 650a 0a20 2020 2064 6566 2047 6574  one..    def Get
-00000dc0: 4469 7673 2873 656c 662c 2073 7461 7274  Divs(self, start
-00000dd0: 2c20 656e 643d 4e6f 6e65 293a 0a20 2020  , end=None):.   
-00000de0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-00000df0: 6563 6b44 6174 6553 7472 6963 7428 7374  eckDateStrict(st
-00000e00: 6172 742c 2022 7374 6172 7422 290a 2020  art, "start").  
-00000e10: 2020 2020 2020 6966 2065 6e64 2069 7320        if end is 
-00000e20: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00000e30: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-00000e40: 6865 636b 4461 7465 5374 7269 6374 2865  heckDateStrict(e
-00000e50: 6e64 2c20 2265 6e64 2229 0a0a 2020 2020  nd, "end")..    
-00000e60: 2020 2020 6966 2073 656c 662e 6469 7673      if self.divs
-00000e70: 2069 7320 4e6f 6e65 206f 7220 7365 6c66   is None or self
-00000e80: 2e64 6976 732e 656d 7074 793a 0a20 2020  .divs.empty:.   
-00000e90: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00000ea0: 4e6f 6e65 0a0a 2020 2020 2020 2020 747a  None..        tz
-00000eb0: 203d 2073 656c 662e 6469 7673 2e69 6e64   = self.divs.ind
-00000ec0: 6578 5b30 5d2e 747a 0a20 2020 2020 2020  ex[0].tz.       
-00000ed0: 2073 7461 7274 203d 2070 642e 5469 6d65   start = pd.Time
-00000ee0: 7374 616d 7028 7374 6172 7429 2e74 7a5f  stamp(start).tz_
-00000ef0: 6c6f 6361 6c69 7a65 2874 7a29 0a20 2020  localize(tz).   
-00000f00: 2020 2020 2069 6620 656e 6420 6973 206e       if end is n
-00000f10: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00000f20: 2020 2020 2065 6e64 203d 2070 642e 5469       end = pd.Ti
-00000f30: 6d65 7374 616d 7028 656e 6429 2e74 7a5f  mestamp(end).tz_
-00000f40: 6c6f 6361 6c69 7a65 2874 7a29 0a0a 2020  localize(tz)..  
-00000f50: 2020 2020 2020 7464 5f31 6420 3d20 7469        td_1d = ti
-00000f60: 6d65 6465 6c74 6128 6461 7973 3d31 290a  medelta(days=1).
-00000f70: 2020 2020 2020 2020 6966 2065 6e64 2069          if end i
-00000f80: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00000f90: 2020 2020 736c 6320 3d20 7365 6c66 2e64      slc = self.d
-00000fa0: 6976 732e 6c6f 635b 7374 6172 743a 5d0a  ivs.loc[start:].
-00000fb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00000fc0: 2020 2020 2020 2020 2020 736c 6320 3d20            slc = 
-00000fd0: 7365 6c66 2e64 6976 732e 6c6f 635b 7374  self.divs.loc[st
-00000fe0: 6172 743a 656e 642d 7464 5f31 645d 0a20  art:end-td_1d]. 
-00000ff0: 2020 2020 2020 2069 6620 736c 632e 656d         if slc.em
-00001000: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-00001010: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-00001020: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00001030: 2020 2020 2020 2072 6574 7572 6e20 736c         return sl
-00001040: 632e 636f 7079 2829 0a0a 2020 2020 6465  c.copy()..    de
-00001050: 6620 4765 7444 6976 7346 6574 6368 6564  f GetDivsFetched
-00001060: 5369 6e63 6528 7365 6c66 2c20 6474 293a  Since(self, dt):
-00001070: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
-00001080: 7065 4368 6563 6b44 6174 6574 696d 6528  peCheckDatetime(
-00001090: 6474 2c20 2264 7422 290a 0a20 2020 2020  dt, "dt")..     
-000010a0: 2020 2069 6620 7365 6c66 2e64 6976 7320     if self.divs 
-000010b0: 6973 204e 6f6e 6520 6f72 2073 656c 662e  is None or self.
-000010c0: 6469 7673 2e65 6d70 7479 3a0a 2020 2020  divs.empty:.    
-000010d0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-000010e0: 204e 6f6e 650a 2020 2020 2020 2020 656c   None.        el
-000010f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00001100: 6620 3d20 7365 6c66 2e64 6976 735b 2246  f = self.divs["F
-00001110: 6574 6368 4461 7465 225d 203e 2064 740a  etchDate"] > dt.
-00001120: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00001130: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-00001140: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00001150: 2073 656c 662e 6469 7673 5b66 5d2e 636f   self.divs[f].co
-00001160: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-00001170: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00001180: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-00001190: 4e6f 6e65 0a0a 2020 2020 2020 2020 6c6f  None..        lo
-000011a0: 675f 6d73 6720 3d20 2247 6574 4469 7673  g_msg = "GetDivs
-000011b0: 4665 7463 6865 6453 696e 6365 2829 2072  FetchedSince() r
-000011c0: 6574 7572 6e69 6e67 220a 2020 2020 2020  eturning".      
-000011d0: 2020 6966 2072 6573 756c 7420 6973 204e    if result is N
-000011e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000011f0: 206c 6f67 5f6d 7367 202b 3d20 2220 4e6f   log_msg += " No
-00001200: 6e65 220a 2020 2020 2020 2020 656c 7365  ne".        else
-00001210: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00001220: 675f 6d73 6720 2b3d 2066 2220 7b6c 656e  g_msg += f" {len
-00001230: 2872 6573 756c 7429 7d22 0a0a 2020 2020  (result)}"..    
-00001240: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
-00001250: 740a 0a20 2020 2064 6566 2047 6574 5370  t..    def GetSp
-00001260: 6c69 7473 2873 656c 662c 2073 7461 7274  lits(self, start
-00001270: 2c20 656e 643d 4e6f 6e65 293a 0a20 2020  , end=None):.   
-00001280: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-00001290: 6563 6b44 6174 6553 7472 6963 7428 7374  eckDateStrict(st
-000012a0: 6172 742c 2022 7374 6172 7422 290a 2020  art, "start").  
-000012b0: 2020 2020 2020 6966 2065 6e64 2069 7320        if end is 
-000012c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000012d0: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-000012e0: 6865 636b 4461 7465 5374 7269 6374 2865  heckDateStrict(e
-000012f0: 6e64 2c20 2265 6e64 2229 0a0a 2020 2020  nd, "end")..    
-00001300: 2020 2020 7265 7375 6c74 203d 204e 6f6e      result = Non
-00001310: 650a 2020 2020 2020 2020 6966 2073 656c  e.        if sel
-00001320: 662e 7370 6c69 7473 2069 7320 6e6f 7420  f.splits is not 
-00001330: 4e6f 6e65 2061 6e64 206e 6f74 2073 656c  None and not sel
-00001340: 662e 7370 6c69 7473 2e65 6d70 7479 3a0a  f.splits.empty:.
-00001350: 2020 2020 2020 2020 2020 2020 7374 6172              star
-00001360: 7420 3d20 7064 2e54 696d 6573 7461 6d70  t = pd.Timestamp
-00001370: 2873 7461 7274 292e 747a 5f6c 6f63 616c  (start).tz_local
-00001380: 697a 6528 7365 6c66 2e73 706c 6974 732e  ize(self.splits.
-00001390: 696e 6465 785b 305d 2e74 7a29 0a20 2020  index[0].tz).   
-000013a0: 2020 2020 2020 2020 2069 6620 656e 6420           if end 
-000013b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000013c0: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-000013d0: 203d 2070 642e 5469 6d65 7374 616d 7028   = pd.Timestamp(
-000013e0: 656e 6429 2e74 7a5f 6c6f 6361 6c69 7a65  end).tz_localize
-000013f0: 2873 656c 662e 7370 6c69 7473 2e69 6e64  (self.splits.ind
-00001400: 6578 5b30 5d2e 747a 290a 2020 2020 2020  ex[0].tz).      
-00001410: 2020 2020 2020 7464 5f31 6420 3d20 7469        td_1d = ti
-00001420: 6d65 6465 6c74 6128 6461 7973 3d31 290a  medelta(days=1).
-00001430: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-00001440: 6e64 2069 7320 4e6f 6e65 3a0a 2020 2020  nd is None:.    
-00001450: 2020 2020 2020 2020 2020 2020 736c 6320              slc 
-00001460: 3d20 7365 6c66 2e73 706c 6974 732e 6c6f  = self.splits.lo
-00001470: 635b 7374 6172 743a 5d0a 2020 2020 2020  c[start:].      
-00001480: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00001490: 2020 2020 2020 2020 2020 2020 736c 6320              slc 
-000014a0: 3d20 7365 6c66 2e73 706c 6974 732e 6c6f  = self.splits.lo
-000014b0: 635b 7374 6172 743a 656e 642d 7464 5f31  c[start:end-td_1
-000014c0: 645d 0a0a 2020 2020 2020 2020 2020 2020  d]..            
-000014d0: 6966 2073 6c63 2e65 6d70 7479 3a0a 2020  if slc.empty:.  
-000014e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000014f0: 7375 6c74 203d 204e 6f6e 650a 2020 2020  sult = None.    
-00001500: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00001510: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00001520: 7375 6c74 203d 2073 6c63 2e63 6f70 7928  sult = slc.copy(
-00001530: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00001540: 6e20 7265 7375 6c74 0a0a 2020 2020 6465  n result..    de
-00001550: 6620 4765 7453 706c 6974 7346 6574 6368  f GetSplitsFetch
-00001560: 6564 5369 6e63 6528 7365 6c66 2c20 6474  edSince(self, dt
-00001570: 293a 0a20 2020 2020 2020 2079 6663 752e  ):.        yfcu.
-00001580: 5479 7065 4368 6563 6b44 6174 6574 696d  TypeCheckDatetim
-00001590: 6528 6474 2c20 2264 7422 290a 0a20 2020  e(dt, "dt")..   
-000015a0: 2020 2020 2069 6620 7365 6c66 2e73 706c       if self.spl
-000015b0: 6974 7320 6973 204e 6f6e 6520 6f72 2073  its is None or s
-000015c0: 656c 662e 7370 6c69 7473 2e65 6d70 7479  elf.splits.empty
-000015d0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000015e0: 7375 6c74 203d 204e 6f6e 650a 2020 2020  sult = None.    
-000015f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00001600: 2020 2020 2020 6620 3d20 7365 6c66 2e73        f = self.s
-00001610: 706c 6974 735b 2246 6574 6368 4461 7465  plits["FetchDate
-00001620: 225d 203e 2064 740a 2020 2020 2020 2020  "] > dt.        
-00001630: 2020 2020 6966 2066 2e61 6e79 2829 3a0a      if f.any():.
-00001640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001650: 7265 7375 6c74 203d 2073 656c 662e 7370  result = self.sp
-00001660: 6c69 7473 5b66 5d2e 636f 7079 2829 0a20  lits[f].copy(). 
-00001670: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00001680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001690: 2072 6573 756c 7420 3d20 4e6f 6e65 0a0a   result = None..
-000016a0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-000016b0: 6573 756c 740a 0a20 2020 2064 6566 2055  esult..    def U
-000016c0: 7064 6174 6553 706c 6974 7328 7365 6c66  pdateSplits(self
-000016d0: 2c20 7370 6c69 7473 5f64 6629 3a0a 2020  , splits_df):.  
-000016e0: 2020 2020 2020 6e20 3d20 7370 6c69 7473        n = splits
-000016f0: 5f64 662e 7368 6170 655b 305d 0a20 2020  _df.shape[0].   
-00001700: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
-00001710: 6e74 6572 2866 2250 4d3a 2055 7064 6174  nter(f"PM: Updat
-00001720: 6553 706c 6974 7328 7b73 706c 6974 735f  eSplits({splits_
-00001730: 6466 2e69 6e64 6578 2e64 6174 657d 2922  df.index.date})"
-00001740: 2920 6966 206e 203c 3d20 3220 656c 7365  ) if n <= 2 else
-00001750: 2079 6663 6c2e 5472 6163 6545 6e74 6572   yfcl.TraceEnter
-00001760: 2866 2250 4d3a 2055 7064 6174 6553 706c  (f"PM: UpdateSpl
-00001770: 6974 7328 6e3d 7b6e 7d29 2229 0a0a 2020  its(n={n})")..  
-00001780: 2020 2020 2020 6465 6275 6720 3d20 4661        debug = Fa
-00001790: 6c73 650a 2020 2020 2020 2020 2320 6465  lse.        # de
-000017a0: 6275 6720 3d20 5472 7565 0a0a 2020 2020  bug = True..    
-000017b0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-000017c0: 636b 4461 7461 4672 616d 6528 7370 6c69  ckDataFrame(spli
-000017d0: 7473 5f64 662c 2022 7370 6c69 7473 5f64  ts_df, "splits_d
-000017e0: 6622 290a 2020 2020 2020 2020 7370 6c69  f").        spli
-000017f0: 7473 5f64 6620 3d20 7370 6c69 7473 5f64  ts_df = splits_d
-00001800: 662e 636f 7079 2829 0a20 2020 2020 2020  f.copy().       
-00001810: 2069 6620 6e6f 7420 7370 6c69 7473 5f64   if not splits_d
-00001820: 662e 656d 7074 793a 0a20 2020 2020 2020  f.empty:.       
-00001830: 2020 2020 2065 7870 6563 7465 645f 636f       expected_co
-00001840: 6c73 203d 205b 2253 746f 636b 2053 706c  ls = ["Stock Spl
-00001850: 6974 7322 2c20 2246 6574 6368 4461 7465  its", "FetchDate
-00001860: 225d 0a20 2020 2020 2020 2020 2020 2066  "].            f
-00001870: 6f72 2063 2069 6e20 6578 7065 6374 6564  or c in expected
-00001880: 5f63 6f6c 733a 0a20 2020 2020 2020 2020  _cols:.         
-00001890: 2020 2020 2020 2069 6620 6320 6e6f 7420         if c not 
-000018a0: 696e 2073 706c 6974 735f 6466 2e63 6f6c  in splits_df.col
-000018b0: 756d 6e73 3a0a 2020 2020 2020 2020 2020  umns:.          
-000018c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000018d0: 5661 6c75 6545 7272 6f72 2822 5570 6461  ValueError("Upda
-000018e0: 7465 5370 6c69 7473 2829 2027 7370 6c69  teSplits() 'spli
-000018f0: 7473 5f64 6627 2063 6f6c 756d 6e73 206d  ts_df' columns m
-00001900: 7573 7420 636f 6e74 6169 6e3a 2027 7b65  ust contain: '{e
-00001910: 7870 6563 7465 645f 636f 6c73 7d27 2229  xpected_cols}'")
-00001920: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00001930: 5072 6570 6172 6520 2773 706c 6974 735f  Prepare 'splits_
-00001940: 6466 2720 666f 7220 6170 7065 6e64 0a20  df' for append. 
-00001950: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00001960: 735f 6466 5b22 5375 7065 7273 6564 6564  s_df["Superseded
-00001970: 2073 706c 6974 225d 203d 2030 2e30 0a20   split"] = 0.0. 
-00001980: 2020 2020 2020 2020 2020 2073 706c 6974             split
-00001990: 735f 6466 5b22 5375 7065 7273 6564 6564  s_df["Superseded
-000019a0: 2073 706c 6974 2046 6574 6368 4461 7465   split FetchDate
-000019b0: 225d 203d 2070 642e 4e61 540a 2020 2020  "] = pd.NaT.    
-000019c0: 2020 2020 2020 2020 666f 7220 6474 2069          for dt i
-000019d0: 6e20 7370 6c69 7473 5f64 662e 696e 6465  n splits_df.inde
-000019e0: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-000019f0: 2020 206e 6577 5f73 706c 6974 203d 2073     new_split = s
-00001a00: 706c 6974 735f 6466 2e6c 6f63 5b64 742c  plits_df.loc[dt,
-00001a10: 2022 5374 6f63 6b20 5370 6c69 7473 225d   "Stock Splits"]
-00001a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001a30: 2069 6620 7365 6c66 2e73 706c 6974 7320   if self.splits 
-00001a40: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00001a50: 6474 2069 6e20 7365 6c66 2e73 706c 6974  dt in self.split
-00001a60: 732e 696e 6465 783a 0a20 2020 2020 2020  s.index:.       
-00001a70: 2020 2020 2020 2020 2020 2020 2063 6163               cac
-00001a80: 6865 645f 7370 6c69 7420 3d20 7365 6c66  hed_split = self
-00001a90: 2e73 706c 6974 732e 6c6f 635b 6474 2c20  .splits.loc[dt, 
-00001aa0: 2253 746f 636b 2053 706c 6974 7322 5d0a  "Stock Splits"].
-00001ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ac0: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
-00001ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ae0: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-00001af0: 5072 696e 7428 6622 7072 652d 6578 6973  Print(f"pre-exis
-00001b00: 7469 6e67 2073 746f 636b 2d73 706c 6974  ting stock-split
-00001b10: 2040 207b 6474 7d3a 207b 6361 6368 6564   @ {dt}: {cached
-00001b20: 5f73 706c 6974 7d20 7673 207b 6e65 775f  _split} vs {new_
-00001b30: 7370 6c69 747d 2229 0a20 2020 2020 2020  split}").       
-00001b40: 2020 2020 2020 2020 2020 2020 2064 6966               dif
-00001b50: 665f 7063 7420 3d20 3130 302a 6162 7328  f_pct = 100*abs(
-00001b60: 6361 6368 6564 5f73 706c 6974 2d6e 6577  cached_split-new
-00001b70: 5f73 706c 6974 292f 6361 6368 6564 5f73  _split)/cached_s
-00001b80: 706c 6974 0a20 2020 2020 2020 2020 2020  plit.           
-00001b90: 2020 2020 2020 2020 2069 6620 6469 6666           if diff
-00001ba0: 5f70 6374 203c 2030 2e30 313a 0a20 2020  _pct < 0.01:.   
-00001bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001bc0: 2020 2020 2023 2074 696e 7920 6469 6666       # tiny diff
-00001bd0: 6572 656e 6365 2c20 6561 7369 6572 2074  erence, easier t
-00001be0: 6f20 6a75 7374 206b 6565 7020 6f6c 6420  o just keep old 
-00001bf0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-00001c00: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-00001c10: 6c69 7473 5f64 6620 3d20 7370 6c69 7473  lits_df = splits
-00001c20: 5f64 662e 6472 6f70 2864 7429 0a20 2020  _df.drop(dt).   
+00000d50: 6c66 2e64 6976 7320 3d20 7966 636d 2e52  lf.divs = yfcm.R
+00000d60: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
+00000d70: 6c66 2e74 6963 6b65 722c 2022 6469 7669  lf.ticker, "divi
+00000d80: 6465 6e64 7322 290a 2020 2020 2020 2020  dends").        
+00000d90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00000da0: 2020 7365 6c66 2e64 6976 7320 3d20 4e6f    self.divs = No
+00000db0: 6e65 0a0a 2020 2020 2020 2020 6966 2079  ne..        if y
+00000dc0: 6663 6d2e 4973 4461 7475 6d43 6163 6865  fcm.IsDatumCache
+00000dd0: 6428 7365 6c66 2e74 6963 6b65 722c 2022  d(self.ticker, "
+00000de0: 7370 6c69 7473 2229 3a0a 2020 2020 2020  splits"):.      
+00000df0: 2020 2020 2020 7365 6c66 2e73 706c 6974        self.split
+00000e00: 7320 3d20 7966 636d 2e52 6561 6443 6163  s = yfcm.ReadCac
+00000e10: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
+00000e20: 6b65 722c 2022 7370 6c69 7473 2229 0a20  ker, "splits"). 
+00000e30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00000e40: 2020 2020 2020 2020 2073 656c 662e 7370           self.sp
+00000e50: 6c69 7473 203d 204e 6f6e 650a 0a20 2020  lits = None..   
+00000e60: 2064 6566 2047 6574 4469 7673 2873 656c   def GetDivs(sel
+00000e70: 662c 2073 7461 7274 2c20 656e 643d 4e6f  f, start, end=No
+00000e80: 6e65 293a 0a20 2020 2020 2020 2079 6663  ne):.        yfc
+00000e90: 752e 5479 7065 4368 6563 6b44 6174 6553  u.TypeCheckDateS
+00000ea0: 7472 6963 7428 7374 6172 742c 2022 7374  trict(start, "st
+00000eb0: 6172 7422 290a 2020 2020 2020 2020 6966  art").        if
+00000ec0: 2065 6e64 2069 7320 6e6f 7420 4e6f 6e65   end is not None
+00000ed0: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
+00000ee0: 6375 2e54 7970 6543 6865 636b 4461 7465  cu.TypeCheckDate
+00000ef0: 5374 7269 6374 2865 6e64 2c20 2265 6e64  Strict(end, "end
+00000f00: 2229 0a0a 2020 2020 2020 2020 6966 2073  ")..        if s
+00000f10: 656c 662e 6469 7673 2069 7320 4e6f 6e65  elf.divs is None
+00000f20: 206f 7220 7365 6c66 2e64 6976 732e 656d   or self.divs.em
+00000f30: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+00000f40: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+00000f50: 2020 2020 2020 747a 203d 2073 656c 662e        tz = self.
+00000f60: 6469 7673 2e69 6e64 6578 5b30 5d2e 747a  divs.index[0].tz
+00000f70: 0a20 2020 2020 2020 2073 7461 7274 203d  .        start =
+00000f80: 2070 642e 5469 6d65 7374 616d 7028 7374   pd.Timestamp(st
+00000f90: 6172 7429 2e74 7a5f 6c6f 6361 6c69 7a65  art).tz_localize
+00000fa0: 2874 7a29 0a20 2020 2020 2020 2069 6620  (tz).        if 
+00000fb0: 656e 6420 6973 206e 6f74 204e 6f6e 653a  end is not None:
+00000fc0: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+00000fd0: 203d 2070 642e 5469 6d65 7374 616d 7028   = pd.Timestamp(
+00000fe0: 656e 6429 2e74 7a5f 6c6f 6361 6c69 7a65  end).tz_localize
+00000ff0: 2874 7a29 0a0a 2020 2020 2020 2020 7464  (tz)..        td
+00001000: 5f31 6420 3d20 7469 6d65 6465 6c74 6128  _1d = timedelta(
+00001010: 6461 7973 3d31 290a 2020 2020 2020 2020  days=1).        
+00001020: 6966 2065 6e64 2069 7320 4e6f 6e65 3a0a  if end is None:.
+00001030: 2020 2020 2020 2020 2020 2020 736c 6320              slc 
+00001040: 3d20 7365 6c66 2e64 6976 732e 6c6f 635b  = self.divs.loc[
+00001050: 7374 6172 743a 5d0a 2020 2020 2020 2020  start:].        
+00001060: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00001070: 2020 736c 6320 3d20 7365 6c66 2e64 6976    slc = self.div
+00001080: 732e 6c6f 635b 7374 6172 743a 656e 642d  s.loc[start:end-
+00001090: 7464 5f31 645d 0a20 2020 2020 2020 2069  td_1d].        i
+000010a0: 6620 736c 632e 656d 7074 793a 0a20 2020  f slc.empty:.   
+000010b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000010c0: 4e6f 6e65 0a20 2020 2020 2020 2065 6c73  None.        els
+000010d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+000010e0: 6574 7572 6e20 736c 632e 636f 7079 2829  eturn slc.copy()
+000010f0: 0a0a 2020 2020 6465 6620 4765 7444 6976  ..    def GetDiv
+00001100: 7346 6574 6368 6564 5369 6e63 6528 7365  sFetchedSince(se
+00001110: 6c66 2c20 6474 293a 0a20 2020 2020 2020  lf, dt):.       
+00001120: 2079 6663 752e 5479 7065 4368 6563 6b44   yfcu.TypeCheckD
+00001130: 6174 6574 696d 6528 6474 2c20 2264 7422  atetime(dt, "dt"
+00001140: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00001150: 6c66 2e64 6976 7320 6973 204e 6f6e 6520  lf.divs is None 
+00001160: 6f72 2073 656c 662e 6469 7673 2e65 6d70  or self.divs.emp
+00001170: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+00001180: 7265 7375 6c74 203d 204e 6f6e 650a 2020  result = None.  
+00001190: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000011a0: 2020 2020 2020 2020 6620 3d20 7365 6c66          f = self
+000011b0: 2e64 6976 735b 2246 6574 6368 4461 7465  .divs["FetchDate
+000011c0: 225d 203e 2064 740a 2020 2020 2020 2020  "] > dt.        
+000011d0: 2020 2020 6966 2066 2e61 6e79 2829 3a0a      if f.any():.
+000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011f0: 7265 7375 6c74 203d 2073 656c 662e 6469  result = self.di
+00001200: 7673 5b66 5d2e 636f 7079 2829 0a20 2020  vs[f].copy().   
+00001210: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00001220: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001230: 6573 756c 7420 3d20 4e6f 6e65 0a0a 2020  esult = None..  
+00001240: 2020 2020 2020 6c6f 675f 6d73 6720 3d20        log_msg = 
+00001250: 2247 6574 4469 7673 4665 7463 6865 6453  "GetDivsFetchedS
+00001260: 696e 6365 2829 2072 6574 7572 6e69 6e67  ince() returning
+00001270: 220a 2020 2020 2020 2020 6966 2072 6573  ".        if res
+00001280: 756c 7420 6973 204e 6f6e 653a 0a20 2020  ult is None:.   
+00001290: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+000012a0: 202b 3d20 2220 4e6f 6e65 220a 2020 2020   += " None".    
+000012b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000012c0: 2020 2020 2020 6c6f 675f 6d73 6720 2b3d        log_msg +=
+000012d0: 2066 2220 7b6c 656e 2872 6573 756c 7429   f" {len(result)
+000012e0: 7d22 0a0a 2020 2020 2020 2020 7265 7475  }"..        retu
+000012f0: 726e 2072 6573 756c 740a 0a20 2020 2064  rn result..    d
+00001300: 6566 2047 6574 5370 6c69 7473 2873 656c  ef GetSplits(sel
+00001310: 662c 2073 7461 7274 2c20 656e 643d 4e6f  f, start, end=No
+00001320: 6e65 293a 0a20 2020 2020 2020 2079 6663  ne):.        yfc
+00001330: 752e 5479 7065 4368 6563 6b44 6174 6553  u.TypeCheckDateS
+00001340: 7472 6963 7428 7374 6172 742c 2022 7374  trict(start, "st
+00001350: 6172 7422 290a 2020 2020 2020 2020 6966  art").        if
+00001360: 2065 6e64 2069 7320 6e6f 7420 4e6f 6e65   end is not None
+00001370: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
+00001380: 6375 2e54 7970 6543 6865 636b 4461 7465  cu.TypeCheckDate
+00001390: 5374 7269 6374 2865 6e64 2c20 2265 6e64  Strict(end, "end
+000013a0: 2229 0a0a 2020 2020 2020 2020 7265 7375  ")..        resu
+000013b0: 6c74 203d 204e 6f6e 650a 2020 2020 2020  lt = None.      
+000013c0: 2020 6966 2073 656c 662e 7370 6c69 7473    if self.splits
+000013d0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000013e0: 206e 6f74 2073 656c 662e 7370 6c69 7473   not self.splits
+000013f0: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+00001400: 2020 2020 7374 6172 7420 3d20 7064 2e54      start = pd.T
+00001410: 696d 6573 7461 6d70 2873 7461 7274 292e  imestamp(start).
+00001420: 747a 5f6c 6f63 616c 697a 6528 7365 6c66  tz_localize(self
+00001430: 2e73 706c 6974 732e 696e 6465 785b 305d  .splits.index[0]
+00001440: 2e74 7a29 0a20 2020 2020 2020 2020 2020  .tz).           
+00001450: 2069 6620 656e 6420 6973 206e 6f74 204e   if end is not N
+00001460: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00001470: 2020 2020 2065 6e64 203d 2070 642e 5469       end = pd.Ti
+00001480: 6d65 7374 616d 7028 656e 6429 2e74 7a5f  mestamp(end).tz_
+00001490: 6c6f 6361 6c69 7a65 2873 656c 662e 7370  localize(self.sp
+000014a0: 6c69 7473 2e69 6e64 6578 5b30 5d2e 747a  lits.index[0].tz
+000014b0: 290a 2020 2020 2020 2020 2020 2020 7464  ).            td
+000014c0: 5f31 6420 3d20 7469 6d65 6465 6c74 6128  _1d = timedelta(
+000014d0: 6461 7973 3d31 290a 2020 2020 2020 2020  days=1).        
+000014e0: 2020 2020 6966 2065 6e64 2069 7320 4e6f      if end is No
+000014f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00001500: 2020 2020 736c 6320 3d20 7365 6c66 2e73      slc = self.s
+00001510: 706c 6974 732e 6c6f 635b 7374 6172 743a  plits.loc[start:
+00001520: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+00001530: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00001540: 2020 2020 736c 6320 3d20 7365 6c66 2e73      slc = self.s
+00001550: 706c 6974 732e 6c6f 635b 7374 6172 743a  plits.loc[start:
+00001560: 656e 642d 7464 5f31 645d 0a0a 2020 2020  end-td_1d]..    
+00001570: 2020 2020 2020 2020 6966 2073 6c63 2e65          if slc.e
+00001580: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
+00001590: 2020 2020 2020 7265 7375 6c74 203d 204e        result = N
+000015a0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000015b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000015c0: 2020 2020 2020 7265 7375 6c74 203d 2073        result = s
+000015d0: 6c63 2e63 6f70 7928 290a 0a20 2020 2020  lc.copy()..     
+000015e0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+000015f0: 0a0a 2020 2020 6465 6620 4765 7453 706c  ..    def GetSpl
+00001600: 6974 7346 6574 6368 6564 5369 6e63 6528  itsFetchedSince(
+00001610: 7365 6c66 2c20 6474 293a 0a20 2020 2020  self, dt):.     
+00001620: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+00001630: 6b44 6174 6574 696d 6528 6474 2c20 2264  kDatetime(dt, "d
+00001640: 7422 290a 0a20 2020 2020 2020 2069 6620  t")..        if 
+00001650: 7365 6c66 2e73 706c 6974 7320 6973 204e  self.splits is N
+00001660: 6f6e 6520 6f72 2073 656c 662e 7370 6c69  one or self.spli
+00001670: 7473 2e65 6d70 7479 3a0a 2020 2020 2020  ts.empty:.      
+00001680: 2020 2020 2020 7265 7375 6c74 203d 204e        result = N
+00001690: 6f6e 650a 2020 2020 2020 2020 656c 7365  one.        else
+000016a0: 3a0a 2020 2020 2020 2020 2020 2020 6620  :.            f 
+000016b0: 3d20 7365 6c66 2e73 706c 6974 735b 2246  = self.splits["F
+000016c0: 6574 6368 4461 7465 225d 203e 2064 740a  etchDate"] > dt.
+000016d0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+000016e0: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+000016f0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00001700: 2073 656c 662e 7370 6c69 7473 5b66 5d2e   self.splits[f].
+00001710: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+00001720: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00001730: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00001740: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+00001750: 7265 7475 726e 2072 6573 756c 740a 0a20  return result.. 
+00001760: 2020 2064 6566 2055 7064 6174 6553 706c     def UpdateSpl
+00001770: 6974 7328 7365 6c66 2c20 7370 6c69 7473  its(self, splits
+00001780: 5f64 6629 3a0a 2020 2020 2020 2020 6e20  _df):.        n 
+00001790: 3d20 7370 6c69 7473 5f64 662e 7368 6170  = splits_df.shap
+000017a0: 655b 305d 0a20 2020 2020 2020 2079 6663  e[0].        yfc
+000017b0: 6c2e 5472 6163 6545 6e74 6572 2866 2250  l.TraceEnter(f"P
+000017c0: 4d3a 2055 7064 6174 6553 706c 6974 7328  M: UpdateSplits(
+000017d0: 7b73 706c 6974 735f 6466 2e69 6e64 6578  {splits_df.index
+000017e0: 2e64 6174 657d 2922 2920 6966 206e 203c  .date})") if n <
+000017f0: 3d20 3220 656c 7365 2079 6663 6c2e 5472  = 2 else yfcl.Tr
+00001800: 6163 6545 6e74 6572 2866 2250 4d3a 2055  aceEnter(f"PM: U
+00001810: 7064 6174 6553 706c 6974 7328 6e3d 7b6e  pdateSplits(n={n
+00001820: 7d29 2229 0a0a 2020 2020 2020 2020 6465  })")..        de
+00001830: 6275 6720 3d20 4661 6c73 650a 2020 2020  bug = False.    
+00001840: 2020 2020 2320 6465 6275 6720 3d20 5472      # debug = Tr
+00001850: 7565 0a0a 2020 2020 2020 2020 7966 6375  ue..        yfcu
+00001860: 2e54 7970 6543 6865 636b 4461 7461 4672  .TypeCheckDataFr
+00001870: 616d 6528 7370 6c69 7473 5f64 662c 2022  ame(splits_df, "
+00001880: 7370 6c69 7473 5f64 6622 290a 2020 2020  splits_df").    
+00001890: 2020 2020 7370 6c69 7473 5f64 6620 3d20      splits_df = 
+000018a0: 7370 6c69 7473 5f64 662e 636f 7079 2829  splits_df.copy()
+000018b0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000018c0: 7370 6c69 7473 5f64 662e 656d 7074 793a  splits_df.empty:
+000018d0: 0a20 2020 2020 2020 2020 2020 2065 7870  .            exp
+000018e0: 6563 7465 645f 636f 6c73 203d 205b 2253  ected_cols = ["S
+000018f0: 746f 636b 2053 706c 6974 7322 2c20 2246  tock Splits", "F
+00001900: 6574 6368 4461 7465 225d 0a20 2020 2020  etchDate"].     
+00001910: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
+00001920: 6578 7065 6374 6564 5f63 6f6c 733a 0a20  expected_cols:. 
+00001930: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001940: 6620 6320 6e6f 7420 696e 2073 706c 6974  f c not in split
+00001950: 735f 6466 2e63 6f6c 756d 6e73 3a0a 2020  s_df.columns:.  
+00001960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001970: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00001980: 6f72 2822 5570 6461 7465 5370 6c69 7473  or("UpdateSplits
+00001990: 2829 2027 7370 6c69 7473 5f64 6627 2063  () 'splits_df' c
+000019a0: 6f6c 756d 6e73 206d 7573 7420 636f 6e74  olumns must cont
+000019b0: 6169 6e3a 2027 7b65 7870 6563 7465 645f  ain: '{expected_
+000019c0: 636f 6c73 7d27 2229 0a0a 2020 2020 2020  cols}'")..      
+000019d0: 2020 2020 2020 2320 5072 6570 6172 6520        # Prepare 
+000019e0: 2773 706c 6974 735f 6466 2720 666f 7220  'splits_df' for 
+000019f0: 6170 7065 6e64 0a20 2020 2020 2020 2020  append.         
+00001a00: 2020 2073 706c 6974 735f 6466 5b22 5375     splits_df["Su
+00001a10: 7065 7273 6564 6564 2073 706c 6974 225d  perseded split"]
+00001a20: 203d 2030 2e30 0a20 2020 2020 2020 2020   = 0.0.         
+00001a30: 2020 2073 706c 6974 735f 6466 5b22 5375     splits_df["Su
+00001a40: 7065 7273 6564 6564 2073 706c 6974 2046  perseded split F
+00001a50: 6574 6368 4461 7465 225d 203d 2070 642e  etchDate"] = pd.
+00001a60: 4e61 540a 2020 2020 2020 2020 2020 2020  NaT.            
+00001a70: 666f 7220 6474 2069 6e20 7370 6c69 7473  for dt in splits
+00001a80: 5f64 662e 696e 6465 783a 0a20 2020 2020  _df.index:.     
+00001a90: 2020 2020 2020 2020 2020 206e 6577 5f73             new_s
+00001aa0: 706c 6974 203d 2073 706c 6974 735f 6466  plit = splits_df
+00001ab0: 2e6c 6f63 5b64 742c 2022 5374 6f63 6b20  .loc[dt, "Stock 
+00001ac0: 5370 6c69 7473 225d 0a20 2020 2020 2020  Splits"].       
+00001ad0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00001ae0: 2e73 706c 6974 7320 6973 206e 6f74 204e  .splits is not N
+00001af0: 6f6e 6520 616e 6420 6474 2069 6e20 7365  one and dt in se
+00001b00: 6c66 2e73 706c 6974 732e 696e 6465 783a  lf.splits.index:
+00001b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001b20: 2020 2020 2063 6163 6865 645f 7370 6c69       cached_spli
+00001b30: 7420 3d20 7365 6c66 2e73 706c 6974 732e  t = self.splits.
+00001b40: 6c6f 635b 6474 2c20 2253 746f 636b 2053  loc[dt, "Stock S
+00001b50: 706c 6974 7322 5d0a 2020 2020 2020 2020  plits"].        
+00001b60: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00001b70: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
+00001b80: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+00001b90: 636c 2e54 7261 6365 5072 696e 7428 6622  cl.TracePrint(f"
+00001ba0: 7072 652d 6578 6973 7469 6e67 2073 746f  pre-existing sto
+00001bb0: 636b 2d73 706c 6974 2040 207b 6474 7d3a  ck-split @ {dt}:
+00001bc0: 207b 6361 6368 6564 5f73 706c 6974 7d20   {cached_split} 
+00001bd0: 7673 207b 6e65 775f 7370 6c69 747d 2229  vs {new_split}")
+00001be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001bf0: 2020 2020 2064 6966 665f 7063 7420 3d20       diff_pct = 
+00001c00: 3130 302a 6162 7328 6361 6368 6564 5f73  100*abs(cached_s
+00001c10: 706c 6974 2d6e 6577 5f73 706c 6974 292f  plit-new_split)/
+00001c20: 6361 6368 6564 5f73 706c 6974 0a20 2020  cached_split.   
 00001c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c40: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
-00001c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c60: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
-00001c70: 5472 6163 6550 7269 6e74 2822 6967 6e6f  TracePrint("igno
-00001c80: 7269 6e67 2229 0a20 2020 2020 2020 2020  ring").         
-00001c90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00001ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001cb0: 2020 2020 2020 2020 2073 706c 6974 735f           splits_
-00001cc0: 6466 2e6c 6f63 5b64 742c 2022 5375 7065  df.loc[dt, "Supe
-00001cd0: 7273 6564 6564 2073 706c 6974 225d 203d  rseded split"] =
-00001ce0: 2073 656c 662e 7370 6c69 7473 2e6c 6f63   self.splits.loc
-00001cf0: 5b64 742c 2022 5374 6f63 6b20 5370 6c69  [dt, "Stock Spli
-00001d00: 7473 225d 0a20 2020 2020 2020 2020 2020  ts"].           
-00001d10: 2020 2020 2020 2020 2020 2020 2073 706c               spl
-00001d20: 6974 735f 6466 2e6c 6f63 5b64 742c 2022  its_df.loc[dt, "
-00001d30: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
-00001d40: 2046 6574 6368 4461 7465 225d 203d 2073   FetchDate"] = s
-00001d50: 656c 662e 7370 6c69 7473 2e6c 6f63 5b64  elf.splits.loc[d
-00001d60: 742c 2022 4665 7463 6844 6174 6522 5d0a  t, "FetchDate"].
-00001d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d80: 2020 2020 2020 2020 7365 6c66 2e73 706c          self.spl
-00001d90: 6974 7320 3d20 7365 6c66 2e73 706c 6974  its = self.split
-00001da0: 732e 6472 6f70 2864 7429 0a20 2020 2020  s.drop(dt).     
+00001c40: 2069 6620 6469 6666 5f70 6374 203c 2030   if diff_pct < 0
+00001c50: 2e30 313a 0a20 2020 2020 2020 2020 2020  .01:.           
+00001c60: 2020 2020 2020 2020 2020 2020 2023 2074               # t
+00001c70: 696e 7920 6469 6666 6572 656e 6365 2c20  iny difference, 
+00001c80: 6561 7369 6572 2074 6f20 6a75 7374 206b  easier to just k
+00001c90: 6565 7020 6f6c 6420 7661 6c75 650a 2020  eep old value.  
+00001ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001cb0: 2020 2020 2020 7370 6c69 7473 5f64 6620        splits_df 
+00001cc0: 3d20 7370 6c69 7473 5f64 662e 6472 6f70  = splits_df.drop
+00001cd0: 2864 7429 0a20 2020 2020 2020 2020 2020  (dt).           
+00001ce0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00001cf0: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
+00001d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d10: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
+00001d20: 6e74 2822 6967 6e6f 7269 6e67 2229 0a20  nt("ignoring"). 
+00001d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00001d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d60: 2073 706c 6974 735f 6466 2e6c 6f63 5b64   splits_df.loc[d
+00001d70: 742c 2022 5375 7065 7273 6564 6564 2073  t, "Superseded s
+00001d80: 706c 6974 225d 203d 2073 656c 662e 7370  plit"] = self.sp
+00001d90: 6c69 7473 2e6c 6f63 5b64 742c 2022 5374  lits.loc[dt, "St
+00001da0: 6f63 6b20 5370 6c69 7473 225d 0a20 2020  ock Splits"].   
 00001db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001dc0: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-00001dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001de0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-00001df0: 6163 6550 7269 6e74 2822 7375 7065 7273  acePrint("supers
-00001e00: 6564 6522 290a 0a20 2020 2020 2020 2020  ede")..         
-00001e10: 2020 2063 6f6c 7320 3d20 5b22 5374 6f63     cols = ["Stoc
-00001e20: 6b20 5370 6c69 7473 222c 2022 4665 7463  k Splits", "Fetc
-00001e30: 6844 6174 6522 2c20 2253 7570 6572 7365  hDate", "Superse
-00001e40: 6465 6420 7370 6c69 7422 2c20 2253 7570  ded split", "Sup
-00001e50: 6572 7365 6465 6420 7370 6c69 7420 4665  erseded split Fe
-00001e60: 7463 6844 6174 6522 5d0a 2020 2020 2020  tchDate"].      
-00001e70: 2020 2020 2020 6966 206e 6f74 2073 706c        if not spl
-00001e80: 6974 735f 6466 2e65 6d70 7479 3a0a 2020  its_df.empty:.  
-00001e90: 2020 2020 2020 2020 2020 2020 2020 7370                sp
-00001ea0: 6c69 7473 5f70 7265 7474 7920 3d20 7370  lits_pretty = sp
-00001eb0: 6c69 7473 5f64 665b 2253 746f 636b 2053  lits_df["Stock S
-00001ec0: 706c 6974 7322 5d0a 2020 2020 2020 2020  plits"].        
-00001ed0: 2020 2020 2020 2020 7370 6c69 7473 5f70          splits_p
-00001ee0: 7265 7474 792e 696e 6465 7820 3d20 7370  retty.index = sp
-00001ef0: 6c69 7473 5f70 7265 7474 792e 696e 6465  lits_pretty.inde
-00001f00: 782e 6461 7465 2e61 7374 7970 6528 7374  x.date.astype(st
-00001f10: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00001f20: 2020 2073 656c 662e 6d61 6e61 6765 722e     self.manager.
-00001f30: 4c6f 6745 7665 6e74 2822 696e 666f 222c  LogEvent("info",
-00001f40: 2022 5370 6c69 744d 616e 6167 6572 222c   "SplitManager",
-00001f50: 2066 227b 7370 6c69 7473 5f70 7265 7474   f"{splits_prett
-00001f60: 792e 7368 6170 655b 305d 7d20 6e65 7720  y.shape[0]} new 
-00001f70: 7370 6c69 7473 3a20 7b73 706c 6974 735f  splits: {splits_
-00001f80: 7072 6574 7479 2e74 6f5f 6469 6374 2829  pretty.to_dict()
-00001f90: 7d22 290a 0a20 2020 2020 2020 2020 2020  }")..           
-00001fa0: 2020 2020 2069 6620 7365 6c66 2e73 706c       if self.spl
-00001fb0: 6974 7320 6973 204e 6f6e 653a 0a20 2020  its is None:.   
-00001fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fd0: 2073 656c 662e 7370 6c69 7473 203d 2073   self.splits = s
-00001fe0: 706c 6974 735f 6466 5b63 6f6c 735d 2e63  plits_df[cols].c
-00001ff0: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-00002000: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00002010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002020: 7365 6c66 2e73 706c 6974 7320 3d20 7064  self.splits = pd
-00002030: 2e63 6f6e 6361 7428 5b73 656c 662e 7370  .concat([self.sp
-00002040: 6c69 7473 2c20 7370 6c69 7473 5f64 665d  lits, splits_df]
-00002050: 2c20 736f 7274 3d54 7275 6529 5b63 6f6c  , sort=True)[col
-00002060: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
-00002070: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
-00002080: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
-00002090: 6b65 722c 2022 7370 6c69 7473 222c 2073  ker, "splits", s
-000020a0: 656c 662e 7370 6c69 7473 290a 0a20 2020  elf.splits)..   
-000020b0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
-000020c0: 7869 7428 2255 7064 6174 6553 706c 6974  xit("UpdateSplit
-000020d0: 7328 2920 7265 7475 726e 696e 6722 290a  s() returning").
-000020e0: 0a20 2020 2064 6566 2055 7064 6174 6544  .    def UpdateD
-000020f0: 6976 6964 656e 6473 2873 656c 662c 2064  ividends(self, d
-00002100: 6976 735f 6466 293a 0a20 2020 2020 2020  ivs_df):.       
-00002110: 2064 6562 7567 203d 2046 616c 7365 0a20   debug = False. 
-00002120: 2020 2020 2020 2023 2064 6562 7567 203d         # debug =
-00002130: 2054 7275 650a 0a20 2020 2020 2020 206e   True..        n
-00002140: 203d 2064 6976 735f 6466 2e73 6861 7065   = divs_df.shape
-00002150: 5b30 5d0a 2020 2020 2020 2020 7966 636c  [0].        yfcl
-00002160: 2e54 7261 6365 456e 7465 7228 6622 504d  .TraceEnter(f"PM
-00002170: 3a20 5570 6461 7465 4469 7669 6465 6e64  : UpdateDividend
-00002180: 7328 7b64 6976 735f 6466 2e69 6e64 6578  s({divs_df.index
-00002190: 2e64 6174 657d 2922 2920 6966 206e 203c  .date})") if n <
-000021a0: 3d20 3220 656c 7365 2079 6663 6c2e 5472  = 2 else yfcl.Tr
-000021b0: 6163 6545 6e74 6572 2866 2250 4d3a 2055  aceEnter(f"PM: U
-000021c0: 7064 6174 6544 6976 6964 656e 6473 286e  pdateDividends(n
-000021d0: 3d7b 6e7d 2922 290a 0a20 2020 2020 2020  ={n})")..       
-000021e0: 2079 6663 752e 5479 7065 4368 6563 6b44   yfcu.TypeCheckD
-000021f0: 6174 6146 7261 6d65 2864 6976 735f 6466  ataFrame(divs_df
-00002200: 2c20 2264 6976 735f 6466 2229 0a20 2020  , "divs_df").   
-00002210: 2020 2020 2064 6976 735f 6466 203d 2064       divs_df = d
-00002220: 6976 735f 6466 2e63 6f70 7928 290a 2020  ivs_df.copy().  
-00002230: 2020 2020 2020 6966 206e 6f74 2064 6976        if not div
-00002240: 735f 6466 2e65 6d70 7479 3a0a 2020 2020  s_df.empty:.    
-00002250: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-00002260: 5f63 6f6c 7320 3d20 5b22 4469 7669 6465  _cols = ["Divide
-00002270: 6e64 7322 2c20 2246 6574 6368 4461 7465  nds", "FetchDate
-00002280: 222c 2022 436c 6f73 6520 6461 7920 6265  ", "Close day be
-00002290: 666f 7265 225d 0a20 2020 2020 2020 2020  fore"].         
-000022a0: 2020 2023 2065 7870 6563 7465 645f 636f     # expected_co
-000022b0: 6c73 203d 205b 2244 6976 6964 656e 6473  ls = ["Dividends
-000022c0: 222c 2022 4665 7463 6844 6174 6522 2c20  ", "FetchDate", 
-000022d0: 2243 6c6f 7365 2074 6f64 6179 225d 0a20  "Close today"]. 
-000022e0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-000022f0: 2069 6e20 6578 7065 6374 6564 5f63 6f6c   in expected_col
-00002300: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00002310: 2020 2069 6620 6320 6e6f 7420 696e 2064     if c not in d
-00002320: 6976 735f 6466 2e63 6f6c 756d 6e73 3a0a  ivs_df.columns:.
-00002330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002340: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00002350: 7272 6f72 2866 2241 6464 4469 7669 6465  rror(f"AddDivide
-00002360: 6e64 7328 2920 2764 6976 735f 6466 2720  nds() 'divs_df' 
-00002370: 6973 206d 6973 7369 6e67 2063 6f6c 756d  is missing colum
-00002380: 6e3a 2027 7b63 7d27 2229 0a0a 2020 2020  n: '{c}'")..    
-00002390: 2020 2020 2020 2020 2320 5072 6570 6172          # Prepar
-000023a0: 6520 2764 6976 735f 6466 2720 666f 7220  e 'divs_df' for 
-000023b0: 6170 7065 6e64 0a20 2020 2020 2020 2020  append.         
-000023c0: 2020 2064 6976 735f 6466 5b22 4261 636b     divs_df["Back
-000023d0: 2041 646a 2e22 5d20 3d20 6e70 2e6e 616e   Adj."] = np.nan
-000023e0: 0a20 2020 2020 2020 2020 2020 2064 6976  .            div
-000023f0: 735f 6466 5b22 5375 7065 7273 6564 6564  s_df["Superseded
-00002400: 2062 6163 6b20 6164 6a2e 225d 203d 2030   back adj."] = 0
-00002410: 2e30 0a20 2020 2020 2020 2020 2020 2064  .0.            d
-00002420: 6976 735f 6466 5b22 5375 7065 7273 6564  ivs_df["Supersed
-00002430: 6564 2064 6976 2046 6574 6368 4461 7465  ed div FetchDate
-00002440: 225d 203d 2070 642e 4e61 540a 2020 2020  "] = pd.NaT.    
-00002450: 2020 2020 2020 2020 666f 7220 6474 2069          for dt i
-00002460: 6e20 6469 7673 5f64 662e 696e 6465 783a  n divs_df.index:
-00002470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002480: 206e 6577 5f64 6976 203d 2064 6976 735f   new_div = divs_
-00002490: 6466 2e6c 6f63 5b64 742c 2022 4469 7669  df.loc[dt, "Divi
-000024a0: 6465 6e64 7322 5d0a 2020 2020 2020 2020  dends"].        
-000024b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000024c0: 6469 7673 2069 7320 6e6f 7420 4e6f 6e65  divs is not None
-000024d0: 2061 6e64 2064 7420 696e 2073 656c 662e   and dt in self.
-000024e0: 6469 7673 2e69 6e64 6578 3a0a 2020 2020  divs.index:.    
-000024f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002500: 6361 6368 6564 5f64 6976 203d 2073 656c  cached_div = sel
-00002510: 662e 6469 7673 2e6c 6f63 5b64 742c 2022  f.divs.loc[dt, "
-00002520: 4469 7669 6465 6e64 7322 5d0a 2020 2020  Dividends"].    
-00002530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002540: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-00002550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002560: 2020 6d73 6720 3d20 6622 7072 652d 6578    msg = f"pre-ex
-00002570: 6973 7469 6e67 2064 6976 6964 656e 6420  isting dividend 
-00002580: 4020 7b64 747d 3a20 7b63 6163 6865 645f  @ {dt}: {cached_
-00002590: 6469 767d 2076 7320 7b6e 6577 5f64 6976  div} vs {new_div
-000025a0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-000025b0: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
-000025c0: 5472 6163 6550 7269 6e74 286d 7367 2920  TracePrint(msg) 
-000025d0: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
-000025e0: 6745 6e61 626c 6564 2829 2065 6c73 6520  gEnabled() else 
-000025f0: 7072 696e 7428 6622 7b73 656c 662e 7469  print(f"{self.ti
-00002600: 636b 6572 7d3a 2022 202b 206d 7367 290a  cker}: " + msg).
-00002610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002620: 2020 2020 6469 6666 5f70 6374 203d 2031      diff_pct = 1
-00002630: 3030 2a61 6273 2863 6163 6865 645f 6469  00*abs(cached_di
-00002640: 762d 6e65 775f 6469 7629 2f63 6163 6865  v-new_div)/cache
-00002650: 645f 6469 760a 2020 2020 2020 2020 2020  d_div.          
-00002660: 2020 2020 2020 2020 2020 6966 2064 6966            if dif
-00002670: 665f 7063 7420 3c20 302e 3031 3a0a 2020  f_pct < 0.01:.  
-00002680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002690: 2020 2020 2020 2320 7469 6e79 2064 6966        # tiny dif
-000026a0: 6665 7265 6e63 652c 2065 6173 6965 7220  ference, easier 
-000026b0: 746f 206a 7573 7420 6b65 6570 206f 6c64  to just keep old
-000026c0: 2076 616c 7565 0a20 2020 2020 2020 2020   value.         
-000026d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000026e0: 6976 735f 6466 203d 2064 6976 735f 6466  ivs_df = divs_df
-000026f0: 2e64 726f 7028 6474 290a 2020 2020 2020  .drop(dt).      
-00002700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002710: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
-00002720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002730: 2020 2020 2020 2020 6d73 6720 3d20 2269          msg = "i
-00002740: 676e 6f72 696e 6720 6e65 7720 6469 7622  gnoring new div"
-00002750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002760: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-00002770: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-00002780: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-00002790: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-000027a0: 6520 7072 696e 7428 6622 7b73 656c 662e  e print(f"{self.
-000027b0: 7469 636b 6572 7d3a 2022 202b 206d 7367  ticker}: " + msg
-000027c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000027d0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-000027e0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-000027f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00002800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002810: 2020 2020 2064 6976 735f 6466 2e6c 6f63       divs_df.loc
-00002820: 5b64 742c 2022 5375 7065 7273 6564 6564  [dt, "Superseded
-00002830: 2062 6163 6b20 6164 6a2e 225d 203d 2073   back adj."] = s
-00002840: 656c 662e 6469 7673 2e6c 6f63 5b64 742c  elf.divs.loc[dt,
-00002850: 2022 4261 636b 2041 646a 2e22 5d0a 2020   "Back Adj."].  
-00002860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002870: 2020 2020 2020 6469 7673 5f64 662e 6c6f        divs_df.lo
-00002880: 635b 6474 2c20 2253 7570 6572 7365 6465  c[dt, "Supersede
-00002890: 6420 6469 7620 4665 7463 6844 6174 6522  d div FetchDate"
-000028a0: 5d20 3d20 7365 6c66 2e64 6976 732e 6c6f  ] = self.divs.lo
-000028b0: 635b 6474 2c20 2246 6574 6368 4461 7465  c[dt, "FetchDate
-000028c0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
-000028d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000028e0: 6469 7673 203d 2073 656c 662e 6469 7673  divs = self.divs
-000028f0: 2e64 726f 7028 6474 290a 2020 2020 2020  .drop(dt).      
-00002900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002910: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
-00002920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002930: 2020 2020 2020 2020 6d73 6720 3d20 2272          msg = "r
-00002940: 6570 6c61 6369 6e67 206f 6c64 2064 6976  eplacing old div
-00002950: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00002960: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00002970: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-00002980: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-00002990: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-000029a0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
-000029b0: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-000029c0: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
-000029d0: 2020 2020 636c 6f73 655f 6265 666f 7265      close_before
-000029e0: 203d 2064 6976 735f 6466 2e6c 6f63 5b64   = divs_df.loc[d
-000029f0: 742c 2022 436c 6f73 6520 6461 7920 6265  t, "Close day be
-00002a00: 666f 7265 225d 0a20 2020 2020 2020 2020  fore"].         
-00002a10: 2020 2020 2020 2023 2061 646a 203d 2028         # adj = (
-00002a20: 636c 6f73 655f 6265 666f 7265 202d 206e  close_before - n
-00002a30: 6577 5f64 6976 2920 2f20 636c 6f73 655f  ew_div) / close_
-00002a40: 6265 666f 7265 0a20 2020 2020 2020 2020  before.         
-00002a50: 2020 2020 2020 2061 646a 203d 2031 2e30         adj = 1.0
-00002a60: 202d 206e 6577 5f64 6976 202f 2063 6c6f   - new_div / clo
-00002a70: 7365 5f62 6566 6f72 650a 2020 2020 2020  se_before.      
-00002a80: 2020 2020 2020 2020 2020 2320 2320 4620            # # F 
-00002a90: 3d20 5032 2f28 5032 2b44 290a 2020 2020  = P2/(P2+D).    
-00002aa0: 2020 2020 2020 2020 2020 2020 2320 2320              # # 
-00002ab0: 6874 7470 3a2f 2f6d 6172 7562 6f7a 752e  http://marubozu.
-00002ac0: 626c 6f67 7370 6f74 2e63 6f6d 2f32 3030  blogspot.com/200
-00002ad0: 362f 3039 2f68 6f77 2d79 6168 6f6f 2d63  6/09/how-yahoo-c
-00002ae0: 616c 6375 6c61 7465 732d 6164 6a75 7374  alculates-adjust
-00002af0: 6564 2d63 6c6f 7369 6e67 2e68 746d 6c23  ed-closing.html#
-00002b00: 6338 3033 3830 3634 3937 3531 3835 3730  c803806497518570
-00002b10: 3838 3536 0a20 2020 2020 2020 2020 2020  8856.           
-00002b20: 2020 2020 2023 2063 6c6f 7365 5f74 6f64       # close_tod
-00002b30: 6179 203d 2064 6976 735f 6466 2e6c 6f63  ay = divs_df.loc
-00002b40: 5b64 742c 2022 436c 6f73 6520 746f 6461  [dt, "Close toda
-00002b50: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
-00002b60: 2020 2020 2320 6164 6a20 3d20 636c 6f73      # adj = clos
-00002b70: 655f 746f 6461 7920 2f20 2863 6c6f 7365  e_today / (close
-00002b80: 5f74 6f64 6179 202b 206e 6577 5f64 6976  _today + new_div
-00002b90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002ba0: 2020 6966 206e 702e 6973 6e61 6e28 6164    if np.isnan(ad
-00002bb0: 6a29 3a20 2023 2074 6f64 6f3a 2072 656d  j):  # todo: rem
-00002bc0: 6f76 6520 6f6e 6365 2063 6f6e 6669 726d  ove once confirm
-00002bd0: 2059 4643 2062 7567 2d66 7265 650a 2020   YFC bug-free.  
-00002be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bf0: 2020 7072 696e 7428 6469 7673 5f64 662e    print(divs_df.
-00002c00: 6c6f 635b 6474 5d29 0a20 2020 2020 2020  loc[dt]).       
-00002c10: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00002c20: 7365 2045 7863 6570 7469 6f6e 2866 2242  se Exception(f"B
-00002c30: 6163 6b20 4164 6a2e 2069 7320 4e61 4e22  ack Adj. is NaN"
-00002c40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00002c50: 2020 6966 2064 6562 7567 3a0a 2020 2020    if debug:.    
-00002c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c70: 6665 7463 685f 6474 203d 2064 6976 735f  fetch_dt = divs_
-00002c80: 6466 2e6c 6f63 5b64 742c 2022 4665 7463  df.loc[dt, "Fetc
-00002c90: 6844 6174 6522 5d0a 2020 2020 2020 2020  hDate"].        
-00002ca0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00002cb0: 3d20 6622 6e65 7720 6469 7669 6465 6e64  = f"new dividend
-00002cc0: 3a20 7b6e 6577 5f64 6976 7d20 4020 7b64  : {new_div} @ {d
-00002cd0: 742e 6461 7465 2829 7d20 6164 6a3d 7b61  t.date()} adj={a
-00002ce0: 646a 3a2e 3566 7d20 636c 6f73 655f 6265  dj:.5f} close_be
-00002cf0: 666f 7265 3d7b 636c 6f73 655f 6265 666f  fore={close_befo
-00002d00: 7265 3a2e 3466 7d20 6665 7463 683d 7b66  re:.4f} fetch={f
-00002d10: 6574 6368 5f64 742e 7374 7266 7469 6d65  etch_dt.strftime
-00002d20: 2827 2559 2d25 6d2d 2564 2025 5827 297d  ('%Y-%m-%d %X')}
-00002d30: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00002d40: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-00002d50: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
-00002d60: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-00002d70: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
-00002d80: 2866 227b 7365 6c66 2e74 6963 6b65 727d  (f"{self.ticker}
-00002d90: 3a20 2220 2b20 6d73 6729 0a20 2020 2020  : " + msg).     
-00002da0: 2020 2020 2020 2020 2020 2064 6976 735f             divs_
-00002db0: 6466 2e6c 6f63 5b64 742c 2022 4261 636b  df.loc[dt, "Back
-00002dc0: 2041 646a 2e22 5d20 3d20 6164 6a0a 0a20   Adj."] = adj.. 
-00002dd0: 2020 2020 2020 2020 2020 2064 6976 735f             divs_
-00002de0: 6466 203d 2064 6976 735f 6466 2e64 726f  df = divs_df.dro
-00002df0: 7028 2243 6c6f 7365 2064 6179 2062 6566  p("Close day bef
-00002e00: 6f72 6522 2c20 6178 6973 3d31 290a 2020  ore", axis=1).  
-00002e10: 2020 2020 2020 2020 2020 2320 6469 7673            # divs
-00002e20: 5f64 6620 3d20 6469 7673 5f64 662e 6472  _df = divs_df.dr
-00002e30: 6f70 2822 436c 6f73 6520 746f 6461 7922  op("Close today"
-00002e40: 2c20 6178 6973 3d31 290a 0a20 2020 2020  , axis=1)..     
-00002e50: 2020 2020 2020 2063 6f6c 7320 3d20 5b22         cols = ["
-00002e60: 4469 7669 6465 6e64 7322 2c20 2242 6163  Dividends", "Bac
-00002e70: 6b20 4164 6a2e 222c 2022 4665 7463 6844  k Adj.", "FetchD
-00002e80: 6174 6522 2c20 2253 7570 6572 7365 6465  ate", "Supersede
-00002e90: 6420 6261 636b 2061 646a 2e22 2c20 2253  d back adj.", "S
-00002ea0: 7570 6572 7365 6465 6420 6469 7620 4665  uperseded div Fe
-00002eb0: 7463 6844 6174 6522 5d0a 2020 2020 2020  tchDate"].      
-00002ec0: 2020 2020 2020 6966 206e 6f74 2064 6976        if not div
-00002ed0: 735f 6466 2e65 6d70 7479 3a0a 2020 2020  s_df.empty:.    
-00002ee0: 2020 2020 2020 2020 2020 2020 6469 7673              divs
-00002ef0: 5f70 7265 7474 7920 3d20 6469 7673 5f64  _pretty = divs_d
-00002f00: 665b 2244 6976 6964 656e 6473 225d 0a20  f["Dividends"]. 
-00002f10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00002f20: 6976 735f 7072 6574 7479 2e69 6e64 6578  ivs_pretty.index
-00002f30: 203d 2064 6976 735f 7072 6574 7479 2e69   = divs_pretty.i
-00002f40: 6e64 6578 2e64 6174 652e 6173 7479 7065  ndex.date.astype
-00002f50: 2873 7472 290a 2020 2020 2020 2020 2020  (str).          
-00002f60: 2020 2020 2020 7365 6c66 2e6d 616e 6167        self.manag
-00002f70: 6572 2e4c 6f67 4576 656e 7428 2269 6e66  er.LogEvent("inf
-00002f80: 6f22 2c20 2244 6976 6964 656e 644d 616e  o", "DividendMan
-00002f90: 6167 6572 222c 2066 227b 6469 7673 5f70  ager", f"{divs_p
-00002fa0: 7265 7474 792e 7368 6170 655b 305d 7d20  retty.shape[0]} 
-00002fb0: 6e65 7720 6469 7669 6465 6e64 733a 207b  new dividends: {
-00002fc0: 6469 7673 5f70 7265 7474 792e 746f 5f64  divs_pretty.to_d
-00002fd0: 6963 7428 297d 2229 0a0a 2020 2020 2020  ict()}")..      
-00002fe0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00002ff0: 662e 6469 7673 2069 7320 4e6f 6e65 3a0a  f.divs is None:.
-00003000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003010: 2020 2020 7365 6c66 2e64 6976 7320 3d20      self.divs = 
-00003020: 6469 7673 5f64 665b 636f 6c73 5d2e 636f  divs_df[cols].co
-00003030: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-00003040: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00003050: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00003060: 656c 662e 6469 7673 203d 2070 642e 636f  elf.divs = pd.co
-00003070: 6e63 6174 285b 7365 6c66 2e64 6976 732c  ncat([self.divs,
-00003080: 2064 6976 735f 6466 5b63 6f6c 735d 5d2c   divs_df[cols]],
-00003090: 2073 6f72 743d 5472 7565 290a 2020 2020   sort=True).    
-000030a0: 2020 2020 2020 2020 2020 2020 7966 636d              yfcm
-000030b0: 2e53 746f 7265 4361 6368 6544 6174 756d  .StoreCacheDatum
-000030c0: 2873 656c 662e 7469 636b 6572 2c20 2264  (self.ticker, "d
-000030d0: 6976 6964 656e 6473 222c 2073 656c 662e  ividends", self.
-000030e0: 6469 7673 290a 0a20 2020 2020 2020 2079  divs)..        y
-000030f0: 6663 6c2e 5472 6163 6545 7869 7428 2255  fcl.TraceExit("U
-00003100: 7064 6174 6544 6976 6964 656e 6473 2829  pdateDividends()
-00003110: 2072 6574 7572 6e69 6e67 2229 0a0a 0a63   returning")...c
-00003120: 6c61 7373 2050 7269 6365 4869 7374 6f72  lass PriceHistor
-00003130: 793a 0a20 2020 2064 6566 205f 5f69 6e69  y:.    def __ini
-00003140: 745f 5f28 7365 6c66 2c20 6d61 6e61 6765  t__(self, manage
-00003150: 722c 2074 6963 6b65 722c 2065 7863 6861  r, ticker, excha
-00003160: 6e67 652c 2074 7a4e 616d 652c 2069 6e74  nge, tzName, int
-00003170: 6572 7661 6c2c 2073 6573 7369 6f6e 2c20  erval, session, 
-00003180: 7072 6f78 792c 2072 6570 6169 723d 5472  proxy, repair=Tr
-00003190: 7565 2c20 636f 6e74 6967 756f 7573 3d46  ue, contiguous=F
-000031a0: 616c 7365 293a 0a20 2020 2020 2020 2069  alse):.        i
-000031b0: 6620 6973 696e 7374 616e 6365 2869 6e74  f isinstance(int
-000031c0: 6572 7661 6c2c 2073 7472 293a 0a20 2020  erval, str):.   
-000031d0: 2020 2020 2020 2020 2069 6620 696e 7465           if inte
-000031e0: 7276 616c 206e 6f74 2069 6e20 7966 6364  rval not in yfcd
-000031f0: 2e69 6e74 6572 7661 6c53 7472 546f 456e  .intervalStrToEn
-00003200: 756d 2e6b 6579 7328 293a 0a20 2020 2020  um.keys():.     
-00003210: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00003220: 2045 7863 6570 7469 6f6e 2822 2769 6e74   Exception("'int
-00003230: 6572 7661 6c27 2069 6620 7374 7220 6d75  erval' if str mu
-00003240: 7374 2062 6520 6f6e 6520 6f66 3a20 7b7d  st be one of: {}
-00003250: 222e 666f 726d 6174 2879 6663 642e 696e  ".format(yfcd.in
-00003260: 7465 7276 616c 5374 7254 6f45 6e75 6d2e  tervalStrToEnum.
-00003270: 6b65 7973 2829 2929 0a20 2020 2020 2020  keys())).       
-00003280: 2020 2020 2069 6e74 6572 7661 6c20 3d20       interval = 
-00003290: 7966 6364 2e69 6e74 6572 7661 6c53 7472  yfcd.intervalStr
-000032a0: 546f 456e 756d 5b69 6e74 6572 7661 6c5d  ToEnum[interval]
-000032b0: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
-000032c0: 7065 4368 6563 6b53 7472 2874 6963 6b65  peCheckStr(ticke
-000032d0: 722c 2022 7469 636b 6572 2229 0a20 2020  r, "ticker").   
-000032e0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-000032f0: 6563 6b53 7472 2865 7863 6861 6e67 652c  eckStr(exchange,
-00003300: 2022 6578 6368 616e 6765 2229 0a20 2020   "exchange").   
-00003310: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-00003320: 6563 6b53 7472 2874 7a4e 616d 652c 2022  eckStr(tzName, "
-00003330: 747a 4e61 6d65 2229 0a20 2020 2020 2020  tzName").       
-00003340: 2079 6663 752e 5479 7065 4368 6563 6b42   yfcu.TypeCheckB
-00003350: 6f6f 6c28 7265 7061 6972 2c20 2272 6570  ool(repair, "rep
-00003360: 6169 7222 290a 2020 2020 2020 2020 7966  air").        yf
-00003370: 6375 2e54 7970 6543 6865 636b 426f 6f6c  cu.TypeCheckBool
-00003380: 2863 6f6e 7469 6775 6f75 732c 2022 636f  (contiguous, "co
-00003390: 6e74 6967 756f 7573 2229 0a0a 2020 2020  ntiguous")..    
-000033a0: 2020 2020 7365 6c66 2e6d 616e 6167 6572      self.manager
-000033b0: 203d 206d 616e 6167 6572 0a20 2020 2020   = manager.     
-000033c0: 2020 2073 656c 662e 7469 636b 6572 203d     self.ticker =
-000033d0: 2074 6963 6b65 720a 2020 2020 2020 2020   ticker.        
-000033e0: 7365 6c66 2e65 7863 6861 6e67 6520 3d20  self.exchange = 
-000033f0: 6578 6368 616e 6765 0a20 2020 2020 2020  exchange.       
-00003400: 2073 656c 662e 747a 4e61 6d65 203d 2074   self.tzName = t
-00003410: 7a4e 616d 650a 2020 2020 2020 2020 7365  zName.        se
-00003420: 6c66 2e69 6e74 6572 7661 6c20 3d20 696e  lf.interval = in
-00003430: 7465 7276 616c 0a20 2020 2020 2020 2073  terval.        s
-00003440: 656c 662e 7365 7373 696f 6e20 3d20 7365  elf.session = se
-00003450: 7373 696f 6e0a 2020 2020 2020 2020 7365  ssion.        se
-00003460: 6c66 2e70 726f 7879 203d 2070 726f 7879  lf.proxy = proxy
-00003470: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-00003480: 7061 6972 203d 2072 6570 6169 720a 2020  pair = repair.  
-00003490: 2020 2020 2020 7365 6c66 2e63 6f6e 7469        self.conti
-000034a0: 6775 6f75 7320 3d20 636f 6e74 6967 756f  guous = contiguo
-000034b0: 7573 0a0a 2020 2020 2020 2020 7365 6c66  us..        self
-000034c0: 2e64 6174 203d 2079 662e 5469 636b 6572  .dat = yf.Ticker
-000034d0: 2873 656c 662e 7469 636b 6572 2c20 7365  (self.ticker, se
-000034e0: 7373 696f 6e3d 7365 6c66 2e73 6573 7369  ssion=self.sessi
-000034f0: 6f6e 290a 2020 2020 2020 2020 7365 6c66  on).        self
-00003500: 2e74 7a20 3d20 5a6f 6e65 496e 666f 2873  .tz = ZoneInfo(s
-00003510: 656c 662e 747a 4e61 6d65 290a 0a20 2020  elf.tzName)..   
-00003520: 2020 2020 2073 656c 662e 6974 6420 3d20       self.itd = 
-00003530: 7966 6364 2e69 6e74 6572 7661 6c54 6f54  yfcd.intervalToT
-00003540: 696d 6564 656c 7461 5b73 656c 662e 696e  imedelta[self.in
-00003550: 7465 7276 616c 5d0a 2020 2020 2020 2020  terval].        
-00003560: 7365 6c66 2e69 7374 7220 3d20 7966 6364  self.istr = yfcd
-00003570: 2e69 6e74 6572 7661 6c54 6f53 7472 696e  .intervalToStrin
-00003580: 675b 7365 6c66 2e69 6e74 6572 7661 6c5d  g[self.interval]
-00003590: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
-000035a0: 7465 7264 6179 203d 2073 656c 662e 696e  terday = self.in
-000035b0: 7465 7276 616c 2069 6e20 5b79 6663 642e  terval in [yfcd.
-000035c0: 496e 7465 7276 616c 2e44 6179 7331 2c20  Interval.Days1, 
-000035d0: 7966 6364 2e49 6e74 6572 7661 6c2e 5765  yfcd.Interval.We
-000035e0: 656b 2c20 7966 6364 2e49 6e74 6572 7661  ek, yfcd.Interva
-000035f0: 6c2e 4d6f 6e74 6873 312c 2079 6663 642e  l.Months1, yfcd.
-00003600: 496e 7465 7276 616c 2e4d 6f6e 7468 7333  Interval.Months3
-00003610: 5d0a 2020 2020 2020 2020 7365 6c66 2e69  ].        self.i
-00003620: 6e74 7261 6461 7920 3d20 6e6f 7420 7365  ntraday = not se
-00003630: 6c66 2e69 6e74 6572 6461 790a 0a20 2020  lf.interday..   
-00003640: 2020 2020 2023 204c 6f61 6420 6672 6f6d       # Load from
-00003650: 2063 6163 6865 0a20 2020 2020 2020 2073   cache.        s
-00003660: 656c 662e 6361 6368 655f 6b65 7920 3d20  elf.cache_key = 
-00003670: 2268 6973 746f 7279 2d22 2b73 656c 662e  "history-"+self.
-00003680: 6973 7472 0a20 2020 2020 2020 2073 656c  istr.        sel
-00003690: 662e 6820 3d20 7365 6c66 2e5f 6765 7443  f.h = self._getC
-000036a0: 6163 6865 6450 7269 6365 7328 290a 2020  achedPrices().  
-000036b0: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
-000036c0: 794e 6577 4576 656e 7473 2829 0a0a 2020  yNewEvents()..  
-000036d0: 2020 2020 2020 2320 4120 706c 6163 6520        # A place 
-000036e0: 746f 2074 656d 706f 7261 7269 6c79 2073  to temporarily s
-000036f0: 746f 7265 206e 6577 2064 6976 6964 656e  tore new dividen
-00003700: 6473 2c20 756e 7469 6c20 7072 6963 6573  ds, until prices
-00003710: 2068 6176 650a 2020 2020 2020 2020 2320   have.        # 
-00003720: 6265 656e 2072 6570 6169 7265 642c 2074  been repaired, t
-00003730: 6865 6e20 7468 6579 2063 616e 2062 6520  hen they can be 
-00003740: 7365 6e74 2074 6f20 4576 656e 7473 4869  sent to EventsHi
-00003750: 7374 6f72 790a 0a20 2020 2020 2020 2073  story..        s
-00003760: 656c 662e 5f64 6562 7567 203d 2046 616c  elf._debug = Fal
-00003770: 7365 0a20 2020 2020 2020 2023 2073 656c  se.        # sel
-00003780: 662e 5f64 6562 7567 203d 2054 7275 650a  f._debug = True.
-00003790: 0a20 2020 2020 2020 2023 204d 616e 6167  .        # Manag
-000037a0: 6520 706f 7465 6e74 6961 6c20 666f 7220  e potential for 
-000037b0: 696e 6669 6e69 7465 2072 6563 7572 7369  infinite recursi
-000037c0: 6f6e 2064 7572 696e 6720 7072 6963 6520  on during price 
-000037d0: 7265 7061 6972 3a0a 2020 2020 2020 2020  repair:.        
-000037e0: 7365 6c66 2e5f 7265 636f 7264 5f73 7461  self._record_sta
-000037f0: 636b 5f74 7261 6365 203d 2054 7275 650a  ck_trace = True.
-00003800: 2020 2020 2020 2020 2320 7365 6c66 2e5f          # self._
-00003810: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
-00003820: 6365 203d 2046 616c 7365 0a20 2020 2020  ce = False.     
-00003830: 2020 2073 656c 662e 5f73 7461 636b 5f74     self._stack_t
-00003840: 7261 6365 203d 205b 5d0a 2020 2020 2020  race = [].      
-00003850: 2020 7365 6c66 2e5f 696e 6669 6e69 7465    self._infinite
-00003860: 5f72 6563 7572 7369 6f6e 5f64 6574 6563  _recursion_detec
-00003870: 7465 6420 3d20 4661 6c73 650a 0a20 2020  ted = False..   
-00003880: 2064 6566 205f 6765 7443 6163 6865 6450   def _getCachedP
-00003890: 7269 6365 7328 7365 6c66 293a 0a20 2020  rices(self):.   
-000038a0: 2020 2020 2068 203d 204e 6f6e 650a 2020       h = None.  
-000038b0: 2020 2020 2020 6966 2079 6663 6d2e 4973        if yfcm.Is
-000038c0: 4461 7475 6d43 6163 6865 6428 7365 6c66  DatumCached(self
-000038d0: 2e74 6963 6b65 722c 2073 656c 662e 6361  .ticker, self.ca
-000038e0: 6368 655f 6b65 7929 3a0a 2020 2020 2020  che_key):.      
-000038f0: 2020 2020 2020 6820 3d20 7966 636d 2e52        h = yfcm.R
-00003900: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
-00003910: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
-00003920: 6361 6368 655f 6b65 7929 0a0a 2020 2020  cache_key)..    
-00003930: 2020 2020 6966 2068 2069 7320 6e6f 7420      if h is not 
-00003940: 4e6f 6e65 2061 6e64 2068 2e65 6d70 7479  None and h.empty
-00003950: 3a0a 2020 2020 2020 2020 2020 2020 6820  :.            h 
-00003960: 3d20 4e6f 6e65 0a20 2020 2020 2020 2065  = None.        e
-00003970: 6c69 6620 6820 6973 206e 6f74 204e 6f6e  lif h is not Non
-00003980: 653a 0a20 2020 2020 2020 2020 2020 2068  e:.            h
-00003990: 5f6d 6f64 6966 6965 6420 3d20 4661 6c73  _modified = Fals
-000039a0: 650a 0a20 2020 2020 2020 2020 2020 2069  e..            i
-000039b0: 6620 2241 646a 2043 6c6f 7365 2220 696e  f "Adj Close" in
-000039c0: 2068 2e63 6f6c 756d 6e73 3a0a 2020 2020   h.columns:.    
-000039d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000039e0: 6520 4578 6365 7074 696f 6e28 2241 646a  e Exception("Adj
-000039f0: 2043 6c6f 7365 2069 6e20 6361 6368 6564   Close in cached
-00003a00: 2068 2229 0a0a 2020 2020 2020 2020 2020   h")..          
-00003a10: 2020 665f 6475 7073 203d 2068 2e69 6e64    f_dups = h.ind
-00003a20: 6578 2e64 7570 6c69 6361 7465 6428 290a  ex.duplicated().
-00003a30: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00003a40: 5f64 7570 732e 616e 7928 293a 0a20 2020  _dups.any():.   
-00003a50: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00003a60: 7365 2045 7863 6570 7469 6f6e 2822 7b7d  se Exception("{}
-00003a70: 3a20 5468 6573 6520 7469 6d65 706f 696e  : These timepoin
-00003a80: 7473 2068 6176 6520 6265 656e 2064 7570  ts have been dup
-00003a90: 6c69 6361 7465 643a 207b 7d22 2e66 6f72  licated: {}".for
-00003aa0: 6d61 7428 7365 6c66 2e74 6963 6b65 722c  mat(self.ticker,
-00003ab0: 2068 2e69 6e64 6578 5b66 5f64 7570 735d   h.index[f_dups]
-00003ac0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00003ad0: 665f 6e61 203d 206e 702e 6973 6e61 6e28  f_na = np.isnan(
-00003ae0: 685b 2243 4446 225d 2e74 6f5f 6e75 6d70  h["CDF"].to_nump
-00003af0: 7928 2929 0a20 2020 2020 2020 2020 2020  y()).           
-00003b00: 2069 6620 665f 6e61 2e61 6e79 2829 3a0a   if f_na.any():.
-00003b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b20: 685b 2243 4446 225d 203d 2068 5b22 4344  h["CDF"] = h["CD
-00003b30: 4622 5d2e 6669 6c6c 6e61 286d 6574 686f  F"].fillna(metho
-00003b40: 643d 2262 6669 6c6c 2229 2e66 696c 6c6e  d="bfill").filln
-00003b50: 6128 6d65 7468 6f64 3d22 6666 696c 6c22  a(method="ffill"
-00003b60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00003b70: 2020 665f 6e61 203d 2068 5b22 4344 4622    f_na = h["CDF"
-00003b80: 5d2e 6973 6e61 2829 0a20 2020 2020 2020  ].isna().       
-00003b90: 2020 2020 2020 2020 2069 6620 665f 6e61           if f_na
-00003ba0: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-00003bb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00003bc0: 6520 4578 6365 7074 696f 6e28 2243 4446  e Exception("CDF
-00003bd0: 204e 614e 2072 6570 6169 7220 6661 696c   NaN repair fail
-00003be0: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-00003bf0: 2020 2020 2068 5f6d 6f64 6966 6965 6420       h_modified 
-00003c00: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-00003c10: 2020 2020 6966 2068 5f6d 6f64 6966 6965      if h_modifie
-00003c20: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-00003c30: 2020 2079 6663 6d2e 5374 6f72 6543 6163     yfcm.StoreCac
-00003c40: 6865 4461 7475 6d28 7365 6c66 2e74 6963  heDatum(self.tic
-00003c50: 6b65 722c 2073 656c 662e 6361 6368 655f  ker, self.cache_
-00003c60: 6b65 792c 2068 290a 0a20 2020 2020 2020  key, h)..       
-00003c70: 2072 6574 7572 6e20 680a 0a20 2020 2064   return h..    d
-00003c80: 6566 205f 7570 6461 7465 6443 6163 6865  ef _updatedCache
-00003c90: 6450 7269 6365 7328 7365 6c66 2c20 6466  dPrices(self, df
-00003ca0: 293a 0a20 2020 2020 2020 2079 6663 752e  ):.        yfcu.
-00003cb0: 5479 7065 4368 6563 6b44 6174 6146 7261  TypeCheckDataFra
-00003cc0: 6d65 2864 662c 2022 6466 2229 0a0a 2020  me(df, "df")..  
-00003cd0: 2020 2020 2020 6578 7065 6374 6564 5f63        expected_c
-00003ce0: 6f6c 7320 3d20 5b22 4f70 656e 222c 2022  ols = ["Open", "
-00003cf0: 4869 6768 222c 2022 4c6f 7722 2c20 2243  High", "Low", "C
-00003d00: 6c6f 7365 222c 2022 566f 6c75 6d65 222c  lose", "Volume",
-00003d10: 2022 4469 7669 6465 6e64 7322 2c20 2253   "Dividends", "S
-00003d20: 746f 636b 2053 706c 6974 7322 5d0a 2020  tock Splits"].  
-00003d30: 2020 2020 2020 6578 7065 6374 6564 5f63        expected_c
-00003d40: 6f6c 7320 2b3d 205b 2246 696e 616c 3f22  ols += ["Final?"
-00003d50: 2c20 2243 2d43 6865 636b 3f22 2c20 2246  , "C-Check?", "F
-00003d60: 6574 6368 4461 7465 222c 2022 4353 4622  etchDate", "CSF"
-00003d70: 2c20 2243 4446 225d 0a20 2020 2020 2020  , "CDF"].       
-00003d80: 2065 7870 6563 7465 645f 636f 6c73 202b   expected_cols +
-00003d90: 3d20 5b22 4c61 7374 4469 7641 646a 7573  = ["LastDivAdjus
-00003da0: 7444 7422 2c20 224c 6173 7453 706c 6974  tDt", "LastSplit
-00003db0: 4164 6a75 7374 4474 225d 0a0a 2020 2020  AdjustDt"]..    
-00003dc0: 2020 2020 6d69 7373 696e 675f 636f 6c73      missing_cols
-00003dd0: 203d 205b 6320 666f 7220 6320 696e 2065   = [c for c in e
-00003de0: 7870 6563 7465 645f 636f 6c73 2069 6620  xpected_cols if 
-00003df0: 6320 6e6f 7420 696e 2064 662e 636f 6c75  c not in df.colu
-00003e00: 6d6e 735d 0a20 2020 2020 2020 2069 6620  mns].        if 
-00003e10: 6c65 6e28 6d69 7373 696e 675f 636f 6c73  len(missing_cols
-00003e20: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00003e30: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00003e40: 6f6e 2866 2244 4620 6d69 7373 696e 6720  on(f"DF missing 
-00003e50: 7468 6573 6520 636f 6c75 6d6e 733a 207b  these columns: {
-00003e60: 6d69 7373 696e 675f 636f 6c73 7d22 290a  missing_cols}").
-00003e70: 0a20 2020 2020 2020 2079 6663 6d2e 5374  .        yfcm.St
-00003e80: 6f72 6543 6163 6865 4461 7475 6d28 7365  oreCacheDatum(se
-00003e90: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
-00003ea0: 6361 6368 655f 6b65 792c 2064 6629 0a0a  cache_key, df)..
-00003eb0: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
-00003ec0: 2064 660a 0a20 2020 2064 6566 2067 6574   df..    def get
-00003ed0: 2873 656c 662c 2073 7461 7274 3d4e 6f6e  (self, start=Non
-00003ee0: 652c 2065 6e64 3d4e 6f6e 652c 2070 6572  e, end=None, per
-00003ef0: 696f 643d 4e6f 6e65 2c20 6d61 785f 6167  iod=None, max_ag
-00003f00: 653d 4e6f 6e65 2c20 7472 6967 6765 725f  e=None, trigger_
-00003f10: 6174 5f6d 6172 6b65 745f 636c 6f73 653d  at_market_close=
-00003f20: 4661 6c73 652c 2072 6570 6169 723d 5472  False, repair=Tr
-00003f30: 7565 2c20 7072 6570 6f73 743d 4661 6c73  ue, prepost=Fals
-00003f40: 652c 2061 646a 7573 745f 7370 6c69 7473  e, adjust_splits
-00003f50: 3d46 616c 7365 2c20 6164 6a75 7374 5f64  =False, adjust_d
-00003f60: 6976 733d 4661 6c73 652c 2071 7569 6574  ivs=False, quiet
-00003f70: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00003f80: 2069 6620 7374 6172 7420 6973 204e 6f6e   if start is Non
-00003f90: 6520 616e 6420 656e 6420 6973 204e 6f6e  e and end is Non
-00003fa0: 6520 616e 6420 7065 7269 6f64 2069 7320  e and period is 
-00003fb0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00003fc0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00003fd0: 6f72 2822 4d75 7374 2070 726f 7669 6465  or("Must provide
-00003fe0: 2076 616c 7565 2066 6f72 206f 6e65 206f   value for one o
-00003ff0: 663a 2027 7374 6172 7427 2c20 2765 6e64  f: 'start', 'end
-00004000: 272c 2027 7065 7269 6f64 2722 290a 2020  ', 'period'").  
-00004010: 2020 2020 2020 6966 2073 7461 7274 2069        if start i
-00004020: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00004030: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-00004040: 6543 6865 636b 496e 7465 7276 616c 4474  eCheckIntervalDt
-00004050: 2873 7461 7274 2c20 7365 6c66 2e69 6e74  (start, self.int
-00004060: 6572 7661 6c2c 2022 7374 6172 7422 2c20  erval, "start", 
-00004070: 7374 7269 6374 3d46 616c 7365 290a 2020  strict=False).  
-00004080: 2020 2020 2020 6966 2065 6e64 2069 7320        if end is 
-00004090: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-000040a0: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-000040b0: 6865 636b 496e 7465 7276 616c 4474 2865  heckIntervalDt(e
-000040c0: 6e64 2c20 7365 6c66 2e69 6e74 6572 7661  nd, self.interva
-000040d0: 6c2c 2022 656e 6422 2c20 7374 7269 6374  l, "end", strict
-000040e0: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
-000040f0: 6966 2070 6572 696f 6420 6973 206e 6f74  if period is not
-00004100: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00004110: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
-00004120: 6b50 6572 696f 6428 7065 7269 6f64 2c20  kPeriod(period, 
-00004130: 2270 6572 696f 6422 290a 2020 2020 2020  "period").      
-00004140: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-00004150: 426f 6f6c 2874 7269 6767 6572 5f61 745f  Bool(trigger_at_
-00004160: 6d61 726b 6574 5f63 6c6f 7365 2c20 2274  market_close, "t
-00004170: 7269 6767 6572 5f61 745f 6d61 726b 6574  rigger_at_market
-00004180: 5f63 6c6f 7365 2229 0a20 2020 2020 2020  _close").       
-00004190: 2079 6663 752e 5479 7065 4368 6563 6b42   yfcu.TypeCheckB
-000041a0: 6f6f 6c28 7265 7061 6972 2c20 2272 6570  ool(repair, "rep
-000041b0: 6169 7222 290a 2020 2020 2020 2020 7966  air").        yf
-000041c0: 6375 2e54 7970 6543 6865 636b 426f 6f6c  cu.TypeCheckBool
-000041d0: 2861 646a 7573 745f 7370 6c69 7473 2c20  (adjust_splits, 
-000041e0: 2261 646a 7573 745f 7370 6c69 7473 2229  "adjust_splits")
-000041f0: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
-00004200: 7065 4368 6563 6b42 6f6f 6c28 6164 6a75  peCheckBool(adju
-00004210: 7374 5f64 6976 732c 2022 6164 6a75 7374  st_divs, "adjust
-00004220: 5f64 6976 7322 290a 0a20 2020 2020 2020  _divs")..       
-00004230: 2023 2054 4f44 4f3a 2065 6e66 6f72 6365   # TODO: enforce
-00004240: 2027 6d61 785f 6167 6527 2076 616c 7565   'max_age' value
-00004250: 2070 726f 7669 6465 642e 204f 6e6c 7920   provided. Only 
-00004260: 274e 6f6e 6527 2077 6869 6c65 2049 2064  'None' while I d
-00004270: 6576 0a20 2020 2020 2020 2069 6620 6d61  ev.        if ma
-00004280: 785f 6167 6520 6973 204e 6f6e 653a 0a20  x_age is None:. 
-00004290: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000042a0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-000042b0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-000042c0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-000042d0: 2020 2020 6d61 785f 6167 6520 3d20 7469      max_age = ti
-000042e0: 6d65 6465 6c74 6128 686f 7572 733d 3429  medelta(hours=4)
-000042f0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00004300: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
-00004310: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
-00004320: 2e57 6565 6b3a 0a20 2020 2020 2020 2020  .Week:.         
-00004330: 2020 2020 2020 206d 6178 5f61 6765 203d         max_age =
-00004340: 2074 696d 6564 656c 7461 2868 6f75 7273   timedelta(hours
-00004350: 3d36 3029 0a20 2020 2020 2020 2020 2020  =60).           
-00004360: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
-00004370: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-00004380: 7276 616c 2e4d 6f6e 7468 7331 3a0a 2020  rval.Months1:.  
-00004390: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000043a0: 785f 6167 6520 3d20 7469 6d65 6465 6c74  x_age = timedelt
-000043b0: 6128 6461 7973 3d31 3529 0a20 2020 2020  a(days=15).     
-000043c0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-000043d0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-000043e0: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
-000043f0: 7333 3a0a 2020 2020 2020 2020 2020 2020  s3:.            
-00004400: 2020 2020 6d61 785f 6167 6520 3d20 7469      max_age = ti
-00004410: 6d65 6465 6c74 6128 6461 7973 3d34 3529  medelta(days=45)
-00004420: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00004430: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00004440: 2020 206d 6178 5f61 6765 203d 2030 2e35     max_age = 0.5
-00004450: 2a79 6663 642e 696e 7465 7276 616c 546f  *yfcd.intervalTo
-00004460: 5469 6d65 6465 6c74 615b 7365 6c66 2e69  Timedelta[self.i
-00004470: 6e74 6572 7661 6c5d 0a0a 2020 2020 2020  nterval]..      
-00004480: 2020 2320 5946 4320 6361 6e6e 6f74 2068    # YFC cannot h
-00004490: 616e 646c 6520 7072 652d 2061 6e64 2070  andle pre- and p
-000044a0: 6f73 742d 6d61 726b 6574 2069 6e74 7261  ost-market intra
-000044b0: 6461 790a 2020 2020 2020 2020 7072 6570  day.        prep
-000044c0: 6f73 7420 3d20 7365 6c66 2e69 6e74 6572  ost = self.inter
-000044d0: 6461 790a 0a20 2020 2020 2020 2079 6663  day..        yfc
-000044e0: 742e 5365 7445 7863 6861 6e67 6554 7a4e  t.SetExchangeTzN
-000044f0: 616d 6528 7365 6c66 2e65 7863 6861 6e67  ame(self.exchang
-00004500: 652c 2073 656c 662e 747a 4e61 6d65 290a  e, self.tzName).
-00004510: 2020 2020 2020 2020 7464 5f31 6420 3d20          td_1d = 
-00004520: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
-00004530: 290a 2020 2020 2020 2020 747a 5f65 7863  ).        tz_exc
-00004540: 6861 6e67 6520 3d20 5a6f 6e65 496e 666f  hange = ZoneInfo
-00004550: 2873 656c 662e 747a 4e61 6d65 290a 2020  (self.tzName).  
-00004560: 2020 2020 2020 6474 5f6e 6f77 203d 2070        dt_now = p
-00004570: 642e 5469 6d65 7374 616d 702e 7574 636e  d.Timestamp.utcn
-00004580: 6f77 2829 2e74 7a5f 636f 6e76 6572 7428  ow().tz_convert(
-00004590: 747a 5f65 7863 6861 6e67 6529 0a20 2020  tz_exchange).   
-000045a0: 2020 2020 2064 5f6e 6f77 5f65 7863 6861       d_now_excha
-000045b0: 6e67 6520 3d20 6474 5f6e 6f77 2e64 6174  nge = dt_now.dat
-000045c0: 6528 290a 2020 2020 2020 2020 746f 6d6f  e().        tomo
-000045d0: 7272 6f77 5f64 203d 2064 5f6e 6f77 5f65  rrow_d = d_now_e
-000045e0: 7863 6861 6e67 6520 2b20 7464 5f31 640a  xchange + td_1d.
-000045f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00004600: 696e 7465 7264 6179 3a0a 2020 2020 2020  interday:.      
-00004610: 2020 2020 2020 746f 6d6f 7272 6f77 203d        tomorrow =
-00004620: 2074 6f6d 6f72 726f 775f 640a 2020 2020   tomorrow_d.    
-00004630: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00004640: 2020 2020 2020 746f 6d6f 7272 6f77 203d        tomorrow =
-00004650: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
-00004660: 6528 746f 6d6f 7272 6f77 5f64 2c20 7469  e(tomorrow_d, ti
-00004670: 6d65 2830 292c 2074 7a5f 6578 6368 616e  me(0), tz_exchan
-00004680: 6765 290a 2020 2020 2020 2020 6966 2073  ge).        if s
-00004690: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
-000046a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000046b0: 2065 6e64 2069 7320 6e6f 7420 4e6f 6e65   end is not None
-000046c0: 2061 6e64 2073 7461 7274 203e 3d20 656e   and start >= en
-000046d0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-000046e0: 2020 2023 2072 6169 7365 2056 616c 7565     # raise Value
-000046f0: 4572 726f 7228 6622 7374 6172 743d 7b73  Error(f"start={s
-00004700: 7461 7274 7d20 6d75 7374 203c 2065 6e64  tart} must < end
-00004710: 3d7b 656e 647d 2229 0a20 2020 2020 2020  ={end}").       
-00004720: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00004730: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00004740: 2023 2069 6620 2873 656c 662e 696e 7465   # if (self.inte
-00004750: 7264 6179 2061 6e64 2073 7461 7274 203e  rday and start >
-00004760: 3d20 746f 6d6f 7272 6f77 2920 6f72 2028  = tomorrow) or (
-00004770: 6e6f 7420 7365 6c66 2e69 6e74 6572 6461  not self.interda
-00004780: 7920 616e 6420 7374 6172 7420 3e20 6474  y and start > dt
-00004790: 5f6e 6f77 293a 0a20 2020 2020 2020 2020  _now):.         
-000047a0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000047b0: 2873 7461 7274 2c20 6461 7465 7469 6d65  (start, datetime
-000047c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000047d0: 2020 2069 6620 7374 6172 7420 3e20 6474     if start > dt
-000047e0: 5f6e 6f77 3a0a 2020 2020 2020 2020 2020  _now:.          
-000047f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00004800: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00004810: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00004820: 2020 2020 2020 2020 6966 2073 7461 7274          if start
-00004830: 203e 3d20 746f 6d6f 7272 6f77 5f64 3a0a   >= tomorrow_d:.
-00004840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004850: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00004860: 0a20 2020 2020 2020 2064 6562 7567 5f79  .        debug_y
-00004870: 6620 3d20 4661 6c73 650a 2020 2020 2020  f = False.      
-00004880: 2020 6465 6275 675f 7966 6320 3d20 7365    debug_yfc = se
-00004890: 6c66 2e5f 6465 6275 670a 2020 2020 2020  lf._debug.      
-000048a0: 2020 2320 6465 6275 675f 7966 6320 3d20    # debug_yfc = 
-000048b0: 5472 7565 0a0a 2020 2020 2020 2020 6966  True..        if
-000048c0: 2070 6572 696f 6420 6973 206e 6f74 204e   period is not N
-000048d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000048e0: 206c 6f67 5f6d 7367 203d 2066 2250 7269   log_msg = f"Pri
-000048f0: 6365 4869 7374 6f72 792d 7b73 656c 662e  ceHistory-{self.
-00004900: 6973 7472 7d2e 6765 7428 746b 723d 7b73  istr}.get(tkr={s
-00004910: 656c 662e 7469 636b 6572 7d2c 2070 6572  elf.ticker}, per
-00004920: 696f 643d 7b70 6572 696f 647d 2c20 6d61  iod={period}, ma
-00004930: 785f 6167 653d 7b6d 6178 5f61 6765 7d2c  x_age={max_age},
-00004940: 2074 7269 6767 6572 5f61 745f 6d61 726b   trigger_at_mark
-00004950: 6574 5f63 6c6f 7365 3d7b 7472 6967 6765  et_close={trigge
-00004960: 725f 6174 5f6d 6172 6b65 745f 636c 6f73  r_at_market_clos
-00004970: 657d 2c20 7072 6570 6f73 743d 7b70 7265  e}, prepost={pre
-00004980: 706f 7374 7d2c 2072 6570 6169 723d 7b72  post}, repair={r
-00004990: 6570 6169 727d 2922 0a20 2020 2020 2020  epair})".       
-000049a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000049b0: 2020 206c 6f67 5f6d 7367 203d 2066 2250     log_msg = f"P
-000049c0: 7269 6365 4869 7374 6f72 792d 7b73 656c  riceHistory-{sel
-000049d0: 662e 6973 7472 7d2e 6765 7428 746b 723d  f.istr}.get(tkr=
-000049e0: 7b73 656c 662e 7469 636b 6572 7d2c 2073  {self.ticker}, s
-000049f0: 7461 7274 3d7b 7374 6172 747d 2c20 656e  tart={start}, en
-00004a00: 643d 7b65 6e64 7d2c 206d 6178 5f61 6765  d={end}, max_age
-00004a10: 3d7b 6d61 785f 6167 657d 2c20 7472 6967  ={max_age}, trig
-00004a20: 6765 725f 6174 5f6d 6172 6b65 745f 636c  ger_at_market_cl
-00004a30: 6f73 653d 7b74 7269 6767 6572 5f61 745f  ose={trigger_at_
-00004a40: 6d61 726b 6574 5f63 6c6f 7365 7d2c 2070  market_close}, p
-00004a50: 7265 706f 7374 3d7b 7072 6570 6f73 747d  repost={prepost}
-00004a60: 2c20 7265 7061 6972 3d7b 7265 7061 6972  , repair={repair
-00004a70: 7d29 220a 2020 2020 2020 2020 6966 2079  })".        if y
-00004a80: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-00004a90: 626c 6564 2829 3a0a 2020 2020 2020 2020  bled():.        
-00004aa0: 2020 2020 7966 636c 2e54 7261 6365 456e      yfcl.TraceEn
-00004ab0: 7465 7228 6c6f 675f 6d73 6729 0a20 2020  ter(log_msg).   
-00004ac0: 2020 2020 2065 6c69 6620 6465 6275 675f       elif debug_
-00004ad0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
-00004ae0: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
-00004af0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00004b00: 2020 2020 2020 2020 2020 7966 5f6c 6167            yf_lag
-00004b10: 203d 2079 6663 642e 6578 6368 616e 6765   = yfcd.exchange
-00004b20: 546f 5966 4c61 675b 7365 6c66 2e65 7863  ToYfLag[self.exc
-00004b30: 6861 6e67 655d 0a20 2020 2020 2020 2065  hange].        e
-00004b40: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-00004b50: 2020 2070 7269 6e74 2866 222d 2074 6963     print(f"- tic
-00004b60: 6b65 7220 3d20 7b73 656c 662e 7469 636b  ker = {self.tick
-00004b70: 6572 7d22 290a 2020 2020 2020 2020 2020  er}").          
-00004b80: 2020 7261 6973 650a 0a20 2020 2020 2020    raise..       
-00004b90: 2070 7374 7220 3d20 4e6f 6e65 0a20 2020   pstr = None.   
-00004ba0: 2020 2020 2065 6e64 5f64 203d 204e 6f6e       end_d = Non
-00004bb0: 6520 3b20 656e 645f 6474 203d 204e 6f6e  e ; end_dt = Non
-00004bc0: 650a 2020 2020 2020 2020 6966 2070 6572  e.        if per
-00004bd0: 696f 6420 6973 206e 6f74 204e 6f6e 653a  iod is not None:
-00004be0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00004bf0: 7274 5f64 2c20 656e 645f 6420 3d20 7966  rt_d, end_d = yf
-00004c00: 6374 2e4d 6170 5065 7269 6f64 546f 4461  ct.MapPeriodToDa
-00004c10: 7465 7328 7365 6c66 2e65 7863 6861 6e67  tes(self.exchang
-00004c20: 652c 2070 6572 696f 642c 2073 656c 662e  e, period, self.
-00004c30: 696e 7465 7276 616c 290a 2020 2020 2020  interval).      
-00004c40: 2020 2020 2020 7065 7269 6f64 203d 204e        period = N
-00004c50: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00004c60: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
-00004c70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004c80: 2020 7374 6172 7420 3d20 7374 6172 745f    start = start_
-00004c90: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00004ca0: 2020 656e 6420 3d20 656e 645f 640a 2020    end = end_d.  
-00004cb0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00004cc0: 6172 745f 6474 203d 2064 6174 6574 696d  art_dt = datetim
-00004cd0: 652e 636f 6d62 696e 6528 7374 6172 745f  e.combine(start_
-00004ce0: 642c 2074 696d 6528 3029 2c20 747a 5f65  d, time(0), tz_e
-00004cf0: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
-00004d00: 2020 2020 2020 2020 2065 6e64 5f64 7420           end_dt 
-00004d10: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
-00004d20: 6e65 2865 6e64 5f64 2c20 7469 6d65 2830  ne(end_d, time(0
-00004d30: 292c 2074 7a5f 6578 6368 616e 6765 290a  ), tz_exchange).
-00004d40: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004d50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004d60: 2020 7374 6172 7420 3d20 6461 7465 7469    start = dateti
-00004d70: 6d65 2e63 6f6d 6269 6e65 2873 7461 7274  me.combine(start
-00004d80: 5f64 2c20 7469 6d65 2830 292c 2074 7a5f  _d, time(0), tz_
-00004d90: 6578 6368 616e 6765 290a 2020 2020 2020  exchange).      
-00004da0: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
-00004db0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00004dc0: 2020 2020 2073 7461 7274 5f64 7420 3d20       start_dt = 
-00004dd0: 7374 6172 740a 2020 2020 2020 2020 2020  start.          
-00004de0: 2020 2020 2020 656e 645f 6474 203d 204e        end_dt = N
-00004df0: 6f6e 650a 2020 2020 2020 2020 656c 7365  one.        else
-00004e00: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00004e10: 2073 656c 662e 696e 7465 7264 6179 3a0a   self.interday:.
-00004e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e30: 7374 6172 745f 6474 203d 2064 6174 6574  start_dt = datet
-00004e40: 696d 652e 636f 6d62 696e 6528 7374 6172  ime.combine(star
-00004e50: 742c 2074 696d 6528 3029 2c20 747a 5f65  t, time(0), tz_e
-00004e60: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
-00004e70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00004e80: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00004e90: 696e 7374 616e 6365 2873 7461 7274 2c20  instance(start, 
-00004ea0: 6461 7465 7469 6d65 293a 0a20 2020 2020  datetime):.     
-00004eb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00004ec0: 7461 7274 5f64 7420 3d20 7374 6172 740a  tart_dt = start.
-00004ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ee0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00004ef0: 2020 2020 2020 2020 2020 7374 6172 745f            start_
-00004f00: 6474 203d 2064 6174 6574 696d 652e 636f  dt = datetime.co
-00004f10: 6d62 696e 6528 7374 6172 742c 2074 696d  mbine(start, tim
-00004f20: 6528 3029 2c20 747a 5f65 7863 6861 6e67  e(0), tz_exchang
-00004f30: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00004f40: 2020 2020 2020 2073 7461 7274 203d 2073         start = s
-00004f50: 7461 7274 5f64 740a 0a20 2020 2020 2020  tart_dt..       
-00004f60: 2069 6620 656e 6420 6973 204e 6f6e 6520   if end is None 
-00004f70: 616e 6420 7073 7472 2069 7320 4e6f 6e65  and pstr is None
-00004f80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00004f90: 2073 656c 662e 696e 7465 7264 6179 3a0a   self.interday:.
-00004fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fb0: 656e 6420 3d20 645f 6e6f 775f 6578 6368  end = d_now_exch
-00004fc0: 616e 6765 2b74 645f 3164 0a20 2020 2020  ange+td_1d.     
-00004fd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00004fe0: 2020 2020 2020 2020 2020 2020 2073 6368               sch
-00004ff0: 6564 203d 2079 6663 742e 4765 7445 7863  ed = yfct.GetExc
-00005000: 6861 6e67 6553 6368 6564 756c 6528 7365  hangeSchedule(se
-00005010: 6c66 2e65 7863 6861 6e67 652c 2064 5f6e  lf.exchange, d_n
-00005020: 6f77 5f65 7863 6861 6e67 652c 2064 5f6e  ow_exchange, d_n
-00005030: 6f77 5f65 7863 6861 6e67 652b 7464 5f31  ow_exchange+td_1
-00005040: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-00005050: 2020 2069 6620 7363 6865 6420 6973 204e     if sched is N
-00005060: 6f6e 6520 6f72 2028 6474 5f6e 6f77 202b  one or (dt_now +
-00005070: 2079 665f 6c61 6729 203c 2073 6368 6564   yf_lag) < sched
-00005080: 5b22 6f70 656e 225d 2e69 6c6f 635b 305d  ["open"].iloc[0]
-00005090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000050a0: 2020 2020 2020 2320 4265 666f 7265 206d        # Before m
-000050b0: 6172 6b65 7420 6f70 656e 0a20 2020 2020  arket open.     
-000050c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000050d0: 6e64 203d 2064 6174 6574 696d 652e 636f  nd = datetime.co
-000050e0: 6d62 696e 6528 645f 6e6f 775f 6578 6368  mbine(d_now_exch
-000050f0: 616e 6765 2c20 7469 6d65 2830 292c 2074  ange, time(0), t
-00005100: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
-00005110: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00005120: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00005130: 2020 2020 2020 6920 3d20 7966 6374 2e47        i = yfct.G
-00005140: 6574 5469 6d65 7374 616d 7043 7572 7265  etTimestampCurre
-00005150: 6e74 496e 7465 7276 616c 2873 656c 662e  ntInterval(self.
-00005160: 6578 6368 616e 6765 2c20 6474 5f6e 6f77  exchange, dt_now
-00005170: 2b79 665f 6c61 672c 2073 656c 662e 696e  +yf_lag, self.in
-00005180: 7465 7276 616c 2c20 6967 6e6f 7265 5f62  terval, ignore_b
-00005190: 7265 616b 733d 5472 7565 290a 2020 2020  reaks=True).    
-000051a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051b0: 6966 2069 2069 7320 4e6f 6e65 3a0a 2020  if i is None:.  
-000051c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051d0: 2020 2020 2020 2320 4166 7465 7220 696e        # After in
-000051e0: 7465 7276 616c 0a20 2020 2020 2020 2020  terval.         
-000051f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00005200: 6e64 203d 2064 6174 6574 696d 652e 636f  nd = datetime.co
-00005210: 6d62 696e 6528 645f 6e6f 775f 6578 6368  mbine(d_now_exch
-00005220: 616e 6765 2b74 645f 3164 2c20 7469 6d65  ange+td_1d, time
-00005230: 2830 292c 2074 7a5f 6578 6368 616e 6765  (0), tz_exchange
-00005240: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00005250: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00005260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005270: 2020 2020 2320 4475 7269 6e67 2069 6e74      # During int
-00005280: 6572 7661 6c0a 2020 2020 2020 2020 2020  erval.          
-00005290: 2020 2020 2020 2020 2020 2020 2020 656e                en
-000052a0: 6420 3d20 695b 2269 6e74 6572 7661 6c5f  d = i["interval_
-000052b0: 636c 6f73 6522 5d0a 2020 2020 2020 2020  close"].        
-000052c0: 6966 2065 6e64 2069 7320 6e6f 7420 4e6f  if end is not No
-000052d0: 6e65 2061 6e64 2065 6e64 5f64 7420 6973  ne and end_dt is
-000052e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000052f0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00005300: 2865 6e64 2c20 6461 7465 7469 6d65 293a  (end, datetime):
-00005310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005320: 2065 6e64 5f64 7420 3d20 656e 640a 2020   end_dt = end.  
-00005330: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00005340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005350: 2320 656e 645f 6474 203d 2064 6174 6574  # end_dt = datet
-00005360: 696d 652e 636f 6d62 696e 6528 656e 642b  ime.combine(end+
-00005370: 7464 5f31 642c 2074 696d 6528 3029 2c20  td_1d, time(0), 
-00005380: 747a 5f65 7863 6861 6e67 6529 0a20 2020  tz_exchange).   
-00005390: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-000053a0: 5f64 7420 3d20 6461 7465 7469 6d65 2e63  _dt = datetime.c
-000053b0: 6f6d 6269 6e65 2865 6e64 2c20 7469 6d65  ombine(end, time
-000053c0: 2830 292c 2074 7a5f 6578 6368 616e 6765  (0), tz_exchange
-000053d0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000053e0: 206e 6f74 2073 656c 662e 696e 7465 7264   not self.interd
-000053f0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
-00005400: 2020 2020 656e 6420 3d20 656e 645f 6474      end = end_dt
-00005410: 0a0a 2020 2020 2020 2020 6966 2070 6572  ..        if per
-00005420: 696f 6420 6973 204e 6f6e 653a 0a20 2020  iod is None:.   
-00005430: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00005440: 2e69 6e74 6572 6461 793a 0a20 2020 2020  .interday:.     
-00005450: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00005460: 696e 7374 616e 6365 2873 7461 7274 2c20  instance(start, 
-00005470: 6461 7465 7469 6d65 2920 6f72 2069 7369  datetime) or isi
-00005480: 6e73 7461 6e63 6528 656e 642c 2064 6174  nstance(end, dat
-00005490: 6574 696d 6529 3a0a 2020 2020 2020 2020  etime):.        
-000054a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000054b0: 6520 5479 7065 4572 726f 7228 6622 2773  e TypeError(f"'s
-000054c0: 7461 7274 2720 616e 6420 2765 6e64 2720  tart' and 'end' 
-000054d0: 6d75 7374 2062 6520 6461 7465 2074 7970  must be date typ
-000054e0: 6520 6e6f 7420 7b74 7970 6528 7374 6172  e not {type(star
-000054f0: 7429 7d2c 207b 7479 7065 2865 6e64 297d  t)}, {type(end)}
-00005500: 2229 0a20 2020 2020 2020 2020 2020 2065  ").            e
-00005510: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00005520: 2020 2020 2069 6620 286e 6f74 2069 7369       if (not isi
-00005530: 6e73 7461 6e63 6528 7374 6172 742c 2064  nstance(start, d
-00005540: 6174 6574 696d 6529 2920 616e 6420 286e  atetime)) and (n
-00005550: 6f74 2069 7369 6e73 7461 6e63 6528 656e  ot isinstance(en
-00005560: 642c 2064 6174 6574 696d 6529 293a 0a20  d, datetime)):. 
-00005570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005580: 2020 2072 6169 7365 2054 7970 6545 7272     raise TypeErr
-00005590: 6f72 2866 2227 7374 6172 7427 2061 6e64  or(f"'start' and
-000055a0: 2027 656e 6427 206d 7573 7420 6265 2064   'end' must be d
-000055b0: 6174 6574 696d 6520 7479 7065 206e 6f74  atetime type not
-000055c0: 207b 7479 7065 2873 7461 7274 297d 2c20   {type(start)}, 
-000055d0: 7b74 7970 6528 656e 6429 7d22 290a 0a20  {type(end)}").. 
-000055e0: 2020 2020 2020 206c 6973 7469 6e67 5f64         listing_d
-000055f0: 6174 6520 3d20 7966 636d 2e52 6561 6443  ate = yfcm.ReadC
-00005600: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
-00005610: 6963 6b65 722c 2022 6c69 7374 696e 675f  icker, "listing_
-00005620: 6461 7465 2229 0a20 2020 2020 2020 2069  date").        i
-00005630: 6620 6c69 7374 696e 675f 6461 7465 2069  f listing_date i
-00005640: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2073  s not None and s
-00005650: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
-00005660: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
-00005670: 7374 696e 675f 6461 7465 5f64 7420 3d20  sting_date_dt = 
-00005680: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
-00005690: 286c 6973 7469 6e67 5f64 6174 652c 2074  (listing_date, t
-000056a0: 696d 6528 3029 2c20 747a 5f65 7863 6861  ime(0), tz_excha
-000056b0: 6e67 6529 0a20 2020 2020 2020 2020 2020  nge).           
-000056c0: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
-000056d0: 7461 7274 2c20 6461 7465 7469 6d65 293a  tart, datetime):
-000056e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000056f0: 2073 7461 7274 203d 206d 6178 2873 7461   start = max(sta
-00005700: 7274 2c20 6c69 7374 696e 675f 6461 7465  rt, listing_date
-00005710: 5f64 7429 0a20 2020 2020 2020 2020 2020  _dt).           
-00005720: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00005730: 2020 2020 2020 2073 7461 7274 203d 206d         start = m
-00005740: 6178 2873 7461 7274 2c20 6c69 7374 696e  ax(start, listin
-00005750: 675f 6461 7465 290a 0a20 2020 2020 2020  g_date)..       
-00005760: 2069 6620 7365 6c66 2e68 2069 7320 6e6f   if self.h is no
-00005770: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00005780: 2020 2020 6966 2073 656c 662e 682e 656d      if self.h.em
-00005790: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-000057a0: 2020 2020 2073 656c 662e 6820 3d20 4e6f       self.h = No
-000057b0: 6e65 0a0a 2020 2020 2020 2020 2320 5265  ne..        # Re
-000057c0: 6d6f 7665 2065 7870 6972 6564 2069 6e74  move expired int
-000057d0: 6572 7661 6c73 2066 726f 6d20 6361 6368  ervals from cach
-000057e0: 650a 2020 2020 2020 2020 6966 2073 656c  e.        if sel
-000057f0: 662e 6820 6973 206e 6f74 204e 6f6e 653a  f.h is not None:
-00005800: 0a20 2020 2020 2020 2020 2020 206e 203d  .            n =
-00005810: 2073 656c 662e 682e 7368 6170 655b 305d   self.h.shape[0]
-00005820: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005830: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-00005840: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00005850: 5f69 6e74 6572 7661 6c5f 6474 7320 3d20  _interval_dts = 
-00005860: 7365 6c66 2e68 2e69 6e64 6578 2e64 6174  self.h.index.dat
-00005870: 6520 6966 2069 7369 6e73 7461 6e63 6528  e if isinstance(
-00005880: 7365 6c66 2e68 2e69 6e64 6578 5b30 5d2c  self.h.index[0],
-00005890: 2070 642e 5469 6d65 7374 616d 7029 2065   pd.Timestamp) e
-000058a0: 6c73 6520 7365 6c66 2e68 2e69 6e64 6578  lse self.h.index
-000058b0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000058c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000058d0: 2020 2068 5f69 6e74 6572 7661 6c5f 6474     h_interval_dt
-000058e0: 7320 3d20 6e70 2e61 7272 6179 285b 7966  s = np.array([yf
-000058f0: 6374 2e43 6f6e 7665 7274 546f 4461 7465  ct.ConvertToDate
-00005900: 7469 6d65 2864 742c 2074 7a3d 747a 5f65  time(dt, tz=tz_e
-00005910: 7863 6861 6e67 6529 2066 6f72 2064 7420  xchange) for dt 
-00005920: 696e 2073 656c 662e 682e 696e 6465 785d  in self.h.index]
-00005930: 290a 2020 2020 2020 2020 2020 2020 685f  ).            h_
-00005940: 696e 7465 7276 616c 5f64 7473 203d 206e  interval_dts = n
-00005950: 702e 6172 7261 7928 685f 696e 7465 7276  p.array(h_interv
-00005960: 616c 5f64 7473 290a 2020 2020 2020 2020  al_dts).        
-00005970: 2020 2020 2320 6966 2073 656c 662e 696e      # if self.in
-00005980: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
-00005990: 6e74 6572 7661 6c2e 4461 7973 313a 0a20  nterval.Days1:. 
-000059a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000059b0: 6c66 2e63 6f6e 7469 6775 6f75 733a 0a20  lf.contiguous:. 
-000059c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000059d0: 2044 6169 6c79 2064 6174 6120 6973 2061   Daily data is a
-000059e0: 6c77 6179 7320 636f 6e74 6967 756f 7573  lways contiguous
-000059f0: 2073 6f20 6f6e 6c79 206e 6565 6420 746f   so only need to
-00005a00: 2063 6865 636b 206c 6173 7420 726f 770a   check last row.
-00005a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a20: 685f 696e 7465 7276 616c 5f64 7420 3d20  h_interval_dt = 
-00005a30: 685f 696e 7465 7276 616c 5f64 7473 5b2d  h_interval_dts[-
-00005a40: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-00005a50: 2020 2066 6574 6368 5f64 7420 3d20 7966     fetch_dt = yf
-00005a60: 6374 2e43 6f6e 7665 7274 546f 4461 7465  ct.ConvertToDate
-00005a70: 7469 6d65 2873 656c 662e 685b 2246 6574  time(self.h["Fet
-00005a80: 6368 4461 7465 225d 2e69 6c6f 635b 2d31  chDate"].iloc[-1
-00005a90: 5d2c 2074 7a3d 747a 5f65 7863 6861 6e67  ], tz=tz_exchang
-00005aa0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00005ab0: 2020 2066 5f66 696e 616c 203d 2073 656c     f_final = sel
-00005ac0: 662e 685b 2246 696e 616c 3f22 5d2e 746f  f.h["Final?"].to
-00005ad0: 5f6e 756d 7079 2829 0a20 2020 2020 2020  _numpy().       
-00005ae0: 2020 2020 2020 2020 2066 5f6e 6669 6e61           f_nfina
-00005af0: 6c20 3d20 7e66 5f66 696e 616c 0a20 2020  l = ~f_final.   
-00005b00: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00005b10: 665f 6e66 696e 616c 2e61 6e79 2829 3a0a  f_nfinal.any():.
-00005b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b30: 2020 2020 6964 7830 203d 206e 702e 7768      idx0 = np.wh
-00005b40: 6572 6528 665f 6e66 696e 616c 295b 305d  ere(f_nfinal)[0]
-00005b50: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00005b60: 2020 2020 2020 2020 685f 696e 7465 7276          h_interv
-00005b70: 616c 5f64 7420 3d20 685f 696e 7465 7276  al_dt = h_interv
-00005b80: 616c 5f64 7473 5b69 6478 305d 0a20 2020  al_dts[idx0].   
-00005b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ba0: 2066 6574 6368 5f64 7420 3d20 7966 6374   fetch_dt = yfct
-00005bb0: 2e43 6f6e 7665 7274 546f 4461 7465 7469  .ConvertToDateti
-00005bc0: 6d65 2873 656c 662e 685b 2246 6574 6368  me(self.h["Fetch
-00005bd0: 4461 7465 225d 5b69 6478 305d 2c20 747a  Date"][idx0], tz
-00005be0: 3d74 7a5f 6578 6368 616e 6765 290a 2020  =tz_exchange).  
-00005bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c00: 2020 6578 7069 7265 6420 3d20 7966 6374    expired = yfct
-00005c10: 2e49 7350 7269 6365 4461 7461 706f 696e  .IsPriceDatapoin
-00005c20: 7445 7870 6972 6564 2868 5f69 6e74 6572  tExpired(h_inter
-00005c30: 7661 6c5f 6474 2c20 6665 7463 685f 6474  val_dt, fetch_dt
-00005c40: 2c20 6d61 785f 6167 652c 2073 656c 662e  , max_age, self.
-00005c50: 6578 6368 616e 6765 2c20 7365 6c66 2e69  exchange, self.i
-00005c60: 6e74 6572 7661 6c2c 2079 665f 6c61 673d  nterval, yf_lag=
-00005c70: 7966 5f6c 6167 2c20 7472 6967 6765 7245  yf_lag, triggerE
-00005c80: 7870 6972 794f 6e43 6c6f 7365 3d74 7269  xpiryOnClose=tri
-00005c90: 6767 6572 5f61 745f 6d61 726b 6574 5f63  gger_at_market_c
-00005ca0: 6c6f 7365 290a 2020 2020 2020 2020 2020  lose).          
-00005cb0: 2020 2020 2020 2020 2020 6966 2065 7870            if exp
-00005cc0: 6972 6564 3a0a 2020 2020 2020 2020 2020  ired:.          
-00005cd0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00005ce0: 6c66 2e68 203d 2073 656c 662e 682e 696c  lf.h = self.h.il
-00005cf0: 6f63 5b3a 6964 7830 5d0a 2020 2020 2020  oc[:idx0].      
-00005d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005d10: 2020 685f 696e 7465 7276 616c 5f64 7473    h_interval_dts
-00005d20: 203d 2068 5f69 6e74 6572 7661 6c5f 6474   = h_interval_dt
-00005d30: 735b 3a69 6478 305d 0a0a 2020 2020 2020  s[:idx0]..      
-00005d40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00005d50: 2020 2020 2020 2020 2020 2020 6578 7069              expi
-00005d60: 7265 6420 3d20 6e70 2e61 7272 6179 285b  red = np.array([
-00005d70: 4661 6c73 655d 2a6e 290a 2020 2020 2020  False]*n).      
-00005d80: 2020 2020 2020 2020 2020 665f 6669 6e61            f_fina
-00005d90: 6c20 3d20 7365 6c66 2e68 5b22 4669 6e61  l = self.h["Fina
-00005da0: 6c3f 225d 2e74 6f5f 6e75 6d70 7928 290a  l?"].to_numpy().
-00005db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005dc0: 666f 7220 6964 7820 696e 206e 702e 7768  for idx in np.wh
-00005dd0: 6572 6528 7e66 5f66 696e 616c 295b 305d  ere(~f_final)[0]
-00005de0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00005df0: 2020 2020 2020 685f 696e 7465 7276 616c        h_interval
-00005e00: 5f64 7420 3d20 685f 696e 7465 7276 616c  _dt = h_interval
-00005e10: 5f64 7473 5b69 6478 5d0a 2020 2020 2020  _dts[idx].      
-00005e20: 2020 2020 2020 2020 2020 2020 2020 6665                fe
-00005e30: 7463 685f 6474 203d 2079 6663 742e 436f  tch_dt = yfct.Co
-00005e40: 6e76 6572 7454 6f44 6174 6574 696d 6528  nvertToDatetime(
-00005e50: 7365 6c66 2e68 5b22 4665 7463 6844 6174  self.h["FetchDat
-00005e60: 6522 5d5b 6964 785d 2c20 747a 3d74 7a5f  e"][idx], tz=tz_
-00005e70: 6578 6368 616e 6765 290a 2020 2020 2020  exchange).      
-00005e80: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00005e90: 7069 7265 645b 6964 785d 203d 2079 6663  pired[idx] = yfc
-00005ea0: 742e 4973 5072 6963 6544 6174 6170 6f69  t.IsPriceDatapoi
-00005eb0: 6e74 4578 7069 7265 6428 685f 696e 7465  ntExpired(h_inte
-00005ec0: 7276 616c 5f64 742c 2066 6574 6368 5f64  rval_dt, fetch_d
-00005ed0: 742c 206d 6178 5f61 6765 2c20 7365 6c66  t, max_age, self
-00005ee0: 2e65 7863 6861 6e67 652c 2073 656c 662e  .exchange, self.
-00005ef0: 696e 7465 7276 616c 2c20 7966 5f6c 6167  interval, yf_lag
-00005f00: 3d79 665f 6c61 672c 2074 7269 6767 6572  =yf_lag, trigger
-00005f10: 4578 7069 7279 4f6e 436c 6f73 653d 7472  ExpiryOnClose=tr
-00005f20: 6967 6765 725f 6174 5f6d 6172 6b65 745f  igger_at_market_
-00005f30: 636c 6f73 6529 0a20 2020 2020 2020 2020  close).         
-00005f40: 2020 2020 2020 2069 6620 6578 7069 7265         if expire
-00005f50: 642e 616e 7928 293a 0a20 2020 2020 2020  d.any():.       
-00005f60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00005f70: 662e 6820 3d20 7365 6c66 2e68 2e64 726f  f.h = self.h.dro
-00005f80: 7028 7365 6c66 2e68 2e69 6e64 6578 5b65  p(self.h.index[e
-00005f90: 7870 6972 6564 5d29 0a20 2020 2020 2020  xpired]).       
-00005fa0: 2020 2020 2020 2020 2020 2020 2068 5f69               h_i
-00005fb0: 6e74 6572 7661 6c5f 6474 7320 3d20 685f  nterval_dts = h_
-00005fc0: 696e 7465 7276 616c 5f64 7473 5b7e 6578  interval_dts[~ex
-00005fd0: 7069 7265 645d 0a20 2020 2020 2020 2020  pired].         
-00005fe0: 2020 2069 6620 7365 6c66 2e68 2e65 6d70     if self.h.emp
-00005ff0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00006000: 2020 2020 7365 6c66 2e68 203d 204e 6f6e      self.h = Non
-00006010: 650a 0a20 2020 2020 2020 2072 616e 6765  e..        range
-00006020: 735f 746f 5f66 6574 6368 203d 205b 5d0a  s_to_fetch = [].
-00006030: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00006040: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
-00006050: 2020 2020 2020 2023 2053 696d 706c 652c         # Simple,
-00006060: 206a 7573 7420 6665 7463 6820 7468 6520   just fetch the 
-00006070: 7265 7175 6573 7465 6420 6461 7461 0a0a  requested data..
-00006080: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-00006090: 6572 696f 6420 6973 206e 6f74 204e 6f6e  eriod is not Non
-000060a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000060b0: 2020 2068 203d 2073 656c 662e 5f66 6574     h = self._fet
-000060c0: 6368 5966 4869 7374 6f72 7928 7073 7472  chYfHistory(pstr
-000060d0: 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20 7072  , None, None, pr
-000060e0: 6570 6f73 742c 2064 6562 7567 5f79 6629  epost, debug_yf)
-000060f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006100: 2069 6620 6820 6973 204e 6f6e 653a 0a20   if h is None:. 
-00006110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006120: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00006130: 6f6e 2866 227b 7365 6c66 2e74 6963 6b65  on(f"{self.ticke
-00006140: 727d 3a20 4661 696c 6564 2074 6f20 6665  r}: Failed to fe
-00006150: 7463 6820 7065 7269 6f64 3d7b 7065 7269  tch period={peri
-00006160: 6f64 7d22 290a 2020 2020 2020 2020 2020  od}").          
-00006170: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006180: 2020 2020 2020 2020 2320 6966 2073 656c          # if sel
-00006190: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-000061a0: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
-000061b0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-000061c0: 2020 2069 6620 7365 6c66 2e63 6f6e 7469     if self.conti
-000061d0: 6775 6f75 733a 0a20 2020 2020 2020 2020  guous:.         
-000061e0: 2020 2020 2020 2020 2020 2023 2045 6e73             # Ens
-000061f0: 7572 6520 6461 696c 7920 616c 7761 7973  ure daily always
-00006200: 2075 702d 746f 2d6e 6f77 0a20 2020 2020   up-to-now.     
-00006210: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00006220: 203d 2073 656c 662e 5f66 6574 6368 5966   = self._fetchYf
-00006230: 4869 7374 6f72 7928 7073 7472 2c20 7374  History(pstr, st
-00006240: 6172 742c 2074 6f6d 6f72 726f 772c 2070  art, tomorrow, p
-00006250: 7265 706f 7374 2c20 6465 6275 675f 7966  repost, debug_yf
-00006260: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006270: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00006280: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
-00006290: 7365 6c66 2e5f 6665 7463 6859 6648 6973  self._fetchYfHis
-000062a0: 746f 7279 2870 7374 722c 2073 7461 7274  tory(pstr, start
-000062b0: 2c20 656e 642c 2070 7265 706f 7374 2c20  , end, prepost, 
-000062c0: 6465 6275 675f 7966 290a 2020 2020 2020  debug_yf).      
-000062d0: 2020 2020 2020 2020 2020 6966 2068 2069            if h i
-000062e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000062f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00006300: 6520 4578 6365 7074 696f 6e28 6622 7b73  e Exception(f"{s
-00006310: 656c 662e 7469 636b 6572 7d3a 2046 6169  elf.ticker}: Fai
-00006320: 6c65 6420 746f 2066 6574 6368 2064 6174  led to fetch dat
-00006330: 6520 7261 6e67 6520 7b73 7461 7274 7d2d  e range {start}-
-00006340: 3e7b 656e 647d 2229 0a20 2020 2020 2020  >{end}").       
-00006350: 2020 2020 2023 2068 5f6d 6f64 6966 6965       # h_modifie
-00006360: 6420 3d20 5472 7565 0a0a 2020 2020 2020  d = True..      
-00006370: 2020 2020 2020 2320 4164 6a75 7374 0a20        # Adjust. 
-00006380: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-00006390: 6e6f 7420 7365 6c66 2e69 6e74 6572 7661  not self.interva
-000063a0: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
-000063b0: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
-000063c0: 2020 2020 2020 2320 2020 2020 7365 6c66        #     self
-000063d0: 2e6d 616e 6167 6572 2e47 6574 4869 7374  .manager.GetHist
-000063e0: 6f72 7928 7966 6364 2e49 6e74 6572 7661  ory(yfcd.Interva
-000063f0: 6c2e 4461 7973 3129 2e67 6574 2873 7461  l.Days1).get(sta
-00006400: 7274 3d73 656c 662e 682e 696e 6465 785b  rt=self.h.index[
-00006410: 2d31 5d2e 6461 7465 2829 2b74 645f 3164  -1].date()+td_1d
-00006420: 2920 2023 2064 6f75 6274 206e 6565 6465  )  # doubt neede
-00006430: 640a 2020 2020 2020 2020 2020 2020 6820  d.            h 
-00006440: 3d20 7365 6c66 2e5f 7265 7665 7273 6559  = self._reverseY
-00006450: 6168 6f6f 4164 6a75 7374 2868 290a 0a20  ahooAdjust(h).. 
-00006460: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00006470: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-00006480: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-00006490: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-000064a0: 2020 2020 685f 7370 6c69 7473 203d 2068      h_splits = h
-000064b0: 5b68 5b22 5374 6f63 6b20 5370 6c69 7473  [h["Stock Splits
-000064c0: 225d 2021 3d20 305d 0a20 2020 2020 2020  "] != 0].       
-000064d0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-000064e0: 685f 7370 6c69 7473 2920 3e20 303a 0a20  h_splits) > 0:. 
-000064f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006500: 2020 2073 656c 662e 6d61 6e61 6765 722e     self.manager.
-00006510: 4765 7448 6973 746f 7279 2822 4576 656e  GetHistory("Even
-00006520: 7473 2229 2e55 7064 6174 6553 706c 6974  ts").UpdateSplit
-00006530: 7328 685f 7370 6c69 7473 290a 0a20 2020  s(h_splits)..   
-00006540: 2020 2020 2020 2020 2020 2020 2068 5f64               h_d
-00006550: 6976 7320 3d20 685b 685b 2244 6976 6964  ivs = h[h["Divid
-00006560: 656e 6473 225d 2021 3d20 305d 5b5b 2244  ends"] != 0][["D
-00006570: 6976 6964 656e 6473 222c 2022 4665 7463  ividends", "Fetc
-00006580: 6844 6174 6522 5d5d 2e63 6f70 7928 290a  hDate"]].copy().
-00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065a0: 6966 206c 656e 2868 5f64 6976 7329 203e  if len(h_divs) >
-000065b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000065c0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-000065d0: 6365 5072 696e 7428 2257 7269 7469 6e67  cePrint("Writing
-000065e0: 206e 6577 2064 6976 6964 656e 6473 2074   new dividends t
-000065f0: 6f20 6361 6368 6522 290a 2020 2020 2020  o cache").      
-00006600: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00006610: 6368 6564 5f6e 6577 5f64 6976 7320 3d20  ched_new_divs = 
-00006620: 7966 636d 2e52 6561 6443 6163 6865 4461  yfcm.ReadCacheDa
-00006630: 7475 6d28 7365 6c66 2e74 6963 6b65 722c  tum(self.ticker,
-00006640: 2022 6e65 775f 6469 7673 2229 0a20 2020   "new_divs").   
-00006650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006660: 2069 6620 6361 6368 6564 5f6e 6577 5f64   if cached_new_d
-00006670: 6976 7320 6973 206e 6f74 204e 6f6e 653a  ivs is not None:
-00006680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006690: 2020 2020 2020 2020 2069 6620 7966 636d           if yfcm
-000066a0: 2e52 6561 6443 6163 6865 4d65 7461 6461  .ReadCacheMetada
-000066b0: 7461 2873 656c 662e 7469 636b 6572 2c20  ta(self.ticker, 
-000066c0: 226e 6577 5f64 6976 7322 2c20 226c 6f63  "new_divs", "loc
-000066d0: 6b65 6422 2920 6973 206e 6f74 204e 6f6e  ked") is not Non
-000066e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000066f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00006700: 206c 6f63 6b65 640a 2020 2020 2020 2020   locked.        
-00006710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006720: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-00006730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006740: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00006750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006760: 2020 2063 6163 6865 645f 6e65 775f 6469     cached_new_di
-00006770: 7673 203d 2070 642e 636f 6e63 6174 285b  vs = pd.concat([
-00006780: 6361 6368 6564 5f6e 6577 5f64 6976 732c  cached_new_divs,
-00006790: 2068 5f64 6976 735d 290a 2020 2020 2020   h_divs]).      
-000067a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000067b0: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-000067c0: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-000067d0: 7469 636b 6572 2c20 226e 6577 5f64 6976  ticker, "new_div
-000067e0: 7322 2c20 6361 6368 6564 5f6e 6577 5f64  s", cached_new_d
-000067f0: 6976 7329 0a20 2020 2020 2020 2020 2020  ivs).           
-00006800: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00006810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006820: 2020 2020 2020 2079 6663 6d2e 5374 6f72         yfcm.Stor
-00006830: 6543 6163 6865 4461 7475 6d28 7365 6c66  eCacheDatum(self
-00006840: 2e74 6963 6b65 722c 2022 6e65 775f 6469  .ticker, "new_di
-00006850: 7673 222c 2068 5f64 6976 732e 636f 7079  vs", h_divs.copy
-00006860: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
-00006870: 2073 656c 662e 5f75 7064 6174 6564 4361   self._updatedCa
-00006880: 6368 6564 5072 6963 6573 2868 290a 0a20  chedPrices(h).. 
-00006890: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000068a0: 2020 2020 2020 2020 2023 2043 6f6d 7061           # Compa
-000068b0: 7265 2072 6571 7565 7374 2061 6761 696e  re request again
-000068c0: 7374 2063 6163 6865 6420 6461 7461 2c20  st cached data, 
-000068d0: 6f6e 6c79 2066 6574 6368 206d 6973 7369  only fetch missi
-000068e0: 6e67 2f65 7870 6972 6564 2064 6174 610a  ng/expired data.
-000068f0: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-00006900: 6572 666f 726d 616e 6365 2054 4f44 4f3a  erformance TODO:
-00006910: 2074 6167 2072 6f77 7320 6173 2066 756c   tag rows as ful
-00006920: 6c79 2063 6f6e 7469 6775 6f75 7320 746f  ly contiguous to
-00006930: 2061 766f 6964 2073 6561 7263 6869 6e67   avoid searching
-00006940: 2066 6f72 2067 6170 730a 0a20 2020 2020   for gaps..     
-00006950: 2020 2020 2020 2023 2043 616c 6375 6c61         # Calcula
-00006960: 7465 2072 616e 6765 735f 746f 5f66 6574  te ranges_to_fet
-00006970: 6368 0a20 2020 2020 2020 2020 2020 2023  ch.            #
-00006980: 2069 6620 7365 6c66 2e69 6e74 6572 7661   if self.interva
-00006990: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
-000069a0: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
-000069b0: 2020 2020 2020 6966 2073 656c 662e 636f        if self.co
-000069c0: 6e74 6967 756f 7573 3a0a 2020 2020 2020  ntiguous:.      
-000069d0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000069e0: 662e 6820 6973 204e 6f6e 6520 6f72 2073  f.h is None or s
-000069f0: 656c 662e 682e 656d 7074 793a 0a20 2020  elf.h.empty:.   
-00006a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a10: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
-00006a20: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00006a30: 2020 2020 2020 2020 2020 2072 616e 6765             range
-00006a40: 735f 746f 5f66 6574 6368 203d 2079 6663  s_to_fetch = yfc
-00006a50: 742e 4964 656e 7469 6679 4d69 7373 696e  t.IdentifyMissin
-00006a60: 6749 6e74 6572 7661 6c52 616e 6765 7328  gIntervalRanges(
-00006a70: 7365 6c66 2e65 7863 6861 6e67 652c 2073  self.exchange, s
-00006a80: 7461 7274 5f64 2c20 656e 645f 642c 2073  tart_d, end_d, s
-00006a90: 656c 662e 696e 7465 7276 616c 2c20 5b5d  elf.interval, []
-00006aa0: 2c20 6d69 6e44 6973 7461 6e63 6554 6872  , minDistanceThr
-00006ab0: 6573 686f 6c64 3d35 290a 2020 2020 2020  eshold=5).      
-00006ac0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00006ad0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006ae0: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
-00006af0: 6573 5f74 6f5f 6665 7463 6820 3d20 7966  es_to_fetch = yf
-00006b00: 6374 2e49 6465 6e74 6966 794d 6973 7369  ct.IdentifyMissi
-00006b10: 6e67 496e 7465 7276 616c 5261 6e67 6573  ngIntervalRanges
-00006b20: 2873 656c 662e 6578 6368 616e 6765 2c20  (self.exchange, 
-00006b30: 7374 6172 742c 2065 6e64 2c20 7365 6c66  start, end, self
-00006b40: 2e69 6e74 6572 7661 6c2c 205b 5d2c 206d  .interval, [], m
-00006b50: 696e 4469 7374 616e 6365 5468 7265 7368  inDistanceThresh
-00006b60: 6f6c 643d 3529 0a20 2020 2020 2020 2020  old=5).         
-00006b70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00006b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006b90: 2023 2045 6e73 7572 6520 7468 6174 2064   # Ensure that d
-00006ba0: 6169 6c79 2064 6174 6120 616c 7761 7973  aily data always
-00006bb0: 2075 702d 746f 2d64 6174 6520 746f 206e   up-to-date to n
-00006bc0: 6f77 0a20 2020 2020 2020 2020 2020 2020  ow.             
-00006bd0: 2020 2020 2020 2023 2055 7064 6174 653a         # Update:
-00006be0: 206f 6e6c 7920 6e65 6365 7373 6172 7920   only necessary 
-00006bf0: 746f 2062 6520 7570 2d74 6f2d 6461 7465  to be up-to-date
-00006c00: 2074 6f20 6e6f 7720 6966 2061 2066 6574   to now if a fet
-00006c10: 6368 2068 6170 7065 6e73 0a20 2020 2020  ch happens.     
-00006c20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00006c30: 745f 7374 6172 7420 3d20 7966 6374 2e43  t_start = yfct.C
-00006c40: 6f6e 7665 7274 546f 4461 7465 7469 6d65  onvertToDatetime
-00006c50: 2873 656c 662e 682e 696e 6465 785b 305d  (self.h.index[0]
-00006c60: 2c20 747a 3d74 7a5f 6578 6368 616e 6765  , tz=tz_exchange
-00006c70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006c80: 2020 2020 2020 6474 5f65 6e64 203d 2079        dt_end = y
-00006c90: 6663 742e 436f 6e76 6572 7454 6f44 6174  fct.ConvertToDat
-00006ca0: 6574 696d 6528 7365 6c66 2e68 2e69 6e64  etime(self.h.ind
-00006cb0: 6578 5b2d 315d 2c20 747a 3d74 7a5f 6578  ex[-1], tz=tz_ex
-00006cc0: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
-00006cd0: 2020 2020 2020 2020 2020 2020 685f 7374              h_st
-00006ce0: 6172 7420 3d20 7966 6374 2e47 6574 5469  art = yfct.GetTi
-00006cf0: 6d65 7374 616d 7043 7572 7265 6e74 496e  mestampCurrentIn
-00006d00: 7465 7276 616c 2873 656c 662e 6578 6368  terval(self.exch
-00006d10: 616e 6765 2c20 6474 5f73 7461 7274 2c20  ange, dt_start, 
-00006d20: 7365 6c66 2e69 6e74 6572 7661 6c2c 2069  self.interval, i
-00006d30: 676e 6f72 655f 6272 6561 6b73 3d54 7275  gnore_breaks=Tru
-00006d40: 6529 5b22 696e 7465 7276 616c 5f6f 7065  e)["interval_ope
-00006d50: 6e22 5d0a 2020 2020 2020 2020 2020 2020  n"].            
-00006d60: 2020 2020 2020 2020 685f 656e 6420 3d20          h_end = 
-00006d70: 7966 6374 2e47 6574 5469 6d65 7374 616d  yfct.GetTimestam
-00006d80: 7043 7572 7265 6e74 496e 7465 7276 616c  pCurrentInterval
-00006d90: 2873 656c 662e 6578 6368 616e 6765 2c20  (self.exchange, 
-00006da0: 6474 5f65 6e64 2c20 7365 6c66 2e69 6e74  dt_end, self.int
-00006db0: 6572 7661 6c2c 2069 676e 6f72 655f 6272  erval, ignore_br
-00006dc0: 6561 6b73 3d54 7275 6529 5b22 696e 7465  eaks=True)["inte
-00006dd0: 7276 616c 5f63 6c6f 7365 225d 0a0a 2020  rval_close"]..  
-00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006df0: 2020 7261 6e67 6550 7265 5f74 6f5f 6665    rangePre_to_fe
-00006e00: 7463 6820 3d20 4e6f 6e65 0a20 2020 2020  tch = None.     
-00006e10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006e20: 6620 7374 6172 7420 3c20 685f 7374 6172  f start < h_star
-00006e30: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00006e40: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00006e50: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-00006e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006e70: 2020 2020 206d 7367 203d 2022 6368 6563       msg = "chec
-00006e80: 6b69 6e67 2066 6f72 2072 616e 6765 5072  king for rangePr
-00006e90: 655f 746f 5f66 6574 6368 220a 2020 2020  e_to_fetch".    
-00006ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006eb0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-00006ec0: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
-00006ed0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-00006ee0: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
-00006ef0: 6e74 2866 227b 7365 6c66 2e74 6963 6b65  nt(f"{self.ticke
-00006f00: 727d 3a20 2220 2b20 6d73 6729 0a20 2020  r}: " + msg).   
-00006f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f20: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00006f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f40: 2020 2020 2020 7261 6e67 6550 7265 5f74        rangePre_t
-00006f50: 6f5f 6665 7463 6820 3d20 7966 6374 2e49  o_fetch = yfct.I
-00006f60: 6465 6e74 6966 794d 6973 7369 6e67 496e  dentifyMissingIn
-00006f70: 7465 7276 616c 5261 6e67 6573 2873 656c  tervalRanges(sel
-00006f80: 662e 6578 6368 616e 6765 2c20 7374 6172  f.exchange, star
-00006f90: 742c 2068 5f73 7461 7274 2c20 7365 6c66  t, h_start, self
-00006fa0: 2e69 6e74 6572 7661 6c2c 204e 6f6e 652c  .interval, None,
-00006fb0: 2069 676e 6f72 655f 6272 6561 6b73 3d54   ignore_breaks=T
-00006fc0: 7275 652c 206d 696e 4469 7374 616e 6365  rue, minDistance
-00006fd0: 5468 7265 7368 6f6c 643d 3529 0a20 2020  Threshold=5).   
-00006fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ff0: 2020 2020 2065 7863 6570 7420 7966 6364       except yfcd
-00007000: 2e4e 6f49 6e74 6572 7661 6c73 496e 5261  .NoIntervalsInRa
-00007010: 6e67 6545 7863 6570 7469 6f6e 3a0a 2020  ngeException:.  
-00007020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007030: 2020 2020 2020 2020 2020 7261 6e67 6550            rangeP
-00007040: 7265 5f74 6f5f 6665 7463 6820 3d20 4e6f  re_to_fetch = No
-00007050: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-00007060: 2020 2020 2020 2069 6620 7261 6e67 6550         if rangeP
-00007070: 7265 5f74 6f5f 6665 7463 6820 6973 206e  re_to_fetch is n
-00007080: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00007090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070a0: 2069 6620 6c65 6e28 7261 6e67 6550 7265   if len(rangePre
-000070b0: 5f74 6f5f 6665 7463 6829 203e 2031 3a0a  _to_fetch) > 1:.
-000070c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000070e0: 6520 4578 6365 7074 696f 6e28 2245 7870  e Exception("Exp
-000070f0: 6563 7465 6420 6f6e 6c79 206f 6e65 2065  ected only one e
-00007100: 6c65 6d65 6e74 2069 6e20 7261 6e67 6550  lement in rangeP
-00007110: 7265 5f74 6f5f 6665 7463 685b 5d2c 2062  re_to_fetch[], b
-00007120: 7574 203d 207b 7d22 2e66 6f72 6d61 7428  ut = {}".format(
-00007130: 7261 6e67 6550 7265 5f74 6f5f 6665 7463  rangePre_to_fetc
-00007140: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
-00007150: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
-00007160: 6550 7265 5f74 6f5f 6665 7463 6820 3d20  ePre_to_fetch = 
-00007170: 7261 6e67 6550 7265 5f74 6f5f 6665 7463  rangePre_to_fetc
-00007180: 685b 305d 0a20 2020 2020 2020 2020 2020  h[0].           
-00007190: 2020 2020 2020 2020 2023 0a20 2020 2020           #.     
-000071a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000071b0: 616e 6765 506f 7374 5f74 6f5f 6665 7463  angePost_to_fetc
-000071c0: 6820 3d20 4e6f 6e65 0a20 2020 2020 2020  h = None.       
-000071d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000071e0: 7365 6c66 2e68 5b22 4669 6e61 6c3f 225d  self.h["Final?"]
-000071f0: 2e69 6c6f 635b 2d31 5d20 616e 6420 286d  .iloc[-1] and (m
-00007200: 696e 2879 6663 742e 4361 6c63 496e 7465  in(yfct.CalcInte
-00007210: 7276 616c 4c61 7374 4461 7461 4474 2873  rvalLastDataDt(s
-00007220: 656c 662e 6578 6368 616e 6765 2c20 6474  elf.exchange, dt
-00007230: 5f65 6e64 2c20 7365 6c66 2e69 6e74 6572  _end, self.inter
-00007240: 7661 6c29 2c20 7365 6c66 2e68 5b22 4665  val), self.h["Fe
-00007250: 7463 6844 6174 6522 5d2e 696c 6f63 5b2d  tchDate"].iloc[-
-00007260: 315d 292b 6d61 785f 6167 6520 3c3d 2064  1])+max_age <= d
-00007270: 745f 6e6f 7729 3a0a 2020 2020 2020 2020  t_now):.        
-00007280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007290: 2320 4e6f 7465 3a20 6966 2073 656c 662e  # Note: if self.
-000072a0: 685b 2246 696e 616c 3f22 5d2e 696c 6f63  h["Final?"].iloc
-000072b0: 5b2d 315d 203d 3d20 4661 6c73 652c 2074  [-1] == False, t
-000072c0: 6865 6e20 7468 6174 206d 6561 6e73 2061  hen that means a
-000072d0: 626f 7665 2065 7870 6972 7920 6368 6563  bove expiry chec
-000072e0: 6b20 6469 646e 2774 2072 656d 6f76 6520  k didn't remove 
-000072f0: 6974 2073 6f20 646f 6e27 7420 6665 7463  it so don't fetc
-00007300: 6820 616e 7974 6869 6e67 0a20 2020 2020  h anything.     
-00007310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007320: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
-00007330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007340: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00007350: 203d 2022 6368 6563 6b69 6e67 2066 6f72   = "checking for
-00007360: 2072 616e 6765 506f 7374 5f74 6f5f 6665   rangePost_to_fe
-00007370: 7463 6822 0a20 2020 2020 2020 2020 2020  tch".           
+00001dc0: 2020 2020 2073 706c 6974 735f 6466 2e6c       splits_df.l
+00001dd0: 6f63 5b64 742c 2022 5375 7065 7273 6564  oc[dt, "Supersed
+00001de0: 6564 2073 706c 6974 2046 6574 6368 4461  ed split FetchDa
+00001df0: 7465 225d 203d 2073 656c 662e 7370 6c69  te"] = self.spli
+00001e00: 7473 2e6c 6f63 5b64 742c 2022 4665 7463  ts.loc[dt, "Fetc
+00001e10: 6844 6174 6522 5d0a 2020 2020 2020 2020  hDate"].        
+00001e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e30: 7365 6c66 2e73 706c 6974 7320 3d20 7365  self.splits = se
+00001e40: 6c66 2e73 706c 6974 732e 6472 6f70 2864  lf.splits.drop(d
+00001e50: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00001e60: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00001e70: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+00001e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e90: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+00001ea0: 2822 7375 7065 7273 6564 6522 290a 0a20  ("supersede").. 
+00001eb0: 2020 2020 2020 2020 2020 2063 6f6c 7320             cols 
+00001ec0: 3d20 5b22 5374 6f63 6b20 5370 6c69 7473  = ["Stock Splits
+00001ed0: 222c 2022 4665 7463 6844 6174 6522 2c20  ", "FetchDate", 
+00001ee0: 2253 7570 6572 7365 6465 6420 7370 6c69  "Superseded spli
+00001ef0: 7422 2c20 2253 7570 6572 7365 6465 6420  t", "Superseded 
+00001f00: 7370 6c69 7420 4665 7463 6844 6174 6522  split FetchDate"
+00001f10: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00001f20: 206e 6f74 2073 706c 6974 735f 6466 2e65   not splits_df.e
+00001f30: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
+00001f40: 2020 2020 2020 7370 6c69 7473 5f70 7265        splits_pre
+00001f50: 7474 7920 3d20 7370 6c69 7473 5f64 665b  tty = splits_df[
+00001f60: 2253 746f 636b 2053 706c 6974 7322 5d0a  "Stock Splits"].
+00001f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001f80: 7370 6c69 7473 5f70 7265 7474 792e 696e  splits_pretty.in
+00001f90: 6465 7820 3d20 7370 6c69 7473 5f70 7265  dex = splits_pre
+00001fa0: 7474 792e 696e 6465 782e 6461 7465 2e61  tty.index.date.a
+00001fb0: 7374 7970 6528 7374 7229 0a20 2020 2020  stype(str).     
+00001fc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00001fd0: 6d61 6e61 6765 722e 4c6f 6745 7665 6e74  manager.LogEvent
+00001fe0: 2822 696e 666f 222c 2022 5370 6c69 744d  ("info", "SplitM
+00001ff0: 616e 6167 6572 222c 2066 227b 7370 6c69  anager", f"{spli
+00002000: 7473 5f70 7265 7474 792e 7368 6170 655b  ts_pretty.shape[
+00002010: 305d 7d20 6e65 7720 7370 6c69 7473 3a20  0]} new splits: 
+00002020: 7b73 706c 6974 735f 7072 6574 7479 2e74  {splits_pretty.t
+00002030: 6f5f 6469 6374 2829 7d22 290a 0a20 2020  o_dict()}")..   
+00002040: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00002050: 7365 6c66 2e73 706c 6974 7320 6973 204e  self.splits is N
+00002060: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00002070: 2020 2020 2020 2020 2073 656c 662e 7370           self.sp
+00002080: 6c69 7473 203d 2073 706c 6974 735f 6466  lits = splits_df
+00002090: 5b63 6f6c 735d 2e63 6f70 7928 290a 2020  [cols].copy().  
+000020a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000020b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000020c0: 2020 2020 2020 2020 7365 6c66 2e73 706c          self.spl
+000020d0: 6974 7320 3d20 7064 2e63 6f6e 6361 7428  its = pd.concat(
+000020e0: 5b73 656c 662e 7370 6c69 7473 2c20 7370  [self.splits, sp
+000020f0: 6c69 7473 5f64 665d 2c20 736f 7274 3d54  lits_df], sort=T
+00002100: 7275 6529 5b63 6f6c 735d 0a20 2020 2020  rue)[cols].     
+00002110: 2020 2020 2020 2020 2020 2079 6663 6d2e             yfcm.
+00002120: 5374 6f72 6543 6163 6865 4461 7475 6d28  StoreCacheDatum(
+00002130: 7365 6c66 2e74 6963 6b65 722c 2022 7370  self.ticker, "sp
+00002140: 6c69 7473 222c 2073 656c 662e 7370 6c69  lits", self.spli
+00002150: 7473 290a 0a20 2020 2020 2020 2079 6663  ts)..        yfc
+00002160: 6c2e 5472 6163 6545 7869 7428 2255 7064  l.TraceExit("Upd
+00002170: 6174 6553 706c 6974 7328 2920 7265 7475  ateSplits() retu
+00002180: 726e 696e 6722 290a 0a20 2020 2064 6566  rning")..    def
+00002190: 2055 7064 6174 6544 6976 6964 656e 6473   UpdateDividends
+000021a0: 2873 656c 662c 2064 6976 735f 6466 293a  (self, divs_df):
+000021b0: 0a20 2020 2020 2020 2064 6562 7567 203d  .        debug =
+000021c0: 2046 616c 7365 0a20 2020 2020 2020 2023   False.        #
+000021d0: 2064 6562 7567 203d 2054 7275 650a 0a20   debug = True.. 
+000021e0: 2020 2020 2020 206e 203d 2064 6976 735f         n = divs_
+000021f0: 6466 2e73 6861 7065 5b30 5d0a 2020 2020  df.shape[0].    
+00002200: 2020 2020 7966 636c 2e54 7261 6365 456e      yfcl.TraceEn
+00002210: 7465 7228 6622 504d 3a20 5570 6461 7465  ter(f"PM: Update
+00002220: 4469 7669 6465 6e64 7328 7b64 6976 735f  Dividends({divs_
+00002230: 6466 2e69 6e64 6578 2e64 6174 657d 2922  df.index.date})"
+00002240: 2920 6966 206e 203c 3d20 3220 656c 7365  ) if n <= 2 else
+00002250: 2079 6663 6c2e 5472 6163 6545 6e74 6572   yfcl.TraceEnter
+00002260: 2866 2250 4d3a 2055 7064 6174 6544 6976  (f"PM: UpdateDiv
+00002270: 6964 656e 6473 286e 3d7b 6e7d 2922 290a  idends(n={n})").
+00002280: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
+00002290: 7065 4368 6563 6b44 6174 6146 7261 6d65  peCheckDataFrame
+000022a0: 2864 6976 735f 6466 2c20 2264 6976 735f  (divs_df, "divs_
+000022b0: 6466 2229 0a20 2020 2020 2020 2064 6976  df").        div
+000022c0: 735f 6466 203d 2064 6976 735f 6466 2e63  s_df = divs_df.c
+000022d0: 6f70 7928 290a 2020 2020 2020 2020 6966  opy().        if
+000022e0: 206e 6f74 2064 6976 735f 6466 2e65 6d70   not divs_df.emp
+000022f0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+00002300: 6578 7065 6374 6564 5f63 6f6c 7320 3d20  expected_cols = 
+00002310: 5b22 4469 7669 6465 6e64 7322 2c20 2246  ["Dividends", "F
+00002320: 6574 6368 4461 7465 222c 2022 436c 6f73  etchDate", "Clos
+00002330: 6520 6461 7920 6265 666f 7265 225d 0a20  e day before"]. 
+00002340: 2020 2020 2020 2020 2020 2023 2065 7870             # exp
+00002350: 6563 7465 645f 636f 6c73 203d 205b 2244  ected_cols = ["D
+00002360: 6976 6964 656e 6473 222c 2022 4665 7463  ividends", "Fetc
+00002370: 6844 6174 6522 2c20 2243 6c6f 7365 2074  hDate", "Close t
+00002380: 6f64 6179 225d 0a20 2020 2020 2020 2020  oday"].         
+00002390: 2020 2066 6f72 2063 2069 6e20 6578 7065     for c in expe
+000023a0: 6374 6564 5f63 6f6c 733a 0a20 2020 2020  cted_cols:.     
+000023b0: 2020 2020 2020 2020 2020 2069 6620 6320             if c 
+000023c0: 6e6f 7420 696e 2064 6976 735f 6466 2e63  not in divs_df.c
+000023d0: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
+000023e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000023f0: 6520 5661 6c75 6545 7272 6f72 2866 2241  e ValueError(f"A
+00002400: 6464 4469 7669 6465 6e64 7328 2920 2764  ddDividends() 'd
+00002410: 6976 735f 6466 2720 6973 206d 6973 7369  ivs_df' is missi
+00002420: 6e67 2063 6f6c 756d 6e3a 2027 7b63 7d27  ng column: '{c}'
+00002430: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
+00002440: 2320 5072 6570 6172 6520 2764 6976 735f  # Prepare 'divs_
+00002450: 6466 2720 666f 7220 6170 7065 6e64 0a20  df' for append. 
+00002460: 2020 2020 2020 2020 2020 2064 6976 735f             divs_
+00002470: 6466 5b22 4261 636b 2041 646a 2e22 5d20  df["Back Adj."] 
+00002480: 3d20 6e70 2e6e 616e 0a20 2020 2020 2020  = np.nan.       
+00002490: 2020 2020 2064 6976 735f 6466 5b22 5375       divs_df["Su
+000024a0: 7065 7273 6564 6564 2064 6976 225d 203d  perseded div"] =
+000024b0: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
+000024c0: 2064 6976 735f 6466 5b22 5375 7065 7273   divs_df["Supers
+000024d0: 6564 6564 2062 6163 6b20 6164 6a2e 225d  eded back adj."]
+000024e0: 203d 2030 2e30 0a20 2020 2020 2020 2020   = 0.0.         
+000024f0: 2020 2064 6976 735f 6466 5b22 5375 7065     divs_df["Supe
+00002500: 7273 6564 6564 2064 6976 2046 6574 6368  rseded div Fetch
+00002510: 4461 7465 225d 203d 2070 642e 4e61 540a  Date"] = pd.NaT.
+00002520: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00002530: 6474 2069 6e20 6469 7673 5f64 662e 696e  dt in divs_df.in
+00002540: 6465 783a 0a20 2020 2020 2020 2020 2020  dex:.           
+00002550: 2020 2020 206e 6577 5f64 6976 203d 2064       new_div = d
+00002560: 6976 735f 6466 2e6c 6f63 5b64 742c 2022  ivs_df.loc[dt, "
+00002570: 4469 7669 6465 6e64 7322 5d0a 2020 2020  Dividends"].    
+00002580: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00002590: 656c 662e 6469 7673 2069 7320 6e6f 7420  elf.divs is not 
+000025a0: 4e6f 6e65 2061 6e64 2064 7420 696e 2073  None and dt in s
+000025b0: 656c 662e 6469 7673 2e69 6e64 6578 3a0a  elf.divs.index:.
+000025c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000025d0: 2020 2020 6361 6368 6564 5f64 6976 203d      cached_div =
+000025e0: 2073 656c 662e 6469 7673 2e6c 6f63 5b64   self.divs.loc[d
+000025f0: 742c 2022 4469 7669 6465 6e64 7322 5d0a  t, "Dividends"].
+00002600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002610: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+00002620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002630: 2020 2020 2020 6d73 6720 3d20 6622 7072        msg = f"pr
+00002640: 652d 6578 6973 7469 6e67 2064 6976 6964  e-existing divid
+00002650: 656e 6420 4020 7b64 747d 3a20 7b63 6163  end @ {dt}: {cac
+00002660: 6865 645f 6469 767d 2076 7320 7b6e 6577  hed_div} vs {new
+00002670: 5f64 6976 7d22 0a20 2020 2020 2020 2020  _div}".         
+00002680: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00002690: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
+000026a0: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
+000026b0: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
+000026c0: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
+000026d0: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
+000026e0: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
+000026f0: 2020 2020 2020 2020 6469 6666 5f70 6374          diff_pct
+00002700: 203d 2031 3030 2a61 6273 2863 6163 6865   = 100*abs(cache
+00002710: 645f 6469 762d 6e65 775f 6469 7629 2f63  d_div-new_div)/c
+00002720: 6163 6865 645f 6469 760a 2020 2020 2020  ached_div.      
+00002730: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00002740: 2064 6966 665f 7063 7420 3c20 302e 3031   diff_pct < 0.01
+00002750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002760: 2020 2020 2020 2020 2020 2320 7469 6e79            # tiny
+00002770: 2064 6966 6665 7265 6e63 652c 2065 6173   difference, eas
+00002780: 6965 7220 746f 206a 7573 7420 6b65 6570  ier to just keep
+00002790: 206f 6c64 2076 616c 7565 0a20 2020 2020   old value.     
+000027a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027b0: 2020 2064 6976 735f 6466 203d 2064 6976     divs_df = div
+000027c0: 735f 6466 2e64 726f 7028 6474 290a 2020  s_df.drop(dt).  
+000027d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000027e0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
+000027f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002800: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00002810: 3d20 2269 676e 6f72 696e 6720 6e65 7720  = "ignoring new 
+00002820: 6469 7622 0a20 2020 2020 2020 2020 2020  div".           
+00002830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002840: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+00002850: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
+00002860: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+00002870: 2065 6c73 6520 7072 696e 7428 6622 7b73   else print(f"{s
+00002880: 656c 662e 7469 636b 6572 7d3a 2022 202b  elf.ticker}: " +
+00002890: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
+000028a0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000028b0: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+000028c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000028d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000028e0: 2020 2020 2020 2020 2064 6976 735f 6466           divs_df
+000028f0: 2e6c 6f63 5b64 742c 2022 5375 7065 7273  .loc[dt, "Supers
+00002900: 6564 6564 2064 6976 225d 203d 2073 656c  eded div"] = sel
+00002910: 662e 6469 7673 2e6c 6f63 5b64 742c 2022  f.divs.loc[dt, "
+00002920: 4469 7669 6465 6e64 7322 5d0a 2020 2020  Dividends"].    
+00002930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002940: 2020 2020 6469 7673 5f64 662e 6c6f 635b      divs_df.loc[
+00002950: 6474 2c20 2253 7570 6572 7365 6465 6420  dt, "Superseded 
+00002960: 6261 636b 2061 646a 2e22 5d20 3d20 7365  back adj."] = se
+00002970: 6c66 2e64 6976 732e 6c6f 635b 6474 2c20  lf.divs.loc[dt, 
+00002980: 2242 6163 6b20 4164 6a2e 225d 0a20 2020  "Back Adj."].   
+00002990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029a0: 2020 2020 2064 6976 735f 6466 2e6c 6f63       divs_df.loc
+000029b0: 5b64 742c 2022 5375 7065 7273 6564 6564  [dt, "Superseded
+000029c0: 2064 6976 2046 6574 6368 4461 7465 225d   div FetchDate"]
+000029d0: 203d 2073 656c 662e 6469 7673 2e6c 6f63   = self.divs.loc
+000029e0: 5b64 742c 2022 4665 7463 6844 6174 6522  [dt, "FetchDate"
+000029f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00002a00: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00002a10: 6976 7320 3d20 7365 6c66 2e64 6976 732e  ivs = self.divs.
+00002a20: 6472 6f70 2864 7429 0a20 2020 2020 2020  drop(dt).       
+00002a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a40: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
+00002a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a60: 2020 2020 2020 206d 7367 203d 2022 7265         msg = "re
+00002a70: 706c 6163 696e 6720 6f6c 6420 6469 7622  placing old div"
+00002a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002a90: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00002aa0: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+00002ab0: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+00002ac0: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+00002ad0: 6520 7072 696e 7428 6622 7b73 656c 662e  e print(f"{self.
+00002ae0: 7469 636b 6572 7d3a 2022 202b 206d 7367  ticker}: " + msg
+00002af0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00002b00: 2020 2063 6c6f 7365 5f62 6566 6f72 6520     close_before 
+00002b10: 3d20 6469 7673 5f64 662e 6c6f 635b 6474  = divs_df.loc[dt
+00002b20: 2c20 2243 6c6f 7365 2064 6179 2062 6566  , "Close day bef
+00002b30: 6f72 6522 5d0a 2020 2020 2020 2020 2020  ore"].          
+00002b40: 2020 2020 2020 2320 6164 6a20 3d20 2863        # adj = (c
+00002b50: 6c6f 7365 5f62 6566 6f72 6520 2d20 6e65  lose_before - ne
+00002b60: 775f 6469 7629 202f 2063 6c6f 7365 5f62  w_div) / close_b
+00002b70: 6566 6f72 650a 2020 2020 2020 2020 2020  efore.          
+00002b80: 2020 2020 2020 6164 6a20 3d20 312e 3020        adj = 1.0 
+00002b90: 2d20 6e65 775f 6469 7620 2f20 636c 6f73  - new_div / clos
+00002ba0: 655f 6265 666f 7265 0a20 2020 2020 2020  e_before.       
+00002bb0: 2020 2020 2020 2020 2023 2023 2046 203d           # # F =
+00002bc0: 2050 322f 2850 322b 4429 0a20 2020 2020   P2/(P2+D).     
+00002bd0: 2020 2020 2020 2020 2020 2023 2023 2068             # # h
+00002be0: 7474 703a 2f2f 6d61 7275 626f 7a75 2e62  ttp://marubozu.b
+00002bf0: 6c6f 6773 706f 742e 636f 6d2f 3230 3036  logspot.com/2006
+00002c00: 2f30 392f 686f 772d 7961 686f 6f2d 6361  /09/how-yahoo-ca
+00002c10: 6c63 756c 6174 6573 2d61 646a 7573 7465  lculates-adjuste
+00002c20: 642d 636c 6f73 696e 672e 6874 6d6c 2363  d-closing.html#c
+00002c30: 3830 3338 3036 3439 3735 3138 3537 3038  8038064975185708
+00002c40: 3835 360a 2020 2020 2020 2020 2020 2020  856.            
+00002c50: 2020 2020 2320 636c 6f73 655f 746f 6461      # close_toda
+00002c60: 7920 3d20 6469 7673 5f64 662e 6c6f 635b  y = divs_df.loc[
+00002c70: 6474 2c20 2243 6c6f 7365 2074 6f64 6179  dt, "Close today
+00002c80: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00002c90: 2020 2023 2061 646a 203d 2063 6c6f 7365     # adj = close
+00002ca0: 5f74 6f64 6179 202f 2028 636c 6f73 655f  _today / (close_
+00002cb0: 746f 6461 7920 2b20 6e65 775f 6469 7629  today + new_div)
+00002cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002cd0: 2069 6620 6e70 2e69 736e 616e 2861 646a   if np.isnan(adj
+00002ce0: 293a 2020 2320 746f 646f 3a20 7265 6d6f  ):  # todo: remo
+00002cf0: 7665 206f 6e63 6520 636f 6e66 6972 6d20  ve once confirm 
+00002d00: 5946 4320 6275 672d 6672 6565 0a20 2020  YFC bug-free.   
+00002d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d20: 2070 7269 6e74 2864 6976 735f 6466 2e6c   print(divs_df.l
+00002d30: 6f63 5b64 745d 290a 2020 2020 2020 2020  oc[dt]).        
+00002d40: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00002d50: 6520 4578 6365 7074 696f 6e28 6622 4261  e Exception(f"Ba
+00002d60: 636b 2041 646a 2e20 6973 204e 614e 2229  ck Adj. is NaN")
+00002d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002d80: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
+00002d90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00002da0: 6574 6368 5f64 7420 3d20 6469 7673 5f64  etch_dt = divs_d
+00002db0: 662e 6c6f 635b 6474 2c20 2246 6574 6368  f.loc[dt, "Fetch
+00002dc0: 4461 7465 225d 0a20 2020 2020 2020 2020  Date"].         
+00002dd0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00002de0: 2066 226e 6577 2064 6976 6964 656e 643a   f"new dividend:
+00002df0: 207b 6e65 775f 6469 767d 2040 207b 6474   {new_div} @ {dt
+00002e00: 2e64 6174 6528 297d 2061 646a 3d7b 6164  .date()} adj={ad
+00002e10: 6a3a 2e35 667d 2063 6c6f 7365 5f62 6566  j:.5f} close_bef
+00002e20: 6f72 653d 7b63 6c6f 7365 5f62 6566 6f72  ore={close_befor
+00002e30: 653a 2e34 667d 2066 6574 6368 3d7b 6665  e:.4f} fetch={fe
+00002e40: 7463 685f 6474 2e73 7472 6674 696d 6528  tch_dt.strftime(
+00002e50: 2725 592d 256d 2d25 6420 2548 3a25 4d3a  '%Y-%m-%d %H:%M:
+00002e60: 2553 257a 2729 7d22 0a20 2020 2020 2020  %S%z')}".       
+00002e70: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00002e80: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+00002e90: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+00002ea0: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+00002eb0: 6520 7072 696e 7428 6622 7b73 656c 662e  e print(f"{self.
+00002ec0: 7469 636b 6572 7d3a 2022 202b 206d 7367  ticker}: " + msg
+00002ed0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00002ee0: 2020 6469 7673 5f64 662e 6c6f 635b 6474    divs_df.loc[dt
+00002ef0: 2c20 2242 6163 6b20 4164 6a2e 225d 203d  , "Back Adj."] =
+00002f00: 2061 646a 0a0a 2020 2020 2020 2020 2020   adj..          
+00002f10: 2020 6469 7673 5f64 6620 3d20 6469 7673    divs_df = divs
+00002f20: 5f64 662e 6472 6f70 2822 436c 6f73 6520  _df.drop("Close 
+00002f30: 6461 7920 6265 666f 7265 222c 2061 7869  day before", axi
+00002f40: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
+00002f50: 2023 2064 6976 735f 6466 203d 2064 6976   # divs_df = div
+00002f60: 735f 6466 2e64 726f 7028 2243 6c6f 7365  s_df.drop("Close
+00002f70: 2074 6f64 6179 222c 2061 7869 733d 3129   today", axis=1)
+00002f80: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+00002f90: 6c73 203d 205b 2244 6976 6964 656e 6473  ls = ["Dividends
+00002fa0: 222c 2022 4261 636b 2041 646a 2e22 2c20  ", "Back Adj.", 
+00002fb0: 2246 6574 6368 4461 7465 222c 2022 5375  "FetchDate", "Su
+00002fc0: 7065 7273 6564 6564 2064 6976 222c 2022  perseded div", "
+00002fd0: 5375 7065 7273 6564 6564 2062 6163 6b20  Superseded back 
+00002fe0: 6164 6a2e 222c 2022 5375 7065 7273 6564  adj.", "Supersed
+00002ff0: 6564 2064 6976 2046 6574 6368 4461 7465  ed div FetchDate
+00003000: 225d 0a20 2020 2020 2020 2020 2020 2069  "].            i
+00003010: 6620 6e6f 7420 6469 7673 5f64 662e 656d  f not divs_df.em
+00003020: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+00003030: 2020 2020 2064 6976 735f 7072 6574 7479       divs_pretty
+00003040: 203d 2064 6976 735f 6466 5b22 4469 7669   = divs_df["Divi
+00003050: 6465 6e64 7322 5d0a 2020 2020 2020 2020  dends"].        
+00003060: 2020 2020 2020 2020 6469 7673 5f70 7265          divs_pre
+00003070: 7474 792e 696e 6465 7820 3d20 6469 7673  tty.index = divs
+00003080: 5f70 7265 7474 792e 696e 6465 782e 6461  _pretty.index.da
+00003090: 7465 2e61 7374 7970 6528 7374 7229 0a20  te.astype(str). 
+000030a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000030b0: 656c 662e 6d61 6e61 6765 722e 4c6f 6745  elf.manager.LogE
+000030c0: 7665 6e74 2822 696e 666f 222c 2022 4469  vent("info", "Di
+000030d0: 7669 6465 6e64 4d61 6e61 6765 7222 2c20  videndManager", 
+000030e0: 6622 7b64 6976 735f 7072 6574 7479 2e73  f"{divs_pretty.s
+000030f0: 6861 7065 5b30 5d7d 206e 6577 2064 6976  hape[0]} new div
+00003100: 6964 656e 6473 3a20 7b64 6976 735f 7072  idends: {divs_pr
+00003110: 6574 7479 2e74 6f5f 6469 6374 2829 7d22  etty.to_dict()}"
+00003120: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00003130: 2020 2069 6620 7365 6c66 2e64 6976 7320     if self.divs 
+00003140: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00003150: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00003160: 662e 6469 7673 203d 2064 6976 735f 6466  f.divs = divs_df
+00003170: 5b63 6f6c 735d 2e63 6f70 7928 290a 2020  [cols].copy().  
+00003180: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00003190: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000031a0: 2020 2020 2020 2020 7365 6c66 2e64 6976          self.div
+000031b0: 7320 3d20 7064 2e63 6f6e 6361 7428 5b73  s = pd.concat([s
+000031c0: 656c 662e 6469 7673 2c20 6469 7673 5f64  elf.divs, divs_d
+000031d0: 665b 636f 6c73 5d5d 2c20 736f 7274 3d54  f[cols]], sort=T
+000031e0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+000031f0: 2020 2020 2079 6663 6d2e 5374 6f72 6543       yfcm.StoreC
+00003200: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
+00003210: 6963 6b65 722c 2022 6469 7669 6465 6e64  icker, "dividend
+00003220: 7322 2c20 7365 6c66 2e64 6976 7329 0a0a  s", self.divs)..
+00003230: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00003240: 6365 4578 6974 2822 5570 6461 7465 4469  ceExit("UpdateDi
+00003250: 7669 6465 6e64 7328 2920 7265 7475 726e  vidends() return
+00003260: 696e 6722 290a 0a0a 636c 6173 7320 5072  ing")...class Pr
+00003270: 6963 6548 6973 746f 7279 3a0a 2020 2020  iceHistory:.    
+00003280: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00003290: 662c 206d 616e 6167 6572 2c20 7469 636b  f, manager, tick
+000032a0: 6572 2c20 6578 6368 616e 6765 2c20 747a  er, exchange, tz
+000032b0: 4e61 6d65 2c20 696e 7465 7276 616c 2c20  Name, interval, 
+000032c0: 7365 7373 696f 6e2c 2070 726f 7879 2c20  session, proxy, 
+000032d0: 7265 7061 6972 3d54 7275 652c 2063 6f6e  repair=True, con
+000032e0: 7469 6775 6f75 733d 4661 6c73 6529 3a0a  tiguous=False):.
+000032f0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00003300: 7461 6e63 6528 696e 7465 7276 616c 2c20  tance(interval, 
+00003310: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+00003320: 2020 6966 2069 6e74 6572 7661 6c20 6e6f    if interval no
+00003330: 7420 696e 2079 6663 642e 696e 7465 7276  t in yfcd.interv
+00003340: 616c 5374 7254 6f45 6e75 6d2e 6b65 7973  alStrToEnum.keys
+00003350: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00003360: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00003370: 696f 6e28 2227 696e 7465 7276 616c 2720  ion("'interval' 
+00003380: 6966 2073 7472 206d 7573 7420 6265 206f  if str must be o
+00003390: 6e65 206f 663a 207b 7d22 2e66 6f72 6d61  ne of: {}".forma
+000033a0: 7428 7966 6364 2e69 6e74 6572 7661 6c53  t(yfcd.intervalS
+000033b0: 7472 546f 456e 756d 2e6b 6579 7328 2929  trToEnum.keys())
+000033c0: 290a 2020 2020 2020 2020 2020 2020 696e  ).            in
+000033d0: 7465 7276 616c 203d 2079 6663 642e 696e  terval = yfcd.in
+000033e0: 7465 7276 616c 5374 7254 6f45 6e75 6d5b  tervalStrToEnum[
+000033f0: 696e 7465 7276 616c 5d0a 2020 2020 2020  interval].      
+00003400: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
+00003410: 5374 7228 7469 636b 6572 2c20 2274 6963  Str(ticker, "tic
+00003420: 6b65 7222 290a 2020 2020 2020 2020 7966  ker").        yf
+00003430: 6375 2e54 7970 6543 6865 636b 5374 7228  cu.TypeCheckStr(
+00003440: 6578 6368 616e 6765 2c20 2265 7863 6861  exchange, "excha
+00003450: 6e67 6522 290a 2020 2020 2020 2020 7966  nge").        yf
+00003460: 6375 2e54 7970 6543 6865 636b 5374 7228  cu.TypeCheckStr(
+00003470: 747a 4e61 6d65 2c20 2274 7a4e 616d 6522  tzName, "tzName"
+00003480: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
+00003490: 7970 6543 6865 636b 426f 6f6c 2872 6570  ypeCheckBool(rep
+000034a0: 6169 722c 2022 7265 7061 6972 2229 0a20  air, "repair"). 
+000034b0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+000034c0: 4368 6563 6b42 6f6f 6c28 636f 6e74 6967  CheckBool(contig
+000034d0: 756f 7573 2c20 2263 6f6e 7469 6775 6f75  uous, "contiguou
+000034e0: 7322 290a 0a20 2020 2020 2020 2073 656c  s")..        sel
+000034f0: 662e 6d61 6e61 6765 7220 3d20 6d61 6e61  f.manager = mana
+00003500: 6765 720a 2020 2020 2020 2020 7365 6c66  ger.        self
+00003510: 2e74 6963 6b65 7220 3d20 7469 636b 6572  .ticker = ticker
+00003520: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
+00003530: 6368 616e 6765 203d 2065 7863 6861 6e67  change = exchang
+00003540: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
+00003550: 7a4e 616d 6520 3d20 747a 4e61 6d65 0a20  zName = tzName. 
+00003560: 2020 2020 2020 2073 656c 662e 696e 7465         self.inte
+00003570: 7276 616c 203d 2069 6e74 6572 7661 6c0a  rval = interval.
+00003580: 2020 2020 2020 2020 7365 6c66 2e73 6573          self.ses
+00003590: 7369 6f6e 203d 2073 6573 7369 6f6e 0a20  sion = session. 
+000035a0: 2020 2020 2020 2073 656c 662e 7072 6f78         self.prox
+000035b0: 7920 3d20 7072 6f78 790a 2020 2020 2020  y = proxy.      
+000035c0: 2020 7365 6c66 2e72 6570 6169 7220 3d20    self.repair = 
+000035d0: 7265 7061 6972 0a20 2020 2020 2020 2073  repair.        s
+000035e0: 656c 662e 636f 6e74 6967 756f 7573 203d  elf.contiguous =
+000035f0: 2063 6f6e 7469 6775 6f75 730a 0a20 2020   contiguous..   
+00003600: 2020 2020 2073 656c 662e 6461 7420 3d20       self.dat = 
+00003610: 7966 2e54 6963 6b65 7228 7365 6c66 2e74  yf.Ticker(self.t
+00003620: 6963 6b65 722c 2073 6573 7369 6f6e 3d73  icker, session=s
+00003630: 656c 662e 7365 7373 696f 6e29 0a20 2020  elf.session).   
+00003640: 2020 2020 2073 656c 662e 747a 203d 205a       self.tz = Z
+00003650: 6f6e 6549 6e66 6f28 7365 6c66 2e74 7a4e  oneInfo(self.tzN
+00003660: 616d 6529 0a0a 2020 2020 2020 2020 7365  ame)..        se
+00003670: 6c66 2e69 7464 203d 2079 6663 642e 696e  lf.itd = yfcd.in
+00003680: 7465 7276 616c 546f 5469 6d65 6465 6c74  tervalToTimedelt
+00003690: 615b 7365 6c66 2e69 6e74 6572 7661 6c5d  a[self.interval]
+000036a0: 0a20 2020 2020 2020 2073 656c 662e 6973  .        self.is
+000036b0: 7472 203d 2079 6663 642e 696e 7465 7276  tr = yfcd.interv
+000036c0: 616c 546f 5374 7269 6e67 5b73 656c 662e  alToString[self.
+000036d0: 696e 7465 7276 616c 5d0a 2020 2020 2020  interval].      
+000036e0: 2020 7365 6c66 2e69 6e74 6572 6461 7920    self.interday 
+000036f0: 3d20 7365 6c66 2e69 6e74 6572 7661 6c20  = self.interval 
+00003700: 696e 205b 7966 6364 2e49 6e74 6572 7661  in [yfcd.Interva
+00003710: 6c2e 4461 7973 312c 2079 6663 642e 496e  l.Days1, yfcd.In
+00003720: 7465 7276 616c 2e57 6565 6b2c 2079 6663  terval.Week, yfc
+00003730: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
+00003740: 7331 2c20 7966 6364 2e49 6e74 6572 7661  s1, yfcd.Interva
+00003750: 6c2e 4d6f 6e74 6873 335d 0a20 2020 2020  l.Months3].     
+00003760: 2020 2073 656c 662e 696e 7472 6164 6179     self.intraday
+00003770: 203d 206e 6f74 2073 656c 662e 696e 7465   = not self.inte
+00003780: 7264 6179 0a0a 2020 2020 2020 2020 2320  rday..        # 
+00003790: 4c6f 6164 2066 726f 6d20 6361 6368 650a  Load from cache.
+000037a0: 2020 2020 2020 2020 7365 6c66 2e63 6163          self.cac
+000037b0: 6865 5f6b 6579 203d 2022 6869 7374 6f72  he_key = "histor
+000037c0: 792d 222b 7365 6c66 2e69 7374 720a 2020  y-"+self.istr.  
+000037d0: 2020 2020 2020 7365 6c66 2e68 203d 2073        self.h = s
+000037e0: 656c 662e 5f67 6574 4361 6368 6564 5072  elf._getCachedPr
+000037f0: 6963 6573 2829 0a20 2020 2020 2020 2073  ices().        s
+00003800: 656c 662e 5f72 6576 6965 774e 6577 4469  elf._reviewNewDi
+00003810: 7673 2829 0a0a 2020 2020 2020 2020 2320  vs()..        # 
+00003820: 4120 706c 6163 6520 746f 2074 656d 706f  A place to tempo
+00003830: 7261 7269 6c79 2073 746f 7265 206e 6577  rarily store new
+00003840: 2064 6976 6964 656e 6473 2c20 756e 7469   dividends, unti
+00003850: 6c20 7072 6963 6573 2068 6176 650a 2020  l prices have.  
+00003860: 2020 2020 2020 2320 6265 656e 2072 6570        # been rep
+00003870: 6169 7265 642c 2074 6865 6e20 7468 6579  aired, then they
+00003880: 2063 616e 2062 6520 7365 6e74 2074 6f20   can be sent to 
+00003890: 4576 656e 7473 4869 7374 6f72 790a 0a20  EventsHistory.. 
+000038a0: 2020 2020 2020 2073 656c 662e 5f64 6562         self._deb
+000038b0: 7567 203d 2046 616c 7365 0a20 2020 2020  ug = False.     
+000038c0: 2020 2023 2073 656c 662e 5f64 6562 7567     # self._debug
+000038d0: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
+000038e0: 2023 204d 616e 6167 6520 706f 7465 6e74   # Manage potent
+000038f0: 6961 6c20 666f 7220 696e 6669 6e69 7465  ial for infinite
+00003900: 2072 6563 7572 7369 6f6e 2064 7572 696e   recursion durin
+00003910: 6720 7072 6963 6520 7265 7061 6972 3a0a  g price repair:.
+00003920: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+00003930: 636f 7264 5f73 7461 636b 5f74 7261 6365  cord_stack_trace
+00003940: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00003950: 2320 7365 6c66 2e5f 7265 636f 7264 5f73  # self._record_s
+00003960: 7461 636b 5f74 7261 6365 203d 2046 616c  tack_trace = Fal
+00003970: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
+00003980: 5f73 7461 636b 5f74 7261 6365 203d 205b  _stack_trace = [
+00003990: 5d0a 2020 2020 2020 2020 7365 6c66 2e5f  ].        self._
+000039a0: 696e 6669 6e69 7465 5f72 6563 7572 7369  infinite_recursi
+000039b0: 6f6e 5f64 6574 6563 7465 6420 3d20 4661  on_detected = Fa
+000039c0: 6c73 650a 0a20 2020 2064 6566 205f 6765  lse..    def _ge
+000039d0: 7443 6163 6865 6450 7269 6365 7328 7365  tCachedPrices(se
+000039e0: 6c66 293a 0a20 2020 2020 2020 2068 203d  lf):.        h =
+000039f0: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+00003a00: 2079 6663 6d2e 4973 4461 7475 6d43 6163   yfcm.IsDatumCac
+00003a10: 6865 6428 7365 6c66 2e74 6963 6b65 722c  hed(self.ticker,
+00003a20: 2073 656c 662e 6361 6368 655f 6b65 7929   self.cache_key)
+00003a30: 3a0a 2020 2020 2020 2020 2020 2020 6820  :.            h 
+00003a40: 3d20 7966 636d 2e52 6561 6443 6163 6865  = yfcm.ReadCache
+00003a50: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
+00003a60: 722c 2073 656c 662e 6361 6368 655f 6b65  r, self.cache_ke
+00003a70: 7929 0a0a 2020 2020 2020 2020 6966 2068  y)..        if h
+00003a80: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00003a90: 2068 2e65 6d70 7479 3a0a 2020 2020 2020   h.empty:.      
+00003aa0: 2020 2020 2020 6820 3d20 4e6f 6e65 0a20        h = None. 
+00003ab0: 2020 2020 2020 2065 6c69 6620 6820 6973         elif h is
+00003ac0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00003ad0: 2020 2020 2020 2068 5f6d 6f64 6966 6965         h_modifie
+00003ae0: 6420 3d20 4661 6c73 650a 0a20 2020 2020  d = False..     
+00003af0: 2020 2020 2020 2069 6620 2241 646a 2043         if "Adj C
+00003b00: 6c6f 7365 2220 696e 2068 2e63 6f6c 756d  lose" in h.colum
+00003b10: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00003b20: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00003b30: 696f 6e28 2241 646a 2043 6c6f 7365 2069  ion("Adj Close i
+00003b40: 6e20 6361 6368 6564 2068 2229 0a0a 2020  n cached h")..  
+00003b50: 2020 2020 2020 2020 2020 665f 6475 7073            f_dups
+00003b60: 203d 2068 2e69 6e64 6578 2e64 7570 6c69   = h.index.dupli
+00003b70: 6361 7465 6428 290a 2020 2020 2020 2020  cated().        
+00003b80: 2020 2020 6966 2066 5f64 7570 732e 616e      if f_dups.an
+00003b90: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+00003ba0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
+00003bb0: 7469 6f6e 2822 7b7d 3a20 5468 6573 6520  tion("{}: These 
+00003bc0: 7469 6d65 706f 696e 7473 2068 6176 6520  timepoints have 
+00003bd0: 6265 656e 2064 7570 6c69 6361 7465 643a  been duplicated:
+00003be0: 207b 7d22 2e66 6f72 6d61 7428 7365 6c66   {}".format(self
+00003bf0: 2e74 6963 6b65 722c 2068 2e69 6e64 6578  .ticker, h.index
+00003c00: 5b66 5f64 7570 735d 2929 0a0a 2020 2020  [f_dups]))..    
+00003c10: 2020 2020 2020 2020 665f 6e61 203d 206e          f_na = n
+00003c20: 702e 6973 6e61 6e28 685b 2243 4446 225d  p.isnan(h["CDF"]
+00003c30: 2e74 6f5f 6e75 6d70 7928 2929 0a20 2020  .to_numpy()).   
+00003c40: 2020 2020 2020 2020 2069 6620 665f 6e61           if f_na
+00003c50: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+00003c60: 2020 2020 2020 2020 685b 2243 4446 225d          h["CDF"]
+00003c70: 203d 2068 5b22 4344 4622 5d2e 6669 6c6c   = h["CDF"].fill
+00003c80: 6e61 286d 6574 686f 643d 2262 6669 6c6c  na(method="bfill
+00003c90: 2229 2e66 696c 6c6e 6128 6d65 7468 6f64  ").fillna(method
+00003ca0: 3d22 6666 696c 6c22 290a 2020 2020 2020  ="ffill").      
+00003cb0: 2020 2020 2020 2020 2020 665f 6e61 203d            f_na =
+00003cc0: 2068 5b22 4344 4622 5d2e 6973 6e61 2829   h["CDF"].isna()
+00003cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ce0: 2069 6620 665f 6e61 2e61 6e79 2829 3a0a   if f_na.any():.
+00003cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d00: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00003d10: 696f 6e28 2243 4446 204e 614e 2072 6570  ion("CDF NaN rep
+00003d20: 6169 7220 6661 696c 6564 2229 0a20 2020  air failed").   
+00003d30: 2020 2020 2020 2020 2020 2020 2068 5f6d               h_m
+00003d40: 6f64 6966 6965 6420 3d20 5472 7565 0a0a  odified = True..
+00003d50: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+00003d60: 5f6d 6f64 6966 6965 643a 0a20 2020 2020  _modified:.     
+00003d70: 2020 2020 2020 2020 2020 2079 6663 6d2e             yfcm.
+00003d80: 5374 6f72 6543 6163 6865 4461 7475 6d28  StoreCacheDatum(
+00003d90: 7365 6c66 2e74 6963 6b65 722c 2073 656c  self.ticker, sel
+00003da0: 662e 6361 6368 655f 6b65 792c 2068 290a  f.cache_key, h).
+00003db0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00003dc0: 680a 0a20 2020 2064 6566 205f 7570 6461  h..    def _upda
+00003dd0: 7465 6443 6163 6865 6450 7269 6365 7328  tedCachedPrices(
+00003de0: 7365 6c66 2c20 6466 293a 0a20 2020 2020  self, df):.     
+00003df0: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+00003e00: 6b44 6174 6146 7261 6d65 2864 662c 2022  kDataFrame(df, "
+00003e10: 6466 2229 0a0a 2020 2020 2020 2020 6578  df")..        ex
+00003e20: 7065 6374 6564 5f63 6f6c 7320 3d20 5b22  pected_cols = ["
+00003e30: 4f70 656e 222c 2022 4869 6768 222c 2022  Open", "High", "
+00003e40: 4c6f 7722 2c20 2243 6c6f 7365 222c 2022  Low", "Close", "
+00003e50: 566f 6c75 6d65 222c 2022 4469 7669 6465  Volume", "Divide
+00003e60: 6e64 7322 2c20 2253 746f 636b 2053 706c  nds", "Stock Spl
+00003e70: 6974 7322 5d0a 2020 2020 2020 2020 6578  its"].        ex
+00003e80: 7065 6374 6564 5f63 6f6c 7320 2b3d 205b  pected_cols += [
+00003e90: 2246 696e 616c 3f22 2c20 2243 2d43 6865  "Final?", "C-Che
+00003ea0: 636b 3f22 2c20 2246 6574 6368 4461 7465  ck?", "FetchDate
+00003eb0: 222c 2022 4353 4622 2c20 2243 4446 225d  ", "CSF", "CDF"]
+00003ec0: 0a20 2020 2020 2020 2065 7870 6563 7465  .        expecte
+00003ed0: 645f 636f 6c73 202b 3d20 5b22 4c61 7374  d_cols += ["Last
+00003ee0: 4469 7641 646a 7573 7444 7422 2c20 224c  DivAdjustDt", "L
+00003ef0: 6173 7453 706c 6974 4164 6a75 7374 4474  astSplitAdjustDt
+00003f00: 225d 0a0a 2020 2020 2020 2020 6d69 7373  "]..        miss
+00003f10: 696e 675f 636f 6c73 203d 205b 6320 666f  ing_cols = [c fo
+00003f20: 7220 6320 696e 2065 7870 6563 7465 645f  r c in expected_
+00003f30: 636f 6c73 2069 6620 6320 6e6f 7420 696e  cols if c not in
+00003f40: 2064 662e 636f 6c75 6d6e 735d 0a20 2020   df.columns].   
+00003f50: 2020 2020 2069 6620 6c65 6e28 6d69 7373       if len(miss
+00003f60: 696e 675f 636f 6c73 2920 3e20 303a 0a20  ing_cols) > 0:. 
+00003f70: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00003f80: 2045 7863 6570 7469 6f6e 2866 2244 4620   Exception(f"DF 
+00003f90: 6d69 7373 696e 6720 7468 6573 6520 636f  missing these co
+00003fa0: 6c75 6d6e 733a 207b 6d69 7373 696e 675f  lumns: {missing_
+00003fb0: 636f 6c73 7d22 290a 0a20 2020 2020 2020  cols}")..       
+00003fc0: 2079 6663 6d2e 5374 6f72 6543 6163 6865   yfcm.StoreCache
+00003fd0: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
+00003fe0: 722c 2073 656c 662e 6361 6368 655f 6b65  r, self.cache_ke
+00003ff0: 792c 2064 6629 0a0a 2020 2020 2020 2020  y, df)..        
+00004000: 7365 6c66 2e68 203d 2064 660a 0a20 2020  self.h = df..   
+00004010: 2064 6566 205f 7265 7669 6577 4e65 7744   def _reviewNewD
+00004020: 6976 7328 7365 6c66 293a 0a20 2020 2020  ivs(self):.     
+00004030: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
+00004040: 7661 6c20 213d 2079 6663 642e 496e 7465  val != yfcd.Inte
+00004050: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
+00004060: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00004070: 2020 2020 2020 2020 6361 6368 6564 5f6e          cached_n
+00004080: 6577 5f64 6976 7320 3d20 7966 636d 2e52  ew_divs = yfcm.R
+00004090: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
+000040a0: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
+000040b0: 6469 7673 2229 0a20 2020 2020 2020 2069  divs").        i
+000040c0: 6620 6361 6368 6564 5f6e 6577 5f64 6976  f cached_new_div
+000040d0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+000040e0: 2020 2020 2020 2020 2020 2069 6620 7966             if yf
+000040f0: 636d 2e52 6561 6443 6163 6865 4d65 7461  cm.ReadCacheMeta
+00004100: 6461 7461 2873 656c 662e 7469 636b 6572  data(self.ticker
+00004110: 2c20 226e 6577 5f64 6976 7322 2c20 226c  , "new_divs", "l
+00004120: 6f63 6b65 6422 2920 6973 206e 6f74 204e  ocked") is not N
+00004130: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00004140: 2020 2020 2023 2054 6869 7320 6973 2062       # This is b
+00004150: 6164 2c20 6d65 616e 7320 5946 4320 7761  ad, means YFC wa
+00004160: 7320 6b69 6c6c 6564 2062 6566 6f72 6520  s killed before 
+00004170: 276e 6577 5f64 6976 7327 2063 6f75 6c64  'new_divs' could
+00004180: 2062 6520 7072 6f63 6573 7365 642e 0a20   be processed.. 
+00004190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000041a0: 204d 6561 6e73 2070 6f74 656e 7469 616c   Means potential
+000041b0: 6c79 2066 7574 7572 6520 6e65 7720 6469  ly future new di
+000041c0: 7669 6465 6e64 7320 6861 7665 206e 6f74  vidends have not
+000041d0: 2062 6565 6e20 7072 6f63 6573 7365 640a   been processed.
+000041e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041f0: 685f 6469 7673 203d 2073 656c 662e 682e  h_divs = self.h.
+00004200: 6c6f 635b 7365 6c66 2e68 5b22 4469 7669  loc[self.h["Divi
+00004210: 6465 6e64 7322 5d21 3d30 2c20 5b22 4469  dends"]!=0, ["Di
+00004220: 7669 6465 6e64 7322 2c20 2246 6574 6368  vidends", "Fetch
+00004230: 4461 7465 225d 5d0a 2020 2020 2020 2020  Date"]].        
+00004240: 2020 2020 2020 2020 685f 6469 7673 5f73          h_divs_s
+00004250: 696e 6365 203d 2068 5f64 6976 735b 685f  ince = h_divs[h_
+00004260: 6469 7673 2e69 6e64 6578 203e 2063 6163  divs.index > cac
+00004270: 6865 645f 6e65 775f 6469 7673 2e69 6e64  hed_new_divs.ind
+00004280: 6578 2e6d 6178 2829 5d0a 2020 2020 2020  ex.max()].      
+00004290: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000042a0: 2068 5f64 6976 735f 7369 6e63 652e 656d   h_divs_since.em
+000042b0: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+000042c0: 2020 2020 2020 2020 2063 6163 6865 645f           cached_
+000042d0: 6e65 775f 6469 7673 203d 2070 642e 636f  new_divs = pd.co
+000042e0: 6e63 6174 285b 6361 6368 6564 5f6e 6577  ncat([cached_new
+000042f0: 5f64 6976 732c 2068 5f64 6976 735f 7369  _divs, h_divs_si
+00004300: 6e63 655d 290a 2020 2020 2020 2020 2020  nce]).          
+00004310: 2020 2020 2020 2020 2020 7966 636d 2e53            yfcm.S
+00004320: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
+00004330: 656c 662e 7469 636b 6572 2c20 226e 6577  elf.ticker, "new
+00004340: 5f64 6976 7322 2c20 6361 6368 6564 5f6e  _divs", cached_n
+00004350: 6577 5f64 6976 7329 0a20 2020 2020 2020  ew_divs).       
+00004360: 2020 2020 2020 2020 2079 6663 6d2e 5772           yfcm.Wr
+00004370: 6974 6543 6163 6865 4d65 7461 6461 7461  iteCacheMetadata
+00004380: 2873 656c 662e 7469 636b 6572 2c20 226e  (self.ticker, "n
+00004390: 6577 5f64 6976 7322 2c20 226c 6f63 6b65  ew_divs", "locke
+000043a0: 6422 2c20 4e6f 6e65 290a 0a20 2020 2064  d", None)..    d
+000043b0: 6566 2067 6574 2873 656c 662c 2073 7461  ef get(self, sta
+000043c0: 7274 3d4e 6f6e 652c 2065 6e64 3d4e 6f6e  rt=None, end=Non
+000043d0: 652c 2070 6572 696f 643d 4e6f 6e65 2c20  e, period=None, 
+000043e0: 6d61 785f 6167 653d 4e6f 6e65 2c20 7472  max_age=None, tr
+000043f0: 6967 6765 725f 6174 5f6d 6172 6b65 745f  igger_at_market_
+00004400: 636c 6f73 653d 4661 6c73 652c 2072 6570  close=False, rep
+00004410: 6169 723d 5472 7565 2c20 7072 6570 6f73  air=True, prepos
+00004420: 743d 4661 6c73 652c 2061 646a 7573 745f  t=False, adjust_
+00004430: 7370 6c69 7473 3d46 616c 7365 2c20 6164  splits=False, ad
+00004440: 6a75 7374 5f64 6976 733d 4661 6c73 652c  just_divs=False,
+00004450: 2071 7569 6574 3d46 616c 7365 293a 0a20   quiet=False):. 
+00004460: 2020 2020 2020 2069 6620 7374 6172 7420         if start 
+00004470: 6973 204e 6f6e 6520 616e 6420 656e 6420  is None and end 
+00004480: 6973 204e 6f6e 6520 616e 6420 7065 7269  is None and peri
+00004490: 6f64 2069 7320 4e6f 6e65 3a0a 2020 2020  od is None:.    
+000044a0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+000044b0: 6c75 6545 7272 6f72 2822 4d75 7374 2070  lueError("Must p
+000044c0: 726f 7669 6465 2076 616c 7565 2066 6f72  rovide value for
+000044d0: 206f 6e65 206f 663a 2027 7374 6172 7427   one of: 'start'
+000044e0: 2c20 2765 6e64 272c 2027 7065 7269 6f64  , 'end', 'period
+000044f0: 2722 290a 2020 2020 2020 2020 6966 2073  '").        if s
+00004500: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
+00004510: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
+00004520: 6375 2e54 7970 6543 6865 636b 496e 7465  cu.TypeCheckInte
+00004530: 7276 616c 4474 2873 7461 7274 2c20 7365  rvalDt(start, se
+00004540: 6c66 2e69 6e74 6572 7661 6c2c 2022 7374  lf.interval, "st
+00004550: 6172 7422 2c20 7374 7269 6374 3d46 616c  art", strict=Fal
+00004560: 7365 290a 2020 2020 2020 2020 6966 2065  se).        if e
+00004570: 6e64 2069 7320 6e6f 7420 4e6f 6e65 3a0a  nd is not None:.
+00004580: 2020 2020 2020 2020 2020 2020 7966 6375              yfcu
+00004590: 2e54 7970 6543 6865 636b 496e 7465 7276  .TypeCheckInterv
+000045a0: 616c 4474 2865 6e64 2c20 7365 6c66 2e69  alDt(end, self.i
+000045b0: 6e74 6572 7661 6c2c 2022 656e 6422 2c20  nterval, "end", 
+000045c0: 7374 7269 6374 3d46 616c 7365 290a 2020  strict=False).  
+000045d0: 2020 2020 2020 6966 2070 6572 696f 6420        if period 
+000045e0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000045f0: 2020 2020 2020 2020 2079 6663 752e 5479           yfcu.Ty
+00004600: 7065 4368 6563 6b50 6572 696f 6428 7065  peCheckPeriod(pe
+00004610: 7269 6f64 2c20 2270 6572 696f 6422 290a  riod, "period").
+00004620: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
+00004630: 6543 6865 636b 426f 6f6c 2874 7269 6767  eCheckBool(trigg
+00004640: 6572 5f61 745f 6d61 726b 6574 5f63 6c6f  er_at_market_clo
+00004650: 7365 2c20 2274 7269 6767 6572 5f61 745f  se, "trigger_at_
+00004660: 6d61 726b 6574 5f63 6c6f 7365 2229 0a20  market_close"). 
+00004670: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+00004680: 4368 6563 6b42 6f6f 6c28 7265 7061 6972  CheckBool(repair
+00004690: 2c20 2272 6570 6169 7222 290a 2020 2020  , "repair").    
+000046a0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
+000046b0: 636b 426f 6f6c 2861 646a 7573 745f 7370  ckBool(adjust_sp
+000046c0: 6c69 7473 2c20 2261 646a 7573 745f 7370  lits, "adjust_sp
+000046d0: 6c69 7473 2229 0a20 2020 2020 2020 2079  lits").        y
+000046e0: 6663 752e 5479 7065 4368 6563 6b42 6f6f  fcu.TypeCheckBoo
+000046f0: 6c28 6164 6a75 7374 5f64 6976 732c 2022  l(adjust_divs, "
+00004700: 6164 6a75 7374 5f64 6976 7322 290a 0a20  adjust_divs").. 
+00004710: 2020 2020 2020 2023 2054 4f44 4f3a 2065         # TODO: e
+00004720: 6e66 6f72 6365 2027 6d61 785f 6167 6527  nforce 'max_age'
+00004730: 2076 616c 7565 2070 726f 7669 6465 642e   value provided.
+00004740: 204f 6e6c 7920 274e 6f6e 6527 2077 6869   Only 'None' whi
+00004750: 6c65 2049 2064 6576 0a20 2020 2020 2020  le I dev.       
+00004760: 2069 6620 6d61 785f 6167 6520 6973 204e   if max_age is N
+00004770: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00004780: 2069 6620 7365 6c66 2e69 6e74 6572 7661   if self.interva
+00004790: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
+000047a0: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
+000047b0: 2020 2020 2020 2020 2020 6d61 785f 6167            max_ag
+000047c0: 6520 3d20 7469 6d65 6465 6c74 6128 686f  e = timedelta(ho
+000047d0: 7572 733d 3429 0a20 2020 2020 2020 2020  urs=4).         
+000047e0: 2020 2065 6c69 6620 7365 6c66 2e69 6e74     elif self.int
+000047f0: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
+00004800: 7465 7276 616c 2e57 6565 6b3a 0a20 2020  terval.Week:.   
+00004810: 2020 2020 2020 2020 2020 2020 206d 6178               max
+00004820: 5f61 6765 203d 2074 696d 6564 656c 7461  _age = timedelta
+00004830: 2868 6f75 7273 3d36 3029 0a20 2020 2020  (hours=60).     
+00004840: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00004850: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+00004860: 642e 496e 7465 7276 616c 2e4d 6f6e 7468  d.Interval.Month
+00004870: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
+00004880: 2020 2020 6d61 785f 6167 6520 3d20 7469      max_age = ti
+00004890: 6d65 6465 6c74 6128 6461 7973 3d31 3529  medelta(days=15)
+000048a0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000048b0: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+000048c0: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+000048d0: 2e4d 6f6e 7468 7333 3a0a 2020 2020 2020  .Months3:.      
+000048e0: 2020 2020 2020 2020 2020 6d61 785f 6167            max_ag
+000048f0: 6520 3d20 7469 6d65 6465 6c74 6128 6461  e = timedelta(da
+00004900: 7973 3d34 3529 0a20 2020 2020 2020 2020  ys=45).         
+00004910: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00004920: 2020 2020 2020 2020 206d 6178 5f61 6765           max_age
+00004930: 203d 2030 2e35 2a79 6663 642e 696e 7465   = 0.5*yfcd.inte
+00004940: 7276 616c 546f 5469 6d65 6465 6c74 615b  rvalToTimedelta[
+00004950: 7365 6c66 2e69 6e74 6572 7661 6c5d 0a0a  self.interval]..
+00004960: 2020 2020 2020 2020 2320 5946 4320 6361          # YFC ca
+00004970: 6e6e 6f74 2068 616e 646c 6520 7072 652d  nnot handle pre-
+00004980: 2061 6e64 2070 6f73 742d 6d61 726b 6574   and post-market
+00004990: 2069 6e74 7261 6461 790a 2020 2020 2020   intraday.      
+000049a0: 2020 7072 6570 6f73 7420 3d20 7365 6c66    prepost = self
+000049b0: 2e69 6e74 6572 6461 790a 0a20 2020 2020  .interday..     
+000049c0: 2020 2079 6663 742e 5365 7445 7863 6861     yfct.SetExcha
+000049d0: 6e67 6554 7a4e 616d 6528 7365 6c66 2e65  ngeTzName(self.e
+000049e0: 7863 6861 6e67 652c 2073 656c 662e 747a  xchange, self.tz
+000049f0: 4e61 6d65 290a 2020 2020 2020 2020 7464  Name).        td
+00004a00: 5f31 6420 3d20 7469 6d65 6465 6c74 6128  _1d = timedelta(
+00004a10: 6461 7973 3d31 290a 2020 2020 2020 2020  days=1).        
+00004a20: 747a 5f65 7863 6861 6e67 6520 3d20 5a6f  tz_exchange = Zo
+00004a30: 6e65 496e 666f 2873 656c 662e 747a 4e61  neInfo(self.tzNa
+00004a40: 6d65 290a 2020 2020 2020 2020 6474 5f6e  me).        dt_n
+00004a50: 6f77 203d 2070 642e 5469 6d65 7374 616d  ow = pd.Timestam
+00004a60: 702e 7574 636e 6f77 2829 2e74 7a5f 636f  p.utcnow().tz_co
+00004a70: 6e76 6572 7428 747a 5f65 7863 6861 6e67  nvert(tz_exchang
+00004a80: 6529 0a20 2020 2020 2020 2064 5f6e 6f77  e).        d_now
+00004a90: 5f65 7863 6861 6e67 6520 3d20 6474 5f6e  _exchange = dt_n
+00004aa0: 6f77 2e64 6174 6528 290a 2020 2020 2020  ow.date().      
+00004ab0: 2020 746f 6d6f 7272 6f77 5f64 203d 2064    tomorrow_d = d
+00004ac0: 5f6e 6f77 5f65 7863 6861 6e67 6520 2b20  _now_exchange + 
+00004ad0: 7464 5f31 640a 2020 2020 2020 2020 6966  td_1d.        if
+00004ae0: 2073 656c 662e 696e 7465 7264 6179 3a0a   self.interday:.
+00004af0: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
+00004b00: 7272 6f77 203d 2074 6f6d 6f72 726f 775f  rrow = tomorrow_
+00004b10: 640a 2020 2020 2020 2020 656c 7365 3a0a  d.        else:.
+00004b20: 2020 2020 2020 2020 2020 2020 746f 6d6f              tomo
+00004b30: 7272 6f77 203d 2064 6174 6574 696d 652e  rrow = datetime.
+00004b40: 636f 6d62 696e 6528 746f 6d6f 7272 6f77  combine(tomorrow
+00004b50: 5f64 2c20 7469 6d65 2830 292c 2074 7a5f  _d, time(0), tz_
+00004b60: 6578 6368 616e 6765 290a 2020 2020 2020  exchange).      
+00004b70: 2020 6966 2073 7461 7274 2069 7320 6e6f    if start is no
+00004b80: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00004b90: 2020 2020 6966 2065 6e64 2069 7320 6e6f      if end is no
+00004ba0: 7420 4e6f 6e65 2061 6e64 2073 7461 7274  t None and start
+00004bb0: 203e 3d20 656e 643a 0a20 2020 2020 2020   >= end:.       
+00004bc0: 2020 2020 2020 2020 2023 2072 6169 7365           # raise
+00004bd0: 2056 616c 7565 4572 726f 7228 6622 7374   ValueError(f"st
+00004be0: 6172 743d 7b73 7461 7274 7d20 6d75 7374  art={start} must
+00004bf0: 203c 2065 6e64 3d7b 656e 647d 2229 0a20   < end={end}"). 
+00004c00: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00004c10: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+00004c20: 2020 2020 2020 2023 2069 6620 2873 656c         # if (sel
+00004c30: 662e 696e 7465 7264 6179 2061 6e64 2073  f.interday and s
+00004c40: 7461 7274 203e 3d20 746f 6d6f 7272 6f77  tart >= tomorrow
+00004c50: 2920 6f72 2028 6e6f 7420 7365 6c66 2e69  ) or (not self.i
+00004c60: 6e74 6572 6461 7920 616e 6420 7374 6172  nterday and star
+00004c70: 7420 3e20 6474 5f6e 6f77 293a 0a20 2020  t > dt_now):.   
+00004c80: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00004c90: 7374 616e 6365 2873 7461 7274 2c20 6461  stance(start, da
+00004ca0: 7465 7469 6d65 293a 0a20 2020 2020 2020  tetime):.       
+00004cb0: 2020 2020 2020 2020 2069 6620 7374 6172           if star
+00004cc0: 7420 3e20 6474 5f6e 6f77 3a0a 2020 2020  t > dt_now:.    
+00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ce0: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+00004cf0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00004d00: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00004d10: 2073 7461 7274 203e 3d20 746f 6d6f 7272   start >= tomorr
+00004d20: 6f77 5f64 3a0a 2020 2020 2020 2020 2020  ow_d:.          
+00004d30: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00004d40: 204e 6f6e 650a 0a20 2020 2020 2020 2064   None..        d
+00004d50: 6562 7567 5f79 6620 3d20 4661 6c73 650a  ebug_yf = False.
+00004d60: 2020 2020 2020 2020 6465 6275 675f 7966          debug_yf
+00004d70: 6320 3d20 7365 6c66 2e5f 6465 6275 670a  c = self._debug.
+00004d80: 2020 2020 2020 2020 2320 6465 6275 675f          # debug_
+00004d90: 7966 6320 3d20 5472 7565 0a0a 2020 2020  yfc = True..    
+00004da0: 2020 2020 6966 2070 6572 696f 6420 6973      if period is
+00004db0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00004dc0: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
+00004dd0: 2066 2250 7269 6365 4869 7374 6f72 792d   f"PriceHistory-
+00004de0: 7b73 656c 662e 6973 7472 7d2e 6765 7428  {self.istr}.get(
+00004df0: 746b 723d 7b73 656c 662e 7469 636b 6572  tkr={self.ticker
+00004e00: 7d2c 2070 6572 696f 643d 7b70 6572 696f  }, period={perio
+00004e10: 647d 2c20 6d61 785f 6167 653d 7b6d 6178  d}, max_age={max
+00004e20: 5f61 6765 7d2c 2074 7269 6767 6572 5f61  _age}, trigger_a
+00004e30: 745f 6d61 726b 6574 5f63 6c6f 7365 3d7b  t_market_close={
+00004e40: 7472 6967 6765 725f 6174 5f6d 6172 6b65  trigger_at_marke
+00004e50: 745f 636c 6f73 657d 2c20 7072 6570 6f73  t_close}, prepos
+00004e60: 743d 7b70 7265 706f 7374 7d2c 2072 6570  t={prepost}, rep
+00004e70: 6169 723d 7b72 6570 6169 727d 2922 0a20  air={repair})". 
+00004e80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00004e90: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+00004ea0: 203d 2066 2250 7269 6365 4869 7374 6f72   = f"PriceHistor
+00004eb0: 792d 7b73 656c 662e 6973 7472 7d2e 6765  y-{self.istr}.ge
+00004ec0: 7428 746b 723d 7b73 656c 662e 7469 636b  t(tkr={self.tick
+00004ed0: 6572 7d2c 2073 7461 7274 3d7b 7374 6172  er}, start={star
+00004ee0: 747d 2c20 656e 643d 7b65 6e64 7d2c 206d  t}, end={end}, m
+00004ef0: 6178 5f61 6765 3d7b 6d61 785f 6167 657d  ax_age={max_age}
+00004f00: 2c20 7472 6967 6765 725f 6174 5f6d 6172  , trigger_at_mar
+00004f10: 6b65 745f 636c 6f73 653d 7b74 7269 6767  ket_close={trigg
+00004f20: 6572 5f61 745f 6d61 726b 6574 5f63 6c6f  er_at_market_clo
+00004f30: 7365 7d2c 2070 7265 706f 7374 3d7b 7072  se}, prepost={pr
+00004f40: 6570 6f73 747d 2c20 7265 7061 6972 3d7b  epost}, repair={
+00004f50: 7265 7061 6972 7d29 220a 2020 2020 2020  repair})".      
+00004f60: 2020 6966 2079 6663 6c2e 4973 5472 6163    if yfcl.IsTrac
+00004f70: 696e 6745 6e61 626c 6564 2829 3a0a 2020  ingEnabled():.  
+00004f80: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00004f90: 7261 6365 456e 7465 7228 6c6f 675f 6d73  raceEnter(log_ms
+00004fa0: 6729 0a20 2020 2020 2020 2065 6c69 6620  g).        elif 
+00004fb0: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
+00004fc0: 2020 2020 2020 2070 7269 6e74 286c 6f67         print(log
+00004fd0: 5f6d 7367 290a 0a20 2020 2020 2020 2073  _msg)..        s
+00004fe0: 656c 662e 5f61 7070 6c79 4e65 7745 7665  elf._applyNewEve
+00004ff0: 6e74 7328 290a 0a20 2020 2020 2020 2074  nts()..        t
+00005000: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00005010: 7966 5f6c 6167 203d 2079 6663 642e 6578  yf_lag = yfcd.ex
+00005020: 6368 616e 6765 546f 5966 4c61 675b 7365  changeToYfLag[se
+00005030: 6c66 2e65 7863 6861 6e67 655d 0a20 2020  lf.exchange].   
+00005040: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00005050: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+00005060: 222d 2074 6963 6b65 7220 3d20 7b73 656c  "- ticker = {sel
+00005070: 662e 7469 636b 6572 7d22 290a 2020 2020  f.ticker}").    
+00005080: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
+00005090: 2020 2020 2020 2070 7374 7220 3d20 4e6f         pstr = No
+000050a0: 6e65 0a20 2020 2020 2020 2065 6e64 5f64  ne.        end_d
+000050b0: 203d 204e 6f6e 6520 3b20 656e 645f 6474   = None ; end_dt
+000050c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000050d0: 6966 2070 6572 696f 6420 6973 206e 6f74  if period is not
+000050e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000050f0: 2020 2073 7461 7274 5f64 2c20 656e 645f     start_d, end_
+00005100: 6420 3d20 7966 6374 2e4d 6170 5065 7269  d = yfct.MapPeri
+00005110: 6f64 546f 4461 7465 7328 7365 6c66 2e65  odToDates(self.e
+00005120: 7863 6861 6e67 652c 2070 6572 696f 642c  xchange, period,
+00005130: 2073 656c 662e 696e 7465 7276 616c 290a   self.interval).
+00005140: 2020 2020 2020 2020 2020 2020 7065 7269              peri
+00005150: 6f64 203d 204e 6f6e 650a 2020 2020 2020  od = None.      
+00005160: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+00005170: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
+00005180: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00005190: 7374 6172 745f 640a 2020 2020 2020 2020  start_d.        
+000051a0: 2020 2020 2020 2020 656e 6420 3d20 656e          end = en
+000051b0: 645f 640a 2020 2020 2020 2020 2020 2020  d_d.            
+000051c0: 2020 2020 7374 6172 745f 6474 203d 2064      start_dt = d
+000051d0: 6174 6574 696d 652e 636f 6d62 696e 6528  atetime.combine(
+000051e0: 7374 6172 745f 642c 2074 696d 6528 3029  start_d, time(0)
+000051f0: 2c20 747a 5f65 7863 6861 6e67 6529 0a20  , tz_exchange). 
+00005200: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00005210: 6e64 5f64 7420 3d20 6461 7465 7469 6d65  nd_dt = datetime
+00005220: 2e63 6f6d 6269 6e65 2865 6e64 5f64 2c20  .combine(end_d, 
+00005230: 7469 6d65 2830 292c 2074 7a5f 6578 6368  time(0), tz_exch
+00005240: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
+00005250: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005260: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00005270: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
+00005280: 2873 7461 7274 5f64 2c20 7469 6d65 2830  (start_d, time(0
+00005290: 292c 2074 7a5f 6578 6368 616e 6765 290a  ), tz_exchange).
+000052a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052b0: 656e 6420 3d20 4e6f 6e65 0a20 2020 2020  end = None.     
+000052c0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+000052d0: 5f64 7420 3d20 7374 6172 740a 2020 2020  _dt = start.    
+000052e0: 2020 2020 2020 2020 2020 2020 656e 645f              end_
+000052f0: 6474 203d 204e 6f6e 650a 2020 2020 2020  dt = None.      
+00005300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005310: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00005320: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00005330: 2020 2020 2020 7374 6172 745f 6474 203d        start_dt =
+00005340: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
+00005350: 6528 7374 6172 742c 2074 696d 6528 3029  e(start, time(0)
+00005360: 2c20 747a 5f65 7863 6861 6e67 6529 0a20  , tz_exchange). 
+00005370: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00005380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005390: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+000053a0: 7461 7274 2c20 6461 7465 7469 6d65 293a  tart, datetime):
+000053b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000053c0: 2020 2020 2073 7461 7274 5f64 7420 3d20       start_dt = 
+000053d0: 7374 6172 740a 2020 2020 2020 2020 2020  start.          
+000053e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000053f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005400: 7374 6172 745f 6474 203d 2064 6174 6574  start_dt = datet
+00005410: 696d 652e 636f 6d62 696e 6528 7374 6172  ime.combine(star
+00005420: 742c 2074 696d 6528 3029 2c20 747a 5f65  t, time(0), tz_e
+00005430: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
+00005440: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00005450: 7274 203d 2073 7461 7274 5f64 740a 0a20  rt = start_dt.. 
+00005460: 2020 2020 2020 2069 6620 656e 6420 6973         if end is
+00005470: 204e 6f6e 6520 616e 6420 7073 7472 2069   None and pstr i
+00005480: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00005490: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+000054a0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+000054b0: 2020 2020 2020 656e 6420 3d20 645f 6e6f        end = d_no
+000054c0: 775f 6578 6368 616e 6765 2b74 645f 3164  w_exchange+td_1d
+000054d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000054e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000054f0: 2020 2073 6368 6564 203d 2079 6663 742e     sched = yfct.
+00005500: 4765 7445 7863 6861 6e67 6553 6368 6564  GetExchangeSched
+00005510: 756c 6528 7365 6c66 2e65 7863 6861 6e67  ule(self.exchang
+00005520: 652c 2064 5f6e 6f77 5f65 7863 6861 6e67  e, d_now_exchang
+00005530: 652c 2064 5f6e 6f77 5f65 7863 6861 6e67  e, d_now_exchang
+00005540: 652b 7464 5f31 6429 0a20 2020 2020 2020  e+td_1d).       
+00005550: 2020 2020 2020 2020 2069 6620 7363 6865           if sche
+00005560: 6420 6973 204e 6f6e 6520 6f72 2028 6474  d is None or (dt
+00005570: 5f6e 6f77 202b 2079 665f 6c61 6729 203c  _now + yf_lag) <
+00005580: 2073 6368 6564 5b22 6f70 656e 225d 2e69   sched["open"].i
+00005590: 6c6f 635b 305d 3a0a 2020 2020 2020 2020  loc[0]:.        
+000055a0: 2020 2020 2020 2020 2020 2020 2320 4265              # Be
+000055b0: 666f 7265 206d 6172 6b65 7420 6f70 656e  fore market open
+000055c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000055d0: 2020 2020 2065 6e64 203d 2064 6174 6574       end = datet
+000055e0: 696d 652e 636f 6d62 696e 6528 645f 6e6f  ime.combine(d_no
+000055f0: 775f 6578 6368 616e 6765 2c20 7469 6d65  w_exchange, time
+00005600: 2830 292c 2074 7a5f 6578 6368 616e 6765  (0), tz_exchange
+00005610: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00005620: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005630: 2020 2020 2020 2020 2020 2020 6920 3d20              i = 
+00005640: 7966 6374 2e47 6574 5469 6d65 7374 616d  yfct.GetTimestam
+00005650: 7043 7572 7265 6e74 496e 7465 7276 616c  pCurrentInterval
+00005660: 2873 656c 662e 6578 6368 616e 6765 2c20  (self.exchange, 
+00005670: 6474 5f6e 6f77 2b79 665f 6c61 672c 2073  dt_now+yf_lag, s
+00005680: 656c 662e 696e 7465 7276 616c 2c20 6967  elf.interval, ig
+00005690: 6e6f 7265 5f62 7265 616b 733d 5472 7565  nore_breaks=True
+000056a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000056b0: 2020 2020 2020 6966 2069 2069 7320 4e6f        if i is No
+000056c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000056d0: 2020 2020 2020 2020 2020 2020 2320 4166              # Af
+000056e0: 7465 7220 696e 7465 7276 616c 0a20 2020  ter interval.   
+000056f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005700: 2020 2020 2065 6e64 203d 2064 6174 6574       end = datet
+00005710: 696d 652e 636f 6d62 696e 6528 645f 6e6f  ime.combine(d_no
+00005720: 775f 6578 6368 616e 6765 2b74 645f 3164  w_exchange+td_1d
+00005730: 2c20 7469 6d65 2830 292c 2074 7a5f 6578  , time(0), tz_ex
+00005740: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+00005750: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00005760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005770: 2020 2020 2020 2020 2020 2320 4475 7269            # Duri
+00005780: 6e67 2069 6e74 6572 7661 6c0a 2020 2020  ng interval.    
+00005790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000057a0: 2020 2020 656e 6420 3d20 695b 2269 6e74      end = i["int
+000057b0: 6572 7661 6c5f 636c 6f73 6522 5d0a 2020  erval_close"].  
+000057c0: 2020 2020 2020 6966 2065 6e64 2069 7320        if end is 
+000057d0: 6e6f 7420 4e6f 6e65 2061 6e64 2065 6e64  not None and end
+000057e0: 5f64 7420 6973 204e 6f6e 653a 0a20 2020  _dt is None:.   
+000057f0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00005800: 7374 616e 6365 2865 6e64 2c20 6461 7465  stance(end, date
+00005810: 7469 6d65 293a 0a20 2020 2020 2020 2020  time):.         
+00005820: 2020 2020 2020 2065 6e64 5f64 7420 3d20         end_dt = 
+00005830: 656e 640a 2020 2020 2020 2020 2020 2020  end.            
+00005840: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00005850: 2020 2020 2020 2320 656e 645f 6474 203d        # end_dt =
+00005860: 2064 6174 6574 696d 652e 636f 6d62 696e   datetime.combin
+00005870: 6528 656e 642b 7464 5f31 642c 2074 696d  e(end+td_1d, tim
+00005880: 6528 3029 2c20 747a 5f65 7863 6861 6e67  e(0), tz_exchang
+00005890: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000058a0: 2020 2065 6e64 5f64 7420 3d20 6461 7465     end_dt = date
+000058b0: 7469 6d65 2e63 6f6d 6269 6e65 2865 6e64  time.combine(end
+000058c0: 2c20 7469 6d65 2830 292c 2074 7a5f 6578  , time(0), tz_ex
+000058d0: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+000058e0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+000058f0: 696e 7465 7264 6179 3a0a 2020 2020 2020  interday:.      
+00005900: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
+00005910: 656e 645f 6474 0a0a 2020 2020 2020 2020  end_dt..        
+00005920: 6966 2070 6572 696f 6420 6973 204e 6f6e  if period is Non
+00005930: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00005940: 6620 7365 6c66 2e69 6e74 6572 6461 793a  f self.interday:
+00005950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005960: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+00005970: 7461 7274 2c20 6461 7465 7469 6d65 2920  tart, datetime) 
+00005980: 6f72 2069 7369 6e73 7461 6e63 6528 656e  or isinstance(en
+00005990: 642c 2064 6174 6574 696d 6529 3a0a 2020  d, datetime):.  
+000059a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059b0: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
+000059c0: 7228 6622 2773 7461 7274 2720 616e 6420  r(f"'start' and 
+000059d0: 2765 6e64 2720 6d75 7374 2062 6520 6461  'end' must be da
+000059e0: 7465 2074 7970 6520 6e6f 7420 7b74 7970  te type not {typ
+000059f0: 6528 7374 6172 7429 7d2c 207b 7479 7065  e(start)}, {type
+00005a00: 2865 6e64 297d 2229 0a20 2020 2020 2020  (end)}").       
+00005a10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00005a20: 2020 2020 2020 2020 2020 2069 6620 286e             if (n
+00005a30: 6f74 2069 7369 6e73 7461 6e63 6528 7374  ot isinstance(st
+00005a40: 6172 742c 2064 6174 6574 696d 6529 2920  art, datetime)) 
+00005a50: 616e 6420 286e 6f74 2069 7369 6e73 7461  and (not isinsta
+00005a60: 6e63 6528 656e 642c 2064 6174 6574 696d  nce(end, datetim
+00005a70: 6529 293a 0a20 2020 2020 2020 2020 2020  e)):.           
+00005a80: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
+00005a90: 7970 6545 7272 6f72 2866 2227 7374 6172  ypeError(f"'star
+00005aa0: 7427 2061 6e64 2027 656e 6427 206d 7573  t' and 'end' mus
+00005ab0: 7420 6265 2064 6174 6574 696d 6520 7479  t be datetime ty
+00005ac0: 7065 206e 6f74 207b 7479 7065 2873 7461  pe not {type(sta
+00005ad0: 7274 297d 2c20 7b74 7970 6528 656e 6429  rt)}, {type(end)
+00005ae0: 7d22 290a 0a20 2020 2020 2020 206c 6973  }")..        lis
+00005af0: 7469 6e67 5f64 6174 6520 3d20 7966 636d  ting_date = yfcm
+00005b00: 2e52 6561 6443 6163 6865 4461 7475 6d28  .ReadCacheDatum(
+00005b10: 7365 6c66 2e74 6963 6b65 722c 2022 6c69  self.ticker, "li
+00005b20: 7374 696e 675f 6461 7465 2229 0a20 2020  sting_date").   
+00005b30: 2020 2020 2069 6620 6c69 7374 696e 675f       if listing_
+00005b40: 6461 7465 2069 7320 6e6f 7420 4e6f 6e65  date is not None
+00005b50: 2061 6e64 2073 7461 7274 2069 7320 6e6f   and start is no
+00005b60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00005b70: 2020 2020 6c69 7374 696e 675f 6461 7465      listing_date
+00005b80: 5f64 7420 3d20 6461 7465 7469 6d65 2e63  _dt = datetime.c
+00005b90: 6f6d 6269 6e65 286c 6973 7469 6e67 5f64  ombine(listing_d
+00005ba0: 6174 652c 2074 696d 6528 3029 2c20 747a  ate, time(0), tz
+00005bb0: 5f65 7863 6861 6e67 6529 0a20 2020 2020  _exchange).     
+00005bc0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00005bd0: 616e 6365 2873 7461 7274 2c20 6461 7465  ance(start, date
+00005be0: 7469 6d65 293a 0a20 2020 2020 2020 2020  time):.         
+00005bf0: 2020 2020 2020 2073 7461 7274 203d 206d         start = m
+00005c00: 6178 2873 7461 7274 2c20 6c69 7374 696e  ax(start, listin
+00005c10: 675f 6461 7465 5f64 7429 0a20 2020 2020  g_date_dt).     
+00005c20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00005c30: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00005c40: 7274 203d 206d 6178 2873 7461 7274 2c20  rt = max(start, 
+00005c50: 6c69 7374 696e 675f 6461 7465 290a 0a20  listing_date).. 
+00005c60: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
+00005c70: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00005c80: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00005c90: 662e 682e 656d 7074 793a 0a20 2020 2020  f.h.empty:.     
+00005ca0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00005cb0: 6820 3d20 4e6f 6e65 0a0a 2020 2020 2020  h = None..      
+00005cc0: 2020 2320 5265 6d6f 7665 2065 7870 6972    # Remove expir
+00005cd0: 6564 2069 6e74 6572 7661 6c73 2066 726f  ed intervals fro
+00005ce0: 6d20 6361 6368 650a 2020 2020 2020 2020  m cache.        
+00005cf0: 6966 2073 656c 662e 6820 6973 206e 6f74  if self.h is not
+00005d00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00005d10: 2020 206e 203d 2073 656c 662e 682e 7368     n = self.h.sh
+00005d20: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
+00005d30: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
+00005d40: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
+00005d50: 2020 2020 2068 5f69 6e74 6572 7661 6c5f       h_interval_
+00005d60: 6474 7320 3d20 7365 6c66 2e68 2e69 6e64  dts = self.h.ind
+00005d70: 6578 2e64 6174 6520 6966 2069 7369 6e73  ex.date if isins
+00005d80: 7461 6e63 6528 7365 6c66 2e68 2e69 6e64  tance(self.h.ind
+00005d90: 6578 5b30 5d2c 2070 642e 5469 6d65 7374  ex[0], pd.Timest
+00005da0: 616d 7029 2065 6c73 6520 7365 6c66 2e68  amp) else self.h
+00005db0: 2e69 6e64 6578 0a20 2020 2020 2020 2020  .index.         
+00005dc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00005dd0: 2020 2020 2020 2020 2068 5f69 6e74 6572           h_inter
+00005de0: 7661 6c5f 6474 7320 3d20 6e70 2e61 7272  val_dts = np.arr
+00005df0: 6179 285b 7966 6374 2e43 6f6e 7665 7274  ay([yfct.Convert
+00005e00: 546f 4461 7465 7469 6d65 2864 742c 2074  ToDatetime(dt, t
+00005e10: 7a3d 747a 5f65 7863 6861 6e67 6529 2066  z=tz_exchange) f
+00005e20: 6f72 2064 7420 696e 2073 656c 662e 682e  or dt in self.h.
+00005e30: 696e 6465 785d 290a 2020 2020 2020 2020  index]).        
+00005e40: 2020 2020 685f 696e 7465 7276 616c 5f64      h_interval_d
+00005e50: 7473 203d 206e 702e 6172 7261 7928 685f  ts = np.array(h_
+00005e60: 696e 7465 7276 616c 5f64 7473 290a 2020  interval_dts).  
+00005e70: 2020 2020 2020 2020 2020 7464 5f37 6420            td_7d 
+00005e80: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
+00005e90: 3d37 290a 2020 2020 2020 2020 2020 2020  =7).            
+00005ea0: 2320 6966 2073 656c 662e 696e 7465 7276  # if self.interv
+00005eb0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
+00005ec0: 7661 6c2e 4461 7973 313a 0a20 2020 2020  val.Days1:.     
+00005ed0: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+00005ee0: 6f6e 7469 6775 6f75 733a 0a20 2020 2020  ontiguous:.     
+00005ef0: 2020 2020 2020 2020 2020 2023 2044 6169             # Dai
+00005f00: 6c79 2064 6174 6120 6973 2061 6c77 6179  ly data is alway
+00005f10: 7320 636f 6e74 6967 756f 7573 2073 6f20  s contiguous so 
+00005f20: 6f6e 6c79 206e 6565 6420 746f 2063 6865  only need to che
+00005f30: 636b 206c 6173 7420 726f 770a 2020 2020  ck last row.    
+00005f40: 2020 2020 2020 2020 2020 2020 685f 696e              h_in
+00005f50: 7465 7276 616c 5f64 7420 3d20 685f 696e  terval_dt = h_in
+00005f60: 7465 7276 616c 5f64 7473 5b2d 315d 0a20  terval_dts[-1]. 
+00005f70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00005f80: 6574 6368 5f64 7420 3d20 7966 6374 2e43  etch_dt = yfct.C
+00005f90: 6f6e 7665 7274 546f 4461 7465 7469 6d65  onvertToDatetime
+00005fa0: 2873 656c 662e 685b 2246 6574 6368 4461  (self.h["FetchDa
+00005fb0: 7465 225d 2e69 6c6f 635b 2d31 5d2c 2074  te"].iloc[-1], t
+00005fc0: 7a3d 747a 5f65 7863 6861 6e67 6529 0a20  z=tz_exchange). 
+00005fd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00005fe0: 5f66 696e 616c 203d 2073 656c 662e 685b  _final = self.h[
+00005ff0: 2246 696e 616c 3f22 5d2e 746f 5f6e 756d  "Final?"].to_num
+00006000: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+00006010: 2020 2020 2066 5f6e 6669 6e61 6c20 3d20       f_nfinal = 
+00006020: 7e66 5f66 696e 616c 0a20 2020 2020 2020  ~f_final.       
+00006030: 2020 2020 2020 2020 2023 202d 2061 6c73           # - als
+00006040: 6f20 7472 6561 7420 7265 7061 6972 6564  o treat repaired
+00006050: 2064 6174 6120 6173 206e 6f6e 2d66 696e   data as non-fin
+00006060: 616c 2c20 6966 2066 6574 6368 6564 206e  al, if fetched n
+00006070: 6561 7220 746f 2069 6e74 6572 7661 6c20  ear to interval 
+00006080: 7469 6d65 706f 696e 740a 2020 2020 2020  timepoint.      
+00006090: 2020 2020 2020 2020 2020 2320 2020 6265            #   be
+000060a0: 6361 7573 6520 5961 686f 6f20 6d69 6768  cause Yahoo migh
+000060b0: 7420 6e6f 7720 6861 7665 2063 6f72 7265  t now have corre
+000060c0: 6374 2064 6174 610a 2020 2020 2020 2020  ct data.        
+000060d0: 2020 2020 2020 2020 665f 7265 7061 6972          f_repair
+000060e0: 203d 2028 7365 6c66 2e68 5b22 5265 7061   = (self.h["Repa
+000060f0: 6972 6564 3f22 5d2e 746f 5f6e 756d 7079  ired?"].to_numpy
+00006100: 2829 2026 2028 7365 6c66 2e68 5b22 4665  () & (self.h["Fe
+00006110: 7463 6844 6174 6522 5d20 3c20 2873 656c  tchDate"] < (sel
+00006120: 662e 682e 696e 6465 7820 2b20 7365 6c66  f.h.index + self
+00006130: 2e69 7464 202b 2074 645f 3764 2929 2e74  .itd + td_7d)).t
+00006140: 6f5f 6e75 6d70 7928 2929 0a20 2020 2020  o_numpy()).     
+00006150: 2020 2020 2020 2020 2020 2066 5f6e 6669             f_nfi
+00006160: 6e61 6c20 3d20 665f 6e66 696e 616c 207c  nal = f_nfinal |
+00006170: 2066 5f72 6570 6169 720a 2020 2020 2020   f_repair.      
+00006180: 2020 2020 2020 2020 2020 6966 2066 5f6e            if f_n
+00006190: 6669 6e61 6c2e 616e 7928 293a 0a20 2020  final.any():.   
+000061a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061b0: 2069 6478 3020 3d20 6e70 2e77 6865 7265   idx0 = np.where
+000061c0: 2866 5f6e 6669 6e61 6c29 5b30 5d5b 305d  (f_nfinal)[0][0]
+000061d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000061e0: 2020 2020 2072 6570 6169 7265 6420 3d20       repaired = 
+000061f0: 665f 7265 7061 6972 5b69 6478 305d 0a20  f_repair[idx0]. 
+00006200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006210: 2020 2068 5f69 6e74 6572 7661 6c5f 6474     h_interval_dt
+00006220: 203d 2068 5f69 6e74 6572 7661 6c5f 6474   = h_interval_dt
+00006230: 735b 6964 7830 5d0a 2020 2020 2020 2020  s[idx0].        
+00006240: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00006250: 685f 6474 203d 2079 6663 742e 436f 6e76  h_dt = yfct.Conv
+00006260: 6572 7454 6f44 6174 6574 696d 6528 7365  ertToDatetime(se
+00006270: 6c66 2e68 5b22 4665 7463 6844 6174 6522  lf.h["FetchDate"
+00006280: 5d5b 6964 7830 5d2c 2074 7a3d 747a 5f65  ][idx0], tz=tz_e
+00006290: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
+000062a0: 2020 2020 2020 2020 2020 2020 2065 7870               exp
+000062b0: 6972 6564 203d 2079 6663 742e 4973 5072  ired = yfct.IsPr
+000062c0: 6963 6544 6174 6170 6f69 6e74 4578 7069  iceDatapointExpi
+000062d0: 7265 6428 685f 696e 7465 7276 616c 5f64  red(h_interval_d
+000062e0: 742c 2066 6574 6368 5f64 742c 2072 6570  t, fetch_dt, rep
+000062f0: 6169 7265 642c 206d 6178 5f61 6765 2c20  aired, max_age, 
+00006300: 7365 6c66 2e65 7863 6861 6e67 652c 2073  self.exchange, s
+00006310: 656c 662e 696e 7465 7276 616c 2c20 7966  elf.interval, yf
+00006320: 5f6c 6167 3d79 665f 6c61 672c 2074 7269  _lag=yf_lag, tri
+00006330: 6767 6572 4578 7069 7279 4f6e 436c 6f73  ggerExpiryOnClos
+00006340: 653d 7472 6967 6765 725f 6174 5f6d 6172  e=trigger_at_mar
+00006350: 6b65 745f 636c 6f73 6529 0a20 2020 2020  ket_close).     
+00006360: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00006370: 6620 6578 7069 7265 643a 0a20 2020 2020  f expired:.     
+00006380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006390: 2020 2073 656c 662e 6820 3d20 7365 6c66     self.h = self
+000063a0: 2e68 2e69 6c6f 635b 3a69 6478 305d 0a20  .h.iloc[:idx0]. 
+000063b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063c0: 2020 2020 2020 2068 5f69 6e74 6572 7661         h_interva
+000063d0: 6c5f 6474 7320 3d20 685f 696e 7465 7276  l_dts = h_interv
+000063e0: 616c 5f64 7473 5b3a 6964 7830 5d0a 0a20  al_dts[:idx0].. 
+000063f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00006400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006410: 2065 7870 6972 6564 203d 206e 702e 6172   expired = np.ar
+00006420: 7261 7928 5b46 616c 7365 5d2a 6e29 0a20  ray([False]*n). 
+00006430: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006440: 5f66 696e 616c 203d 2073 656c 662e 685b  _final = self.h[
+00006450: 2246 696e 616c 3f22 5d2e 746f 5f6e 756d  "Final?"].to_num
+00006460: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+00006470: 2020 2020 2066 5f6e 6669 6e61 6c20 3d20       f_nfinal = 
+00006480: 7e66 5f66 696e 616c 0a20 2020 2020 2020  ~f_final.       
+00006490: 2020 2020 2020 2020 2023 202d 2061 6c73           # - als
+000064a0: 6f20 7472 6561 7420 7265 7061 6972 6564  o treat repaired
+000064b0: 2064 6174 6120 6173 206e 6f6e 2d66 696e   data as non-fin
+000064c0: 616c 2c20 6966 2066 6574 6368 6564 206e  al, if fetched n
+000064d0: 6561 7220 746f 2069 6e74 6572 7661 6c20  ear to interval 
+000064e0: 7469 6d65 706f 696e 740a 2020 2020 2020  timepoint.      
+000064f0: 2020 2020 2020 2020 2020 2320 2020 6265            #   be
+00006500: 6361 7573 6520 5961 686f 6f20 6d69 6768  cause Yahoo migh
+00006510: 7420 6e6f 7720 6861 7665 2063 6f72 7265  t now have corre
+00006520: 6374 2064 6174 610a 2020 2020 2020 2020  ct data.        
+00006530: 2020 2020 2020 2020 2320 2020 544f 444f          #   TODO
+00006540: 3a20 7465 7374 210a 2020 2020 2020 2020  : test!.        
+00006550: 2020 2020 2020 2020 665f 7265 7061 6972          f_repair
+00006560: 203d 2028 7365 6c66 2e68 5b22 5265 7061   = (self.h["Repa
+00006570: 6972 6564 3f22 5d2e 746f 5f6e 756d 7079  ired?"].to_numpy
+00006580: 2829 2026 2028 7365 6c66 2e68 5b22 4665  () & (self.h["Fe
+00006590: 7463 6844 6174 6522 5d20 3c20 2873 656c  tchDate"] < (sel
+000065a0: 662e 682e 696e 6465 7820 2b20 7365 6c66  f.h.index + self
+000065b0: 2e69 7464 202b 2074 645f 3764 2929 2e74  .itd + td_7d)).t
+000065c0: 6f5f 6e75 6d70 7928 2929 0a20 2020 2020  o_numpy()).     
+000065d0: 2020 2020 2020 2020 2020 2066 5f6e 6669             f_nfi
+000065e0: 6e61 6c20 3d20 665f 6e66 696e 616c 207c  nal = f_nfinal |
+000065f0: 2066 5f72 6570 6169 720a 2020 2020 2020   f_repair.      
+00006600: 2020 2020 2020 2020 2020 666f 7220 6964            for id
+00006610: 7820 696e 206e 702e 7768 6572 6528 665f  x in np.where(f_
+00006620: 6e66 696e 616c 295b 305d 3a0a 2020 2020  nfinal)[0]:.    
+00006630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006640: 2320 7265 7061 6972 6564 203d 2046 616c  # repaired = Fal
+00006650: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00006660: 2020 2020 2020 2072 6570 6169 7265 6420         repaired 
+00006670: 3d20 665f 7265 7061 6972 5b69 6478 5d0a  = f_repair[idx].
+00006680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006690: 2020 2020 685f 696e 7465 7276 616c 5f64      h_interval_d
+000066a0: 7420 3d20 685f 696e 7465 7276 616c 5f64  t = h_interval_d
+000066b0: 7473 5b69 6478 5d0a 2020 2020 2020 2020  ts[idx].        
+000066c0: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+000066d0: 685f 6474 203d 2079 6663 742e 436f 6e76  h_dt = yfct.Conv
+000066e0: 6572 7454 6f44 6174 6574 696d 6528 7365  ertToDatetime(se
+000066f0: 6c66 2e68 5b22 4665 7463 6844 6174 6522  lf.h["FetchDate"
+00006700: 5d5b 6964 785d 2c20 747a 3d74 7a5f 6578  ][idx], tz=tz_ex
+00006710: 6368 616e 6765 290a 2020 2020 2020 2020  change).        
+00006720: 2020 2020 2020 2020 2020 2020 6578 7069              expi
+00006730: 7265 645b 6964 785d 203d 2079 6663 742e  red[idx] = yfct.
+00006740: 4973 5072 6963 6544 6174 6170 6f69 6e74  IsPriceDatapoint
+00006750: 4578 7069 7265 6428 685f 696e 7465 7276  Expired(h_interv
+00006760: 616c 5f64 742c 2066 6574 6368 5f64 742c  al_dt, fetch_dt,
+00006770: 2072 6570 6169 7265 642c 206d 6178 5f61   repaired, max_a
+00006780: 6765 2c20 7365 6c66 2e65 7863 6861 6e67  ge, self.exchang
+00006790: 652c 2073 656c 662e 696e 7465 7276 616c  e, self.interval
+000067a0: 2c20 7966 5f6c 6167 3d79 665f 6c61 672c  , yf_lag=yf_lag,
+000067b0: 2074 7269 6767 6572 4578 7069 7279 4f6e   triggerExpiryOn
+000067c0: 436c 6f73 653d 7472 6967 6765 725f 6174  Close=trigger_at
+000067d0: 5f6d 6172 6b65 745f 636c 6f73 6529 0a20  _market_close). 
+000067e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000067f0: 6620 6578 7069 7265 642e 616e 7928 293a  f expired.any():
+00006800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006810: 2020 2020 2073 656c 662e 6820 3d20 7365       self.h = se
+00006820: 6c66 2e68 2e64 726f 7028 7365 6c66 2e68  lf.h.drop(self.h
+00006830: 2e69 6e64 6578 5b65 7870 6972 6564 5d29  .index[expired])
+00006840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006850: 2020 2020 2068 5f69 6e74 6572 7661 6c5f       h_interval_
+00006860: 6474 7320 3d20 685f 696e 7465 7276 616c  dts = h_interval
+00006870: 5f64 7473 5b7e 6578 7069 7265 645d 0a20  _dts[~expired]. 
+00006880: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00006890: 6c66 2e68 2e65 6d70 7479 3a0a 2020 2020  lf.h.empty:.    
+000068a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000068b0: 2e68 203d 204e 6f6e 650a 0a20 2020 2020  .h = None..     
+000068c0: 2020 2072 616e 6765 735f 746f 5f66 6574     ranges_to_fet
+000068d0: 6368 203d 205b 5d0a 2020 2020 2020 2020  ch = [].        
+000068e0: 6966 2073 656c 662e 6820 6973 204e 6f6e  if self.h is Non
+000068f0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00006900: 2053 696d 706c 652c 206a 7573 7420 6665   Simple, just fe
+00006910: 7463 6820 7468 6520 7265 7175 6573 7465  tch the requeste
+00006920: 6420 6461 7461 0a0a 2020 2020 2020 2020  d data..        
+00006930: 2020 2020 6966 2070 6572 696f 6420 6973      if period is
+00006940: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00006950: 2020 2020 2020 2020 2020 2068 203d 2073             h = s
+00006960: 656c 662e 5f66 6574 6368 5966 4869 7374  elf._fetchYfHist
+00006970: 6f72 7928 7073 7472 2c20 4e6f 6e65 2c20  ory(pstr, None, 
+00006980: 4e6f 6e65 2c20 7072 6570 6f73 742c 2064  None, prepost, d
+00006990: 6562 7567 5f79 6629 0a20 2020 2020 2020  ebug_yf).       
+000069a0: 2020 2020 2020 2020 2069 6620 6820 6973           if h is
+000069b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000069c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000069d0: 2045 7863 6570 7469 6f6e 2866 227b 7365   Exception(f"{se
+000069e0: 6c66 2e74 6963 6b65 727d 3a20 4661 696c  lf.ticker}: Fail
+000069f0: 6564 2074 6f20 6665 7463 6820 7065 7269  ed to fetch peri
+00006a00: 6f64 3d7b 7065 7269 6f64 7d22 290a 2020  od={period}").  
+00006a10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00006a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006a30: 6966 2073 656c 662e 636f 6e74 6967 756f  if self.contiguo
+00006a40: 7573 3a0a 2020 2020 2020 2020 2020 2020  us:.            
+00006a50: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00006a60: 2064 6169 6c79 2061 6c77 6179 7320 7570   daily always up
+00006a70: 2d74 6f2d 6e6f 770a 2020 2020 2020 2020  -to-now.        
+00006a80: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
+00006a90: 7365 6c66 2e5f 6665 7463 6859 6648 6973  self._fetchYfHis
+00006aa0: 746f 7279 2870 7374 722c 2073 7461 7274  tory(pstr, start
+00006ab0: 2c20 746f 6d6f 7272 6f77 2c20 7072 6570  , tomorrow, prep
+00006ac0: 6f73 742c 2064 6562 7567 5f79 6629 0a20  ost, debug_yf). 
+00006ad0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00006ae0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00006af0: 2020 2020 2020 2020 2068 203d 2073 656c           h = sel
+00006b00: 662e 5f66 6574 6368 5966 4869 7374 6f72  f._fetchYfHistor
+00006b10: 7928 7073 7472 2c20 7374 6172 742c 2065  y(pstr, start, e
+00006b20: 6e64 2c20 7072 6570 6f73 742c 2064 6562  nd, prepost, deb
+00006b30: 7567 5f79 6629 0a20 2020 2020 2020 2020  ug_yf).         
+00006b40: 2020 2020 2020 2069 6620 6820 6973 204e         if h is N
+00006b50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00006b60: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+00006b70: 7863 6570 7469 6f6e 2866 227b 7365 6c66  xception(f"{self
+00006b80: 2e74 6963 6b65 727d 3a20 4661 696c 6564  .ticker}: Failed
+00006b90: 2074 6f20 6665 7463 6820 6461 7465 2072   to fetch date r
+00006ba0: 616e 6765 207b 7374 6172 747d 2d3e 7b65  ange {start}->{e
+00006bb0: 6e64 7d22 290a 0a20 2020 2020 2020 2020  nd}")..         
+00006bc0: 2020 2023 2041 646a 7573 740a 2020 2020     # Adjust.    
+00006bd0: 2020 2020 2020 2020 6820 3d20 7365 6c66          h = self
+00006be0: 2e5f 7265 7665 7273 6559 6168 6f6f 4164  ._reverseYahooAd
+00006bf0: 6a75 7374 2868 290a 0a20 2020 2020 2020  just(h)..       
+00006c00: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00006c10: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
+00006c20: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
+00006c30: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+00006c40: 7370 6c69 7473 203d 2068 5b68 5b22 5374  splits = h[h["St
+00006c50: 6f63 6b20 5370 6c69 7473 225d 2021 3d20  ock Splits"] != 
+00006c60: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00006c70: 2020 2069 6620 6c65 6e28 685f 7370 6c69     if len(h_spli
+00006c80: 7473 2920 3e20 303a 0a20 2020 2020 2020  ts) > 0:.       
+00006c90: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00006ca0: 662e 6d61 6e61 6765 722e 4765 7448 6973  f.manager.GetHis
+00006cb0: 746f 7279 2822 4576 656e 7473 2229 2e55  tory("Events").U
+00006cc0: 7064 6174 6553 706c 6974 7328 685f 7370  pdateSplits(h_sp
+00006cd0: 6c69 7473 290a 0a20 2020 2020 2020 2020  lits)..         
+00006ce0: 2020 2020 2020 2068 5f64 6976 7320 3d20         h_divs = 
+00006cf0: 685b 685b 2244 6976 6964 656e 6473 225d  h[h["Dividends"]
+00006d00: 2021 3d20 305d 5b5b 2244 6976 6964 656e   != 0][["Dividen
+00006d10: 6473 222c 2022 4665 7463 6844 6174 6522  ds", "FetchDate"
+00006d20: 5d5d 2e63 6f70 7928 290a 2020 2020 2020  ]].copy().      
+00006d30: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00006d40: 2868 5f64 6976 7329 203e 2030 3a0a 2020  (h_divs) > 0:.  
+00006d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d60: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
+00006d70: 7428 2257 7269 7469 6e67 206e 6577 2064  t("Writing new d
+00006d80: 6976 6964 656e 6473 2074 6f20 6361 6368  ividends to cach
+00006d90: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+00006da0: 2020 2020 2020 2020 6361 6368 6564 5f6e          cached_n
+00006db0: 6577 5f64 6976 7320 3d20 7966 636d 2e52  ew_divs = yfcm.R
+00006dc0: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
+00006dd0: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
+00006de0: 6469 7673 2229 0a20 2020 2020 2020 2020  divs").         
+00006df0: 2020 2020 2020 2020 2020 2069 6620 6361             if ca
+00006e00: 6368 6564 5f6e 6577 5f64 6976 7320 6973  ched_new_divs is
+00006e10: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00006e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e30: 2020 2069 6620 7966 636d 2e52 6561 6443     if yfcm.ReadC
+00006e40: 6163 6865 4d65 7461 6461 7461 2873 656c  acheMetadata(sel
+00006e50: 662e 7469 636b 6572 2c20 226e 6577 5f64  f.ticker, "new_d
+00006e60: 6976 7322 2c20 226c 6f63 6b65 6422 2920  ivs", "locked") 
+00006e70: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00006e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e90: 2020 2020 2020 2020 2023 206c 6f63 6b65           # locke
+00006ea0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00006eb0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00006ec0: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
+00006ed0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00006ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006ef0: 2020 2020 2020 2020 2020 2020 2063 6163               cac
+00006f00: 6865 645f 6e65 775f 6469 7673 203d 2070  hed_new_divs = p
+00006f10: 642e 636f 6e63 6174 285b 6361 6368 6564  d.concat([cached
+00006f20: 5f6e 6577 5f64 6976 732c 2068 5f64 6976  _new_divs, h_div
+00006f30: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
+00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f50: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
+00006f60: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
+00006f70: 2c20 226e 6577 5f64 6976 7322 2c20 6361  , "new_divs", ca
+00006f80: 6368 6564 5f6e 6577 5f64 6976 7329 0a20  ched_new_divs). 
+00006f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fa0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fc0: 2079 6663 6d2e 5374 6f72 6543 6163 6865   yfcm.StoreCache
+00006fd0: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
+00006fe0: 722c 2022 6e65 775f 6469 7673 222c 2068  r, "new_divs", h
+00006ff0: 5f64 6976 732e 636f 7079 2829 290a 0a20  _divs.copy()).. 
+00007000: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00007010: 5f75 7064 6174 6564 4361 6368 6564 5072  _updatedCachedPr
+00007020: 6963 6573 2868 290a 0a20 2020 2020 2020  ices(h)..       
+00007030: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00007040: 2020 2023 2043 6f6d 7061 7265 2072 6571     # Compare req
+00007050: 7565 7374 2061 6761 696e 7374 2063 6163  uest against cac
+00007060: 6865 6420 6461 7461 2c20 6f6e 6c79 2066  hed data, only f
+00007070: 6574 6368 206d 6973 7369 6e67 2f65 7870  etch missing/exp
+00007080: 6972 6564 2064 6174 610a 0a20 2020 2020  ired data..     
+00007090: 2020 2020 2020 2023 2050 6572 666f 726d         # Perform
+000070a0: 616e 6365 2054 4f44 4f3a 2074 6167 2072  ance TODO: tag r
+000070b0: 6f77 7320 6173 2066 756c 6c79 2063 6f6e  ows as fully con
+000070c0: 7469 6775 6f75 7320 746f 2061 766f 6964  tiguous to avoid
+000070d0: 2073 6561 7263 6869 6e67 2066 6f72 2067   searching for g
+000070e0: 6170 730a 0a20 2020 2020 2020 2020 2020  aps..           
+000070f0: 2023 2043 616c 6375 6c61 7465 2072 616e   # Calculate ran
+00007100: 6765 735f 746f 5f66 6574 6368 0a20 2020  ges_to_fetch.   
+00007110: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00007120: 2e63 6f6e 7469 6775 6f75 733a 0a20 2020  .contiguous:.   
+00007130: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00007140: 7365 6c66 2e68 2069 7320 4e6f 6e65 206f  self.h is None o
+00007150: 7220 7365 6c66 2e68 2e65 6d70 7479 3a0a  r self.h.empty:.
+00007160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007170: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00007180: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00007190: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000071a0: 6e67 6573 5f74 6f5f 6665 7463 6820 3d20  nges_to_fetch = 
+000071b0: 7966 6374 2e49 6465 6e74 6966 794d 6973  yfct.IdentifyMis
+000071c0: 7369 6e67 496e 7465 7276 616c 5261 6e67  singIntervalRang
+000071d0: 6573 2873 656c 662e 6578 6368 616e 6765  es(self.exchange
+000071e0: 2c20 7374 6172 745f 642c 2065 6e64 5f64  , start_d, end_d
+000071f0: 2c20 7365 6c66 2e69 6e74 6572 7661 6c2c  , self.interval,
+00007200: 205b 5d2c 206d 696e 4469 7374 616e 6365   [], minDistance
+00007210: 5468 7265 7368 6f6c 643d 3529 0a20 2020  Threshold=5).   
+00007220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007230: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00007240: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00007250: 616e 6765 735f 746f 5f66 6574 6368 203d  anges_to_fetch =
+00007260: 2079 6663 742e 4964 656e 7469 6679 4d69   yfct.IdentifyMi
+00007270: 7373 696e 6749 6e74 6572 7661 6c52 616e  ssingIntervalRan
+00007280: 6765 7328 7365 6c66 2e65 7863 6861 6e67  ges(self.exchang
+00007290: 652c 2073 7461 7274 2c20 656e 642c 2073  e, start, end, s
+000072a0: 656c 662e 696e 7465 7276 616c 2c20 5b5d  elf.interval, []
+000072b0: 2c20 6d69 6e44 6973 7461 6e63 6554 6872  , minDistanceThr
+000072c0: 6573 686f 6c64 3d35 290a 2020 2020 2020  eshold=5).      
+000072d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000072e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072f0: 2020 2020 2320 456e 7375 7265 2074 6861      # Ensure tha
+00007300: 7420 6461 696c 7920 6461 7461 2061 6c77  t daily data alw
+00007310: 6179 7320 7570 2d74 6f2d 6461 7465 2074  ays up-to-date t
+00007320: 6f20 6e6f 770a 2020 2020 2020 2020 2020  o now.          
+00007330: 2020 2020 2020 2020 2020 2320 5570 6461            # Upda
+00007340: 7465 3a20 6f6e 6c79 206e 6563 6573 7361  te: only necessa
+00007350: 7279 2074 6f20 6265 2075 702d 746f 2d64  ry to be up-to-d
+00007360: 6174 6520 746f 206e 6f77 2069 6620 6120  ate to now if a 
+00007370: 6665 7463 6820 6861 7070 656e 730a 2020  fetch happens.  
 00007380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007390: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
-000073a0: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
-000073b0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-000073c0: 2065 6c73 6520 7072 696e 7428 6622 7b73   else print(f"{s
-000073d0: 656c 662e 7469 636b 6572 7d3a 2022 202b  elf.ticker}: " +
-000073e0: 206d 7367 290a 2020 2020 2020 2020 2020   msg).          
-000073f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00007400: 2073 656c 662e 696e 7465 7264 6179 3a0a   self.interday:.
-00007410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007420: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-00007430: 616e 6765 5072 655f 746f 5f66 6574 6368  angePre_to_fetch
-00007440: 2069 7320 6e6f 7420 4e6f 6e65 206f 7220   is not None or 
-00007450: 656e 6420 3e20 685f 656e 643a 0a20 2020  end > h_end:.   
-00007460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007470: 2020 2020 2020 2020 2020 2020 2074 6172               tar
-00007480: 6765 745f 656e 645f 6420 3d20 746f 6d6f  get_end_d = tomo
-00007490: 7272 6f77 5f64 0a20 2020 2020 2020 2020  rrow_d.         
-000074a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000074c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000074d0: 2020 2020 2020 2020 2074 6172 6765 745f           target_
-000074e0: 656e 645f 6420 3d20 656e 640a 2020 2020  end_d = end.    
-000074f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007500: 2020 2020 2020 2020 6966 2068 5f65 6e64          if h_end
-00007510: 203c 2074 6172 6765 745f 656e 645f 643a   < target_end_d:
-00007520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007540: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00007550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007560: 2020 2020 2020 2020 2020 7261 6e67 6550            rangeP
-00007570: 6f73 745f 746f 5f66 6574 6368 203d 2079  ost_to_fetch = y
-00007580: 6663 742e 4964 656e 7469 6679 4d69 7373  fct.IdentifyMiss
-00007590: 696e 6749 6e74 6572 7661 6c52 616e 6765  ingIntervalRange
-000075a0: 7328 7365 6c66 2e65 7863 6861 6e67 652c  s(self.exchange,
-000075b0: 2068 5f65 6e64 2c20 7461 7267 6574 5f65   h_end, target_e
-000075c0: 6e64 5f64 2c20 7365 6c66 2e69 6e74 6572  nd_d, self.inter
-000075d0: 7661 6c2c 204e 6f6e 652c 206d 696e 4469  val, None, minDi
-000075e0: 7374 616e 6365 5468 7265 7368 6f6c 643d  stanceThreshold=
-000075f0: 3529 0a20 2020 2020 2020 2020 2020 2020  5).             
+00007390: 2020 6474 5f73 7461 7274 203d 2079 6663    dt_start = yfc
+000073a0: 742e 436f 6e76 6572 7454 6f44 6174 6574  t.ConvertToDatet
+000073b0: 696d 6528 7365 6c66 2e68 2e69 6e64 6578  ime(self.h.index
+000073c0: 5b30 5d2c 2074 7a3d 747a 5f65 7863 6861  [0], tz=tz_excha
+000073d0: 6e67 6529 0a20 2020 2020 2020 2020 2020  nge).           
+000073e0: 2020 2020 2020 2020 2064 745f 656e 6420           dt_end 
+000073f0: 3d20 7966 6374 2e43 6f6e 7665 7274 546f  = yfct.ConvertTo
+00007400: 4461 7465 7469 6d65 2873 656c 662e 682e  Datetime(self.h.
+00007410: 696e 6465 785b 2d31 5d2c 2074 7a3d 747a  index[-1], tz=tz
+00007420: 5f65 7863 6861 6e67 6529 0a20 2020 2020  _exchange).     
+00007430: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00007440: 5f73 7461 7274 203d 2079 6663 742e 4765  _start = yfct.Ge
+00007450: 7454 696d 6573 7461 6d70 4375 7272 656e  tTimestampCurren
+00007460: 7449 6e74 6572 7661 6c28 7365 6c66 2e65  tInterval(self.e
+00007470: 7863 6861 6e67 652c 2064 745f 7374 6172  xchange, dt_star
+00007480: 742c 2073 656c 662e 696e 7465 7276 616c  t, self.interval
+00007490: 2c20 6967 6e6f 7265 5f62 7265 616b 733d  , ignore_breaks=
+000074a0: 5472 7565 295b 2269 6e74 6572 7661 6c5f  True)["interval_
+000074b0: 6f70 656e 225d 0a20 2020 2020 2020 2020  open"].         
+000074c0: 2020 2020 2020 2020 2020 2068 5f65 6e64             h_end
+000074d0: 203d 2079 6663 742e 4765 7454 696d 6573   = yfct.GetTimes
+000074e0: 7461 6d70 4375 7272 656e 7449 6e74 6572  tampCurrentInter
+000074f0: 7661 6c28 7365 6c66 2e65 7863 6861 6e67  val(self.exchang
+00007500: 652c 2064 745f 656e 642c 2073 656c 662e  e, dt_end, self.
+00007510: 696e 7465 7276 616c 2c20 6967 6e6f 7265  interval, ignore
+00007520: 5f62 7265 616b 733d 5472 7565 295b 2269  _breaks=True)["i
+00007530: 6e74 6572 7661 6c5f 636c 6f73 6522 5d0a  nterval_close"].
+00007540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007550: 2020 2020 2072 616e 6765 5072 655f 746f       rangePre_to
+00007560: 5f66 6574 6368 203d 204e 6f6e 650a 2020  _fetch = None.  
+00007570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007580: 2020 6966 2073 7461 7274 203c 2068 5f73    if start < h_s
+00007590: 7461 7274 3a0a 2020 2020 2020 2020 2020  tart:.          
+000075a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000075b0: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
+000075c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000075d0: 2020 2020 2020 2020 6d73 6720 3d20 2263          msg = "c
+000075e0: 6865 636b 696e 6720 666f 7220 7261 6e67  hecking for rang
+000075f0: 6550 7265 5f74 6f5f 6665 7463 6822 0a20  ePre_to_fetch". 
 00007600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007610: 2020 2065 7863 6570 7420 7966 6364 2e4e     except yfcd.N
-00007620: 6f49 6e74 6572 7661 6c73 496e 5261 6e67  oIntervalsInRang
-00007630: 6545 7863 6570 7469 6f6e 3a0a 2020 2020  eException:.    
-00007640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007660: 7261 6e67 6550 6f73 745f 746f 5f66 6574  rangePost_to_fet
-00007670: 6368 203d 204e 6f6e 650a 2020 2020 2020  ch = None.      
-00007680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007690: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076b0: 2020 2020 6966 2072 616e 6765 5072 655f      if rangePre_
-000076c0: 746f 5f66 6574 6368 2069 7320 6e6f 7420  to_fetch is not 
-000076d0: 4e6f 6e65 206f 7220 656e 6420 3e20 685f  None or end > h_
-000076e0: 656e 643a 0a20 2020 2020 2020 2020 2020  end:.           
-000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007700: 2020 2020 2074 6172 6765 745f 656e 645f       target_end_
-00007710: 6474 203d 2064 745f 6e6f 770a 2020 2020  dt = dt_now.    
-00007720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007730: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00007610: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+00007620: 5472 6163 6550 7269 6e74 286d 7367 2920  TracePrint(msg) 
+00007630: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
+00007640: 6745 6e61 626c 6564 2829 2065 6c73 6520  gEnabled() else 
+00007650: 7072 696e 7428 6622 7b73 656c 662e 7469  print(f"{self.ti
+00007660: 636b 6572 7d3a 2022 202b 206d 7367 290a  cker}: " + msg).
+00007670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007680: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00007690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000076a0: 2020 2020 2020 2020 2072 616e 6765 5072           rangePr
+000076b0: 655f 746f 5f66 6574 6368 203d 2079 6663  e_to_fetch = yfc
+000076c0: 742e 4964 656e 7469 6679 4d69 7373 696e  t.IdentifyMissin
+000076d0: 6749 6e74 6572 7661 6c52 616e 6765 7328  gIntervalRanges(
+000076e0: 7365 6c66 2e65 7863 6861 6e67 652c 2073  self.exchange, s
+000076f0: 7461 7274 2c20 685f 7374 6172 742c 2073  tart, h_start, s
+00007700: 656c 662e 696e 7465 7276 616c 2c20 4e6f  elf.interval, No
+00007710: 6e65 2c20 6967 6e6f 7265 5f62 7265 616b  ne, ignore_break
+00007720: 733d 5472 7565 2c20 6d69 6e44 6973 7461  s=True, minDista
+00007730: 6e63 6554 6872 6573 686f 6c64 3d35 290a  nceThreshold=5).
 00007740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007750: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00007760: 7267 6574 5f65 6e64 5f64 7420 3d20 656e  rget_end_dt = en
-00007770: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00007780: 2020 2020 2020 2020 2020 2020 2020 6420                d 
-00007790: 3d20 7461 7267 6574 5f65 6e64 5f64 742e  = target_end_dt.
-000077a0: 6173 7469 6d65 7a6f 6e65 2874 7a5f 6578  astimezone(tz_ex
-000077b0: 6368 616e 6765 292e 6461 7465 2829 0a20  change).date(). 
-000077c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000077d0: 2020 2020 2020 2020 2020 2073 6368 6564             sched
-000077e0: 203d 2079 6663 742e 4765 7445 7863 6861   = yfct.GetExcha
-000077f0: 6e67 6553 6368 6564 756c 6528 7365 6c66  ngeSchedule(self
-00007800: 2e65 7863 6861 6e67 652c 2064 2c20 6420  .exchange, d, d 
-00007810: 2b20 7464 5f31 6429 0a20 2020 2020 2020  + td_1d).       
-00007820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007830: 2020 2020 2069 6620 2873 6368 6564 2069       if (sched i
-00007840: 7320 6e6f 7420 4e6f 6e65 2920 616e 6420  s not None) and 
-00007850: 286e 6f74 2073 6368 6564 2e65 6d70 7479  (not sched.empty
-00007860: 2920 616e 6420 2864 745f 6e6f 7720 3e20  ) and (dt_now > 
-00007870: 7363 6865 645b 226f 7065 6e22 5d2e 696c  sched["open"].il
-00007880: 6f63 5b30 5d29 3a0a 2020 2020 2020 2020  oc[0]):.        
-00007890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000078a0: 2020 2020 2020 2020 7461 7267 6574 5f65          target_e
-000078b0: 6e64 5f64 7420 3d20 7363 6865 645b 2263  nd_dt = sched["c
-000078c0: 6c6f 7365 225d 2e69 6c6f 635b 305d 2b74  lose"].iloc[0]+t
-000078d0: 696d 6564 656c 7461 2868 6f75 7273 3d32  imedelta(hours=2
-000078e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000078f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00007900: 2068 5f65 6e64 203c 2074 6172 6765 745f   h_end < target_
-00007910: 656e 645f 6474 3a0a 2020 2020 2020 2020  end_dt:.        
-00007920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007930: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00007940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007960: 2072 616e 6765 506f 7374 5f74 6f5f 6665   rangePost_to_fe
-00007970: 7463 6820 3d20 7966 6374 2e49 6465 6e74  tch = yfct.Ident
-00007980: 6966 794d 6973 7369 6e67 496e 7465 7276  ifyMissingInterv
-00007990: 616c 5261 6e67 6573 2873 656c 662e 6578  alRanges(self.ex
-000079a0: 6368 616e 6765 2c20 685f 656e 642c 2074  change, h_end, t
-000079b0: 6172 6765 745f 656e 645f 6474 2c20 7365  arget_end_dt, se
-000079c0: 6c66 2e69 6e74 6572 7661 6c2c 204e 6f6e  lf.interval, Non
-000079d0: 652c 206d 696e 4469 7374 616e 6365 5468  e, minDistanceTh
-000079e0: 7265 7368 6f6c 643d 3529 0a20 2020 2020  reshold=5).     
-000079f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a00: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00007a10: 7420 7966 6364 2e4e 6f49 6e74 6572 7661  t yfcd.NoInterva
-00007a20: 6c73 496e 5261 6e67 6545 7863 6570 7469  lsInRangeExcepti
-00007a30: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00007a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007a50: 2020 2020 2020 2020 7261 6e67 6550 6f73          rangePos
-00007a60: 745f 746f 5f66 6574 6368 203d 204e 6f6e  t_to_fetch = Non
-00007a70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00007a80: 2020 2020 2020 2320 6966 206e 6f74 2079        # if not y
-00007a90: 6663 742e 4973 5469 6d65 7374 616d 7049  fct.IsTimestampI
-00007aa0: 6e41 6374 6976 6553 6573 7369 6f6e 2873  nActiveSession(s
-00007ab0: 656c 662e 6578 6368 616e 6765 2c20 6474  elf.exchange, dt
-00007ac0: 5f6e 6f77 293a 0a20 2020 2020 2020 2020  _now):.         
-00007ad0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-00007ae0: 7261 6e67 6550 6f73 745f 746f 5f66 6574  rangePost_to_fet
-00007af0: 6368 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ch is not None:.
-00007b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b10: 2020 2020 2320 2020 2020 7072 696e 7428      #     print(
-00007b20: 2272 616e 6765 506f 7374 5f74 6f5f 6665  "rangePost_to_fe
-00007b30: 7463 683a 2229 0a20 2020 2020 2020 2020  tch:").         
-00007b40: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00007b50: 2066 6f72 2072 2069 6e20 7261 6e67 6550   for r in rangeP
-00007b60: 6f73 745f 746f 5f66 6574 6368 3a0a 2020  ost_to_fetch:.  
-00007b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b80: 2020 2320 2020 2020 2020 2020 7072 696e    #         prin
-00007b90: 7428 222d 2022 2c20 7229 0a20 2020 2020  t("- ", r).     
-00007ba0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007bb0: 2020 2020 2064 6179 5f73 6368 6564 203d       day_sched =
-00007bc0: 2079 6663 742e 4765 7445 7863 6861 6e67   yfct.GetExchang
-00007bd0: 6553 6368 6564 756c 6528 7365 6c66 2e65  eSchedule(self.e
-00007be0: 7863 6861 6e67 652c 2064 5f6e 6f77 5f65  xchange, d_now_e
-00007bf0: 7863 6861 6e67 652c 2074 6f6d 6f72 726f  xchange, tomorro
-00007c00: 775f 6429 0a20 2020 2020 2020 2020 2020  w_d).           
-00007c10: 2020 2020 2020 2020 2023 2020 2020 2070           #     p
-00007c20: 7269 6e74 2866 2264 5f6e 6f77 5f65 7863  rint(f"d_now_exc
-00007c30: 6861 6e67 653d 7b64 5f6e 6f77 5f65 7863  hange={d_now_exc
-00007c40: 6861 6e67 657d 2c20 746f 6d6f 7272 6f77  hange}, tomorrow
-00007c50: 5f64 3d7b 746f 6d6f 7272 6f77 5f64 7d22  _d={tomorrow_d}"
-00007c60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007c70: 2020 2020 2020 2320 2020 2020 7072 696e        #     prin
-00007c80: 7428 2264 6179 5f73 6368 6564 3a22 290a  t("day_sched:").
+00007750: 2020 2020 2020 2020 6578 6365 7074 2079          except y
+00007760: 6663 642e 4e6f 496e 7465 7276 616c 7349  fcd.NoIntervalsI
+00007770: 6e52 616e 6765 4578 6365 7074 696f 6e3a  nRangeException:
+00007780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007790: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+000077a0: 6765 5072 655f 746f 5f66 6574 6368 203d  gePre_to_fetch =
+000077b0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000077c0: 2020 2020 2020 2020 2020 6966 2072 616e            if ran
+000077d0: 6765 5072 655f 746f 5f66 6574 6368 2069  gePre_to_fetch i
+000077e0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000077f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007800: 2020 2020 6966 206c 656e 2872 616e 6765      if len(range
+00007810: 5072 655f 746f 5f66 6574 6368 2920 3e20  Pre_to_fetch) > 
+00007820: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00007830: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00007840: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+00007850: 4578 7065 6374 6564 206f 6e6c 7920 6f6e  Expected only on
+00007860: 6520 656c 656d 656e 7420 696e 2072 616e  e element in ran
+00007870: 6765 5072 655f 746f 5f66 6574 6368 5b5d  gePre_to_fetch[]
+00007880: 2c20 6275 7420 3d20 7b7d 222e 666f 726d  , but = {}".form
+00007890: 6174 2872 616e 6765 5072 655f 746f 5f66  at(rangePre_to_f
+000078a0: 6574 6368 2929 0a20 2020 2020 2020 2020  etch)).         
+000078b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000078c0: 616e 6765 5072 655f 746f 5f66 6574 6368  angePre_to_fetch
+000078d0: 203d 2072 616e 6765 5072 655f 746f 5f66   = rangePre_to_f
+000078e0: 6574 6368 5b30 5d0a 2020 2020 2020 2020  etch[0].        
+000078f0: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
+00007900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007910: 2020 7261 6e67 6550 6f73 745f 746f 5f66    rangePost_to_f
+00007920: 6574 6368 203d 204e 6f6e 650a 2020 2020  etch = None.    
+00007930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007940: 6966 2073 656c 662e 685b 2246 696e 616c  if self.h["Final
+00007950: 3f22 5d2e 696c 6f63 5b2d 315d 2061 6e64  ?"].iloc[-1] and
+00007960: 2028 6d69 6e28 7966 6374 2e43 616c 6349   (min(yfct.CalcI
+00007970: 6e74 6572 7661 6c4c 6173 7444 6174 6144  ntervalLastDataD
+00007980: 7428 7365 6c66 2e65 7863 6861 6e67 652c  t(self.exchange,
+00007990: 2064 745f 656e 642c 2073 656c 662e 696e   dt_end, self.in
+000079a0: 7465 7276 616c 292c 2073 656c 662e 685b  terval), self.h[
+000079b0: 2246 6574 6368 4461 7465 225d 2e69 6c6f  "FetchDate"].ilo
+000079c0: 635b 2d31 5d29 2b6d 6178 5f61 6765 203c  c[-1])+max_age <
+000079d0: 3d20 6474 5f6e 6f77 293a 0a20 2020 2020  = dt_now):.     
+000079e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000079f0: 2020 2023 204e 6f74 653a 2069 6620 7365     # Note: if se
+00007a00: 6c66 2e68 5b22 4669 6e61 6c3f 225d 2e69  lf.h["Final?"].i
+00007a10: 6c6f 635b 2d31 5d20 3d3d 2046 616c 7365  loc[-1] == False
+00007a20: 2c20 7468 656e 2074 6861 7420 6d65 616e  , then that mean
+00007a30: 7320 6162 6f76 6520 6578 7069 7279 2063  s above expiry c
+00007a40: 6865 636b 2064 6964 6e27 7420 7265 6d6f  heck didn't remo
+00007a50: 7665 2069 7420 736f 2064 6f6e 2774 2066  ve it so don't f
+00007a60: 6574 6368 2061 6e79 7468 696e 670a 2020  etch anything.  
+00007a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a80: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+00007a90: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+00007aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ab0: 6d73 6720 3d20 2263 6865 636b 696e 6720  msg = "checking 
+00007ac0: 666f 7220 7261 6e67 6550 6f73 745f 746f  for rangePost_to
+00007ad0: 5f66 6574 6368 220a 2020 2020 2020 2020  _fetch".        
+00007ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007af0: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
+00007b00: 696e 7428 6d73 6729 2069 6620 7966 636c  int(msg) if yfcl
+00007b10: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
+00007b20: 6428 2920 656c 7365 2070 7269 6e74 2866  d() else print(f
+00007b30: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
+00007b40: 2220 2b20 6d73 6729 0a20 2020 2020 2020  " + msg).       
+00007b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b60: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
+00007b70: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00007b80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00007b90: 6620 7261 6e67 6550 7265 5f74 6f5f 6665  f rangePre_to_fe
+00007ba0: 7463 6820 6973 206e 6f74 204e 6f6e 6520  tch is not None 
+00007bb0: 6f72 2065 6e64 203e 2068 5f65 6e64 3a0a  or end > h_end:.
+00007bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007be0: 7461 7267 6574 5f65 6e64 5f64 203d 2074  target_end_d = t
+00007bf0: 6f6d 6f72 726f 775f 640a 2020 2020 2020  omorrow_d.      
+00007c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00007c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c30: 2020 2020 2020 2020 2020 2020 7461 7267              targ
+00007c40: 6574 5f65 6e64 5f64 203d 2065 6e64 0a20  et_end_d = end. 
+00007c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c60: 2020 2020 2020 2020 2020 2069 6620 685f             if h_
+00007c70: 656e 6420 3c20 7461 7267 6574 5f65 6e64  end < target_end
+00007c80: 5f64 3a0a 2020 2020 2020 2020 2020 2020  _d:.            
 00007c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ca0: 2020 2020 2320 2020 2020 7072 696e 7428      #     print(
-00007cb0: 6461 795f 7363 6865 6429 0a20 2020 2020  day_sched).     
-00007cc0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00007cd0: 2020 2020 2069 6620 6474 5f6e 6f77 203c       if dt_now <
-00007ce0: 2064 6179 5f73 6368 6564 5b22 6f70 656e   day_sched["open
-00007cf0: 225d 2e69 6c6f 635b 305d 3a0a 2020 2020  "].iloc[0]:.    
-00007d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d10: 2320 2020 2020 2020 2020 666f 7220 6920  #         for i 
-00007d20: 696e 2072 616e 6765 286c 656e 2872 616e  in range(len(ran
-00007d30: 6765 506f 7374 5f74 6f5f 6665 7463 6829  gePost_to_fetch)
-00007d40: 2d31 2c20 2d31 2c20 2d31 293a 0a20 2020  -1, -1, -1):.   
-00007d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007d60: 2023 2020 2020 2020 2020 2020 2020 2072   #             r
-00007d70: 203d 2072 616e 6765 506f 7374 5f74 6f5f   = rangePost_to_
-00007d80: 6665 7463 685b 695d 0a20 2020 2020 2020  fetch[i].       
-00007d90: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-00007da0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00007db0: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
-00007dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007dd0: 2023 2020 2020 2020 2020 2020 2020 2020   #              
-00007de0: 2020 2023 2069 6620 725b 315d 203d 3d20     # if r[1] == 
-00007df0: 2864 745f 6e6f 772e 6173 7469 6d65 7a6f  (dt_now.astimezo
-00007e00: 6e65 2874 7a5f 6578 6368 616e 6765 292e  ne(tz_exchange).
-00007e10: 6461 7465 2829 2b74 645f 3164 293a 0a20  date()+td_1d):. 
-00007e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e30: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00007e40: 2020 2020 2069 6620 725b 315d 203d 3d20       if r[1] == 
-00007e50: 746f 6d6f 7272 6f77 5f64 3a0a 2020 2020  tomorrow_d:.    
-00007e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e70: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00007e80: 2020 2020 2020 2320 725b 315d 202d 3d20        # r[1] -= 
-00007e90: 7464 5f31 640a 2020 2020 2020 2020 2020  td_1d.          
-00007ea0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00007ca0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00007cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cc0: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00007cd0: 6765 506f 7374 5f74 6f5f 6665 7463 6820  gePost_to_fetch 
+00007ce0: 3d20 7966 6374 2e49 6465 6e74 6966 794d  = yfct.IdentifyM
+00007cf0: 6973 7369 6e67 496e 7465 7276 616c 5261  issingIntervalRa
+00007d00: 6e67 6573 2873 656c 662e 6578 6368 616e  nges(self.exchan
+00007d10: 6765 2c20 685f 656e 642c 2074 6172 6765  ge, h_end, targe
+00007d20: 745f 656e 645f 642c 2073 656c 662e 696e  t_end_d, self.in
+00007d30: 7465 7276 616c 2c20 4e6f 6e65 2c20 6d69  terval, None, mi
+00007d40: 6e44 6973 7461 6e63 6554 6872 6573 686f  nDistanceThresho
+00007d50: 6c64 3d35 290a 2020 2020 2020 2020 2020  ld=5).          
+00007d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d70: 2020 2020 2020 6578 6365 7074 2079 6663        except yfc
+00007d80: 642e 4e6f 496e 7465 7276 616c 7349 6e52  d.NoIntervalsInR
+00007d90: 616e 6765 4578 6365 7074 696f 6e3a 0a20  angeException:. 
+00007da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007dc0: 2020 2072 616e 6765 506f 7374 5f74 6f5f     rangePost_to_
+00007dd0: 6665 7463 6820 3d20 4e6f 6e65 0a20 2020  fetch = None.   
+00007de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007df0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e10: 2020 2020 2020 2069 6620 7261 6e67 6550         if rangeP
+00007e20: 7265 5f74 6f5f 6665 7463 6820 6973 206e  re_to_fetch is n
+00007e30: 6f74 204e 6f6e 6520 6f72 2065 6e64 203e  ot None or end >
+00007e40: 2068 5f65 6e64 3a0a 2020 2020 2020 2020   h_end:.        
+00007e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e60: 2020 2020 2020 2020 7461 7267 6574 5f65          target_e
+00007e70: 6e64 5f64 7420 3d20 6474 5f6e 6f77 0a20  nd_dt = dt_now. 
+00007e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007e90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00007ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00007eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ec0: 7261 6e67 6550 6f73 745f 746f 5f66 6574  rangePost_to_fet
-00007ed0: 6368 5b69 5d20 3d20 2872 5b30 5d2c 2072  ch[i] = (r[0], r
-00007ee0: 5b31 5d20 2d20 7464 5f31 6429 0a20 2020  [1] - td_1d).   
-00007ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f00: 2023 2020 2020 2020 2020 2020 2020 2020   #              
-00007f10: 2020 2020 2020 2069 6620 725b 315d 203d         if r[1] =
-00007f20: 3d20 725b 305d 3a0a 2020 2020 2020 2020  = r[0]:.        
-00007f30: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00007f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f50: 2020 2020 2020 6465 6c20 7261 6e67 6550        del rangeP
-00007f60: 6f73 745f 746f 5f66 6574 6368 5b69 5d0a  ost_to_fetch[i].
-00007f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f80: 2020 2020 2320 2020 2020 2020 2020 6966      #         if
-00007f90: 206c 656e 2872 616e 6765 506f 7374 5f74   len(rangePost_t
-00007fa0: 6f5f 6665 7463 6829 203d 3d20 303a 0a20  o_fetch) == 0:. 
-00007fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fc0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00007fd0: 2072 616e 6765 506f 7374 5f74 6f5f 6665   rangePost_to_fe
-00007fe0: 7463 6820 3d20 4e6f 6e65 0a20 2020 2020  tch = None.     
-00007ff0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00008000: 616e 6765 735f 746f 5f66 6574 6368 203d  anges_to_fetch =
-00008010: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00008020: 2020 2020 2020 2020 6966 2072 616e 6765          if range
-00008030: 506f 7374 5f74 6f5f 6665 7463 6820 6973  Post_to_fetch is
-00008040: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00007ec0: 2074 6172 6765 745f 656e 645f 6474 203d   target_end_dt =
+00007ed0: 2065 6e64 0a20 2020 2020 2020 2020 2020   end.           
+00007ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ef0: 2064 203d 2074 6172 6765 745f 656e 645f   d = target_end_
+00007f00: 6474 2e61 7374 696d 657a 6f6e 6528 747a  dt.astimezone(tz
+00007f10: 5f65 7863 6861 6e67 6529 2e64 6174 6528  _exchange).date(
+00007f20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00007f30: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00007f40: 6865 6420 3d20 7966 6374 2e47 6574 4578  hed = yfct.GetEx
+00007f50: 6368 616e 6765 5363 6865 6475 6c65 2873  changeSchedule(s
+00007f60: 656c 662e 6578 6368 616e 6765 2c20 642c  elf.exchange, d,
+00007f70: 2064 202b 2074 645f 3164 290a 2020 2020   d + td_1d).    
+00007f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f90: 2020 2020 2020 2020 6966 2028 7363 6865          if (sche
+00007fa0: 6420 6973 206e 6f74 204e 6f6e 6529 2061  d is not None) a
+00007fb0: 6e64 2028 6e6f 7420 7363 6865 642e 656d  nd (not sched.em
+00007fc0: 7074 7929 2061 6e64 2028 6474 5f6e 6f77  pty) and (dt_now
+00007fd0: 203e 2073 6368 6564 5b22 6f70 656e 225d   > sched["open"]
+00007fe0: 2e69 6c6f 635b 305d 293a 0a20 2020 2020  .iloc[0]):.     
+00007ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008000: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+00008010: 745f 656e 645f 6474 203d 2073 6368 6564  t_end_dt = sched
+00008020: 5b22 636c 6f73 6522 5d2e 696c 6f63 5b30  ["close"].iloc[0
+00008030: 5d2b 7469 6d65 6465 6c74 6128 686f 7572  ]+timedelta(hour
+00008040: 733d 3229 0a20 2020 2020 2020 2020 2020  s=2).           
 00008050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008060: 2020 2069 6620 6c65 6e28 7261 6e67 6550     if len(rangeP
-00008070: 6f73 745f 746f 5f66 6574 6368 2920 3e20  ost_to_fetch) > 
-00008080: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00008090: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000080a0: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
-000080b0: 4578 7065 6374 6564 206f 6e6c 7920 6f6e  Expected only on
-000080c0: 6520 656c 656d 656e 7420 696e 2072 616e  e element in ran
-000080d0: 6765 506f 7374 5f74 6f5f 6665 7463 685b  gePost_to_fetch[
-000080e0: 5d2c 2062 7574 203d 207b 7d22 2e66 6f72  ], but = {}".for
-000080f0: 6d61 7428 7261 6e67 6550 6f73 745f 746f  mat(rangePost_to
-00008100: 5f66 6574 6368 2929 0a20 2020 2020 2020  _fetch)).       
-00008110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008120: 2072 616e 6765 506f 7374 5f74 6f5f 6665   rangePost_to_fe
-00008130: 7463 6820 3d20 7261 6e67 6550 6f73 745f  tch = rangePost_
-00008140: 746f 5f66 6574 6368 5b30 5d0a 2020 2020  to_fetch[0].    
+00008060: 2069 6620 685f 656e 6420 3c20 7461 7267   if h_end < targ
+00008070: 6574 5f65 6e64 5f64 743a 0a20 2020 2020  et_end_dt:.     
+00008080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008090: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+000080a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000080c0: 2020 2020 7261 6e67 6550 6f73 745f 746f      rangePost_to
+000080d0: 5f66 6574 6368 203d 2079 6663 742e 4964  _fetch = yfct.Id
+000080e0: 656e 7469 6679 4d69 7373 696e 6749 6e74  entifyMissingInt
+000080f0: 6572 7661 6c52 616e 6765 7328 7365 6c66  ervalRanges(self
+00008100: 2e65 7863 6861 6e67 652c 2068 5f65 6e64  .exchange, h_end
+00008110: 2c20 7461 7267 6574 5f65 6e64 5f64 742c  , target_end_dt,
+00008120: 2073 656c 662e 696e 7465 7276 616c 2c20   self.interval, 
+00008130: 4e6f 6e65 2c20 6d69 6e44 6973 7461 6e63  None, minDistanc
+00008140: 6554 6872 6573 686f 6c64 3d35 290a 2020  eThreshold=5).  
 00008150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008160: 6966 2072 616e 6765 5072 655f 746f 5f66  if rangePre_to_f
-00008170: 6574 6368 2069 7320 6e6f 7420 4e6f 6e65  etch is not None
-00008180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008190: 2020 2020 2020 2020 2020 7261 6e67 6573            ranges
-000081a0: 5f74 6f5f 6665 7463 682e 6170 7065 6e64  _to_fetch.append
-000081b0: 2872 616e 6765 5072 655f 746f 5f66 6574  (rangePre_to_fet
-000081c0: 6368 290a 2020 2020 2020 2020 2020 2020  ch).            
-000081d0: 2020 2020 2020 2020 6966 2072 616e 6765          if range
-000081e0: 506f 7374 5f74 6f5f 6665 7463 6820 6973  Post_to_fetch is
-000081f0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00008160: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00008170: 6365 7074 2079 6663 642e 4e6f 496e 7465  cept yfcd.NoInte
+00008180: 7276 616c 7349 6e52 616e 6765 4578 6365  rvalsInRangeExce
+00008190: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+000081a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081b0: 2020 2020 2020 2020 2020 2072 616e 6765             range
+000081c0: 506f 7374 5f74 6f5f 6665 7463 6820 3d20  Post_to_fetch = 
+000081d0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000081e0: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
+000081f0: 746f 5f66 6574 6368 203d 205b 5d0a 2020  to_fetch = [].  
 00008200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008210: 2020 2072 616e 6765 735f 746f 5f66 6574     ranges_to_fet
-00008220: 6368 2e61 7070 656e 6428 7261 6e67 6550  ch.append(rangeP
-00008230: 6f73 745f 746f 5f66 6574 6368 290a 2020  ost_to_fetch).  
-00008240: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00008250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008260: 685f 696e 7465 7276 616c 7320 3d20 7966  h_intervals = yf
-00008270: 6374 2e47 6574 5469 6d65 7374 616d 7043  ct.GetTimestampC
-00008280: 7572 7265 6e74 496e 7465 7276 616c 5f62  urrentInterval_b
-00008290: 6174 6368 2873 656c 662e 6578 6368 616e  atch(self.exchan
-000082a0: 6765 2c20 685f 696e 7465 7276 616c 5f64  ge, h_interval_d
-000082b0: 7473 2c20 7365 6c66 2e69 6e74 6572 7661  ts, self.interva
-000082c0: 6c2c 2069 676e 6f72 655f 6272 6561 6b73  l, ignore_breaks
-000082d0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-000082e0: 2020 2020 2020 2069 6620 685f 696e 7465         if h_inte
-000082f0: 7276 616c 7320 6973 204e 6f6e 653a 0a20  rvals is None:. 
-00008300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008310: 2020 2068 5f69 6e74 6572 7661 6c73 203d     h_intervals =
-00008320: 2070 642e 4461 7461 4672 616d 6528 6461   pd.DataFrame(da
-00008330: 7461 3d7b 2269 6e74 6572 7661 6c5f 6f70  ta={"interval_op
-00008340: 656e 223a 205b 5d2c 2022 696e 7465 7276  en": [], "interv
-00008350: 616c 5f63 6c6f 7365 223a 205b 5d7d 290a  al_close": []}).
-00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008370: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00008380: 2020 2020 2020 2020 2020 665f 6e61 203d            f_na =
-00008390: 2068 5f69 6e74 6572 7661 6c73 5b22 696e   h_intervals["in
-000083a0: 7465 7276 616c 5f6f 7065 6e22 5d2e 6973  terval_open"].is
-000083b0: 6e61 2829 2e74 6f5f 6e75 6d70 7928 290a  na().to_numpy().
-000083c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083d0: 2020 2020 6966 2066 5f6e 612e 616e 7928      if f_na.any(
-000083e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000083f0: 2020 2020 2020 2020 2020 2023 204d 6170             # Map
-00008400: 7069 6e67 2059 6168 6f6f 2069 6e74 6572  ping Yahoo inter
-00008410: 7661 6c73 202d 3e20 7863 616c 2063 616e  vals -> xcal can
-00008420: 2066 6169 6c20 6e6f 772c 2062 6563 6175   fail now, becau
-00008430: 7365 2073 6f6d 6574 696d 6520 7863 616c  se sometime xcal
-00008440: 2069 7320 7772 6f6e 672e 0a20 2020 2020   is wrong..     
-00008450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008460: 2020 2023 204e 6565 6420 746f 2074 6f6c     # Need to tol
-00008470: 6572 6174 650a 2020 2020 2020 2020 2020  erate.          
-00008480: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-00008490: 696e 7465 7276 616c 732e 6c6f 635b 665f  intervals.loc[f_
-000084a0: 6e61 2c20 2269 6e74 6572 7661 6c5f 6f70  na, "interval_op
-000084b0: 656e 225d 203d 2068 5f69 6e74 6572 7661  en"] = h_interva
-000084c0: 6c5f 6474 735b 665f 6e61 5d0a 2020 2020  l_dts[f_na].    
-000084d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084e0: 2020 2020 685f 696e 7465 7276 616c 732e      h_intervals.
-000084f0: 6c6f 635b 665f 6e61 2c20 2269 6e74 6572  loc[f_na, "inter
-00008500: 7661 6c5f 636c 6f73 6522 5d20 3d20 685f  val_close"] = h_
-00008510: 696e 7465 7276 616c 5f64 7473 5b66 5f6e  interval_dts[f_n
-00008520: 615d 2b73 656c 662e 6974 640a 2020 2020  a]+self.itd.    
-00008530: 2020 2020 2020 2020 2020 2020 2320 665f              # f_
-00008540: 6e61 203d 2068 5f69 6e74 6572 7661 6c73  na = h_intervals
-00008550: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
-00008560: 5d2e 6973 6e61 2829 2e74 6f5f 6e75 6d70  ].isna().to_nump
-00008570: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00008580: 2020 2020 2320 6966 2066 5f6e 612e 616e      # if f_na.an
-00008590: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-000085a0: 2020 2020 2023 2020 2020 2070 7269 6e74       #     print
-000085b0: 2873 656c 662e 685b 665f 6e61 5d29 0a20  (self.h[f_na]). 
-000085c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000085d0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-000085e0: 7469 6f6e 2822 4261 6420 726f 7773 2066  tion("Bad rows f
-000085f0: 6f75 6e64 2069 6e20 7072 6963 6573 2074  ound in prices t
-00008600: 6162 6c65 2229 0a20 2020 2020 2020 2020  able").         
-00008610: 2020 2020 2020 2023 2020 2020 2069 6620         #     if 
-00008620: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
-00008630: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00008640: 2020 2020 2070 7269 6e74 2822 2d20 666f       print("- fo
-00008650: 756e 6420 6261 6420 726f 7773 2c20 6465  und bad rows, de
-00008660: 6c65 7469 6e67 3a22 290a 2020 2020 2020  leting:").      
-00008670: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00008680: 2020 2020 7072 696e 7428 7365 6c66 2e68      print(self.h
-00008690: 5b66 5f6e 615d 290a 2020 2020 2020 2020  [f_na]).        
-000086a0: 2020 2020 2020 2020 2320 2020 2020 7365          #     se
-000086b0: 6c66 2e68 203d 2073 656c 662e 685b 7e66  lf.h = self.h[~f
-000086c0: 5f6e 615d 2e63 6f70 7928 290a 2020 2020  _na].copy().    
-000086d0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-000086e0: 2020 685f 696e 7465 7276 616c 7320 3d20    h_intervals = 
-000086f0: 685f 696e 7465 7276 616c 735b 7e66 5f6e  h_intervals[~f_n
-00008700: 615d 0a20 2020 2020 2020 2020 2020 2020  a].             
-00008710: 2020 2069 6620 286e 6f74 2068 5f69 6e74     if (not h_int
-00008720: 6572 7661 6c73 2e65 6d70 7479 2920 616e  ervals.empty) an
-00008730: 6420 6973 696e 7374 616e 6365 2868 5f69  d isinstance(h_i
-00008740: 6e74 6572 7661 6c73 5b22 696e 7465 7276  ntervals["interv
-00008750: 616c 5f6f 7065 6e22 5d5b 305d 2c20 6461  al_open"][0], da
-00008760: 7465 7469 6d65 293a 0a20 2020 2020 2020  tetime):.       
-00008770: 2020 2020 2020 2020 2020 2020 2068 5f69               h_i
-00008780: 6e74 6572 7661 6c5f 6f70 656e 7320 3d20  nterval_opens = 
-00008790: 5b78 2e74 6f5f 7079 6461 7465 7469 6d65  [x.to_pydatetime
-000087a0: 2829 2e61 7374 696d 657a 6f6e 6528 747a  ().astimezone(tz
-000087b0: 5f65 7863 6861 6e67 6529 2066 6f72 2078  _exchange) for x
-000087c0: 2069 6e20 685f 696e 7465 7276 616c 735b   in h_intervals[
-000087d0: 2269 6e74 6572 7661 6c5f 6f70 656e 225d  "interval_open"]
-000087e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000087f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00008800: 2020 2020 2020 2020 2020 2020 685f 696e              h_in
-00008810: 7465 7276 616c 5f6f 7065 6e73 203d 2068  terval_opens = h
-00008820: 5f69 6e74 6572 7661 6c73 5b22 696e 7465  _intervals["inte
-00008830: 7276 616c 5f6f 7065 6e22 5d2e 746f 5f6e  rval_open"].to_n
-00008840: 756d 7079 2829 0a0a 2020 2020 2020 2020  umpy()..        
-00008850: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00008860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008870: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
-00008880: 203d 2079 6663 742e 4964 656e 7469 6679   = yfct.Identify
-00008890: 4d69 7373 696e 6749 6e74 6572 7661 6c52  MissingIntervalR
-000088a0: 616e 6765 7328 7365 6c66 2e65 7863 6861  anges(self.excha
-000088b0: 6e67 652c 2073 7461 7274 2c20 656e 642c  nge, start, end,
-000088c0: 2073 656c 662e 696e 7465 7276 616c 2c20   self.interval, 
-000088d0: 685f 696e 7465 7276 616c 5f6f 7065 6e73  h_interval_opens
-000088e0: 2c20 6967 6e6f 7265 5f62 7265 616b 733d  , ignore_breaks=
-000088f0: 5472 7565 2c20 6d69 6e44 6973 7461 6e63  True, minDistanc
-00008900: 6554 6872 6573 686f 6c64 3d35 290a 2020  eThreshold=5).  
-00008910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008920: 2020 6966 2072 616e 6765 735f 746f 5f66    if ranges_to_f
-00008930: 6574 6368 2069 7320 4e6f 6e65 3a0a 2020  etch is None:.  
-00008940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008950: 2020 2020 2020 7261 6e67 6573 5f74 6f5f        ranges_to_
-00008960: 6665 7463 6820 3d20 5b5d 0a20 2020 2020  fetch = [].     
-00008970: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00008980: 7420 7966 6364 2e4e 6f49 6e74 6572 7661  t yfcd.NoInterva
-00008990: 6c73 496e 5261 6e67 6545 7863 6570 7469  lsInRangeExcepti
-000089a0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-000089b0: 2020 2020 2020 2020 7261 6e67 6573 5f74          ranges_t
-000089c0: 6f5f 6665 7463 6820 3d20 5b5d 0a20 2020  o_fetch = [].   
-000089d0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-000089e0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-000089f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a00: 2020 2070 7269 6e74 2822 5469 636b 6572     print("Ticker
-00008a10: 203d 222c 2073 656c 662e 7469 636b 6572   =", self.ticker
-00008a20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008a30: 2020 2020 2020 7261 6973 650a 2020 2020        raise.    
-00008a40: 2020 2020 2020 2020 2320 5072 756e 6520          # Prune 
-00008a50: 7261 6e67 6573 2069 6e20 6675 7475 7265  ranges in future
-00008a60: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00008a70: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-00008a80: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
-00008a90: 292d 312c 202d 312c 202d 3129 3a0a 2020  )-1, -1, -1):.  
-00008aa0: 2020 2020 2020 2020 2020 2020 2020 7220                r 
-00008ab0: 3d20 7261 6e67 6573 5f74 6f5f 6665 7463  = ranges_to_fetc
-00008ac0: 685b 695d 0a20 2020 2020 2020 2020 2020  h[i].           
-00008ad0: 2020 2020 2078 203d 2072 5b30 5d0a 2020       x = r[0].  
-00008ae0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-00008af0: 6c65 7465 5f72 616e 6765 203d 2046 616c  lete_range = Fal
-00008b00: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00008b10: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00008b20: 2878 2c20 2864 6174 6574 696d 652c 2070  (x, (datetime, p
-00008b30: 642e 5469 6d65 7374 616d 7029 293a 0a20  d.Timestamp)):. 
-00008b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008b50: 2020 2069 6620 7820 3e20 6474 5f6e 6f77     if x > dt_now
-00008b60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008b70: 2020 2020 2020 2020 2020 6465 6c65 7465            delete
-00008b80: 5f72 616e 6765 203d 2054 7275 650a 2020  _range = True.  
-00008b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00008bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bc0: 7363 6865 6420 3d20 7966 6374 2e47 6574  sched = yfct.Get
-00008bd0: 4578 6368 616e 6765 5363 6865 6475 6c65  ExchangeSchedule
-00008be0: 2873 656c 662e 6578 6368 616e 6765 2c20  (self.exchange, 
-00008bf0: 782e 6461 7465 2829 2c20 782e 6461 7465  x.date(), x.date
-00008c00: 2829 202b 2074 645f 3164 290a 2020 2020  () + td_1d).    
-00008c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008c20: 2020 2020 6465 6c65 7465 5f72 616e 6765      delete_range
-00008c30: 203d 2028 7363 6865 6420 6973 206e 6f74   = (sched is not
-00008c40: 204e 6f6e 6529 2061 6e64 2064 745f 6e6f   None) and dt_no
-00008c50: 7720 3c20 2873 6368 6564 5b22 6f70 656e  w < (sched["open
-00008c60: 225d 2e69 6c6f 635b 305d 202b 2079 665f  "].iloc[0] + yf_
-00008c70: 6c61 6729 0a20 2020 2020 2020 2020 2020  lag).           
-00008c80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00008c90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00008ca0: 6620 6461 7465 7469 6d65 2e63 6f6d 6269  f datetime.combi
-00008cb0: 6e65 2878 2c20 7469 6d65 2830 292c 2074  ne(x, time(0), t
-00008cc0: 7a69 6e66 6f3d 747a 5f65 7863 6861 6e67  zinfo=tz_exchang
-00008cd0: 6529 203e 2064 745f 6e6f 773a 0a20 2020  e) > dt_now:.   
-00008ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008cf0: 2020 2020 2064 656c 6574 655f 7261 6e67       delete_rang
-00008d00: 6520 3d20 5472 7565 0a20 2020 2020 2020  e = True.       
-00008d10: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00008d20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00008d30: 2020 2020 2020 2020 2020 2073 6368 6564             sched
-00008d40: 203d 2079 6663 742e 4765 7445 7863 6861   = yfct.GetExcha
-00008d50: 6e67 6553 6368 6564 756c 6528 7365 6c66  ngeSchedule(self
-00008d60: 2e65 7863 6861 6e67 652c 2078 2c20 7820  .exchange, x, x 
-00008d70: 2b20 7464 5f31 6429 0a20 2020 2020 2020  + td_1d).       
-00008d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d90: 2064 656c 6574 655f 7261 6e67 6520 3d20   delete_range = 
-00008da0: 2873 6368 6564 2069 7320 6e6f 7420 4e6f  (sched is not No
-00008db0: 6e65 2920 616e 6420 6474 5f6e 6f77 203c  ne) and dt_now <
-00008dc0: 2028 7363 6865 645b 226f 7065 6e22 5d2e   (sched["open"].
-00008dd0: 696c 6f63 5b30 5d20 2b20 7966 5f6c 6167  iloc[0] + yf_lag
-00008de0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008df0: 2020 6966 2064 656c 6574 655f 7261 6e67    if delete_rang
-00008e00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00008e10: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
-00008e20: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
-00008e30: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00008e40: 6e74 2822 2d20 6465 6c65 7469 6e67 2066  nt("- deleting f
-00008e50: 7574 7572 6520 7261 6e67 653a 222c 2072  uture range:", r
-00008e60: 616e 6765 735f 746f 5f66 6574 6368 5b69  anges_to_fetch[i
-00008e70: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00008e80: 2020 2020 2020 2064 656c 2072 616e 6765         del range
-00008e90: 735f 746f 5f66 6574 6368 5b69 5d0a 2020  s_to_fetch[i].  
-00008ea0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00008eb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008ec0: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-00008ed0: 6966 2072 616e 6765 2065 6e64 7320 696e  if range ends in
-00008ee0: 2066 7574 7572 652c 2069 6620 7965 7320   future, if yes 
-00008ef0: 7468 656e 2061 646a 7573 7420 746f 2074  then adjust to t
-00008f00: 6f6d 6f72 726f 7720 6d61 780a 2020 2020  omorrow max.    
-00008f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f20: 7920 3d20 725b 315d 0a20 2020 2020 2020  y = r[1].       
-00008f30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00008f40: 6973 696e 7374 616e 6365 2879 2c20 2864  isinstance(y, (d
-00008f50: 6174 6574 696d 652c 2070 642e 5469 6d65  atetime, pd.Time
-00008f60: 7374 616d 7029 2920 616e 6420 7920 3e20  stamp)) and y > 
-00008f70: 6474 5f6e 6f77 3a0a 2020 2020 2020 2020  dt_now:.        
+00008210: 2020 6966 2072 616e 6765 506f 7374 5f74    if rangePost_t
+00008220: 6f5f 6665 7463 6820 6973 206e 6f74 204e  o_fetch is not N
+00008230: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00008240: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00008250: 6c65 6e28 7261 6e67 6550 6f73 745f 746f  len(rangePost_to
+00008260: 5f66 6574 6368 2920 3e20 313a 0a20 2020  _fetch) > 1:.   
+00008270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008280: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+00008290: 7863 6570 7469 6f6e 2822 4578 7065 6374  xception("Expect
+000082a0: 6564 206f 6e6c 7920 6f6e 6520 656c 656d  ed only one elem
+000082b0: 656e 7420 696e 2072 616e 6765 506f 7374  ent in rangePost
+000082c0: 5f74 6f5f 6665 7463 685b 5d2c 2062 7574  _to_fetch[], but
+000082d0: 203d 207b 7d22 2e66 6f72 6d61 7428 7261   = {}".format(ra
+000082e0: 6e67 6550 6f73 745f 746f 5f66 6574 6368  ngePost_to_fetch
+000082f0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00008300: 2020 2020 2020 2020 2020 2072 616e 6765             range
+00008310: 506f 7374 5f74 6f5f 6665 7463 6820 3d20  Post_to_fetch = 
+00008320: 7261 6e67 6550 6f73 745f 746f 5f66 6574  rangePost_to_fet
+00008330: 6368 5b30 5d0a 2020 2020 2020 2020 2020  ch[0].          
+00008340: 2020 2020 2020 2020 2020 6966 2072 616e            if ran
+00008350: 6765 5072 655f 746f 5f66 6574 6368 2069  gePre_to_fetch i
+00008360: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00008370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008380: 2020 2020 7261 6e67 6573 5f74 6f5f 6665      ranges_to_fe
+00008390: 7463 682e 6170 7065 6e64 2872 616e 6765  tch.append(range
+000083a0: 5072 655f 746f 5f66 6574 6368 290a 2020  Pre_to_fetch).  
+000083b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083c0: 2020 6966 2072 616e 6765 506f 7374 5f74    if rangePost_t
+000083d0: 6f5f 6665 7463 6820 6973 206e 6f74 204e  o_fetch is not N
+000083e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000083f0: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00008400: 6765 735f 746f 5f66 6574 6368 2e61 7070  ges_to_fetch.app
+00008410: 656e 6428 7261 6e67 6550 6f73 745f 746f  end(rangePost_to
+00008420: 5f66 6574 6368 290a 2020 2020 2020 2020  _fetch).        
+00008430: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00008440: 2020 2020 2020 2020 2020 685f 696e 7465            h_inte
+00008450: 7276 616c 7320 3d20 7966 6374 2e47 6574  rvals = yfct.Get
+00008460: 5469 6d65 7374 616d 7043 7572 7265 6e74  TimestampCurrent
+00008470: 496e 7465 7276 616c 5f62 6174 6368 2873  Interval_batch(s
+00008480: 656c 662e 6578 6368 616e 6765 2c20 685f  elf.exchange, h_
+00008490: 696e 7465 7276 616c 5f64 7473 2c20 7365  interval_dts, se
+000084a0: 6c66 2e69 6e74 6572 7661 6c2c 2069 676e  lf.interval, ign
+000084b0: 6f72 655f 6272 6561 6b73 3d54 7275 6529  ore_breaks=True)
+000084c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000084d0: 2069 6620 685f 696e 7465 7276 616c 7320   if h_intervals 
+000084e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000084f0: 2020 2020 2020 2020 2020 2020 2068 5f69               h_i
+00008500: 6e74 6572 7661 6c73 203d 2070 642e 4461  ntervals = pd.Da
+00008510: 7461 4672 616d 6528 6461 7461 3d7b 2269  taFrame(data={"i
+00008520: 6e74 6572 7661 6c5f 6f70 656e 223a 205b  nterval_open": [
+00008530: 5d2c 2022 696e 7465 7276 616c 5f63 6c6f  ], "interval_clo
+00008540: 7365 223a 205b 5d7d 290a 2020 2020 2020  se": []}).      
+00008550: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00008560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008570: 2020 2020 665f 6e61 203d 2068 5f69 6e74      f_na = h_int
+00008580: 6572 7661 6c73 5b22 696e 7465 7276 616c  ervals["interval
+00008590: 5f6f 7065 6e22 5d2e 6973 6e61 2829 2e74  _open"].isna().t
+000085a0: 6f5f 6e75 6d70 7928 290a 2020 2020 2020  o_numpy().      
+000085b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000085c0: 2066 5f6e 612e 616e 7928 293a 0a20 2020   f_na.any():.   
+000085d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085e0: 2020 2020 2023 204d 6170 7069 6e67 2059       # Mapping Y
+000085f0: 6168 6f6f 2069 6e74 6572 7661 6c73 202d  ahoo intervals -
+00008600: 3e20 7863 616c 2063 616e 2066 6169 6c20  > xcal can fail 
+00008610: 6e6f 772c 2062 6563 6175 7365 2073 6f6d  now, because som
+00008620: 6574 696d 6520 7863 616c 2069 7320 7772  etime xcal is wr
+00008630: 6f6e 672e 0a20 2020 2020 2020 2020 2020  ong..           
+00008640: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+00008650: 6565 6420 746f 2074 6f6c 6572 6174 650a  eed to tolerate.
+00008660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008670: 2020 2020 2020 2020 685f 696e 7465 7276          h_interv
+00008680: 616c 732e 6c6f 635b 665f 6e61 2c20 2269  als.loc[f_na, "i
+00008690: 6e74 6572 7661 6c5f 6f70 656e 225d 203d  nterval_open"] =
+000086a0: 2068 5f69 6e74 6572 7661 6c5f 6474 735b   h_interval_dts[
+000086b0: 665f 6e61 5d0a 2020 2020 2020 2020 2020  f_na].          
+000086c0: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+000086d0: 696e 7465 7276 616c 732e 6c6f 635b 665f  intervals.loc[f_
+000086e0: 6e61 2c20 2269 6e74 6572 7661 6c5f 636c  na, "interval_cl
+000086f0: 6f73 6522 5d20 3d20 685f 696e 7465 7276  ose"] = h_interv
+00008700: 616c 5f64 7473 5b66 5f6e 615d 2b73 656c  al_dts[f_na]+sel
+00008710: 662e 6974 640a 2020 2020 2020 2020 2020  f.itd.          
+00008720: 2020 2020 2020 6966 2028 6e6f 7420 685f        if (not h_
+00008730: 696e 7465 7276 616c 732e 656d 7074 7929  intervals.empty)
+00008740: 2061 6e64 2069 7369 6e73 7461 6e63 6528   and isinstance(
+00008750: 685f 696e 7465 7276 616c 735b 2269 6e74  h_intervals["int
+00008760: 6572 7661 6c5f 6f70 656e 225d 5b30 5d2c  erval_open"][0],
+00008770: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
+00008780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008790: 685f 696e 7465 7276 616c 5f6f 7065 6e73  h_interval_opens
+000087a0: 203d 205b 782e 746f 5f70 7964 6174 6574   = [x.to_pydatet
+000087b0: 696d 6528 292e 6173 7469 6d65 7a6f 6e65  ime().astimezone
+000087c0: 2874 7a5f 6578 6368 616e 6765 2920 666f  (tz_exchange) fo
+000087d0: 7220 7820 696e 2068 5f69 6e74 6572 7661  r x in h_interva
+000087e0: 6c73 5b22 696e 7465 7276 616c 5f6f 7065  ls["interval_ope
+000087f0: 6e22 5d5d 0a20 2020 2020 2020 2020 2020  n"]].           
+00008800: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00008810: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00008820: 5f69 6e74 6572 7661 6c5f 6f70 656e 7320  _interval_opens 
+00008830: 3d20 685f 696e 7465 7276 616c 735b 2269  = h_intervals["i
+00008840: 6e74 6572 7661 6c5f 6f70 656e 225d 2e74  nterval_open"].t
+00008850: 6f5f 6e75 6d70 7928 290a 0a20 2020 2020  o_numpy()..     
+00008860: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00008870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008880: 2020 2020 7261 6e67 6573 5f74 6f5f 6665      ranges_to_fe
+00008890: 7463 6820 3d20 7966 6374 2e49 6465 6e74  tch = yfct.Ident
+000088a0: 6966 794d 6973 7369 6e67 496e 7465 7276  ifyMissingInterv
+000088b0: 616c 5261 6e67 6573 2873 656c 662e 6578  alRanges(self.ex
+000088c0: 6368 616e 6765 2c20 7374 6172 742c 2065  change, start, e
+000088d0: 6e64 2c20 7365 6c66 2e69 6e74 6572 7661  nd, self.interva
+000088e0: 6c2c 2068 5f69 6e74 6572 7661 6c5f 6f70  l, h_interval_op
+000088f0: 656e 732c 2069 676e 6f72 655f 6272 6561  ens, ignore_brea
+00008900: 6b73 3d54 7275 652c 206d 696e 4469 7374  ks=True, minDist
+00008910: 616e 6365 5468 7265 7368 6f6c 643d 3529  anceThreshold=5)
+00008920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008930: 2020 2020 2069 6620 7261 6e67 6573 5f74       if ranges_t
+00008940: 6f5f 6665 7463 6820 6973 204e 6f6e 653a  o_fetch is None:
+00008950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008960: 2020 2020 2020 2020 2072 616e 6765 735f           ranges_
+00008970: 746f 5f66 6574 6368 203d 205b 5d0a 2020  to_fetch = [].  
+00008980: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00008990: 6365 7074 2079 6663 642e 4e6f 496e 7465  cept yfcd.NoInte
+000089a0: 7276 616c 7349 6e52 616e 6765 4578 6365  rvalsInRangeExce
+000089b0: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+000089c0: 2020 2020 2020 2020 2020 2072 616e 6765             range
+000089d0: 735f 746f 5f66 6574 6368 203d 205b 5d0a  s_to_fetch = [].
+000089e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089f0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00008a00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008a10: 2020 2020 2020 7072 696e 7428 2254 6963        print("Tic
+00008a20: 6b65 7220 3d22 2c20 7365 6c66 2e74 6963  ker =", self.tic
+00008a30: 6b65 7229 0a20 2020 2020 2020 2020 2020  ker).           
+00008a40: 2020 2020 2020 2020 2072 6169 7365 0a20           raise. 
+00008a50: 2020 2020 2020 2020 2020 2023 2050 7275             # Pru
+00008a60: 6e65 2072 616e 6765 7320 696e 2066 7574  ne ranges in fut
+00008a70: 7572 653a 0a20 2020 2020 2020 2020 2020  ure:.           
+00008a80: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00008a90: 6c65 6e28 7261 6e67 6573 5f74 6f5f 6665  len(ranges_to_fe
+00008aa0: 7463 6829 2d31 2c20 2d31 2c20 2d31 293a  tch)-1, -1, -1):
+00008ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008ac0: 2072 203d 2072 616e 6765 735f 746f 5f66   r = ranges_to_f
+00008ad0: 6574 6368 5b69 5d0a 2020 2020 2020 2020  etch[i].        
+00008ae0: 2020 2020 2020 2020 7820 3d20 725b 305d          x = r[0]
+00008af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008b00: 2064 656c 6574 655f 7261 6e67 6520 3d20   delete_range = 
+00008b10: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00008b20: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00008b30: 6e63 6528 782c 2028 6461 7465 7469 6d65  nce(x, (datetime
+00008b40: 2c20 7064 2e54 696d 6573 7461 6d70 2929  , pd.Timestamp))
+00008b50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008b60: 2020 2020 2020 6966 2078 203e 2064 745f        if x > dt_
+00008b70: 6e6f 773a 0a20 2020 2020 2020 2020 2020  now:.           
+00008b80: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00008b90: 6574 655f 7261 6e67 6520 3d20 5472 7565  ete_range = True
+00008ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008bb0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00008bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bd0: 2020 2073 6368 6564 203d 2079 6663 742e     sched = yfct.
+00008be0: 4765 7445 7863 6861 6e67 6553 6368 6564  GetExchangeSched
+00008bf0: 756c 6528 7365 6c66 2e65 7863 6861 6e67  ule(self.exchang
+00008c00: 652c 2078 2e64 6174 6528 292c 2078 2e64  e, x.date(), x.d
+00008c10: 6174 6528 2920 2b20 7464 5f31 6429 0a20  ate() + td_1d). 
+00008c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c30: 2020 2020 2020 2064 656c 6574 655f 7261         delete_ra
+00008c40: 6e67 6520 3d20 2873 6368 6564 2069 7320  nge = (sched is 
+00008c50: 6e6f 7420 4e6f 6e65 2920 616e 6420 6474  not None) and dt
+00008c60: 5f6e 6f77 203c 2028 7363 6865 645b 226f  _now < (sched["o
+00008c70: 7065 6e22 5d2e 696c 6f63 5b30 5d20 2b20  pen"].iloc[0] + 
+00008c80: 7966 5f6c 6167 290a 2020 2020 2020 2020  yf_lag).        
+00008c90: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00008ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008cb0: 2020 6966 2064 6174 6574 696d 652e 636f    if datetime.co
+00008cc0: 6d62 696e 6528 782c 2074 696d 6528 3029  mbine(x, time(0)
+00008cd0: 2c20 747a 696e 666f 3d74 7a5f 6578 6368  , tzinfo=tz_exch
+00008ce0: 616e 6765 2920 3e20 6474 5f6e 6f77 3a0a  ange) > dt_now:.
+00008cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d00: 2020 2020 2020 2020 6465 6c65 7465 5f72          delete_r
+00008d10: 616e 6765 203d 2054 7275 650a 2020 2020  ange = True.    
+00008d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008d30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00008d40: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00008d50: 6865 6420 3d20 7966 6374 2e47 6574 4578  hed = yfct.GetEx
+00008d60: 6368 616e 6765 5363 6865 6475 6c65 2873  changeSchedule(s
+00008d70: 656c 662e 6578 6368 616e 6765 2c20 782c  elf.exchange, x,
+00008d80: 2078 202b 2074 645f 3164 290a 2020 2020   x + td_1d).    
+00008d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008da0: 2020 2020 6465 6c65 7465 5f72 616e 6765      delete_range
+00008db0: 203d 2028 7363 6865 6420 6973 206e 6f74   = (sched is not
+00008dc0: 204e 6f6e 6529 2061 6e64 2064 745f 6e6f   None) and dt_no
+00008dd0: 7720 3c20 2873 6368 6564 5b22 6f70 656e  w < (sched["open
+00008de0: 225d 2e69 6c6f 635b 305d 202b 2079 665f  "].iloc[0] + yf_
+00008df0: 6c61 6729 0a20 2020 2020 2020 2020 2020  lag).           
+00008e00: 2020 2020 2069 6620 6465 6c65 7465 5f72       if delete_r
+00008e10: 616e 6765 3a0a 2020 2020 2020 2020 2020  ange:.          
+00008e20: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00008e30: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+00008e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e50: 7072 696e 7428 222d 2064 656c 6574 696e  print("- deletin
+00008e60: 6720 6675 7475 7265 2072 616e 6765 3a22  g future range:"
+00008e70: 2c20 7261 6e67 6573 5f74 6f5f 6665 7463  , ranges_to_fetc
+00008e80: 685b 695d 290a 2020 2020 2020 2020 2020  h[i]).          
+00008e90: 2020 2020 2020 2020 2020 6465 6c20 7261            del ra
+00008ea0: 6e67 6573 5f74 6f5f 6665 7463 685b 695d  nges_to_fetch[i]
+00008eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008ec0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00008ed0: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+00008ee0: 636b 2069 6620 7261 6e67 6520 656e 6473  ck if range ends
+00008ef0: 2069 6e20 6675 7475 7265 2c20 6966 2079   in future, if y
+00008f00: 6573 2074 6865 6e20 6164 6a75 7374 2074  es then adjust t
+00008f10: 6f20 746f 6d6f 7272 6f77 206d 6178 0a20  o tomorrow max. 
+00008f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f30: 2020 2079 203d 2072 5b31 5d0a 2020 2020     y = r[1].    
+00008f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f50: 6966 2069 7369 6e73 7461 6e63 6528 792c  if isinstance(y,
+00008f60: 2028 6461 7465 7469 6d65 2c20 7064 2e54   (datetime, pd.T
+00008f70: 696d 6573 7461 6d70 2929 3a0a 2020 2020  imestamp)):.    
 00008f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f90: 7261 6e67 6573 5f74 6f5f 6665 7463 685b  ranges_to_fetch[
-00008fa0: 695d 5b31 5d20 3d20 6d69 6e28 6474 5f6e  i][1] = min(dt_n
-00008fb0: 6f77 2e63 6569 6c28 292c 2079 290a 2020  ow.ceil(), y).  
-00008fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008fd0: 2020 656c 6966 2079 203e 2064 5f6e 6f77    elif y > d_now
-00008fe0: 5f65 7863 6861 6e67 653a 0a20 2020 2020  _exchange:.     
+00008f90: 2020 2020 6966 2079 203e 2064 745f 6e6f      if y > dt_no
+00008fa0: 773a 0a20 2020 2020 2020 2020 2020 2020  w:.             
+00008fb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00008fc0: 616e 6765 735f 746f 5f66 6574 6368 5b69  anges_to_fetch[i
+00008fd0: 5d5b 315d 203d 206d 696e 2864 745f 6e6f  ][1] = min(dt_no
+00008fe0: 772e 6365 696c 2829 2c20 7929 0a20 2020  w.ceil(), y).   
 00008ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009000: 2020 2073 6368 6564 203d 2079 6663 742e     sched = yfct.
-00009010: 4765 7445 7863 6861 6e67 6553 6368 6564  GetExchangeSched
-00009020: 756c 6528 7365 6c66 2e65 7863 6861 6e67  ule(self.exchang
-00009030: 652c 2064 5f6e 6f77 5f65 7863 6861 6e67  e, d_now_exchang
-00009040: 652c 2079 202b 2074 645f 3164 290a 2020  e, y + td_1d).  
-00009050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009060: 2020 2020 2020 6966 2073 6368 6564 2069        if sched i
-00009070: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00009000: 2065 6c69 6620 7920 3e20 645f 6e6f 775f   elif y > d_now_
+00009010: 6578 6368 616e 6765 3a0a 2020 2020 2020  exchange:.      
+00009020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009030: 2020 7363 6865 6420 3d20 7966 6374 2e47    sched = yfct.G
+00009040: 6574 4578 6368 616e 6765 5363 6865 6475  etExchangeSchedu
+00009050: 6c65 2873 656c 662e 6578 6368 616e 6765  le(self.exchange
+00009060: 2c20 645f 6e6f 775f 6578 6368 616e 6765  , d_now_exchange
+00009070: 2c20 7920 2b20 7464 5f31 6429 0a20 2020  , y + td_1d).   
 00009080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009090: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-000090a0: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+00009090: 2020 2020 2069 6620 7363 6865 6420 6973       if sched is
+000090a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
 000090b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090c0: 2020 2020 2020 7072 696e 7428 222d 2063        print("- c
-000090d0: 6170 7069 6e67 206c 6173 7420 7261 6e67  apping last rang
-000090e0: 655f 746f 5f66 6574 6368 2065 6e64 2074  e_to_fetch end t
-000090f0: 6f20 645f 6e6f 775f 6578 6368 616e 6765  o d_now_exchange
-00009100: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00009110: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009120: 6620 6474 5f6e 6f77 203c 2073 6368 6564  f dt_now < sched
-00009130: 5b22 6f70 656e 225d 2e69 6c6f 635b 305d  ["open"].iloc[0]
-00009140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009160: 2020 7261 6e67 6573 5f74 6f5f 6665 7463    ranges_to_fetc
-00009170: 685b 695d 203d 2028 725b 305d 2c20 645f  h[i] = (r[0], d_
-00009180: 6e6f 775f 6578 6368 616e 6765 290a 2020  now_exchange).  
-00009190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000091b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090c0: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
+000090d0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
+000090e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090f0: 2020 2020 2070 7269 6e74 2822 2d20 6361       print("- ca
+00009100: 7070 696e 6720 6c61 7374 2072 616e 6765  pping last range
+00009110: 5f74 6f5f 6665 7463 6820 656e 6420 746f  _to_fetch end to
+00009120: 2064 5f6e 6f77 5f65 7863 6861 6e67 6522   d_now_exchange"
+00009130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009140: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00009150: 2064 745f 6e6f 7720 3c20 7363 6865 645b   dt_now < sched[
+00009160: 226f 7065 6e22 5d2e 696c 6f63 5b30 5d3a  "open"].iloc[0]:
+00009170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009190: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
+000091a0: 5b69 5d20 3d20 2872 5b30 5d2c 2064 5f6e  [i] = (r[0], d_n
+000091b0: 6f77 5f65 7863 6861 6e67 6529 0a20 2020  ow_exchange).   
 000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091d0: 7261 6e67 6573 5f74 6f5f 6665 7463 685b  ranges_to_fetch[
-000091e0: 695d 203d 2028 725b 305d 2c20 645f 6e6f  i] = (r[0], d_no
-000091f0: 775f 6578 6368 616e 6765 202b 2074 645f  w_exchange + td_
-00009200: 3164 290a 0a20 2020 2020 2020 2020 2020  1d)..           
-00009210: 2023 2049 6d70 6f72 7461 6e74 2074 6861   # Important tha
-00009220: 7420 7261 6e67 6573 5f74 6f5f 6665 7463  t ranges_to_fetc
-00009230: 6820 696e 2072 6576 6572 7365 206f 7264  h in reverse ord
-00009240: 6572 210a 2020 2020 2020 2020 2020 2020  er!.            
-00009250: 7261 6e67 6573 5f74 6f5f 6665 7463 682e  ranges_to_fetch.
-00009260: 736f 7274 286b 6579 3d6c 616d 6264 6120  sort(key=lambda 
-00009270: 783a 2078 5b30 5d2c 2072 6576 6572 7365  x: x[0], reverse
-00009280: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-00009290: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
-000092a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000092b0: 2070 7269 6e74 2822 2d20 7261 6e67 6573   print("- ranges
-000092c0: 5f74 6f5f 6665 7463 683a 2229 0a20 2020  _to_fetch:").   
-000092d0: 2020 2020 2020 2020 2020 2020 2070 7072               ppr
-000092e0: 696e 7428 7261 6e67 6573 5f74 6f5f 6665  int(ranges_to_fe
-000092f0: 7463 6829 0a0a 2020 2020 2020 2020 2020  tch)..          
-00009300: 2020 6966 206c 656e 2872 616e 6765 735f    if len(ranges_
-00009310: 746f 5f66 6574 6368 2920 3e20 303a 0a20  to_fetch) > 0:. 
-00009320: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009330: 6620 6e6f 7420 7365 6c66 2e68 2e65 6d70  f not self.h.emp
-00009340: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00009350: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00009360: 206f 6e6c 7920 6f6e 6520 7261 6e67 6520   only one range 
-00009370: 6d61 7820 6973 2061 6674 6572 2063 6163  max is after cac
-00009380: 6865 6420 6461 7461 3a0a 2020 2020 2020  hed data:.      
-00009390: 2020 2020 2020 2020 2020 2020 2020 685f                h_
-000093a0: 6c61 7374 5f64 7420 3d20 7365 6c66 2e68  last_dt = self.h
-000093b0: 2e69 6e64 6578 5b2d 315d 2e74 6f5f 7079  .index[-1].to_py
-000093c0: 6461 7465 7469 6d65 2829 0a20 2020 2020  datetime().     
-000093d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000093e0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-000093f0: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
-00009400: 5b30 5d5b 305d 2c20 6461 7465 7469 6d65  [0][0], datetime
-00009410: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00009420: 2020 2020 2020 2020 2020 2068 5f6c 6173             h_las
-00009430: 745f 6474 203d 2068 5f6c 6173 745f 6474  t_dt = h_last_dt
-00009440: 2e61 7374 696d 657a 6f6e 6528 747a 5f65  .astimezone(tz_e
-00009450: 7863 6861 6e67 6529 2e64 6174 6528 290a  xchange).date().
-00009460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009470: 2020 2020 6e20 3d20 300a 2020 2020 2020      n = 0.      
-00009480: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00009490: 7220 7220 696e 2072 616e 6765 735f 746f  r r in ranges_to
-000094a0: 5f66 6574 6368 3a0a 2020 2020 2020 2020  _fetch:.        
-000094b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094c0: 6966 2072 5b30 5d20 3e20 685f 6c61 7374  if r[0] > h_last
-000094d0: 5f64 743a 0a20 2020 2020 2020 2020 2020  _dt:.           
-000094e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000094f0: 206e 202b 3d20 310a 2020 2020 2020 2020   n += 1.        
-00009500: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00009510: 203e 2031 3a0a 2020 2020 2020 2020 2020   > 1:.          
-00009520: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00009530: 696e 7428 2272 616e 6765 735f 746f 5f66  int("ranges_to_f
-00009540: 6574 6368 3a22 290a 2020 2020 2020 2020  etch:").        
-00009550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009560: 7070 7269 6e74 2872 616e 6765 735f 746f  pprint(ranges_to
-00009570: 5f66 6574 6368 290a 2020 2020 2020 2020  _fetch).        
-00009580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009590: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-000095a0: 2272 616e 6765 735f 746f 5f66 6574 6368  "ranges_to_fetch
-000095b0: 2063 6f6e 7461 696e 7320 7b7d 2072 616e   contains {} ran
-000095c0: 6765 7320 7468 6174 206f 6363 7572 2061  ges that occur a
-000095d0: 6674 6572 2068 5f6c 6173 745f 6474 3d7b  fter h_last_dt={
-000095e0: 7d2c 2065 7870 6563 7465 6420 3120 6d61  }, expected 1 ma
-000095f0: 7822 2e66 6f72 6d61 7428 6e2c 2068 5f6c  x".format(n, h_l
-00009600: 6173 745f 6474 2929 0a0a 2020 2020 2020  ast_dt))..      
-00009610: 2020 2020 2020 2020 2020 2320 6966 206e            # if n
-00009620: 6f74 2071 7569 6574 3a0a 2020 2020 2020  ot quiet:.      
-00009630: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00009640: 7175 6965 7420 3d20 7065 7269 6f64 2069  quiet = period i
-00009650: 7320 6e6f 7420 4e6f 6e65 2020 2320 5946  s not None  # YF
-00009660: 4320 6765 6e65 7261 7465 6420 6461 7465  C generated date
-00009670: 2072 616e 6765 2073 6f20 646f 6e27 7420   range so don't 
-00009680: 7072 696e 7420 6d65 7373 6167 650a 2020  print message.  
-00009690: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000096a0: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
-000096b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096c0: 7175 6965 7420 3d20 4661 6c73 650a 2020  quiet = False.  
-000096d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096e0: 2020 2320 7175 6965 7420 3d20 6e6f 7420    # quiet = not 
-000096f0: 6465 6275 675f 7966 630a 2020 2020 2020  debug_yfc.      
-00009700: 2020 2020 2020 2020 2020 2320 6966 2073            # if s
-00009710: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-00009720: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
-00009730: 7973 313a 0a20 2020 2020 2020 2020 2020  ys1:.           
-00009740: 2020 2020 2069 6620 7365 6c66 2e63 6f6e       if self.con
-00009750: 7469 6775 6f75 733a 0a20 2020 2020 2020  tiguous:.       
-00009760: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00009770: 662e 5f66 6574 6368 416e 6441 6464 5261  f._fetchAndAddRa
-00009780: 6e67 6573 5f63 6f6e 7469 6775 6f75 7328  nges_contiguous(
-00009790: 7073 7472 2c20 7261 6e67 6573 5f74 6f5f  pstr, ranges_to_
-000097a0: 6665 7463 682c 2070 7265 706f 7374 2c20  fetch, prepost, 
-000097b0: 6465 6275 675f 7966 2c20 7175 6965 743d  debug_yf, quiet=
-000097c0: 7175 6965 7429 0a20 2020 2020 2020 2020  quiet).         
-000097d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000097e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000097f0: 2073 656c 662e 5f66 6574 6368 416e 6441   self._fetchAndA
-00009800: 6464 5261 6e67 6573 5f73 7061 7273 6528  ddRanges_sparse(
-00009810: 7073 7472 2c20 7261 6e67 6573 5f74 6f5f  pstr, ranges_to_
-00009820: 6665 7463 682c 2070 7265 706f 7374 2c20  fetch, prepost, 
-00009830: 6465 6275 675f 7966 2c20 7175 6965 743d  debug_yf, quiet=
-00009840: 7175 6965 7429 0a0a 2020 2020 2020 2020  quiet)..        
-00009850: 6966 2022 4164 6a20 436c 6f73 6522 2069  if "Adj Close" i
-00009860: 6e20 7365 6c66 2e68 2e63 6f6c 756d 6e73  n self.h.columns
-00009870: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00009880: 6973 6520 4578 6365 7074 696f 6e28 2241  ise Exception("A
-00009890: 646a 2043 6c6f 7365 2069 6e20 7365 6c66  dj Close in self
-000098a0: 2e68 2229 0a0a 2020 2020 2020 2020 2320  .h")..        # 
-000098b0: 7265 7061 6972 2061 6674 6572 2061 6c6c  repair after all
-000098c0: 2066 6574 6368 6573 2063 6f6d 706c 6574   fetches complet
-000098d0: 650a 2020 2020 2020 2020 6966 2073 656c  e.        if sel
-000098e0: 662e 7265 7061 6972 2061 6e64 2072 6570  f.repair and rep
-000098f0: 6169 723a 0a20 2020 2020 2020 2020 2020  air:.           
-00009900: 2066 5f6e 6f74 5f63 6865 636b 6564 203d   f_not_checked =
-00009910: 207e 2873 656c 662e 685b 2243 2d43 6865   ~(self.h["C-Che
-00009920: 636b 3f22 5d2e 746f 5f6e 756d 7079 2829  ck?"].to_numpy()
-00009930: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00009940: 2066 5f6e 6f74 5f63 6865 636b 6564 2e61   f_not_checked.a
-00009950: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00009960: 2020 2020 2020 6861 203d 2073 656c 662e        ha = self.
-00009970: 685b 665f 6e6f 745f 6368 6563 6b65 645d  h[f_not_checked]
-00009980: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-00009990: 2020 2020 2020 2020 6862 203d 2073 656c          hb = sel
-000099a0: 662e 685b 7e66 5f6e 6f74 5f63 6865 636b  f.h[~f_not_check
-000099b0: 6564 5d0a 2020 2020 2020 2020 2020 2020  ed].            
-000099c0: 2020 2020 6861 203d 2073 656c 662e 5f72      ha = self._r
-000099d0: 6570 6169 725a 6572 6f50 7269 6365 7328  epairZeroPrices(
-000099e0: 6861 2c20 7369 6c65 6e74 3d54 7275 6529  ha, silent=True)
-000099f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009a00: 2068 6120 3d20 7365 6c66 2e5f 7265 7061   ha = self._repa
-00009a10: 6972 556e 6974 4d69 7875 7073 2868 612c  irUnitMixups(ha,
-00009a20: 2073 696c 656e 743d 5472 7565 290a 2020   silent=True).  
-00009a30: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00009a40: 5b22 432d 4368 6563 6b3f 225d 203d 2054  ["C-Check?"] = T
-00009a50: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00009a60: 2020 2020 6966 206e 6f74 2068 622e 656d      if not hb.em
-00009a70: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-00009a80: 2020 2020 2020 2020 2073 656c 662e 6820           self.h 
-00009a90: 3d20 7064 2e63 6f6e 6361 7428 5b68 612c  = pd.concat([ha,
-00009aa0: 2068 625d 2c20 736f 7274 3d54 7275 6529   hb], sort=True)
-00009ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009ac0: 2020 2020 2073 656c 662e 682e 696e 6465       self.h.inde
-00009ad0: 7820 3d20 7064 2e74 6f5f 6461 7465 7469  x = pd.to_dateti
-00009ae0: 6d65 2873 656c 662e 682e 696e 6465 782c  me(self.h.index,
-00009af0: 2075 7463 3d54 7275 6529 2e74 7a5f 636f   utc=True).tz_co
-00009b00: 6e76 6572 7428 747a 5f65 7863 6861 6e67  nvert(tz_exchang
-00009b10: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00009b20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00009b30: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00009b40: 662e 6820 3d20 6861 0a20 2020 2020 2020  f.h = ha.       
-00009b50: 2020 2020 2020 2020 2073 656c 662e 6820           self.h 
-00009b60: 3d20 7365 6c66 2e68 2e73 6f72 745f 696e  = self.h.sort_in
-00009b70: 6465 7828 290a 2020 2020 2020 2020 2020  dex().          
-00009b80: 2020 2020 2020 7365 6c66 2e5f 7570 6461        self._upda
-00009b90: 7465 6443 6163 6865 6450 7269 6365 7328  tedCachedPrices(
-00009ba0: 7365 6c66 2e68 290a 0a20 2020 2020 2020  self.h)..       
-00009bb0: 2023 204e 6f77 2070 7269 6365 7320 6861   # Now prices ha
-00009bc0: 7665 2062 6565 6e20 7265 7061 6972 6564  ve been repaired
-00009bd0: 2c20 6361 6e20 7365 6e64 206f 7574 2064  , can send out d
-00009be0: 6976 6964 656e 6473 0a20 2020 2020 2020  ividends.       
-00009bf0: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
-00009c00: 203d 2079 6663 6d2e 5265 6164 4361 6368   = yfcm.ReadCach
-00009c10: 6544 6174 756d 2873 656c 662e 7469 636b  eDatum(self.tick
-00009c20: 6572 2c20 226e 6577 5f64 6976 7322 290a  er, "new_divs").
-00009c30: 2020 2020 2020 2020 6966 2063 6163 6865          if cache
-00009c40: 645f 6e65 775f 6469 7673 2069 7320 6e6f  d_new_divs is no
-00009c50: 7420 4e6f 6e65 2061 6e64 206e 6f74 2063  t None and not c
-00009c60: 6163 6865 645f 6e65 775f 6469 7673 2e65  ached_new_divs.e
-00009c70: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-00009c80: 2020 6361 6368 6564 5f6e 6577 5f64 6976    cached_new_div
-00009c90: 735f 6c6f 636b 6564 203d 2079 6663 6d2e  s_locked = yfcm.
-00009ca0: 5265 6164 4361 6368 654d 6574 6164 6174  ReadCacheMetadat
-00009cb0: 6128 7365 6c66 2e74 6963 6b65 722c 2022  a(self.ticker, "
-00009cc0: 6e65 775f 6469 7673 222c 2022 6c6f 636b  new_divs", "lock
-00009cd0: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-00009ce0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
-00009cf0: 2866 2263 6163 6865 645f 6e65 775f 6469  (f"cached_new_di
-00009d00: 7673 5f6c 6f63 6b65 6420 3d20 7b63 6163  vs_locked = {cac
-00009d10: 6865 645f 6e65 775f 6469 7673 5f6c 6f63  hed_new_divs_loc
-00009d20: 6b65 647d 2229 0a20 2020 2020 2020 2020  ked}").         
-00009d30: 2020 2069 6620 6361 6368 6564 5f6e 6577     if cached_new
-00009d40: 5f64 6976 735f 6c6f 636b 6564 2069 7320  _divs_locked is 
-00009d50: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00009d60: 2020 2020 2020 7966 636d 2e57 7269 7465        yfcm.Write
-00009d70: 4361 6368 654d 6574 6164 6174 6128 7365  CacheMetadata(se
-00009d80: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
-00009d90: 6469 7673 222c 2022 6c6f 636b 6564 222c  divs", "locked",
-00009da0: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-00009db0: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
-00009dc0: 696e 7428 2273 656e 6469 6e67 206f 7574  int("sending out
-00009dd0: 206e 6577 2064 6976 6964 656e 6473 202e   new dividends .
-00009de0: 2e2e 2229 0a20 2020 2020 2020 2020 2020  ..").           
-00009df0: 2020 2020 2023 2054 4f44 4f3a 2072 656d       # TODO: rem
-00009e00: 6f76 6520 6475 706c 6963 6174 6573 2066  ove duplicates f
-00009e10: 726f 6d20 5f6e 6577 4469 7673 2028 706f  rom _newDivs (po
-00009e20: 7373 6962 6c65 2077 6865 6e20 7265 7374  ssible when rest
-00009e30: 6f72 696e 6720 6669 6c65 2066 696c 6529  oring file file)
-00009e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009e50: 2064 6976 735f 6466 203d 2063 6163 6865   divs_df = cache
-00009e60: 645f 6e65 775f 6469 7673 0a20 2020 2020  d_new_divs.     
-00009e70: 2020 2020 2020 2020 2020 2064 6976 735f             divs_
-00009e80: 6466 5b22 436c 6f73 6520 6461 7920 6265  df["Close day be
-00009e90: 666f 7265 225d 203d 206e 702e 6e61 6e0a  fore"] = np.nan.
-00009ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009eb0: 666f 7220 6474 2069 6e20 6469 7673 5f64  for dt in divs_d
-00009ec0: 662e 696e 6465 783a 0a20 2020 2020 2020  f.index:.       
-00009ed0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00009ee0: 6474 203d 3d20 7365 6c66 2e68 2e69 6e64  dt == self.h.ind
-00009ef0: 6578 5b30 5d3a 0a20 2020 2020 2020 2020  ex[0]:.         
-00009f00: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-00009f10: 6973 745f 6265 666f 7265 203d 2073 656c  ist_before = sel
-00009f20: 662e 6d61 6e61 6765 722e 4765 7448 6973  f.manager.GetHis
-00009f30: 746f 7279 2879 6663 642e 496e 7465 7276  tory(yfcd.Interv
-00009f40: 616c 2e44 6179 7331 292e 6765 7428 7374  al.Days1).get(st
-00009f50: 6172 743d 6474 2e64 6174 6528 292d 7469  art=dt.date()-ti
-00009f60: 6d65 6465 6c74 6128 6461 7973 3d37 292c  medelta(days=7),
-00009f70: 2065 6e64 3d64 742e 6461 7465 2829 2c20   end=dt.date(), 
-00009f80: 6164 6a75 7374 5f73 706c 6974 733d 4661  adjust_splits=Fa
-00009f90: 6c73 652c 2061 646a 7573 745f 6469 7673  lse, adjust_divs
-00009fa0: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
-00009fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009fc0: 636c 6f73 655f 6461 795f 6265 666f 7265  close_day_before
-00009fd0: 203d 2068 6973 745f 6265 666f 7265 5b22   = hist_before["
-00009fe0: 436c 6f73 6522 5d2e 696c 6f63 5b2d 315d  Close"].iloc[-1]
-00009ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a000: 2020 2020 2020 2020 2069 6620 6e70 2e69           if np.i
-0000a010: 736e 616e 2863 6c6f 7365 5f64 6179 5f62  snan(close_day_b
-0000a020: 6566 6f72 6529 3a0a 2020 2020 2020 2020  efore):.        
-0000a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a040: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-0000a050: 696f 6e28 2227 636c 6f73 655f 6461 795f  ion("'close_day_
-0000a060: 6265 666f 7265 2720 6973 204e 614e 2229  before' is NaN")
-0000a070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a080: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000a090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0a0: 2020 2069 6478 203d 2073 656c 662e 682e     idx = self.h.
-0000a0b0: 696e 6465 782e 6765 745f 6c6f 6328 6474  index.get_loc(dt
-0000a0c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a0d0: 2020 2020 2020 2020 2020 636c 6f73 655f            close_
-0000a0e0: 6461 795f 6265 666f 7265 203d 2073 656c  day_before = sel
-0000a0f0: 662e 685b 2243 6c6f 7365 225d 2e69 6c6f  f.h["Close"].ilo
-0000a100: 635b 6964 782d 315d 0a20 2020 2020 2020  c[idx-1].       
-0000a110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a120: 2069 6620 6e70 2e69 736e 616e 2863 6c6f   if np.isnan(clo
-0000a130: 7365 5f64 6179 5f62 6566 6f72 6529 3a0a  se_day_before):.
+000091d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000091e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00009200: 616e 6765 735f 746f 5f66 6574 6368 5b69  anges_to_fetch[i
+00009210: 5d20 3d20 2872 5b30 5d2c 2064 5f6e 6f77  ] = (r[0], d_now
+00009220: 5f65 7863 6861 6e67 6520 2b20 7464 5f31  _exchange + td_1
+00009230: 6429 0a0a 2020 2020 2020 2020 2020 2020  d)..            
+00009240: 2320 496d 706f 7274 616e 7420 7468 6174  # Important that
+00009250: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
+00009260: 2069 6e20 7265 7665 7273 6520 6f72 6465   in reverse orde
+00009270: 7221 0a20 2020 2020 2020 2020 2020 2072  r!.            r
+00009280: 616e 6765 735f 746f 5f66 6574 6368 2e73  anges_to_fetch.s
+00009290: 6f72 7428 6b65 793d 6c61 6d62 6461 2078  ort(key=lambda x
+000092a0: 3a20 785b 305d 2c20 7265 7665 7273 653d  : x[0], reverse=
+000092b0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+000092c0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+000092d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092e0: 7072 696e 7428 222d 2072 616e 6765 735f  print("- ranges_
+000092f0: 746f 5f66 6574 6368 3a22 290a 2020 2020  to_fetch:").    
+00009300: 2020 2020 2020 2020 2020 2020 7070 7269              ppri
+00009310: 6e74 2872 616e 6765 735f 746f 5f66 6574  nt(ranges_to_fet
+00009320: 6368 290a 0a20 2020 2020 2020 2020 2020  ch)..           
+00009330: 2069 6620 6c65 6e28 7261 6e67 6573 5f74   if len(ranges_t
+00009340: 6f5f 6665 7463 6829 203e 2030 3a0a 2020  o_fetch) > 0:.  
+00009350: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00009360: 206e 6f74 2073 656c 662e 682e 656d 7074   not self.h.empt
+00009370: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00009380: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+00009390: 6f6e 6c79 206f 6e65 2072 616e 6765 206d  only one range m
+000093a0: 6178 2069 7320 6166 7465 7220 6361 6368  ax is after cach
+000093b0: 6564 2064 6174 613a 0a20 2020 2020 2020  ed data:.       
+000093c0: 2020 2020 2020 2020 2020 2020 2068 5f6c               h_l
+000093d0: 6173 745f 6474 203d 2073 656c 662e 682e  ast_dt = self.h.
+000093e0: 696e 6465 785b 2d31 5d2e 746f 5f70 7964  index[-1].to_pyd
+000093f0: 6174 6574 696d 6528 290a 2020 2020 2020  atetime().      
+00009400: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00009410: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00009420: 7261 6e67 6573 5f74 6f5f 6665 7463 685b  ranges_to_fetch[
+00009430: 305d 5b30 5d2c 2064 6174 6574 696d 6529  0][0], datetime)
+00009440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009450: 2020 2020 2020 2020 2020 685f 6c61 7374            h_last
+00009460: 5f64 7420 3d20 685f 6c61 7374 5f64 742e  _dt = h_last_dt.
+00009470: 6173 7469 6d65 7a6f 6e65 2874 7a5f 6578  astimezone(tz_ex
+00009480: 6368 616e 6765 292e 6461 7465 2829 0a20  change).date(). 
+00009490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094a0: 2020 206e 203d 2030 0a20 2020 2020 2020     n = 0.       
+000094b0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000094c0: 2072 2069 6e20 7261 6e67 6573 5f74 6f5f   r in ranges_to_
+000094d0: 6665 7463 683a 0a20 2020 2020 2020 2020  fetch:.         
+000094e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000094f0: 6620 725b 305d 203e 2068 5f6c 6173 745f  f r[0] > h_last_
+00009500: 6474 3a0a 2020 2020 2020 2020 2020 2020  dt:.            
+00009510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009520: 6e20 2b3d 2031 0a20 2020 2020 2020 2020  n += 1.         
+00009530: 2020 2020 2020 2020 2020 2069 6620 6e20             if n 
+00009540: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+00009550: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00009560: 6e74 2822 7261 6e67 6573 5f74 6f5f 6665  nt("ranges_to_fe
+00009570: 7463 683a 2229 0a20 2020 2020 2020 2020  tch:").         
+00009580: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00009590: 7072 696e 7428 7261 6e67 6573 5f74 6f5f  print(ranges_to_
+000095a0: 6665 7463 6829 0a20 2020 2020 2020 2020  fetch).         
+000095b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000095c0: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+000095d0: 7261 6e67 6573 5f74 6f5f 6665 7463 6820  ranges_to_fetch 
+000095e0: 636f 6e74 6169 6e73 207b 7d20 7261 6e67  contains {} rang
+000095f0: 6573 2074 6861 7420 6f63 6375 7220 6166  es that occur af
+00009600: 7465 7220 685f 6c61 7374 5f64 743d 7b7d  ter h_last_dt={}
+00009610: 2c20 6578 7065 6374 6564 2031 206d 6178  , expected 1 max
+00009620: 222e 666f 726d 6174 286e 2c20 685f 6c61  ".format(n, h_la
+00009630: 7374 5f64 7429 290a 0a20 2020 2020 2020  st_dt))..       
+00009640: 2020 2020 2020 2020 2023 2069 6620 6e6f           # if no
+00009650: 7420 7175 6965 743a 0a20 2020 2020 2020  t quiet:.       
+00009660: 2020 2020 2020 2020 2023 2020 2020 2071           #     q
+00009670: 7569 6574 203d 2070 6572 696f 6420 6973  uiet = period is
+00009680: 206e 6f74 204e 6f6e 6520 2023 2059 4643   not None  # YFC
+00009690: 2067 656e 6572 6174 6564 2064 6174 6520   generated date 
+000096a0: 7261 6e67 6520 736f 2064 6f6e 2774 2070  range so don't p
+000096b0: 7269 6e74 206d 6573 7361 6765 0a20 2020  rint message.   
+000096c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000096d0: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
+000096e0: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+000096f0: 7569 6574 203d 2046 616c 7365 0a20 2020  uiet = False.   
+00009700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009710: 2023 2071 7569 6574 203d 206e 6f74 2064   # quiet = not d
+00009720: 6562 7567 5f79 6663 0a20 2020 2020 2020  ebug_yfc.       
+00009730: 2020 2020 2020 2020 2023 2069 6620 7365           # if se
+00009740: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
+00009750: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
+00009760: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
+00009770: 2020 2020 6966 2073 656c 662e 636f 6e74      if self.cont
+00009780: 6967 756f 7573 3a0a 2020 2020 2020 2020  iguous:.        
+00009790: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000097a0: 2e5f 6665 7463 6841 6e64 4164 6452 616e  ._fetchAndAddRan
+000097b0: 6765 735f 636f 6e74 6967 756f 7573 2870  ges_contiguous(p
+000097c0: 7374 722c 2072 616e 6765 735f 746f 5f66  str, ranges_to_f
+000097d0: 6574 6368 2c20 7072 6570 6f73 742c 2064  etch, prepost, d
+000097e0: 6562 7567 5f79 662c 2071 7569 6574 3d71  ebug_yf, quiet=q
+000097f0: 7569 6574 290a 2020 2020 2020 2020 2020  uiet).          
+00009800: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00009810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009820: 7365 6c66 2e5f 6665 7463 6841 6e64 4164  self._fetchAndAd
+00009830: 6452 616e 6765 735f 7370 6172 7365 2870  dRanges_sparse(p
+00009840: 7374 722c 2072 616e 6765 735f 746f 5f66  str, ranges_to_f
+00009850: 6574 6368 2c20 7072 6570 6f73 742c 2064  etch, prepost, d
+00009860: 6562 7567 5f79 662c 2071 7569 6574 3d71  ebug_yf, quiet=q
+00009870: 7569 6574 290a 0a20 2020 2020 2020 2069  uiet)..        i
+00009880: 6620 2241 646a 2043 6c6f 7365 2220 696e  f "Adj Close" in
+00009890: 2073 656c 662e 682e 636f 6c75 6d6e 733a   self.h.columns:
+000098a0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000098b0: 7365 2045 7863 6570 7469 6f6e 2822 4164  se Exception("Ad
+000098c0: 6a20 436c 6f73 6520 696e 2073 656c 662e  j Close in self.
+000098d0: 6822 290a 0a20 2020 2020 2020 2023 2072  h")..        # r
+000098e0: 6570 6169 7220 6166 7465 7220 616c 6c20  epair after all 
+000098f0: 6665 7463 6865 7320 636f 6d70 6c65 7465  fetches complete
+00009900: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00009910: 2e72 6570 6169 7220 616e 6420 7265 7061  .repair and repa
+00009920: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
+00009930: 665f 6e6f 745f 6368 6563 6b65 6420 3d20  f_not_checked = 
+00009940: 7e28 7365 6c66 2e68 5b22 432d 4368 6563  ~(self.h["C-Chec
+00009950: 6b3f 225d 2e74 6f5f 6e75 6d70 7928 2929  k?"].to_numpy())
+00009960: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009970: 665f 6e6f 745f 6368 6563 6b65 642e 616e  f_not_checked.an
+00009980: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+00009990: 2020 2020 2068 6120 3d20 7365 6c66 2e68       ha = self.h
+000099a0: 5b66 5f6e 6f74 5f63 6865 636b 6564 5d2e  [f_not_checked].
+000099b0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+000099c0: 2020 2020 2020 2068 6220 3d20 7365 6c66         hb = self
+000099d0: 2e68 5b7e 665f 6e6f 745f 6368 6563 6b65  .h[~f_not_checke
+000099e0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+000099f0: 2020 2068 6120 3d20 7365 6c66 2e5f 7265     ha = self._re
+00009a00: 7061 6972 5a65 726f 5072 6963 6573 2868  pairZeroPrices(h
+00009a10: 612c 2073 696c 656e 743d 5472 7565 290a  a, silent=True).
+00009a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a30: 6861 203d 2073 656c 662e 5f72 6570 6169  ha = self._repai
+00009a40: 7255 6e69 744d 6978 7570 7328 6861 2c20  rUnitMixups(ha, 
+00009a50: 7369 6c65 6e74 3d54 7275 6529 0a20 2020  silent=True).   
+00009a60: 2020 2020 2020 2020 2020 2020 2068 615b               ha[
+00009a70: 2243 2d43 6865 636b 3f22 5d20 3d20 5472  "C-Check?"] = Tr
+00009a80: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00009a90: 2020 2069 6620 6e6f 7420 6862 2e65 6d70     if not hb.emp
+00009aa0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+00009ab0: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
+00009ac0: 2070 642e 636f 6e63 6174 285b 6861 2c20   pd.concat([ha, 
+00009ad0: 6862 5d2c 2073 6f72 743d 5472 7565 290a  hb], sort=True).
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009af0: 2020 2020 7365 6c66 2e68 2e69 6e64 6578      self.h.index
+00009b00: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
+00009b10: 6528 7365 6c66 2e68 2e69 6e64 6578 2c20  e(self.h.index, 
+00009b20: 7574 633d 5472 7565 292e 747a 5f63 6f6e  utc=True).tz_con
+00009b30: 7665 7274 2874 7a5f 6578 6368 616e 6765  vert(tz_exchange
+00009b40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009b50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00009b60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00009b70: 2e68 203d 2068 610a 2020 2020 2020 2020  .h = ha.        
+00009b80: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
+00009b90: 2073 656c 662e 682e 736f 7274 5f69 6e64   self.h.sort_ind
+00009ba0: 6578 2829 0a20 2020 2020 2020 2020 2020  ex().           
+00009bb0: 2020 2020 2073 656c 662e 5f75 7064 6174       self._updat
+00009bc0: 6564 4361 6368 6564 5072 6963 6573 2873  edCachedPrices(s
+00009bd0: 656c 662e 6829 0a0a 2020 2020 2020 2020  elf.h)..        
+00009be0: 2320 4e6f 7720 7072 6963 6573 2068 6176  # Now prices hav
+00009bf0: 6520 6265 656e 2072 6570 6169 7265 642c  e been repaired,
+00009c00: 2063 616e 2073 656e 6420 6f75 7420 6469   can send out di
+00009c10: 7669 6465 6e64 730a 2020 2020 2020 2020  vidends.        
+00009c20: 6361 6368 6564 5f6e 6577 5f64 6976 7320  cached_new_divs 
+00009c30: 3d20 7966 636d 2e52 6561 6443 6163 6865  = yfcm.ReadCache
+00009c40: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
+00009c50: 722c 2022 6e65 775f 6469 7673 2229 0a20  r, "new_divs"). 
+00009c60: 2020 2020 2020 2069 6620 6361 6368 6564         if cached
+00009c70: 5f6e 6577 5f64 6976 7320 6973 206e 6f74  _new_divs is not
+00009c80: 204e 6f6e 6520 616e 6420 6e6f 7420 6361   None and not ca
+00009c90: 6368 6564 5f6e 6577 5f64 6976 732e 656d  ched_new_divs.em
+00009ca0: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+00009cb0: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
+00009cc0: 5f6c 6f63 6b65 6420 3d20 7966 636d 2e52  _locked = yfcm.R
+00009cd0: 6561 6443 6163 6865 4d65 7461 6461 7461  eadCacheMetadata
+00009ce0: 2873 656c 662e 7469 636b 6572 2c20 226e  (self.ticker, "n
+00009cf0: 6577 5f64 6976 7322 2c20 226c 6f63 6b65  ew_divs", "locke
+00009d00: 6422 290a 2020 2020 2020 2020 2020 2020  d").            
+00009d10: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+00009d20: 6622 6361 6368 6564 5f6e 6577 5f64 6976  f"cached_new_div
+00009d30: 735f 6c6f 636b 6564 203d 207b 6361 6368  s_locked = {cach
+00009d40: 6564 5f6e 6577 5f64 6976 735f 6c6f 636b  ed_new_divs_lock
+00009d50: 6564 7d22 290a 2020 2020 2020 2020 2020  ed}").          
+00009d60: 2020 6966 2063 6163 6865 645f 6e65 775f    if cached_new_
+00009d70: 6469 7673 5f6c 6f63 6b65 6420 6973 204e  divs_locked is N
+00009d80: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00009d90: 2020 2020 2079 6663 6d2e 5772 6974 6543       yfcm.WriteC
+00009da0: 6163 6865 4d65 7461 6461 7461 2873 656c  acheMetadata(sel
+00009db0: 662e 7469 636b 6572 2c20 226e 6577 5f64  f.ticker, "new_d
+00009dc0: 6976 7322 2c20 226c 6f63 6b65 6422 2c20  ivs", "locked", 
+00009dd0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+00009de0: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
+00009df0: 6e74 2822 7365 6e64 696e 6720 6f75 7420  nt("sending out 
+00009e00: 6e65 7720 6469 7669 6465 6e64 7320 2e2e  new dividends ..
+00009e10: 2e22 290a 2020 2020 2020 2020 2020 2020  .").            
+00009e20: 2020 2020 2320 544f 444f 3a20 7265 6d6f      # TODO: remo
+00009e30: 7665 2064 7570 6c69 6361 7465 7320 6672  ve duplicates fr
+00009e40: 6f6d 205f 6e65 7744 6976 7320 2870 6f73  om _newDivs (pos
+00009e50: 7369 626c 6520 7768 656e 2072 6573 746f  sible when resto
+00009e60: 7269 6e67 2066 696c 6520 6669 6c65 290a  ring file file).
+00009e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e80: 6469 7673 5f64 6620 3d20 6361 6368 6564  divs_df = cached
+00009e90: 5f6e 6577 5f64 6976 730a 2020 2020 2020  _new_divs.      
+00009ea0: 2020 2020 2020 2020 2020 6469 7673 5f64            divs_d
+00009eb0: 665b 2243 6c6f 7365 2064 6179 2062 6566  f["Close day bef
+00009ec0: 6f72 6522 5d20 3d20 6e70 2e6e 616e 0a20  ore"] = np.nan. 
+00009ed0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009ee0: 6f72 2064 7420 696e 2064 6976 735f 6466  or dt in divs_df
+00009ef0: 2e69 6e64 6578 3a0a 2020 2020 2020 2020  .index:.        
+00009f00: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00009f10: 7420 3d3d 2073 656c 662e 682e 696e 6465  t == self.h.inde
+00009f20: 785b 305d 3a0a 2020 2020 2020 2020 2020  x[0]:.          
+00009f30: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+00009f40: 7374 5f62 6566 6f72 6520 3d20 7365 6c66  st_before = self
+00009f50: 2e6d 616e 6167 6572 2e47 6574 4869 7374  .manager.GetHist
+00009f60: 6f72 7928 7966 6364 2e49 6e74 6572 7661  ory(yfcd.Interva
+00009f70: 6c2e 4461 7973 3129 2e67 6574 2873 7461  l.Days1).get(sta
+00009f80: 7274 3d64 742e 6461 7465 2829 2d74 696d  rt=dt.date()-tim
+00009f90: 6564 656c 7461 2864 6179 733d 3729 2c20  edelta(days=7), 
+00009fa0: 656e 643d 6474 2e64 6174 6528 292c 2061  end=dt.date(), a
+00009fb0: 646a 7573 745f 7370 6c69 7473 3d46 616c  djust_splits=Fal
+00009fc0: 7365 2c20 6164 6a75 7374 5f64 6976 733d  se, adjust_divs=
+00009fd0: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+00009fe0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00009ff0: 6c6f 7365 5f64 6179 5f62 6566 6f72 6520  lose_day_before 
+0000a000: 3d20 6869 7374 5f62 6566 6f72 655b 2243  = hist_before["C
+0000a010: 6c6f 7365 225d 2e69 6c6f 635b 2d31 5d0a  lose"].iloc[-1].
+0000a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a030: 2020 2020 2020 2020 6966 206e 702e 6973          if np.is
+0000a040: 6e61 6e28 636c 6f73 655f 6461 795f 6265  nan(close_day_be
+0000a050: 666f 7265 293a 0a20 2020 2020 2020 2020  fore):.         
+0000a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a070: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0000a080: 6f6e 2822 2763 6c6f 7365 5f64 6179 5f62  on("'close_day_b
+0000a090: 6566 6f72 6527 2069 7320 4e61 4e22 290a  efore' is NaN").
+0000a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0d0: 2020 6964 7820 3d20 7365 6c66 2e68 2e69    idx = self.h.i
+0000a0e0: 6e64 6578 2e67 6574 5f6c 6f63 2864 7429  ndex.get_loc(dt)
+0000a0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a100: 2020 2020 2020 2020 2063 6c6f 7365 5f64           close_d
+0000a110: 6179 5f62 6566 6f72 6520 3d20 7365 6c66  ay_before = self
+0000a120: 2e68 5b22 436c 6f73 6522 5d2e 696c 6f63  .h["Close"].iloc
+0000a130: 5b69 6478 2d31 5d0a 2020 2020 2020 2020  [idx-1].        
 0000a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a150: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000a160: 6920 696e 2072 616e 6765 2832 2c20 3130  i in range(2, 10
-0000a170: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a190: 2020 2063 6c6f 7365 5f64 6179 5f62 6566     close_day_bef
-0000a1a0: 6f72 6520 3d20 7365 6c66 2e68 5b22 436c  ore = self.h["Cl
-0000a1b0: 6f73 6522 5d2e 696c 6f63 5b69 6478 2d69  ose"].iloc[idx-i
-0000a1c0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1e0: 2020 6966 206e 6f74 206e 702e 6973 6e61    if not np.isna
-0000a1f0: 6e28 636c 6f73 655f 6461 795f 6265 666f  n(close_day_befo
-0000a200: 7265 293a 0a20 2020 2020 2020 2020 2020  re):.           
-0000a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a220: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-0000a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a240: 2020 2020 2020 2069 6620 6e70 2e69 736e         if np.isn
-0000a250: 616e 2863 6c6f 7365 5f64 6179 5f62 6566  an(close_day_bef
-0000a260: 6f72 6529 3a0a 2020 2020 2020 2020 2020  ore):.          
-0000a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a280: 2020 7072 696e 7428 6622 2d20 6964 783d    print(f"- idx=
-0000a290: 7b69 6478 7d20 6474 3d7b 6474 7d22 290a  {idx} dt={dt}").
+0000a150: 6966 206e 702e 6973 6e61 6e28 636c 6f73  if np.isnan(clos
+0000a160: 655f 6461 795f 6265 666f 7265 293a 0a20  e_day_before):. 
+0000a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a180: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0000a190: 2069 6e20 7261 6e67 6528 322c 2031 3029   in range(2, 10)
+0000a1a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a1c0: 2020 636c 6f73 655f 6461 795f 6265 666f    close_day_befo
+0000a1d0: 7265 203d 2073 656c 662e 685b 2243 6c6f  re = self.h["Clo
+0000a1e0: 7365 225d 2e69 6c6f 635b 6964 782d 695d  se"].iloc[idx-i]
+0000a1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a210: 2069 6620 6e6f 7420 6e70 2e69 736e 616e   if not np.isnan
+0000a220: 2863 6c6f 7365 5f64 6179 5f62 6566 6f72  (close_day_befor
+0000a230: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0000a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a250: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+0000a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a270: 2020 2020 2020 2020 2020 6966 206e 702e            if np.
+0000a280: 6973 6e61 6e28 636c 6f73 655f 6461 795f  isnan(close_day_
+0000a290: 6265 666f 7265 293a 0a20 2020 2020 2020  before):.       
 0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000a2c0: 7428 7365 6c66 2e68 2e69 6c6f 635b 6964  t(self.h.iloc[id
-0000a2d0: 782d 323a 6964 782b 335d 5b5b 2243 6c6f  x-2:idx+3][["Clo
-0000a2e0: 7365 222c 2022 4665 7463 6844 6174 6522  se", "FetchDate"
-0000a2f0: 5d5d 290a 2020 2020 2020 2020 2020 2020  ]]).            
-0000a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a310: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0000a320: 2227 636c 6f73 655f 6461 795f 6265 666f  "'close_day_befo
-0000a330: 7265 2720 6973 204e 614e 2229 0a20 2020  re' is NaN").   
-0000a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a350: 2064 6976 735f 6466 2e6c 6f63 5b64 742c   divs_df.loc[dt,
-0000a360: 2022 436c 6f73 6520 6461 7920 6265 666f   "Close day befo
-0000a370: 7265 225d 203d 2063 6c6f 7365 5f64 6179  re"] = close_day
-0000a380: 5f62 6566 6f72 650a 2020 2020 2020 2020  _before.        
-0000a390: 2020 2020 2020 2020 7365 6c66 2e6d 616e          self.man
-0000a3a0: 6167 6572 2e47 6574 4869 7374 6f72 7928  ager.GetHistory(
-0000a3b0: 2245 7665 6e74 7322 292e 5570 6461 7465  "Events").Update
-0000a3c0: 4469 7669 6465 6e64 7328 6469 7673 5f64  Dividends(divs_d
-0000a3d0: 6629 0a20 2020 2020 2020 2020 2020 2020  f).             
-0000a3e0: 2020 2073 656c 662e 5f61 7070 6c79 4e65     self._applyNe
-0000a3f0: 7745 7665 6e74 7328 290a 2020 2020 2020  wEvents().      
-0000a400: 2020 2020 2020 2020 2020 6966 2063 6163            if cac
-0000a410: 6865 645f 6e65 775f 6469 7673 2069 7320  hed_new_divs is 
-0000a420: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
-0000a430: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
-0000a440: 5f6c 6f63 6b65 643a 0a20 2020 2020 2020  _locked:.       
-0000a450: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-0000a460: 6c2e 5472 6163 6550 7269 6e74 2822 7265  l.TracePrint("re
-0000a470: 6c65 6173 696e 6720 6c6f 636b 206f 6e20  leasing lock on 
-0000a480: 6361 6368 6564 5f6e 6577 5f64 6976 7322  cached_new_divs"
-0000a490: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a4a0: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-0000a4b0: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-0000a4c0: 7469 636b 6572 2c20 226e 6577 5f64 6976  ticker, "new_div
-0000a4d0: 7322 2c20 4e6f 6e65 2920 2023 2064 656c  s", None)  # del
-0000a4e0: 6574 650a 0a20 2020 2020 2020 2069 6620  ete..        if 
-0000a4f0: 2241 646a 2043 6c6f 7365 2220 696e 2073  "Adj Close" in s
-0000a500: 656c 662e 682e 636f 6c75 6d6e 733a 0a20  elf.h.columns:. 
-0000a510: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000a520: 2045 7863 6570 7469 6f6e 2822 4164 6a20   Exception("Adj 
-0000a530: 436c 6f73 6520 696e 2073 656c 662e 6822  Close in self.h"
-0000a540: 290a 0a20 2020 2020 2020 2069 6620 2873  )..        if (s
-0000a550: 7461 7274 2069 7320 6e6f 7420 4e6f 6e65  tart is not None
-0000a560: 2920 616e 6420 2865 6e64 2069 7320 6e6f  ) and (end is no
-0000a570: 7420 4e6f 6e65 293a 0a20 2020 2020 2020  t None):.       
-0000a580: 2020 2020 2068 5f63 6f70 7920 3d20 7365       h_copy = se
-0000a590: 6c66 2e68 2e6c 6f63 5b73 7461 7274 5f64  lf.h.loc[start_d
-0000a5a0: 743a 656e 645f 6474 2d74 696d 6564 656c  t:end_dt-timedel
-0000a5b0: 7461 286d 696c 6c69 7365 636f 6e64 733d  ta(milliseconds=
-0000a5c0: 3129 5d2e 636f 7079 2829 0a20 2020 2020  1)].copy().     
-0000a5d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000a5e0: 2020 2020 2068 5f63 6f70 7920 3d20 7365       h_copy = se
-0000a5f0: 6c66 2e68 2e63 6f70 7928 290a 0a20 2020  lf.h.copy()..   
-0000a600: 2020 2020 2069 6620 6164 6a75 7374 5f73       if adjust_s
-0000a610: 706c 6974 733a 0a20 2020 2020 2020 2020  plits:.         
-0000a620: 2020 2066 6f72 2063 2069 6e20 5b22 4f70     for c in ["Op
-0000a630: 656e 222c 2022 4869 6768 222c 2022 4c6f  en", "High", "Lo
-0000a640: 7722 2c20 2243 6c6f 7365 222c 2022 4469  w", "Close", "Di
-0000a650: 7669 6465 6e64 7322 5d3a 0a20 2020 2020  vidends"]:.     
-0000a660: 2020 2020 2020 2020 2020 2068 5f63 6f70             h_cop
-0000a670: 795b 635d 202a 3d20 685f 636f 7079 5b22  y[c] *= h_copy["
-0000a680: 4353 4622 5d0a 2020 2020 2020 2020 2020  CSF"].          
-0000a690: 2020 685f 636f 7079 5b22 566f 6c75 6d65    h_copy["Volume
-0000a6a0: 225d 202f 3d20 685f 636f 7079 5b22 4353  "] /= h_copy["CS
-0000a6b0: 4622 5d0a 2020 2020 2020 2020 2020 2020  F"].            
-0000a6c0: 685f 636f 7079 203d 2068 5f63 6f70 792e  h_copy = h_copy.
-0000a6d0: 6472 6f70 2822 4353 4622 2c20 6178 6973  drop("CSF", axis
-0000a6e0: 3d31 290a 2020 2020 2020 2020 6966 2061  =1).        if a
-0000a6f0: 646a 7573 745f 6469 7673 3a0a 2020 2020  djust_divs:.    
-0000a700: 2020 2020 2020 2020 666f 7220 6320 696e          for c in
-0000a710: 205b 224f 7065 6e22 2c20 2248 6967 6822   ["Open", "High"
-0000a720: 2c20 224c 6f77 222c 2022 436c 6f73 6522  , "Low", "Close"
-0000a730: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-0000a740: 2020 2068 5f63 6f70 795b 635d 202a 3d20     h_copy[c] *= 
-0000a750: 685f 636f 7079 5b22 4344 4622 5d0a 2020  h_copy["CDF"].  
-0000a760: 2020 2020 2020 2020 2020 685f 636f 7079            h_copy
-0000a770: 203d 2068 5f63 6f70 792e 6472 6f70 2822   = h_copy.drop("
-0000a780: 4344 4622 2c20 6178 6973 3d31 290a 0a20  CDF", axis=1).. 
-0000a790: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
-0000a7a0: 2066 2250 7269 6365 4869 7374 6f72 792d   f"PriceHistory-
-0000a7b0: 7b73 656c 662e 6973 7472 7d2e 6765 7428  {self.istr}.get(
-0000a7c0: 2920 7265 7475 726e 696e 6722 0a20 2020  ) returning".   
-0000a7d0: 2020 2020 2069 6620 685f 636f 7079 2e65       if h_copy.e
-0000a7e0: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-0000a7f0: 2020 6c6f 675f 6d73 6720 2b3d 2022 2065    log_msg += " e
-0000a800: 6d70 7479 2064 6622 0a20 2020 2020 2020  mpty df".       
-0000a810: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000a820: 2020 206c 6f67 5f6d 7367 202b 3d20 6622     log_msg += f"
-0000a830: 2044 4620 7b68 5f63 6f70 792e 696e 6465   DF {h_copy.inde
-0000a840: 785b 305d 7d20 2d3e 207b 685f 636f 7079  x[0]} -> {h_copy
-0000a850: 2e69 6e64 6578 5b2d 315d 7d22 0a20 2020  .index[-1]}".   
-0000a860: 2020 2020 2069 6620 7966 636c 2e49 7354       if yfcl.IsT
-0000a870: 7261 6369 6e67 456e 6162 6c65 6428 293a  racingEnabled():
-0000a880: 0a20 2020 2020 2020 2020 2020 2079 6663  .            yfc
-0000a890: 6c2e 5472 6163 6545 7869 7428 6c6f 675f  l.TraceExit(log_
-0000a8a0: 6d73 6729 0a20 2020 2020 2020 2065 6c69  msg).        eli
-0000a8b0: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
-0000a8c0: 2020 2020 2020 2020 2070 7269 6e74 286c           print(l
-0000a8d0: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
-0000a8e0: 2072 6574 7572 6e20 685f 636f 7079 0a0a   return h_copy..
-0000a8f0: 2020 2020 6465 6620 5f66 6574 6368 416e      def _fetchAn
-0000a900: 6441 6464 5261 6e67 6573 5f63 6f6e 7469  dAddRanges_conti
-0000a910: 6775 6f75 7328 7365 6c66 2c20 7073 7472  guous(self, pstr
-0000a920: 2c20 7261 6e67 6573 5f74 6f5f 6665 7463  , ranges_to_fetc
-0000a930: 682c 2070 7265 706f 7374 2c20 6465 6275  h, prepost, debu
-0000a940: 672c 2071 7569 6574 3d46 616c 7365 293a  g, quiet=False):
-0000a950: 0a20 2020 2020 2020 2069 6620 7073 7472  .        if pstr
-0000a960: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000a970: 2020 2020 2020 2020 2020 7966 6375 2e54            yfcu.T
-0000a980: 7970 6543 6865 636b 5374 7228 7073 7472  ypeCheckStr(pstr
-0000a990: 2c20 2270 7374 7222 290a 2020 2020 2020  , "pstr").      
-0000a9a0: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-0000a9b0: 4974 6572 6162 6c65 2872 616e 6765 735f  Iterable(ranges_
-0000a9c0: 746f 5f66 6574 6368 2c20 2272 616e 6765  to_fetch, "range
-0000a9d0: 735f 746f 5f66 6574 6368 2229 0a20 2020  s_to_fetch").   
-0000a9e0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-0000a9f0: 6563 6b42 6f6f 6c28 7072 6570 6f73 742c  eckBool(prepost,
-0000aa00: 2022 7072 6570 6f73 7422 290a 2020 2020   "prepost").    
-0000aa10: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-0000aa20: 636b 426f 6f6c 2864 6562 7567 2c20 2264  ckBool(debug, "d
-0000aa30: 6562 7567 2229 0a20 2020 2020 2020 2079  ebug").        y
-0000aa40: 6663 752e 5479 7065 4368 6563 6b42 6f6f  fcu.TypeCheckBoo
-0000aa50: 6c28 7175 6965 742c 2022 7175 6965 7422  l(quiet, "quiet"
-0000aa60: 290a 0a20 2020 2020 2020 2023 2046 6574  )..        # Fet
-0000aa70: 6368 2065 6163 6820 7261 6e67 652c 2061  ch each range, a
-0000aa80: 7070 656e 6469 6e67 2f70 7265 7065 6e64  ppending/prepend
-0000aa90: 696e 6720 746f 2063 6163 6865 6420 6461  ing to cached da
-0000aaa0: 7461 0a20 2020 2020 2020 2069 6620 2872  ta.        if (r
-0000aab0: 616e 6765 735f 746f 5f66 6574 6368 2069  anges_to_fetch i
-0000aac0: 7320 4e6f 6e65 2920 6f72 206c 656e 2872  s None) or len(r
-0000aad0: 616e 6765 735f 746f 5f66 6574 6368 2920  anges_to_fetch) 
-0000aae0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0000aaf0: 2020 2320 7265 7475 726e 2068 0a20 2020    # return h.   
-0000ab00: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0000ab10: 0a20 2020 2020 2020 2064 6562 7567 5f79  .        debug_y
-0000ab20: 6663 203d 2073 656c 662e 5f64 6562 7567  fc = self._debug
-0000ab30: 0a20 2020 2020 2020 2023 2064 6562 7567  .        # debug
-0000ab40: 5f79 6663 203d 2054 7275 650a 0a20 2020  _yfc = True..   
-0000ab50: 2020 2020 206c 6f67 5f6d 7367 203d 2066       log_msg = f
-0000ab60: 225f 6665 7463 6841 6e64 4164 6452 616e  "_fetchAndAddRan
-0000ab70: 6765 735f 636f 6e74 6967 756f 7573 2d7b  ges_contiguous-{
-0000ab80: 7365 6c66 2e69 7374 727d 286e 3d7b 6c65  self.istr}(n={le
-0000ab90: 6e28 7261 6e67 6573 5f74 6f5f 6665 7463  n(ranges_to_fetc
-0000aba0: 6829 7d20 7072 6570 6f73 743d 7b70 7265  h)} prepost={pre
-0000abb0: 706f 7374 7d29 2922 0a20 2020 2020 2020  post}))".       
-0000abc0: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
-0000abd0: 6e67 456e 6162 6c65 6428 293a 0a20 2020  ngEnabled():.   
-0000abe0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-0000abf0: 6163 6545 6e74 6572 286c 6f67 5f6d 7367  aceEnter(log_msg
-0000ac00: 290a 2020 2020 2020 2020 656c 6966 2064  ).        elif d
-0000ac10: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
-0000ac20: 2020 2020 2020 7072 696e 7428 6c6f 675f        print(log_
-0000ac30: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-0000ac40: 2070 7269 6e74 2822 2d20 7261 6e67 6573   print("- ranges
-0000ac50: 5f74 6f5f 6665 7463 683a 2229 0a20 2020  _to_fetch:").   
-0000ac60: 2020 2020 2020 2020 2070 7072 696e 7428           pprint(
-0000ac70: 7261 6e67 6573 5f74 6f5f 6665 7463 6829  ranges_to_fetch)
-0000ac80: 0a0a 2020 2020 2020 2020 747a 5f65 7863  ..        tz_exc
-0000ac90: 6861 6e67 6520 3d20 5a6f 6e65 496e 666f  hange = ZoneInfo
-0000aca0: 2873 656c 662e 747a 4e61 6d65 290a 2020  (self.tzName).  
-0000acb0: 2020 2020 2020 7966 6374 2e53 6574 4578        yfct.SetEx
-0000acc0: 6368 616e 6765 547a 4e61 6d65 2873 656c  changeTzName(sel
-0000acd0: 662e 6578 6368 616e 6765 2c20 7365 6c66  f.exchange, self
-0000ace0: 2e74 7a4e 616d 6529 0a0a 2020 2020 2020  .tzName)..      
-0000acf0: 2020 6966 2073 656c 662e 6820 6973 204e    if self.h is N
-0000ad00: 6f6e 6520 6f72 2073 656c 662e 682e 656d  one or self.h.em
-0000ad10: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-0000ad20: 2068 5f66 6972 7374 5f64 7420 3d20 4e6f   h_first_dt = No
-0000ad30: 6e65 203b 2068 5f6c 6173 745f 6474 203d  ne ; h_last_dt =
-0000ad40: 204e 6f6e 650a 2020 2020 2020 2020 656c   None.        el
-0000ad50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000ad60: 685f 6669 7273 745f 6474 203d 2073 656c  h_first_dt = sel
-0000ad70: 662e 682e 696e 6465 785b 305d 2e74 6f5f  f.h.index[0].to_
-0000ad80: 7079 6461 7465 7469 6d65 2829 0a20 2020  pydatetime().   
-0000ad90: 2020 2020 2020 2020 2068 5f6c 6173 745f           h_last_
-0000ada0: 6474 203d 2073 656c 662e 682e 696e 6465  dt = self.h.inde
-0000adb0: 785b 2d31 5d2e 746f 5f70 7964 6174 6574  x[-1].to_pydatet
-0000adc0: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
-0000add0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0000ade0: 6e63 6528 7261 6e67 6573 5f74 6f5f 6665  nce(ranges_to_fe
-0000adf0: 7463 685b 305d 5b30 5d2c 2064 6174 6574  tch[0][0], datet
-0000ae00: 696d 6529 3a0a 2020 2020 2020 2020 2020  ime):.          
-0000ae10: 2020 2020 2020 685f 6669 7273 745f 6474        h_first_dt
-0000ae20: 203d 2068 5f66 6972 7374 5f64 742e 6173   = h_first_dt.as
-0000ae30: 7469 6d65 7a6f 6e65 2874 7a5f 6578 6368  timezone(tz_exch
-0000ae40: 616e 6765 292e 6461 7465 2829 0a20 2020  ange).date().   
-0000ae50: 2020 2020 2020 2020 2020 2020 2068 5f6c               h_l
-0000ae60: 6173 745f 6474 203d 2068 5f6c 6173 745f  ast_dt = h_last_
-0000ae70: 6474 2e61 7374 696d 657a 6f6e 6528 747a  dt.astimezone(tz
-0000ae80: 5f65 7863 6861 6e67 6529 2e64 6174 6528  _exchange).date(
-0000ae90: 290a 2020 2020 2020 2020 7464 5f31 6420  ).        td_1d 
-0000aea0: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
-0000aeb0: 3d31 290a 0a20 2020 2020 2020 2023 2042  =1)..        # B
-0000aec0: 6563 6175 7365 2064 6174 6120 7368 6f75  ecause data shou
-0000aed0: 6c64 2062 6520 636f 6e74 6967 756f 7573  ld be contiguous
-0000aee0: 2c20 7468 656e 2072 616e 6765 7320 7368  , then ranges sh
-0000aef0: 6f75 6c64 206d 6565 7420 736f 6d65 2063  ould meet some c
-0000af00: 6f6e 6469 7469 6f6e 733a 0a20 2020 2020  onditions:.     
-0000af10: 2020 2069 6620 6c65 6e28 7261 6e67 6573     if len(ranges
-0000af20: 5f74 6f5f 6665 7463 6829 203e 2032 3a0a  _to_fetch) > 2:.
-0000af30: 2020 2020 2020 2020 2020 2020 7070 7269              ppri
-0000af40: 6e74 2872 616e 6765 735f 746f 5f66 6574  nt(ranges_to_fet
-0000af50: 6368 290a 2020 2020 2020 2020 2020 2020  ch).            
-0000af60: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0000af70: 2246 6f72 2063 6f6e 7469 6775 6f75 7320  "For contiguous 
-0000af80: 6461 7461 2067 656e 6572 6174 6564 207b  data generated {
-0000af90: 7d3e 3220 7261 6e67 6573 222e 666f 726d  }>2 ranges".form
-0000afa0: 6174 286c 656e 2872 616e 6765 735f 746f  at(len(ranges_to
-0000afb0: 5f66 6574 6368 2929 290a 2020 2020 2020  _fetch))).      
-0000afc0: 2020 6966 2073 656c 662e 682e 656d 7074    if self.h.empt
-0000afd0: 7920 616e 6420 6c65 6e28 7261 6e67 6573  y and len(ranges
-0000afe0: 5f74 6f5f 6665 7463 6829 203e 2031 3a0a  _to_fetch) > 1:.
-0000aff0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000b000: 6520 4578 6365 7074 696f 6e28 2246 6f72  e Exception("For
-0000b010: 2063 6f6e 7469 6775 6f75 7320 6461 7461   contiguous data
-0000b020: 2067 656e 6572 6174 6564 207b 7d20 7261   generated {} ra
-0000b030: 6e67 6573 2c20 6275 7420 6820 6973 2065  nges, but h is e
-0000b040: 6d70 7479 222e 666f 726d 6174 286c 656e  mpty".format(len
-0000b050: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
-0000b060: 2929 290a 2020 2020 2020 2020 7261 6e67  ))).        rang
-0000b070: 655f 7072 6520 3d20 4e6f 6e65 203b 2072  e_pre = None ; r
-0000b080: 616e 6765 5f70 6f73 7420 3d20 4e6f 6e65  ange_post = None
-0000b090: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000b0a0: 2e68 2e65 6d70 7479 2061 6e64 206c 656e  .h.empty and len
-0000b0b0: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
-0000b0c0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+0000a2b0: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+0000a2c0: 222d 2069 6478 3d7b 6964 787d 2064 743d  "- idx={idx} dt=
+0000a2d0: 7b64 747d 2229 0a20 2020 2020 2020 2020  {dt}").         
+0000a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2f0: 2020 2020 2020 2070 7269 6e74 2873 656c         print(sel
+0000a300: 662e 682e 696c 6f63 5b69 6478 2d32 3a69  f.h.iloc[idx-2:i
+0000a310: 6478 2b33 5d5b 5b22 436c 6f73 6522 2c20  dx+3][["Close", 
+0000a320: 2246 6574 6368 4461 7465 225d 5d29 0a20  "FetchDate"]]). 
+0000a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a340: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000a350: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+0000a360: 2763 6c6f 7365 5f64 6179 5f62 6566 6f72  'close_day_befor
+0000a370: 6527 2069 7320 4e61 4e22 290a 2020 2020  e' is NaN").    
+0000a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a390: 6469 7673 5f64 662e 6c6f 635b 6474 2c20  divs_df.loc[dt, 
+0000a3a0: 2243 6c6f 7365 2064 6179 2062 6566 6f72  "Close day befor
+0000a3b0: 6522 5d20 3d20 636c 6f73 655f 6461 795f  e"] = close_day_
+0000a3c0: 6265 666f 7265 0a20 2020 2020 2020 2020  before.         
+0000a3d0: 2020 2020 2020 2073 656c 662e 6d61 6e61         self.mana
+0000a3e0: 6765 722e 4765 7448 6973 746f 7279 2822  ger.GetHistory("
+0000a3f0: 4576 656e 7473 2229 2e55 7064 6174 6544  Events").UpdateD
+0000a400: 6976 6964 656e 6473 2864 6976 735f 6466  ividends(divs_df
+0000a410: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000a420: 2020 7365 6c66 2e5f 6170 706c 794e 6577    self._applyNew
+0000a430: 4576 656e 7473 2829 0a20 2020 2020 2020  Events().       
+0000a440: 2020 2020 2020 2020 2069 6620 6361 6368           if cach
+0000a450: 6564 5f6e 6577 5f64 6976 7320 6973 206e  ed_new_divs is n
+0000a460: 6f74 204e 6f6e 6520 616e 6420 6e6f 7420  ot None and not 
+0000a470: 6361 6368 6564 5f6e 6577 5f64 6976 735f  cached_new_divs_
+0000a480: 6c6f 636b 6564 3a0a 2020 2020 2020 2020  locked:.        
+0000a490: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+0000a4a0: 2e54 7261 6365 5072 696e 7428 2272 656c  .TracePrint("rel
+0000a4b0: 6561 7369 6e67 206c 6f63 6b20 6f6e 2063  easing lock on c
+0000a4c0: 6163 6865 645f 6e65 775f 6469 7673 2229  ached_new_divs")
+0000a4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a4e0: 2020 2020 2079 6663 6d2e 5374 6f72 6543       yfcm.StoreC
+0000a4f0: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
+0000a500: 6963 6b65 722c 2022 6e65 775f 6469 7673  icker, "new_divs
+0000a510: 222c 204e 6f6e 6529 2020 2320 6465 6c65  ", None)  # dele
+0000a520: 7465 0a0a 2020 2020 2020 2020 6966 2022  te..        if "
+0000a530: 4164 6a20 436c 6f73 6522 2069 6e20 7365  Adj Close" in se
+0000a540: 6c66 2e68 2e63 6f6c 756d 6e73 3a0a 2020  lf.h.columns:.  
+0000a550: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000a560: 4578 6365 7074 696f 6e28 2241 646a 2043  Exception("Adj C
+0000a570: 6c6f 7365 2069 6e20 7365 6c66 2e68 2229  lose in self.h")
+0000a580: 0a0a 2020 2020 2020 2020 6966 2028 7374  ..        if (st
+0000a590: 6172 7420 6973 206e 6f74 204e 6f6e 6529  art is not None)
+0000a5a0: 2061 6e64 2028 656e 6420 6973 206e 6f74   and (end is not
+0000a5b0: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
+0000a5c0: 2020 2020 685f 636f 7079 203d 2073 656c      h_copy = sel
+0000a5d0: 662e 682e 6c6f 635b 7374 6172 745f 6474  f.h.loc[start_dt
+0000a5e0: 3a65 6e64 5f64 742d 7469 6d65 6465 6c74  :end_dt-timedelt
+0000a5f0: 6128 6d69 6c6c 6973 6563 6f6e 6473 3d31  a(milliseconds=1
+0000a600: 295d 2e63 6f70 7928 290a 2020 2020 2020  )].copy().      
+0000a610: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000a620: 2020 2020 685f 636f 7079 203d 2073 656c      h_copy = sel
+0000a630: 662e 682e 636f 7079 2829 0a0a 2020 2020  f.h.copy()..    
+0000a640: 2020 2020 6966 2061 646a 7573 745f 7370      if adjust_sp
+0000a650: 6c69 7473 3a0a 2020 2020 2020 2020 2020  lits:.          
+0000a660: 2020 666f 7220 6320 696e 205b 224f 7065    for c in ["Ope
+0000a670: 6e22 2c20 2248 6967 6822 2c20 224c 6f77  n", "High", "Low
+0000a680: 222c 2022 436c 6f73 6522 2c20 2244 6976  ", "Close", "Div
+0000a690: 6964 656e 6473 225d 3a0a 2020 2020 2020  idends"]:.      
+0000a6a0: 2020 2020 2020 2020 2020 685f 636f 7079            h_copy
+0000a6b0: 5b63 5d20 2a3d 2068 5f63 6f70 795b 2243  [c] *= h_copy["C
+0000a6c0: 5346 225d 0a20 2020 2020 2020 2020 2020  SF"].           
+0000a6d0: 2068 5f63 6f70 795b 2256 6f6c 756d 6522   h_copy["Volume"
+0000a6e0: 5d20 3d20 2868 5f63 6f70 795b 2256 6f6c  ] = (h_copy["Vol
+0000a6f0: 756d 6522 5d2f 685f 636f 7079 5b22 4353  ume"]/h_copy["CS
+0000a700: 4622 5d29 2e72 6f75 6e64 2830 292e 6173  F"]).round(0).as
+0000a710: 7479 7065 2827 696e 7427 290a 2020 2020  type('int').    
+0000a720: 2020 2020 2020 2020 685f 636f 7079 203d          h_copy =
+0000a730: 2068 5f63 6f70 792e 6472 6f70 2822 4353   h_copy.drop("CS
+0000a740: 4622 2c20 6178 6973 3d31 290a 2020 2020  F", axis=1).    
+0000a750: 2020 2020 6966 2061 646a 7573 745f 6469      if adjust_di
+0000a760: 7673 3a0a 2020 2020 2020 2020 2020 2020  vs:.            
+0000a770: 666f 7220 6320 696e 205b 224f 7065 6e22  for c in ["Open"
+0000a780: 2c20 2248 6967 6822 2c20 224c 6f77 222c  , "High", "Low",
+0000a790: 2022 436c 6f73 6522 5d3a 0a20 2020 2020   "Close"]:.     
+0000a7a0: 2020 2020 2020 2020 2020 2068 5f63 6f70             h_cop
+0000a7b0: 795b 635d 202a 3d20 685f 636f 7079 5b22  y[c] *= h_copy["
+0000a7c0: 4344 4622 5d0a 2020 2020 2020 2020 2020  CDF"].          
+0000a7d0: 2020 685f 636f 7079 203d 2068 5f63 6f70    h_copy = h_cop
+0000a7e0: 792e 6472 6f70 2822 4344 4622 2c20 6178  y.drop("CDF", ax
+0000a7f0: 6973 3d31 290a 0a20 2020 2020 2020 206c  is=1)..        l
+0000a800: 6f67 5f6d 7367 203d 2066 2250 7269 6365  og_msg = f"Price
+0000a810: 4869 7374 6f72 792d 7b73 656c 662e 6973  History-{self.is
+0000a820: 7472 7d2e 6765 7428 2920 7265 7475 726e  tr}.get() return
+0000a830: 696e 6722 0a20 2020 2020 2020 2069 6620  ing".        if 
+0000a840: 685f 636f 7079 2e65 6d70 7479 3a0a 2020  h_copy.empty:.  
+0000a850: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
+0000a860: 6720 2b3d 2022 2065 6d70 7479 2064 6622  g += " empty df"
+0000a870: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000a880: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
+0000a890: 7367 202b 3d20 6622 2044 4620 7b68 5f63  sg += f" DF {h_c
+0000a8a0: 6f70 792e 696e 6465 785b 305d 7d20 2d3e  opy.index[0]} ->
+0000a8b0: 207b 685f 636f 7079 2e69 6e64 6578 5b2d   {h_copy.index[-
+0000a8c0: 315d 7d22 0a20 2020 2020 2020 2069 6620  1]}".        if 
+0000a8d0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+0000a8e0: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
+0000a8f0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+0000a900: 7869 7428 6c6f 675f 6d73 6729 0a20 2020  xit(log_msg).   
+0000a910: 2020 2020 2065 6c69 6620 6465 6275 675f       elif debug_
+0000a920: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
+0000a930: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
+0000a940: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000a950: 685f 636f 7079 0a0a 2020 2020 6465 6620  h_copy..    def 
+0000a960: 5f66 6574 6368 416e 6441 6464 5261 6e67  _fetchAndAddRang
+0000a970: 6573 5f63 6f6e 7469 6775 6f75 7328 7365  es_contiguous(se
+0000a980: 6c66 2c20 7073 7472 2c20 7261 6e67 6573  lf, pstr, ranges
+0000a990: 5f74 6f5f 6665 7463 682c 2070 7265 706f  _to_fetch, prepo
+0000a9a0: 7374 2c20 6465 6275 672c 2071 7569 6574  st, debug, quiet
+0000a9b0: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+0000a9c0: 2069 6620 7073 7472 2069 7320 6e6f 7420   if pstr is not 
+0000a9d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000a9e0: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
+0000a9f0: 5374 7228 7073 7472 2c20 2270 7374 7222  Str(pstr, "pstr"
+0000aa00: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
+0000aa10: 7970 6543 6865 636b 4974 6572 6162 6c65  ypeCheckIterable
+0000aa20: 2872 616e 6765 735f 746f 5f66 6574 6368  (ranges_to_fetch
+0000aa30: 2c20 2272 616e 6765 735f 746f 5f66 6574  , "ranges_to_fet
+0000aa40: 6368 2229 0a20 2020 2020 2020 2079 6663  ch").        yfc
+0000aa50: 752e 5479 7065 4368 6563 6b42 6f6f 6c28  u.TypeCheckBool(
+0000aa60: 7072 6570 6f73 742c 2022 7072 6570 6f73  prepost, "prepos
+0000aa70: 7422 290a 2020 2020 2020 2020 7966 6375  t").        yfcu
+0000aa80: 2e54 7970 6543 6865 636b 426f 6f6c 2864  .TypeCheckBool(d
+0000aa90: 6562 7567 2c20 2264 6562 7567 2229 0a20  ebug, "debug"). 
+0000aaa0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+0000aab0: 4368 6563 6b42 6f6f 6c28 7175 6965 742c  CheckBool(quiet,
+0000aac0: 2022 7175 6965 7422 290a 0a20 2020 2020   "quiet")..     
+0000aad0: 2020 2023 2046 6574 6368 2065 6163 6820     # Fetch each 
+0000aae0: 7261 6e67 652c 2061 7070 656e 6469 6e67  range, appending
+0000aaf0: 2f70 7265 7065 6e64 696e 6720 746f 2063  /prepending to c
+0000ab00: 6163 6865 6420 6461 7461 0a20 2020 2020  ached data.     
+0000ab10: 2020 2069 6620 2872 616e 6765 735f 746f     if (ranges_to
+0000ab20: 5f66 6574 6368 2069 7320 4e6f 6e65 2920  _fetch is None) 
+0000ab30: 6f72 206c 656e 2872 616e 6765 735f 746f  or len(ranges_to
+0000ab40: 5f66 6574 6368 2920 3d3d 2030 3a0a 2020  _fetch) == 0:.  
+0000ab50: 2020 2020 2020 2020 2020 2320 7265 7475            # retu
+0000ab60: 726e 2068 0a20 2020 2020 2020 2020 2020  rn h.           
+0000ab70: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
+0000ab80: 2064 6562 7567 5f79 6663 203d 2073 656c   debug_yfc = sel
+0000ab90: 662e 5f64 6562 7567 0a20 2020 2020 2020  f._debug.       
+0000aba0: 2023 2064 6562 7567 5f79 6663 203d 2054   # debug_yfc = T
+0000abb0: 7275 650a 0a20 2020 2020 2020 206c 6f67  rue..        log
+0000abc0: 5f6d 7367 203d 2066 225f 6665 7463 6841  _msg = f"_fetchA
+0000abd0: 6e64 4164 6452 616e 6765 735f 636f 6e74  ndAddRanges_cont
+0000abe0: 6967 756f 7573 2d7b 7365 6c66 2e69 7374  iguous-{self.ist
+0000abf0: 727d 286e 3d7b 6c65 6e28 7261 6e67 6573  r}(n={len(ranges
+0000ac00: 5f74 6f5f 6665 7463 6829 7d20 7072 6570  _to_fetch)} prep
+0000ac10: 6f73 743d 7b70 7265 706f 7374 7d29 2922  ost={prepost}))"
+0000ac20: 0a20 2020 2020 2020 2069 6620 7966 636c  .        if yfcl
+0000ac30: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
+0000ac40: 6428 293a 0a20 2020 2020 2020 2020 2020  d():.           
+0000ac50: 2079 6663 6c2e 5472 6163 6545 6e74 6572   yfcl.TraceEnter
+0000ac60: 286c 6f67 5f6d 7367 290a 2020 2020 2020  (log_msg).      
+0000ac70: 2020 656c 6966 2064 6562 7567 5f79 6663    elif debug_yfc
+0000ac80: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+0000ac90: 696e 7428 6c6f 675f 6d73 6729 0a20 2020  int(log_msg).   
+0000aca0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0000acb0: 2d20 7261 6e67 6573 5f74 6f5f 6665 7463  - ranges_to_fetc
+0000acc0: 683a 2229 0a20 2020 2020 2020 2020 2020  h:").           
+0000acd0: 2070 7072 696e 7428 7261 6e67 6573 5f74   pprint(ranges_t
+0000ace0: 6f5f 6665 7463 6829 0a0a 2020 2020 2020  o_fetch)..      
+0000acf0: 2020 747a 5f65 7863 6861 6e67 6520 3d20    tz_exchange = 
+0000ad00: 5a6f 6e65 496e 666f 2873 656c 662e 747a  ZoneInfo(self.tz
+0000ad10: 4e61 6d65 290a 2020 2020 2020 2020 7966  Name).        yf
+0000ad20: 6374 2e53 6574 4578 6368 616e 6765 547a  ct.SetExchangeTz
+0000ad30: 4e61 6d65 2873 656c 662e 6578 6368 616e  Name(self.exchan
+0000ad40: 6765 2c20 7365 6c66 2e74 7a4e 616d 6529  ge, self.tzName)
+0000ad50: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0000ad60: 662e 6820 6973 204e 6f6e 6520 6f72 2073  f.h is None or s
+0000ad70: 656c 662e 682e 656d 7074 793a 0a20 2020  elf.h.empty:.   
+0000ad80: 2020 2020 2020 2020 2068 5f66 6972 7374           h_first
+0000ad90: 5f64 7420 3d20 4e6f 6e65 203b 2068 5f6c  _dt = None ; h_l
+0000ada0: 6173 745f 6474 203d 204e 6f6e 650a 2020  ast_dt = None.  
+0000adb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000adc0: 2020 2020 2020 2020 685f 6669 7273 745f          h_first_
+0000add0: 6474 203d 2073 656c 662e 682e 696e 6465  dt = self.h.inde
+0000ade0: 785b 305d 2e74 6f5f 7079 6461 7465 7469  x[0].to_pydateti
+0000adf0: 6d65 2829 0a20 2020 2020 2020 2020 2020  me().           
+0000ae00: 2068 5f6c 6173 745f 6474 203d 2073 656c   h_last_dt = sel
+0000ae10: 662e 682e 696e 6465 785b 2d31 5d2e 746f  f.h.index[-1].to
+0000ae20: 5f70 7964 6174 6574 696d 6528 290a 2020  _pydatetime().  
+0000ae30: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0000ae40: 2069 7369 6e73 7461 6e63 6528 7261 6e67   isinstance(rang
+0000ae50: 6573 5f74 6f5f 6665 7463 685b 305d 5b30  es_to_fetch[0][0
+0000ae60: 5d2c 2064 6174 6574 696d 6529 3a0a 2020  ], datetime):.  
+0000ae70: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+0000ae80: 6669 7273 745f 6474 203d 2068 5f66 6972  first_dt = h_fir
+0000ae90: 7374 5f64 742e 6173 7469 6d65 7a6f 6e65  st_dt.astimezone
+0000aea0: 2874 7a5f 6578 6368 616e 6765 292e 6461  (tz_exchange).da
+0000aeb0: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
+0000aec0: 2020 2020 2068 5f6c 6173 745f 6474 203d       h_last_dt =
+0000aed0: 2068 5f6c 6173 745f 6474 2e61 7374 696d   h_last_dt.astim
+0000aee0: 657a 6f6e 6528 747a 5f65 7863 6861 6e67  ezone(tz_exchang
+0000aef0: 6529 2e64 6174 6528 290a 2020 2020 2020  e).date().      
+0000af00: 2020 7464 5f31 6420 3d20 7469 6d65 6465    td_1d = timede
+0000af10: 6c74 6128 6461 7973 3d31 290a 0a20 2020  lta(days=1)..   
+0000af20: 2020 2020 2023 2042 6563 6175 7365 2064       # Because d
+0000af30: 6174 6120 7368 6f75 6c64 2062 6520 636f  ata should be co
+0000af40: 6e74 6967 756f 7573 2c20 7468 656e 2072  ntiguous, then r
+0000af50: 616e 6765 7320 7368 6f75 6c64 206d 6565  anges should mee
+0000af60: 7420 736f 6d65 2063 6f6e 6469 7469 6f6e  t some condition
+0000af70: 733a 0a20 2020 2020 2020 2069 6620 6c65  s:.        if le
+0000af80: 6e28 7261 6e67 6573 5f74 6f5f 6665 7463  n(ranges_to_fetc
+0000af90: 6829 203e 2032 3a0a 2020 2020 2020 2020  h) > 2:.        
+0000afa0: 2020 2020 7070 7269 6e74 2872 616e 6765      pprint(range
+0000afb0: 735f 746f 5f66 6574 6368 290a 2020 2020  s_to_fetch).    
+0000afc0: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+0000afd0: 6365 7074 696f 6e28 2246 6f72 2063 6f6e  ception("For con
+0000afe0: 7469 6775 6f75 7320 6461 7461 2067 656e  tiguous data gen
+0000aff0: 6572 6174 6564 207b 7d3e 3220 7261 6e67  erated {}>2 rang
+0000b000: 6573 222e 666f 726d 6174 286c 656e 2872  es".format(len(r
+0000b010: 616e 6765 735f 746f 5f66 6574 6368 2929  anges_to_fetch))
+0000b020: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+0000b030: 662e 682e 656d 7074 7920 616e 6420 6c65  f.h.empty and le
+0000b040: 6e28 7261 6e67 6573 5f74 6f5f 6665 7463  n(ranges_to_fetc
+0000b050: 6829 203e 2031 3a0a 2020 2020 2020 2020  h) > 1:.        
+0000b060: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+0000b070: 696f 6e28 2246 6f72 2063 6f6e 7469 6775  ion("For contigu
+0000b080: 6f75 7320 6461 7461 2067 656e 6572 6174  ous data generat
+0000b090: 6564 207b 7d20 7261 6e67 6573 2c20 6275  ed {} ranges, bu
+0000b0a0: 7420 6820 6973 2065 6d70 7479 222e 666f  t h is empty".fo
+0000b0b0: 726d 6174 286c 656e 2872 616e 6765 735f  rmat(len(ranges_
+0000b0c0: 746f 5f66 6574 6368 2929 290a 2020 2020  to_fetch))).    
 0000b0d0: 2020 2020 7261 6e67 655f 7072 6520 3d20      range_pre = 
-0000b0e0: 7261 6e67 6573 5f74 6f5f 6665 7463 685b  ranges_to_fetch[
-0000b0f0: 305d 0a20 2020 2020 2020 2065 6c73 653a  0].        else:
-0000b100: 0a20 2020 2020 2020 2020 2020 206e 5f70  .            n_p
-0000b110: 7265 203d 2030 203b 206e 5f70 6f73 7420  re = 0 ; n_post 
-0000b120: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-0000b130: 666f 7220 7220 696e 2072 616e 6765 735f  for r in ranges_
-0000b140: 746f 5f66 6574 6368 3a0a 2020 2020 2020  to_fetch:.      
-0000b150: 2020 2020 2020 2020 2020 6966 2072 5b30            if r[0
-0000b160: 5d20 3e20 685f 6c61 7374 5f64 743a 0a20  ] > h_last_dt:. 
-0000b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b180: 2020 206e 5f70 6f73 7420 2b3d 2031 0a20     n_post += 1. 
-0000b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1a0: 2020 2072 616e 6765 5f70 6f73 7420 3d20     range_post = 
-0000b1b0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0000b1c0: 2020 656c 6966 2072 5b30 5d20 3c20 685f    elif r[0] < h_
-0000b1d0: 6669 7273 745f 6474 3a0a 2020 2020 2020  first_dt:.      
-0000b1e0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-0000b1f0: 7072 6520 2b3d 2031 0a20 2020 2020 2020  pre += 1.       
-0000b200: 2020 2020 2020 2020 2020 2020 2072 616e               ran
-0000b210: 6765 5f70 7265 203d 2072 0a20 2020 2020  ge_pre = r.     
-0000b220: 2020 2020 2020 2069 6620 6e5f 7072 6520         if n_pre 
-0000b230: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-0000b240: 2020 2020 2070 7072 696e 7428 7261 6e67       pprint(rang
-0000b250: 6573 5f74 6f5f 6665 7463 6829 0a20 2020  es_to_fetch).   
-0000b260: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000b270: 7365 2045 7863 6570 7469 6f6e 2822 466f  se Exception("Fo
-0000b280: 7220 636f 6e74 6967 756f 7573 2064 6174  r contiguous dat
-0000b290: 6120 6765 6e65 7261 7465 6420 7b7d 3e31  a generated {}>1
-0000b2a0: 2072 616e 6765 7320 6265 666f 7265 2068   ranges before h
-0000b2b0: 5f66 6972 7374 5f64 7422 2e66 6f72 6d61  _first_dt".forma
-0000b2c0: 7428 6e5f 7072 6529 290a 2020 2020 2020  t(n_pre)).      
-0000b2d0: 2020 2020 2020 6966 206e 5f70 6f73 7420        if n_post 
-0000b2e0: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
-0000b2f0: 2020 2020 2070 7072 696e 7428 7261 6e67       pprint(rang
-0000b300: 6573 5f74 6f5f 6665 7463 6829 0a20 2020  es_to_fetch).   
-0000b310: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000b320: 7365 2045 7863 6570 7469 6f6e 2822 466f  se Exception("Fo
-0000b330: 7220 636f 6e74 6967 756f 7573 2064 6174  r contiguous dat
-0000b340: 6120 6765 6e65 7261 7465 6420 7b7d 3e31  a generated {}>1
-0000b350: 2072 616e 6765 7320 6166 7465 7220 685f   ranges after h_
-0000b360: 6c61 7374 5f64 7422 2e66 6f72 6d61 7428  last_dt".format(
-0000b370: 6e5f 706f 7374 2929 0a0a 2020 2020 2020  n_post))..      
-0000b380: 2020 2320 4665 7463 6820 7261 6e67 6573    # Fetch ranges
-0000b390: 0a20 2020 2020 2020 2068 325f 7072 6520  .        h2_pre 
-0000b3a0: 3d20 4e6f 6e65 203b 2068 325f 706f 7374  = None ; h2_post
-0000b3b0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000b3c0: 6966 2072 616e 6765 5f70 7265 2069 7320  if range_pre is 
-0000b3d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000b3e0: 2020 2020 2020 7220 3d20 7261 6e67 655f        r = range_
-0000b3f0: 7072 650a 2020 2020 2020 2020 2020 2020  pre.            
-0000b400: 2320 6368 6563 6b5f 666f 725f 6c69 7374  # check_for_list
-0000b410: 696e 6720 3d20 4661 6c73 650a 2020 2020  ing = False.    
-0000b420: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000b430: 2020 2020 2020 2020 2020 2020 2068 325f               h2_
-0000b440: 7072 6520 3d20 7365 6c66 2e5f 6665 7463  pre = self._fetc
-0000b450: 6859 6648 6973 746f 7279 2870 7374 722c  hYfHistory(pstr,
-0000b460: 2072 5b30 5d2c 2072 5b31 5d2c 2070 7265   r[0], r[1], pre
-0000b470: 706f 7374 2c20 6465 6275 6729 0a20 2020  post, debug).   
-0000b480: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000b490: 7966 6364 2e4e 6f50 7269 6365 4461 7461  yfcd.NoPriceData
-0000b4a0: 496e 5261 6e67 6545 7863 6570 7469 6f6e  InRangeException
-0000b4b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000b4c0: 2020 6966 2073 656c 662e 696e 7465 7276    if self.interv
-0000b4d0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
-0000b4e0: 7661 6c2e 4461 7973 3120 616e 6420 725b  val.Days1 and r[
-0000b4f0: 315d 202d 2072 5b30 5d20 3d3d 2074 645f  1] - r[0] == td_
-0000b500: 3164 3a0a 2020 2020 2020 2020 2020 2020  1d:.            
-0000b510: 2020 2020 2020 2020 2320 4966 206f 6e6c          # If onl
-0000b520: 7920 7472 7969 6e67 2074 6f20 6665 7463  y trying to fetc
-0000b530: 6820 3120 6461 7920 6f66 2031 6420 6461  h 1 day of 1d da
-0000b540: 7461 2c20 7468 656e 2070 7269 6e74 2077  ta, then print w
-0000b550: 6172 6e69 6e67 2069 6e73 7465 6164 206f  arning instead o
-0000b560: 6620 6578 6365 7074 696f 6e2e 0a20 2020  f exception..   
+0000b0e0: 4e6f 6e65 203b 2072 616e 6765 5f70 6f73  None ; range_pos
+0000b0f0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+0000b100: 2069 6620 7365 6c66 2e68 2e65 6d70 7479   if self.h.empty
+0000b110: 2061 6e64 206c 656e 2872 616e 6765 735f   and len(ranges_
+0000b120: 746f 5f66 6574 6368 2920 3d3d 2031 3a0a  to_fetch) == 1:.
+0000b130: 2020 2020 2020 2020 2020 2020 7261 6e67              rang
+0000b140: 655f 7072 6520 3d20 7261 6e67 6573 5f74  e_pre = ranges_t
+0000b150: 6f5f 6665 7463 685b 305d 0a20 2020 2020  o_fetch[0].     
+0000b160: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000b170: 2020 2020 206e 5f70 7265 203d 2030 203b       n_pre = 0 ;
+0000b180: 206e 5f70 6f73 7420 3d20 300a 2020 2020   n_post = 0.    
+0000b190: 2020 2020 2020 2020 666f 7220 7220 696e          for r in
+0000b1a0: 2072 616e 6765 735f 746f 5f66 6574 6368   ranges_to_fetch
+0000b1b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b1c0: 2020 6966 2072 5b30 5d20 3e20 685f 6c61    if r[0] > h_la
+0000b1d0: 7374 5f64 743a 0a20 2020 2020 2020 2020  st_dt:.         
+0000b1e0: 2020 2020 2020 2020 2020 206e 5f70 6f73             n_pos
+0000b1f0: 7420 2b3d 2031 0a20 2020 2020 2020 2020  t += 1.         
+0000b200: 2020 2020 2020 2020 2020 2072 616e 6765             range
+0000b210: 5f70 6f73 7420 3d20 720a 2020 2020 2020  _post = r.      
+0000b220: 2020 2020 2020 2020 2020 656c 6966 2072            elif r
+0000b230: 5b30 5d20 3c20 685f 6669 7273 745f 6474  [0] < h_first_dt
+0000b240: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b250: 2020 2020 2020 6e5f 7072 6520 2b3d 2031        n_pre += 1
+0000b260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b270: 2020 2020 2072 616e 6765 5f70 7265 203d       range_pre =
+0000b280: 2072 0a20 2020 2020 2020 2020 2020 2069   r.            i
+0000b290: 6620 6e5f 7072 6520 3e20 313a 0a20 2020  f n_pre > 1:.   
+0000b2a0: 2020 2020 2020 2020 2020 2020 2070 7072               ppr
+0000b2b0: 696e 7428 7261 6e67 6573 5f74 6f5f 6665  int(ranges_to_fe
+0000b2c0: 7463 6829 0a20 2020 2020 2020 2020 2020  tch).           
+0000b2d0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
+0000b2e0: 7469 6f6e 2822 466f 7220 636f 6e74 6967  tion("For contig
+0000b2f0: 756f 7573 2064 6174 6120 6765 6e65 7261  uous data genera
+0000b300: 7465 6420 7b7d 3e31 2072 616e 6765 7320  ted {}>1 ranges 
+0000b310: 6265 666f 7265 2068 5f66 6972 7374 5f64  before h_first_d
+0000b320: 7422 2e66 6f72 6d61 7428 6e5f 7072 6529  t".format(n_pre)
+0000b330: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000b340: 206e 5f70 6f73 7420 3e20 313a 0a20 2020   n_post > 1:.   
+0000b350: 2020 2020 2020 2020 2020 2020 2070 7072               ppr
+0000b360: 696e 7428 7261 6e67 6573 5f74 6f5f 6665  int(ranges_to_fe
+0000b370: 7463 6829 0a20 2020 2020 2020 2020 2020  tch).           
+0000b380: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
+0000b390: 7469 6f6e 2822 466f 7220 636f 6e74 6967  tion("For contig
+0000b3a0: 756f 7573 2064 6174 6120 6765 6e65 7261  uous data genera
+0000b3b0: 7465 6420 7b7d 3e31 2072 616e 6765 7320  ted {}>1 ranges 
+0000b3c0: 6166 7465 7220 685f 6c61 7374 5f64 7422  after h_last_dt"
+0000b3d0: 2e66 6f72 6d61 7428 6e5f 706f 7374 2929  .format(n_post))
+0000b3e0: 0a0a 2020 2020 2020 2020 2320 4665 7463  ..        # Fetc
+0000b3f0: 6820 7261 6e67 6573 0a20 2020 2020 2020  h ranges.       
+0000b400: 2068 325f 7072 6520 3d20 4e6f 6e65 203b   h2_pre = None ;
+0000b410: 2068 325f 706f 7374 203d 204e 6f6e 650a   h2_post = None.
+0000b420: 2020 2020 2020 2020 6966 2072 616e 6765          if range
+0000b430: 5f70 7265 2069 7320 6e6f 7420 4e6f 6e65  _pre is not None
+0000b440: 3a0a 2020 2020 2020 2020 2020 2020 7220  :.            r 
+0000b450: 3d20 7261 6e67 655f 7072 650a 2020 2020  = range_pre.    
+0000b460: 2020 2020 2020 2020 2320 6368 6563 6b5f          # check_
+0000b470: 666f 725f 6c69 7374 696e 6720 3d20 4661  for_listing = Fa
+0000b480: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0000b490: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000b4a0: 2020 2020 2068 325f 7072 6520 3d20 7365       h2_pre = se
+0000b4b0: 6c66 2e5f 6665 7463 6859 6648 6973 746f  lf._fetchYfHisto
+0000b4c0: 7279 2870 7374 722c 2072 5b30 5d2c 2072  ry(pstr, r[0], r
+0000b4d0: 5b31 5d2c 2070 7265 706f 7374 2c20 6465  [1], prepost, de
+0000b4e0: 6275 6729 0a20 2020 2020 2020 2020 2020  bug).           
+0000b4f0: 2065 7863 6570 7420 7966 6364 2e4e 6f50   except yfcd.NoP
+0000b500: 7269 6365 4461 7461 496e 5261 6e67 6545  riceDataInRangeE
+0000b510: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+0000b520: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0000b530: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+0000b540: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
+0000b550: 3120 616e 6420 725b 315d 202d 2072 5b30  1 and r[1] - r[0
+0000b560: 5d20 3d3d 2074 645f 3164 3a0a 2020 2020  ] == td_1d:.    
 0000b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b580: 2023 2043 6f75 6c64 2061 6464 2061 6464   # Could add add
-0000b590: 6974 696f 6e61 6c20 636f 6e64 6974 696f  itional conditio
-0000b5a0: 6e20 6f66 2064 6976 6964 656e 6420 7072  n of dividend pr
-0000b5b0: 6576 696f 7573 2064 6179 2028 7365 656d  evious day (seem
-0000b5c0: 7320 746f 206d 6573 7320 7570 2074 6162  s to mess up tab
-0000b5d0: 6c65 292e 0a20 2020 2020 2020 2020 2020  le)..           
-0000b5e0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0000b5f0: 7175 6965 743a 0a20 2020 2020 2020 2020  quiet:.         
-0000b600: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000b610: 2070 7269 6e74 2822 5741 524e 494e 473a   print("WARNING:
-0000b620: 204e 6f20 7b7d 2d70 7269 6365 2064 6174   No {}-price dat
-0000b630: 6120 6665 7463 6865 6420 666f 7220 7469  a fetched for ti
-0000b640: 636b 6572 207b 7d20 6265 7477 6565 6e20  cker {} between 
-0000b650: 6461 7465 7320 7b7d 202d 3e20 7b7d 222e  dates {} -> {}".
-0000b660: 666f 726d 6174 2879 6663 642e 696e 7465  format(yfcd.inte
-0000b670: 7276 616c 546f 5374 7269 6e67 5b73 656c  rvalToString[sel
-0000b680: 662e 696e 7465 7276 616c 5d2c 2073 656c  f.interval], sel
-0000b690: 662e 7469 636b 6572 2c20 725b 305d 2c20  f.ticker, r[0], 
-0000b6a0: 725b 315d 2929 0a20 2020 2020 2020 2020  r[1])).         
-0000b6b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000b6c0: 7269 6e74 2866 2257 4152 4e49 4e47 3a20  rint(f"WARNING: 
-0000b6d0: 7b73 656c 662e 7469 636b 6572 7d3a 204e  {self.ticker}: N
-0000b6e0: 6f20 7b79 6663 642e 696e 7465 7276 616c  o {yfcd.interval
-0000b6f0: 546f 5374 7269 6e67 5b73 656c 662e 696e  ToString[self.in
-0000b700: 7465 7276 616c 5d7d 2d70 7269 6365 2064  terval]}-price d
-0000b710: 6174 6120 6665 7463 6865 6420 666f 7220  ata fetched for 
-0000b720: 7b72 5b30 5d7d 202d 3e20 7b72 5b31 5d7d  {r[0]} -> {r[1]}
-0000b730: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0000b740: 2020 2020 2020 2068 325f 7072 6520 3d20         h2_pre = 
-0000b750: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0000b760: 2020 2020 2065 6c69 6620 2872 616e 6765       elif (range
-0000b770: 5f70 6f73 7420 6973 204e 6f6e 6529 2061  _post is None) a
-0000b780: 6e64 2028 725b 315d 2d72 5b30 5d20 3c20  nd (r[1]-r[0] < 
-0000b790: 7464 5f31 642a 3729 2061 6e64 2028 725b  td_1d*7) and (r[
-0000b7a0: 315d 2d72 5b30 5d20 3e20 7464 5f31 642a  1]-r[0] > td_1d*
-0000b7b0: 3329 3a0a 2020 2020 2020 2020 2020 2020  3):.            
-0000b7c0: 2020 2020 2020 2020 2320 536d 616c 6c20          # Small 
-0000b7d0: 6461 7465 2072 616e 6765 2c20 706f 7465  date range, pote
-0000b7e0: 6e74 6961 6c6c 7920 7472 7969 6e67 2074  ntially trying t
-0000b7f0: 6f20 6665 7463 6820 6265 666f 7265 206c  o fetch before l
-0000b800: 6973 7469 6e67 2064 6174 610a 2020 2020  isting data.    
-0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b820: 2320 6368 6563 6b5f 666f 725f 6c69 7374  # check_for_list
-0000b830: 696e 6720 3d20 5472 7565 0a20 2020 2020  ing = True.     
-0000b840: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0000b850: 325f 7072 6520 3d20 4e6f 6e65 0a20 2020  2_pre = None.   
-0000b860: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000b870: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000b880: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-0000b890: 2020 2020 2020 2020 2023 2069 6620 6368           # if ch
-0000b8a0: 6563 6b5f 666f 725f 6c69 7374 696e 673a  eck_for_listing:
-0000b8b0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-0000b8c0: 2020 2064 6620 3d20 4e6f 6e65 0a20 2020     df = None.   
-0000b8d0: 2020 2020 2020 2020 2023 2020 2020 2074           #     t
-0000b8e0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000b8f0: 2320 2020 2020 2020 2020 6466 203d 2073  #         df = s
-0000b900: 656c 662e 5f66 6574 6368 5966 4869 7374  elf._fetchYfHist
-0000b910: 6f72 7928 7073 7472 2c20 725b 305d 2c20  ory(pstr, r[0], 
-0000b920: 725b 315d 2b74 645f 3164 2a37 2c20 7072  r[1]+td_1d*7, pr
-0000b930: 6570 6f73 742c 2064 6562 7567 290a 2020  epost, debug).  
-0000b940: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0000b950: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0000b960: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000b970: 2020 2020 2020 2020 2320 4469 7363 6172          # Discar
-0000b980: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-0000b990: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-0000b9a0: 2020 2020 2020 2020 2023 2020 2020 2069           #     i
-0000b9b0: 6620 6466 2069 7320 6e6f 7420 4e6f 6e65  f df is not None
-0000b9c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000b9d0: 2020 2020 2020 2020 2320 5468 656e 2074          # Then t
-0000b9e0: 6865 2065 7863 6570 7469 6f6e 2061 626f  he exception abo
-0000b9f0: 7665 206f 6363 7572 7265 6420 6265 6361  ve occurred beca
-0000ba00: 7573 6520 7472 7969 6e67 2074 6f20 6665  use trying to fe
-0000ba10: 7463 6820 6265 666f 7265 206c 6973 7469  tch before listi
-0000ba20: 6e67 2064 6174 6564 210a 2020 2020 2020  ng dated!.      
+0000b580: 2320 4966 206f 6e6c 7920 7472 7969 6e67  # If only trying
+0000b590: 2074 6f20 6665 7463 6820 3120 6461 7920   to fetch 1 day 
+0000b5a0: 6f66 2031 6420 6461 7461 2c20 7468 656e  of 1d data, then
+0000b5b0: 2070 7269 6e74 2077 6172 6e69 6e67 2069   print warning i
+0000b5c0: 6e73 7465 6164 206f 6620 6578 6365 7074  nstead of except
+0000b5d0: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
+0000b5e0: 2020 2020 2020 2020 2023 2043 6f75 6c64           # Could
+0000b5f0: 2061 6464 2061 6464 6974 696f 6e61 6c20   add additional 
+0000b600: 636f 6e64 6974 696f 6e20 6f66 2064 6976  condition of div
+0000b610: 6964 656e 6420 7072 6576 696f 7573 2064  idend previous d
+0000b620: 6179 2028 7365 656d 7320 746f 206d 6573  ay (seems to mes
+0000b630: 7320 7570 2074 6162 6c65 292e 0a20 2020  s up table)..   
+0000b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b650: 2069 6620 6e6f 7420 7175 6965 743a 0a20   if not quiet:. 
+0000b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b670: 2020 2020 2020 2023 2070 7269 6e74 2822         # print("
+0000b680: 5741 524e 494e 473a 204e 6f20 7b7d 2d70  WARNING: No {}-p
+0000b690: 7269 6365 2064 6174 6120 6665 7463 6865  rice data fetche
+0000b6a0: 6420 666f 7220 7469 636b 6572 207b 7d20  d for ticker {} 
+0000b6b0: 6265 7477 6565 6e20 6461 7465 7320 7b7d  between dates {}
+0000b6c0: 202d 3e20 7b7d 222e 666f 726d 6174 2879   -> {}".format(y
+0000b6d0: 6663 642e 696e 7465 7276 616c 546f 5374  fcd.intervalToSt
+0000b6e0: 7269 6e67 5b73 656c 662e 696e 7465 7276  ring[self.interv
+0000b6f0: 616c 5d2c 2073 656c 662e 7469 636b 6572  al], self.ticker
+0000b700: 2c20 725b 305d 2c20 725b 315d 2929 0a20  , r[0], r[1])). 
+0000b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b720: 2020 2020 2020 2070 7269 6e74 2866 2257         print(f"W
+0000b730: 4152 4e49 4e47 3a20 7b73 656c 662e 7469  ARNING: {self.ti
+0000b740: 636b 6572 7d3a 204e 6f20 7b79 6663 642e  cker}: No {yfcd.
+0000b750: 696e 7465 7276 616c 546f 5374 7269 6e67  intervalToString
+0000b760: 5b73 656c 662e 696e 7465 7276 616c 5d7d  [self.interval]}
+0000b770: 2d70 7269 6365 2064 6174 6120 6665 7463  -price data fetc
+0000b780: 6865 6420 666f 7220 7b72 5b30 5d7d 202d  hed for {r[0]} -
+0000b790: 3e20 7b72 5b31 5d7d 2229 0a20 2020 2020  > {r[1]}").     
+0000b7a0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000b7b0: 325f 7072 6520 3d20 4e6f 6e65 0a20 2020  2_pre = None.   
+0000b7c0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0000b7d0: 6620 2872 616e 6765 5f70 6f73 7420 6973  f (range_post is
+0000b7e0: 204e 6f6e 6529 2061 6e64 2028 725b 315d   None) and (r[1]
+0000b7f0: 2d72 5b30 5d20 3c20 7464 5f31 642a 3729  -r[0] < td_1d*7)
+0000b800: 2061 6e64 2028 725b 315d 2d72 5b30 5d20   and (r[1]-r[0] 
+0000b810: 3e20 7464 5f31 642a 3329 3a0a 2020 2020  > td_1d*3):.    
+0000b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b830: 2320 536d 616c 6c20 6461 7465 2072 616e  # Small date ran
+0000b840: 6765 2c20 706f 7465 6e74 6961 6c6c 7920  ge, potentially 
+0000b850: 7472 7969 6e67 2074 6f20 6665 7463 6820  trying to fetch 
+0000b860: 6265 666f 7265 206c 6973 7469 6e67 2064  before listing d
+0000b870: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+0000b880: 2020 2020 2020 2020 2320 6368 6563 6b5f          # check_
+0000b890: 666f 725f 6c69 7374 696e 6720 3d20 5472  for_listing = Tr
+0000b8a0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0000b8b0: 2020 2020 2020 2068 325f 7072 6520 3d20         h2_pre = 
+0000b8c0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000b8d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000b8e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000b8f0: 6169 7365 0a20 2020 2020 2020 2020 2020  aise.           
+0000b900: 2023 2069 6620 6368 6563 6b5f 666f 725f   # if check_for_
+0000b910: 6c69 7374 696e 673a 0a20 2020 2020 2020  listing:.       
+0000b920: 2020 2020 2023 2020 2020 2064 6620 3d20       #     df = 
+0000b930: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000b940: 2023 2020 2020 2074 7279 3a0a 2020 2020   #     try:.    
+0000b950: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+0000b960: 2020 6466 203d 2073 656c 662e 5f66 6574    df = self._fet
+0000b970: 6368 5966 4869 7374 6f72 7928 7073 7472  chYfHistory(pstr
+0000b980: 2c20 725b 305d 2c20 725b 315d 2b74 645f  , r[0], r[1]+td_
+0000b990: 3164 2a37 2c20 7072 6570 6f73 742c 2064  1d*7, prepost, d
+0000b9a0: 6562 7567 290a 2020 2020 2020 2020 2020  ebug).          
+0000b9b0: 2020 2320 2020 2020 6578 6365 7074 2045    #     except E
+0000b9c0: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+0000b9d0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0000b9e0: 2320 4469 7363 6172 640a 2020 2020 2020  # Discard.      
+0000b9f0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0000ba00: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0000ba10: 2023 2020 2020 2069 6620 6466 2069 7320   #     if df is 
+0000ba20: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
 0000ba30: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0000ba40: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
-0000ba50: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
-0000ba60: 2c20 226c 6973 7469 6e67 5f64 6174 6522  , "listing_date"
-0000ba70: 2c20 7365 6c66 2e68 2e69 6e64 6578 5b30  , self.h.index[0
-0000ba80: 5d2e 6461 7465 2829 290a 2020 2020 2020  ].date()).      
-0000ba90: 2020 2020 2020 2320 2020 2020 656c 7365        #     else
-0000baa0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000bab0: 2020 2020 2020 2020 2320 5468 656e 2074          # Then t
-0000bac0: 6865 2065 7863 6570 7469 6f6e 2061 626f  he exception abo
-0000bad0: 7665 2077 6173 2067 656e 7569 6e65 2061  ve was genuine a
-0000bae0: 6e64 206e 6565 6473 2074 6f20 6265 2070  nd needs to be p
-0000baf0: 726f 7061 6761 7465 640a 2020 2020 2020  ropagated.      
-0000bb00: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0000bb10: 7261 6973 6520 7966 6364 2e4e 6f50 7269  raise yfcd.NoPri
-0000bb20: 6365 4461 7461 496e 5261 6e67 6545 7863  ceDataInRangeExc
-0000bb30: 6570 7469 6f6e 2873 656c 662e 7469 636b  eption(self.tick
-0000bb40: 6572 2c20 7365 6c66 2e69 7374 722c 2072  er, self.istr, r
-0000bb50: 5b30 5d2c 2072 5b31 5d29 0a0a 2020 2020  [0], r[1])..    
-0000bb60: 2020 2020 6966 2072 616e 6765 5f70 6f73      if range_pos
-0000bb70: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-0000bb80: 2020 2020 2020 2020 2020 2072 203d 2072             r = r
-0000bb90: 616e 6765 5f70 6f73 740a 2020 2020 2020  ange_post.      
-0000bba0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000bbb0: 2020 2020 2020 2020 2020 2068 325f 706f             h2_po
-0000bbc0: 7374 203d 2073 656c 662e 5f66 6574 6368  st = self._fetch
-0000bbd0: 5966 4869 7374 6f72 7928 7073 7472 2c20  YfHistory(pstr, 
-0000bbe0: 725b 305d 2c20 725b 315d 2c20 7072 6570  r[0], r[1], prep
-0000bbf0: 6f73 742c 2064 6562 7567 290a 2020 2020  ost, debug).    
-0000bc00: 2020 2020 2020 2020 6578 6365 7074 2079          except y
-0000bc10: 6663 642e 4e6f 5072 6963 6544 6174 6149  fcd.NoPriceDataI
-0000bc20: 6e52 616e 6765 4578 6365 7074 696f 6e3a  nRangeException:
-0000bc30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bc40: 2023 2049 6620 6f6e 6c79 2074 7279 696e   # If only tryin
-0000bc50: 6720 746f 2066 6574 6368 2031 2064 6179  g to fetch 1 day
-0000bc60: 206f 6620 3164 2064 6174 612c 2074 6865   of 1d data, the
-0000bc70: 6e20 7072 696e 7420 7761 726e 696e 6720  n print warning 
-0000bc80: 696e 7374 6561 6420 6f66 2065 7863 6570  instead of excep
-0000bc90: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
-0000bca0: 2020 2020 2020 2320 436f 756c 6420 6164        # Could ad
-0000bcb0: 6420 6164 6469 7469 6f6e 616c 2063 6f6e  d additional con
-0000bcc0: 6469 7469 6f6e 206f 6620 6469 7669 6465  dition of divide
-0000bcd0: 6e64 2070 7265 7669 6f75 7320 6461 7920  nd previous day 
-0000bce0: 2873 6565 6d73 2074 6f20 6d65 7373 2075  (seems to mess u
-0000bcf0: 7020 7461 626c 6529 2e0a 2020 2020 2020  p table)..      
-0000bd00: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0000bd10: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-0000bd20: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
-0000bd30: 3120 616e 6420 725b 315d 202d 2072 5b30  1 and r[1] - r[0
-0000bd40: 5d20 3d3d 2074 645f 3164 3a0a 2020 2020  ] == td_1d:.    
-0000bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd60: 6966 206e 6f74 2071 7569 6574 3a0a 2020  if not quiet:.  
-0000bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd80: 2020 2020 2020 2320 7072 696e 7428 2257        # print("W
-0000bd90: 4152 4e49 4e47 3a20 4e6f 207b 7d2d 7072  ARNING: No {}-pr
-0000bda0: 6963 6520 6461 7461 2066 6574 6368 6564  ice data fetched
-0000bdb0: 2066 6f72 2074 6963 6b65 7220 7b7d 2062   for ticker {} b
-0000bdc0: 6574 7765 656e 2064 6174 6573 207b 7d20  etween dates {} 
-0000bdd0: 2d3e 207b 7d22 2e66 6f72 6d61 7428 7966  -> {}".format(yf
-0000bde0: 6364 2e69 6e74 6572 7661 6c54 6f53 7472  cd.intervalToStr
-0000bdf0: 696e 675b 7365 6c66 2e69 6e74 6572 7661  ing[self.interva
-0000be00: 6c5d 2c20 7365 6c66 2e74 6963 6b65 722c  l], self.ticker,
-0000be10: 2072 5b30 5d2c 2072 5b31 5d29 290a 2020   r[0], r[1])).  
-0000be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000be30: 2020 2020 2020 7072 696e 7428 6622 5741        print(f"WA
-0000be40: 524e 494e 473a 207b 7365 6c66 2e74 6963  RNING: {self.tic
-0000be50: 6b65 727d 3a20 4e6f 207b 7966 6364 2e69  ker}: No {yfcd.i
-0000be60: 6e74 6572 7661 6c54 6f53 7472 696e 675b  ntervalToString[
-0000be70: 7365 6c66 2e69 6e74 6572 7661 6c5d 7d2d  self.interval]}-
-0000be80: 7072 6963 6520 6461 7461 2066 6574 6368  price data fetch
-0000be90: 6564 2066 6f72 207b 725b 305d 7d20 2d3e  ed for {r[0]} ->
-0000bea0: 207b 725b 315d 7d22 290a 2020 2020 2020   {r[1]}").      
-0000beb0: 2020 2020 2020 2020 2020 2020 2020 6832                h2
-0000bec0: 5f70 6f73 7420 3d20 4e6f 6e65 0a20 2020  _post = None.   
-0000bed0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000bee0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000bef0: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
-0000bf00: 2020 2020 2020 6c69 7374 696e 675f 6461        listing_da
-0000bf10: 7465 203d 2079 6663 6d2e 5265 6164 4361  te = yfcm.ReadCa
-0000bf20: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
-0000bf30: 636b 6572 2c20 226c 6973 7469 6e67 5f64  cker, "listing_d
-0000bf40: 6174 6522 290a 2020 2020 2020 2020 6966  ate").        if
-0000bf50: 206c 6973 7469 6e67 5f64 6174 6520 6973   listing_date is
-0000bf60: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000bf70: 2020 206c 6973 7469 6e67 5f64 6174 6520     listing_date 
-0000bf80: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
-0000bf90: 7279 5f6d 6574 6164 6174 615b 2266 6972  ry_metadata["fir
-0000bfa0: 7374 5472 6164 6544 6174 6522 5d0a 2020  stTradeDate"].  
-0000bfb0: 2020 2020 2020 2020 2020 7966 636d 2e53            yfcm.S
-0000bfc0: 746f 7265 4361 6368 6544 6174 756d 2873  toreCacheDatum(s
-0000bfd0: 656c 662e 7469 636b 6572 2c20 226c 6973  elf.ticker, "lis
-0000bfe0: 7469 6e67 5f64 6174 6522 2c20 6c69 7374  ting_date", list
-0000bff0: 696e 675f 6461 7465 2e64 6174 6528 2929  ing_date.date())
-0000c000: 0a0a 2020 2020 2020 2020 6966 2068 325f  ..        if h2_
-0000c010: 706f 7374 2069 7320 6e6f 7420 4e6f 6e65  post is not None
-0000c020: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0000c030: 4465 2d61 646a 7573 7420 7468 6520 6e65  De-adjust the ne
-0000c040: 7720 6461 7461 2c20 616e 6420 6261 636b  w data, and back
-0000c050: 706f 7274 2061 6e79 206e 6577 2065 7665  port any new eve
-0000c060: 6e74 7320 696e 2063 6163 6865 6420 6461  nts in cached da
-0000c070: 7461 0a20 2020 2020 2020 2020 2020 2023  ta.            #
-0000c080: 204e 6f74 653a 2059 6168 6f6f 2061 6c77   Note: Yahoo alw
-0000c090: 6179 7320 7265 7475 726e 7320 7370 6c69  ays returns spli
-0000c0a0: 742d 6164 6a75 7374 6564 2070 7269 6365  t-adjusted price
-0000c0b0: 2c20 736f 2072 6576 6572 7365 2069 740a  , so reverse it.
-0000c0c0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0000c0d0: 696d 706c 6520 6170 7065 6e64 2074 6f20  imple append to 
-0000c0e0: 626f 7474 6f6d 206f 6620 7461 626c 650a  bottom of table.
-0000c0f0: 2020 2020 2020 2020 2020 2020 2320 3129              # 1)
-0000c100: 2061 646a 7573 7420 6832 5f70 6f73 740a   adjust h2_post.
-0000c110: 2020 2020 2020 2020 2020 2020 6832 5f70              h2_p
-0000c120: 6f73 7420 3d20 7365 6c66 2e5f 7265 7665  ost = self._reve
-0000c130: 7273 6559 6168 6f6f 4164 6a75 7374 2868  rseYahooAdjust(h
-0000c140: 325f 706f 7374 290a 2020 2020 2020 2020  2_post).        
-0000c150: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-0000c160: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000c170: 2020 7072 696e 7428 222d 2068 325f 706f    print("- h2_po
-0000c180: 7374 3a22 290a 2020 2020 2020 2020 2020  st:").          
-0000c190: 2020 2020 2020 7072 696e 7428 6832 5f70        print(h2_p
-0000c1a0: 6f73 7429 0a0a 2020 2020 2020 2020 2020  ost)..          
-0000c1b0: 2020 2320 544f 444f 3a20 5072 6f62 6c65    # TODO: Proble
-0000c1c0: 6d3a 2064 6976 6964 656e 6473 206e 6565  m: dividends nee
-0000c1d0: 6420 636f 7272 6563 7420 636c 6f73 650a  d correct close.
-0000c1e0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0000c1f0: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-0000c200: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
-0000c210: 7973 313a 0a20 2020 2020 2020 2020 2020  ys1:.           
-0000c220: 2020 2020 2068 325f 706f 7374 5f73 706c       h2_post_spl
-0000c230: 6974 7320 3d20 6832 5f70 6f73 745b 6832  its = h2_post[h2
-0000c240: 5f70 6f73 745b 2253 746f 636b 2053 706c  _post["Stock Spl
-0000c250: 6974 7322 5d20 213d 2030 5d5b 5b22 5374  its"] != 0][["St
-0000c260: 6f63 6b20 5370 6c69 7473 222c 2022 4665  ock Splits", "Fe
-0000c270: 7463 6844 6174 6522 5d5d 2e63 6f70 7928  tchDate"]].copy(
-0000c280: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c290: 2020 6966 206e 6f74 2068 325f 706f 7374    if not h2_post
-0000c2a0: 5f73 706c 6974 732e 656d 7074 793a 0a20  _splits.empty:. 
-0000c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2c0: 2020 2073 656c 662e 6d61 6e61 6765 722e     self.manager.
-0000c2d0: 4765 7448 6973 746f 7279 2822 4576 656e  GetHistory("Even
-0000c2e0: 7473 2229 2e55 7064 6174 6553 706c 6974  ts").UpdateSplit
-0000c2f0: 7328 6832 5f70 6f73 745f 7370 6c69 7473  s(h2_post_splits
-0000c300: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c310: 2020 2320 5570 6461 7465 3a20 6d6f 7669    # Update: movi
-0000c320: 6e67 2055 7064 6174 6544 6976 6964 656e  ng UpdateDividen
-0000c330: 6473 2829 2074 6f20 6166 7465 7220 7265  ds() to after re
-0000c340: 7061 6972 0a20 2020 2020 2020 2020 2020  pair.           
-0000c350: 2020 2020 2068 325f 706f 7374 5f64 6976       h2_post_div
-0000c360: 7320 3d20 6832 5f70 6f73 745b 6832 5f70  s = h2_post[h2_p
-0000c370: 6f73 745b 2244 6976 6964 656e 6473 225d  ost["Dividends"]
-0000c380: 2021 3d20 305d 5b5b 2244 6976 6964 656e   != 0][["Dividen
-0000c390: 6473 222c 2022 4665 7463 6844 6174 6522  ds", "FetchDate"
-0000c3a0: 5d5d 2e63 6f70 7928 290a 2020 2020 2020  ]].copy().      
-0000c3b0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0000c3c0: 2068 325f 706f 7374 5f64 6976 732e 656d   h2_post_divs.em
-0000c3d0: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-0000c3e0: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-0000c3f0: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-0000c400: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000c410: 7269 6e74 2822 2d20 6832 5f70 6f73 745f  rint("- h2_post_
-0000c420: 6469 7673 3a22 290a 2020 2020 2020 2020  divs:").        
-0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c440: 7072 696e 7428 6832 5f70 6f73 745f 6469  print(h2_post_di
-0000c450: 7673 290a 2020 2020 2020 2020 2020 2020  vs).            
-0000c460: 2020 2020 2020 2020 6361 6368 6564 5f6e          cached_n
-0000c470: 6577 5f64 6976 7320 3d20 7966 636d 2e52  ew_divs = yfcm.R
-0000c480: 6561 6443 6163 6865 4461 7475 6d28 7365  eadCacheDatum(se
-0000c490: 6c66 2e74 6963 6b65 722c 2022 6e65 775f  lf.ticker, "new_
-0000c4a0: 6469 7673 2229 0a20 2020 2020 2020 2020  divs").         
-0000c4b0: 2020 2020 2020 2020 2020 2069 6620 6361             if ca
-0000c4c0: 6368 6564 5f6e 6577 5f64 6976 7320 6973  ched_new_divs is
-0000c4d0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4f0: 2020 2069 6620 7966 636d 2e52 6561 6443     if yfcm.ReadC
-0000c500: 6163 6865 4d65 7461 6461 7461 2873 656c  acheMetadata(sel
-0000c510: 662e 7469 636b 6572 2c20 226e 6577 5f64  f.ticker, "new_d
-0000c520: 6976 7322 2c20 226c 6f63 6b65 6422 2920  ivs", "locked") 
-0000c530: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c550: 2020 2020 2020 2020 2023 206c 6f63 6b65           # locke
-0000c560: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000c570: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0000c580: 7373 0a20 2020 2020 2020 2020 2020 2020  ss.             
-0000c590: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000c5a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c5b0: 2020 2020 2020 2020 2020 2020 2063 6163               cac
-0000c5c0: 6865 645f 6e65 775f 6469 7673 203d 2070  hed_new_divs = p
-0000c5d0: 642e 636f 6e63 6174 285b 6361 6368 6564  d.concat([cached
-0000c5e0: 5f6e 6577 5f64 6976 732c 2068 325f 706f  _new_divs, h2_po
-0000c5f0: 7374 5f64 6976 735d 290a 2020 2020 2020  st_divs]).      
-0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c610: 2020 2020 2020 7966 636d 2e53 746f 7265        yfcm.Store
-0000c620: 4361 6368 6544 6174 756d 2873 656c 662e  CacheDatum(self.
-0000c630: 7469 636b 6572 2c20 226e 6577 5f64 6976  ticker, "new_div
-0000c640: 7322 2c20 6361 6368 6564 5f6e 6577 5f64  s", cached_new_d
-0000c650: 6976 7329 0a20 2020 2020 2020 2020 2020  ivs).           
-0000c660: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000c670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c680: 2020 2020 2020 2079 6663 6d2e 5374 6f72         yfcm.Stor
-0000c690: 6543 6163 6865 4461 7475 6d28 7365 6c66  eCacheDatum(self
-0000c6a0: 2e74 6963 6b65 722c 2022 6e65 775f 6469  .ticker, "new_di
-0000c6b0: 7673 222c 2068 325f 706f 7374 5f64 6976  vs", h2_post_div
-0000c6c0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-0000c6d0: 2320 4261 636b 706f 7274 206e 6577 2065  # Backport new e
-0000c6e0: 7665 6e74 7320 6163 726f 7373 2065 6e74  vents across ent
-0000c6f0: 6972 6520 6820 7461 626c 650a 2020 2020  ire h table.    
-0000c700: 2020 2020 2020 2020 7365 6c66 2e5f 6170          self._ap
-0000c710: 706c 794e 6577 4576 656e 7473 2829 0a0a  plyNewEvents()..
-0000c720: 2020 2020 2020 2020 2020 2020 6966 2068              if h
-0000c730: 325f 706f 7374 2069 7320 6e6f 7420 4e6f  2_post is not No
-0000c740: 6e65 2061 6e64 206e 6f74 2069 7369 6e73  ne and not isins
-0000c750: 7461 6e63 6528 6832 5f70 6f73 742e 696e  tance(h2_post.in
-0000c760: 6465 782c 2070 642e 4461 7465 7469 6d65  dex, pd.Datetime
-0000c770: 496e 6465 7829 3a0a 2020 2020 2020 2020  Index):.        
-0000c780: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-0000c790: 6365 7074 696f 6e28 2268 325f 706f 7374  ception("h2_post
-0000c7a0: 2e69 6e64 6578 206e 6f74 2044 6174 6574  .index not Datet
-0000c7b0: 696d 6549 6e64 6578 2229 0a0a 2020 2020  imeIndex")..    
-0000c7c0: 2020 2020 2020 2020 6966 2022 4164 6a20          if "Adj 
-0000c7d0: 436c 6f73 6522 2069 6e20 6832 5f70 6f73  Close" in h2_pos
-0000c7e0: 742e 636f 6c75 6d6e 733a 0a20 2020 2020  t.columns:.     
-0000c7f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000c800: 2045 7863 6570 7469 6f6e 2822 4164 6a20   Exception("Adj 
-0000c810: 436c 6f73 6520 696e 2068 325f 706f 7374  Close in h2_post
-0000c820: 2229 0a20 2020 2020 2020 2020 2020 2073  ").            s
-0000c830: 656c 662e 6820 3d20 7064 2e63 6f6e 6361  elf.h = pd.conca
-0000c840: 7428 5b73 656c 662e 682c 2068 325f 706f  t([self.h, h2_po
-0000c850: 7374 5d2c 2073 6f72 743d 5472 7565 290a  st], sort=True).
-0000c860: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000c870: 2e68 2e69 6e64 6578 203d 2070 642e 746f  .h.index = pd.to
-0000c880: 5f64 6174 6574 696d 6528 7365 6c66 2e68  _datetime(self.h
-0000c890: 2e69 6e64 6578 2c20 7574 633d 5472 7565  .index, utc=True
-0000c8a0: 292e 747a 5f63 6f6e 7665 7274 2874 7a5f  ).tz_convert(tz_
-0000c8b0: 6578 6368 616e 6765 290a 0a20 2020 2020  exchange)..     
-0000c8c0: 2020 2069 6620 6832 5f70 7265 2069 7320     if h2_pre is 
-0000c8d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000c8e0: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
-0000c8f0: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-0000c900: 2020 2020 7072 696e 7428 222d 2070 7265      print("- pre
-0000c910: 7065 6e64 696e 6720 6e65 7720 6461 7461  pending new data
-0000c920: 2229 0a20 2020 2020 2020 2020 2020 2023  ").            #
-0000c930: 2053 696d 706c 6520 7072 6570 656e 6420   Simple prepend 
-0000c940: 746f 2074 6f70 206f 6620 7461 626c 650a  to top of table.
-0000c950: 0a20 2020 2020 2020 2020 2020 2068 325f  .            h2_
-0000c960: 7072 6520 3d20 7365 6c66 2e5f 7265 7665  pre = self._reve
-0000c970: 7273 6559 6168 6f6f 4164 6a75 7374 2868  rseYahooAdjust(h
-0000c980: 325f 7072 6529 0a0a 2020 2020 2020 2020  2_pre)..        
-0000c990: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-0000c9a0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0000c9b0: 6572 7661 6c2e 4461 7973 313a 0a20 2020  erval.Days1:.   
-0000c9c0: 2020 2020 2020 2020 2020 2020 2068 325f               h2_
-0000c9d0: 7072 655f 7370 6c69 7473 203d 2068 325f  pre_splits = h2_
-0000c9e0: 7072 655b 6832 5f70 7265 5b22 5374 6f63  pre[h2_pre["Stoc
-0000c9f0: 6b20 5370 6c69 7473 225d 2021 3d20 305d  k Splits"] != 0]
-0000ca00: 5b5b 2253 746f 636b 2053 706c 6974 7322  [["Stock Splits"
-0000ca10: 2c20 2246 6574 6368 4461 7465 225d 5d2e  , "FetchDate"]].
-0000ca20: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-0000ca30: 2020 2020 2020 2069 6620 6e6f 7420 6832         if not h2
-0000ca40: 5f70 7265 5f73 706c 6974 732e 656d 7074  _pre_splits.empt
-0000ca50: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000ca60: 2020 2020 2020 2073 656c 662e 6d61 6e61         self.mana
-0000ca70: 6765 722e 4765 7448 6973 746f 7279 2822  ger.GetHistory("
-0000ca80: 4576 656e 7473 2229 2e55 7064 6174 6553  Events").UpdateS
-0000ca90: 706c 6974 7328 6832 5f70 7265 5f73 706c  plits(h2_pre_spl
-0000caa0: 6974 7329 0a0a 2020 2020 2020 2020 2020  its)..          
-0000cab0: 2020 2020 2020 6832 5f70 7265 5f64 6976        h2_pre_div
-0000cac0: 7320 3d20 6832 5f70 7265 5b68 325f 7072  s = h2_pre[h2_pr
-0000cad0: 655b 2244 6976 6964 656e 6473 225d 2021  e["Dividends"] !
-0000cae0: 3d20 305d 5b5b 2244 6976 6964 656e 6473  = 0][["Dividends
-0000caf0: 222c 2022 4665 7463 6844 6174 6522 5d5d  ", "FetchDate"]]
-0000cb00: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
-0000cb10: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
-0000cb20: 325f 7072 655f 6469 7673 2e65 6d70 7479  2_pre_divs.empty
-0000cb30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cb40: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
-0000cb50: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
-0000cb60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000cb70: 7428 222d 2068 325f 7072 655f 6469 7673  t("- h2_pre_divs
-0000cb80: 3a22 290a 2020 2020 2020 2020 2020 2020  :").            
-0000cb90: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000cba0: 7428 6832 5f70 7265 5f64 6976 7329 0a20  t(h2_pre_divs). 
-0000cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbc0: 2020 2063 6163 6865 645f 6e65 775f 6469     cached_new_di
-0000cbd0: 7673 203d 2079 6663 6d2e 5265 6164 4361  vs = yfcm.ReadCa
-0000cbe0: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
-0000cbf0: 636b 6572 2c20 226e 6577 5f64 6976 7322  cker, "new_divs"
-0000cc00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000cc10: 2020 2020 2020 6966 2063 6163 6865 645f        if cached_
-0000cc20: 6e65 775f 6469 7673 2069 7320 6e6f 7420  new_divs is not 
-0000cc30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000cc40: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000cc50: 2079 6663 6d2e 5265 6164 4361 6368 654d   yfcm.ReadCacheM
-0000cc60: 6574 6164 6174 6128 7365 6c66 2e74 6963  etadata(self.tic
-0000cc70: 6b65 722c 2022 6e65 775f 6469 7673 222c  ker, "new_divs",
-0000cc80: 2022 6c6f 636b 6564 2229 2069 7320 6e6f   "locked") is no
-0000cc90: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccb0: 2020 2020 2320 6c6f 636b 6564 0a20 2020      # locked.   
-0000ccc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccd0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-0000cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccf0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000ba40: 2320 5468 656e 2074 6865 2065 7863 6570  # Then the excep
+0000ba50: 7469 6f6e 2061 626f 7665 206f 6363 7572  tion above occur
+0000ba60: 7265 6420 6265 6361 7573 6520 7472 7969  red because tryi
+0000ba70: 6e67 2074 6f20 6665 7463 6820 6265 666f  ng to fetch befo
+0000ba80: 7265 206c 6973 7469 6e67 2064 6174 6564  re listing dated
+0000ba90: 210a 2020 2020 2020 2020 2020 2020 2320  !.            # 
+0000baa0: 2020 2020 2020 2020 7966 636d 2e53 746f          yfcm.Sto
+0000bab0: 7265 4361 6368 6544 6174 756d 2873 656c  reCacheDatum(sel
+0000bac0: 662e 7469 636b 6572 2c20 226c 6973 7469  f.ticker, "listi
+0000bad0: 6e67 5f64 6174 6522 2c20 7365 6c66 2e68  ng_date", self.h
+0000bae0: 2e69 6e64 6578 5b30 5d2e 6461 7465 2829  .index[0].date()
+0000baf0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0000bb00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000bb10: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0000bb20: 2320 5468 656e 2074 6865 2065 7863 6570  # Then the excep
+0000bb30: 7469 6f6e 2061 626f 7665 2077 6173 2067  tion above was g
+0000bb40: 656e 7569 6e65 2061 6e64 206e 6565 6473  enuine and needs
+0000bb50: 2074 6f20 6265 2070 726f 7061 6761 7465   to be propagate
+0000bb60: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
+0000bb70: 2020 2020 2020 2020 7261 6973 6520 7966          raise yf
+0000bb80: 6364 2e4e 6f50 7269 6365 4461 7461 496e  cd.NoPriceDataIn
+0000bb90: 5261 6e67 6545 7863 6570 7469 6f6e 2873  RangeException(s
+0000bba0: 656c 662e 7469 636b 6572 2c20 7365 6c66  elf.ticker, self
+0000bbb0: 2e69 7374 722c 2072 5b30 5d2c 2072 5b31  .istr, r[0], r[1
+0000bbc0: 5d29 0a0a 2020 2020 2020 2020 6966 2072  ])..        if r
+0000bbd0: 616e 6765 5f70 6f73 7420 6973 206e 6f74  ange_post is not
+0000bbe0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000bbf0: 2020 2072 203d 2072 616e 6765 5f70 6f73     r = range_pos
+0000bc00: 740a 2020 2020 2020 2020 2020 2020 7472  t.            tr
+0000bc10: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000bc20: 2020 2068 325f 706f 7374 203d 2073 656c     h2_post = sel
+0000bc30: 662e 5f66 6574 6368 5966 4869 7374 6f72  f._fetchYfHistor
+0000bc40: 7928 7073 7472 2c20 725b 305d 2c20 725b  y(pstr, r[0], r[
+0000bc50: 315d 2c20 7072 6570 6f73 742c 2064 6562  1], prepost, deb
+0000bc60: 7567 290a 2020 2020 2020 2020 2020 2020  ug).            
+0000bc70: 6578 6365 7074 2079 6663 642e 4e6f 5072  except yfcd.NoPr
+0000bc80: 6963 6544 6174 6149 6e52 616e 6765 4578  iceDataInRangeEx
+0000bc90: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+0000bca0: 2020 2020 2020 2020 2023 2049 6620 6f6e           # If on
+0000bcb0: 6c79 2074 7279 696e 6720 746f 2066 6574  ly trying to fet
+0000bcc0: 6368 2031 2064 6179 206f 6620 3164 2064  ch 1 day of 1d d
+0000bcd0: 6174 612c 2074 6865 6e20 7072 696e 7420  ata, then print 
+0000bce0: 7761 726e 696e 6720 696e 7374 6561 6420  warning instead 
+0000bcf0: 6f66 2065 7863 6570 7469 6f6e 2e0a 2020  of exception..  
+0000bd00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000bd10: 436f 756c 6420 6164 6420 6164 6469 7469  Could add additi
+0000bd20: 6f6e 616c 2063 6f6e 6469 7469 6f6e 206f  onal condition o
+0000bd30: 6620 6469 7669 6465 6e64 2070 7265 7669  f dividend previ
+0000bd40: 6f75 7320 6461 7920 2873 6565 6d73 2074  ous day (seems t
+0000bd50: 6f20 6d65 7373 2075 7020 7461 626c 6529  o mess up table)
+0000bd60: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000bd70: 2020 6966 2073 656c 662e 696e 7465 7276    if self.interv
+0000bd80: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
+0000bd90: 7661 6c2e 4461 7973 3120 616e 6420 725b  val.Days1 and r[
+0000bda0: 315d 202d 2072 5b30 5d20 3d3d 2074 645f  1] - r[0] == td_
+0000bdb0: 3164 3a0a 2020 2020 2020 2020 2020 2020  1d:.            
+0000bdc0: 2020 2020 2020 2020 6966 206e 6f74 2071          if not q
+0000bdd0: 7569 6574 3a0a 2020 2020 2020 2020 2020  uiet:.          
+0000bde0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000bdf0: 7072 696e 7428 2257 4152 4e49 4e47 3a20  print("WARNING: 
+0000be00: 4e6f 207b 7d2d 7072 6963 6520 6461 7461  No {}-price data
+0000be10: 2066 6574 6368 6564 2066 6f72 2074 6963   fetched for tic
+0000be20: 6b65 7220 7b7d 2062 6574 7765 656e 2064  ker {} between d
+0000be30: 6174 6573 207b 7d20 2d3e 207b 7d22 2e66  ates {} -> {}".f
+0000be40: 6f72 6d61 7428 7966 6364 2e69 6e74 6572  ormat(yfcd.inter
+0000be50: 7661 6c54 6f53 7472 696e 675b 7365 6c66  valToString[self
+0000be60: 2e69 6e74 6572 7661 6c5d 2c20 7365 6c66  .interval], self
+0000be70: 2e74 6963 6b65 722c 2072 5b30 5d2c 2072  .ticker, r[0], r
+0000be80: 5b31 5d29 290a 2020 2020 2020 2020 2020  [1])).          
+0000be90: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000bea0: 696e 7428 6622 5741 524e 494e 473a 207b  int(f"WARNING: {
+0000beb0: 7365 6c66 2e74 6963 6b65 727d 3a20 4e6f  self.ticker}: No
+0000bec0: 207b 7966 6364 2e69 6e74 6572 7661 6c54   {yfcd.intervalT
+0000bed0: 6f53 7472 696e 675b 7365 6c66 2e69 6e74  oString[self.int
+0000bee0: 6572 7661 6c5d 7d2d 7072 6963 6520 6461  erval]}-price da
+0000bef0: 7461 2066 6574 6368 6564 2066 6f72 207b  ta fetched for {
+0000bf00: 725b 305d 7d20 2d3e 207b 725b 315d 7d22  r[0]} -> {r[1]}"
+0000bf10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000bf20: 2020 2020 2020 6832 5f70 6f73 7420 3d20        h2_post = 
+0000bf30: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000bf40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000bf50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000bf60: 6169 7365 0a0a 2020 2020 2020 2020 6c69  aise..        li
+0000bf70: 7374 696e 675f 6461 7465 203d 2079 6663  sting_date = yfc
+0000bf80: 6d2e 5265 6164 4361 6368 6544 6174 756d  m.ReadCacheDatum
+0000bf90: 2873 656c 662e 7469 636b 6572 2c20 226c  (self.ticker, "l
+0000bfa0: 6973 7469 6e67 5f64 6174 6522 290a 2020  isting_date").  
+0000bfb0: 2020 2020 2020 6966 206c 6973 7469 6e67        if listing
+0000bfc0: 5f64 6174 6520 6973 204e 6f6e 653a 0a20  _date is None:. 
+0000bfd0: 2020 2020 2020 2020 2020 206c 6973 7469             listi
+0000bfe0: 6e67 5f64 6174 6520 3d20 7365 6c66 2e64  ng_date = self.d
+0000bff0: 6174 2e68 6973 746f 7279 5f6d 6574 6164  at.history_metad
+0000c000: 6174 615b 2266 6972 7374 5472 6164 6544  ata["firstTradeD
+0000c010: 6174 6522 5d0a 2020 2020 2020 2020 2020  ate"].          
+0000c020: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000c030: 6c69 7374 696e 675f 6461 7465 2c20 696e  listing_date, in
+0000c040: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+0000c050: 2020 2020 6c69 7374 696e 675f 6461 7465      listing_date
+0000c060: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
+0000c070: 6528 6c69 7374 696e 675f 6461 7465 2c20  e(listing_date, 
+0000c080: 756e 6974 3d27 7327 2c20 7574 633d 5472  unit='s', utc=Tr
+0000c090: 7565 292e 747a 5f63 6f6e 7665 7274 2874  ue).tz_convert(t
+0000c0a0: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
+0000c0b0: 2020 2020 2020 2020 7966 636d 2e53 746f          yfcm.Sto
+0000c0c0: 7265 4361 6368 6544 6174 756d 2873 656c  reCacheDatum(sel
+0000c0d0: 662e 7469 636b 6572 2c20 226c 6973 7469  f.ticker, "listi
+0000c0e0: 6e67 5f64 6174 6522 2c20 6c69 7374 696e  ng_date", listin
+0000c0f0: 675f 6461 7465 2e64 6174 6528 2929 0a0a  g_date.date())..
+0000c100: 2020 2020 2020 2020 6966 2068 325f 706f          if h2_po
+0000c110: 7374 2069 7320 6e6f 7420 4e6f 6e65 3a0a  st is not None:.
+0000c120: 2020 2020 2020 2020 2020 2020 2320 4465              # De
+0000c130: 2d61 646a 7573 7420 7468 6520 6e65 7720  -adjust the new 
+0000c140: 6461 7461 2c20 616e 6420 6261 636b 706f  data, and backpo
+0000c150: 7274 2061 6e79 206e 6577 2065 7665 6e74  rt any new event
+0000c160: 7320 696e 2063 6163 6865 6420 6461 7461  s in cached data
+0000c170: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+0000c180: 6f74 653a 2059 6168 6f6f 2061 6c77 6179  ote: Yahoo alway
+0000c190: 7320 7265 7475 726e 7320 7370 6c69 742d  s returns split-
+0000c1a0: 6164 6a75 7374 6564 2070 7269 6365 2c20  adjusted price, 
+0000c1b0: 736f 2072 6576 6572 7365 2069 740a 0a20  so reverse it.. 
+0000c1c0: 2020 2020 2020 2020 2020 2023 2053 696d             # Sim
+0000c1d0: 706c 6520 6170 7065 6e64 2074 6f20 626f  ple append to bo
+0000c1e0: 7474 6f6d 206f 6620 7461 626c 650a 2020  ttom of table.  
+0000c1f0: 2020 2020 2020 2020 2020 2320 3129 2061            # 1) a
+0000c200: 646a 7573 7420 6832 5f70 6f73 740a 2020  djust h2_post.  
+0000c210: 2020 2020 2020 2020 2020 6832 5f70 6f73            h2_pos
+0000c220: 7420 3d20 7365 6c66 2e5f 7265 7665 7273  t = self._revers
+0000c230: 6559 6168 6f6f 4164 6a75 7374 2868 325f  eYahooAdjust(h2_
+0000c240: 706f 7374 290a 2020 2020 2020 2020 2020  post).          
+0000c250: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+0000c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c270: 7072 696e 7428 222d 2068 325f 706f 7374  print("- h2_post
+0000c280: 3a22 290a 2020 2020 2020 2020 2020 2020  :").            
+0000c290: 2020 2020 7072 696e 7428 6832 5f70 6f73      print(h2_pos
+0000c2a0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+0000c2b0: 2320 544f 444f 3a20 5072 6f62 6c65 6d3a  # TODO: Problem:
+0000c2c0: 2064 6976 6964 656e 6473 206e 6565 6420   dividends need 
+0000c2d0: 636f 7272 6563 7420 636c 6f73 650a 2020  correct close.  
+0000c2e0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0000c2f0: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+0000c300: 6364 2e49 6e74 6572 7661 6c2e 4461 7973  cd.Interval.Days
+0000c310: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0000c320: 2020 2068 325f 706f 7374 5f73 706c 6974     h2_post_split
+0000c330: 7320 3d20 6832 5f70 6f73 745b 6832 5f70  s = h2_post[h2_p
+0000c340: 6f73 745b 2253 746f 636b 2053 706c 6974  ost["Stock Split
+0000c350: 7322 5d20 213d 2030 5d5b 5b22 5374 6f63  s"] != 0][["Stoc
+0000c360: 6b20 5370 6c69 7473 222c 2022 4665 7463  k Splits", "Fetc
+0000c370: 6844 6174 6522 5d5d 2e63 6f70 7928 290a  hDate"]].copy().
+0000c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c390: 6966 206e 6f74 2068 325f 706f 7374 5f73  if not h2_post_s
+0000c3a0: 706c 6974 732e 656d 7074 793a 0a20 2020  plits.empty:.   
+0000c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3c0: 2073 656c 662e 6d61 6e61 6765 722e 4765   self.manager.Ge
+0000c3d0: 7448 6973 746f 7279 2822 4576 656e 7473  tHistory("Events
+0000c3e0: 2229 2e55 7064 6174 6553 706c 6974 7328  ").UpdateSplits(
+0000c3f0: 6832 5f70 6f73 745f 7370 6c69 7473 290a  h2_post_splits).
+0000c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c410: 2320 5570 6461 7465 3a20 6d6f 7669 6e67  # Update: moving
+0000c420: 2055 7064 6174 6544 6976 6964 656e 6473   UpdateDividends
+0000c430: 2829 2074 6f20 6166 7465 7220 7265 7061  () to after repa
+0000c440: 6972 0a20 2020 2020 2020 2020 2020 2020  ir.             
+0000c450: 2020 2068 325f 706f 7374 5f64 6976 7320     h2_post_divs 
+0000c460: 3d20 6832 5f70 6f73 745b 6832 5f70 6f73  = h2_post[h2_pos
+0000c470: 745b 2244 6976 6964 656e 6473 225d 2021  t["Dividends"] !
+0000c480: 3d20 305d 5b5b 2244 6976 6964 656e 6473  = 0][["Dividends
+0000c490: 222c 2022 4665 7463 6844 6174 6522 5d5d  ", "FetchDate"]]
+0000c4a0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+0000c4b0: 2020 2020 2020 2020 6966 206e 6f74 2068          if not h
+0000c4c0: 325f 706f 7374 5f64 6976 732e 656d 7074  2_post_divs.empt
+0000c4d0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000c4e0: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
+0000c4f0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
+0000c500: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000c510: 6e74 2822 2d20 6832 5f70 6f73 745f 6469  nt("- h2_post_di
+0000c520: 7673 3a22 290a 2020 2020 2020 2020 2020  vs:").          
+0000c530: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000c540: 696e 7428 6832 5f70 6f73 745f 6469 7673  int(h2_post_divs
+0000c550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000c560: 2020 2020 2020 6361 6368 6564 5f6e 6577        cached_new
+0000c570: 5f64 6976 7320 3d20 7966 636d 2e52 6561  _divs = yfcm.Rea
+0000c580: 6443 6163 6865 4461 7475 6d28 7365 6c66  dCacheDatum(self
+0000c590: 2e74 6963 6b65 722c 2022 6e65 775f 6469  .ticker, "new_di
+0000c5a0: 7673 2229 0a20 2020 2020 2020 2020 2020  vs").           
+0000c5b0: 2020 2020 2020 2020 2069 6620 6361 6368           if cach
+0000c5c0: 6564 5f6e 6577 5f64 6976 7320 6973 206e  ed_new_divs is n
+0000c5d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5f0: 2069 6620 7966 636d 2e52 6561 6443 6163   if yfcm.ReadCac
+0000c600: 6865 4d65 7461 6461 7461 2873 656c 662e  heMetadata(self.
+0000c610: 7469 636b 6572 2c20 226e 6577 5f64 6976  ticker, "new_div
+0000c620: 7322 2c20 226c 6f63 6b65 6422 2920 6973  s", "locked") is
+0000c630: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c650: 2020 2020 2020 2023 206c 6f63 6b65 640a         # locked.
+0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c670: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0000c680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c690: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6b0: 2020 2020 2020 2020 2020 2063 6163 6865             cache
+0000c6c0: 645f 6e65 775f 6469 7673 203d 2070 642e  d_new_divs = pd.
+0000c6d0: 636f 6e63 6174 285b 6361 6368 6564 5f6e  concat([cached_n
+0000c6e0: 6577 5f64 6976 732c 2068 325f 706f 7374  ew_divs, h2_post
+0000c6f0: 5f64 6976 735d 290a 2020 2020 2020 2020  _divs]).        
+0000c700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c710: 2020 2020 7966 636d 2e53 746f 7265 4361      yfcm.StoreCa
+0000c720: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
+0000c730: 636b 6572 2c20 226e 6577 5f64 6976 7322  cker, "new_divs"
+0000c740: 2c20 6361 6368 6564 5f6e 6577 5f64 6976  , cached_new_div
+0000c750: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0000c760: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c780: 2020 2020 2079 6663 6d2e 5374 6f72 6543       yfcm.StoreC
+0000c790: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
+0000c7a0: 6963 6b65 722c 2022 6e65 775f 6469 7673  icker, "new_divs
+0000c7b0: 222c 2068 325f 706f 7374 5f64 6976 7329  ", h2_post_divs)
+0000c7c0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000c7d0: 4261 636b 706f 7274 206e 6577 2065 7665  Backport new eve
+0000c7e0: 6e74 7320 6163 726f 7373 2065 6e74 6972  nts across entir
+0000c7f0: 6520 6820 7461 626c 650a 2020 2020 2020  e h table.      
+0000c800: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
+0000c810: 794e 6577 4576 656e 7473 2829 0a0a 2020  yNewEvents()..  
+0000c820: 2020 2020 2020 2020 2020 6966 2068 325f            if h2_
+0000c830: 706f 7374 2069 7320 6e6f 7420 4e6f 6e65  post is not None
+0000c840: 2061 6e64 206e 6f74 2069 7369 6e73 7461   and not isinsta
+0000c850: 6e63 6528 6832 5f70 6f73 742e 696e 6465  nce(h2_post.inde
+0000c860: 782c 2070 642e 4461 7465 7469 6d65 496e  x, pd.DatetimeIn
+0000c870: 6465 7829 3a0a 2020 2020 2020 2020 2020  dex):.          
+0000c880: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+0000c890: 7074 696f 6e28 2268 325f 706f 7374 2e69  ption("h2_post.i
+0000c8a0: 6e64 6578 206e 6f74 2044 6174 6574 696d  ndex not Datetim
+0000c8b0: 6549 6e64 6578 2229 0a0a 2020 2020 2020  eIndex")..      
+0000c8c0: 2020 2020 2020 6966 2022 4164 6a20 436c        if "Adj Cl
+0000c8d0: 6f73 6522 2069 6e20 6832 5f70 6f73 742e  ose" in h2_post.
+0000c8e0: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+0000c8f0: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+0000c900: 7863 6570 7469 6f6e 2822 4164 6a20 436c  xception("Adj Cl
+0000c910: 6f73 6520 696e 2068 325f 706f 7374 2229  ose in h2_post")
+0000c920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000c930: 662e 6820 3d20 7064 2e63 6f6e 6361 7428  f.h = pd.concat(
+0000c940: 5b73 656c 662e 682c 2068 325f 706f 7374  [self.h, h2_post
+0000c950: 5d2c 2073 6f72 743d 5472 7565 290a 2020  ], sort=True).  
+0000c960: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+0000c970: 2e69 6e64 6578 203d 2070 642e 746f 5f64  .index = pd.to_d
+0000c980: 6174 6574 696d 6528 7365 6c66 2e68 2e69  atetime(self.h.i
+0000c990: 6e64 6578 2c20 7574 633d 5472 7565 292e  ndex, utc=True).
+0000c9a0: 747a 5f63 6f6e 7665 7274 2874 7a5f 6578  tz_convert(tz_ex
+0000c9b0: 6368 616e 6765 290a 0a20 2020 2020 2020  change)..       
+0000c9c0: 2069 6620 6832 5f70 7265 2069 7320 6e6f   if h2_pre is no
+0000c9d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000c9e0: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
+0000c9f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ca00: 2020 7072 696e 7428 222d 2070 7265 7065    print("- prepe
+0000ca10: 6e64 696e 6720 6e65 7720 6461 7461 2229  nding new data")
+0000ca20: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0000ca30: 696d 706c 6520 7072 6570 656e 6420 746f  imple prepend to
+0000ca40: 2074 6f70 206f 6620 7461 626c 650a 0a20   top of table.. 
+0000ca50: 2020 2020 2020 2020 2020 2068 325f 7072             h2_pr
+0000ca60: 6520 3d20 7365 6c66 2e5f 7265 7665 7273  e = self._revers
+0000ca70: 6559 6168 6f6f 4164 6a75 7374 2868 325f  eYahooAdjust(h2_
+0000ca80: 7072 6529 0a0a 2020 2020 2020 2020 2020  pre)..          
+0000ca90: 2020 6966 2073 656c 662e 696e 7465 7276    if self.interv
+0000caa0: 616c 203d 3d20 7966 6364 2e49 6e74 6572  al == yfcd.Inter
+0000cab0: 7661 6c2e 4461 7973 313a 0a20 2020 2020  val.Days1:.     
+0000cac0: 2020 2020 2020 2020 2020 2068 325f 7072             h2_pr
+0000cad0: 655f 7370 6c69 7473 203d 2068 325f 7072  e_splits = h2_pr
+0000cae0: 655b 6832 5f70 7265 5b22 5374 6f63 6b20  e[h2_pre["Stock 
+0000caf0: 5370 6c69 7473 225d 2021 3d20 305d 5b5b  Splits"] != 0][[
+0000cb00: 2253 746f 636b 2053 706c 6974 7322 2c20  "Stock Splits", 
+0000cb10: 2246 6574 6368 4461 7465 225d 5d2e 636f  "FetchDate"]].co
+0000cb20: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0000cb30: 2020 2020 2069 6620 6e6f 7420 6832 5f70       if not h2_p
+0000cb40: 7265 5f73 706c 6974 732e 656d 7074 793a  re_splits.empty:
+0000cb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cb60: 2020 2020 2073 656c 662e 6d61 6e61 6765       self.manage
+0000cb70: 722e 4765 7448 6973 746f 7279 2822 4576  r.GetHistory("Ev
+0000cb80: 656e 7473 2229 2e55 7064 6174 6553 706c  ents").UpdateSpl
+0000cb90: 6974 7328 6832 5f70 7265 5f73 706c 6974  its(h2_pre_split
+0000cba0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0000cbb0: 2020 2020 6832 5f70 7265 5f64 6976 7320      h2_pre_divs 
+0000cbc0: 3d20 6832 5f70 7265 5b68 325f 7072 655b  = h2_pre[h2_pre[
+0000cbd0: 2244 6976 6964 656e 6473 225d 2021 3d20  "Dividends"] != 
+0000cbe0: 305d 5b5b 2244 6976 6964 656e 6473 222c  0][["Dividends",
+0000cbf0: 2022 4665 7463 6844 6174 6522 5d5d 2e63   "FetchDate"]].c
+0000cc00: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+0000cc10: 2020 2020 2020 6966 206e 6f74 2068 325f        if not h2_
+0000cc20: 7072 655f 6469 7673 2e65 6d70 7479 3a0a  pre_divs.empty:.
+0000cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc40: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
+0000cc50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000cc60: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000cc70: 222d 2068 325f 7072 655f 6469 7673 3a22  "- h2_pre_divs:"
+0000cc80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000cc90: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000cca0: 6832 5f70 7265 5f64 6976 7329 0a20 2020  h2_pre_divs).   
+0000ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ccc0: 2063 6163 6865 645f 6e65 775f 6469 7673   cached_new_divs
+0000ccd0: 203d 2079 6663 6d2e 5265 6164 4361 6368   = yfcm.ReadCach
+0000cce0: 6544 6174 756d 2873 656c 662e 7469 636b  eDatum(self.tick
+0000ccf0: 6572 2c20 226e 6577 5f64 6976 7322 290a  er, "new_divs").
 0000cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd10: 2020 2020 2020 2020 6361 6368 6564 5f6e          cached_n
-0000cd20: 6577 5f64 6976 7320 3d20 7064 2e63 6f6e  ew_divs = pd.con
-0000cd30: 6361 7428 5b63 6163 6865 645f 6e65 775f  cat([cached_new_
-0000cd40: 6469 7673 2c20 6832 5f70 7265 5f64 6976  divs, h2_pre_div
-0000cd50: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
-0000cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd70: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
-0000cd80: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
-0000cd90: 2c20 226e 6577 5f64 6976 7322 2c20 6361  , "new_divs", ca
-0000cda0: 6368 6564 5f6e 6577 5f64 6976 7329 0a20  ched_new_divs). 
-0000cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cdc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cde0: 2079 6663 6d2e 5374 6f72 6543 6163 6865   yfcm.StoreCache
-0000cdf0: 4461 7475 6d28 7365 6c66 2e74 6963 6b65  Datum(self.ticke
-0000ce00: 722c 2022 6e65 775f 6469 7673 222c 2068  r, "new_divs", h
-0000ce10: 325f 7072 655f 6469 7673 290a 0a20 2020  2_pre_divs)..   
-0000ce20: 2020 2020 2020 2020 2023 2068 325f 7072           # h2_pr
-0000ce30: 6520 3d20 6832 5f70 7265 2e64 726f 7028  e = h2_pre.drop(
-0000ce40: 5b22 4469 7669 6465 6e64 7322 2c20 2253  ["Dividends", "S
-0000ce50: 746f 636b 2053 706c 6974 7322 5d2c 2061  tock Splits"], a
-0000ce60: 7869 733d 3129 0a20 2020 2020 2020 2020  xis=1).         
-0000ce70: 2020 2069 6620 2241 646a 2043 6c6f 7365     if "Adj Close
-0000ce80: 2220 696e 2068 325f 7072 652e 636f 6c75  " in h2_pre.colu
-0000ce90: 6d6e 733a 0a20 2020 2020 2020 2020 2020  mns:.           
-0000cea0: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-0000ceb0: 7469 6f6e 2822 4164 6a20 436c 6f73 6520  tion("Adj Close 
-0000cec0: 696e 2068 325f 7072 6522 290a 2020 2020  in h2_pre").    
-0000ced0: 2020 2020 2020 2020 7365 6c66 2e68 203d          self.h =
-0000cee0: 2070 642e 636f 6e63 6174 285b 7365 6c66   pd.concat([self
-0000cef0: 2e68 2c20 6832 5f70 7265 5d2c 2073 6f72  .h, h2_pre], sor
-0000cf00: 743d 5472 7565 290a 2020 2020 2020 2020  t=True).        
-0000cf10: 2020 2020 7365 6c66 2e68 2e69 6e64 6578      self.h.index
-0000cf20: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
-0000cf30: 6528 7365 6c66 2e68 2e69 6e64 6578 2c20  e(self.h.index, 
-0000cf40: 7574 633d 5472 7565 292e 747a 5f63 6f6e  utc=True).tz_con
-0000cf50: 7665 7274 2874 7a5f 6578 6368 616e 6765  vert(tz_exchange
-0000cf60: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0000cf70: 6820 3d20 7365 6c66 2e68 2e73 6f72 745f  h = self.h.sort_
-0000cf80: 696e 6465 7828 290a 2020 2020 2020 2020  index().        
-0000cf90: 7365 6c66 2e5f 7570 6461 7465 6443 6163  self._updatedCac
-0000cfa0: 6865 6450 7269 6365 7328 7365 6c66 2e68  hedPrices(self.h
-0000cfb0: 290a 0a20 2020 2020 2020 206c 6f67 5f6d  )..        log_m
-0000cfc0: 7367 203d 2022 5f66 6574 6368 416e 6441  sg = "_fetchAndA
-0000cfd0: 6464 5261 6e67 6573 5f63 6f6e 7469 6775  ddRanges_contigu
-0000cfe0: 6f75 7328 2920 7265 7475 726e 696e 6722  ous() returning"
-0000cff0: 0a20 2020 2020 2020 2069 6620 7966 636c  .        if yfcl
-0000d000: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
-0000d010: 6428 293a 0a20 2020 2020 2020 2020 2020  d():.           
-0000d020: 2079 6663 6c2e 5472 6163 6545 7869 7428   yfcl.TraceExit(
-0000d030: 6c6f 675f 6d73 6729 0a20 2020 2020 2020  log_msg).       
-0000d040: 2065 6c69 6620 6465 6275 675f 7966 633a   elif debug_yfc:
-0000d050: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0000d060: 6e74 2822 2d20 683a 2229 0a20 2020 2020  nt("- h:").     
-0000d070: 2020 2020 2020 2070 7269 6e74 2873 656c         print(sel
-0000d080: 662e 6829 0a20 2020 2020 2020 2020 2020  f.h).           
-0000d090: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
-0000d0a0: 0a20 2020 2064 6566 205f 6665 7463 6841  .    def _fetchA
-0000d0b0: 6e64 4164 6452 616e 6765 735f 7370 6172  ndAddRanges_spar
-0000d0c0: 7365 2873 656c 662c 2070 7374 722c 2072  se(self, pstr, r
-0000d0d0: 616e 6765 735f 746f 5f66 6574 6368 2c20  anges_to_fetch, 
-0000d0e0: 7072 6570 6f73 742c 2064 6562 7567 2c20  prepost, debug, 
-0000d0f0: 7175 6965 743d 4661 6c73 6529 3a0a 2020  quiet=False):.  
-0000d100: 2020 2020 2020 6966 2070 7374 7220 6973        if pstr is
-0000d110: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000d120: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
-0000d130: 4368 6563 6b53 7472 2870 7374 722c 2022  CheckStr(pstr, "
-0000d140: 7073 7472 2229 0a20 2020 2020 2020 2079  pstr").        y
-0000d150: 6663 752e 5479 7065 4368 6563 6b49 7465  fcu.TypeCheckIte
-0000d160: 7261 626c 6528 7261 6e67 6573 5f74 6f5f  rable(ranges_to_
-0000d170: 6665 7463 682c 2022 7261 6e67 6573 5f74  fetch, "ranges_t
-0000d180: 6f5f 6665 7463 6822 290a 2020 2020 2020  o_fetch").      
-0000d190: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-0000d1a0: 426f 6f6c 2870 7265 706f 7374 2c20 2270  Bool(prepost, "p
-0000d1b0: 7265 706f 7374 2229 0a20 2020 2020 2020  repost").       
-0000d1c0: 2079 6663 752e 5479 7065 4368 6563 6b42   yfcu.TypeCheckB
-0000d1d0: 6f6f 6c28 6465 6275 672c 2022 6465 6275  ool(debug, "debu
-0000d1e0: 6722 290a 2020 2020 2020 2020 7966 6375  g").        yfcu
-0000d1f0: 2e54 7970 6543 6865 636b 426f 6f6c 2871  .TypeCheckBool(q
-0000d200: 7569 6574 2c20 2271 7569 6574 2229 0a0a  uiet, "quiet")..
-0000d210: 2020 2020 2020 2020 2320 4665 7463 6820          # Fetch 
-0000d220: 6561 6368 2072 616e 6765 2c20 6275 7420  each range, but 
-0000d230: 6361 6e20 6265 2063 6172 656c 6573 7320  can be careless 
-0000d240: 7265 6761 7264 696e 6720 6465 2d61 646a  regarding de-adj
-0000d250: 7573 7420 6265 6361 7573 650a 2020 2020  ust because.    
-0000d260: 2020 2020 2320 6765 7474 696e 6720 6576      # getting ev
-0000d270: 656e 7473 2066 726f 6d20 7468 6520 6361  ents from the ca
-0000d280: 7265 6675 6c6c 792d 6d61 6e61 6765 6420  refully-managed 
-0000d290: 6461 696c 7920 6461 7461 0a20 2020 2020  daily data.     
-0000d2a0: 2020 2069 6620 2872 616e 6765 735f 746f     if (ranges_to
-0000d2b0: 5f66 6574 6368 2069 7320 4e6f 6e65 2920  _fetch is None) 
-0000d2c0: 6f72 206c 656e 2872 616e 6765 735f 746f  or len(ranges_to
-0000d2d0: 5f66 6574 6368 2920 3d3d 2030 3a0a 2020  _fetch) == 0:.  
-0000d2e0: 2020 2020 2020 2020 2020 2320 7265 7475            # retu
-0000d2f0: 726e 2068 0a20 2020 2020 2020 2020 2020  rn h.           
-0000d300: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-0000d310: 2064 6562 7567 5f79 6663 203d 2073 656c   debug_yfc = sel
-0000d320: 662e 5f64 6562 7567 0a20 2020 2020 2020  f._debug.       
-0000d330: 2023 2064 6562 7567 5f79 6663 203d 2054   # debug_yfc = T
-0000d340: 7275 650a 0a20 2020 2020 2020 206c 6f67  rue..        log
-0000d350: 5f6d 7367 203d 2066 225f 6665 7463 6841  _msg = f"_fetchA
-0000d360: 6e64 4164 6452 616e 6765 735f 7370 6172  ndAddRanges_spar
-0000d370: 7365 2870 7265 706f 7374 3d7b 7072 6570  se(prepost={prep
-0000d380: 6f73 747d 2922 0a20 2020 2020 2020 2069  ost})".        i
-0000d390: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-0000d3a0: 456e 6162 6c65 6428 293a 0a20 2020 2020  Enabled():.     
-0000d3b0: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-0000d3c0: 6545 6e74 6572 286c 6f67 5f6d 7367 290a  eEnter(log_msg).
-0000d3d0: 2020 2020 2020 2020 656c 6966 2064 6562          elif deb
-0000d3e0: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
-0000d3f0: 2020 2020 7072 696e 7428 6c6f 675f 6d73      print(log_ms
-0000d400: 6729 0a0a 2020 2020 2020 2020 747a 5f65  g)..        tz_e
-0000d410: 7863 6861 6e67 6520 3d20 7365 6c66 2e74  xchange = self.t
-0000d420: 7a0a 2020 2020 2020 2020 7464 5f31 6420  z.        td_1d 
-0000d430: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
-0000d440: 3d31 290a 2020 2020 2020 2020 6474 6e6f  =1).        dtno
-0000d450: 7720 3d20 7064 2e54 696d 6573 7461 6d70  w = pd.Timestamp
-0000d460: 2e75 7463 6e6f 7728 292e 747a 5f63 6f6e  .utcnow().tz_con
-0000d470: 7665 7274 2874 7a5f 6578 6368 616e 6765  vert(tz_exchange
-0000d480: 290a 0a20 2020 2020 2020 2023 2042 6163  )..        # Bac
-0000d490: 6b70 6f72 7420 6576 656e 7473 2074 6861  kport events tha
-0000d4a0: 7420 6f63 6375 7272 6564 2073 696e 6365  t occurred since
-0000d4b0: 206c 6173 7420 6164 6a75 7374 6d65 6e74   last adjustment
-0000d4c0: 3a0a 2020 2020 2020 2020 7365 6c66 2e5f  :.        self._
-0000d4d0: 6170 706c 794e 6577 4576 656e 7473 2829  applyNewEvents()
-0000d4e0: 0a0a 2020 2020 2020 2020 2320 456e 7375  ..        # Ensu
-0000d4f0: 7265 2068 6176 6520 6461 696c 7920 6461  re have daily da
-0000d500: 7461 2063 6f76 6572 696e 6720 616c 6c20  ta covering all 
-0000d510: 7261 6e67 6573 5f74 6f5f 6665 7463 682c  ranges_to_fetch,
-0000d520: 2073 6f20 7468 6579 2063 616e 2062 6520   so they can be 
-0000d530: 6465 2d73 706c 6974 7465 640a 2020 2020  de-splitted.    
-0000d540: 2020 2020 725f 7374 6172 745f 6561 726c      r_start_earl
-0000d550: 6965 7374 203d 2072 616e 6765 735f 746f  iest = ranges_to
-0000d560: 5f66 6574 6368 5b30 5d5b 305d 0a20 2020  _fetch[0][0].   
-0000d570: 2020 2020 2066 6f72 2072 7374 6172 742c       for rstart,
-0000d580: 2072 656e 6420 696e 2072 616e 6765 735f   rend in ranges_
-0000d590: 746f 5f66 6574 6368 3a0a 2020 2020 2020  to_fetch:.      
-0000d5a0: 2020 2020 2020 725f 7374 6172 745f 6561        r_start_ea
-0000d5b0: 726c 6965 7374 203d 206d 696e 2872 7374  rliest = min(rst
-0000d5c0: 6172 742c 2072 5f73 7461 7274 5f65 6172  art, r_start_ear
-0000d5d0: 6c69 6573 7429 0a20 2020 2020 2020 2072  liest).        r
-0000d5e0: 5f73 7461 7274 5f65 6172 6c69 6573 745f  _start_earliest_
-0000d5f0: 6420 3d20 725f 7374 6172 745f 6561 726c  d = r_start_earl
-0000d600: 6965 7374 2e64 6174 6528 2920 6966 2069  iest.date() if i
-0000d610: 7369 6e73 7461 6e63 6528 725f 7374 6172  sinstance(r_star
-0000d620: 745f 6561 726c 6965 7374 2c20 6461 7465  t_earliest, date
-0000d630: 7469 6d65 2920 656c 7365 2072 5f73 7461  time) else r_sta
-0000d640: 7274 5f65 6172 6c69 6573 740a 2020 2020  rt_earliest.    
-0000d650: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-0000d660: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0000d670: 696e 7428 222d 2072 5f73 7461 7274 5f65  int("- r_start_e
-0000d680: 6172 6c69 6573 7420 3d20 7b7d 222e 666f  arliest = {}".fo
-0000d690: 726d 6174 2872 5f73 7461 7274 5f65 6172  rmat(r_start_ear
-0000d6a0: 6c69 6573 7429 290a 2020 2020 2020 2020  liest)).        
-0000d6b0: 2320 5472 6967 6765 7220 7072 6963 6520  # Trigger price 
-0000d6c0: 7379 6e63 3a0a 2020 2020 2020 2020 6869  sync:.        hi
-0000d6d0: 7374 4461 696c 7920 3d20 7365 6c66 2e6d  stDaily = self.m
-0000d6e0: 616e 6167 6572 2e47 6574 4869 7374 6f72  anager.GetHistor
-0000d6f0: 7928 7966 6364 2e49 6e74 6572 7661 6c2e  y(yfcd.Interval.
-0000d700: 4461 7973 3129 0a20 2020 2020 2020 2023  Days1).        #
-0000d710: 2068 6973 7444 6169 6c79 2e67 6574 2873   histDaily.get(s
-0000d720: 7461 7274 3d72 5f73 7461 7274 5f65 6172  tart=r_start_ear
-0000d730: 6c69 6573 745f 642c 206d 6178 5f61 6765  liest_d, max_age
-0000d740: 3d74 645f 3164 290a 2020 2020 2020 2020  =td_1d).        
-0000d750: 6869 7374 4461 696c 792e 6765 7428 7374  histDaily.get(st
-0000d760: 6172 743d 725f 7374 6172 745f 6561 726c  art=r_start_earl
-0000d770: 6965 7374 5f64 2c20 6d61 785f 6167 653d  iest_d, max_age=
-0000d780: 7464 5f31 642c 2072 6570 6169 723d 4661  td_1d, repair=Fa
-0000d790: 6c73 6529 0a0a 2020 2020 2020 2020 2320  lse)..        # 
-0000d7a0: 4665 7463 6820 6561 6368 2072 616e 6765  Fetch each range
-0000d7b0: 2c20 616e 6420 6164 6a75 7374 2066 6f72  , and adjust for
-0000d7c0: 2073 706c 6974 7320 7468 6174 206f 6363   splits that occ
-0000d7d0: 7572 7265 6420 6166 7465 720a 2020 2020  urred after.    
-0000d7e0: 2020 2020 666f 7220 7273 7461 7274 2c20      for rstart, 
-0000d7f0: 7265 6e64 2069 6e20 7261 6e67 6573 5f74  rend in ranges_t
-0000d800: 6f5f 6665 7463 683a 0a20 2020 2020 2020  o_fetch:.       
-0000d810: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
-0000d820: 203d 2072 7374 6172 740a 2020 2020 2020   = rstart.      
-0000d830: 2020 2020 2020 6665 7463 685f 656e 6420        fetch_end 
-0000d840: 3d20 7265 6e64 0a20 2020 2020 2020 2020  = rend.         
-0000d850: 2020 2023 2069 6620 6e6f 7420 7365 6c66     # if not self
-0000d860: 2e69 6e74 6572 6461 793a 2020 2320 616e  .interday:  # an
-0000d870: 6420 6665 7463 685f 7374 6172 742e 6461  d fetch_start.da
-0000d880: 7465 2829 203d 3d20 6665 7463 685f 656e  te() == fetch_en
-0000d890: 642e 6461 7465 2829 3a0a 2020 2020 2020  d.date():.      
-0000d8a0: 2020 2020 2020 2320 2020 2020 2320 496e        #     # In
-0000d8b0: 7472 6164 6179 2066 6574 6368 6573 2062  traday fetches b
-0000d8c0: 6568 6176 6520 6265 7474 6572 2077 6865  ehave better whe
-0000d8d0: 6e20 7469 6d65 203d 206d 6964 6e69 6768  n time = midnigh
-0000d8e0: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-0000d8f0: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
-0000d900: 3d20 6665 7463 685f 7374 6172 742e 666c  = fetch_start.fl
-0000d910: 6f6f 7228 2231 4422 290a 2020 2020 2020  oor("1D").      
-0000d920: 2020 2020 2020 2320 2020 2020 6665 7463        #     fetc
-0000d930: 685f 656e 6420 3d20 6665 7463 685f 656e  h_end = fetch_en
-0000d940: 642e 6365 696c 2822 3144 2229 0a20 2020  d.ceil("1D").   
-0000d950: 2020 2020 2020 2020 2023 2055 7064 6174           # Updat
-0000d960: 653a 2064 6174 6120 7265 6c69 6162 696c  e: data reliabil
-0000d970: 6974 7920 6e6f 7720 6669 7865 6420 6279  ity now fixed by
-0000d980: 2043 6875 6e6b 4461 7465 7349 6e74 6f59   ChunkDatesIntoY
-0000d990: 6646 6574 6368 6573 2829 0a20 2020 2020  fFetches().     
-0000d9a0: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
-0000d9b0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
-0000d9c0: 2020 2020 2070 7269 6e74 2822 2d20 6665       print("- fe
-0000d9d0: 7463 6869 6e67 207b 7d20 2d3e 207b 7d22  tching {} -> {}"
-0000d9e0: 2e66 6f72 6d61 7428 6665 7463 685f 7374  .format(fetch_st
-0000d9f0: 6172 742c 2066 6574 6368 5f65 6e64 2929  art, fetch_end))
-0000da00: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-0000da10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000da20: 2020 6832 203d 2073 656c 662e 5f66 6574    h2 = self._fet
-0000da30: 6368 5966 4869 7374 6f72 7928 7073 7472  chYfHistory(pstr
-0000da40: 2c20 6665 7463 685f 7374 6172 742c 2066  , fetch_start, f
-0000da50: 6574 6368 5f65 6e64 2c20 7072 6570 6f73  etch_end, prepos
-0000da60: 742c 2064 6562 7567 290a 2020 2020 2020  t, debug).      
-0000da70: 2020 2020 2020 6578 6365 7074 2079 6663        except yfc
-0000da80: 642e 4e6f 5072 6963 6544 6174 6149 6e52  d.NoPriceDataInR
-0000da90: 616e 6765 4578 6365 7074 696f 6e3a 0a20  angeException:. 
-0000daa0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000dab0: 2049 6620 6f6e 6c79 2074 7279 696e 6720   If only trying 
-0000dac0: 746f 2066 6574 6368 2031 2064 6179 206f  to fetch 1 day o
-0000dad0: 6620 3164 2064 6174 612c 2074 6865 6e20  f 1d data, then 
-0000dae0: 7072 696e 7420 7761 726e 696e 6720 696e  print warning in
-0000daf0: 7374 6561 6420 6f66 2065 7863 6570 7469  stead of excepti
-0000db00: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
-0000db10: 2020 2020 2320 436f 756c 6420 6164 6420      # Could add 
-0000db20: 6164 6469 7469 6f6e 616c 2063 6f6e 6469  additional condi
-0000db30: 7469 6f6e 206f 6620 6469 7669 6465 6e64  tion of dividend
-0000db40: 2070 7265 7669 6f75 7320 6461 7920 2873   previous day (s
-0000db50: 6565 6d73 2074 6f20 6d65 7373 2075 7020  eems to mess up 
-0000db60: 7461 626c 6529 2e0a 2020 2020 2020 2020  table)..        
-0000db70: 2020 2020 2020 2020 6967 6e6f 7265 203d          ignore =
-0000db80: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-0000db90: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-0000dba0: 6e74 6572 7661 6c20 3d3d 2079 6663 642e  nterval == yfcd.
-0000dbb0: 496e 7465 7276 616c 2e44 6179 7331 2061  Interval.Days1 a
-0000dbc0: 6e64 2066 6574 6368 5f65 6e64 202d 2066  nd fetch_end - f
-0000dbd0: 6574 6368 5f73 7461 7274 203d 3d20 7464  etch_start == td
-0000dbe0: 5f31 643a 0a20 2020 2020 2020 2020 2020  _1d:.           
-0000dbf0: 2020 2020 2020 2020 2069 676e 6f72 6520           ignore 
-0000dc00: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0000dc10: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-0000dc20: 2e69 6e74 7261 6461 7920 616e 6420 6665  .intraday and fe
-0000dc30: 7463 685f 7374 6172 742e 6461 7465 2829  tch_start.date()
-0000dc40: 203d 3d20 6474 6e6f 772e 6461 7465 2829   == dtnow.date()
-0000dc50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000dc60: 2020 2020 2020 6967 6e6f 7265 203d 2054        ignore = T
-0000dc70: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0000dc80: 2020 2020 656c 6966 2073 656c 662e 696e      elif self.in
-0000dc90: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
-0000dca0: 6e74 6572 7661 6c2e 4d69 6e73 3120 616e  nterval.Mins1 an
-0000dcb0: 6420 6665 7463 685f 656e 6420 2d20 6665  d fetch_end - fe
-0000dcc0: 7463 685f 7374 6172 7420 3c3d 2074 696d  tch_start <= tim
-0000dcd0: 6564 656c 7461 286d 696e 7574 6573 3d31  edelta(minutes=1
-0000dce0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-0000dcf0: 2020 2020 2020 2020 6967 6e6f 7265 203d          ignore =
-0000dd00: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0000dd10: 2020 2020 2020 6966 2069 676e 6f72 653a        if ignore:
-0000dd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dd30: 2020 2020 2069 6620 6e6f 7420 7175 6965       if not quie
-0000dd40: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0000dd50: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0000dd60: 6e74 2822 5741 524e 494e 473a 204e 6f20  nt("WARNING: No 
-0000dd70: 7b7d 2d70 7269 6365 2064 6174 6120 6665  {}-price data fe
-0000dd80: 7463 6865 6420 666f 7220 7469 636b 6572  tched for ticker
-0000dd90: 207b 7d20 6265 7477 6565 6e20 6461 7465   {} between date
-0000dda0: 7320 7b7d 202d 3e20 7b7d 222e 666f 726d  s {} -> {}".form
-0000ddb0: 6174 2879 6663 642e 696e 7465 7276 616c  at(yfcd.interval
-0000ddc0: 546f 5374 7269 6e67 5b73 656c 662e 696e  ToString[self.in
-0000ddd0: 7465 7276 616c 5d2c 2073 656c 662e 7469  terval], self.ti
-0000dde0: 636b 6572 2c20 7273 7461 7274 2c20 7265  cker, rstart, re
-0000ddf0: 6e64 2929 0a20 2020 2020 2020 2020 2020  nd)).           
-0000de00: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0000de10: 6e74 2866 2257 4152 4e49 4e47 3a20 7b73  nt(f"WARNING: {s
-0000de20: 656c 662e 7469 636b 6572 7d3a 204e 6f20  elf.ticker}: No 
-0000de30: 7b79 6663 642e 696e 7465 7276 616c 546f  {yfcd.intervalTo
-0000de40: 5374 7269 6e67 5b73 656c 662e 696e 7465  String[self.inte
-0000de50: 7276 616c 5d7d 2d70 7269 6365 2064 6174  rval]}-price dat
-0000de60: 6120 6665 7463 6865 6420 666f 7220 7b72  a fetched for {r
-0000de70: 7374 6172 747d 202d 3e20 7b72 656e 647d  start} -> {rend}
-0000de80: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0000de90: 2020 2020 2020 2068 3220 3d20 4e6f 6e65         h2 = None
-0000dea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000deb0: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-0000dec0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000ded0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000dee0: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
-0000def0: 2020 2020 2020 2020 2020 2069 6620 6832             if h2
-0000df00: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000df10: 2020 2020 2020 2020 2020 2320 7261 6973            # rais
-0000df20: 6520 4578 6365 7074 696f 6e28 2259 4620  e Exception("YF 
-0000df30: 7265 7475 726e 6564 204e 6f6e 6520 666f  returned None fo
-0000df40: 723a 2074 6b72 3d7b 7d2c 2069 6e74 6572  r: tkr={}, inter
-0000df50: 7661 6c3d 7b7d 2c20 7374 6172 743d 7b7d  val={}, start={}
-0000df60: 2c20 656e 643d 7b7d 222e 666f 726d 6174  , end={}".format
-0000df70: 2873 656c 662e 7469 636b 6572 2c20 7365  (self.ticker, se
-0000df80: 6c66 2e69 6e74 6572 7661 6c2c 2072 7374  lf.interval, rst
-0000df90: 6172 742c 2072 656e 6429 290a 2020 2020  art, rend)).    
-0000dfa0: 2020 2020 2020 2020 2020 2020 2320 7261              # ra
-0000dfb0: 6973 6520 4578 6365 7074 696f 6e28 6622  ise Exception(f"
-0000dfc0: 7966 696e 616e 6365 2e68 6973 746f 7279  yfinance.history
-0000dfd0: 2829 2072 6574 7572 6e65 6420 4e6f 6e65  () returned None
-0000dfe0: 2028 7b73 656c 662e 7469 636b 6572 7d20   ({self.ticker} 
-0000dff0: 7b73 656c 662e 6973 7472 7d20 7b72 7374  {self.istr} {rst
-0000e000: 6172 747d 2d3e 7b72 656e 647d 2922 290a  art}->{rend})").
-0000e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e020: 7261 6973 6520 7966 6364 2e4e 6f50 7269  raise yfcd.NoPri
-0000e030: 6365 4461 7461 496e 5261 6e67 6545 7863  ceDataInRangeExc
-0000e040: 6570 7469 6f6e 2873 656c 662e 7469 636b  eption(self.tick
-0000e050: 6572 2c20 7365 6c66 2e69 7374 722c 2072  er, self.istr, r
-0000e060: 7374 6172 742c 2072 656e 6429 0a20 2020  start, rend).   
-0000e070: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-0000e080: 6169 7365 2045 7863 6570 7469 6f6e 2866  aise Exception(f
-0000e090: 2279 6669 6e61 6e63 652e 6869 7374 6f72  "yfinance.histor
-0000e0a0: 7928 2920 7265 7475 726e 6564 204e 6f6e  y() returned Non
-0000e0b0: 6520 287b 7365 6c66 2e74 6963 6b65 727d  e ({self.ticker}
-0000e0c0: 207b 7365 6c66 2e69 7374 727d 207b 6665   {self.istr} {fe
-0000e0d0: 7463 685f 7374 6172 747d 2d3e 7b66 6574  tch_start}->{fet
-0000e0e0: 6368 5f65 6e64 7d29 2229 0a0a 2020 2020  ch_end})")..    
-0000e0f0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-0000e100: 2068 3220 6973 2073 706c 6974 2d61 646a   h2 is split-adj
-0000e110: 7573 7465 642e 2053 6f6d 6574 696d 6573  usted. Sometimes
-0000e120: 2059 6168 6f6f 2072 6574 7572 6e73 2075   Yahoo returns u
-0000e130: 6e61 646a 7573 7465 6420 6461 7461 0a20  nadjusted data. 
-0000e140: 2020 2020 2020 2020 2020 2068 3220 3d20             h2 = 
-0000e150: 7365 6c66 2e5f 7265 7665 7273 6559 6168  self._reverseYah
-0000e160: 6f6f 4164 6a75 7374 2868 3229 0a20 2020  ooAdjust(h2).   
-0000e170: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-0000e180: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-0000e190: 2020 2020 2020 2070 7269 6e74 2822 2d20         print("- 
-0000e1a0: 6832 2061 646a 7573 7465 643a 2229 0a20  h2 adjusted:"). 
-0000e1b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000e1c0: 7269 6e74 2868 325b 5b22 436c 6f73 6522  rint(h2[["Close"
-0000e1d0: 2c20 2244 6976 6964 656e 6473 222c 2022  , "Dividends", "
-0000e1e0: 566f 6c75 6d65 222c 2022 4353 4622 2c20  Volume", "CSF", 
-0000e1f0: 2243 4446 225d 5d29 0a0a 2020 2020 2020  "CDF"]])..      
-0000e200: 2020 2020 2020 6966 2066 6574 6368 5f73        if fetch_s
-0000e210: 7461 7274 2021 3d20 7273 7461 7274 3a0a  tart != rstart:.
-0000e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e230: 6832 203d 2068 325b 6832 2e69 6e64 6578  h2 = h2[h2.index
-0000e240: 203e 3d20 7273 7461 7274 5d0a 2020 2020   >= rstart].    
-0000e250: 2020 2020 2020 2020 6966 2066 6574 6368          if fetch
-0000e260: 5f65 6e64 2021 3d20 7265 6e64 3a0a 2020  _end != rend:.  
-0000e270: 2020 2020 2020 2020 2020 2020 2020 6832                h2
-0000e280: 203d 2068 325b 6832 2e69 6e64 6578 203c   = h2[h2.index <
-0000e290: 2072 656e 642b 7365 6c66 2e69 7464 5d0a   rend+self.itd].
-0000e2a0: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
-0000e2b0: 7064 6174 653a 2072 6570 6169 7220 4146  pdate: repair AF
-0000e2c0: 5445 5220 6665 7463 6865 730a 2020 2020  TER fetches.    
-0000e2d0: 2020 2020 2020 2020 2320 6966 2073 656c          # if sel
-0000e2e0: 662e 7265 7061 6972 3a0a 2020 2020 2020  f.repair:.      
-0000e2f0: 2020 2020 2020 2320 2020 2020 6832 203d        #     h2 =
-0000e300: 2073 656c 662e 5f72 6570 6169 725a 6572   self._repairZer
-0000e310: 6f50 7269 6365 7328 6832 290a 2020 2020  oPrices(h2).    
-0000e320: 2020 2020 2020 2020 2320 2020 2020 6832          #     h2
-0000e330: 203d 2073 656c 662e 5f72 6570 6169 7255   = self._repairU
-0000e340: 6e69 744d 6978 7570 7328 6832 290a 0a20  nitMixups(h2).. 
-0000e350: 2020 2020 2020 2020 2020 2069 6620 2241             if "A
-0000e360: 646a 2043 6c6f 7365 2220 696e 2068 322e  dj Close" in h2.
-0000e370: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0000e380: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-0000e390: 7863 6570 7469 6f6e 2822 4164 6a20 436c  xception("Adj Cl
-0000e3a0: 6f73 6520 696e 2068 3222 290a 2020 2020  ose in h2").    
-0000e3b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000e3c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000e3d0: 662e 6820 3d20 7365 6c66 2e68 5b79 6663  f.h = self.h[yfc
-0000e3e0: 752e 6e70 5f69 7369 6e5f 6f70 7469 6d69  u.np_isin_optimi
-0000e3f0: 7365 6428 7365 6c66 2e68 2e69 6e64 6578  sed(self.h.index
-0000e400: 2c20 6832 2e69 6e64 6578 2c20 696e 7665  , h2.index, inve
-0000e410: 7274 3d54 7275 6529 5d0a 2020 2020 2020  rt=True)].      
-0000e420: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-0000e430: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-0000e440: 2020 2020 2020 2020 7072 696e 7428 2273          print("s
-0000e450: 656c 662e 682e 7368 6170 653a 222c 2073  elf.h.shape:", s
-0000e460: 656c 662e 682e 7368 6170 6529 0a20 2020  elf.h.shape).   
-0000e470: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0000e480: 6e74 2822 6832 2e73 6861 7065 3a22 2c20  nt("h2.shape:", 
-0000e490: 6832 2e73 6861 7065 290a 2020 2020 2020  h2.shape).      
-0000e4a0: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-0000e4b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000e4c0: 2e68 203d 2070 642e 636f 6e63 6174 285b  .h = pd.concat([
-0000e4d0: 7365 6c66 2e68 2c20 6832 5d2c 2073 6f72  self.h, h2], sor
-0000e4e0: 743d 5472 7565 290a 2020 2020 2020 2020  t=True).        
-0000e4f0: 2020 2020 7365 6c66 2e68 2e69 6e64 6578      self.h.index
-0000e500: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
-0000e510: 6528 7365 6c66 2e68 2e69 6e64 6578 2c20  e(self.h.index, 
-0000e520: 7574 633d 5472 7565 292e 747a 5f63 6f6e  utc=True).tz_con
-0000e530: 7665 7274 2874 7a5f 6578 6368 616e 6765  vert(tz_exchange
-0000e540: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
-0000e550: 5f64 7570 7320 3d20 7365 6c66 2e68 2e69  _dups = self.h.i
-0000e560: 6e64 6578 2e64 7570 6c69 6361 7465 6428  ndex.duplicated(
-0000e570: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000e580: 2066 5f64 7570 732e 616e 7928 293a 0a20   f_dups.any():. 
-0000e590: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000e5a0: 6169 7365 2045 7863 6570 7469 6f6e 2866  aise Exception(f
-0000e5b0: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
-0000e5c0: 4164 6469 6e67 2072 616e 6765 207b 7273  Adding range {rs
-0000e5d0: 7461 7274 7d2d 3e7b 7265 6e64 7d20 6861  tart}->{rend} ha
-0000e5e0: 7320 6164 6465 6420 6475 706c 6963 6174  s added duplicat
-0000e5f0: 6520 7469 6d65 706f 696e 7473 2068 6176  e timepoints hav
-0000e600: 6520 6265 656e 2064 7570 6c69 6361 7465  e been duplicate
-0000e610: 643a 207b 7365 6c66 2e68 2e69 6e64 6578  d: {self.h.index
-0000e620: 5b66 5f64 7570 735d 7d22 290a 0a20 2020  [f_dups]}")..   
-0000e630: 2020 2020 2073 656c 662e 6820 3d20 7365       self.h = se
-0000e640: 6c66 2e68 2e73 6f72 745f 696e 6465 7828  lf.h.sort_index(
-0000e650: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-0000e660: 7570 6461 7465 6443 6163 6865 6450 7269  updatedCachedPri
-0000e670: 6365 7328 7365 6c66 2e68 290a 0a20 2020  ces(self.h)..   
-0000e680: 2020 2020 206c 6f67 5f6d 7367 203d 2022       log_msg = "
-0000e690: 5f66 6574 6368 416e 6441 6464 5261 6e67  _fetchAndAddRang
-0000e6a0: 6573 5f73 7061 7273 6528 2920 7265 7475  es_sparse() retu
-0000e6b0: 726e 696e 6722 0a20 2020 2020 2020 2069  rning".        i
-0000e6c0: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-0000e6d0: 456e 6162 6c65 6428 293a 0a20 2020 2020  Enabled():.     
-0000e6e0: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-0000e6f0: 6545 7869 7428 6c6f 675f 6d73 6729 0a20  eExit(log_msg). 
-0000e700: 2020 2020 2020 2065 6c69 6620 6465 6275         elif debu
-0000e710: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-0000e720: 2020 2070 7269 6e74 286c 6f67 5f6d 7367     print(log_msg
-0000e730: 290a 0a20 2020 2064 6566 205f 7665 7269  )..    def _veri
-0000e740: 6679 4361 6368 6564 5072 6963 6573 2873  fyCachedPrices(s
-0000e750: 656c 662c 2072 746f 6c3d 302e 3030 3031  elf, rtol=0.0001
-0000e760: 2c20 766f 6c5f 7274 6f6c 3d30 2e30 3034  , vol_rtol=0.004
-0000e770: 2c20 636f 7272 6563 743d 4661 6c73 652c  , correct=False,
-0000e780: 2064 6973 6361 7264 5f6f 6c64 3d46 616c   discard_old=Fal
-0000e790: 7365 2c20 7175 6965 743d 5472 7565 2c20  se, quiet=True, 
-0000e7a0: 6465 6275 673d 4661 6c73 6529 3a0a 2020  debug=False):.  
-0000e7b0: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-0000e7c0: 6865 636b 426f 6f6c 2863 6f72 7265 6374  heckBool(correct
-0000e7d0: 2c20 2263 6f72 7265 6374 2229 0a0a 2020  , "correct")..  
-0000e7e0: 2020 2020 2020 6966 2073 656c 662e 6820        if self.h 
-0000e7f0: 6973 204e 6f6e 6520 6f72 2073 656c 662e  is None or self.
-0000e800: 682e 656d 7074 793a 0a20 2020 2020 2020  h.empty:.       
-0000e810: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
-0000e820: 0a0a 2020 2020 2020 2020 7966 636c 2e54  ..        yfcl.T
-0000e830: 7261 6365 456e 7465 7228 6622 504d 3a3a  raceEnter(f"PM::
-0000e840: 5f76 6572 6966 7943 6163 6865 6450 7269  _verifyCachedPri
-0000e850: 6365 732d 7b73 656c 662e 6973 7472 7d28  ces-{self.istr}(
-0000e860: 636f 7272 6563 743d 7b63 6f72 7265 6374  correct={correct
-0000e870: 7d2c 2064 6562 7567 3d7b 6465 6275 677d  }, debug={debug}
-0000e880: 2922 290a 0a20 2020 2020 2020 2023 204e  )")..        # N
-0000e890: 6577 2063 6f64 653a 2068 6f70 6566 756c  ew code: hopeful
-0000e8a0: 6c79 2074 6869 7320 7769 6c6c 2063 6f72  ly this will cor
-0000e8b0: 7265 6374 2062 6164 2043 4446 2069 6e20  rect bad CDF in 
-0000e8c0: 3177 6b20 6574 630a 2020 2020 2020 2020  1wk etc.        
-0000e8d0: 7365 6c66 2e5f 6170 706c 794e 6577 4576  self._applyNewEv
-0000e8e0: 656e 7473 2829 0a0a 2020 2020 2020 2020  ents()..        
-0000e8f0: 6820 3d20 7365 6c66 2e68 2e63 6f70 7928  h = self.h.copy(
-0000e900: 2920 2023 2077 6f72 6b69 6e67 2063 6f70  )  # working cop
-0000e910: 7920 666f 7220 636f 6d70 6172 6973 6f6e  y for comparison
-0000e920: 2077 6974 6820 5946 0a20 2020 2020 2020   with YF.       
-0000e930: 2068 5f6d 6f64 6966 6965 6420 3d20 4661   h_modified = Fa
-0000e940: 6c73 650a 2020 2020 2020 2020 685f 6e65  lse.        h_ne
-0000e950: 7720 3d20 7365 6c66 2e68 2e63 6f70 7928  w = self.h.copy(
-0000e960: 2920 2023 2063 6f70 7920 666f 7220 7374  )  # copy for st
-0000e970: 6f72 696e 6720 6368 616e 6765 730a 2020  oring changes.  
-0000e980: 2020 2020 2020 2320 4b65 6570 2074 7261        # Keep tra
-0000e990: 636b 206f 6620 7072 6f62 6c65 6d73 3a0a  ck of problems:.
-0000e9a0: 2020 2020 2020 2020 665f 6469 6666 5f61          f_diff_a
-0000e9b0: 6c6c 203d 2070 642e 5365 7269 6573 286e  ll = pd.Series(n
-0000e9c0: 702e 6675 6c6c 2868 2e73 6861 7065 5b30  p.full(h.shape[0
-0000e9d0: 5d2c 2046 616c 7365 292c 2068 2e69 6e64  ], False), h.ind
-0000e9e0: 6578 290a 2020 2020 2020 2020 6e20 3d20  ex).        n = 
-0000e9f0: 682e 7368 6170 655b 305d 0a0a 2020 2020  h.shape[0]..    
-0000ea00: 2020 2020 2320 4967 6e6f 7265 206e 6f6e      # Ignore non
-0000ea10: 2d66 696e 616c 2064 6174 6120 6265 6361  -final data beca
-0000ea20: 7573 6520 7769 6c6c 2064 6966 6665 7220  use will differ 
-0000ea30: 746f 2059 6168 6f6f 0a20 2020 2020 2020  to Yahoo.       
-0000ea40: 2068 5f6c 6173 7452 6f77 203d 2068 2e69   h_lastRow = h.i
-0000ea50: 6c6f 635b 2d31 5d0a 2020 2020 2020 2020  loc[-1].        
-0000ea60: 6820 3d20 685b 685b 2246 696e 616c 3f22  h = h[h["Final?"
-0000ea70: 5d2e 746f 5f6e 756d 7079 2829 5d0a 0a20  ].to_numpy()].. 
-0000ea80: 2020 2020 2020 2023 2041 7070 6c79 2073         # Apply s
-0000ea90: 746f 636b 2d73 706c 6974 2061 646a 7573  tock-split adjus
-0000eaa0: 746d 656e 7420 746f 206d 6174 6368 2059  tment to match Y
-0000eab0: 460a 2020 2020 2020 2020 666f 7220 6320  F.        for c 
-0000eac0: 696e 205b 224f 7065 6e22 2c20 2243 6c6f  in ["Open", "Clo
-0000ead0: 7365 222c 2022 4c6f 7722 2c20 2248 6967  se", "Low", "Hig
-0000eae0: 6822 2c20 2244 6976 6964 656e 6473 225d  h", "Dividends"]
-0000eaf0: 3a0a 2020 2020 2020 2020 2020 2020 685b  :.            h[
-0000eb00: 635d 203d 2068 5b63 5d2e 746f 5f6e 756d  c] = h[c].to_num
-0000eb10: 7079 2829 202a 2068 5b22 4353 4622 5d2e  py() * h["CSF"].
-0000eb20: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-0000eb30: 2020 2068 5b22 566f 6c75 6d65 225d 203d     h["Volume"] =
-0000eb40: 2068 5b22 566f 6c75 6d65 225d 2e74 6f5f   h["Volume"].to_
-0000eb50: 6e75 6d70 7928 2920 2f20 685b 2243 5346  numpy() / h["CSF
-0000eb60: 225d 2e74 6f5f 6e75 6d70 7928 290a 0a20  "].to_numpy().. 
-0000eb70: 2020 2020 2020 2074 645f 3164 203d 2070         td_1d = p
-0000eb80: 642e 5469 6d65 6465 6c74 6128 2231 4422  d.Timedelta("1D"
-0000eb90: 290a 2020 2020 2020 2020 6474 5f6e 6f77  ).        dt_now
-0000eba0: 203d 2070 642e 5469 6d65 7374 616d 702e   = pd.Timestamp.
-0000ebb0: 7574 636e 6f77 2829 2e74 7a5f 636f 6e76  utcnow().tz_conv
-0000ebc0: 6572 7428 5a6f 6e65 496e 666f 2822 5554  ert(ZoneInfo("UT
-0000ebd0: 4322 2929 0a0a 2020 2020 2020 2020 6465  C"))..        de
-0000ebe0: 6620 5f61 6767 7265 6761 7465 5f79 6664  f _aggregate_yfd
-0000ebf0: 665f 6461 696c 7928 6466 293a 0a20 2020  f_daily(df):.   
-0000ec00: 2020 2020 2020 2020 2064 6632 203d 2064           df2 = d
-0000ec10: 662e 636f 7079 2829 0a20 2020 2020 2020  f.copy().       
-0000ec20: 2020 2020 2064 6632 5b22 5f64 6174 6522       df2["_date"
-0000ec30: 5d20 3d20 6466 322e 696e 6465 782e 6461  ] = df2.index.da
-0000ec40: 7465 0a20 2020 2020 2020 2020 2020 2064  te.            d
-0000ec50: 6632 2e6c 6f63 5b64 6632 5b22 5374 6f63  f2.loc[df2["Stoc
-0000ec60: 6b20 5370 6c69 7473 225d 203d 3d20 302c  k Splits"] == 0,
-0000ec70: 2022 5374 6f63 6b20 5370 6c69 7473 225d   "Stock Splits"]
-0000ec80: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
-0000ec90: 2069 6620 2243 4446 2220 696e 2064 662e   if "CDF" in df.
-0000eca0: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0000ecb0: 2020 2020 2020 2020 2064 6632 203d 2064           df2 = d
-0000ecc0: 6632 2e67 726f 7570 6279 2822 5f64 6174  f2.groupby("_dat
-0000ecd0: 6522 292e 6167 6728 0a20 2020 2020 2020  e").agg(.       
-0000ece0: 2020 2020 2020 2020 2020 2020 204f 7065               Ope
-0000ecf0: 6e3d 2822 4f70 656e 222c 2022 6669 7273  n=("Open", "firs
-0000ed00: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
-0000ed10: 2020 2020 2020 2020 2043 6c6f 7365 3d28           Close=(
-0000ed20: 2243 6c6f 7365 222c 2022 6c61 7374 2229  "Close", "last")
-0000ed30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ed40: 2020 2020 2020 4c6f 773d 2822 4c6f 7722        Low=("Low"
-0000ed50: 2c20 226d 696e 2229 2c0a 2020 2020 2020  , "min"),.      
-0000ed60: 2020 2020 2020 2020 2020 2020 2020 4869                Hi
-0000ed70: 6768 3d28 2248 6967 6822 2c20 226d 6178  gh=("High", "max
-0000ed80: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000ed90: 2020 2020 2020 2020 566f 6c75 6d65 3d28          Volume=(
-0000eda0: 2256 6f6c 756d 6522 2c20 2273 756d 2229  "Volume", "sum")
-0000edb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000edc0: 2020 2020 2020 4469 7669 6465 6e64 733d        Dividends=
-0000edd0: 2822 4469 7669 6465 6e64 7322 2c20 2273  ("Dividends", "s
-0000ede0: 756d 2229 2c0a 2020 2020 2020 2020 2020  um"),.          
-0000edf0: 2020 2020 2020 2020 2020 5374 6f63 6b53            StockS
-0000ee00: 706c 6974 733d 2822 5374 6f63 6b20 5370  plits=("Stock Sp
-0000ee10: 6c69 7473 222c 2022 7072 6f64 2229 2c0a  lits", "prod"),.
-0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee30: 2020 2020 4344 463d 2822 4344 4622 2c20      CDF=("CDF", 
-0000ee40: 2270 726f 6422 292c 0a20 2020 2020 2020  "prod"),.       
-0000ee50: 2020 2020 2020 2020 2020 2020 2043 5346               CSF
-0000ee60: 3d28 2243 5346 222c 2022 7072 6f64 2229  =("CSF", "prod")
-0000ee70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000ee80: 2020 2020 2020 4665 7463 6844 6174 653d        FetchDate=
-0000ee90: 2822 4665 7463 6844 6174 6522 2c20 2266  ("FetchDate", "f
-0000eea0: 6972 7374 2229 292e 7265 6e61 6d65 2863  irst")).rename(c
-0000eeb0: 6f6c 756d 6e73 3d7b 2253 746f 636b 5370  olumns={"StockSp
-0000eec0: 6c69 7473 223a 2022 5374 6f63 6b20 5370  lits": "Stock Sp
-0000eed0: 6c69 7473 227d 290a 2020 2020 2020 2020  lits"}).        
-0000eee0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000eef0: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
-0000ef00: 6466 322e 6772 6f75 7062 7928 225f 6461  df2.groupby("_da
-0000ef10: 7465 2229 2e61 6767 280a 2020 2020 2020  te").agg(.      
-0000ef20: 2020 2020 2020 2020 2020 2020 2020 4f70                Op
-0000ef30: 656e 3d28 224f 7065 6e22 2c20 2266 6972  en=("Open", "fir
-0000ef40: 7374 2229 2c0a 2020 2020 2020 2020 2020  st"),.          
-0000ef50: 2020 2020 2020 2020 2020 436c 6f73 653d            Close=
-0000ef60: 2822 436c 6f73 6522 2c20 226c 6173 7422  ("Close", "last"
-0000ef70: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0000ef80: 2020 2020 2020 2041 646a 436c 6f73 653d         AdjClose=
-0000ef90: 2822 4164 6a20 436c 6f73 6522 2c20 226c  ("Adj Close", "l
-0000efa0: 6173 7422 292c 0a20 2020 2020 2020 2020  ast"),.         
-0000efb0: 2020 2020 2020 2020 2020 204c 6f77 3d28             Low=(
-0000efc0: 224c 6f77 222c 2022 6d69 6e22 292c 0a20  "Low", "min"),. 
-0000efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efe0: 2020 2048 6967 683d 2822 4869 6768 222c     High=("High",
-0000eff0: 2022 6d61 7822 292c 0a20 2020 2020 2020   "max"),.       
-0000f000: 2020 2020 2020 2020 2020 2020 2056 6f6c               Vol
-0000f010: 756d 653d 2822 566f 6c75 6d65 222c 2022  ume=("Volume", "
-0000f020: 7375 6d22 292c 0a20 2020 2020 2020 2020  sum"),.         
-0000f030: 2020 2020 2020 2020 2020 2044 6976 6964             Divid
-0000f040: 656e 6473 3d28 2244 6976 6964 656e 6473  ends=("Dividends
-0000f050: 222c 2022 7375 6d22 292c 0a20 2020 2020  ", "sum"),.     
-0000f060: 2020 2020 2020 2020 2020 2020 2020 2053                 S
-0000f070: 746f 636b 5370 6c69 7473 3d28 2253 746f  tockSplits=("Sto
-0000f080: 636b 2053 706c 6974 7322 2c20 2270 726f  ck Splits", "pro
-0000f090: 6422 2929 2e72 656e 616d 6528 636f 6c75  d")).rename(colu
-0000f0a0: 6d6e 733d 7b22 5374 6f63 6b53 706c 6974  mns={"StockSplit
-0000f0b0: 7322 3a20 2253 746f 636b 2053 706c 6974  s": "Stock Split
-0000f0c0: 7322 2c20 2241 646a 436c 6f73 6522 3a20  s", "AdjClose": 
-0000f0d0: 2241 646a 2043 6c6f 7365 227d 290a 2020  "Adj Close"}).  
-0000f0e0: 2020 2020 2020 2020 2020 6466 322e 6c6f            df2.lo
-0000f0f0: 635b 6466 325b 2253 746f 636b 2053 706c  c[df2["Stock Spl
-0000f100: 6974 7322 5d20 3d3d 2031 2c20 2253 746f  its"] == 1, "Sto
-0000f110: 636b 2053 706c 6974 7322 5d20 3d20 300a  ck Splits"] = 0.
-0000f120: 2020 2020 2020 2020 2020 2020 6466 322e              df2.
-0000f130: 696e 6465 782e 6e61 6d65 203d 2064 662e  index.name = df.
-0000f140: 696e 6465 782e 6e61 6d65 0a20 2020 2020  index.name.     
-0000f150: 2020 2020 2020 2064 6632 2e69 6e64 6578         df2.index
-0000f160: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
-0000f170: 6528 6466 322e 696e 6465 7829 2e74 7a5f  e(df2.index).tz_
-0000f180: 6c6f 6361 6c69 7a65 2864 662e 696e 6465  localize(df.inde
-0000f190: 782e 747a 290a 2020 2020 2020 2020 2020  x.tz).          
-0000f1a0: 2020 7265 7475 726e 2064 6632 0a0a 2020    return df2..  
-0000f1b0: 2020 2020 2020 2320 466f 7220 696e 7472        # For intr
-0000f1c0: 6164 6179 2064 6174 6120 6f6c 6465 7220  aday data older 
-0000f1d0: 7468 616e 2059 6168 6f6f 206c 696d 6974  than Yahoo limit
-0000f1e0: 2c20 636f 6d70 6172 6520 6167 6772 6567  , compare aggreg
-0000f1f0: 6174 6564 2061 6761 696e 7374 2031 640a  ated against 1d.
-0000f200: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000f210: 696e 7472 6164 6179 3a0a 2020 2020 2020  intraday:.      
-0000f220: 2020 2020 2020 6474 5f6e 6f77 5f6c 6f63        dt_now_loc
-0000f230: 616c 203d 2064 745f 6e6f 772e 747a 5f63  al = dt_now.tz_c
-0000f240: 6f6e 7665 7274 2873 656c 662e 747a 4e61  onvert(self.tzNa
-0000f250: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0000f260: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
-0000f270: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
-0000f280: 6c2e 486f 7572 7331 3a0a 2020 2020 2020  l.Hours1:.      
-0000f290: 2020 2020 2020 2020 2020 6d61 785f 6c6f            max_lo
-0000f2a0: 6f6b 6261 636b 5f64 6179 7320 3d20 3336  okback_days = 36
-0000f2b0: 352a 320a 2020 2020 2020 2020 2020 2020  5*2.            
-0000f2c0: 656c 6966 2073 656c 662e 6973 7472 2069  elif self.istr i
-0000f2d0: 6e20 5b22 3930 6d22 2c20 2233 306d 222c  n ["90m", "30m",
-0000f2e0: 2022 3135 6d22 2c20 2235 6d22 2c20 2232   "15m", "5m", "2
-0000f2f0: 6d22 5d3a 0a20 2020 2020 2020 2020 2020  m"]:.           
-0000f300: 2020 2020 206d 6178 5f6c 6f6f 6b62 6163       max_lookbac
-0000f310: 6b5f 6461 7973 203d 2036 300a 2020 2020  k_days = 60.    
-0000f320: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-0000f330: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-0000f340: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
-0000f350: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0000f360: 2020 2023 206d 6178 5f6c 6f6f 6b62 6163     # max_lookbac
-0000f370: 6b5f 6461 7973 203d 2037 0a20 2020 2020  k_days = 7.     
-0000f380: 2020 2020 2020 2020 2020 206d 6178 5f6c             max_l
-0000f390: 6f6f 6b62 6163 6b5f 6461 7973 203d 2033  ookback_days = 3
-0000f3a0: 300a 2020 2020 2020 2020 2020 2020 6d61  0.            ma
-0000f3b0: 785f 6c6f 6f6b 6261 636b 203d 2074 696d  x_lookback = tim
-0000f3c0: 6564 656c 7461 2864 6179 733d 6d61 785f  edelta(days=max_
-0000f3d0: 6c6f 6f6b 6261 636b 5f64 6179 7329 0a20  lookback_days). 
-0000f3e0: 2020 2020 2020 2020 2020 206d 6178 5f6c             max_l
-0000f3f0: 6f6f 6b62 6163 6b20 2d3d 2074 696d 6564  ookback -= timed
-0000f400: 656c 7461 286d 696e 7574 6573 3d35 2920  elta(minutes=5) 
-0000f410: 2023 2061 6c6c 6f77 2074 696d 6520 666f   # allow time fo
-0000f420: 7220 7365 7276 6572 2070 726f 6365 7373  r server process
-0000f430: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0000f440: 2320 6665 7463 685f 7374 6172 745f 6d69  # fetch_start_mi
-0000f450: 6e20 3d20 6474 5f6e 6f77 5f6c 6f63 616c  n = dt_now_local
-0000f460: 2e63 6569 6c28 2231 4422 2920 2d20 6d61  .ceil("1D") - ma
-0000f470: 785f 6c6f 6f6b 6261 636b 0a20 2020 2020  x_lookback.     
-0000f480: 2020 2020 2020 2023 2066 6574 6368 5f73         # fetch_s
-0000f490: 7461 7274 5f6d 696e 203d 2064 745f 6e6f  tart_min = dt_no
-0000f4a0: 775f 6c6f 6361 6c2e 666c 6f6f 7228 2231  w_local.floor("1
-0000f4b0: 4422 2920 2d20 6d61 785f 6c6f 6f6b 6261  D") - max_lookba
-0000f4c0: 636b 0a20 2020 2020 2020 2020 2020 2066  ck.            f
-0000f4d0: 6574 6368 5f73 7461 7274 5f6d 696e 203d  etch_start_min =
-0000f4e0: 2064 745f 6e6f 775f 6c6f 6361 6c20 2d20   dt_now_local - 
-0000f4f0: 6d61 785f 6c6f 6f6b 6261 636b 0a20 2020  max_lookback.   
-0000f500: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000f510: 2e69 6e74 7261 6461 793a 0a20 2020 2020  .intraday:.     
-0000f520: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
-0000f530: 5f73 7461 7274 5f6d 696e 203d 2066 6574  _start_min = fet
-0000f540: 6368 5f73 7461 7274 5f6d 696e 2e63 6569  ch_start_min.cei
-0000f550: 6c28 2231 4422 290a 2020 2020 2020 2020  l("1D").        
-0000f560: 2020 2020 6966 2068 2e69 6e64 6578 5b30      if h.index[0
-0000f570: 5d20 3c20 6665 7463 685f 7374 6172 745f  ] < fetch_start_
-0000f580: 6d69 6e3a 0a20 2020 2020 2020 2020 2020  min:.           
-0000f590: 2020 2020 2023 2068 5f6f 6c64 203d 2068       # h_old = h
-0000f5a0: 2e6c 6f63 5b3a 6665 7463 685f 7374 6172  .loc[:fetch_star
-0000f5b0: 745f 6d69 6e2d 7469 6d65 6465 6c74 6128  t_min-timedelta(
-0000f5c0: 7365 636f 6e64 733d 3129 5d0a 2020 2020  seconds=1)].    
-0000f5d0: 2020 2020 2020 2020 2020 2020 2320 685f              # h_
-0000f5e0: 6f6c 645f 3164 203d 205f 6167 6772 6567  old_1d = _aggreg
-0000f5f0: 6174 655f 7966 6466 5f64 6169 6c79 2868  ate_yfdf_daily(h
-0000f600: 5f6f 6c64 2e64 726f 7028 5b22 4669 6e61  _old.drop(["Fina
-0000f610: 6c3f 222c 2022 432d 4368 6563 6b3f 222c  l?", "C-Check?",
-0000f620: 2022 4c61 7374 4469 7641 646a 7573 7444   "LastDivAdjustD
-0000f630: 7422 2c20 224c 6173 7453 706c 6974 4164  t", "LastSplitAd
-0000f640: 6a75 7374 4474 225d 2c20 6178 6973 3d31  justDt"], axis=1
-0000f650: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-0000f660: 2020 2020 2320 6966 2073 656c 662e 696e      # if self.in
-0000f670: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
-0000f680: 6e74 6572 7661 6c2e 486f 7572 7331 3a0a  nterval.Hours1:.
-0000f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6a0: 2320 2020 2020 6466 5f79 6620 3d20 7365  #     df_yf = se
-0000f6b0: 6c66 2e64 6174 2e68 6973 746f 7279 2869  lf.dat.history(i
-0000f6c0: 6e74 6572 7661 6c3d 2231 6422 2c20 7374  nterval="1d", st
-0000f6d0: 6172 743d 685f 6f6c 642e 696e 6465 785b  art=h_old.index[
-0000f6e0: 305d 2e64 6174 6528 292c 2065 6e64 3d68  0].date(), end=h
-0000f6f0: 5f6f 6c64 2e69 6e64 6578 5b2d 315d 2e64  _old.index[-1].d
-0000f700: 6174 6528 292b 7464 5f31 642c 2061 7574  ate()+td_1d, aut
-0000f710: 6f5f 6164 6a75 7374 3d46 616c 7365 2c20  o_adjust=False, 
-0000f720: 7265 7061 6972 3d22 7369 6c65 6e74 2229  repair="silent")
-0000f730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f740: 2023 2065 6c73 653a 0a20 2020 2020 2020   # else:.       
-0000f750: 2020 2020 2020 2020 2023 2020 2020 2064           #     d
-0000f760: 665f 7966 203d 2073 656c 662e 6461 742e  f_yf = self.dat.
-0000f770: 6869 7374 6f72 7928 696e 7465 7276 616c  history(interval
-0000f780: 3d22 3168 222c 2073 7461 7274 3d68 5f6f  ="1h", start=h_o
-0000f790: 6c64 2e69 6e64 6578 5b30 5d2e 6461 7465  ld.index[0].date
-0000f7a0: 2829 2c20 656e 643d 685f 6f6c 642e 696e  (), end=h_old.in
-0000f7b0: 6465 785b 2d31 5d2e 6461 7465 2829 2b74  dex[-1].date()+t
-0000f7c0: 645f 3164 2c20 6175 746f 5f61 646a 7573  d_1d, auto_adjus
-0000f7d0: 743d 4661 6c73 652c 2072 6570 6169 723d  t=False, repair=
-0000f7e0: 2273 696c 656e 7422 290a 2020 2020 2020  "silent").      
-0000f7f0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0000f800: 6466 5f79 6620 3d20 5f61 6767 7265 6761  df_yf = _aggrega
-0000f810: 7465 5f79 6664 665f 6461 696c 7928 6466  te_yfdf_daily(df
-0000f820: 5f79 6629 0a0a 2020 2020 2020 2020 2020  _yf)..          
-0000f830: 2020 2020 2020 2320 2320 4167 6772 6567        # # Aggreg
-0000f840: 6174 6564 2064 6174 6120 7769 6c6c 2061  ated data will a
-0000f850: 6c6d 6f73 7420 616c 7761 7973 2064 6966  lmost always dif
-0000f860: 6665 7220 6672 6f6d 2061 6374 7561 6c20  fer from actual 
-0000f870: 6461 696c 792c 2073 6f20 6f6e 6c79 0a20  daily, so only. 
-0000f880: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000f890: 2023 206c 6f6f 6b20 666f 7220 6269 6720   # look for big 
-0000f8a0: 6572 726f 7273 0a20 2020 2020 2020 2020  errors.         
-0000f8b0: 2020 2020 2020 2023 2066 5f6f 6c64 5f64         # f_old_d
-0000f8c0: 6966 6620 3d20 7966 6375 2e56 6572 6966  iff = yfcu.Verif
-0000f8d0: 7950 7269 6365 7344 6628 685f 6f6c 645f  yPricesDf(h_old_
-0000f8e0: 3164 2c20 6466 5f79 662c 2073 656c 662e  1d, df_yf, self.
-0000f8f0: 696e 7465 7276 616c 2c20 7274 6f6c 3d30  interval, rtol=0
-0000f900: 2e32 2c20 6465 6275 673d 5472 7565 290a  .2, debug=True).
-0000f910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f920: 2320 7261 6973 6520 4578 6365 7074 696f  # raise Exceptio
-0000f930: 6e28 222d 2069 6e76 6573 7469 6761 7465  n("- investigate
-0000f940: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-0000f950: 2020 2023 2066 5f6f 6c64 5f64 6966 6620     # f_old_diff 
-0000f960: 3d20 7966 6375 2e56 6572 6966 7950 7269  = yfcu.VerifyPri
-0000f970: 6365 7344 6628 685f 6f6c 645f 3164 2c20  cesDf(h_old_1d, 
-0000f980: 6466 5f79 662c 2073 656c 662e 696e 7465  df_yf, self.inte
-0000f990: 7276 616c 2c20 7274 6f6c 3d30 2e32 290a  rval, rtol=0.2).
-0000f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9b0: 2320 6966 2066 5f6f 6c64 5f64 6966 662e  # if f_old_diff.
-0000f9c0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-0000f9d0: 2020 2020 2020 2023 2020 2020 206d 7367         #     msg
-0000f9e0: 203d 2066 2253 6967 6e69 6669 6361 6e74   = f"Significant
-0000f9f0: 2064 6966 6665 7265 6e63 6573 2064 6574   differences det
-0000fa00: 6563 7465 6420 6265 7477 6565 6e20 6f6c  ected between ol
-0000fa10: 6420 7b73 656c 662e 6973 7472 7d20 6461  d {self.istr} da
-0000fa20: 7461 2061 6e64 2031 642e 220a 2020 2020  ta and 1d.".    
-0000fa30: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000fa40: 2020 7072 696e 7428 290a 2020 2020 2020    print().      
-0000fa50: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0000fa60: 2320 665f 6469 6666 5f61 6c6c 203d 2066  # f_diff_all = f
-0000fa70: 5f64 6966 665f 616c 6c20 7c20 665f 6f6c  _diff_all | f_ol
-0000fa80: 645f 6469 6666 0a20 2020 2020 2020 2020  d_diff.         
-0000fa90: 2020 2020 2020 2023 2020 2020 2062 6164         #     bad
-0000faa0: 5f64 6174 6573 203d 2066 5f6f 6c64 5f64  _dates = f_old_d
-0000fab0: 6966 662e 696e 6465 782e 6461 7465 5b66  iff.index.date[f
-0000fac0: 5f6f 6c64 5f64 6966 665d 0a20 2020 2020  _old_diff].     
-0000fad0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0000fae0: 2066 5f64 6966 665f 616c 6c5b 6e70 2e69   f_diff_all[np.i
-0000faf0: 7369 6e28 665f 6469 6666 5f61 6c6c 2e69  sin(f_diff_all.i
-0000fb00: 6e64 6578 2e64 6174 652c 2062 6164 5f64  ndex.date, bad_d
-0000fb10: 6174 6573 295d 203d 2054 7275 650a 0a20  ates)] = True.. 
-0000fb20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000fb30: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0000fb40: 2864 6973 6361 7264 5f6f 6c64 2c20 626f  (discard_old, bo
-0000fb50: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
-0000fb60: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
-0000fb70: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
-0000fb80: 536f 6d65 207b 7365 6c66 2e69 7374 727d  Some {self.istr}
-0000fb90: 2064 6174 6120 6973 206e 6f77 206f 6c64   data is now old
-0000fba0: 6572 2074 6861 6e20 7b6d 6178 5f6c 6f6f  er than {max_loo
-0000fbb0: 6b62 6163 6b5f 6461 7973 7d20 6461 7973  kback_days} days
-0000fbc0: 2220 2b5c 0a20 2020 2020 2020 2020 2020  " +\.           
-0000fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fbe0: 2022 2073 6f20 6361 6e6e 6f74 2063 6f6d   " so cannot com
-0000fbf0: 7061 7265 2074 6f20 5961 686f 6f2e 2044  pare to Yahoo. D
-0000fc00: 6973 6361 7264 206f 6c64 2064 6174 613f  iscard old data?
-0000fc10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000fc20: 2020 2020 2020 6469 7363 6172 645f 6f6c        discard_ol
-0000fc30: 6420 3d20 636c 6963 6b2e 636f 6e66 6972  d = click.confir
-0000fc40: 6d28 6d73 672c 2064 6566 6175 6c74 3d46  m(msg, default=F
-0000fc50: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
-0000fc60: 2020 2020 2020 6966 2064 6973 6361 7264        if discard
-0000fc70: 5f6f 6c64 3a0a 2020 2020 2020 2020 2020  _old:.          
-0000fc80: 2020 2020 2020 2020 2020 665f 6469 7363            f_disc
-0000fc90: 6172 6420 3d20 7064 2e53 6572 6965 7328  ard = pd.Series(
-0000fca0: 682e 696e 6465 7820 3c20 6665 7463 685f  h.index < fetch_
-0000fcb0: 7374 6172 745f 6d69 6e2c 2068 2e69 6e64  start_min, h.ind
-0000fcc0: 6578 290a 2020 2020 2020 2020 2020 2020  ex).            
-0000fcd0: 2020 2020 2020 2020 6966 2066 5f64 6973          if f_dis
-0000fce0: 6361 7264 2e61 6e79 2829 3a0a 2020 2020  card.any():.    
-0000fcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd00: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
-0000fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fd20: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0000fd30: 6622 4469 7363 6172 6469 6e67 207b 6e70  f"Discarding {np
-0000fd40: 2e73 756d 2866 5f64 6973 6361 7264 297d  .sum(f_discard)}
-0000fd50: 2f7b 6e7d 206f 6c64 2072 6f77 7320 6265  /{n} old rows be
-0000fd60: 6361 7573 6520 6361 6e27 7420 7665 7269  cause can't veri
-0000fd70: 6679 2028 6665 7463 685f 7374 6172 745f  fy (fetch_start_
-0000fd80: 6d69 6e3d 7b66 6574 6368 5f73 7461 7274  min={fetch_start
-0000fd90: 5f6d 696e 7d29 2229 0a20 2020 2020 2020  _min})").       
+0000cd10: 2020 2020 6966 2063 6163 6865 645f 6e65      if cached_ne
+0000cd20: 775f 6469 7673 2069 7320 6e6f 7420 4e6f  w_divs is not No
+0000cd30: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000cd40: 2020 2020 2020 2020 2020 2020 6966 2079              if y
+0000cd50: 6663 6d2e 5265 6164 4361 6368 654d 6574  fcm.ReadCacheMet
+0000cd60: 6164 6174 6128 7365 6c66 2e74 6963 6b65  adata(self.ticke
+0000cd70: 722c 2022 6e65 775f 6469 7673 222c 2022  r, "new_divs", "
+0000cd80: 6c6f 636b 6564 2229 2069 7320 6e6f 7420  locked") is not 
+0000cd90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cdb0: 2020 2320 6c6f 636b 6564 0a20 2020 2020    # locked.     
+0000cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cdd0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+0000cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cdf0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce10: 2020 2020 2020 6361 6368 6564 5f6e 6577        cached_new
+0000ce20: 5f64 6976 7320 3d20 7064 2e63 6f6e 6361  _divs = pd.conca
+0000ce30: 7428 5b63 6163 6865 645f 6e65 775f 6469  t([cached_new_di
+0000ce40: 7673 2c20 6832 5f70 7265 5f64 6976 735d  vs, h2_pre_divs]
+0000ce50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000ce60: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+0000ce70: 636d 2e53 746f 7265 4361 6368 6544 6174  cm.StoreCacheDat
+0000ce80: 756d 2873 656c 662e 7469 636b 6572 2c20  um(self.ticker, 
+0000ce90: 226e 6577 5f64 6976 7322 2c20 6361 6368  "new_divs", cach
+0000cea0: 6564 5f6e 6577 5f64 6976 7329 0a20 2020  ed_new_divs).   
+0000ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cec0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ced0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0000cee0: 6663 6d2e 5374 6f72 6543 6163 6865 4461  fcm.StoreCacheDa
+0000cef0: 7475 6d28 7365 6c66 2e74 6963 6b65 722c  tum(self.ticker,
+0000cf00: 2022 6e65 775f 6469 7673 222c 2068 325f   "new_divs", h2_
+0000cf10: 7072 655f 6469 7673 290a 0a20 2020 2020  pre_divs)..     
+0000cf20: 2020 2020 2020 2023 2068 325f 7072 6520         # h2_pre 
+0000cf30: 3d20 6832 5f70 7265 2e64 726f 7028 5b22  = h2_pre.drop(["
+0000cf40: 4469 7669 6465 6e64 7322 2c20 2253 746f  Dividends", "Sto
+0000cf50: 636b 2053 706c 6974 7322 5d2c 2061 7869  ck Splits"], axi
+0000cf60: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
+0000cf70: 2069 6620 2241 646a 2043 6c6f 7365 2220   if "Adj Close" 
+0000cf80: 696e 2068 325f 7072 652e 636f 6c75 6d6e  in h2_pre.column
+0000cf90: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000cfa0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0000cfb0: 6f6e 2822 4164 6a20 436c 6f73 6520 696e  on("Adj Close in
+0000cfc0: 2068 325f 7072 6522 290a 2020 2020 2020   h2_pre").      
+0000cfd0: 2020 2020 2020 7365 6c66 2e68 203d 2070        self.h = p
+0000cfe0: 642e 636f 6e63 6174 285b 7365 6c66 2e68  d.concat([self.h
+0000cff0: 2c20 6832 5f70 7265 5d2c 2073 6f72 743d  , h2_pre], sort=
+0000d000: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0000d010: 2020 7365 6c66 2e68 2e69 6e64 6578 203d    self.h.index =
+0000d020: 2070 642e 746f 5f64 6174 6574 696d 6528   pd.to_datetime(
+0000d030: 7365 6c66 2e68 2e69 6e64 6578 2c20 7574  self.h.index, ut
+0000d040: 633d 5472 7565 292e 747a 5f63 6f6e 7665  c=True).tz_conve
+0000d050: 7274 2874 7a5f 6578 6368 616e 6765 290a  rt(tz_exchange).
+0000d060: 0a20 2020 2020 2020 2073 656c 662e 6820  .        self.h 
+0000d070: 3d20 7365 6c66 2e68 2e73 6f72 745f 696e  = self.h.sort_in
+0000d080: 6465 7828 290a 2020 2020 2020 2020 7365  dex().        se
+0000d090: 6c66 2e5f 7570 6461 7465 6443 6163 6865  lf._updatedCache
+0000d0a0: 6450 7269 6365 7328 7365 6c66 2e68 290a  dPrices(self.h).
+0000d0b0: 0a20 2020 2020 2020 206c 6f67 5f6d 7367  .        log_msg
+0000d0c0: 203d 2022 5f66 6574 6368 416e 6441 6464   = "_fetchAndAdd
+0000d0d0: 5261 6e67 6573 5f63 6f6e 7469 6775 6f75  Ranges_contiguou
+0000d0e0: 7328 2920 7265 7475 726e 696e 6722 0a20  s() returning". 
+0000d0f0: 2020 2020 2020 2069 6620 7966 636c 2e49         if yfcl.I
+0000d100: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+0000d110: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
+0000d120: 6663 6c2e 5472 6163 6545 7869 7428 6c6f  fcl.TraceExit(lo
+0000d130: 675f 6d73 6729 0a20 2020 2020 2020 2065  g_msg).        e
+0000d140: 6c69 6620 6465 6275 675f 7966 633a 0a20  lif debug_yfc:. 
+0000d150: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000d160: 2822 2d20 683a 2229 0a20 2020 2020 2020  ("- h:").       
+0000d170: 2020 2020 2070 7269 6e74 2873 656c 662e       print(self.
+0000d180: 6829 0a20 2020 2020 2020 2020 2020 2070  h).            p
+0000d190: 7269 6e74 286c 6f67 5f6d 7367 290a 0a20  rint(log_msg).. 
+0000d1a0: 2020 2064 6566 205f 6665 7463 6841 6e64     def _fetchAnd
+0000d1b0: 4164 6452 616e 6765 735f 7370 6172 7365  AddRanges_sparse
+0000d1c0: 2873 656c 662c 2070 7374 722c 2072 616e  (self, pstr, ran
+0000d1d0: 6765 735f 746f 5f66 6574 6368 2c20 7072  ges_to_fetch, pr
+0000d1e0: 6570 6f73 742c 2064 6562 7567 2c20 7175  epost, debug, qu
+0000d1f0: 6965 743d 4661 6c73 6529 3a0a 2020 2020  iet=False):.    
+0000d200: 2020 2020 6966 2070 7374 7220 6973 206e      if pstr is n
+0000d210: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000d220: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+0000d230: 6563 6b53 7472 2870 7374 722c 2022 7073  eckStr(pstr, "ps
+0000d240: 7472 2229 0a20 2020 2020 2020 2079 6663  tr").        yfc
+0000d250: 752e 5479 7065 4368 6563 6b49 7465 7261  u.TypeCheckItera
+0000d260: 626c 6528 7261 6e67 6573 5f74 6f5f 6665  ble(ranges_to_fe
+0000d270: 7463 682c 2022 7261 6e67 6573 5f74 6f5f  tch, "ranges_to_
+0000d280: 6665 7463 6822 290a 2020 2020 2020 2020  fetch").        
+0000d290: 7966 6375 2e54 7970 6543 6865 636b 426f  yfcu.TypeCheckBo
+0000d2a0: 6f6c 2870 7265 706f 7374 2c20 2270 7265  ol(prepost, "pre
+0000d2b0: 706f 7374 2229 0a20 2020 2020 2020 2079  post").        y
+0000d2c0: 6663 752e 5479 7065 4368 6563 6b42 6f6f  fcu.TypeCheckBoo
+0000d2d0: 6c28 6465 6275 672c 2022 6465 6275 6722  l(debug, "debug"
+0000d2e0: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
+0000d2f0: 7970 6543 6865 636b 426f 6f6c 2871 7569  ypeCheckBool(qui
+0000d300: 6574 2c20 2271 7569 6574 2229 0a0a 2020  et, "quiet")..  
+0000d310: 2020 2020 2020 2320 4665 7463 6820 6561        # Fetch ea
+0000d320: 6368 2072 616e 6765 2c20 6275 7420 6361  ch range, but ca
+0000d330: 6e20 6265 2063 6172 656c 6573 7320 7265  n be careless re
+0000d340: 6761 7264 696e 6720 6465 2d61 646a 7573  garding de-adjus
+0000d350: 7420 6265 6361 7573 650a 2020 2020 2020  t because.      
+0000d360: 2020 2320 6765 7474 696e 6720 6576 656e    # getting even
+0000d370: 7473 2066 726f 6d20 7468 6520 6361 7265  ts from the care
+0000d380: 6675 6c6c 792d 6d61 6e61 6765 6420 6461  fully-managed da
+0000d390: 696c 7920 6461 7461 0a20 2020 2020 2020  ily data.       
+0000d3a0: 2069 6620 2872 616e 6765 735f 746f 5f66   if (ranges_to_f
+0000d3b0: 6574 6368 2069 7320 4e6f 6e65 2920 6f72  etch is None) or
+0000d3c0: 206c 656e 2872 616e 6765 735f 746f 5f66   len(ranges_to_f
+0000d3d0: 6574 6368 2920 3d3d 2030 3a0a 2020 2020  etch) == 0:.    
+0000d3e0: 2020 2020 2020 2020 2320 7265 7475 726e          # return
+0000d3f0: 2068 0a20 2020 2020 2020 2020 2020 2072   h.            r
+0000d400: 6574 7572 6e0a 0a20 2020 2020 2020 2064  eturn..        d
+0000d410: 6562 7567 5f79 6663 203d 2073 656c 662e  ebug_yfc = self.
+0000d420: 5f64 6562 7567 0a20 2020 2020 2020 2023  _debug.        #
+0000d430: 2064 6562 7567 5f79 6663 203d 2054 7275   debug_yfc = Tru
+0000d440: 650a 0a20 2020 2020 2020 206c 6f67 5f6d  e..        log_m
+0000d450: 7367 203d 2066 225f 6665 7463 6841 6e64  sg = f"_fetchAnd
+0000d460: 4164 6452 616e 6765 735f 7370 6172 7365  AddRanges_sparse
+0000d470: 2870 7265 706f 7374 3d7b 7072 6570 6f73  (prepost={prepos
+0000d480: 747d 2922 0a20 2020 2020 2020 2069 6620  t})".        if 
+0000d490: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+0000d4a0: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
+0000d4b0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+0000d4c0: 6e74 6572 286c 6f67 5f6d 7367 290a 2020  nter(log_msg).  
+0000d4d0: 2020 2020 2020 656c 6966 2064 6562 7567        elif debug
+0000d4e0: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+0000d4f0: 2020 7072 696e 7428 6c6f 675f 6d73 6729    print(log_msg)
+0000d500: 0a0a 2020 2020 2020 2020 747a 5f65 7863  ..        tz_exc
+0000d510: 6861 6e67 6520 3d20 7365 6c66 2e74 7a0a  hange = self.tz.
+0000d520: 2020 2020 2020 2020 7464 5f31 6420 3d20          td_1d = 
+0000d530: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
+0000d540: 290a 2020 2020 2020 2020 6474 6e6f 7720  ).        dtnow 
+0000d550: 3d20 7064 2e54 696d 6573 7461 6d70 2e75  = pd.Timestamp.u
+0000d560: 7463 6e6f 7728 292e 747a 5f63 6f6e 7665  tcnow().tz_conve
+0000d570: 7274 2874 7a5f 6578 6368 616e 6765 290a  rt(tz_exchange).
+0000d580: 0a20 2020 2020 2020 2023 2042 6163 6b70  .        # Backp
+0000d590: 6f72 7420 6576 656e 7473 2074 6861 7420  ort events that 
+0000d5a0: 6f63 6375 7272 6564 2073 696e 6365 206c  occurred since l
+0000d5b0: 6173 7420 6164 6a75 7374 6d65 6e74 3a0a  ast adjustment:.
+0000d5c0: 2020 2020 2020 2020 7365 6c66 2e5f 6170          self._ap
+0000d5d0: 706c 794e 6577 4576 656e 7473 2829 0a0a  plyNewEvents()..
+0000d5e0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+0000d5f0: 2068 6176 6520 6461 696c 7920 6461 7461   have daily data
+0000d600: 2063 6f76 6572 696e 6720 616c 6c20 7261   covering all ra
+0000d610: 6e67 6573 5f74 6f5f 6665 7463 682c 2073  nges_to_fetch, s
+0000d620: 6f20 7468 6579 2063 616e 2062 6520 6465  o they can be de
+0000d630: 2d73 706c 6974 7465 640a 2020 2020 2020  -splitted.      
+0000d640: 2020 725f 7374 6172 745f 6561 726c 6965    r_start_earlie
+0000d650: 7374 203d 2072 616e 6765 735f 746f 5f66  st = ranges_to_f
+0000d660: 6574 6368 5b30 5d5b 305d 0a20 2020 2020  etch[0][0].     
+0000d670: 2020 2066 6f72 2072 7374 6172 742c 2072     for rstart, r
+0000d680: 656e 6420 696e 2072 616e 6765 735f 746f  end in ranges_to
+0000d690: 5f66 6574 6368 3a0a 2020 2020 2020 2020  _fetch:.        
+0000d6a0: 2020 2020 725f 7374 6172 745f 6561 726c      r_start_earl
+0000d6b0: 6965 7374 203d 206d 696e 2872 7374 6172  iest = min(rstar
+0000d6c0: 742c 2072 5f73 7461 7274 5f65 6172 6c69  t, r_start_earli
+0000d6d0: 6573 7429 0a20 2020 2020 2020 2072 5f73  est).        r_s
+0000d6e0: 7461 7274 5f65 6172 6c69 6573 745f 6420  tart_earliest_d 
+0000d6f0: 3d20 725f 7374 6172 745f 6561 726c 6965  = r_start_earlie
+0000d700: 7374 2e64 6174 6528 2920 6966 2069 7369  st.date() if isi
+0000d710: 6e73 7461 6e63 6528 725f 7374 6172 745f  nstance(r_start_
+0000d720: 6561 726c 6965 7374 2c20 6461 7465 7469  earliest, dateti
+0000d730: 6d65 2920 656c 7365 2072 5f73 7461 7274  me) else r_start
+0000d740: 5f65 6172 6c69 6573 740a 2020 2020 2020  _earliest.      
+0000d750: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+0000d760: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000d770: 7428 222d 2072 5f73 7461 7274 5f65 6172  t("- r_start_ear
+0000d780: 6c69 6573 7420 3d20 7b7d 222e 666f 726d  liest = {}".form
+0000d790: 6174 2872 5f73 7461 7274 5f65 6172 6c69  at(r_start_earli
+0000d7a0: 6573 7429 290a 2020 2020 2020 2020 2320  est)).        # 
+0000d7b0: 5472 6967 6765 7220 7072 6963 6520 7379  Trigger price sy
+0000d7c0: 6e63 3a0a 2020 2020 2020 2020 6869 7374  nc:.        hist
+0000d7d0: 4461 696c 7920 3d20 7365 6c66 2e6d 616e  Daily = self.man
+0000d7e0: 6167 6572 2e47 6574 4869 7374 6f72 7928  ager.GetHistory(
+0000d7f0: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
+0000d800: 7973 3129 0a20 2020 2020 2020 2023 2068  ys1).        # h
+0000d810: 6973 7444 6169 6c79 2e67 6574 2873 7461  istDaily.get(sta
+0000d820: 7274 3d72 5f73 7461 7274 5f65 6172 6c69  rt=r_start_earli
+0000d830: 6573 745f 642c 206d 6178 5f61 6765 3d74  est_d, max_age=t
+0000d840: 645f 3164 290a 2020 2020 2020 2020 6869  d_1d).        hi
+0000d850: 7374 4461 696c 792e 6765 7428 7374 6172  stDaily.get(star
+0000d860: 743d 725f 7374 6172 745f 6561 726c 6965  t=r_start_earlie
+0000d870: 7374 5f64 2c20 6d61 785f 6167 653d 7464  st_d, max_age=td
+0000d880: 5f31 642c 2072 6570 6169 723d 4661 6c73  _1d, repair=Fals
+0000d890: 6529 0a0a 2020 2020 2020 2020 2320 4665  e)..        # Fe
+0000d8a0: 7463 6820 6561 6368 2072 616e 6765 2c20  tch each range, 
+0000d8b0: 616e 6420 6164 6a75 7374 2066 6f72 2073  and adjust for s
+0000d8c0: 706c 6974 7320 7468 6174 206f 6363 7572  plits that occur
+0000d8d0: 7265 6420 6166 7465 720a 2020 2020 2020  red after.      
+0000d8e0: 2020 666f 7220 7273 7461 7274 2c20 7265    for rstart, re
+0000d8f0: 6e64 2069 6e20 7261 6e67 6573 5f74 6f5f  nd in ranges_to_
+0000d900: 6665 7463 683a 0a20 2020 2020 2020 2020  fetch:.         
+0000d910: 2020 2066 6574 6368 5f73 7461 7274 203d     fetch_start =
+0000d920: 2072 7374 6172 740a 2020 2020 2020 2020   rstart.        
+0000d930: 2020 2020 6665 7463 685f 656e 6420 3d20      fetch_end = 
+0000d940: 7265 6e64 0a20 2020 2020 2020 2020 2020  rend.           
+0000d950: 2023 2069 6620 6e6f 7420 7365 6c66 2e69   # if not self.i
+0000d960: 6e74 6572 6461 793a 2020 2320 616e 6420  nterday:  # and 
+0000d970: 6665 7463 685f 7374 6172 742e 6461 7465  fetch_start.date
+0000d980: 2829 203d 3d20 6665 7463 685f 656e 642e  () == fetch_end.
+0000d990: 6461 7465 2829 3a0a 2020 2020 2020 2020  date():.        
+0000d9a0: 2020 2020 2320 2020 2020 2320 496e 7472      #     # Intr
+0000d9b0: 6164 6179 2066 6574 6368 6573 2062 6568  aday fetches beh
+0000d9c0: 6176 6520 6265 7474 6572 2077 6865 6e20  ave better when 
+0000d9d0: 7469 6d65 203d 206d 6964 6e69 6768 740a  time = midnight.
+0000d9e0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000d9f0: 2020 6665 7463 685f 7374 6172 7420 3d20    fetch_start = 
+0000da00: 6665 7463 685f 7374 6172 742e 666c 6f6f  fetch_start.floo
+0000da10: 7228 2231 4422 290a 2020 2020 2020 2020  r("1D").        
+0000da20: 2020 2020 2320 2020 2020 6665 7463 685f      #     fetch_
+0000da30: 656e 6420 3d20 6665 7463 685f 656e 642e  end = fetch_end.
+0000da40: 6365 696c 2822 3144 2229 0a20 2020 2020  ceil("1D").     
+0000da50: 2020 2020 2020 2023 2055 7064 6174 653a         # Update:
+0000da60: 2064 6174 6120 7265 6c69 6162 696c 6974   data reliabilit
+0000da70: 7920 6e6f 7720 6669 7865 6420 6279 2043  y now fixed by C
+0000da80: 6875 6e6b 4461 7465 7349 6e74 6f59 6646  hunkDatesIntoYfF
+0000da90: 6574 6368 6573 2829 0a20 2020 2020 2020  etches().       
+0000daa0: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
+0000dab0: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+0000dac0: 2020 2070 7269 6e74 2822 2d20 6665 7463     print("- fetc
+0000dad0: 6869 6e67 207b 7d20 2d3e 207b 7d22 2e66  hing {} -> {}".f
+0000dae0: 6f72 6d61 7428 6665 7463 685f 7374 6172  ormat(fetch_star
+0000daf0: 742c 2066 6574 6368 5f65 6e64 2929 0a20  t, fetch_end)). 
+0000db00: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db20: 6832 203d 2073 656c 662e 5f66 6574 6368  h2 = self._fetch
+0000db30: 5966 4869 7374 6f72 7928 7073 7472 2c20  YfHistory(pstr, 
+0000db40: 6665 7463 685f 7374 6172 742c 2066 6574  fetch_start, fet
+0000db50: 6368 5f65 6e64 2c20 7072 6570 6f73 742c  ch_end, prepost,
+0000db60: 2064 6562 7567 290a 2020 2020 2020 2020   debug).        
+0000db70: 2020 2020 6578 6365 7074 2079 6663 642e      except yfcd.
+0000db80: 4e6f 5072 6963 6544 6174 6149 6e52 616e  NoPriceDataInRan
+0000db90: 6765 4578 6365 7074 696f 6e3a 0a20 2020  geException:.   
+0000dba0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+0000dbb0: 6620 6f6e 6c79 2074 7279 696e 6720 746f  f only trying to
+0000dbc0: 2066 6574 6368 2031 2064 6179 206f 6620   fetch 1 day of 
+0000dbd0: 3164 2064 6174 612c 2074 6865 6e20 7072  1d data, then pr
+0000dbe0: 696e 7420 7761 726e 696e 6720 696e 7374  int warning inst
+0000dbf0: 6561 6420 6f66 2065 7863 6570 7469 6f6e  ead of exception
+0000dc00: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000dc10: 2020 2320 436f 756c 6420 6164 6420 6164    # Could add ad
+0000dc20: 6469 7469 6f6e 616c 2063 6f6e 6469 7469  ditional conditi
+0000dc30: 6f6e 206f 6620 6469 7669 6465 6e64 2070  on of dividend p
+0000dc40: 7265 7669 6f75 7320 6461 7920 2873 6565  revious day (see
+0000dc50: 6d73 2074 6f20 6d65 7373 2075 7020 7461  ms to mess up ta
+0000dc60: 626c 6529 2e0a 2020 2020 2020 2020 2020  ble)..          
+0000dc70: 2020 2020 2020 6967 6e6f 7265 203d 2046        ignore = F
+0000dc80: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+0000dc90: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+0000dca0: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
+0000dcb0: 7465 7276 616c 2e44 6179 7331 2061 6e64  terval.Days1 and
+0000dcc0: 2066 6574 6368 5f65 6e64 202d 2066 6574   fetch_end - fet
+0000dcd0: 6368 5f73 7461 7274 203d 3d20 7464 5f31  ch_start == td_1
+0000dce0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+0000dcf0: 2020 2020 2020 2069 676e 6f72 6520 3d20         ignore = 
+0000dd00: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0000dd10: 2020 2020 2065 6c69 6620 7365 6c66 2e69       elif self.i
+0000dd20: 6e74 7261 6461 7920 616e 6420 6665 7463  ntraday and fetc
+0000dd30: 685f 7374 6172 742e 6461 7465 2829 203d  h_start.date() =
+0000dd40: 3d20 6474 6e6f 772e 6461 7465 2829 3a0a  = dtnow.date():.
+0000dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd60: 2020 2020 6967 6e6f 7265 203d 2054 7275      ignore = Tru
+0000dd70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000dd80: 2020 656c 6966 2073 656c 662e 696e 7465    elif self.inte
+0000dd90: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
+0000dda0: 6572 7661 6c2e 4d69 6e73 3120 616e 6420  erval.Mins1 and 
+0000ddb0: 6665 7463 685f 656e 6420 2d20 6665 7463  fetch_end - fetc
+0000ddc0: 685f 7374 6172 7420 3c3d 2074 696d 6564  h_start <= timed
+0000ddd0: 656c 7461 286d 696e 7574 6573 3d31 3029  elta(minutes=10)
+0000dde0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ddf0: 2020 2020 2020 6967 6e6f 7265 203d 2054        ignore = T
+0000de00: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0000de10: 2020 2020 6966 2069 676e 6f72 653a 0a20      if ignore:. 
+0000de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de30: 2020 2069 6620 6e6f 7420 7175 6965 743a     if not quiet:
+0000de40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000de50: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+0000de60: 2822 5741 524e 494e 473a 204e 6f20 7b7d  ("WARNING: No {}
+0000de70: 2d70 7269 6365 2064 6174 6120 6665 7463  -price data fetc
+0000de80: 6865 6420 666f 7220 7469 636b 6572 207b  hed for ticker {
+0000de90: 7d20 6265 7477 6565 6e20 6461 7465 7320  } between dates 
+0000dea0: 7b7d 202d 3e20 7b7d 222e 666f 726d 6174  {} -> {}".format
+0000deb0: 2879 6663 642e 696e 7465 7276 616c 546f  (yfcd.intervalTo
+0000dec0: 5374 7269 6e67 5b73 656c 662e 696e 7465  String[self.inte
+0000ded0: 7276 616c 5d2c 2073 656c 662e 7469 636b  rval], self.tick
+0000dee0: 6572 2c20 7273 7461 7274 2c20 7265 6e64  er, rstart, rend
+0000def0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000df00: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000df10: 2866 2257 4152 4e49 4e47 3a20 7b73 656c  (f"WARNING: {sel
+0000df20: 662e 7469 636b 6572 7d3a 204e 6f20 7b79  f.ticker}: No {y
+0000df30: 6663 642e 696e 7465 7276 616c 546f 5374  fcd.intervalToSt
+0000df40: 7269 6e67 5b73 656c 662e 696e 7465 7276  ring[self.interv
+0000df50: 616c 5d7d 2d70 7269 6365 2064 6174 6120  al]}-price data 
+0000df60: 6665 7463 6865 6420 666f 7220 7b72 7374  fetched for {rst
+0000df70: 6172 747d 202d 3e20 7b72 656e 647d 2229  art} -> {rend}")
+0000df80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000df90: 2020 2020 2068 3220 3d20 4e6f 6e65 0a20       h2 = None. 
+0000dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfb0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0000dfc0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000dfd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000dfe0: 2020 2020 2020 7261 6973 650a 0a20 2020        raise..   
+0000dff0: 2020 2020 2020 2020 2069 6620 6832 2069           if h2 i
+0000e000: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000e010: 2020 2020 2020 2020 2320 7261 6973 6520          # raise 
+0000e020: 4578 6365 7074 696f 6e28 2259 4620 7265  Exception("YF re
+0000e030: 7475 726e 6564 204e 6f6e 6520 666f 723a  turned None for:
+0000e040: 2074 6b72 3d7b 7d2c 2069 6e74 6572 7661   tkr={}, interva
+0000e050: 6c3d 7b7d 2c20 7374 6172 743d 7b7d 2c20  l={}, start={}, 
+0000e060: 656e 643d 7b7d 222e 666f 726d 6174 2873  end={}".format(s
+0000e070: 656c 662e 7469 636b 6572 2c20 7365 6c66  elf.ticker, self
+0000e080: 2e69 6e74 6572 7661 6c2c 2072 7374 6172  .interval, rstar
+0000e090: 742c 2072 656e 6429 290a 2020 2020 2020  t, rend)).      
+0000e0a0: 2020 2020 2020 2020 2020 2320 7261 6973            # rais
+0000e0b0: 6520 4578 6365 7074 696f 6e28 6622 7966  e Exception(f"yf
+0000e0c0: 696e 616e 6365 2e68 6973 746f 7279 2829  inance.history()
+0000e0d0: 2072 6574 7572 6e65 6420 4e6f 6e65 2028   returned None (
+0000e0e0: 7b73 656c 662e 7469 636b 6572 7d20 7b73  {self.ticker} {s
+0000e0f0: 656c 662e 6973 7472 7d20 7b72 7374 6172  elf.istr} {rstar
+0000e100: 747d 2d3e 7b72 656e 647d 2922 290a 2020  t}->{rend})").  
+0000e110: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000e120: 6973 6520 7966 6364 2e4e 6f50 7269 6365  ise yfcd.NoPrice
+0000e130: 4461 7461 496e 5261 6e67 6545 7863 6570  DataInRangeExcep
+0000e140: 7469 6f6e 2873 656c 662e 7469 636b 6572  tion(self.ticker
+0000e150: 2c20 7365 6c66 2e69 7374 722c 2072 7374  , self.istr, rst
+0000e160: 6172 742c 2072 656e 6429 0a20 2020 2020  art, rend).     
+0000e170: 2020 2020 2020 2020 2020 2023 2072 6169             # rai
+0000e180: 7365 2045 7863 6570 7469 6f6e 2866 2279  se Exception(f"y
+0000e190: 6669 6e61 6e63 652e 6869 7374 6f72 7928  finance.history(
+0000e1a0: 2920 7265 7475 726e 6564 204e 6f6e 6520  ) returned None 
+0000e1b0: 287b 7365 6c66 2e74 6963 6b65 727d 207b  ({self.ticker} {
+0000e1c0: 7365 6c66 2e69 7374 727d 207b 6665 7463  self.istr} {fetc
+0000e1d0: 685f 7374 6172 747d 2d3e 7b66 6574 6368  h_start}->{fetch
+0000e1e0: 5f65 6e64 7d29 2229 0a0a 2020 2020 2020  _end})")..      
+0000e1f0: 2020 2020 2020 2320 456e 7375 7265 2068        # Ensure h
+0000e200: 3220 6973 2073 706c 6974 2d61 646a 7573  2 is split-adjus
+0000e210: 7465 642e 2053 6f6d 6574 696d 6573 2059  ted. Sometimes Y
+0000e220: 6168 6f6f 2072 6574 7572 6e73 2075 6e61  ahoo returns una
+0000e230: 646a 7573 7465 6420 6461 7461 0a20 2020  djusted data.   
+0000e240: 2020 2020 2020 2020 2068 3220 3d20 7365           h2 = se
+0000e250: 6c66 2e5f 7265 7665 7273 6559 6168 6f6f  lf._reverseYahoo
+0000e260: 4164 6a75 7374 2868 3229 0a20 2020 2020  Adjust(h2).     
+0000e270: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
+0000e280: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
+0000e290: 2020 2020 2070 7269 6e74 2822 2d20 6832       print("- h2
+0000e2a0: 2061 646a 7573 7465 643a 2229 0a20 2020   adjusted:").   
+0000e2b0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000e2c0: 6e74 2868 325b 5b22 436c 6f73 6522 2c20  nt(h2[["Close", 
+0000e2d0: 2244 6976 6964 656e 6473 222c 2022 566f  "Dividends", "Vo
+0000e2e0: 6c75 6d65 222c 2022 4353 4622 2c20 2243  lume", "CSF", "C
+0000e2f0: 4446 225d 5d29 0a0a 2020 2020 2020 2020  DF"]])..        
+0000e300: 2020 2020 6966 2066 6574 6368 5f73 7461      if fetch_sta
+0000e310: 7274 2021 3d20 7273 7461 7274 3a0a 2020  rt != rstart:.  
+0000e320: 2020 2020 2020 2020 2020 2020 2020 6832                h2
+0000e330: 203d 2068 325b 6832 2e69 6e64 6578 203e   = h2[h2.index >
+0000e340: 3d20 7273 7461 7274 5d0a 2020 2020 2020  = rstart].      
+0000e350: 2020 2020 2020 6966 2066 6574 6368 5f65        if fetch_e
+0000e360: 6e64 2021 3d20 7265 6e64 3a0a 2020 2020  nd != rend:.    
+0000e370: 2020 2020 2020 2020 2020 2020 6832 203d              h2 =
+0000e380: 2068 325b 6832 2e69 6e64 6578 203c 2072   h2[h2.index < r
+0000e390: 656e 642b 7365 6c66 2e69 7464 5d0a 0a20  end+self.itd].. 
+0000e3a0: 2020 2020 2020 2020 2020 2023 2055 7064             # Upd
+0000e3b0: 6174 653a 2072 6570 6169 7220 4146 5445  ate: repair AFTE
+0000e3c0: 5220 6665 7463 6865 730a 2020 2020 2020  R fetches.      
+0000e3d0: 2020 2020 2020 2320 6966 2073 656c 662e        # if self.
+0000e3e0: 7265 7061 6972 3a0a 2020 2020 2020 2020  repair:.        
+0000e3f0: 2020 2020 2320 2020 2020 6832 203d 2073      #     h2 = s
+0000e400: 656c 662e 5f72 6570 6169 725a 6572 6f50  elf._repairZeroP
+0000e410: 7269 6365 7328 6832 290a 2020 2020 2020  rices(h2).      
+0000e420: 2020 2020 2020 2320 2020 2020 6832 203d        #     h2 =
+0000e430: 2073 656c 662e 5f72 6570 6169 7255 6e69   self._repairUni
+0000e440: 744d 6978 7570 7328 6832 290a 0a20 2020  tMixups(h2)..   
+0000e450: 2020 2020 2020 2020 2069 6620 2241 646a           if "Adj
+0000e460: 2043 6c6f 7365 2220 696e 2068 322e 636f   Close" in h2.co
+0000e470: 6c75 6d6e 733a 0a20 2020 2020 2020 2020  lumns:.         
+0000e480: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+0000e490: 6570 7469 6f6e 2822 4164 6a20 436c 6f73  eption("Adj Clos
+0000e4a0: 6520 696e 2068 3222 290a 2020 2020 2020  e in h2").      
+0000e4b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000e4c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000e4d0: 6820 3d20 7365 6c66 2e68 5b79 6663 752e  h = self.h[yfcu.
+0000e4e0: 6e70 5f69 7369 6e5f 6f70 7469 6d69 7365  np_isin_optimise
+0000e4f0: 6428 7365 6c66 2e68 2e69 6e64 6578 2c20  d(self.h.index, 
+0000e500: 6832 2e69 6e64 6578 2c20 696e 7665 7274  h2.index, invert
+0000e510: 3d54 7275 6529 5d0a 2020 2020 2020 2020  =True)].        
+0000e520: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+0000e530: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0000e540: 2020 2020 2020 7072 696e 7428 2273 656c        print("sel
+0000e550: 662e 682e 7368 6170 653a 222c 2073 656c  f.h.shape:", sel
+0000e560: 662e 682e 7368 6170 6529 0a20 2020 2020  f.h.shape).     
+0000e570: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000e580: 2822 6832 2e73 6861 7065 3a22 2c20 6832  ("h2.shape:", h2
+0000e590: 2e73 6861 7065 290a 2020 2020 2020 2020  .shape).        
+0000e5a0: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+0000e5b0: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+0000e5c0: 203d 2070 642e 636f 6e63 6174 285b 7365   = pd.concat([se
+0000e5d0: 6c66 2e68 2c20 6832 5d2c 2073 6f72 743d  lf.h, h2], sort=
+0000e5e0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0000e5f0: 2020 7365 6c66 2e68 2e69 6e64 6578 203d    self.h.index =
+0000e600: 2070 642e 746f 5f64 6174 6574 696d 6528   pd.to_datetime(
+0000e610: 7365 6c66 2e68 2e69 6e64 6578 2c20 7574  self.h.index, ut
+0000e620: 633d 5472 7565 292e 747a 5f63 6f6e 7665  c=True).tz_conve
+0000e630: 7274 2874 7a5f 6578 6368 616e 6765 290a  rt(tz_exchange).
+0000e640: 0a20 2020 2020 2020 2020 2020 2066 5f64  .            f_d
+0000e650: 7570 7320 3d20 7365 6c66 2e68 2e69 6e64  ups = self.h.ind
+0000e660: 6578 2e64 7570 6c69 6361 7465 6428 290a  ex.duplicated().
+0000e670: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+0000e680: 5f64 7570 732e 616e 7928 293a 0a20 2020  _dups.any():.   
+0000e690: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000e6a0: 7365 2045 7863 6570 7469 6f6e 2866 227b  se Exception(f"{
+0000e6b0: 7365 6c66 2e74 6963 6b65 727d 3a20 4164  self.ticker}: Ad
+0000e6c0: 6469 6e67 2072 616e 6765 207b 7273 7461  ding range {rsta
+0000e6d0: 7274 7d2d 3e7b 7265 6e64 7d20 6861 7320  rt}->{rend} has 
+0000e6e0: 6164 6465 6420 6475 706c 6963 6174 6520  added duplicate 
+0000e6f0: 7469 6d65 706f 696e 7473 2068 6176 6520  timepoints have 
+0000e700: 6265 656e 2064 7570 6c69 6361 7465 643a  been duplicated:
+0000e710: 207b 7365 6c66 2e68 2e69 6e64 6578 5b66   {self.h.index[f
+0000e720: 5f64 7570 735d 7d22 290a 0a20 2020 2020  _dups]}")..     
+0000e730: 2020 2073 656c 662e 6820 3d20 7365 6c66     self.h = self
+0000e740: 2e68 2e73 6f72 745f 696e 6465 7828 290a  .h.sort_index().
+0000e750: 2020 2020 2020 2020 7365 6c66 2e5f 7570          self._up
+0000e760: 6461 7465 6443 6163 6865 6450 7269 6365  datedCachedPrice
+0000e770: 7328 7365 6c66 2e68 290a 0a20 2020 2020  s(self.h)..     
+0000e780: 2020 206c 6f67 5f6d 7367 203d 2022 5f66     log_msg = "_f
+0000e790: 6574 6368 416e 6441 6464 5261 6e67 6573  etchAndAddRanges
+0000e7a0: 5f73 7061 7273 6528 2920 7265 7475 726e  _sparse() return
+0000e7b0: 696e 6722 0a20 2020 2020 2020 2069 6620  ing".        if 
+0000e7c0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+0000e7d0: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
+0000e7e0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+0000e7f0: 7869 7428 6c6f 675f 6d73 6729 0a20 2020  xit(log_msg).   
+0000e800: 2020 2020 2065 6c69 6620 6465 6275 675f       elif debug_
+0000e810: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
+0000e820: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
+0000e830: 0a20 2020 2064 6566 205f 7665 7269 6679  .    def _verify
+0000e840: 4361 6368 6564 5072 6963 6573 2873 656c  CachedPrices(sel
+0000e850: 662c 2072 746f 6c3d 302e 3030 3031 2c20  f, rtol=0.0001, 
+0000e860: 766f 6c5f 7274 6f6c 3d30 2e30 3034 2c20  vol_rtol=0.004, 
+0000e870: 636f 7272 6563 743d 4661 6c73 652c 2064  correct=False, d
+0000e880: 6973 6361 7264 5f6f 6c64 3d46 616c 7365  iscard_old=False
+0000e890: 2c20 7175 6965 743d 5472 7565 2c20 6465  , quiet=True, de
+0000e8a0: 6275 673d 4661 6c73 6529 3a0a 2020 2020  bug=False):.    
+0000e8b0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
+0000e8c0: 636b 426f 6f6c 2863 6f72 7265 6374 2c20  ckBool(correct, 
+0000e8d0: 2263 6f72 7265 6374 2229 0a20 2020 2020  "correct").     
+0000e8e0: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+0000e8f0: 6b42 6f6f 6c28 6469 7363 6172 645f 6f6c  kBool(discard_ol
+0000e900: 642c 2022 6469 7363 6172 645f 6f6c 6422  d, "discard_old"
+0000e910: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
+0000e920: 7970 6543 6865 636b 426f 6f6c 2871 7569  ypeCheckBool(qui
+0000e930: 6574 2c20 2271 7569 6574 2229 0a20 2020  et, "quiet").   
+0000e940: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
+0000e950: 6563 6b42 6f6f 6c28 6465 6275 672c 2022  eckBool(debug, "
+0000e960: 6465 6275 6722 290a 0a20 2020 2020 2020  debug")..       
+0000e970: 2069 6620 7365 6c66 2e68 2069 7320 4e6f   if self.h is No
+0000e980: 6e65 206f 7220 7365 6c66 2e68 2e65 6d70  ne or self.h.emp
+0000e990: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+0000e9a0: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+0000e9b0: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
+0000e9c0: 2020 2020 2020 2020 2020 2071 7569 6574             quiet
+0000e9d0: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0000e9e0: 2020 7966 636c 2e54 7261 6365 456e 7465    yfcl.TraceEnte
+0000e9f0: 7228 6622 504d 3a3a 5f76 6572 6966 7943  r(f"PM::_verifyC
+0000ea00: 6163 6865 6450 7269 6365 732d 7b73 656c  achedPrices-{sel
+0000ea10: 662e 6973 7472 7d28 636f 7272 6563 743d  f.istr}(correct=
+0000ea20: 7b63 6f72 7265 6374 7d2c 2064 6562 7567  {correct}, debug
+0000ea30: 3d7b 6465 6275 677d 2922 290a 0a20 2020  ={debug})")..   
+0000ea40: 2020 2020 2023 204e 6577 2063 6f64 653a       # New code:
+0000ea50: 2068 6f70 6566 756c 6c79 2074 6869 7320   hopefully this 
+0000ea60: 7769 6c6c 2063 6f72 7265 6374 2062 6164  will correct bad
+0000ea70: 2043 4446 2069 6e20 3177 6b20 6574 630a   CDF in 1wk etc.
+0000ea80: 2020 2020 2020 2020 7365 6c66 2e5f 6170          self._ap
+0000ea90: 706c 794e 6577 4576 656e 7473 2829 0a0a  plyNewEvents()..
+0000eaa0: 2020 2020 2020 2020 6820 3d20 7365 6c66          h = self
+0000eab0: 2e68 2e63 6f70 7928 2920 2023 2077 6f72  .h.copy()  # wor
+0000eac0: 6b69 6e67 2063 6f70 7920 666f 7220 636f  king copy for co
+0000ead0: 6d70 6172 6973 6f6e 2077 6974 6820 5946  mparison with YF
+0000eae0: 0a20 2020 2020 2020 2068 5f6d 6f64 6966  .        h_modif
+0000eaf0: 6965 6420 3d20 4661 6c73 650a 2020 2020  ied = False.    
+0000eb00: 2020 2020 685f 6e65 7720 3d20 7365 6c66      h_new = self
+0000eb10: 2e68 2e63 6f70 7928 2920 2023 2063 6f70  .h.copy()  # cop
+0000eb20: 7920 666f 7220 7374 6f72 696e 6720 6368  y for storing ch
+0000eb30: 616e 6765 730a 2020 2020 2020 2020 2320  anges.        # 
+0000eb40: 4b65 6570 2074 7261 636b 206f 6620 7072  Keep track of pr
+0000eb50: 6f62 6c65 6d73 3a0a 2020 2020 2020 2020  oblems:.        
+0000eb60: 665f 6469 6666 5f61 6c6c 203d 2070 642e  f_diff_all = pd.
+0000eb70: 5365 7269 6573 286e 702e 6675 6c6c 2868  Series(np.full(h
+0000eb80: 2e73 6861 7065 5b30 5d2c 2046 616c 7365  .shape[0], False
+0000eb90: 292c 2068 2e69 6e64 6578 290a 2020 2020  ), h.index).    
+0000eba0: 2020 2020 6e20 3d20 682e 7368 6170 655b      n = h.shape[
+0000ebb0: 305d 0a0a 2020 2020 2020 2020 2320 4967  0]..        # Ig
+0000ebc0: 6e6f 7265 206e 6f6e 2d66 696e 616c 2064  nore non-final d
+0000ebd0: 6174 6120 6265 6361 7573 6520 7769 6c6c  ata because will
+0000ebe0: 2064 6966 6665 7220 746f 2059 6168 6f6f   differ to Yahoo
+0000ebf0: 0a20 2020 2020 2020 2068 5f6c 6173 7452  .        h_lastR
+0000ec00: 6f77 203d 2068 2e69 6c6f 635b 2d31 5d0a  ow = h.iloc[-1].
+0000ec10: 2020 2020 2020 2020 6820 3d20 685b 685b          h = h[h[
+0000ec20: 2246 696e 616c 3f22 5d2e 746f 5f6e 756d  "Final?"].to_num
+0000ec30: 7079 2829 5d0a 0a20 2020 2020 2020 2023  py()]..        #
+0000ec40: 2041 7070 6c79 2073 746f 636b 2d73 706c   Apply stock-spl
+0000ec50: 6974 2061 646a 7573 746d 656e 7420 746f  it adjustment to
+0000ec60: 206d 6174 6368 2059 460a 2020 2020 2020   match YF.      
+0000ec70: 2020 666f 7220 6320 696e 205b 224f 7065    for c in ["Ope
+0000ec80: 6e22 2c20 2243 6c6f 7365 222c 2022 4c6f  n", "Close", "Lo
+0000ec90: 7722 2c20 2248 6967 6822 2c20 2244 6976  w", "High", "Div
+0000eca0: 6964 656e 6473 225d 3a0a 2020 2020 2020  idends"]:.      
+0000ecb0: 2020 2020 2020 685b 635d 203d 2068 5b63        h[c] = h[c
+0000ecc0: 5d2e 746f 5f6e 756d 7079 2829 202a 2068  ].to_numpy() * h
+0000ecd0: 5b22 4353 4622 5d2e 746f 5f6e 756d 7079  ["CSF"].to_numpy
+0000ece0: 2829 0a20 2020 2020 2020 2068 5b22 566f  ().        h["Vo
+0000ecf0: 6c75 6d65 225d 203d 2028 685b 2256 6f6c  lume"] = (h["Vol
+0000ed00: 756d 6522 5d2e 746f 5f6e 756d 7079 2829  ume"].to_numpy()
+0000ed10: 202f 2068 5b22 4353 4622 5d2e 746f 5f6e   / h["CSF"].to_n
+0000ed20: 756d 7079 2829 292e 726f 756e 6428 292e  umpy()).round().
+0000ed30: 6173 7479 7065 2827 696e 7427 290a 0a20  astype('int').. 
+0000ed40: 2020 2020 2020 2074 645f 3164 203d 2070         td_1d = p
+0000ed50: 642e 5469 6d65 6465 6c74 6128 2231 4422  d.Timedelta("1D"
+0000ed60: 290a 2020 2020 2020 2020 6474 5f6e 6f77  ).        dt_now
+0000ed70: 203d 2070 642e 5469 6d65 7374 616d 702e   = pd.Timestamp.
+0000ed80: 7574 636e 6f77 2829 2e74 7a5f 636f 6e76  utcnow().tz_conv
+0000ed90: 6572 7428 5a6f 6e65 496e 666f 2822 5554  ert(ZoneInfo("UT
+0000eda0: 4322 2929 0a0a 2020 2020 2020 2020 6465  C"))..        de
+0000edb0: 6620 5f61 6767 7265 6761 7465 5f79 6664  f _aggregate_yfd
+0000edc0: 665f 6461 696c 7928 6466 293a 0a20 2020  f_daily(df):.   
+0000edd0: 2020 2020 2020 2020 2064 6632 203d 2064           df2 = d
+0000ede0: 662e 636f 7079 2829 0a20 2020 2020 2020  f.copy().       
+0000edf0: 2020 2020 2064 6632 5b22 5f64 6174 6522       df2["_date"
+0000ee00: 5d20 3d20 6466 322e 696e 6465 782e 6461  ] = df2.index.da
+0000ee10: 7465 0a20 2020 2020 2020 2020 2020 2064  te.            d
+0000ee20: 6632 2e6c 6f63 5b64 6632 5b22 5374 6f63  f2.loc[df2["Stoc
+0000ee30: 6b20 5370 6c69 7473 225d 203d 3d20 302c  k Splits"] == 0,
+0000ee40: 2022 5374 6f63 6b20 5370 6c69 7473 225d   "Stock Splits"]
+0000ee50: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+0000ee60: 2069 6620 2243 4446 2220 696e 2064 662e   if "CDF" in df.
+0000ee70: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
+0000ee80: 2020 2020 2020 2020 2064 6632 203d 2064           df2 = d
+0000ee90: 6632 2e67 726f 7570 6279 2822 5f64 6174  f2.groupby("_dat
+0000eea0: 6522 292e 6167 6728 0a20 2020 2020 2020  e").agg(.       
+0000eeb0: 2020 2020 2020 2020 2020 2020 204f 7065               Ope
+0000eec0: 6e3d 2822 4f70 656e 222c 2022 6669 7273  n=("Open", "firs
+0000eed0: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
+0000eee0: 2020 2020 2020 2020 2043 6c6f 7365 3d28           Close=(
+0000eef0: 2243 6c6f 7365 222c 2022 6c61 7374 2229  "Close", "last")
+0000ef00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ef10: 2020 2020 2020 4c6f 773d 2822 4c6f 7722        Low=("Low"
+0000ef20: 2c20 226d 696e 2229 2c0a 2020 2020 2020  , "min"),.      
+0000ef30: 2020 2020 2020 2020 2020 2020 2020 4869                Hi
+0000ef40: 6768 3d28 2248 6967 6822 2c20 226d 6178  gh=("High", "max
+0000ef50: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+0000ef60: 2020 2020 2020 2020 566f 6c75 6d65 3d28          Volume=(
+0000ef70: 2256 6f6c 756d 6522 2c20 2273 756d 2229  "Volume", "sum")
+0000ef80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ef90: 2020 2020 2020 4469 7669 6465 6e64 733d        Dividends=
+0000efa0: 2822 4469 7669 6465 6e64 7322 2c20 2273  ("Dividends", "s
+0000efb0: 756d 2229 2c0a 2020 2020 2020 2020 2020  um"),.          
+0000efc0: 2020 2020 2020 2020 2020 5374 6f63 6b53            StockS
+0000efd0: 706c 6974 733d 2822 5374 6f63 6b20 5370  plits=("Stock Sp
+0000efe0: 6c69 7473 222c 2022 7072 6f64 2229 2c0a  lits", "prod"),.
+0000eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f000: 2020 2020 4344 463d 2822 4344 4622 2c20      CDF=("CDF", 
+0000f010: 2270 726f 6422 292c 0a20 2020 2020 2020  "prod"),.       
+0000f020: 2020 2020 2020 2020 2020 2020 2043 5346               CSF
+0000f030: 3d28 2243 5346 222c 2022 7072 6f64 2229  =("CSF", "prod")
+0000f040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f050: 2020 2020 2020 4665 7463 6844 6174 653d        FetchDate=
+0000f060: 2822 4665 7463 6844 6174 6522 2c20 2266  ("FetchDate", "f
+0000f070: 6972 7374 2229 292e 7265 6e61 6d65 2863  irst")).rename(c
+0000f080: 6f6c 756d 6e73 3d7b 2253 746f 636b 5370  olumns={"StockSp
+0000f090: 6c69 7473 223a 2022 5374 6f63 6b20 5370  lits": "Stock Sp
+0000f0a0: 6c69 7473 227d 290a 2020 2020 2020 2020  lits"}).        
+0000f0b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000f0c0: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
+0000f0d0: 6466 322e 6772 6f75 7062 7928 225f 6461  df2.groupby("_da
+0000f0e0: 7465 2229 2e61 6767 280a 2020 2020 2020  te").agg(.      
+0000f0f0: 2020 2020 2020 2020 2020 2020 2020 4f70                Op
+0000f100: 656e 3d28 224f 7065 6e22 2c20 2266 6972  en=("Open", "fir
+0000f110: 7374 2229 2c0a 2020 2020 2020 2020 2020  st"),.          
+0000f120: 2020 2020 2020 2020 2020 436c 6f73 653d            Close=
+0000f130: 2822 436c 6f73 6522 2c20 226c 6173 7422  ("Close", "last"
+0000f140: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000f150: 2020 2020 2020 2041 646a 436c 6f73 653d         AdjClose=
+0000f160: 2822 4164 6a20 436c 6f73 6522 2c20 226c  ("Adj Close", "l
+0000f170: 6173 7422 292c 0a20 2020 2020 2020 2020  ast"),.         
+0000f180: 2020 2020 2020 2020 2020 204c 6f77 3d28             Low=(
+0000f190: 224c 6f77 222c 2022 6d69 6e22 292c 0a20  "Low", "min"),. 
+0000f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f1b0: 2020 2048 6967 683d 2822 4869 6768 222c     High=("High",
+0000f1c0: 2022 6d61 7822 292c 0a20 2020 2020 2020   "max"),.       
+0000f1d0: 2020 2020 2020 2020 2020 2020 2056 6f6c               Vol
+0000f1e0: 756d 653d 2822 566f 6c75 6d65 222c 2022  ume=("Volume", "
+0000f1f0: 7375 6d22 292c 0a20 2020 2020 2020 2020  sum"),.         
+0000f200: 2020 2020 2020 2020 2020 2044 6976 6964             Divid
+0000f210: 656e 6473 3d28 2244 6976 6964 656e 6473  ends=("Dividends
+0000f220: 222c 2022 7375 6d22 292c 0a20 2020 2020  ", "sum"),.     
+0000f230: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+0000f240: 746f 636b 5370 6c69 7473 3d28 2253 746f  tockSplits=("Sto
+0000f250: 636b 2053 706c 6974 7322 2c20 2270 726f  ck Splits", "pro
+0000f260: 6422 2929 2e72 656e 616d 6528 636f 6c75  d")).rename(colu
+0000f270: 6d6e 733d 7b22 5374 6f63 6b53 706c 6974  mns={"StockSplit
+0000f280: 7322 3a20 2253 746f 636b 2053 706c 6974  s": "Stock Split
+0000f290: 7322 2c20 2241 646a 436c 6f73 6522 3a20  s", "AdjClose": 
+0000f2a0: 2241 646a 2043 6c6f 7365 227d 290a 2020  "Adj Close"}).  
+0000f2b0: 2020 2020 2020 2020 2020 6466 322e 6c6f            df2.lo
+0000f2c0: 635b 6466 325b 2253 746f 636b 2053 706c  c[df2["Stock Spl
+0000f2d0: 6974 7322 5d20 3d3d 2031 2c20 2253 746f  its"] == 1, "Sto
+0000f2e0: 636b 2053 706c 6974 7322 5d20 3d20 300a  ck Splits"] = 0.
+0000f2f0: 2020 2020 2020 2020 2020 2020 6466 322e              df2.
+0000f300: 696e 6465 782e 6e61 6d65 203d 2064 662e  index.name = df.
+0000f310: 696e 6465 782e 6e61 6d65 0a20 2020 2020  index.name.     
+0000f320: 2020 2020 2020 2064 6632 2e69 6e64 6578         df2.index
+0000f330: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
+0000f340: 6528 6466 322e 696e 6465 7829 2e74 7a5f  e(df2.index).tz_
+0000f350: 6c6f 6361 6c69 7a65 2864 662e 696e 6465  localize(df.inde
+0000f360: 782e 747a 290a 2020 2020 2020 2020 2020  x.tz).          
+0000f370: 2020 7265 7475 726e 2064 6632 0a0a 2020    return df2..  
+0000f380: 2020 2020 2020 2320 466f 7220 696e 7472        # For intr
+0000f390: 6164 6179 2064 6174 6120 6f6c 6465 7220  aday data older 
+0000f3a0: 7468 616e 2059 6168 6f6f 206c 696d 6974  than Yahoo limit
+0000f3b0: 2c20 636f 6d70 6172 6520 6167 6772 6567  , compare aggreg
+0000f3c0: 6174 6564 2061 6761 696e 7374 2031 640a  ated against 1d.
+0000f3d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000f3e0: 696e 7472 6164 6179 3a0a 2020 2020 2020  intraday:.      
+0000f3f0: 2020 2020 2020 6474 5f6e 6f77 5f6c 6f63        dt_now_loc
+0000f400: 616c 203d 2064 745f 6e6f 772e 747a 5f63  al = dt_now.tz_c
+0000f410: 6f6e 7665 7274 2873 656c 662e 747a 4e61  onvert(self.tzNa
+0000f420: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0000f430: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
+0000f440: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+0000f450: 6c2e 486f 7572 7331 3a0a 2020 2020 2020  l.Hours1:.      
+0000f460: 2020 2020 2020 2020 2020 6d61 785f 6c6f            max_lo
+0000f470: 6f6b 6261 636b 5f64 6179 7320 3d20 3336  okback_days = 36
+0000f480: 352a 320a 2020 2020 2020 2020 2020 2020  5*2.            
+0000f490: 656c 6966 2073 656c 662e 6973 7472 2069  elif self.istr i
+0000f4a0: 6e20 5b22 3930 6d22 2c20 2233 306d 222c  n ["90m", "30m",
+0000f4b0: 2022 3135 6d22 2c20 2235 6d22 2c20 2232   "15m", "5m", "2
+0000f4c0: 6d22 5d3a 0a20 2020 2020 2020 2020 2020  m"]:.           
+0000f4d0: 2020 2020 206d 6178 5f6c 6f6f 6b62 6163       max_lookbac
+0000f4e0: 6b5f 6461 7973 203d 2036 300a 2020 2020  k_days = 60.    
+0000f4f0: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+0000f500: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+0000f510: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
+0000f520: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0000f530: 2020 2023 206d 6178 5f6c 6f6f 6b62 6163     # max_lookbac
+0000f540: 6b5f 6461 7973 203d 2037 0a20 2020 2020  k_days = 7.     
+0000f550: 2020 2020 2020 2020 2020 206d 6178 5f6c             max_l
+0000f560: 6f6f 6b62 6163 6b5f 6461 7973 203d 2033  ookback_days = 3
+0000f570: 300a 2020 2020 2020 2020 2020 2020 6d61  0.            ma
+0000f580: 785f 6c6f 6f6b 6261 636b 203d 2074 696d  x_lookback = tim
+0000f590: 6564 656c 7461 2864 6179 733d 6d61 785f  edelta(days=max_
+0000f5a0: 6c6f 6f6b 6261 636b 5f64 6179 7329 0a20  lookback_days). 
+0000f5b0: 2020 2020 2020 2020 2020 206d 6178 5f6c             max_l
+0000f5c0: 6f6f 6b62 6163 6b20 2d3d 2074 696d 6564  ookback -= timed
+0000f5d0: 656c 7461 286d 696e 7574 6573 3d35 2920  elta(minutes=5) 
+0000f5e0: 2023 2061 6c6c 6f77 2074 696d 6520 666f   # allow time fo
+0000f5f0: 7220 7365 7276 6572 2070 726f 6365 7373  r server process
+0000f600: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0000f610: 2320 6665 7463 685f 7374 6172 745f 6d69  # fetch_start_mi
+0000f620: 6e20 3d20 6474 5f6e 6f77 5f6c 6f63 616c  n = dt_now_local
+0000f630: 2e63 6569 6c28 2231 4422 2920 2d20 6d61  .ceil("1D") - ma
+0000f640: 785f 6c6f 6f6b 6261 636b 0a20 2020 2020  x_lookback.     
+0000f650: 2020 2020 2020 2023 2066 6574 6368 5f73         # fetch_s
+0000f660: 7461 7274 5f6d 696e 203d 2064 745f 6e6f  tart_min = dt_no
+0000f670: 775f 6c6f 6361 6c2e 666c 6f6f 7228 2231  w_local.floor("1
+0000f680: 4422 2920 2d20 6d61 785f 6c6f 6f6b 6261  D") - max_lookba
+0000f690: 636b 0a20 2020 2020 2020 2020 2020 2066  ck.            f
+0000f6a0: 6574 6368 5f73 7461 7274 5f6d 696e 203d  etch_start_min =
+0000f6b0: 2064 745f 6e6f 775f 6c6f 6361 6c20 2d20   dt_now_local - 
+0000f6c0: 6d61 785f 6c6f 6f6b 6261 636b 0a20 2020  max_lookback.   
+0000f6d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0000f6e0: 2e69 6e74 7261 6461 793a 0a20 2020 2020  .intraday:.     
+0000f6f0: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
+0000f700: 5f73 7461 7274 5f6d 696e 203d 2066 6574  _start_min = fet
+0000f710: 6368 5f73 7461 7274 5f6d 696e 2e63 6569  ch_start_min.cei
+0000f720: 6c28 2231 4422 290a 2020 2020 2020 2020  l("1D").        
+0000f730: 2020 2020 6966 2068 2e69 6e64 6578 5b30      if h.index[0
+0000f740: 5d20 3c20 6665 7463 685f 7374 6172 745f  ] < fetch_start_
+0000f750: 6d69 6e3a 0a20 2020 2020 2020 2020 2020  min:.           
+0000f760: 2020 2020 2023 2068 5f6f 6c64 203d 2068       # h_old = h
+0000f770: 2e6c 6f63 5b3a 6665 7463 685f 7374 6172  .loc[:fetch_star
+0000f780: 745f 6d69 6e2d 7469 6d65 6465 6c74 6128  t_min-timedelta(
+0000f790: 7365 636f 6e64 733d 3129 5d0a 2020 2020  seconds=1)].    
+0000f7a0: 2020 2020 2020 2020 2020 2020 2320 685f              # h_
+0000f7b0: 6f6c 645f 3164 203d 205f 6167 6772 6567  old_1d = _aggreg
+0000f7c0: 6174 655f 7966 6466 5f64 6169 6c79 2868  ate_yfdf_daily(h
+0000f7d0: 5f6f 6c64 2e64 726f 7028 5b22 4669 6e61  _old.drop(["Fina
+0000f7e0: 6c3f 222c 2022 432d 4368 6563 6b3f 222c  l?", "C-Check?",
+0000f7f0: 2022 4c61 7374 4469 7641 646a 7573 7444   "LastDivAdjustD
+0000f800: 7422 2c20 224c 6173 7453 706c 6974 4164  t", "LastSplitAd
+0000f810: 6a75 7374 4474 225d 2c20 6178 6973 3d31  justDt"], axis=1
+0000f820: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+0000f830: 2020 2020 2320 6966 2073 656c 662e 696e      # if self.in
+0000f840: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0000f850: 6e74 6572 7661 6c2e 486f 7572 7331 3a0a  nterval.Hours1:.
+0000f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f870: 2320 2020 2020 6466 5f79 6620 3d20 7365  #     df_yf = se
+0000f880: 6c66 2e64 6174 2e68 6973 746f 7279 2869  lf.dat.history(i
+0000f890: 6e74 6572 7661 6c3d 2231 6422 2c20 7374  nterval="1d", st
+0000f8a0: 6172 743d 685f 6f6c 642e 696e 6465 785b  art=h_old.index[
+0000f8b0: 305d 2e64 6174 6528 292c 2065 6e64 3d68  0].date(), end=h
+0000f8c0: 5f6f 6c64 2e69 6e64 6578 5b2d 315d 2e64  _old.index[-1].d
+0000f8d0: 6174 6528 292b 7464 5f31 642c 2061 7574  ate()+td_1d, aut
+0000f8e0: 6f5f 6164 6a75 7374 3d46 616c 7365 2c20  o_adjust=False, 
+0000f8f0: 7265 7061 6972 3d22 7369 6c65 6e74 2229  repair="silent")
+0000f900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f910: 2023 2065 6c73 653a 0a20 2020 2020 2020   # else:.       
+0000f920: 2020 2020 2020 2020 2023 2020 2020 2064           #     d
+0000f930: 665f 7966 203d 2073 656c 662e 6461 742e  f_yf = self.dat.
+0000f940: 6869 7374 6f72 7928 696e 7465 7276 616c  history(interval
+0000f950: 3d22 3168 222c 2073 7461 7274 3d68 5f6f  ="1h", start=h_o
+0000f960: 6c64 2e69 6e64 6578 5b30 5d2e 6461 7465  ld.index[0].date
+0000f970: 2829 2c20 656e 643d 685f 6f6c 642e 696e  (), end=h_old.in
+0000f980: 6465 785b 2d31 5d2e 6461 7465 2829 2b74  dex[-1].date()+t
+0000f990: 645f 3164 2c20 6175 746f 5f61 646a 7573  d_1d, auto_adjus
+0000f9a0: 743d 4661 6c73 652c 2072 6570 6169 723d  t=False, repair=
+0000f9b0: 2273 696c 656e 7422 290a 2020 2020 2020  "silent").      
+0000f9c0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+0000f9d0: 6466 5f79 6620 3d20 5f61 6767 7265 6761  df_yf = _aggrega
+0000f9e0: 7465 5f79 6664 665f 6461 696c 7928 6466  te_yfdf_daily(df
+0000f9f0: 5f79 6629 0a0a 2020 2020 2020 2020 2020  _yf)..          
+0000fa00: 2020 2020 2020 2320 2320 4167 6772 6567        # # Aggreg
+0000fa10: 6174 6564 2064 6174 6120 7769 6c6c 2061  ated data will a
+0000fa20: 6c6d 6f73 7420 616c 7761 7973 2064 6966  lmost always dif
+0000fa30: 6665 7220 6672 6f6d 2061 6374 7561 6c20  fer from actual 
+0000fa40: 6461 696c 792c 2073 6f20 6f6e 6c79 0a20  daily, so only. 
+0000fa50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000fa60: 2023 206c 6f6f 6b20 666f 7220 6269 6720   # look for big 
+0000fa70: 6572 726f 7273 0a20 2020 2020 2020 2020  errors.         
+0000fa80: 2020 2020 2020 2023 2066 5f6f 6c64 5f64         # f_old_d
+0000fa90: 6966 6620 3d20 7966 6375 2e56 6572 6966  iff = yfcu.Verif
+0000faa0: 7950 7269 6365 7344 6628 685f 6f6c 645f  yPricesDf(h_old_
+0000fab0: 3164 2c20 6466 5f79 662c 2073 656c 662e  1d, df_yf, self.
+0000fac0: 696e 7465 7276 616c 2c20 7274 6f6c 3d30  interval, rtol=0
+0000fad0: 2e32 2c20 6465 6275 673d 5472 7565 290a  .2, debug=True).
+0000fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000faf0: 2320 7261 6973 6520 4578 6365 7074 696f  # raise Exceptio
+0000fb00: 6e28 222d 2069 6e76 6573 7469 6761 7465  n("- investigate
+0000fb10: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0000fb20: 2020 2023 2066 5f6f 6c64 5f64 6966 6620     # f_old_diff 
+0000fb30: 3d20 7966 6375 2e56 6572 6966 7950 7269  = yfcu.VerifyPri
+0000fb40: 6365 7344 6628 685f 6f6c 645f 3164 2c20  cesDf(h_old_1d, 
+0000fb50: 6466 5f79 662c 2073 656c 662e 696e 7465  df_yf, self.inte
+0000fb60: 7276 616c 2c20 7274 6f6c 3d30 2e32 290a  rval, rtol=0.2).
+0000fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb80: 2320 6966 2066 5f6f 6c64 5f64 6966 662e  # if f_old_diff.
+0000fb90: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+0000fba0: 2020 2020 2020 2023 2020 2020 206d 7367         #     msg
+0000fbb0: 203d 2066 2253 6967 6e69 6669 6361 6e74   = f"Significant
+0000fbc0: 2064 6966 6665 7265 6e63 6573 2064 6574   differences det
+0000fbd0: 6563 7465 6420 6265 7477 6565 6e20 6f6c  ected between ol
+0000fbe0: 6420 7b73 656c 662e 6973 7472 7d20 6461  d {self.istr} da
+0000fbf0: 7461 2061 6e64 2031 642e 220a 2020 2020  ta and 1d.".    
+0000fc00: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000fc10: 2020 7072 696e 7428 290a 2020 2020 2020    print().      
+0000fc20: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+0000fc30: 2320 665f 6469 6666 5f61 6c6c 203d 2066  # f_diff_all = f
+0000fc40: 5f64 6966 665f 616c 6c20 7c20 665f 6f6c  _diff_all | f_ol
+0000fc50: 645f 6469 6666 0a20 2020 2020 2020 2020  d_diff.         
+0000fc60: 2020 2020 2020 2023 2020 2020 2062 6164         #     bad
+0000fc70: 5f64 6174 6573 203d 2066 5f6f 6c64 5f64  _dates = f_old_d
+0000fc80: 6966 662e 696e 6465 782e 6461 7465 5b66  iff.index.date[f
+0000fc90: 5f6f 6c64 5f64 6966 665d 0a20 2020 2020  _old_diff].     
+0000fca0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+0000fcb0: 2066 5f64 6966 665f 616c 6c5b 6e70 2e69   f_diff_all[np.i
+0000fcc0: 7369 6e28 665f 6469 6666 5f61 6c6c 2e69  sin(f_diff_all.i
+0000fcd0: 6e64 6578 2e64 6174 652c 2062 6164 5f64  ndex.date, bad_d
+0000fce0: 6174 6573 295d 203d 2054 7275 650a 0a20  ates)] = True.. 
+0000fcf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000fd00: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+0000fd10: 2864 6973 6361 7264 5f6f 6c64 2c20 626f  (discard_old, bo
+0000fd20: 6f6c 293a 0a20 2020 2020 2020 2020 2020  ol):.           
+0000fd30: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+0000fd40: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
+0000fd50: 536f 6d65 207b 7365 6c66 2e69 7374 727d  Some {self.istr}
+0000fd60: 2064 6174 6120 6973 206e 6f77 206f 6c64   data is now old
+0000fd70: 6572 2074 6861 6e20 7b6d 6178 5f6c 6f6f  er than {max_loo
+0000fd80: 6b62 6163 6b5f 6461 7973 7d20 6461 7973  kback_days} days
+0000fd90: 2220 2b5c 0a20 2020 2020 2020 2020 2020  " +\.           
 0000fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fdb0: 2066 5f64 6966 665f 616c 6c20 3d20 665f   f_diff_all = f_
-0000fdc0: 6469 6666 5f61 6c6c 207c 2066 5f64 6973  diff_all | f_dis
-0000fdd0: 6361 7264 0a0a 2020 2020 2020 2020 2020  card..          
-0000fde0: 2020 2020 2020 6820 3d20 682e 6c6f 635b        h = h.loc[
-0000fdf0: 6665 7463 685f 7374 6172 745f 6d69 6e3a  fetch_start_min:
-0000fe00: 5d0a 0a20 2020 2020 2020 2069 6620 6e6f  ]..        if no
-0000fe10: 7420 682e 656d 7074 793a 0a20 2020 2020  t h.empty:.     
-0000fe20: 2020 2020 2020 2023 2046 6574 6368 2059         # Fetch Y
-0000fe30: 4620 6461 7461 0a20 2020 2020 2020 2020  F data.         
-0000fe40: 2020 2073 7461 7274 5f64 7420 3d20 682e     start_dt = h.
-0000fe50: 696e 6465 785b 305d 0a20 2020 2020 2020  index[0].       
-0000fe60: 2020 2020 206c 6173 745f 6474 203d 2068       last_dt = h
-0000fe70: 2e69 6e64 6578 5b2d 315d 0a20 2020 2020  .index[-1].     
-0000fe80: 2020 2020 2020 2065 6e64 5f64 7420 3d20         end_dt = 
-0000fe90: 6c61 7374 5f64 7420 2b20 7365 6c66 2e69  last_dt + self.i
-0000fea0: 7464 0a20 2020 2020 2020 2020 2020 2066  td.            f
-0000feb0: 6574 6368 5f73 7461 7274 203d 2073 7461  etch_start = sta
-0000fec0: 7274 5f64 742e 6461 7465 2829 0a20 2020  rt_dt.date().   
-0000fed0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000fee0: 2e69 7464 203e 2074 696d 6564 656c 7461  .itd > timedelta
-0000fef0: 2864 6179 733d 3129 3a0a 2020 2020 2020  (days=1):.      
-0000ff00: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
-0000ff10: 656e 6420 3d20 6c61 7374 5f64 742e 6461  end = last_dt.da
-0000ff20: 7465 2829 2b79 6663 642e 696e 7465 7276  te()+yfcd.interv
-0000ff30: 616c 546f 5469 6d65 6465 6c74 615b 7365  alToTimedelta[se
-0000ff40: 6c66 2e69 6e74 6572 7661 6c5d 0a20 2020  lf.interval].   
-0000ff50: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000ff60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000ff70: 6574 6368 5f65 6e64 203d 206c 6173 745f  etch_end = last_
-0000ff80: 6474 2e64 6174 6528 292b 7464 5f31 640a  dt.date()+td_1d.
-0000ff90: 2020 2020 2020 2020 2020 2020 2320 536f              # So
-0000ffa0: 6d65 7469 6d65 7320 5961 686f 6f20 646f  metimes Yahoo do
-0000ffb0: 6573 6e27 7420 7265 7475 726e 2066 756c  esn't return ful
-0000ffc0: 6c20 7472 6164 696e 6720 6461 7461 2066  l trading data f
-0000ffd0: 6f72 206c 6173 7420 6461 7920 6966 2065  or last day if e
-0000ffe0: 6e64 203d 2064 6179 2061 6674 6572 2e0a  nd = day after..
-0000fff0: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
-00010000: 6420 736f 6d65 206d 6f72 6520 6461 7973  d some more days
-00010010: 2074 6f20 6176 6f69 6420 7072 6f62 6c65   to avoid proble
-00010020: 6d2e 0a20 2020 2020 2020 2020 2020 2066  m..            f
-00010030: 6574 6368 5f65 6e64 202b 3d20 332a 7464  etch_end += 3*td
-00010040: 5f31 640a 2020 2020 2020 2020 2020 2020  _1d.            
-00010050: 6665 7463 685f 656e 6420 3d20 6d69 6e28  fetch_end = min(
-00010060: 6665 7463 685f 656e 642c 2064 745f 6e6f  fetch_end, dt_no
-00010070: 772e 747a 5f63 6f6e 7665 7274 2873 656c  w.tz_convert(sel
-00010080: 662e 747a 4e61 6d65 292e 6365 696c 2822  f.tzName).ceil("
-00010090: 4422 292e 6461 7465 2829 290a 2020 2020  D").date()).    
-000100a0: 2020 2020 2020 2020 7265 7061 6972 203d          repair =
-000100b0: 2054 7275 6520 6966 2064 6562 7567 2065   True if debug e
-000100c0: 6c73 6520 2273 696c 656e 7422 0a20 2020  lse "silent".   
-000100d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000100e0: 2e69 6e74 7261 6461 793a 0a20 2020 2020  .intraday:.     
-000100f0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00010100: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-00010110: 6663 642e 496e 7465 7276 616c 2e4d 696e  fcd.Interval.Min
-00010120: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-00010130: 2020 2020 2020 2020 2320 4665 7463 6820          # Fetch 
-00010140: 696e 2037 2d64 6179 2062 6174 6368 6573  in 7-day batches
-00010150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010160: 2020 2020 2064 665f 7966 203d 204e 6f6e       df_yf = Non
-00010170: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00010180: 2020 2020 2020 7464 5f37 6420 3d20 7469        td_7d = ti
-00010190: 6d65 6465 6c74 6128 6461 7973 3d37 290a  medelta(days=7).
-000101a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101b0: 2020 2020 6665 7463 685f 656e 645f 6261      fetch_end_ba
-000101c0: 7463 6820 3d20 6665 7463 685f 656e 640a  tch = fetch_end.
-000101d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101e0: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
-000101f0: 6261 7463 6820 3d20 6665 7463 685f 656e  batch = fetch_en
-00010200: 6420 2d20 7464 5f37 640a 2020 2020 2020  d - td_7d.      
-00010210: 2020 2020 2020 2020 2020 2020 2020 7768                wh
-00010220: 696c 6520 6665 7463 685f 656e 645f 6261  ile fetch_end_ba
-00010230: 7463 6820 3e20 6665 7463 685f 7374 6172  tch > fetch_star
-00010240: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00010250: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00010260: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
-00010270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010280: 206d 7367 203d 2066 2272 6571 7565 7374   msg = f"request
-00010290: 696e 6720 5946 2066 6574 6368 3a20 7b73  ing YF fetch: {s
-000102a0: 656c 662e 6973 7472 7d20 7b66 6574 6368  elf.istr} {fetch
-000102b0: 5f73 7461 7274 5f62 6174 6368 7d20 2d3e  _start_batch} ->
-000102c0: 207b 6665 7463 685f 656e 645f 6261 7463   {fetch_end_batc
-000102d0: 687d 220a 2020 2020 2020 2020 2020 2020  h}".            
-000102e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102f0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-00010300: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-00010310: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-00010320: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
-00010330: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
-00010340: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00010350: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00010360: 7966 5f62 6174 6368 203d 2073 656c 662e  yf_batch = self.
-00010370: 6461 742e 6869 7374 6f72 7928 696e 7465  dat.history(inte
-00010380: 7276 616c 3d73 656c 662e 6973 7472 2c20  rval=self.istr, 
-00010390: 7374 6172 743d 6665 7463 685f 7374 6172  start=fetch_star
-000103a0: 745f 6261 7463 682c 2065 6e64 3d66 6574  t_batch, end=fet
-000103b0: 6368 5f65 6e64 5f62 6174 6368 2c20 6175  ch_end_batch, au
-000103c0: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
-000103d0: 2072 6570 6169 723d 7265 7061 6972 2c20   repair=repair, 
-000103e0: 6b65 6570 6e61 3d54 7275 6529 0a20 2020  keepna=True).   
-000103f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010400: 2020 2020 2069 6620 6466 5f79 6620 6973       if df_yf is
-00010410: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010430: 2020 2064 665f 7966 203d 2064 665f 7966     df_yf = df_yf
-00010440: 5f62 6174 6368 0a20 2020 2020 2020 2020  _batch.         
-00010450: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00010460: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00010470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010480: 2064 665f 7966 203d 2070 642e 636f 6e63   df_yf = pd.conc
-00010490: 6174 285b 6466 5f79 662c 2064 665f 7966  at([df_yf, df_yf
-000104a0: 5f62 6174 6368 5d2c 2061 7869 733d 3029  _batch], axis=0)
-000104b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000104c0: 2020 2020 2020 2020 2023 0a20 2020 2020           #.     
-000104d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104e0: 2020 2066 6574 6368 5f65 6e64 5f62 6174     fetch_end_bat
-000104f0: 6368 202d 3d20 7464 5f37 640a 2020 2020  ch -= td_7d.    
-00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010510: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
-00010520: 6261 7463 6820 2d3d 2074 645f 3764 0a20  batch -= td_7d. 
-00010530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010540: 2020 2020 2020 2066 6574 6368 5f73 7461         fetch_sta
-00010550: 7274 5f62 6174 6368 203d 206d 6178 2866  rt_batch = max(f
-00010560: 6574 6368 5f73 7461 7274 5f62 6174 6368  etch_start_batch
-00010570: 2c20 6665 7463 685f 7374 6172 7429 0a20  , fetch_start). 
-00010580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010590: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
-000105a0: 2020 2020 2020 2020 2064 665f 7966 203d           df_yf =
-000105b0: 2064 665f 7966 2e73 6f72 745f 696e 6465   df_yf.sort_inde
-000105c0: 7828 290a 2020 2020 2020 2020 2020 2020  x().            
-000105d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000105e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000105f0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+0000fdb0: 2022 2073 6f20 6361 6e6e 6f74 2063 6f6d   " so cannot com
+0000fdc0: 7061 7265 2074 6f20 5961 686f 6f2e 2044  pare to Yahoo. D
+0000fdd0: 6973 6361 7264 206f 6c64 2064 6174 613f  iscard old data?
+0000fde0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0000fdf0: 2020 2020 2020 6469 7363 6172 645f 6f6c        discard_ol
+0000fe00: 6420 3d20 636c 6963 6b2e 636f 6e66 6972  d = click.confir
+0000fe10: 6d28 6d73 672c 2064 6566 6175 6c74 3d46  m(msg, default=F
+0000fe20: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
+0000fe30: 2020 2020 2020 6966 2064 6973 6361 7264        if discard
+0000fe40: 5f6f 6c64 3a0a 2020 2020 2020 2020 2020  _old:.          
+0000fe50: 2020 2020 2020 2020 2020 665f 6469 7363            f_disc
+0000fe60: 6172 6420 3d20 7064 2e53 6572 6965 7328  ard = pd.Series(
+0000fe70: 682e 696e 6465 7820 3c20 6665 7463 685f  h.index < fetch_
+0000fe80: 7374 6172 745f 6d69 6e2c 2068 2e69 6e64  start_min, h.ind
+0000fe90: 6578 290a 2020 2020 2020 2020 2020 2020  ex).            
+0000fea0: 2020 2020 2020 2020 6966 2066 5f64 6973          if f_dis
+0000feb0: 6361 7264 2e61 6e79 2829 3a0a 2020 2020  card.any():.    
+0000fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fed0: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+0000fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fef0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000ff00: 6622 4469 7363 6172 6469 6e67 207b 6e70  f"Discarding {np
+0000ff10: 2e73 756d 2866 5f64 6973 6361 7264 297d  .sum(f_discard)}
+0000ff20: 2f7b 6e7d 206f 6c64 2072 6f77 7320 6265  /{n} old rows be
+0000ff30: 6361 7573 6520 6361 6e27 7420 7665 7269  cause can't veri
+0000ff40: 6679 2028 6665 7463 685f 7374 6172 745f  fy (fetch_start_
+0000ff50: 6d69 6e3d 7b66 6574 6368 5f73 7461 7274  min={fetch_start
+0000ff60: 5f6d 696e 7d29 2229 0a20 2020 2020 2020  _min})").       
+0000ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff80: 2066 5f64 6966 665f 616c 6c20 3d20 665f   f_diff_all = f_
+0000ff90: 6469 6666 5f61 6c6c 207c 2066 5f64 6973  diff_all | f_dis
+0000ffa0: 6361 7264 0a0a 2020 2020 2020 2020 2020  card..          
+0000ffb0: 2020 2020 2020 6820 3d20 682e 6c6f 635b        h = h.loc[
+0000ffc0: 6665 7463 685f 7374 6172 745f 6d69 6e3a  fetch_start_min:
+0000ffd0: 5d0a 0a20 2020 2020 2020 2069 6620 6e6f  ]..        if no
+0000ffe0: 7420 682e 656d 7074 793a 0a20 2020 2020  t h.empty:.     
+0000fff0: 2020 2020 2020 2023 2046 6574 6368 2059         # Fetch Y
+00010000: 4620 6461 7461 0a20 2020 2020 2020 2020  F data.         
+00010010: 2020 2073 7461 7274 5f64 7420 3d20 682e     start_dt = h.
+00010020: 696e 6465 785b 305d 0a20 2020 2020 2020  index[0].       
+00010030: 2020 2020 206c 6173 745f 6474 203d 2068       last_dt = h
+00010040: 2e69 6e64 6578 5b2d 315d 0a20 2020 2020  .index[-1].     
+00010050: 2020 2020 2020 2065 6e64 5f64 7420 3d20         end_dt = 
+00010060: 6c61 7374 5f64 7420 2b20 7365 6c66 2e69  last_dt + self.i
+00010070: 7464 0a20 2020 2020 2020 2020 2020 2066  td.            f
+00010080: 6574 6368 5f73 7461 7274 203d 2073 7461  etch_start = sta
+00010090: 7274 5f64 742e 6461 7465 2829 0a20 2020  rt_dt.date().   
+000100a0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000100b0: 2e69 7464 203e 2074 696d 6564 656c 7461  .itd > timedelta
+000100c0: 2864 6179 733d 3129 3a0a 2020 2020 2020  (days=1):.      
+000100d0: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
+000100e0: 656e 6420 3d20 6c61 7374 5f64 742e 6461  end = last_dt.da
+000100f0: 7465 2829 2b79 6663 642e 696e 7465 7276  te()+yfcd.interv
+00010100: 616c 546f 5469 6d65 6465 6c74 615b 7365  alToTimedelta[se
+00010110: 6c66 2e69 6e74 6572 7661 6c5d 0a20 2020  lf.interval].   
+00010120: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00010130: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010140: 6574 6368 5f65 6e64 203d 206c 6173 745f  etch_end = last_
+00010150: 6474 2e64 6174 6528 292b 7464 5f31 640a  dt.date()+td_1d.
+00010160: 2020 2020 2020 2020 2020 2020 2320 536f              # So
+00010170: 6d65 7469 6d65 7320 5961 686f 6f20 646f  metimes Yahoo do
+00010180: 6573 6e27 7420 7265 7475 726e 2066 756c  esn't return ful
+00010190: 6c20 7472 6164 696e 6720 6461 7461 2066  l trading data f
+000101a0: 6f72 206c 6173 7420 6461 7920 6966 2065  or last day if e
+000101b0: 6e64 203d 2064 6179 2061 6674 6572 2e0a  nd = day after..
+000101c0: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
+000101d0: 6420 736f 6d65 206d 6f72 6520 6461 7973  d some more days
+000101e0: 2074 6f20 6176 6f69 6420 7072 6f62 6c65   to avoid proble
+000101f0: 6d2e 0a20 2020 2020 2020 2020 2020 2066  m..            f
+00010200: 6574 6368 5f65 6e64 202b 3d20 332a 7464  etch_end += 3*td
+00010210: 5f31 640a 2020 2020 2020 2020 2020 2020  _1d.            
+00010220: 6665 7463 685f 656e 6420 3d20 6d69 6e28  fetch_end = min(
+00010230: 6665 7463 685f 656e 642c 2064 745f 6e6f  fetch_end, dt_no
+00010240: 772e 747a 5f63 6f6e 7665 7274 2873 656c  w.tz_convert(sel
+00010250: 662e 747a 4e61 6d65 292e 6365 696c 2822  f.tzName).ceil("
+00010260: 4422 292e 6461 7465 2829 290a 2020 2020  D").date()).    
+00010270: 2020 2020 2020 2020 7265 7061 6972 203d          repair =
+00010280: 2054 7275 6520 6966 2064 6562 7567 2065   True if debug e
+00010290: 6c73 6520 2273 696c 656e 7422 0a20 2020  lse "silent".   
+000102a0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000102b0: 2e69 6e74 7261 6461 793a 0a20 2020 2020  .intraday:.     
+000102c0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+000102d0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
+000102e0: 6663 642e 496e 7465 7276 616c 2e4d 696e  fcd.Interval.Min
+000102f0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
+00010300: 2020 2020 2020 2020 2320 4665 7463 6820          # Fetch 
+00010310: 696e 2037 2d64 6179 2062 6174 6368 6573  in 7-day batches
+00010320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010330: 2020 2020 2064 665f 7966 203d 204e 6f6e       df_yf = Non
+00010340: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00010350: 2020 2020 2020 7464 5f37 6420 3d20 7469        td_7d = ti
+00010360: 6d65 6465 6c74 6128 6461 7973 3d37 290a  medelta(days=7).
+00010370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010380: 2020 2020 6665 7463 685f 656e 645f 6261      fetch_end_ba
+00010390: 7463 6820 3d20 6665 7463 685f 656e 640a  tch = fetch_end.
+000103a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103b0: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+000103c0: 6261 7463 6820 3d20 6665 7463 685f 656e  batch = fetch_en
+000103d0: 6420 2d20 7464 5f37 640a 2020 2020 2020  d - td_7d.      
+000103e0: 2020 2020 2020 2020 2020 2020 2020 7768                wh
+000103f0: 696c 6520 6665 7463 685f 656e 645f 6261  ile fetch_end_ba
+00010400: 7463 6820 3e20 6665 7463 685f 7374 6172  tch > fetch_star
+00010410: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00010420: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00010430: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010450: 206d 7367 203d 2066 2272 6571 7565 7374   msg = f"request
+00010460: 696e 6720 5946 2066 6574 6368 3a20 7b73  ing YF fetch: {s
+00010470: 656c 662e 6973 7472 7d20 7b66 6574 6368  elf.istr} {fetch
+00010480: 5f73 7461 7274 5f62 6174 6368 7d20 2d3e  _start_batch} ->
+00010490: 207b 6665 7463 685f 656e 645f 6261 7463   {fetch_end_batc
+000104a0: 687d 220a 2020 2020 2020 2020 2020 2020  h}".            
+000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104c0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+000104d0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
+000104e0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
+000104f0: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
+00010500: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
+00010510: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+00010520: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00010530: 7966 5f62 6174 6368 203d 2073 656c 662e  yf_batch = self.
+00010540: 6461 742e 6869 7374 6f72 7928 696e 7465  dat.history(inte
+00010550: 7276 616c 3d73 656c 662e 6973 7472 2c20  rval=self.istr, 
+00010560: 7374 6172 743d 6665 7463 685f 7374 6172  start=fetch_star
+00010570: 745f 6261 7463 682c 2065 6e64 3d66 6574  t_batch, end=fet
+00010580: 6368 5f65 6e64 5f62 6174 6368 2c20 6175  ch_end_batch, au
+00010590: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
+000105a0: 2072 6570 6169 723d 7265 7061 6972 2c20   repair=repair, 
+000105b0: 6b65 6570 6e61 3d54 7275 6529 0a20 2020  keepna=True).   
+000105c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105d0: 2020 2020 2069 6620 6e6f 7420 2252 6570       if not "Rep
+000105e0: 6169 7265 643f 2220 696e 2064 665f 7966  aired?" in df_yf
+000105f0: 5f62 6174 6368 2e63 6f6c 756d 6e73 3a0a  _batch.columns:.
 00010600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010610: 6d73 6720 3d20 6622 7265 7175 6573 7469  msg = f"requesti
-00010620: 6e67 2059 4620 6665 7463 683a 207b 7365  ng YF fetch: {se
-00010630: 6c66 2e69 7374 727d 207b 6665 7463 685f  lf.istr} {fetch_
-00010640: 7374 6172 747d 202d 3e20 7b66 6574 6368  start} -> {fetch
-00010650: 5f65 6e64 7d22 0a20 2020 2020 2020 2020  _end}".         
-00010660: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00010670: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-00010680: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-00010690: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-000106a0: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
-000106b0: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
-000106c0: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-000106d0: 2020 2020 2020 2020 2320 6466 5f79 6620          # df_yf 
-000106e0: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
-000106f0: 7279 2869 6e74 6572 7661 6c3d 7365 6c66  ry(interval=self
-00010700: 2e69 7374 722c 2073 7461 7274 3d66 6574  .istr, start=fet
-00010710: 6368 5f73 7461 7274 2c20 656e 643d 6665  ch_start, end=fe
-00010720: 7463 685f 656e 642c 2061 7574 6f5f 6164  tch_end, auto_ad
-00010730: 6a75 7374 3d46 616c 7365 2c20 7265 7061  just=False, repa
-00010740: 6972 3d72 6570 6169 7229 0a20 2020 2020  ir=repair).     
-00010750: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00010760: 665f 7966 203d 2073 656c 662e 6461 742e  f_yf = self.dat.
-00010770: 6869 7374 6f72 7928 696e 7465 7276 616c  history(interval
-00010780: 3d73 656c 662e 6973 7472 2c20 7374 6172  =self.istr, star
-00010790: 743d 6665 7463 685f 7374 6172 742c 2065  t=fetch_start, e
-000107a0: 6e64 3d66 6574 6368 5f65 6e64 2c20 6175  nd=fetch_end, au
-000107b0: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
-000107c0: 2072 6570 6169 723d 7265 7061 6972 2c20   repair=repair, 
-000107d0: 6b65 6570 6e61 3d54 7275 6529 0a20 2020  keepna=True).   
-000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107f0: 2064 665f 7966 203d 2064 665f 7966 2e6c   df_yf = df_yf.l
-00010800: 6f63 5b73 7461 7274 5f64 743a 5d0a 2020  oc[start_dt:].  
-00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010820: 2020 6466 5f79 6620 3d20 6466 5f79 665b    df_yf = df_yf[
-00010830: 6466 5f79 662e 696e 6465 7820 3c20 656e  df_yf.index < en
-00010840: 645f 6474 5d0a 0a20 2020 2020 2020 2020  d_dt]..         
-00010850: 2020 2020 2020 2023 2059 6168 6f6f 2064         # Yahoo d
-00010860: 6f65 736e 2774 2064 6976 2d61 646a 7573  oesn't div-adjus
-00010870: 7420 696e 7472 6164 6179 0a20 2020 2020  t intraday.     
-00010880: 2020 2020 2020 2020 2020 2064 665f 7966             df_yf
-00010890: 5f31 6420 3d20 7365 6c66 2e64 6174 2e68  _1d = self.dat.h
-000108a0: 6973 746f 7279 2869 6e74 6572 7661 6c3d  istory(interval=
-000108b0: 2231 6422 2c20 7374 6172 743d 6466 5f79  "1d", start=df_y
-000108c0: 662e 696e 6465 785b 305d 2e64 6174 6528  f.index[0].date(
-000108d0: 292c 2065 6e64 3d64 665f 7966 2e69 6e64  ), end=df_yf.ind
-000108e0: 6578 5b2d 315d 2e64 6174 6528 292b 7464  ex[-1].date()+td
-000108f0: 5f31 642c 2061 7574 6f5f 6164 6a75 7374  _1d, auto_adjust
-00010900: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
-00010910: 2020 2020 2020 2020 6466 5f79 665b 225f          df_yf["_
-00010920: 696e 6465 7842 6163 6b75 7022 5d20 3d20  indexBackup"] = 
-00010930: 6466 5f79 662e 696e 6465 780a 2020 2020  df_yf.index.    
-00010940: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
-00010950: 665b 225f 6461 7465 225d 203d 2064 665f  f["_date"] = df_
-00010960: 7966 2e69 6e64 6578 2e64 6174 650a 2020  yf.index.date.  
-00010970: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00010980: 5f79 665f 3164 5b22 5f64 6174 6522 5d20  _yf_1d["_date"] 
-00010990: 3d20 6466 5f79 665f 3164 2e69 6e64 6578  = df_yf_1d.index
-000109a0: 2e64 6174 650a 2020 2020 2020 2020 2020  .date.          
-000109b0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-000109c0: 2020 2020 2020 2020 2320 6466 5f79 6620          # df_yf 
-000109d0: 3d20 6466 5f79 662e 6472 6f70 2822 4164  = df_yf.drop("Ad
-000109e0: 6a20 436c 6f73 6522 2c20 6178 6973 3d31  j Close", axis=1
-000109f0: 292e 6d65 7267 6528 6466 5f79 665f 3164  ).merge(df_yf_1d
-00010a00: 5b5b 2241 646a 2043 6c6f 7365 222c 2022  [["Adj Close", "
-00010a10: 5f64 6174 6522 5d5d 2c20 686f 773d 226c  _date"]], how="l
-00010a20: 6566 7422 2c20 6f6e 3d22 5f64 6174 6522  eft", on="_date"
-00010a30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010a40: 2020 6466 5f79 665f 3164 5b22 4164 6a22    df_yf_1d["Adj"
-00010a50: 5d20 3d20 6466 5f79 665f 3164 5b22 4164  ] = df_yf_1d["Ad
-00010a60: 6a20 436c 6f73 6522 5d2e 746f 5f6e 756d  j Close"].to_num
-00010a70: 7079 2829 202f 2064 665f 7966 5f31 645b  py() / df_yf_1d[
-00010a80: 2243 6c6f 7365 225d 2e74 6f5f 6e75 6d70  "Close"].to_nump
-00010a90: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00010aa0: 2020 2020 6466 5f79 6620 3d20 6466 5f79      df_yf = df_y
-00010ab0: 662e 6d65 7267 6528 6466 5f79 665f 3164  f.merge(df_yf_1d
-00010ac0: 5b5b 2241 646a 222c 2022 5f64 6174 6522  [["Adj", "_date"
-00010ad0: 5d5d 2c20 686f 773d 226c 6566 7422 2c20  ]], how="left", 
-00010ae0: 6f6e 3d22 5f64 6174 6522 290a 2020 2020  on="_date").    
-00010af0: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
-00010b00: 665b 2241 646a 2043 6c6f 7365 225d 203d  f["Adj Close"] =
-00010b10: 2064 665f 7966 5b22 436c 6f73 6522 5d2e   df_yf["Close"].
-00010b20: 746f 5f6e 756d 7079 2829 202a 2064 665f  to_numpy() * df_
-00010b30: 7966 5b22 4164 6a22 5d2e 746f 5f6e 756d  yf["Adj"].to_num
-00010b40: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-00010b50: 2020 2020 2064 665f 7966 203d 2064 665f       df_yf = df_
-00010b60: 7966 2e64 726f 7028 2241 646a 222c 2061  yf.drop("Adj", a
-00010b70: 7869 733d 3129 0a20 2020 2020 2020 2020  xis=1).         
-00010b80: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-00010b90: 2020 2020 2020 2020 2064 665f 7966 2e69           df_yf.i
-00010ba0: 6e64 6578 203d 2064 665f 7966 5b22 5f69  ndex = df_yf["_i
-00010bb0: 6e64 6578 4261 636b 7570 225d 0a20 2020  ndexBackup"].   
-00010bc0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00010bd0: 7966 203d 2064 665f 7966 2e64 726f 7028  yf = df_yf.drop(
-00010be0: 5b22 5f69 6e64 6578 4261 636b 7570 222c  ["_indexBackup",
-00010bf0: 2022 5f64 6174 6522 5d2c 2061 7869 733d   "_date"], axis=
-00010c00: 3129 0a20 2020 2020 2020 2020 2020 2065  1).            e
-00010c10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00010c20: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
-00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c40: 2020 206d 7367 203d 2066 2272 6571 7565     msg = f"reque
-00010c50: 7374 696e 6720 5946 2066 6574 6368 3a20  sting YF fetch: 
-00010c60: 7b73 656c 662e 6973 7472 7d20 7b66 6574  {self.istr} {fet
-00010c70: 6368 5f73 7461 7274 7d20 2d3e 207b 6665  ch_start} -> {fe
-00010c80: 7463 685f 656e 647d 220a 2020 2020 2020  tch_end}".      
-00010c90: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00010ca0: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-00010cb0: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-00010cc0: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-00010cd0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
-00010ce0: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-00010cf0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-00010d00: 2020 2023 2064 665f 7966 203d 2073 656c     # df_yf = sel
-00010d10: 662e 6461 742e 6869 7374 6f72 7928 696e  f.dat.history(in
-00010d20: 7465 7276 616c 3d73 656c 662e 6973 7472  terval=self.istr
-00010d30: 2c20 7374 6172 743d 6665 7463 685f 7374  , start=fetch_st
-00010d40: 6172 742c 2065 6e64 3d66 6574 6368 5f65  art, end=fetch_e
-00010d50: 6e64 2c20 6175 746f 5f61 646a 7573 743d  nd, auto_adjust=
-00010d60: 4661 6c73 652c 2072 6570 6169 723d 7265  False, repair=re
-00010d70: 7061 6972 290a 2020 2020 2020 2020 2020  pair).          
-00010d80: 2020 2020 2020 6466 5f79 6620 3d20 7365        df_yf = se
-00010d90: 6c66 2e64 6174 2e68 6973 746f 7279 2869  lf.dat.history(i
-00010da0: 6e74 6572 7661 6c3d 7365 6c66 2e69 7374  nterval=self.ist
-00010db0: 722c 2073 7461 7274 3d66 6574 6368 5f73  r, start=fetch_s
-00010dc0: 7461 7274 2c20 656e 643d 6665 7463 685f  tart, end=fetch_
-00010dd0: 656e 642c 2061 7574 6f5f 6164 6a75 7374  end, auto_adjust
-00010de0: 3d46 616c 7365 2c20 7265 7061 6972 3d72  =False, repair=r
-00010df0: 6570 6169 722c 206b 6565 706e 613d 5472  epair, keepna=Tr
-00010e00: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-00010e10: 2020 2020 2320 6966 206e 6f74 2022 4469      # if not "Di
-00010e20: 7669 6465 6e64 7322 2069 6e20 6466 5f79  vidends" in df_y
-00010e30: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-00010e40: 2020 2069 6620 6466 5f79 662e 656d 7074     if df_yf.empt
-00010e50: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00010e60: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-00010e70: 6570 7469 6f6e 2866 227b 7365 6c66 2e74  eption(f"{self.t
-00010e80: 6963 6b65 727d 3a20 5946 2066 6574 6368  icker}: YF fetch
-00010e90: 2066 6169 6c65 6420 666f 7220 7b73 656c   failed for {sel
-00010ea0: 662e 6973 7472 7d20 7b66 6574 6368 5f73  f.istr} {fetch_s
-00010eb0: 7461 7274 7d20 2d3e 207b 6665 7463 685f  tart} -> {fetch_
-00010ec0: 656e 647d 2229 0a20 2020 2020 2020 2020  end}").         
-00010ed0: 2020 2020 2020 2023 204d 616b 6520 7370         # Make sp
-00010ee0: 6563 6961 6c20 6164 6a75 7374 6d65 6e74  ecial adjustment
-00010ef0: 7320 666f 7220 6469 7669 6465 6e64 7320  s for dividends 
-00010f00: 2f20 7374 6f63 6b20 7370 6c69 7473 2072  / stock splits r
-00010f10: 656c 6561 7365 6420 544f 4441 590a 2020  eleased TODAY.  
-00010f20: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00010f30: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
-00010f40: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-00010f50: 4461 7973 313a 0a20 2020 2020 2020 2020  Days1:.         
-00010f60: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00010f70: 7420 6e70 2e69 736e 616e 2864 665f 7966  t np.isnan(df_yf
-00010f80: 5b22 4469 7669 6465 6e64 7322 5d2e 696c  ["Dividends"].il
-00010f90: 6f63 5b2d 315d 2920 616e 6420 6466 5f79  oc[-1]) and df_y
-00010fa0: 665b 2244 6976 6964 656e 6473 225d 2e69  f["Dividends"].i
-00010fb0: 6c6f 635b 2d31 5d20 3e20 303a 0a20 2020  loc[-1] > 0:.   
-00010fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fd0: 2020 2020 2065 7870 6563 745f 6e65 775f       expect_new_
-00010fe0: 6469 765f 6d69 7373 696e 6720 3d20 4661  div_missing = Fa
-00010ff0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00011000: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00011010: 702e 6973 6e61 6e28 6466 5f79 665b 2243  p.isnan(df_yf["C
-00011020: 6c6f 7365 225d 2e69 6c6f 635b 2d31 5d29  lose"].iloc[-1])
-00011030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011040: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00011050: 7065 6374 5f6e 6577 5f64 6976 5f6d 6973  pect_new_div_mis
-00011060: 7369 6e67 203d 2054 7275 650a 2020 2020  sing = True.    
-00011070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011080: 2020 2020 656c 6966 2068 5f6c 6173 7452      elif h_lastR
-00011090: 6f77 2e6e 616d 6520 3d3d 2064 665f 7966  ow.name == df_yf
-000110a0: 2e69 6e64 6578 5b2d 315d 2061 6e64 2068  .index[-1] and h
-000110b0: 5f6c 6173 7452 6f77 5b22 4469 7669 6465  _lastRow["Divide
-000110c0: 6e64 7322 5d20 3d3d 2030 2e30 3a0a 2020  nds"] == 0.0:.  
-000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110e0: 2020 2020 2020 2020 2020 6578 7065 6374            expect
-000110f0: 5f6e 6577 5f64 6976 5f6d 6973 7369 6e67  _new_div_missing
-00011100: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 6966 2065 7870 6563 745f 6e65 775f 6469  if expect_new_di
-00011130: 765f 6d69 7373 696e 673a 0a20 2020 2020  v_missing:.     
-00011140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011150: 2020 2020 2020 2023 2059 4643 2077 6f6e         # YFC won
-00011160: 2774 2068 6176 6520 7265 636f 7264 206f  't have record o
-00011170: 6620 7468 6973 2064 6976 6964 656e 6420  f this dividend 
-00011180: 6265 6361 7573 6520 6f63 6375 7273 2074  because occurs t
-00011190: 6f6e 6967 6874 2f74 6f6d 6f72 726f 772c  onight/tomorrow,
-000111a0: 2073 6f20 7265 6d6f 7665 2069 7427 7320   so remove it's 
-000111b0: 6164 6a75 7374 6d65 6e74 2066 726f 6d20  adjustment from 
-000111c0: 7072 6963 6573 0a20 2020 2020 2020 2020  prices.         
-000111d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111e0: 2020 2072 6576 5f61 646a 203d 2064 665f     rev_adj = df_
-000111f0: 7966 5b22 436c 6f73 6522 5d2e 696c 6f63  yf["Close"].iloc
-00011200: 5b2d 325d 202f 2064 665f 7966 5b22 4164  [-2] / df_yf["Ad
-00011210: 6a20 436c 6f73 6522 5d2e 696c 6f63 5b2d  j Close"].iloc[-
-00011220: 325d 0a20 2020 2020 2020 2020 2020 2020  2].             
-00011230: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00011240: 7367 203d 2066 222d 2072 656d 6f76 696e  sg = f"- removin
-00011250: 6720 6469 7669 6465 6e64 2066 726f 6d20  g dividend from 
-00011260: 6466 5f79 663a 207b 6466 5f79 662e 696e  df_yf: {df_yf.in
-00011270: 6465 785b 2d31 5d7d 2061 646a 3d7b 312e  dex[-1]} adj={1.
-00011280: 302f 7265 765f 6164 6a7d 220a 2020 2020  0/rev_adj}".    
-00011290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000112a0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-000112b0: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
-000112c0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-000112d0: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
-000112e0: 6e74 2866 227b 7365 6c66 2e74 6963 6b65  nt(f"{self.ticke
-000112f0: 727d 3a20 2220 2b20 6d73 6729 0a20 2020  r}: " + msg).   
-00011300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011310: 2020 2020 2020 2020 2064 665f 7966 5b22           df_yf["
-00011320: 4164 6a20 436c 6f73 6522 5d20 2a3d 2072  Adj Close"] *= r
-00011330: 6576 5f61 646a 0a20 2020 2020 2020 2020  ev_adj.         
-00011340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011350: 2020 2064 665f 7966 203d 2064 665f 7966     df_yf = df_yf
-00011360: 2e64 726f 7028 6466 5f79 662e 696e 6465  .drop(df_yf.inde
-00011370: 785b 2d31 5d29 0a20 2020 2020 2020 2020  x[-1]).         
-00011380: 2020 2020 2020 2020 2020 2069 6620 6466             if df
-00011390: 5f79 662e 696e 6465 785b 2d31 5d20 3d3d  _yf.index[-1] ==
-000113a0: 2068 5f6c 6173 7452 6f77 2e6e 616d 6520   h_lastRow.name 
-000113b0: 616e 6420 6466 5f79 665b 2253 746f 636b  and df_yf["Stock
-000113c0: 2053 706c 6974 7322 5d2e 696c 6f63 5b2d   Splits"].iloc[-
-000113d0: 315d 2021 3d20 3020 616e 6420 685f 6c61  1] != 0 and h_la
-000113e0: 7374 526f 775b 2253 746f 636b 2053 706c  stRow["Stock Spl
-000113f0: 6974 7322 5d20 3d3d 2030 3a0a 2020 2020  its"] == 0:.    
-00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011410: 2020 2020 2320 5946 4320 646f 6573 6e27      # YFC doesn'
-00011420: 7420 6861 7665 2072 6563 6f72 6420 6f66  t have record of
-00011430: 2074 6f64 6179 2773 2073 706c 6974 2079   today's split y
-00011440: 6574 2073 6f20 7265 6d6f 7665 2065 6666  et so remove eff
-00011450: 6563 740a 2020 2020 2020 2020 2020 2020  ect.            
-00011460: 2020 2020 2020 2020 2020 2020 7265 765f              rev_
-00011470: 6164 6a20 3d20 6466 5f79 665b 2253 746f  adj = df_yf["Sto
-00011480: 636b 2053 706c 6974 7322 5d2e 696c 6f63  ck Splits"].iloc
-00011490: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
-000114a0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-000114b0: 203d 2066 222d 2072 656d 6f76 696e 6720   = f"- removing 
-000114c0: 7370 6c69 7420 6672 6f6d 2064 665f 7966  split from df_yf
-000114d0: 3a20 7b64 665f 7966 2e69 6e64 6578 5b2d  : {df_yf.index[-
-000114e0: 315d 7d20 6164 6a3d 7b31 2e30 2f72 6576  1]} adj={1.0/rev
-000114f0: 5f61 646a 7d22 0a20 2020 2020 2020 2020  _adj}".         
-00011500: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00011510: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-00011520: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-00011530: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-00011540: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
-00011550: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
-00011560: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-00011570: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011580: 6320 696e 205b 224f 7065 6e22 2c20 2248  c in ["Open", "H
-00011590: 6967 6822 2c20 224c 6f77 222c 2022 436c  igh", "Low", "Cl
-000115a0: 6f73 6522 2c20 2241 646a 2043 6c6f 7365  ose", "Adj Close
-000115b0: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115d0: 6466 5f79 665b 635d 202a 3d20 7265 765f  df_yf[c] *= rev_
-000115e0: 6164 6a0a 2020 2020 2020 2020 2020 2020  adj.            
-000115f0: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
-00011600: 665b 2256 6f6c 756d 6522 5d20 2f3d 2072  f["Volume"] /= r
-00011610: 6576 5f61 646a 0a20 2020 2020 2020 2020  ev_adj.         
-00011620: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00011630: 665f 7966 2e6c 6f63 5b64 665f 7966 2e69  f_yf.loc[df_yf.i
-00011640: 6e64 6578 5b2d 315d 2c20 2253 746f 636b  ndex[-1], "Stock
-00011650: 2053 706c 6974 7322 5d20 3d20 302e 300a   Splits"] = 0.0.
-00011660: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011670: 6466 5f79 6620 6973 204e 6f6e 6520 6f72  df_yf is None or
-00011680: 2064 665f 7966 2e65 6d70 7479 3a0a 2020   df_yf.empty:.  
-00011690: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000116a0: 6973 6520 4578 6365 7074 696f 6e28 6622  ise Exception(f"
-000116b0: 4665 7463 6869 6e67 2072 6566 6572 656e  Fetching referen
-000116c0: 6365 2079 6669 6e61 6e63 6520 6461 7461  ce yfinance data
-000116d0: 2066 6169 6c65 6420 2869 6e74 6572 7661   failed (interva
-000116e0: 6c3d 7b73 656c 662e 6973 7472 7d2c 2073  l={self.istr}, s
-000116f0: 7461 7274 5f64 743d 7b73 7461 7274 5f64  tart_dt={start_d
-00011700: 747d 2c20 6c61 7374 5f64 743d 7b6c 6173  t}, last_dt={las
-00011710: 745f 6474 7d29 2229 0a20 2020 2020 2020  t_dt})").       
-00011720: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00011730: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-00011740: 7465 7276 616c 2e57 6565 6b3a 0a20 2020  terval.Week:.   
-00011750: 2020 2020 2020 2020 2020 2020 2023 2045               # E
-00011760: 6e73 7572 6520 6461 7461 2061 6c69 676e  nsure data align
-00011770: 6564 2074 6f20 4d6f 6e64 6179 3a0a 2020  ed to Monday:.  
-00011780: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00011790: 206e 6f74 2064 665f 7966 2e69 6e64 6578   not df_yf.index
-000117a0: 5b30 5d2e 7765 656b 6461 7928 2920 3d3d  [0].weekday() ==
-000117b0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-000117c0: 2020 2020 2020 2020 6e20 3d20 300a 2020          n = 0.  
-000117d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117e0: 2020 7768 696c 6520 6e20 3c20 333a 0a20    while n < 3:. 
-000117f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011800: 2020 2020 2020 2066 6574 6368 5f73 7461         fetch_sta
-00011810: 7274 202d 3d20 7469 6d65 6465 6c74 6128  rt -= timedelta(
-00011820: 6461 7973 3d32 290a 2020 2020 2020 2020  days=2).        
-00011830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011840: 6466 5f79 6620 3d20 7365 6c66 2e64 6174  df_yf = self.dat
-00011850: 2e68 6973 746f 7279 2869 6e74 6572 7661  .history(interva
-00011860: 6c3d 7365 6c66 2e69 7374 722c 2073 7461  l=self.istr, sta
-00011870: 7274 3d66 6574 6368 5f73 7461 7274 2c20  rt=fetch_start, 
-00011880: 656e 643d 6665 7463 685f 656e 642c 2061  end=fetch_end, a
-00011890: 7574 6f5f 6164 6a75 7374 3d46 616c 7365  uto_adjust=False
-000118a0: 2c20 7265 7061 6972 3d72 6570 6169 7229  , repair=repair)
-000118b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000118c0: 2020 2020 2020 2020 206e 202b 3d20 310a           n += 1.
-000118d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000118e0: 2020 2020 2020 2020 6966 2064 665f 7966          if df_yf
-000118f0: 2e69 6e64 6578 5b30 5d2e 7765 656b 6461  .index[0].weekda
-00011900: 7928 2920 3d3d 2030 3a0a 2020 2020 2020  y() == 0:.      
-00011910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011920: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00011930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011940: 6966 206e 6f74 2064 665f 7966 2e69 6e64  if not df_yf.ind
-00011950: 6578 5b30 5d2e 7765 656b 6461 7928 2920  ex[0].weekday() 
-00011960: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00011970: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00011980: 6973 6520 4578 6365 7074 696f 6e28 2246  ise Exception("F
-00011990: 6169 6c65 6420 746f 2067 6574 204d 6f6e  ailed to get Mon
-000119a0: 6461 792d 616c 6967 6e65 6420 7765 656b  day-aligned week
-000119b0: 6c79 2064 6174 6120 6672 6f6d 2059 4622  ly data from YF"
-000119c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000119d0: 2020 2020 2020 6466 5f79 6620 3d20 6466        df_yf = df
-000119e0: 5f79 662e 6c6f 635b 682e 696e 6465 785b  _yf.loc[h.index[
-000119f0: 305d 3a5d 0a0a 2020 2020 2020 2020 2020  0]:]..          
-00011a00: 2020 2320 6966 2073 656c 662e 6578 6368    # if self.exch
-00011a10: 616e 6765 203d 3d20 2241 5358 2220 616e  ange == "ASX" an
-00011a20: 6420 7365 6c66 2e69 7374 7220 696e 205b  d self.istr in [
-00011a30: 2231 6d22 2c20 2232 6d22 2c20 2235 6d22  "1m", "2m", "5m"
-00011a40: 5d3a 0a20 2020 2020 2020 2020 2020 2023  ]:.            #
-00011a50: 2020 2020 2023 2041 5358 206d 6172 6b65       # ASX marke
-00011a60: 7420 636c 6f73 6573 2061 7420 3470 6d20  t closes at 4pm 
-00011a70: 7769 7468 2061 7563 7469 6f6e 2061 726f  with auction aro
-00011a80: 756e 6420 343a 3131 706d 2c0a 2020 2020  und 4:11pm,.    
-00011a90: 2020 2020 2020 2020 2320 2020 2020 2320          #     # 
-00011aa0: 6275 7420 736f 6d65 7469 6d65 7320 5961  but sometimes Ya
-00011ab0: 686f 6f20 7468 696e 6b73 2074 696e 7920  hoo thinks tiny 
-00011ac0: 766f 6c75 6d65 206f 6620 7472 6164 6573  volume of trades
-00011ad0: 206f 6363 7572 7265 640a 2020 2020 2020   occurred.      
-00011ae0: 2020 2020 2020 2320 2020 2020 2320 696e        #     # in
-00011af0: 6265 7477 6565 6e2e 2057 726f 6e67 210a  between. Wrong!.
-00011b00: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00011b10: 2020 2320 4669 7820 3d20 6d65 7267 6520    # Fix = merge 
-00011b20: 7769 7468 2070 7265 7669 6f75 7320 696e  with previous in
-00011b30: 7465 7276 616c 0a20 2020 2020 2020 2020  terval.         
-00011b40: 2020 2023 2020 2020 2066 203d 2064 665f     #     f = df_
-00011b50: 7966 2e69 6e64 6578 2e74 696d 6520 3d3d  yf.index.time ==
-00011b60: 2074 696d 6528 3136 290a 2020 2020 2020   time(16).      
-00011b70: 2020 2020 2020 2320 2020 2020 6966 2066        #     if f
-00011b80: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-00011b90: 2020 2020 2320 2020 2020 2020 2020 696e      #         in
-00011ba0: 6469 6365 7320 3d20 736f 7274 6564 286c  dices = sorted(l
-00011bb0: 6973 7428 6e70 2e77 6865 7265 2866 295b  ist(np.where(f)[
-00011bc0: 305d 2929 0a20 2020 2020 2020 2020 2020  0])).           
-00011bd0: 2023 2020 2020 2020 2020 2066 6f72 2069   #         for i
-00011be0: 2069 6e20 696e 6469 6365 733a 0a20 2020   in indices:.   
-00011bf0: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00011c00: 2020 2020 2020 2064 665f 7966 2e6c 6f63         df_yf.loc
-00011c10: 5b64 665f 7966 2e69 6e64 6578 5b69 2d31  [df_yf.index[i-1
-00011c20: 5d2c 2022 566f 6c75 6d65 225d 202b 3d20  ], "Volume"] += 
-00011c30: 6466 5f79 665b 2256 6f6c 756d 6522 5d2e  df_yf["Volume"].
-00011c40: 696c 6f63 5b69 5d0a 2020 2020 2020 2020  iloc[i].        
-00011c50: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-00011c60: 2020 6466 5f79 662e 6c6f 635b 6466 5f79    df_yf.loc[df_y
-00011c70: 662e 696e 6465 785b 692d 315d 2c20 2243  f.index[i-1], "C
-00011c80: 6c6f 7365 225d 203d 2064 665f 7966 5b22  lose"] = df_yf["
-00011c90: 436c 6f73 6522 5d2e 696c 6f63 5b69 5d0a  Close"].iloc[i].
-00011ca0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00011cb0: 2020 2020 2020 6466 5f79 6620 3d20 6466        df_yf = df
-00011cc0: 5f79 662e 6472 6f70 2864 665f 7966 2e69  _yf.drop(df_yf.i
-00011cd0: 6e64 6578 5b69 6e64 6963 6573 5d29 0a20  ndex[indices]). 
-00011ce0: 2020 2020 2020 2020 2020 2023 2055 7064             # Upd
-00011cf0: 6174 653a 2049 2074 6869 6e6b 2059 6168  ate: I think Yah
-00011d00: 6f6f 2072 6967 6874 2062 6563 6175 7365  oo right because
-00011d10: 2054 7261 6469 6e67 5669 6577 2063 6f6e   TradingView con
-00011d20: 6669 726d 730a 0a20 2020 2020 2020 2020  firms..         
-00011d30: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
-00011d40: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
-00011d50: 2020 2020 2020 2020 2023 2056 6f6c 756d           # Volum
-00011d60: 6520 6e6f 7420 7370 6c69 742d 6164 6a75  e not split-adju
-00011d70: 7374 6564 0a20 2020 2020 2020 2020 2020  sted.           
-00011d80: 2020 2020 2073 7320 3d20 6466 5f79 665b       ss = df_yf[
-00011d90: 2253 746f 636b 2053 706c 6974 7322 5d2e  "Stock Splits"].
-00011da0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-00011db0: 2020 2020 2020 2073 735b 2873 7320 3d3d         ss[(ss ==
-00011dc0: 2030 2e30 2920 7c20 7373 2e69 736e 6128   0.0) | ss.isna(
-00011dd0: 295d 203d 2031 2e30 0a20 2020 2020 2020  )] = 1.0.       
-00011de0: 2020 2020 2020 2020 2073 735f 7263 7020           ss_rcp 
-00011df0: 3d20 312e 3020 2f20 7373 0a20 2020 2020  = 1.0 / ss.     
-00011e00: 2020 2020 2020 2020 2020 2063 7366 203d             csf =
-00011e10: 2073 735f 7263 702e 736f 7274 5f69 6e64   ss_rcp.sort_ind
-00011e20: 6578 2861 7363 656e 6469 6e67 3d46 616c  ex(ascending=Fal
-00011e30: 7365 292e 6375 6d70 726f 6428 292e 736f  se).cumprod().so
-00011e40: 7274 5f69 6e64 6578 2861 7363 656e 6469  rt_index(ascendi
-00011e50: 6e67 3d54 7275 6529 2e73 6869 6674 282d  ng=True).shift(-
-00011e60: 312c 2066 696c 6c5f 7661 6c75 653d 312e  1, fill_value=1.
-00011e70: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00011e80: 2020 2064 665f 7966 5b22 566f 6c75 6d65     df_yf["Volume
-00011e90: 225d 203d 2064 665f 7966 5b22 566f 6c75  "] = df_yf["Volu
-00011ea0: 6d65 225d 2e74 6f5f 6e75 6d70 7928 2920  me"].to_numpy() 
-00011eb0: 2f20 6373 660a 0a20 2020 2020 2020 2020  / csf..         
-00011ec0: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
-00011ed0: 7661 6c20 213d 2079 6663 642e 496e 7465  val != yfcd.Inte
-00011ee0: 7276 616c 2e44 6179 7331 2061 6e64 2063  rval.Days1 and c
-00011ef0: 6f72 7265 6374 3a0a 2020 2020 2020 2020  orrect:.        
-00011f00: 2020 2020 2020 2020 2320 436f 7079 206f          # Copy o
-00011f10: 7665 7220 616e 7920 6d69 7373 696e 6720  ver any missing 
-00011f20: 6469 7669 6465 6e64 730a 2020 2020 2020  dividends.      
-00011f30: 2020 2020 2020 2020 2020 6320 3d20 2244            c = "D
-00011f40: 6976 6964 656e 6473 220a 2020 2020 2020  ividends".      
-00011f50: 2020 2020 2020 2020 2020 685f 6469 7673            h_divs
-00011f60: 203d 2068 2e6c 6f63 5b68 5b63 5d20 213d   = h.loc[h[c] !=
-00011f70: 2030 2e30 2c20 635d 2e63 6f70 7928 292e   0.0, c].copy().
-00011f80: 6472 6f70 6e61 2829 0a20 2020 2020 2020  dropna().       
-00011f90: 2020 2020 2020 2020 2079 665f 6469 7673           yf_divs
-00011fa0: 203d 2064 665f 7966 2e6c 6f63 5b64 665f   = df_yf.loc[df_
-00011fb0: 7966 5b63 5d20 213d 2030 2e30 2c20 635d  yf[c] != 0.0, c]
-00011fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011fd0: 2064 7473 5f6d 6973 7369 6e67 5f66 726f   dts_missing_fro
-00011fe0: 6d5f 6361 6368 6520 3d20 7966 5f64 6976  m_cache = yf_div
-00011ff0: 732e 696e 6465 785b 7e79 665f 6469 7673  s.index[~yf_divs
-00012000: 2e69 6e64 6578 2e69 7369 6e28 685f 6469  .index.isin(h_di
-00012010: 7673 2e69 6e64 6578 295d 0a20 2020 2020  vs.index)].     
-00012020: 2020 2020 2020 2020 2020 2064 7473 5f6d             dts_m
-00012030: 6973 7369 6e67 5f66 726f 6d5f 6361 6368  issing_from_cach
-00012040: 6520 3d20 5b64 7420 666f 7220 6474 2069  e = [dt for dt i
-00012050: 6e20 6474 735f 6d69 7373 696e 675f 6672  n dts_missing_fr
-00012060: 6f6d 5f63 6163 6865 2069 6620 6474 2069  om_cache if dt i
-00012070: 6e20 682e 696e 6465 785d 0a20 2020 2020  n h.index].     
-00012080: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00012090: 6e28 6474 735f 6d69 7373 696e 675f 6672  n(dts_missing_fr
-000120a0: 6f6d 5f63 6163 6865 2920 3e20 303a 0a20  om_cache) > 0:. 
-000120b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120c0: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-000120d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000120e0: 2020 2020 206d 7367 203d 2066 2243 4f52       msg = f"COR
-000120f0: 5245 4354 494e 473a 2043 6163 6865 206d  RECTING: Cache m
-00012100: 6973 7369 6e67 2074 6865 7365 2064 6976  issing these div
-00012110: 6964 656e 6473 3a20 7b64 7473 5f6d 6973  idends: {dts_mis
-00012120: 7369 6e67 5f66 726f 6d5f 6361 6368 657d  sing_from_cache}
-00012130: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00012140: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-00012150: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
-00012160: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-00012170: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
-00012180: 7269 6e74 2866 227b 7365 6c66 2e74 6963  rint(f"{self.tic
-00012190: 6b65 727d 3a20 2220 2b20 6d73 6729 0a20  ker}: " + msg). 
+00010610: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
+00010620: 665f 6261 7463 685b 2252 6570 6169 7265  f_batch["Repaire
+00010630: 643f 225d 203d 2046 616c 7365 0a20 2020  d?"] = False.   
+00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010650: 2020 2020 2069 6620 6466 5f79 6620 6973       if df_yf is
+00010660: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00010670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010680: 2020 2064 665f 7966 203d 2064 665f 7966     df_yf = df_yf
+00010690: 5f62 6174 6368 0a20 2020 2020 2020 2020  _batch.         
+000106a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000106b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000106c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106d0: 2064 665f 7966 203d 2070 642e 636f 6e63   df_yf = pd.conc
+000106e0: 6174 285b 6466 5f79 662c 2064 665f 7966  at([df_yf, df_yf
+000106f0: 5f62 6174 6368 5d2c 2061 7869 733d 3029  _batch], axis=0)
+00010700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010710: 2020 2020 2020 2020 2023 0a20 2020 2020           #.     
+00010720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010730: 2020 2066 6574 6368 5f65 6e64 5f62 6174     fetch_end_bat
+00010740: 6368 202d 3d20 7464 5f37 640a 2020 2020  ch -= td_7d.    
+00010750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010760: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+00010770: 6261 7463 6820 2d3d 2074 645f 3764 0a20  batch -= td_7d. 
+00010780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010790: 2020 2020 2020 2066 6574 6368 5f73 7461         fetch_sta
+000107a0: 7274 5f62 6174 6368 203d 206d 6178 2866  rt_batch = max(f
+000107b0: 6574 6368 5f73 7461 7274 5f62 6174 6368  etch_start_batch
+000107c0: 2c20 6665 7463 685f 7374 6172 7429 0a20  , fetch_start). 
+000107d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107e0: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
+000107f0: 2020 2020 2020 2020 2064 665f 7966 203d           df_yf =
+00010800: 2064 665f 7966 2e73 6f72 745f 696e 6465   df_yf.sort_inde
+00010810: 7828 290a 2020 2020 2020 2020 2020 2020  x().            
+00010820: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010830: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010840: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+00010850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010860: 6d73 6720 3d20 6622 7265 7175 6573 7469  msg = f"requesti
+00010870: 6e67 2059 4620 6665 7463 683a 207b 7365  ng YF fetch: {se
+00010880: 6c66 2e69 7374 727d 207b 6665 7463 685f  lf.istr} {fetch_
+00010890: 7374 6172 747d 202d 3e20 7b66 6574 6368  start} -> {fetch
+000108a0: 5f65 6e64 7d22 0a20 2020 2020 2020 2020  _end}".         
+000108b0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+000108c0: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
+000108d0: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
+000108e0: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
+000108f0: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
+00010900: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
+00010910: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
+00010920: 2020 2020 2020 2020 2320 6466 5f79 6620          # df_yf 
+00010930: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
+00010940: 7279 2869 6e74 6572 7661 6c3d 7365 6c66  ry(interval=self
+00010950: 2e69 7374 722c 2073 7461 7274 3d66 6574  .istr, start=fet
+00010960: 6368 5f73 7461 7274 2c20 656e 643d 6665  ch_start, end=fe
+00010970: 7463 685f 656e 642c 2061 7574 6f5f 6164  tch_end, auto_ad
+00010980: 6a75 7374 3d46 616c 7365 2c20 7265 7061  just=False, repa
+00010990: 6972 3d72 6570 6169 7229 0a20 2020 2020  ir=repair).     
+000109a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000109b0: 665f 7966 203d 2073 656c 662e 6461 742e  f_yf = self.dat.
+000109c0: 6869 7374 6f72 7928 696e 7465 7276 616c  history(interval
+000109d0: 3d73 656c 662e 6973 7472 2c20 7374 6172  =self.istr, star
+000109e0: 743d 6665 7463 685f 7374 6172 742c 2065  t=fetch_start, e
+000109f0: 6e64 3d66 6574 6368 5f65 6e64 2c20 6175  nd=fetch_end, au
+00010a00: 746f 5f61 646a 7573 743d 4661 6c73 652c  to_adjust=False,
+00010a10: 2072 6570 6169 723d 7265 7061 6972 2c20   repair=repair, 
+00010a20: 6b65 6570 6e61 3d54 7275 6529 0a20 2020  keepna=True).   
+00010a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a40: 2069 6620 6e6f 7420 2252 6570 6169 7265   if not "Repaire
+00010a50: 643f 2220 696e 2064 665f 7966 2e63 6f6c  d?" in df_yf.col
+00010a60: 756d 6e73 3a0a 2020 2020 2020 2020 2020  umns:.          
+00010a70: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00010a80: 5f79 665b 2252 6570 6169 7265 643f 225d  _yf["Repaired?"]
+00010a90: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00010aa0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00010ab0: 7966 203d 2064 665f 7966 2e6c 6f63 5b73  yf = df_yf.loc[s
+00010ac0: 7461 7274 5f64 743a 5d0a 2020 2020 2020  tart_dt:].      
+00010ad0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00010ae0: 5f79 6620 3d20 6466 5f79 665b 6466 5f79  _yf = df_yf[df_y
+00010af0: 662e 696e 6465 7820 3c20 656e 645f 6474  f.index < end_dt
+00010b00: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00010b10: 2020 2023 2059 6168 6f6f 2064 6f65 736e     # Yahoo doesn
+00010b20: 2774 2064 6976 2d61 646a 7573 7420 696e  't div-adjust in
+00010b30: 7472 6164 6179 0a20 2020 2020 2020 2020  traday.         
+00010b40: 2020 2020 2020 2064 665f 7966 5f31 6420         df_yf_1d 
+00010b50: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
+00010b60: 7279 2869 6e74 6572 7661 6c3d 2231 6422  ry(interval="1d"
+00010b70: 2c20 7374 6172 743d 6466 5f79 662e 696e  , start=df_yf.in
+00010b80: 6465 785b 305d 2e64 6174 6528 292c 2065  dex[0].date(), e
+00010b90: 6e64 3d64 665f 7966 2e69 6e64 6578 5b2d  nd=df_yf.index[-
+00010ba0: 315d 2e64 6174 6528 292b 7464 5f31 642c  1].date()+td_1d,
+00010bb0: 2061 7574 6f5f 6164 6a75 7374 3d46 616c   auto_adjust=Fal
+00010bc0: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00010bd0: 2020 2020 6966 206e 6f74 2022 5265 7061      if not "Repa
+00010be0: 6972 6564 3f22 2069 6e20 6466 5f79 665f  ired?" in df_yf_
+00010bf0: 3164 2e63 6f6c 756d 6e73 3a0a 2020 2020  1d.columns:.    
+00010c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c10: 6466 5f79 665f 3164 5b22 5265 7061 6972  df_yf_1d["Repair
+00010c20: 6564 3f22 5d20 3d20 4661 6c73 650a 2020  ed?"] = False.  
+00010c30: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00010c40: 5f79 665b 225f 696e 6465 7842 6163 6b75  _yf["_indexBacku
+00010c50: 7022 5d20 3d20 6466 5f79 662e 696e 6465  p"] = df_yf.inde
+00010c60: 780a 2020 2020 2020 2020 2020 2020 2020  x.              
+00010c70: 2020 6466 5f79 665b 225f 6461 7465 225d    df_yf["_date"]
+00010c80: 203d 2064 665f 7966 2e69 6e64 6578 2e64   = df_yf.index.d
+00010c90: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+00010ca0: 2020 2020 6466 5f79 665f 3164 5b22 5f64      df_yf_1d["_d
+00010cb0: 6174 6522 5d20 3d20 6466 5f79 665f 3164  ate"] = df_yf_1d
+00010cc0: 2e69 6e64 6578 2e64 6174 650a 2020 2020  .index.date.    
+00010cd0: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
+00010ce0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00010cf0: 6466 5f79 6620 3d20 6466 5f79 662e 6472  df_yf = df_yf.dr
+00010d00: 6f70 2822 4164 6a20 436c 6f73 6522 2c20  op("Adj Close", 
+00010d10: 6178 6973 3d31 292e 6d65 7267 6528 6466  axis=1).merge(df
+00010d20: 5f79 665f 3164 5b5b 2241 646a 2043 6c6f  _yf_1d[["Adj Clo
+00010d30: 7365 222c 2022 5f64 6174 6522 5d5d 2c20  se", "_date"]], 
+00010d40: 686f 773d 226c 6566 7422 2c20 6f6e 3d22  how="left", on="
+00010d50: 5f64 6174 6522 290a 2020 2020 2020 2020  _date").        
+00010d60: 2020 2020 2020 2020 6466 5f79 665f 3164          df_yf_1d
+00010d70: 5b22 4164 6a22 5d20 3d20 6466 5f79 665f  ["Adj"] = df_yf_
+00010d80: 3164 5b22 4164 6a20 436c 6f73 6522 5d2e  1d["Adj Close"].
+00010d90: 746f 5f6e 756d 7079 2829 202f 2064 665f  to_numpy() / df_
+00010da0: 7966 5f31 645b 2243 6c6f 7365 225d 2e74  yf_1d["Close"].t
+00010db0: 6f5f 6e75 6d70 7928 290a 2020 2020 2020  o_numpy().      
+00010dc0: 2020 2020 2020 2020 2020 6466 5f79 6620            df_yf 
+00010dd0: 3d20 6466 5f79 662e 6d65 7267 6528 6466  = df_yf.merge(df
+00010de0: 5f79 665f 3164 5b5b 2241 646a 222c 2022  _yf_1d[["Adj", "
+00010df0: 5f64 6174 6522 5d5d 2c20 686f 773d 226c  _date"]], how="l
+00010e00: 6566 7422 2c20 6f6e 3d22 5f64 6174 6522  eft", on="_date"
+00010e10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010e20: 2020 6466 5f79 665b 2241 646a 2043 6c6f    df_yf["Adj Clo
+00010e30: 7365 225d 203d 2064 665f 7966 5b22 436c  se"] = df_yf["Cl
+00010e40: 6f73 6522 5d2e 746f 5f6e 756d 7079 2829  ose"].to_numpy()
+00010e50: 202a 2064 665f 7966 5b22 4164 6a22 5d2e   * df_yf["Adj"].
+00010e60: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
+00010e70: 2020 2020 2020 2020 2020 2064 665f 7966             df_yf
+00010e80: 203d 2064 665f 7966 2e64 726f 7028 2241   = df_yf.drop("A
+00010e90: 646a 222c 2061 7869 733d 3129 0a20 2020  dj", axis=1).   
+00010ea0: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
+00010eb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00010ec0: 665f 7966 2e69 6e64 6578 203d 2064 665f  f_yf.index = df_
+00010ed0: 7966 5b22 5f69 6e64 6578 4261 636b 7570  yf["_indexBackup
+00010ee0: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00010ef0: 2020 2064 665f 7966 203d 2064 665f 7966     df_yf = df_yf
+00010f00: 2e64 726f 7028 5b22 5f69 6e64 6578 4261  .drop(["_indexBa
+00010f10: 636b 7570 222c 2022 5f64 6174 6522 5d2c  ckup", "_date"],
+00010f20: 2061 7869 733d 3129 0a20 2020 2020 2020   axis=1).       
+00010f30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00010f40: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00010f50: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+00010f60: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+00010f70: 2272 6571 7565 7374 696e 6720 5946 2066  "requesting YF f
+00010f80: 6574 6368 3a20 7b73 656c 662e 6973 7472  etch: {self.istr
+00010f90: 7d20 7b66 6574 6368 5f73 7461 7274 7d20  } {fetch_start} 
+00010fa0: 2d3e 207b 6665 7463 685f 656e 647d 220a  -> {fetch_end}".
+00010fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010fc0: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
+00010fd0: 696e 7428 6d73 6729 2069 6620 7966 636c  int(msg) if yfcl
+00010fe0: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
+00010ff0: 6428 2920 656c 7365 2070 7269 6e74 2866  d() else print(f
+00011000: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
+00011010: 2220 2b20 6d73 6729 0a20 2020 2020 2020  " + msg).       
+00011020: 2020 2020 2020 2020 2023 2064 665f 7966           # df_yf
+00011030: 203d 2073 656c 662e 6461 742e 6869 7374   = self.dat.hist
+00011040: 6f72 7928 696e 7465 7276 616c 3d73 656c  ory(interval=sel
+00011050: 662e 6973 7472 2c20 7374 6172 743d 6665  f.istr, start=fe
+00011060: 7463 685f 7374 6172 742c 2065 6e64 3d66  tch_start, end=f
+00011070: 6574 6368 5f65 6e64 2c20 6175 746f 5f61  etch_end, auto_a
+00011080: 646a 7573 743d 4661 6c73 652c 2072 6570  djust=False, rep
+00011090: 6169 723d 7265 7061 6972 290a 2020 2020  air=repair).    
+000110a0: 2020 2020 2020 2020 2020 2020 6466 5f79              df_y
+000110b0: 6620 3d20 7365 6c66 2e64 6174 2e68 6973  f = self.dat.his
+000110c0: 746f 7279 2869 6e74 6572 7661 6c3d 7365  tory(interval=se
+000110d0: 6c66 2e69 7374 722c 2073 7461 7274 3d66  lf.istr, start=f
+000110e0: 6574 6368 5f73 7461 7274 2c20 656e 643d  etch_start, end=
+000110f0: 6665 7463 685f 656e 642c 2061 7574 6f5f  fetch_end, auto_
+00011100: 6164 6a75 7374 3d46 616c 7365 2c20 7265  adjust=False, re
+00011110: 7061 6972 3d72 6570 6169 722c 206b 6565  pair=repair, kee
+00011120: 706e 613d 5472 7565 290a 2020 2020 2020  pna=True).      
+00011130: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00011140: 2022 5265 7061 6972 6564 3f22 2069 6e20   "Repaired?" in 
+00011150: 6466 5f79 662e 636f 6c75 6d6e 733a 0a20  df_yf.columns:. 
+00011160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011170: 2020 2064 665f 7966 5b22 5265 7061 6972     df_yf["Repair
+00011180: 6564 3f22 5d20 3d20 4661 6c73 650a 2020  ed?"] = False.  
+00011190: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000111a0: 6966 206e 6f74 2022 4469 7669 6465 6e64  if not "Dividend
+000111b0: 7322 2069 6e20 6466 5f79 663a 0a20 2020  s" in df_yf:.   
+000111c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000111d0: 6466 5f79 662e 656d 7074 793a 0a20 2020  df_yf.empty:.   
+000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111f0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+00011200: 2866 227b 7365 6c66 2e74 6963 6b65 727d  (f"{self.ticker}
+00011210: 3a20 5946 2066 6574 6368 2066 6169 6c65  : YF fetch faile
+00011220: 6420 666f 7220 7b73 656c 662e 6973 7472  d for {self.istr
+00011230: 7d20 7b66 6574 6368 5f73 7461 7274 7d20  } {fetch_start} 
+00011240: 2d3e 207b 6665 7463 685f 656e 647d 2229  -> {fetch_end}")
+00011250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011260: 2023 204d 616b 6520 7370 6563 6961 6c20   # Make special 
+00011270: 6164 6a75 7374 6d65 6e74 7320 666f 7220  adjustments for 
+00011280: 6469 7669 6465 6e64 7320 2f20 7374 6f63  dividends / stoc
+00011290: 6b20 7370 6c69 7473 2072 656c 6561 7365  k splits release
+000112a0: 6420 544f 4441 590a 2020 2020 2020 2020  d TODAY.        
+000112b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000112c0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+000112d0: 2e49 6e74 6572 7661 6c2e 4461 7973 313a  .Interval.Days1:
+000112e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000112f0: 2020 2020 2069 6620 6e6f 7420 6e70 2e69       if not np.i
+00011300: 736e 616e 2864 665f 7966 5b22 4469 7669  snan(df_yf["Divi
+00011310: 6465 6e64 7322 5d2e 696c 6f63 5b2d 315d  dends"].iloc[-1]
+00011320: 2920 616e 6420 6466 5f79 665b 2244 6976  ) and df_yf["Div
+00011330: 6964 656e 6473 225d 2e69 6c6f 635b 2d31  idends"].iloc[-1
+00011340: 5d20 3e20 303a 0a20 2020 2020 2020 2020  ] > 0:.         
+00011350: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00011360: 7870 6563 745f 6e65 775f 6469 765f 6d69  xpect_new_div_mi
+00011370: 7373 696e 6720 3d20 4661 6c73 650a 2020  ssing = False.  
+00011380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011390: 2020 2020 2020 6966 206e 702e 6973 6e61        if np.isna
+000113a0: 6e28 6466 5f79 665b 2243 6c6f 7365 225d  n(df_yf["Close"]
+000113b0: 2e69 6c6f 635b 2d31 5d29 3a0a 2020 2020  .iloc[-1]):.    
+000113c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113d0: 2020 2020 2020 2020 6578 7065 6374 5f6e          expect_n
+000113e0: 6577 5f64 6976 5f6d 6973 7369 6e67 203d  ew_div_missing =
+000113f0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+00011400: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00011410: 6966 2068 5f6c 6173 7452 6f77 2e6e 616d  if h_lastRow.nam
+00011420: 6520 3d3d 2064 665f 7966 2e69 6e64 6578  e == df_yf.index
+00011430: 5b2d 315d 2061 6e64 2068 5f6c 6173 7452  [-1] and h_lastR
+00011440: 6f77 5b22 4469 7669 6465 6e64 7322 5d20  ow["Dividends"] 
+00011450: 3d3d 2030 2e30 3a0a 2020 2020 2020 2020  == 0.0:.        
+00011460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011470: 2020 2020 6578 7065 6374 5f6e 6577 5f64      expect_new_d
+00011480: 6976 5f6d 6973 7369 6e67 203d 2054 7275  iv_missing = Tru
+00011490: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000114a0: 2020 2020 2020 2020 2020 6966 2065 7870            if exp
+000114b0: 6563 745f 6e65 775f 6469 765f 6d69 7373  ect_new_div_miss
+000114c0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+000114d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114e0: 2023 2059 4643 2077 6f6e 2774 2068 6176   # YFC won't hav
+000114f0: 6520 7265 636f 7264 206f 6620 7468 6973  e record of this
+00011500: 2064 6976 6964 656e 6420 6265 6361 7573   dividend becaus
+00011510: 6520 6f63 6375 7273 2074 6f6e 6967 6874  e occurs tonight
+00011520: 2f74 6f6d 6f72 726f 772c 2073 6f20 7265  /tomorrow, so re
+00011530: 6d6f 7665 2069 7427 7320 6164 6a75 7374  move it's adjust
+00011540: 6d65 6e74 2066 726f 6d20 7072 6963 6573  ment from prices
+00011550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011560: 2020 2020 2020 2020 2020 2020 2072 6576               rev
+00011570: 5f61 646a 203d 2064 665f 7966 5b22 436c  _adj = df_yf["Cl
+00011580: 6f73 6522 5d2e 696c 6f63 5b2d 325d 202f  ose"].iloc[-2] /
+00011590: 2064 665f 7966 5b22 4164 6a20 436c 6f73   df_yf["Adj Clos
+000115a0: 6522 5d2e 696c 6f63 5b2d 325d 0a20 2020  e"].iloc[-2].   
+000115b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000115c0: 2020 2020 2020 2020 206d 7367 203d 2066           msg = f
+000115d0: 222d 2072 656d 6f76 696e 6720 6469 7669  "- removing divi
+000115e0: 6465 6e64 2066 726f 6d20 6466 5f79 663a  dend from df_yf:
+000115f0: 207b 6466 5f79 662e 696e 6465 785b 2d31   {df_yf.index[-1
+00011600: 5d7d 2061 646a 3d7b 312e 302f 7265 765f  ]} adj={1.0/rev_
+00011610: 6164 6a7d 220a 2020 2020 2020 2020 2020  adj}".          
+00011620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011630: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
+00011640: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
+00011650: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+00011660: 2920 656c 7365 2070 7269 6e74 2866 227b  ) else print(f"{
+00011670: 7365 6c66 2e74 6963 6b65 727d 3a20 2220  self.ticker}: " 
+00011680: 2b20 6d73 6729 0a20 2020 2020 2020 2020  + msg).         
+00011690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000116a0: 2020 2064 665f 7966 5b22 4164 6a20 436c     df_yf["Adj Cl
+000116b0: 6f73 6522 5d20 2a3d 2072 6576 5f61 646a  ose"] *= rev_adj
+000116c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000116d0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+000116e0: 7966 203d 2064 665f 7966 2e64 726f 7028  yf = df_yf.drop(
+000116f0: 6466 5f79 662e 696e 6465 785b 2d31 5d29  df_yf.index[-1])
+00011700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011710: 2020 2020 2069 6620 6466 5f79 662e 696e       if df_yf.in
+00011720: 6465 785b 2d31 5d20 3d3d 2068 5f6c 6173  dex[-1] == h_las
+00011730: 7452 6f77 2e6e 616d 6520 616e 6420 6466  tRow.name and df
+00011740: 5f79 665b 2253 746f 636b 2053 706c 6974  _yf["Stock Split
+00011750: 7322 5d2e 696c 6f63 5b2d 315d 2021 3d20  s"].iloc[-1] != 
+00011760: 3020 616e 6420 685f 6c61 7374 526f 775b  0 and h_lastRow[
+00011770: 2253 746f 636b 2053 706c 6974 7322 5d20  "Stock Splits"] 
+00011780: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00011790: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000117a0: 5946 4320 646f 6573 6e27 7420 6861 7665  YFC doesn't have
+000117b0: 2072 6563 6f72 6420 6f66 2074 6f64 6179   record of today
+000117c0: 2773 2073 706c 6974 2079 6574 2073 6f20  's split yet so 
+000117d0: 7265 6d6f 7665 2065 6666 6563 740a 2020  remove effect.  
+000117e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000117f0: 2020 2020 2020 7265 765f 6164 6a20 3d20        rev_adj = 
+00011800: 6466 5f79 665b 2253 746f 636b 2053 706c  df_yf["Stock Spl
+00011810: 6974 7322 5d2e 696c 6f63 5b2d 315d 0a20  its"].iloc[-1]. 
+00011820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011830: 2020 2020 2020 206d 7367 203d 2066 222d         msg = f"-
+00011840: 2072 656d 6f76 696e 6720 7370 6c69 7420   removing split 
+00011850: 6672 6f6d 2064 665f 7966 3a20 7b64 665f  from df_yf: {df_
+00011860: 7966 2e69 6e64 6578 5b2d 315d 7d20 6164  yf.index[-1]} ad
+00011870: 6a3d 7b31 2e30 2f72 6576 5f61 646a 7d22  j={1.0/rev_adj}"
+00011880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011890: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
+000118a0: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
+000118b0: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
+000118c0: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
+000118d0: 696e 7428 6622 7b73 656c 662e 7469 636b  int(f"{self.tick
+000118e0: 6572 7d3a 2022 202b 206d 7367 290a 2020  er}: " + msg).  
+000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011900: 2020 2020 2020 666f 7220 6320 696e 205b        for c in [
+00011910: 224f 7065 6e22 2c20 2248 6967 6822 2c20  "Open", "High", 
+00011920: 224c 6f77 222c 2022 436c 6f73 6522 2c20  "Low", "Close", 
+00011930: 2241 646a 2043 6c6f 7365 225d 3a0a 2020  "Adj Close"]:.  
+00011940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011950: 2020 2020 2020 2020 2020 6466 5f79 665b            df_yf[
+00011960: 635d 202a 3d20 7265 765f 6164 6a0a 2020  c] *= rev_adj.  
+00011970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011980: 2020 2020 2020 6466 5f79 665b 2256 6f6c        df_yf["Vol
+00011990: 756d 6522 5d20 2f3d 2072 6576 5f61 646a  ume"] /= rev_adj
+000119a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000119b0: 2020 2020 2020 2020 2064 665f 7966 2e6c           df_yf.l
+000119c0: 6f63 5b64 665f 7966 2e69 6e64 6578 5b2d  oc[df_yf.index[-
+000119d0: 315d 2c20 2253 746f 636b 2053 706c 6974  1], "Stock Split
+000119e0: 7322 5d20 3d20 302e 300a 0a20 2020 2020  s"] = 0.0..     
+000119f0: 2020 2020 2020 2069 6620 6466 5f79 6620         if df_yf 
+00011a00: 6973 204e 6f6e 6520 6f72 2064 665f 7966  is None or df_yf
+00011a10: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+00011a20: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
+00011a30: 6365 7074 696f 6e28 6622 4665 7463 6869  ception(f"Fetchi
+00011a40: 6e67 2072 6566 6572 656e 6365 2079 6669  ng reference yfi
+00011a50: 6e61 6e63 6520 6461 7461 2066 6169 6c65  nance data faile
+00011a60: 6420 2869 6e74 6572 7661 6c3d 7b73 656c  d (interval={sel
+00011a70: 662e 6973 7472 7d2c 2073 7461 7274 5f64  f.istr}, start_d
+00011a80: 743d 7b73 7461 7274 5f64 747d 2c20 6c61  t={start_dt}, la
+00011a90: 7374 5f64 743d 7b6c 6173 745f 6474 7d29  st_dt={last_dt})
+00011aa0: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
+00011ab0: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
+00011ac0: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
+00011ad0: 2e57 6565 6b3a 0a20 2020 2020 2020 2020  .Week:.         
+00011ae0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+00011af0: 6461 7461 2061 6c69 676e 6564 2074 6f20  data aligned to 
+00011b00: 4d6f 6e64 6179 3a0a 2020 2020 2020 2020  Monday:.        
+00011b10: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+00011b20: 665f 7966 2e69 6e64 6578 5b30 5d2e 7765  f_yf.index[0].we
+00011b30: 656b 6461 7928 2920 3d3d 2030 3a0a 2020  ekday() == 0:.  
+00011b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b50: 2020 6e20 3d20 300a 2020 2020 2020 2020    n = 0.        
+00011b60: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00011b70: 6520 6e20 3c20 333a 0a20 2020 2020 2020  e n < 3:.       
+00011b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b90: 2066 6574 6368 5f73 7461 7274 202d 3d20   fetch_start -= 
+00011ba0: 7469 6d65 6465 6c74 6128 6461 7973 3d32  timedelta(days=2
+00011bb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011bc0: 2020 2020 2020 2020 2020 6466 5f79 6620            df_yf 
+00011bd0: 3d20 7365 6c66 2e64 6174 2e68 6973 746f  = self.dat.histo
+00011be0: 7279 2869 6e74 6572 7661 6c3d 7365 6c66  ry(interval=self
+00011bf0: 2e69 7374 722c 2073 7461 7274 3d66 6574  .istr, start=fet
+00011c00: 6368 5f73 7461 7274 2c20 656e 643d 6665  ch_start, end=fe
+00011c10: 7463 685f 656e 642c 2061 7574 6f5f 6164  tch_end, auto_ad
+00011c20: 6a75 7374 3d46 616c 7365 2c20 7265 7061  just=False, repa
+00011c30: 6972 3d72 6570 6169 7229 0a20 2020 2020  ir=repair).     
+00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c50: 2020 2069 6620 6e6f 7420 2252 6570 6169     if not "Repai
+00011c60: 7265 643f 2220 696e 2064 665f 7966 2e63  red?" in df_yf.c
+00011c70: 6f6c 756d 6e73 3a0a 2020 2020 2020 2020  olumns:.        
+00011c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c90: 2020 2020 6466 5f79 665b 2252 6570 6169      df_yf["Repai
+00011ca0: 7265 643f 225d 203d 2046 616c 7365 0a20  red?"] = False. 
+00011cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011cc0: 2020 2020 2020 206e 202b 3d20 310a 2020         n += 1.  
+00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ce0: 2020 2020 2020 6966 2064 665f 7966 2e69        if df_yf.i
+00011cf0: 6e64 6578 5b30 5d2e 7765 656b 6461 7928  ndex[0].weekday(
+00011d00: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+00011d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d20: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00011d30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00011d40: 206e 6f74 2064 665f 7966 2e69 6e64 6578   not df_yf.index
+00011d50: 5b30 5d2e 7765 656b 6461 7928 2920 3d3d  [0].weekday() ==
+00011d60: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00011d70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00011d80: 6520 4578 6365 7074 696f 6e28 2246 6169  e Exception("Fai
+00011d90: 6c65 6420 746f 2067 6574 204d 6f6e 6461  led to get Monda
+00011da0: 792d 616c 6967 6e65 6420 7765 656b 6c79  y-aligned weekly
+00011db0: 2064 6174 6120 6672 6f6d 2059 4622 290a   data from YF").
+00011dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011dd0: 2020 2020 6466 5f79 6620 3d20 6466 5f79      df_yf = df_y
+00011de0: 662e 6c6f 635b 682e 696e 6465 785b 305d  f.loc[h.index[0]
+00011df0: 3a5d 0a0a 2020 2020 2020 2020 2020 2020  :]..            
+00011e00: 6966 206e 6f74 2073 656c 662e 696e 7465  if not self.inte
+00011e10: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00011e20: 2020 2020 2020 2320 566f 6c75 6d65 206e        # Volume n
+00011e30: 6f74 2073 706c 6974 2d61 646a 7573 7465  ot split-adjuste
+00011e40: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00011e50: 2020 7373 203d 2064 665f 7966 5b22 5374    ss = df_yf["St
+00011e60: 6f63 6b20 5370 6c69 7473 225d 2e63 6f70  ock Splits"].cop
+00011e70: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+00011e80: 2020 2020 7373 5b28 7373 203d 3d20 302e      ss[(ss == 0.
+00011e90: 3029 207c 2073 732e 6973 6e61 2829 5d20  0) | ss.isna()] 
+00011ea0: 3d20 312e 300a 2020 2020 2020 2020 2020  = 1.0.          
+00011eb0: 2020 2020 2020 7373 5f72 6370 203d 2031        ss_rcp = 1
+00011ec0: 2e30 202f 2073 730a 2020 2020 2020 2020  .0 / ss.        
+00011ed0: 2020 2020 2020 2020 6373 6620 3d20 7373          csf = ss
+00011ee0: 5f72 6370 2e73 6f72 745f 696e 6465 7828  _rcp.sort_index(
+00011ef0: 6173 6365 6e64 696e 673d 4661 6c73 6529  ascending=False)
+00011f00: 2e63 756d 7072 6f64 2829 2e73 6f72 745f  .cumprod().sort_
+00011f10: 696e 6465 7828 6173 6365 6e64 696e 673d  index(ascending=
+00011f20: 5472 7565 292e 7368 6966 7428 2d31 2c20  True).shift(-1, 
+00011f30: 6669 6c6c 5f76 616c 7565 3d31 2e30 290a  fill_value=1.0).
+00011f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f50: 6466 5f79 665b 2256 6f6c 756d 6522 5d20  df_yf["Volume"] 
+00011f60: 3d20 6466 5f79 665b 2256 6f6c 756d 6522  = df_yf["Volume"
+00011f70: 5d2e 746f 5f6e 756d 7079 2829 202f 2063  ].to_numpy() / c
+00011f80: 7366 0a0a 2020 2020 2020 2020 2020 2020  sf..            
+00011f90: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
+00011fa0: 2021 3d20 7966 6364 2e49 6e74 6572 7661   != yfcd.Interva
+00011fb0: 6c2e 4461 7973 3120 616e 6420 636f 7272  l.Days1 and corr
+00011fc0: 6563 743a 0a20 2020 2020 2020 2020 2020  ect:.           
+00011fd0: 2020 2020 2023 2043 6f70 7920 6f76 6572       # Copy over
+00011fe0: 2061 6e79 206d 6973 7369 6e67 2064 6976   any missing div
+00011ff0: 6964 656e 6473 0a20 2020 2020 2020 2020  idends.         
+00012000: 2020 2020 2020 2063 203d 2022 4469 7669         c = "Divi
+00012010: 6465 6e64 7322 0a20 2020 2020 2020 2020  dends".         
+00012020: 2020 2020 2020 2068 5f64 6976 7320 3d20         h_divs = 
+00012030: 682e 6c6f 635b 685b 635d 2021 3d20 302e  h.loc[h[c] != 0.
+00012040: 302c 2063 5d2e 636f 7079 2829 2e64 726f  0, c].copy().dro
+00012050: 706e 6128 290a 2020 2020 2020 2020 2020  pna().          
+00012060: 2020 2020 2020 7966 5f64 6976 7320 3d20        yf_divs = 
+00012070: 6466 5f79 662e 6c6f 635b 6466 5f79 665b  df_yf.loc[df_yf[
+00012080: 635d 2021 3d20 302e 302c 2063 5d0a 2020  c] != 0.0, c].  
+00012090: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+000120a0: 735f 6d69 7373 696e 675f 6672 6f6d 5f63  s_missing_from_c
+000120b0: 6163 6865 203d 2079 665f 6469 7673 2e69  ache = yf_divs.i
+000120c0: 6e64 6578 5b7e 7966 5f64 6976 732e 696e  ndex[~yf_divs.in
+000120d0: 6465 782e 6973 696e 2868 5f64 6976 732e  dex.isin(h_divs.
+000120e0: 696e 6465 7829 5d0a 2020 2020 2020 2020  index)].        
+000120f0: 2020 2020 2020 2020 6474 735f 6d69 7373          dts_miss
+00012100: 696e 675f 6672 6f6d 5f63 6163 6865 203d  ing_from_cache =
+00012110: 205b 6474 2066 6f72 2064 7420 696e 2064   [dt for dt in d
+00012120: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
+00012130: 6361 6368 6520 6966 2064 7420 696e 2068  cache if dt in h
+00012140: 2e69 6e64 6578 5d0a 2020 2020 2020 2020  .index].        
+00012150: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
+00012160: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
+00012170: 6361 6368 6529 203e 2030 3a0a 2020 2020  cache) > 0:.    
+00012180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012190: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
 000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121b0: 2020 2066 6f72 2064 7420 696e 2064 7473     for dt in dts
-000121c0: 5f6d 6973 7369 6e67 5f66 726f 6d5f 6361  _missing_from_ca
-000121d0: 6368 653a 0a20 2020 2020 2020 2020 2020  che:.           
-000121e0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
-000121f0: 6f72 7265 6374 2068 6572 650a 2020 2020  orrect here.    
+000121b0: 2020 6d73 6720 3d20 6622 434f 5252 4543    msg = f"CORREC
+000121c0: 5449 4e47 3a20 4361 6368 6520 6d69 7373  TING: Cache miss
+000121d0: 696e 6720 7468 6573 6520 6469 7669 6465  ing these divide
+000121e0: 6e64 733a 207b 6474 735f 6d69 7373 696e  nds: {dts_missin
+000121f0: 675f 6672 6f6d 5f63 6163 6865 7d22 0a20  g_from_cache}". 
 00012200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012210: 2020 2020 682e 6c6f 635b 6474 2c20 635d      h.loc[dt, c]
-00012220: 203d 2079 665f 6469 7673 2e6c 6f63 5b64   = yf_divs.loc[d
-00012230: 745d 0a20 2020 2020 2020 2020 2020 2020  t].             
-00012240: 2020 2020 2020 2020 2020 2068 5f6e 6577             h_new
-00012250: 2e6c 6f63 5b64 742c 2063 5d20 3d20 7966  .loc[dt, c] = yf
-00012260: 5f64 6976 732e 6c6f 635b 6474 5d0a 2020  _divs.loc[dt].  
+00012210: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+00012220: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+00012230: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+00012240: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+00012250: 7428 6622 7b73 656c 662e 7469 636b 6572  t(f"{self.ticker
+00012260: 7d3a 2022 202b 206d 7367 290a 2020 2020  }: " + msg).    
 00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012280: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
-00012290: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
-000122a0: 2020 2020 2020 2020 2023 2043 6f70 7920           # Copy 
-000122b0: 6f76 6572 2061 6e79 206d 6973 7369 6e67  over any missing
-000122c0: 2073 746f 636b 2073 706c 6974 730a 2020   stock splits.  
-000122d0: 2020 2020 2020 2020 2020 2020 2020 6320                c 
-000122e0: 3d20 2253 746f 636b 2053 706c 6974 7322  = "Stock Splits"
-000122f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012300: 2068 5f73 7320 3d20 682e 6c6f 635b 685b   h_ss = h.loc[h[
-00012310: 635d 2021 3d20 302e 302c 2063 5d2e 636f  c] != 0.0, c].co
-00012320: 7079 2829 2e64 726f 706e 6128 290a 2020  py().dropna().  
-00012330: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-00012340: 5f73 7320 3d20 6466 5f79 662e 6c6f 635b  _ss = df_yf.loc[
-00012350: 6466 5f79 665b 635d 2021 3d20 302e 302c  df_yf[c] != 0.0,
-00012360: 2063 5d0a 2020 2020 2020 2020 2020 2020   c].            
-00012370: 2020 2020 6474 735f 6d69 7373 696e 675f      dts_missing_
-00012380: 6672 6f6d 5f63 6163 6865 203d 2079 665f  from_cache = yf_
-00012390: 7373 2e69 6e64 6578 5b7e 7966 5f73 732e  ss.index[~yf_ss.
-000123a0: 696e 6465 782e 6973 696e 2868 5f73 732e  index.isin(h_ss.
-000123b0: 696e 6465 7829 5d0a 2020 2020 2020 2020  index)].        
-000123c0: 2020 2020 2020 2020 6474 735f 6d69 7373          dts_miss
-000123d0: 696e 675f 6672 6f6d 5f63 6163 6865 203d  ing_from_cache =
-000123e0: 205b 6474 2066 6f72 2064 7420 696e 2064   [dt for dt in d
-000123f0: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
-00012400: 6361 6368 6520 6966 2064 7420 696e 2068  cache if dt in h
-00012410: 2e69 6e64 6578 5d0a 2020 2020 2020 2020  .index].        
-00012420: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
-00012430: 7473 5f6d 6973 7369 6e67 5f66 726f 6d5f  ts_missing_from_
-00012440: 6361 6368 6529 203e 2030 3a0a 2020 2020  cache) > 0:.    
-00012450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012460: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-00012470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012480: 2020 6d73 6720 3d20 6622 434f 5252 4543    msg = f"CORREC
-00012490: 5449 4e47 3a20 4361 6368 6520 6d69 7373  TING: Cache miss
-000124a0: 696e 6720 7468 6573 6520 7374 6f63 6b20  ing these stock 
-000124b0: 7370 6c69 7473 3a20 7b64 7473 5f6d 6973  splits: {dts_mis
-000124c0: 7369 6e67 5f66 726f 6d5f 6361 6368 657d  sing_from_cache}
-000124d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000124e0: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-000124f0: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
-00012500: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-00012510: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
-00012520: 7269 6e74 2866 227b 7365 6c66 2e74 6963  rint(f"{self.tic
-00012530: 6b65 727d 3a20 2220 2b20 6d73 6729 0a20  ker}: " + msg). 
-00012540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012550: 2020 2066 6f72 2064 7420 696e 2064 7473     for dt in dts
-00012560: 5f6d 6973 7369 6e67 5f66 726f 6d5f 6361  _missing_from_ca
-00012570: 6368 653a 0a20 2020 2020 2020 2020 2020  che:.           
-00012580: 2020 2020 2020 2020 2020 2020 2023 2043               # C
-00012590: 6f72 7265 6374 2068 6572 650a 2020 2020  orrect here.    
+00012280: 666f 7220 6474 2069 6e20 6474 735f 6d69  for dt in dts_mi
+00012290: 7373 696e 675f 6672 6f6d 5f63 6163 6865  ssing_from_cache
+000122a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000122b0: 2020 2020 2020 2020 2020 2320 436f 7272            # Corr
+000122c0: 6563 7420 6865 7265 0a20 2020 2020 2020  ect here.       
+000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122e0: 2068 2e6c 6f63 5b64 742c 2063 5d20 3d20   h.loc[dt, c] = 
+000122f0: 7966 5f64 6976 732e 6c6f 635b 6474 5d0a  yf_divs.loc[dt].
+00012300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012310: 2020 2020 2020 2020 685f 6e65 772e 6c6f          h_new.lo
+00012320: 635b 6474 2c20 635d 203d 2079 665f 6469  c[dt, c] = yf_di
+00012330: 7673 2e6c 6f63 5b64 745d 0a20 2020 2020  vs.loc[dt].     
+00012340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012350: 2020 2068 5f6d 6f64 6966 6965 6420 3d20     h_modified = 
+00012360: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
+00012370: 2020 2020 2020 2320 436f 7079 206f 7665        # Copy ove
+00012380: 7220 616e 7920 6d69 7373 696e 6720 7374  r any missing st
+00012390: 6f63 6b20 7370 6c69 7473 0a20 2020 2020  ock splits.     
+000123a0: 2020 2020 2020 2020 2020 2063 203d 2022             c = "
+000123b0: 5374 6f63 6b20 5370 6c69 7473 220a 2020  Stock Splits".  
+000123c0: 2020 2020 2020 2020 2020 2020 2020 685f                h_
+000123d0: 7373 203d 2068 2e6c 6f63 5b68 5b63 5d20  ss = h.loc[h[c] 
+000123e0: 213d 2030 2e30 2c20 635d 2e63 6f70 7928  != 0.0, c].copy(
+000123f0: 292e 6472 6f70 6e61 2829 0a20 2020 2020  ).dropna().     
+00012400: 2020 2020 2020 2020 2020 2079 665f 7373             yf_ss
+00012410: 203d 2064 665f 7966 2e6c 6f63 5b64 665f   = df_yf.loc[df_
+00012420: 7966 5b63 5d20 213d 2030 2e30 2c20 635d  yf[c] != 0.0, c]
+00012430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012440: 2064 7473 5f6d 6973 7369 6e67 5f66 726f   dts_missing_fro
+00012450: 6d5f 6361 6368 6520 3d20 7966 5f73 732e  m_cache = yf_ss.
+00012460: 696e 6465 785b 7e79 665f 7373 2e69 6e64  index[~yf_ss.ind
+00012470: 6578 2e69 7369 6e28 685f 7373 2e69 6e64  ex.isin(h_ss.ind
+00012480: 6578 295d 0a20 2020 2020 2020 2020 2020  ex)].           
+00012490: 2020 2020 2064 7473 5f6d 6973 7369 6e67       dts_missing
+000124a0: 5f66 726f 6d5f 6361 6368 6520 3d20 5b64  _from_cache = [d
+000124b0: 7420 666f 7220 6474 2069 6e20 6474 735f  t for dt in dts_
+000124c0: 6d69 7373 696e 675f 6672 6f6d 5f63 6163  missing_from_cac
+000124d0: 6865 2069 6620 6474 2069 6e20 682e 696e  he if dt in h.in
+000124e0: 6465 785d 0a20 2020 2020 2020 2020 2020  dex].           
+000124f0: 2020 2020 2069 6620 6c65 6e28 6474 735f       if len(dts_
+00012500: 6d69 7373 696e 675f 6672 6f6d 5f63 6163  missing_from_cac
+00012510: 6865 2920 3e20 303a 0a20 2020 2020 2020  he) > 0:.       
+00012520: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00012530: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
+00012540: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00012550: 7367 203d 2066 2243 4f52 5245 4354 494e  sg = f"CORRECTIN
+00012560: 473a 2043 6163 6865 206d 6973 7369 6e67  G: Cache missing
+00012570: 2074 6865 7365 2073 746f 636b 2073 706c   these stock spl
+00012580: 6974 733a 207b 6474 735f 6d69 7373 696e  its: {dts_missin
+00012590: 675f 6672 6f6d 5f63 6163 6865 7d22 0a20  g_from_cache}". 
 000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125b0: 2020 2020 682e 6c6f 635b 6474 2c20 635d      h.loc[dt, c]
-000125c0: 203d 2079 665f 7373 2e6c 6f63 5b64 745d   = yf_ss.loc[dt]
-000125d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000125e0: 2020 2020 2020 2020 2068 5f6e 6577 2e6c           h_new.l
-000125f0: 6f63 5b64 742c 2063 5d20 3d20 7966 5f73  oc[dt, c] = yf_s
-00012600: 732e 6c6f 635b 6474 5d0a 2020 2020 2020  s.loc[dt].      
+000125b0: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+000125c0: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
+000125d0: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+000125e0: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
+000125f0: 7428 6622 7b73 656c 662e 7469 636b 6572  t(f"{self.ticker
+00012600: 7d3a 2022 202b 206d 7367 290a 2020 2020  }: " + msg).    
 00012610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012620: 2020 685f 6d6f 6469 6669 6564 203d 2054    h_modified = T
-00012630: 7275 650a 0a20 2020 2020 2020 2020 2020  rue..           
-00012640: 2066 5f64 6966 665f 616c 6c20 3d20 665f   f_diff_all = f_
-00012650: 6469 6666 5f61 6c6c 207c 2079 6663 752e  diff_all | yfcu.
-00012660: 5665 7269 6679 5072 6963 6573 4466 2868  VerifyPricesDf(h
-00012670: 2c20 6466 5f79 662c 2073 656c 662e 696e  , df_yf, self.in
-00012680: 7465 7276 616c 2c20 7274 6f6c 3d72 746f  terval, rtol=rto
-00012690: 6c2c 2076 6f6c 5f72 746f 6c3d 766f 6c5f  l, vol_rtol=vol_
-000126a0: 7274 6f6c 2c20 7175 6965 743d 7175 6965  rtol, quiet=quie
-000126b0: 742c 2064 6562 7567 3d64 6562 7567 290a  t, debug=debug).
-000126c0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000126d0: 665f 6469 6666 5f61 6c6c 2e61 6e79 2829  f_diff_all.any()
-000126e0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000126f0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-00012700: 2020 2020 2020 2020 6d73 6720 3d20 224e          msg = "N
-00012710: 6f20 6469 6666 6572 656e 6365 7322 0a20  o differences". 
-00012720: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00012730: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-00012740: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-00012750: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-00012760: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
-00012770: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
-00012780: 7367 290a 0a20 2020 2020 2020 2020 2020  sg)..           
-00012790: 2069 6620 685f 6d6f 6469 6669 6564 3a0a   if h_modified:.
-000127a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127b0: 2320 7966 636d 2e53 746f 7265 4361 6368  # yfcm.StoreCach
-000127c0: 6544 6174 756d 2873 656c 662e 7469 636b  eDatum(self.tick
-000127d0: 6572 2c20 7365 6c66 2e63 6163 6865 5f6b  er, self.cache_k
-000127e0: 6579 2c20 6829 0a20 2020 2020 2020 2020  ey, h).         
-000127f0: 2020 2020 2020 2079 6663 6d2e 5374 6f72         yfcm.Stor
-00012800: 6543 6163 6865 4461 7475 6d28 7365 6c66  eCacheDatum(self
-00012810: 2e74 6963 6b65 722c 2073 656c 662e 6361  .ticker, self.ca
-00012820: 6368 655f 6b65 792c 2068 5f6e 6577 290a  che_key, h_new).
-00012830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012840: 7365 6c66 2e68 203d 2073 656c 662e 5f67  self.h = self._g
-00012850: 6574 4361 6368 6564 5072 6963 6573 2829  etCachedPrices()
-00012860: 0a0a 2020 2020 2020 2020 2020 2020 7966  ..            yf
-00012870: 636c 2e54 7261 6365 4578 6974 2866 2250  cl.TraceExit(f"P
-00012880: 4d3a 3a5f 7665 7269 6679 4361 6368 6564  M::_verifyCached
-00012890: 5072 6963 6573 2d7b 7365 6c66 2e69 7374  Prices-{self.ist
-000128a0: 727d 2829 2072 6574 7572 6e69 6e67 2054  r}() returning T
-000128b0: 7275 6522 290a 2020 2020 2020 2020 2020  rue").          
-000128c0: 2020 7265 7475 726e 2054 7275 650a 0a20    return True.. 
-000128d0: 2020 2020 2020 2068 203d 2068 5f6e 6577         h = h_new
-000128e0: 0a20 2020 2020 2020 2069 6620 636f 7272  .        if corr
-000128f0: 6563 743a 0a20 2020 2020 2020 2020 2020  ect:.           
-00012900: 2064 726f 705f 6474 7320 3d20 665f 6469   drop_dts = f_di
-00012910: 6666 5f61 6c6c 2e69 6e64 6578 5b66 5f64  ff_all.index[f_d
-00012920: 6966 665f 616c 6c5d 0a20 2020 2020 2020  iff_all].       
-00012930: 2020 2020 2064 726f 705f 6474 735f 6167       drop_dts_ag
-00012940: 6573 203d 2064 745f 6e6f 7720 2d20 6472  es = dt_now - dr
-00012950: 6f70 5f64 7473 0a20 2020 2020 2020 2020  op_dts.         
-00012960: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
-00012970: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-00012980: 7276 616c 2e57 6565 6b3a 0a20 2020 2020  rval.Week:.     
-00012990: 2020 2020 2020 2020 2020 2066 203d 2064             f = d
-000129a0: 726f 705f 6474 735f 6167 6573 203e 2074  rop_dts_ages > t
-000129b0: 696d 6564 656c 7461 2864 6179 733d 3829  imedelta(days=8)
-000129c0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000129d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000129e0: 2020 2066 203d 2064 726f 705f 6474 735f     f = drop_dts_
-000129f0: 6167 6573 203e 2074 696d 6564 656c 7461  ages > timedelta
-00012a00: 2864 6179 733d 3429 2020 2320 616c 6c6f  (days=4)  # allo
-00012a10: 7720 666f 7220 7765 656b 656e 640a 2020  w for weekend.  
-00012a20: 2020 2020 2020 2020 2020 6472 6f70 5f64            drop_d
-00012a30: 7473 5f6e 6f74 5f72 6563 656e 7420 3d20  ts_not_recent = 
-00012a40: 6472 6f70 5f64 7473 5b66 5d0a 2020 2020  drop_dts[f].    
-00012a50: 2020 2020 2020 2020 6472 6f70 5f64 7473          drop_dts
-00012a60: 5f61 6765 7320 3d20 6472 6f70 5f64 7473  _ages = drop_dts
-00012a70: 5f61 6765 735b 665d 0a20 2020 2020 2020  _ages[f].       
-00012a80: 2020 2020 206d 7367 203d 2066 227b 7365       msg = f"{se
-00012a90: 6c66 2e74 6963 6b65 727d 3a20 7b73 656c  lf.ticker}: {sel
-00012aa0: 662e 6973 7472 7d2d 7072 6963 6573 2070  f.istr}-prices p
-00012ab0: 726f 626c 656d 7322 0a20 2020 2020 2020  roblems".       
-00012ac0: 2020 2020 2069 6620 7365 6c66 2e63 6f6e       if self.con
-00012ad0: 7469 6775 6f75 733a 0a20 2020 2020 2020  tiguous:.       
-00012ae0: 2020 2020 2020 2020 2023 2044 6169 6c79           # Daily
-00012af0: 206d 7573 7420 616c 7761 7973 2062 6520   must always be 
-00012b00: 636f 6e74 6967 756f 7573 2c20 736f 2064  contiguous, so d
-00012b10: 726f 7020 6576 6572 7974 6869 6e67 2066  rop everything f
-00012b20: 726f 6d20 6669 7273 7420 6469 6666 0a20  rom first diff. 
-00012b30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012b40: 6620 6c65 6e28 6472 6f70 5f64 7473 5f6e  f len(drop_dts_n
-00012b50: 6f74 5f72 6563 656e 7429 203e 2030 3a0a  ot_recent) > 0:.
-00012b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b70: 2020 2020 6966 206c 656e 2864 726f 705f      if len(drop_
-00012b80: 6474 735f 6e6f 745f 7265 6365 6e74 2920  dts_not_recent) 
-00012b90: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-00012ba0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00012bb0: 6720 2b3d 2066 223a 2064 726f 7070 696e  g += f": droppin
-00012bc0: 6720 7b64 726f 705f 6474 735f 6e6f 745f  g {drop_dts_not_
-00012bd0: 7265 6365 6e74 5b30 5d2e 6461 7465 2829  recent[0].date()
-00012be0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00012bf0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c10: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00012c20: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+00012620: 666f 7220 6474 2069 6e20 6474 735f 6d69  for dt in dts_mi
+00012630: 7373 696e 675f 6672 6f6d 5f63 6163 6865  ssing_from_cache
+00012640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012650: 2020 2020 2020 2020 2020 2320 436f 7272            # Corr
+00012660: 6563 7420 6865 7265 0a20 2020 2020 2020  ect here.       
+00012670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012680: 2068 2e6c 6f63 5b64 742c 2063 5d20 3d20   h.loc[dt, c] = 
+00012690: 7966 5f73 732e 6c6f 635b 6474 5d0a 2020  yf_ss.loc[dt].  
+000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126b0: 2020 2020 2020 685f 6e65 772e 6c6f 635b        h_new.loc[
+000126c0: 6474 2c20 635d 203d 2079 665f 7373 2e6c  dt, c] = yf_ss.l
+000126d0: 6f63 5b64 745d 0a20 2020 2020 2020 2020  oc[dt].         
+000126e0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000126f0: 5f6d 6f64 6966 6965 6420 3d20 5472 7565  _modified = True
+00012700: 0a0a 2020 2020 2020 2020 2020 2020 665f  ..            f_
+00012710: 6469 6666 5f61 6c6c 203d 2066 5f64 6966  diff_all = f_dif
+00012720: 665f 616c 6c20 7c20 7966 6375 2e56 6572  f_all | yfcu.Ver
+00012730: 6966 7950 7269 6365 7344 6628 682c 2064  ifyPricesDf(h, d
+00012740: 665f 7966 2c20 7365 6c66 2e69 6e74 6572  f_yf, self.inter
+00012750: 7661 6c2c 2072 746f 6c3d 7274 6f6c 2c20  val, rtol=rtol, 
+00012760: 766f 6c5f 7274 6f6c 3d76 6f6c 5f72 746f  vol_rtol=vol_rto
+00012770: 6c2c 2071 7569 6574 3d71 7569 6574 2c20  l, quiet=quiet, 
+00012780: 6465 6275 673d 6465 6275 6729 0a0a 2020  debug=debug)..  
+00012790: 2020 2020 2020 6966 206e 6f74 2066 5f64        if not f_d
+000127a0: 6966 665f 616c 6c2e 616e 7928 293a 0a20  iff_all.any():. 
+000127b0: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+000127c0: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+000127d0: 2020 2020 206d 7367 203d 2022 4e6f 2064       msg = "No d
+000127e0: 6966 6665 7265 6e63 6573 220a 2020 2020  ifferences".    
+000127f0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+00012800: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
+00012810: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
+00012820: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
+00012830: 2070 7269 6e74 2866 227b 7365 6c66 2e74   print(f"{self.t
+00012840: 6963 6b65 727d 3a20 2220 2b20 6d73 6729  icker}: " + msg)
+00012850: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00012860: 2068 5f6d 6f64 6966 6965 643a 0a20 2020   h_modified:.   
+00012870: 2020 2020 2020 2020 2020 2020 2023 2079               # y
+00012880: 6663 6d2e 5374 6f72 6543 6163 6865 4461  fcm.StoreCacheDa
+00012890: 7475 6d28 7365 6c66 2e74 6963 6b65 722c  tum(self.ticker,
+000128a0: 2073 656c 662e 6361 6368 655f 6b65 792c   self.cache_key,
+000128b0: 2068 290a 2020 2020 2020 2020 2020 2020   h).            
+000128c0: 2020 2020 7966 636d 2e53 746f 7265 4361      yfcm.StoreCa
+000128d0: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
+000128e0: 636b 6572 2c20 7365 6c66 2e63 6163 6865  cker, self.cache
+000128f0: 5f6b 6579 2c20 685f 6e65 7729 0a20 2020  _key, h_new).   
+00012900: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00012910: 662e 6820 3d20 7365 6c66 2e5f 6765 7443  f.h = self._getC
+00012920: 6163 6865 6450 7269 6365 7328 290a 0a20  achedPrices().. 
+00012930: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+00012940: 5472 6163 6545 7869 7428 6622 504d 3a3a  TraceExit(f"PM::
+00012950: 5f76 6572 6966 7943 6163 6865 6450 7269  _verifyCachedPri
+00012960: 6365 732d 7b73 656c 662e 6973 7472 7d28  ces-{self.istr}(
+00012970: 2920 7265 7475 726e 696e 6720 5472 7565  ) returning True
+00012980: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+00012990: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+000129a0: 2020 2020 6820 3d20 685f 6e65 770a 2020      h = h_new.  
+000129b0: 2020 2020 2020 6966 2063 6f72 7265 6374        if correct
+000129c0: 3a0a 2020 2020 2020 2020 2020 2020 6472  :.            dr
+000129d0: 6f70 5f64 7473 203d 2066 5f64 6966 665f  op_dts = f_diff_
+000129e0: 616c 6c2e 696e 6465 785b 665f 6469 6666  all.index[f_diff
+000129f0: 5f61 6c6c 5d0a 2020 2020 2020 2020 2020  _all].          
+00012a00: 2020 6472 6f70 5f64 7473 5f61 6765 7320    drop_dts_ages 
+00012a10: 3d20 6474 5f6e 6f77 202d 2064 726f 705f  = dt_now - drop_
+00012a20: 6474 730a 2020 2020 2020 2020 2020 2020  dts.            
+00012a30: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
+00012a40: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+00012a50: 6c2e 5765 656b 3a0a 2020 2020 2020 2020  l.Week:.        
+00012a60: 2020 2020 2020 2020 6620 3d20 6472 6f70          f = drop
+00012a70: 5f64 7473 5f61 6765 7320 3e20 7469 6d65  _dts_ages > time
+00012a80: 6465 6c74 6128 6461 7973 3d38 290a 2020  delta(days=8).  
+00012a90: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00012aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ab0: 6620 3d20 6472 6f70 5f64 7473 5f61 6765  f = drop_dts_age
+00012ac0: 7320 3e20 7469 6d65 6465 6c74 6128 6461  s > timedelta(da
+00012ad0: 7973 3d34 2920 2023 2061 6c6c 6f77 2066  ys=4)  # allow f
+00012ae0: 6f72 2077 6565 6b65 6e64 0a20 2020 2020  or weekend.     
+00012af0: 2020 2020 2020 2064 726f 705f 6474 735f         drop_dts_
+00012b00: 6e6f 745f 7265 6365 6e74 203d 2064 726f  not_recent = dro
+00012b10: 705f 6474 735b 665d 0a20 2020 2020 2020  p_dts[f].       
+00012b20: 2020 2020 2064 726f 705f 6474 735f 6167       drop_dts_ag
+00012b30: 6573 203d 2064 726f 705f 6474 735f 6167  es = drop_dts_ag
+00012b40: 6573 5b66 5d0a 2020 2020 2020 2020 2020  es[f].          
+00012b50: 2020 6d73 6720 3d20 6622 7b73 656c 662e    msg = f"{self.
+00012b60: 7469 636b 6572 7d3a 207b 7365 6c66 2e69  ticker}: {self.i
+00012b70: 7374 727d 2d70 7269 6365 7320 7072 6f62  str}-prices prob
+00012b80: 6c65 6d73 220a 2020 2020 2020 2020 2020  lems".          
+00012b90: 2020 6966 2073 656c 662e 636f 6e74 6967    if self.contig
+00012ba0: 756f 7573 3a0a 2020 2020 2020 2020 2020  uous:.          
+00012bb0: 2020 2020 2020 2320 4461 696c 7920 6d75        # Daily mu
+00012bc0: 7374 2061 6c77 6179 7320 6265 2063 6f6e  st always be con
+00012bd0: 7469 6775 6f75 732c 2073 6f20 6472 6f70  tiguous, so drop
+00012be0: 2065 7665 7279 7468 696e 6720 6672 6f6d   everything from
+00012bf0: 2066 6972 7374 2064 6966 660a 2020 2020   first diff.    
+00012c00: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00012c10: 656e 2864 726f 705f 6474 735f 6e6f 745f  en(drop_dts_not_
+00012c20: 7265 6365 6e74 2920 3e20 303a 0a20 2020  recent) > 0:.   
 00012c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c40: 2020 206d 7367 202b 3d20 6622 3a20 6472     msg += f": dr
-00012c50: 6f70 7069 6e67 2061 6c6c 2072 6f77 7320  opping all rows 
-00012c60: 6672 6f6d 207b 6472 6f70 5f64 7473 5f6e  from {drop_dts_n
-00012c70: 6f74 5f72 6563 656e 745b 305d 2e64 6174  ot_recent[0].dat
-00012c80: 6528 297d 220a 2020 2020 2020 2020 2020  e()}".          
-00012c90: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00012ca0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00012c40: 2069 6620 6c65 6e28 6472 6f70 5f64 7473   if len(drop_dts
+00012c50: 5f6e 6f74 5f72 6563 656e 7429 203d 3d20  _not_recent) == 
+00012c60: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00012c70: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
+00012c80: 3d20 6622 3a20 6472 6f70 7069 6e67 207b  = f": dropping {
+00012c90: 6472 6f70 5f64 7473 5f6e 6f74 5f72 6563  drop_dts_not_rec
+00012ca0: 656e 745b 305d 2e64 6174 6528 297d 220a  ent[0].date()}".
 00012cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012cc0: 6d73 6720 2b3d 2066 223a 2064 726f 7070  msg += f": dropp
-00012cd0: 696e 6720 616c 6c20 726f 7773 2066 726f  ing all rows fro
-00012ce0: 6d20 7b64 726f 705f 6474 735f 6e6f 745f  m {drop_dts_not_
-00012cf0: 7265 6365 6e74 5b30 5d7d 220a 2020 2020  recent[0]}".    
+00012cc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ce0: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
+00012cf0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
 00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d10: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-00012d20: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-00012d30: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-00012d40: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
-00012d50: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
-00012d60: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00012d70: 2020 2020 2068 203d 2068 5b68 2e69 6e64       h = h[h.ind
-00012d80: 6578 203c 2064 726f 705f 6474 735b 305d  ex < drop_dts[0]
-00012d90: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00012da0: 2020 685f 6d6f 6469 6669 6564 203d 2054    h_modified = T
-00012db0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00012dc0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00012dd0: 2020 2020 2020 6e20 3d20 7365 6c66 2e68        n = self.h
-00012de0: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
-00012df0: 2020 2020 2020 2020 2020 6e5f 6472 6f70            n_drop
-00012e00: 203d 206e 702e 7375 6d28 665f 6469 6666   = np.sum(f_diff
-00012e10: 5f61 6c6c 290a 2020 2020 2020 2020 2020  _all).          
-00012e20: 2020 2020 2020 6966 206c 656e 2864 726f        if len(dro
-00012e30: 705f 6474 735f 6e6f 745f 7265 6365 6e74  p_dts_not_recent
-00012e40: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
-00012e50: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00012e60: 6e28 6472 6f70 5f64 7473 5f6e 6f74 5f72  n(drop_dts_not_r
-00012e70: 6563 656e 7429 203c 2031 303a 0a20 2020  ecent) < 10:.   
-00012e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e90: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00012ea0: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ec0: 2020 206d 7367 202b 3d20 6622 3a20 6472     msg += f": dr
-00012ed0: 6f70 7069 6e67 207b 6472 6f70 5f64 7473  opping {drop_dts
-00012ee0: 5f6e 6f74 5f72 6563 656e 742e 6461 7465  _not_recent.date
-00012ef0: 2e61 7374 7970 6528 7374 7229 7d22 0a20  .astype(str)}". 
-00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f30: 2020 2020 2020 2020 206d 7367 202b 3d20           msg += 
-00012f40: 6622 3a20 6472 6f70 7069 6e67 207b 6472  f": dropping {dr
-00012f50: 6f70 5f64 7473 5f6e 6f74 5f72 6563 656e  op_dts_not_recen
-00012f60: 742e 747a 5f6c 6f63 616c 697a 6528 4e6f  t.tz_localize(No
-00012f70: 6e65 297d 220a 2020 2020 2020 2020 2020  ne)}".          
-00012f80: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00012f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fa0: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
-00012fb0: 223a 2064 726f 7070 696e 6720 7b6e 5f64  ": dropping {n_d
-00012fc0: 726f 707d 2f7b 6e7d 2072 6f77 7322 0a20  rop}/{n} rows". 
+00012d10: 6d73 6720 2b3d 2066 223a 2064 726f 7070  msg += f": dropp
+00012d20: 696e 6720 616c 6c20 726f 7773 2066 726f  ing all rows fro
+00012d30: 6d20 7b64 726f 705f 6474 735f 6e6f 745f  m {drop_dts_not_
+00012d40: 7265 6365 6e74 5b30 5d2e 6461 7465 2829  recent[0].date()
+00012d50: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00012d60: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00012d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012d80: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00012d90: 202b 3d20 6622 3a20 6472 6f70 7069 6e67   += f": dropping
+00012da0: 2061 6c6c 2072 6f77 7320 6672 6f6d 207b   all rows from {
+00012db0: 6472 6f70 5f64 7473 5f6e 6f74 5f72 6563  drop_dts_not_rec
+00012dc0: 656e 745b 305d 7d22 0a20 2020 2020 2020  ent[0]}".       
+00012dd0: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00012de0: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+00012df0: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+00012e00: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+00012e10: 6520 7072 696e 7428 6622 7b73 656c 662e  e print(f"{self.
+00012e20: 7469 636b 6572 7d3a 2022 202b 206d 7367  ticker}: " + msg
+00012e30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012e40: 2020 6820 3d20 685b 682e 696e 6465 7820    h = h[h.index 
+00012e50: 3c20 6472 6f70 5f64 7473 5b30 5d5d 0a20  < drop_dts[0]]. 
+00012e60: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00012e70: 5f6d 6f64 6966 6965 6420 3d20 5472 7565  _modified = True
+00012e80: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00012e90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00012ea0: 2020 206e 203d 2073 656c 662e 682e 7368     n = self.h.sh
+00012eb0: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
+00012ec0: 2020 2020 2020 206e 5f64 726f 7020 3d20         n_drop = 
+00012ed0: 6e70 2e73 756d 2866 5f64 6966 665f 616c  np.sum(f_diff_al
+00012ee0: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
+00012ef0: 2020 2069 6620 6c65 6e28 6472 6f70 5f64     if len(drop_d
+00012f00: 7473 5f6e 6f74 5f72 6563 656e 7429 203e  ts_not_recent) >
+00012f10: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00012f20: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
+00012f30: 726f 705f 6474 735f 6e6f 745f 7265 6365  rop_dts_not_rece
+00012f40: 6e74 2920 3c20 3130 3a0a 2020 2020 2020  nt) < 10:.      
+00012f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f60: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
+00012f70: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+00012f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f90: 6d73 6720 2b3d 2066 223a 2064 726f 7070  msg += f": dropp
+00012fa0: 696e 6720 7b64 726f 705f 6474 735f 6e6f  ing {drop_dts_no
+00012fb0: 745f 7265 6365 6e74 2e64 6174 652e 6173  t_recent.date.as
+00012fc0: 7479 7065 2873 7472 297d 220a 2020 2020  type(str)}".    
 00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
-00012ff0: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
-00013000: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-00013010: 2829 2065 6c73 6520 7072 696e 7428 6622  () else print(f"
-00013020: 7b73 656c 662e 7469 636b 6572 7d3a 2022  {self.ticker}: "
-00013030: 202b 206d 7367 290a 2020 2020 2020 2020   + msg).        
-00013040: 2020 2020 2020 2020 6832 203d 2068 2e64          h2 = h.d
-00013050: 726f 7028 6472 6f70 5f64 7473 290a 2020  rop(drop_dts).  
-00013060: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00013070: 2068 2e73 6861 7065 5b30 5d2d 6832 2e73   h.shape[0]-h2.s
-00013080: 6861 7065 5b30 5d20 213d 206e 5f64 726f  hape[0] != n_dro
-00013090: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-000130a0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-000130b0: 6570 7469 6f6e 2822 6865 7265 2229 0a20  eption("here"). 
-000130c0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-000130d0: 203d 2068 320a 2020 2020 2020 2020 2020   = h2.          
-000130e0: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
-000130f0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-00013100: 2020 2020 6966 2068 2e65 6d70 7479 3a0a      if h.empty:.
-00013110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013120: 6820 3d20 4e6f 6e65 0a20 2020 2020 2020  h = None.       
-00013130: 2020 2020 2020 2020 2068 5f6d 6f64 6966           h_modif
-00013140: 6965 6420 3d20 5472 7565 0a0a 2020 2020  ied = True..    
-00013150: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00013160: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
-00013170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013180: 6e20 3d20 6e70 2e73 756d 2866 5f64 6966  n = np.sum(f_dif
-00013190: 665f 616c 6c29 0a20 2020 2020 2020 2020  f_all).         
-000131a0: 2020 2020 2020 2069 6620 6e20 3c20 353a         if n < 5:
-000131b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000131c0: 2020 2020 206d 7367 203d 2066 2264 6966       msg = f"dif
-000131d0: 6665 7265 6e63 6573 2066 6f75 6e64 2062  ferences found b
-000131e0: 7574 206e 6f74 2063 6f72 7265 6374 696e  ut not correctin
-000131f0: 673a 207b 665f 6469 6666 5f61 6c6c 2e69  g: {f_diff_all.i
-00013200: 6e64 6578 5b66 5f64 6966 665f 616c 6c5d  ndex[f_diff_all]
-00013210: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
-00013220: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00013230: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00013240: 203d 2066 227b 6e70 2e73 756d 2866 5f64   = f"{np.sum(f_d
-00013250: 6966 665f 616c 6c29 7d20 6469 6666 6572  iff_all)} differ
-00013260: 656e 6365 7320 666f 756e 6420 6275 7420  ences found but 
-00013270: 6e6f 7420 636f 7272 6563 7469 6e67 220a  not correcting".
+00012fe0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013000: 2020 2020 2020 6d73 6720 2b3d 2066 223a        msg += f":
+00013010: 2064 726f 7070 696e 6720 7b64 726f 705f   dropping {drop_
+00013020: 6474 735f 6e6f 745f 7265 6365 6e74 2e74  dts_not_recent.t
+00013030: 7a5f 6c6f 6361 6c69 7a65 284e 6f6e 6529  z_localize(None)
+00013040: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00013050: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013070: 2020 2020 206d 7367 202b 3d20 6622 3a20       msg += f": 
+00013080: 6472 6f70 7069 6e67 207b 6e5f 6472 6f70  dropping {n_drop
+00013090: 7d2f 7b6e 7d20 726f 7773 220a 2020 2020  }/{n} rows".    
+000130a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000130b0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+000130c0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
+000130d0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
+000130e0: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
+000130f0: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
+00013100: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+00013110: 2020 2020 2068 3220 3d20 682e 6472 6f70       h2 = h.drop
+00013120: 2864 726f 705f 6474 7329 0a20 2020 2020  (drop_dts).     
+00013130: 2020 2020 2020 2020 2020 2069 6620 682e             if h.
+00013140: 7368 6170 655b 305d 2d68 322e 7368 6170  shape[0]-h2.shap
+00013150: 655b 305d 2021 3d20 6e5f 6472 6f70 3a0a  e[0] != n_drop:.
+00013160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013170: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00013180: 696f 6e28 2268 6572 6522 290a 2020 2020  ion("here").    
+00013190: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
+000131a0: 6832 0a20 2020 2020 2020 2020 2020 2020  h2.             
+000131b0: 2020 2068 5f6d 6f64 6966 6965 6420 3d20     h_modified = 
+000131c0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+000131d0: 2069 6620 682e 656d 7074 793a 0a20 2020   if h.empty:.   
+000131e0: 2020 2020 2020 2020 2020 2020 2068 203d               h =
+000131f0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00013200: 2020 2020 2020 685f 6d6f 6469 6669 6564        h_modified
+00013210: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
+00013220: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013230: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
+00013240: 2020 2020 2020 2020 2020 2020 206e 203d               n =
+00013250: 206e 702e 7375 6d28 665f 6469 6666 5f61   np.sum(f_diff_a
+00013260: 6c6c 290a 2020 2020 2020 2020 2020 2020  ll).            
+00013270: 2020 2020 6966 206e 203c 2035 3a0a 2020      if n < 5:.  
 00013280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013290: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-000132a0: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-000132b0: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-000132c0: 656c 7365 2070 7269 6e74 2866 227b 7365  else print(f"{se
-000132d0: 6c66 2e74 6963 6b65 727d 3a20 2220 2b20  lf.ticker}: " + 
-000132e0: 6d73 6729 0a0a 2020 2020 2020 2020 6966  msg)..        if
-000132f0: 2068 5f6d 6f64 6966 6965 643a 0a20 2020   h_modified:.   
-00013300: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-00013310: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00013320: 2020 206d 7367 203d 2022 5772 6974 696e     msg = "Writin
-00013330: 6720 4446 2074 6f20 6361 6368 6522 0a20  g DF to cache". 
-00013340: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00013350: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-00013360: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-00013370: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-00013380: 6c73 6520 7072 696e 7428 6622 7b73 656c  lse print(f"{sel
-00013390: 662e 7469 636b 6572 7d3a 2022 202b 206d  f.ticker}: " + m
-000133a0: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
-000133b0: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
-000133c0: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
-000133d0: 2c20 7365 6c66 2e63 6163 6865 5f6b 6579  , self.cache_key
-000133e0: 2c20 6829 0a20 2020 2020 2020 2020 2020  , h).           
-000133f0: 2073 656c 662e 6820 3d20 7365 6c66 2e5f   self.h = self._
-00013400: 6765 7443 6163 6865 6450 7269 6365 7328  getCachedPrices(
-00013410: 290a 0a20 2020 2020 2020 2079 6663 6c2e  )..        yfcl.
-00013420: 5472 6163 6545 7869 7428 6622 504d 3a3a  TraceExit(f"PM::
-00013430: 5f76 6572 6966 7943 6163 6865 6450 7269  _verifyCachedPri
-00013440: 6365 732d 7b73 656c 662e 6973 7472 7d28  ces-{self.istr}(
-00013450: 2920 7265 7475 726e 696e 6720 4661 6c73  ) returning Fals
-00013460: 6522 290a 2020 2020 2020 2020 7265 7475  e").        retu
-00013470: 726e 2046 616c 7365 0a0a 2020 2020 6465  rn False..    de
-00013480: 6620 5f66 6574 6368 5966 4869 7374 6f72  f _fetchYfHistor
-00013490: 7928 7365 6c66 2c20 7073 7472 2c20 7374  y(self, pstr, st
-000134a0: 6172 742c 2065 6e64 2c20 7072 6570 6f73  art, end, prepos
-000134b0: 742c 2064 6562 7567 2c20 7665 7269 6679  t, debug, verify
-000134c0: 5f69 6e74 6572 7661 6c73 3d54 7275 652c  _intervals=True,
-000134d0: 2064 6973 6162 6c65 5f79 6663 5f6d 6574   disable_yfc_met
-000134e0: 6164 6174 613d 4661 6c73 6529 3a0a 2020  adata=False):.  
-000134f0: 2020 2020 2020 6966 2073 7461 7274 2069        if start i
-00013500: 7320 4e6f 6e65 2061 6e64 2065 6e64 2069  s None and end i
-00013510: 7320 4e6f 6e65 2061 6e64 2070 7374 7220  s None and pstr 
-00013520: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00013530: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00013540: 4572 726f 7228 224d 7573 7420 7072 6f76  Error("Must prov
-00013550: 6964 6520 7661 6c75 6520 666f 7220 6f6e  ide value for on
-00013560: 6520 6f66 3a20 2773 7461 7274 272c 2027  e of: 'start', '
-00013570: 656e 6427 2c20 2770 7374 7227 2229 0a20  end', 'pstr'"). 
-00013580: 2020 2020 2020 2069 6620 7073 7472 2069         if pstr i
-00013590: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000135a0: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-000135b0: 6543 6865 636b 5374 7228 7073 7472 2c20  eCheckStr(pstr, 
-000135c0: 2270 7374 7222 290a 2020 2020 2020 2020  "pstr").        
-000135d0: 6966 2073 7461 7274 2069 7320 6e6f 7420  if start is not 
-000135e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000135f0: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-00013600: 496e 7465 7276 616c 4474 2873 7461 7274  IntervalDt(start
-00013610: 2c20 7365 6c66 2e69 6e74 6572 7661 6c2c  , self.interval,
-00013620: 2022 7374 6172 7422 290a 2020 2020 2020   "start").      
-00013630: 2020 6966 2065 6e64 2069 7320 6e6f 7420    if end is not 
-00013640: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00013650: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-00013660: 496e 7465 7276 616c 4474 2865 6e64 2c20  IntervalDt(end, 
-00013670: 7365 6c66 2e69 6e74 6572 7661 6c2c 2022  self.interval, "
-00013680: 656e 6422 290a 2020 2020 2020 2020 7966  end").        yf
-00013690: 6375 2e54 7970 6543 6865 636b 426f 6f6c  cu.TypeCheckBool
-000136a0: 2870 7265 706f 7374 2c20 2270 7265 706f  (prepost, "prepo
-000136b0: 7374 2229 0a20 2020 2020 2020 2079 6663  st").        yfc
-000136c0: 752e 5479 7065 4368 6563 6b42 6f6f 6c28  u.TypeCheckBool(
-000136d0: 6465 6275 672c 2022 6465 6275 6722 290a  debug, "debug").
-000136e0: 0a20 2020 2020 2020 2064 6562 7567 5f79  .        debug_y
-000136f0: 6663 203d 2046 616c 7365 0a20 2020 2020  fc = False.     
-00013700: 2020 2023 2064 6562 7567 5f79 6663 203d     # debug_yfc =
-00013710: 2054 7275 650a 0a20 2020 2020 2020 206c   True..        l
-00013720: 6f67 5f6d 7367 203d 2066 2250 4d3a 3a5f  og_msg = f"PM::_
-00013730: 6665 7463 6859 6648 6973 746f 7279 2d7b  fetchYfHistory-{
-00013740: 7365 6c66 2e69 7374 727d 2870 7374 723d  self.istr}(pstr=
-00013750: 7b70 7374 727d 202c 207b 7374 6172 747d  {pstr} , {start}
-00013760: 2d3e 7b65 6e64 7d2c 2070 7265 706f 7374  ->{end}, prepost
-00013770: 3d7b 7072 6570 6f73 747d 2922 0a20 2020  ={prepost})".   
-00013780: 2020 2020 2069 6620 7966 636c 2e49 7354       if yfcl.IsT
-00013790: 7261 6369 6e67 456e 6162 6c65 6428 293a  racingEnabled():
-000137a0: 0a20 2020 2020 2020 2020 2020 2079 6663  .            yfc
-000137b0: 6c2e 5472 6163 6545 6e74 6572 286c 6f67  l.TraceEnter(log
-000137c0: 5f6d 7367 290a 2020 2020 2020 2020 656c  _msg).        el
-000137d0: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-000137e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000137f0: 2222 290a 2020 2020 2020 2020 2020 2020  "").            
-00013800: 7072 696e 7428 6c6f 675f 6d73 6729 0a0a  print(log_msg)..
-00013810: 2020 2020 2020 2020 6966 2070 7374 7220          if pstr 
-00013820: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00013830: 2020 2020 2020 2020 2069 6620 2873 7461           if (sta
-00013840: 7274 2069 7320 6e6f 7420 4e6f 6e65 2920  rt is not None) 
-00013850: 616e 6420 2865 6e64 2069 7320 6e6f 7420  and (end is not 
-00013860: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-00013870: 2020 2020 2020 2023 2073 7461 7274 2f65         # start/e
-00013880: 6e64 2074 616b 6520 7072 6563 6564 656e  nd take preceden
-00013890: 6365 206f 7665 7220 7073 7472 0a20 2020  ce over pstr.   
-000138a0: 2020 2020 2020 2020 2020 2020 2070 7374               pst
-000138b0: 7220 3d20 4e6f 6e65 0a0a 2020 2020 2020  r = None..      
-000138c0: 2020 747a 5f65 7863 6861 6e67 6520 3d20    tz_exchange = 
-000138d0: 7365 6c66 2e74 7a0a 2020 2020 2020 2020  self.tz.        
-000138e0: 7464 5f31 6420 3d20 7469 6d65 6465 6c74  td_1d = timedelt
-000138f0: 6128 6461 7973 3d31 290a 2020 2020 2020  a(days=1).      
-00013900: 2020 6474 5f6e 6f77 203d 2070 642e 5469    dt_now = pd.Ti
-00013910: 6d65 7374 616d 702e 7574 636e 6f77 2829  mestamp.utcnow()
-00013920: 2e74 7a5f 636f 6e76 6572 7428 5a6f 6e65  .tz_convert(Zone
-00013930: 496e 666f 2822 5554 4322 2929 0a0a 2020  Info("UTC"))..  
-00013940: 2020 2020 2020 6966 2070 7374 7220 6973        if pstr is
-00013950: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00013960: 2020 2020 2020 2064 6620 3d20 7365 6c66         df = self
-00013970: 2e5f 6665 7463 6859 6648 6973 746f 7279  ._fetchYfHistory
-00013980: 5f70 6572 696f 6428 7073 7472 2c20 7072  _period(pstr, pr
-00013990: 6570 6f73 742c 2064 6562 7567 290a 2020  epost, debug).  
-000139a0: 2020 2020 2020 2020 2020 6669 7273 745f            first_
-000139b0: 6665 7463 685f 6661 696c 6564 203d 2064  fetch_failed = d
-000139c0: 6620 6973 204e 6f6e 6520 6f72 2064 662e  f is None or df.
-000139d0: 656d 7074 790a 0a20 2020 2020 2020 2065  empty..        e
-000139e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000139f0: 2069 6620 7365 6c66 2e69 6e74 7261 6461   if self.intrada
-00013a00: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00013a10: 2020 206d 6178 4c6f 6f6b 6261 636b 203d     maxLookback =
-00013a20: 2079 6663 642e 7966 4d61 7846 6574 6368   yfcd.yfMaxFetch
-00013a30: 4c6f 6f6b 6261 636b 5b73 656c 662e 696e  Lookback[self.in
-00013a40: 7465 7276 616c 5d20 2d20 7469 6d65 6465  terval] - timede
-00013a50: 6c74 6128 7365 636f 6e64 733d 3130 290a  lta(seconds=10).
-00013a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a70: 6966 206d 6178 4c6f 6f6b 6261 636b 2069  if maxLookback i
-00013a80: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00013a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013aa0: 7374 6172 7420 3d20 6d61 7828 7374 6172  start = max(star
-00013ab0: 742c 2064 745f 6e6f 7720 2d20 6d61 784c  t, dt_now - maxL
-00013ac0: 6f6f 6b62 6163 6b29 0a20 2020 2020 2020  ookback).       
-00013ad0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00013ae0: 7374 6172 7420 3e3d 2065 6e64 3a0a 2020  start >= end:.  
-00013af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b00: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00013b10: 650a 0a20 2020 2020 2020 2020 2020 2066  e..            f
-00013b20: 6574 6368 5f73 7461 7274 203d 2073 7461  etch_start = sta
-00013b30: 7274 0a20 2020 2020 2020 2020 2020 2066  rt.            f
-00013b40: 6574 6368 5f65 6e64 203d 2065 6e64 0a0a  etch_end = end..
-00013b50: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-00013b60: 6e64 2069 7320 6e6f 7420 4e6f 6e65 3a0a  nd is not None:.
-00013b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b80: 2320 4966 2027 6665 7463 685f 656e 6427  # If 'fetch_end'
-00013b90: 2069 6e20 6675 7475 7265 2074 6865 6e20   in future then 
-00013ba0: 6361 7020 746f 2065 7863 6861 6e67 6520  cap to exchange 
-00013bb0: 6d69 646e 6967 6874 0a20 2020 2020 2020  midnight.       
-00013bc0: 2020 2020 2020 2020 2064 746e 6f77 5f65           dtnow_e
-00013bd0: 7863 6861 6e67 6520 3d20 6474 5f6e 6f77  xchange = dt_now
-00013be0: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
-00013bf0: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
-00013c00: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00013c10: 7374 616e 6365 2865 6e64 2c20 6461 7465  stance(end, date
-00013c20: 7469 6d65 293a 0a20 2020 2020 2020 2020  time):.         
-00013c30: 2020 2020 2020 2020 2020 2065 6e64 5f64             end_d
-00013c40: 7420 3d20 656e 640a 2020 2020 2020 2020  t = end.        
-00013c50: 2020 2020 2020 2020 2020 2020 2320 656e              # en
-00013c60: 645f 6420 3d20 656e 642e 6173 7469 6d65  d_d = end.astime
-00013c70: 7a6f 6e65 2874 7a5f 6578 6368 616e 6765  zone(tz_exchange
-00013c80: 292e 6461 7465 2829 0a20 2020 2020 2020  ).date().       
-00013c90: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-00013ca0: 5f64 203d 204e 6f6e 650a 2020 2020 2020  _d = None.      
-00013cb0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00013cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cd0: 2020 2020 656e 645f 6420 3d20 656e 640a      end_d = end.
-00013ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013cf0: 2020 2020 656e 645f 6474 203d 2064 6174      end_dt = dat
-00013d00: 6574 696d 652e 636f 6d62 696e 6528 656e  etime.combine(en
-00013d10: 642c 2074 696d 6528 3029 2c20 747a 5f65  d, time(0), tz_e
-00013d20: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
-00013d30: 2020 2020 2020 2020 2069 6620 656e 645f           if end_
-00013d40: 6474 203e 2064 745f 6e6f 773a 0a20 2020  dt > dt_now:.   
-00013d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d60: 2065 7863 6861 6e67 655f 6d69 646e 6967   exchange_midnig
-00013d70: 6874 5f64 7420 3d20 6461 7465 7469 6d65  ht_dt = datetime
-00013d80: 2e63 6f6d 6269 6e65 2864 746e 6f77 5f65  .combine(dtnow_e
-00013d90: 7863 6861 6e67 652e 6461 7465 2829 2b74  xchange.date()+t
-00013da0: 645f 3164 2c20 7469 6d65 2830 292c 2074  d_1d, time(0), t
-00013db0: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
+00013290: 2020 6d73 6720 3d20 2264 6966 6665 7265    msg = "differe
+000132a0: 6e63 6573 2066 6f75 6e64 2062 7574 206e  nces found but n
+000132b0: 6f74 2063 6f72 7265 6374 696e 673a 2022  ot correcting: "
+000132c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000132d0: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+000132e0: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+000132f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00013300: 7367 202b 3d20 2266 7b66 5f64 6966 665f  sg += "f{f_diff_
+00013310: 616c 6c2e 696e 6465 785b 665f 6469 6666  all.index[f_diff
+00013320: 5f61 6c6c 5d2e 6461 7465 7d22 0a20 2020  _all].date}".   
+00013330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013340: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013350: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00013360: 7367 202b 3d20 2266 7b66 5f64 6966 665f  sg += "f{f_diff_
+00013370: 616c 6c2e 696e 6465 785b 665f 6469 6666  all.index[f_diff
+00013380: 5f61 6c6c 5d7d 220a 2020 2020 2020 2020  _all]}".        
+00013390: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000133a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000133b0: 2020 6d73 6720 3d20 6622 7b6e 702e 7375    msg = f"{np.su
+000133c0: 6d28 665f 6469 6666 5f61 6c6c 297d 2064  m(f_diff_all)} d
+000133d0: 6966 6665 7265 6e63 6573 2066 6f75 6e64  ifferences found
+000133e0: 2062 7574 206e 6f74 2063 6f72 7265 6374   but not correct
+000133f0: 696e 6722 0a20 2020 2020 2020 2020 2020  ing".           
+00013400: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
+00013410: 7269 6e74 286d 7367 2920 6966 2079 6663  rint(msg) if yfc
+00013420: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
+00013430: 6564 2829 2065 6c73 6520 7072 696e 7428  ed() else print(
+00013440: 6622 7b73 656c 662e 7469 636b 6572 7d3a  f"{self.ticker}:
+00013450: 2022 202b 206d 7367 290a 0a20 2020 2020   " + msg)..     
+00013460: 2020 2069 6620 685f 6d6f 6469 6669 6564     if h_modified
+00013470: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00013480: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+00013490: 2020 2020 2020 2020 6d73 6720 3d20 2257          msg = "W
+000134a0: 7269 7469 6e67 2044 4620 746f 2063 6163  riting DF to cac
+000134b0: 6865 220a 2020 2020 2020 2020 2020 2020  he".            
+000134c0: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
+000134d0: 696e 7428 6d73 6729 2069 6620 7966 636c  int(msg) if yfcl
+000134e0: 2e49 7354 7261 6369 6e67 456e 6162 6c65  .IsTracingEnable
+000134f0: 6428 2920 656c 7365 2070 7269 6e74 2866  d() else print(f
+00013500: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
+00013510: 2220 2b20 6d73 6729 0a20 2020 2020 2020  " + msg).       
+00013520: 2020 2020 2079 6663 6d2e 5374 6f72 6543       yfcm.StoreC
+00013530: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
+00013540: 6963 6b65 722c 2073 656c 662e 6361 6368  icker, self.cach
+00013550: 655f 6b65 792c 2068 290a 2020 2020 2020  e_key, h).      
+00013560: 2020 2020 2020 7365 6c66 2e68 203d 2073        self.h = s
+00013570: 656c 662e 5f67 6574 4361 6368 6564 5072  elf._getCachedPr
+00013580: 6963 6573 2829 0a0a 2020 2020 2020 2020  ices()..        
+00013590: 7966 636c 2e54 7261 6365 4578 6974 2866  yfcl.TraceExit(f
+000135a0: 2250 4d3a 3a5f 7665 7269 6679 4361 6368  "PM::_verifyCach
+000135b0: 6564 5072 6963 6573 2d7b 7365 6c66 2e69  edPrices-{self.i
+000135c0: 7374 727d 2829 2072 6574 7572 6e69 6e67  str}() returning
+000135d0: 2046 616c 7365 2229 0a20 2020 2020 2020   False").       
+000135e0: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
+000135f0: 2020 2064 6566 205f 6665 7463 6859 6648     def _fetchYfH
+00013600: 6973 746f 7279 2873 656c 662c 2070 7374  istory(self, pst
+00013610: 722c 2073 7461 7274 2c20 656e 642c 2070  r, start, end, p
+00013620: 7265 706f 7374 2c20 6465 6275 672c 2076  repost, debug, v
+00013630: 6572 6966 795f 696e 7465 7276 616c 733d  erify_intervals=
+00013640: 5472 7565 2c20 6469 7361 626c 655f 7966  True, disable_yf
+00013650: 635f 6d65 7461 6461 7461 3d46 616c 7365  c_metadata=False
+00013660: 293a 0a20 2020 2020 2020 2069 6620 7374  ):.        if st
+00013670: 6172 7420 6973 204e 6f6e 6520 616e 6420  art is None and 
+00013680: 656e 6420 6973 204e 6f6e 6520 616e 6420  end is None and 
+00013690: 7073 7472 2069 7320 4e6f 6e65 3a0a 2020  pstr is None:.  
+000136a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000136b0: 5661 6c75 6545 7272 6f72 2822 4d75 7374  ValueError("Must
+000136c0: 2070 726f 7669 6465 2076 616c 7565 2066   provide value f
+000136d0: 6f72 206f 6e65 206f 663a 2027 7374 6172  or one of: 'star
+000136e0: 7427 2c20 2765 6e64 272c 2027 7073 7472  t', 'end', 'pstr
+000136f0: 2722 290a 2020 2020 2020 2020 6966 2070  '").        if p
+00013700: 7374 7220 6973 206e 6f74 204e 6f6e 653a  str is not None:
+00013710: 0a20 2020 2020 2020 2020 2020 2079 6663  .            yfc
+00013720: 752e 5479 7065 4368 6563 6b53 7472 2870  u.TypeCheckStr(p
+00013730: 7374 722c 2022 7073 7472 2229 0a20 2020  str, "pstr").   
+00013740: 2020 2020 2069 6620 7374 6172 7420 6973       if start is
+00013750: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00013760: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+00013770: 4368 6563 6b49 6e74 6572 7661 6c44 7428  CheckIntervalDt(
+00013780: 7374 6172 742c 2073 656c 662e 696e 7465  start, self.inte
+00013790: 7276 616c 2c20 2273 7461 7274 2229 0a20  rval, "start"). 
+000137a0: 2020 2020 2020 2069 6620 656e 6420 6973         if end is
+000137b0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000137c0: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+000137d0: 4368 6563 6b49 6e74 6572 7661 6c44 7428  CheckIntervalDt(
+000137e0: 656e 642c 2073 656c 662e 696e 7465 7276  end, self.interv
+000137f0: 616c 2c20 2265 6e64 2229 0a20 2020 2020  al, "end").     
+00013800: 2020 2079 6663 752e 5479 7065 4368 6563     yfcu.TypeChec
+00013810: 6b42 6f6f 6c28 7072 6570 6f73 742c 2022  kBool(prepost, "
+00013820: 7072 6570 6f73 7422 290a 2020 2020 2020  prepost").      
+00013830: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
+00013840: 426f 6f6c 2864 6562 7567 2c20 2264 6562  Bool(debug, "deb
+00013850: 7567 2229 0a0a 2020 2020 2020 2020 6465  ug")..        de
+00013860: 6275 675f 7966 6320 3d20 4661 6c73 650a  bug_yfc = False.
+00013870: 2020 2020 2020 2020 2320 6465 6275 675f          # debug_
+00013880: 7966 6320 3d20 5472 7565 0a0a 2020 2020  yfc = True..    
+00013890: 2020 2020 6c6f 675f 6d73 6720 3d20 6622      log_msg = f"
+000138a0: 504d 3a3a 5f66 6574 6368 5966 4869 7374  PM::_fetchYfHist
+000138b0: 6f72 792d 7b73 656c 662e 6973 7472 7d28  ory-{self.istr}(
+000138c0: 7073 7472 3d7b 7073 7472 7d20 2c20 7b73  pstr={pstr} , {s
+000138d0: 7461 7274 7d2d 3e7b 656e 647d 2c20 7072  tart}->{end}, pr
+000138e0: 6570 6f73 743d 7b70 7265 706f 7374 7d29  epost={prepost})
+000138f0: 220a 2020 2020 2020 2020 6966 2079 6663  ".        if yfc
+00013900: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
+00013910: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
+00013920: 2020 7966 636c 2e54 7261 6365 456e 7465    yfcl.TraceEnte
+00013930: 7228 6c6f 675f 6d73 6729 0a20 2020 2020  r(log_msg).     
+00013940: 2020 2065 6c69 6620 6465 6275 675f 7966     elif debug_yf
+00013950: 633a 0a20 2020 2020 2020 2020 2020 2070  c:.            p
+00013960: 7269 6e74 2822 2229 0a20 2020 2020 2020  rint("").       
+00013970: 2020 2020 2070 7269 6e74 286c 6f67 5f6d       print(log_m
+00013980: 7367 290a 0a20 2020 2020 2020 2069 6620  sg)..        if 
+00013990: 7073 7472 2069 7320 6e6f 7420 4e6f 6e65  pstr is not None
+000139a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000139b0: 2028 7374 6172 7420 6973 206e 6f74 204e   (start is not N
+000139c0: 6f6e 6529 2061 6e64 2028 656e 6420 6973  one) and (end is
+000139d0: 206e 6f74 204e 6f6e 6529 3a0a 2020 2020   not None):.    
+000139e0: 2020 2020 2020 2020 2020 2020 2320 7374              # st
+000139f0: 6172 742f 656e 6420 7461 6b65 2070 7265  art/end take pre
+00013a00: 6365 6465 6e63 6520 6f76 6572 2070 7374  cedence over pst
+00013a10: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00013a20: 2020 7073 7472 203d 204e 6f6e 650a 0a20    pstr = None.. 
+00013a30: 2020 2020 2020 2074 7a5f 6578 6368 616e         tz_exchan
+00013a40: 6765 203d 2073 656c 662e 747a 0a20 2020  ge = self.tz.   
+00013a50: 2020 2020 2074 645f 3164 203d 2074 696d       td_1d = tim
+00013a60: 6564 656c 7461 2864 6179 733d 3129 0a20  edelta(days=1). 
+00013a70: 2020 2020 2020 2064 745f 6e6f 7720 3d20         dt_now = 
+00013a80: 7064 2e54 696d 6573 7461 6d70 2e75 7463  pd.Timestamp.utc
+00013a90: 6e6f 7728 292e 747a 5f63 6f6e 7665 7274  now().tz_convert
+00013aa0: 285a 6f6e 6549 6e66 6f28 2255 5443 2229  (ZoneInfo("UTC")
+00013ab0: 290a 0a20 2020 2020 2020 2069 6620 7073  )..        if ps
+00013ac0: 7472 2069 7320 6e6f 7420 4e6f 6e65 3a0a  tr is not None:.
+00013ad0: 2020 2020 2020 2020 2020 2020 6466 203d              df =
+00013ae0: 2073 656c 662e 5f66 6574 6368 5966 4869   self._fetchYfHi
+00013af0: 7374 6f72 795f 7065 7269 6f64 2870 7374  story_period(pst
+00013b00: 722c 2070 7265 706f 7374 2c20 6465 6275  r, prepost, debu
+00013b10: 6729 0a20 2020 2020 2020 2020 2020 2066  g).            f
+00013b20: 6972 7374 5f66 6574 6368 5f66 6169 6c65  irst_fetch_faile
+00013b30: 6420 3d20 6466 2069 7320 4e6f 6e65 206f  d = df is None o
+00013b40: 7220 6466 2e65 6d70 7479 0a0a 2020 2020  r df.empty..    
+00013b50: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013b60: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+00013b70: 7472 6164 6179 3a0a 2020 2020 2020 2020  traday:.        
+00013b80: 2020 2020 2020 2020 6d61 784c 6f6f 6b62          maxLookb
+00013b90: 6163 6b20 3d20 7966 6364 2e79 664d 6178  ack = yfcd.yfMax
+00013ba0: 4665 7463 684c 6f6f 6b62 6163 6b5b 7365  FetchLookback[se
+00013bb0: 6c66 2e69 6e74 6572 7661 6c5d 202d 2074  lf.interval] - t
+00013bc0: 696d 6564 656c 7461 2873 6563 6f6e 6473  imedelta(seconds
+00013bd0: 3d31 3029 0a20 2020 2020 2020 2020 2020  =10).           
+00013be0: 2020 2020 2069 6620 6d61 784c 6f6f 6b62       if maxLookb
+00013bf0: 6163 6b20 6973 206e 6f74 204e 6f6e 653a  ack is not None:
+00013c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013c10: 2020 2020 2073 7461 7274 203d 206d 6178       start = max
+00013c20: 2873 7461 7274 2c20 6474 5f6e 6f77 202d  (start, dt_now -
+00013c30: 206d 6178 4c6f 6f6b 6261 636b 290a 2020   maxLookback).  
+00013c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c50: 2020 6966 2073 7461 7274 203e 3d20 656e    if start >= en
+00013c60: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00013c70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00013c80: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+00013c90: 2020 2020 6665 7463 685f 7374 6172 7420      fetch_start 
+00013ca0: 3d20 7374 6172 740a 2020 2020 2020 2020  = start.        
+00013cb0: 2020 2020 6665 7463 685f 656e 6420 3d20      fetch_end = 
+00013cc0: 656e 640a 0a20 2020 2020 2020 2020 2020  end..           
+00013cd0: 2069 6620 656e 6420 6973 206e 6f74 204e   if end is not N
+00013ce0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00013cf0: 2020 2020 2023 2049 6620 2766 6574 6368       # If 'fetch
+00013d00: 5f65 6e64 2720 696e 2066 7574 7572 6520  _end' in future 
+00013d10: 7468 656e 2063 6170 2074 6f20 6578 6368  then cap to exch
+00013d20: 616e 6765 206d 6964 6e69 6768 740a 2020  ange midnight.  
+00013d30: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+00013d40: 6e6f 775f 6578 6368 616e 6765 203d 2064  now_exchange = d
+00013d50: 745f 6e6f 772e 747a 5f63 6f6e 7665 7274  t_now.tz_convert
+00013d60: 2874 7a5f 6578 6368 616e 6765 290a 2020  (tz_exchange).  
+00013d70: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00013d80: 2069 7369 6e73 7461 6e63 6528 656e 642c   isinstance(end,
+00013d90: 2064 6174 6574 696d 6529 3a0a 2020 2020   datetime):.    
+00013da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013db0: 656e 645f 6474 203d 2065 6e64 0a20 2020  end_dt = end.   
 00013dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013dd0: 6966 2069 7369 6e73 7461 6e63 6528 656e  if isinstance(en
-00013de0: 642c 2064 6174 6574 696d 6529 3a0a 2020  d, datetime):.  
-00013df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013e00: 2020 2020 2020 6665 7463 685f 656e 6420        fetch_end 
-00013e10: 3d20 6578 6368 616e 6765 5f6d 6964 6e69  = exchange_midni
-00013e20: 6768 745f 6474 0a20 2020 2020 2020 2020  ght_dt.         
-00013e30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00013e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013e50: 2020 2020 2020 2020 2066 6574 6368 5f65           fetch_e
-00013e60: 6e64 203d 2065 7863 6861 6e67 655f 6d69  nd = exchange_mi
-00013e70: 646e 6967 6874 5f64 742e 6461 7465 2829  dnight_dt.date()
-00013e80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013e90: 7374 6172 7420 6973 206e 6f74 204e 6f6e  start is not Non
-00013ea0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00013eb0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-00013ec0: 2873 7461 7274 2c20 6461 7465 7469 6d65  (start, datetime
-00013ed0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013ee0: 2020 2020 2020 2073 7461 7274 5f64 7420         start_dt 
-00013ef0: 3d20 7374 6172 740a 2020 2020 2020 2020  = start.        
-00013f00: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-00013f10: 6172 745f 6420 3d20 7374 6172 742e 6173  art_d = start.as
-00013f20: 7469 6d65 7a6f 6e65 2874 7a5f 6578 6368  timezone(tz_exch
-00013f30: 616e 6765 292e 6461 7465 2829 0a20 2020  ange).date().   
-00013f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f50: 2073 7461 7274 5f64 203d 204e 6f6e 650a   start_d = None.
-00013f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00013f80: 2020 2020 2020 2020 2020 7374 6172 745f            start_
-00013f90: 6420 3d20 7374 6172 740a 2020 2020 2020  d = start.      
-00013fa0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00013fb0: 6172 745f 6474 203d 2064 6174 6574 696d  art_dt = datetim
-00013fc0: 652e 636f 6d62 696e 6528 7374 6172 742c  e.combine(start,
-00013fd0: 2074 696d 6528 3029 2c20 747a 5f65 7863   time(0), tz_exc
-00013fe0: 6861 6e67 6529 0a0a 2020 2020 2020 2020  hange)..        
-00013ff0: 2020 2020 2020 2020 6966 2028 6665 7463          if (fetc
-00014000: 685f 7374 6172 7420 6973 206e 6f74 204e  h_start is not N
-00014010: 6f6e 6529 2061 6e64 2028 6665 7463 685f  one) and (fetch_
-00014020: 656e 6420 3c3d 2066 6574 6368 5f73 7461  end <= fetch_sta
-00014030: 7274 293a 0a20 2020 2020 2020 2020 2020  rt):.           
-00014040: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00014050: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-00014060: 2020 6966 2066 6574 6368 5f73 7461 7274    if fetch_start
-00014070: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00014080: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014090: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-000140a0: 6665 7463 685f 7374 6172 742c 2028 6461  fetch_start, (da
-000140b0: 7465 7469 6d65 2c20 7064 2e54 696d 6573  tetime, pd.Times
-000140c0: 7461 6d70 2929 3a0a 2020 2020 2020 2020  tamp)):.        
-000140d0: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
-000140e0: 685f 7374 6172 745f 6474 203d 2064 6174  h_start_dt = dat
-000140f0: 6574 696d 652e 636f 6d62 696e 6528 6665  etime.combine(fe
-00014100: 7463 685f 7374 6172 742c 2074 696d 6528  tch_start, time(
-00014110: 3029 2c20 7365 6c66 2e74 7a29 0a20 2020  0), self.tz).   
-00014120: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00014130: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00014140: 2020 2020 2020 2066 6574 6368 5f73 7461         fetch_sta
-00014150: 7274 5f64 7420 3d20 6665 7463 685f 7374  rt_dt = fetch_st
-00014160: 6172 740a 2020 2020 2020 2020 2020 2020  art.            
-00014170: 6966 2066 6574 6368 5f65 6e64 2069 7320  if fetch_end is 
-00014180: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00014190: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000141a0: 2069 7369 6e73 7461 6e63 6528 6665 7463   isinstance(fetc
-000141b0: 685f 656e 642c 2028 6461 7465 7469 6d65  h_end, (datetime
-000141c0: 2c20 7064 2e54 696d 6573 7461 6d70 2929  , pd.Timestamp))
-000141d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000141e0: 2020 2020 2020 6665 7463 685f 656e 645f        fetch_end_
-000141f0: 6474 203d 2064 6174 6574 696d 652e 636f  dt = datetime.co
-00014200: 6d62 696e 6528 6665 7463 685f 656e 642c  mbine(fetch_end,
-00014210: 2074 696d 6528 3029 2c20 747a 5f65 7863   time(0), tz_exc
-00014220: 6861 6e67 6529 0a20 2020 2020 2020 2020  hange).         
-00014230: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00013dd0: 2023 2065 6e64 5f64 203d 2065 6e64 2e61   # end_d = end.a
+00013de0: 7374 696d 657a 6f6e 6528 747a 5f65 7863  stimezone(tz_exc
+00013df0: 6861 6e67 6529 2e64 6174 6528 290a 2020  hange).date().  
+00013e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e10: 2020 656e 645f 6420 3d20 4e6f 6e65 0a20    end_d = None. 
+00013e20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00013e30: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00013e40: 2020 2020 2020 2020 2065 6e64 5f64 203d           end_d =
+00013e50: 2065 6e64 0a20 2020 2020 2020 2020 2020   end.           
+00013e60: 2020 2020 2020 2020 2065 6e64 5f64 7420           end_dt 
+00013e70: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
+00013e80: 6e65 2865 6e64 2c20 7469 6d65 2830 292c  ne(end, time(0),
+00013e90: 2074 7a5f 6578 6368 616e 6765 290a 2020   tz_exchange).  
+00013ea0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00013eb0: 2065 6e64 5f64 7420 3e20 6474 5f6e 6f77   end_dt > dt_now
+00013ec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00013ed0: 2020 2020 2020 6578 6368 616e 6765 5f6d        exchange_m
+00013ee0: 6964 6e69 6768 745f 6474 203d 2064 6174  idnight_dt = dat
+00013ef0: 6574 696d 652e 636f 6d62 696e 6528 6474  etime.combine(dt
+00013f00: 6e6f 775f 6578 6368 616e 6765 2e64 6174  now_exchange.dat
+00013f10: 6528 292b 7464 5f31 642c 2074 696d 6528  e()+td_1d, time(
+00013f20: 3029 2c20 747a 5f65 7863 6861 6e67 6529  0), tz_exchange)
+00013f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013f40: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00013f50: 6365 2865 6e64 2c20 6461 7465 7469 6d65  ce(end, datetime
+00013f60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00013f70: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
+00013f80: 5f65 6e64 203d 2065 7863 6861 6e67 655f  _end = exchange_
+00013f90: 6d69 646e 6967 6874 5f64 740a 2020 2020  midnight_dt.    
+00013fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013fb0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00013fc0: 2020 2020 2020 2020 2020 2020 2020 6665                fe
+00013fd0: 7463 685f 656e 6420 3d20 6578 6368 616e  tch_end = exchan
+00013fe0: 6765 5f6d 6964 6e69 6768 745f 6474 2e64  ge_midnight_dt.d
+00013ff0: 6174 6528 290a 2020 2020 2020 2020 2020  ate().          
+00014000: 2020 6966 2073 7461 7274 2069 7320 6e6f    if start is no
+00014010: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00014020: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00014030: 7461 6e63 6528 7374 6172 742c 2064 6174  tance(start, dat
+00014040: 6574 696d 6529 3a0a 2020 2020 2020 2020  etime):.        
+00014050: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00014060: 745f 6474 203d 2073 7461 7274 0a20 2020  t_dt = start.   
+00014070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014080: 2023 2073 7461 7274 5f64 203d 2073 7461   # start_d = sta
+00014090: 7274 2e61 7374 696d 657a 6f6e 6528 747a  rt.astimezone(tz
+000140a0: 5f65 7863 6861 6e67 6529 2e64 6174 6528  _exchange).date(
+000140b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000140c0: 2020 2020 2020 7374 6172 745f 6420 3d20        start_d = 
+000140d0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000140e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000140f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014100: 7461 7274 5f64 203d 2073 7461 7274 0a20  tart_d = start. 
+00014110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014120: 2020 2073 7461 7274 5f64 7420 3d20 6461     start_dt = da
+00014130: 7465 7469 6d65 2e63 6f6d 6269 6e65 2873  tetime.combine(s
+00014140: 7461 7274 2c20 7469 6d65 2830 292c 2074  tart, time(0), t
+00014150: 7a5f 6578 6368 616e 6765 290a 0a20 2020  z_exchange)..   
+00014160: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00014170: 2866 6574 6368 5f73 7461 7274 2069 7320  (fetch_start is 
+00014180: 6e6f 7420 4e6f 6e65 2920 616e 6420 2866  not None) and (f
+00014190: 6574 6368 5f65 6e64 203c 3d20 6665 7463  etch_end <= fetc
+000141a0: 685f 7374 6172 7429 3a0a 2020 2020 2020  h_start):.      
+000141b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000141c0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+000141d0: 2020 2020 2020 2069 6620 6665 7463 685f         if fetch_
+000141e0: 7374 6172 7420 6973 206e 6f74 204e 6f6e  start is not Non
+000141f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00014200: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+00014210: 616e 6365 2866 6574 6368 5f73 7461 7274  ance(fetch_start
+00014220: 2c20 2864 6174 6574 696d 652c 2070 642e  , (datetime, pd.
+00014230: 5469 6d65 7374 616d 7029 293a 0a20 2020  Timestamp)):.   
 00014240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014250: 2066 6574 6368 5f65 6e64 5f64 7420 3d20   fetch_end_dt = 
-00014260: 6665 7463 685f 656e 640a 0a20 2020 2020  fetch_end..     
-00014270: 2020 2020 2020 2069 6620 6665 7463 685f         if fetch_
-00014280: 7374 6172 7420 6973 206e 6f74 204e 6f6e  start is not Non
-00014290: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000142a0: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
-000142b0: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-000142c0: 7276 616c 2e57 6565 6b3a 0a20 2020 2020  rval.Week:.     
-000142d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000142e0: 2045 6e73 7572 6520 616c 6967 6e65 6420   Ensure aligned 
-000142f0: 746f 2077 6565 6b20 7374 6172 743a 0a20  to week start:. 
-00014300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014310: 2020 2066 6574 6368 5f73 7461 7274 202d     fetch_start -
-00014320: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
-00014330: 3d66 6574 6368 5f73 7461 7274 2e77 6565  =fetch_start.wee
-00014340: 6b64 6179 2829 290a 0a20 2020 2020 2020  kday())..       
-00014350: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00014360: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
-00014370: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
-00014380: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00014390: 7273 745f 6665 7463 685f 6661 696c 6564  rst_fetch_failed
-000143a0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000143b0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000143c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143d0: 2020 6466 203d 2073 656c 662e 5f66 6574    df = self._fet
-000143e0: 6368 5966 4869 7374 6f72 795f 6461 7465  chYfHistory_date
-000143f0: 5261 6e67 6528 6665 7463 685f 7374 6172  Range(fetch_star
-00014400: 742c 2066 6574 6368 5f65 6e64 2c20 7072  t, fetch_end, pr
-00014410: 6570 6f73 742c 2064 6562 7567 290a 2020  epost, debug).  
-00014420: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00014430: 6365 7074 2079 6663 642e 4e6f 5072 6963  cept yfcd.NoPric
-00014440: 6544 6174 6149 6e52 616e 6765 4578 6365  eDataInRangeExce
-00014450: 7074 696f 6e20 6173 2065 3a0a 2020 2020  ption as e:.    
-00014460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014470: 6669 7273 745f 6665 7463 685f 6661 696c  first_fetch_fail
-00014480: 6564 203d 2054 7275 650a 2020 2020 2020  ed = True.      
-00014490: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-000144a0: 203d 2065 0a0a 2020 2020 2020 2020 2020   = e..          
-000144b0: 2020 2020 2020 6966 2066 6972 7374 5f66        if first_f
-000144c0: 6574 6368 5f66 6169 6c65 6420 616e 6420  etch_failed and 
-000144d0: 6665 7463 685f 656e 6420 6973 206e 6f74  fetch_end is not
-000144e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000144f0: 2020 2020 2020 2020 2020 2023 2054 7279             # Try
-00014500: 2077 6974 6820 7769 6465 7220 6461 7465   with wider date
-00014510: 2072 616e 6765 2c20 6d61 7962 6520 656e   range, maybe en
-00014520: 7469 7265 2072 616e 6765 2069 7320 6a75  tire range is ju
-00014530: 7374 2062 6566 6f72 6520 6c69 7374 696e  st before listin
-00014540: 6720 6461 7465 0a20 2020 2020 2020 2020  g date.         
-00014550: 2020 2020 2020 2020 2020 2073 6563 6f6e             secon
-00014560: 645f 6665 7463 685f 6661 696c 6564 203d  d_fetch_failed =
-00014570: 2046 616c 7365 0a20 2020 2020 2020 2020   False.         
-00014580: 2020 2020 2020 2020 2020 2064 665f 7769             df_wi
-00014590: 6465 7220 3d20 4e6f 6e65 0a20 2020 2020  der = None.     
-000145a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000145b0: 6973 7469 6e67 5f64 6174 655f 6368 6563  isting_date_chec
-000145c0: 6b5f 746f 6c20 3d20 7966 6364 2e6c 6973  k_tol = yfcd.lis
-000145d0: 7469 6e67 5f64 6174 655f 6368 6563 6b5f  ting_date_check_
-000145e0: 746f 6c73 5b73 656c 662e 696e 7465 7276  tols[self.interv
-000145f0: 616c 5d0a 2020 2020 2020 2020 2020 2020  al].            
-00014600: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
-00014610: 6172 7420 2d3d 2032 2a6c 6973 7469 6e67  art -= 2*listing
-00014620: 5f64 6174 655f 6368 6563 6b5f 746f 6c0a  _date_check_tol.
-00014630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014640: 2020 2020 6665 7463 685f 656e 6420 2b3d      fetch_end +=
-00014650: 2032 2a6c 6973 7469 6e67 5f64 6174 655f   2*listing_date_
-00014660: 6368 6563 6b5f 746f 6c0a 2020 2020 2020  check_tol.      
-00014670: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014680: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
+00014250: 2066 6574 6368 5f73 7461 7274 5f64 7420   fetch_start_dt 
+00014260: 3d20 6461 7465 7469 6d65 2e63 6f6d 6269  = datetime.combi
+00014270: 6e65 2866 6574 6368 5f73 7461 7274 2c20  ne(fetch_start, 
+00014280: 7469 6d65 2830 292c 2073 656c 662e 747a  time(0), self.tz
+00014290: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000142a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000142b0: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+000142c0: 685f 7374 6172 745f 6474 203d 2066 6574  h_start_dt = fet
+000142d0: 6368 5f73 7461 7274 0a20 2020 2020 2020  ch_start.       
+000142e0: 2020 2020 2069 6620 6665 7463 685f 656e       if fetch_en
+000142f0: 6420 6973 206e 6f74 204e 6f6e 653a 0a20  d is not None:. 
+00014300: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00014310: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00014320: 2866 6574 6368 5f65 6e64 2c20 2864 6174  (fetch_end, (dat
+00014330: 6574 696d 652c 2070 642e 5469 6d65 7374  etime, pd.Timest
+00014340: 616d 7029 293a 0a20 2020 2020 2020 2020  amp)):.         
+00014350: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
+00014360: 5f65 6e64 5f64 7420 3d20 6461 7465 7469  _end_dt = dateti
+00014370: 6d65 2e63 6f6d 6269 6e65 2866 6574 6368  me.combine(fetch
+00014380: 5f65 6e64 2c20 7469 6d65 2830 292c 2074  _end, time(0), t
+00014390: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
+000143a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000143b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000143c0: 2020 2020 2020 6665 7463 685f 656e 645f        fetch_end_
+000143d0: 6474 203d 2066 6574 6368 5f65 6e64 0a0a  dt = fetch_end..
+000143e0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+000143f0: 6574 6368 5f73 7461 7274 2069 7320 6e6f  etch_start is no
+00014400: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00014410: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00014420: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+00014430: 2e49 6e74 6572 7661 6c2e 5765 656b 3a0a  .Interval.Week:.
+00014440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014450: 2020 2020 2320 456e 7375 7265 2061 6c69      # Ensure ali
+00014460: 676e 6564 2074 6f20 7765 656b 2073 7461  gned to week sta
+00014470: 7274 3a0a 2020 2020 2020 2020 2020 2020  rt:.            
+00014480: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
+00014490: 6172 7420 2d3d 2074 696d 6564 656c 7461  art -= timedelta
+000144a0: 2864 6179 733d 6665 7463 685f 7374 6172  (days=fetch_star
+000144b0: 742e 7765 656b 6461 7928 2929 0a0a 2020  t.weekday())..  
+000144c0: 2020 2020 2020 2020 2020 7464 5f31 6420            td_1d 
+000144d0: 3d20 7469 6d65 6465 6c74 6128 6461 7973  = timedelta(days
+000144e0: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
+000144f0: 7464 5f31 3464 203d 2074 696d 6564 656c  td_14d = timedel
+00014500: 7461 2864 6179 733d 3134 290a 2020 2020  ta(days=14).    
+00014510: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00014520: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+00014530: 2e49 6e74 6572 7661 6c2e 4461 7973 313a  .Interval.Days1:
+00014540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014550: 2023 2041 6464 2070 6164 6469 6e67 2064   # Add padding d
+00014560: 6179 7320 746f 2065 6e73 7572 6520 5961  ays to ensure Ya
+00014570: 686f 6f20 7265 7475 726e 7320 636f 7272  hoo returns corr
+00014580: 6563 7420 566f 6c75 6d65 0a20 2020 2020  ect Volume.     
+00014590: 2020 2020 2020 2020 2020 2073 203d 2079             s = y
+000145a0: 6663 742e 4765 7445 7863 6861 6e67 6553  fct.GetExchangeS
+000145b0: 6368 6564 756c 6528 7365 6c66 2e65 7863  chedule(self.exc
+000145c0: 6861 6e67 652c 2066 6574 6368 5f73 7461  hange, fetch_sta
+000145d0: 7274 202d 2074 645f 3134 642c 2066 6574  rt - td_14d, fet
+000145e0: 6368 5f65 6e64 202b 2074 645f 3134 6429  ch_end + td_14d)
+000145f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014600: 2066 6574 6368 5f73 7461 7274 5f70 6164   fetch_start_pad
+00014610: 203d 2073 2e69 6c6f 635b 732e 696e 6465   = s.iloc[s.inde
+00014620: 782e 6765 745f 696e 6465 7865 7228 5b73  x.get_indexer([s
+00014630: 7472 2866 6574 6368 5f73 7461 7274 295d  tr(fetch_start)]
+00014640: 2c20 6d65 7468 6f64 3d22 6666 696c 6c22  , method="ffill"
+00014650: 295b 305d 2d31 5d2e 6e61 6d65 2e64 6174  )[0]-1].name.dat
+00014660: 6528 290a 0a20 2020 2020 2020 2020 2020  e()..           
+00014670: 2020 2020 2066 6972 7374 5f66 6574 6368       first_fetch
+00014680: 5f66 6169 6c65 6420 3d20 4661 6c73 650a  _failed = False.
 00014690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146a0: 2020 2020 6d73 6720 3d20 222d 2066 6972      msg = "- fir
-000146b0: 7374 2066 6574 6368 2066 6169 6c65 642c  st fetch failed,
-000146c0: 2074 7279 696e 6720 6167 6169 6e20 7769   trying again wi
-000146d0: 7468 2077 6964 6572 2072 616e 6765 3a20  th wider range: 
-000146e0: 7b7d 202d 3e20 7b7d 222e 666f 726d 6174  {} -> {}".format
-000146f0: 2866 6574 6368 5f73 7461 7274 2c20 6665  (fetch_start, fe
-00014700: 7463 685f 656e 6429 0a20 2020 2020 2020  tch_end).       
-00014710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014720: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
-00014730: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
-00014740: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-00014750: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
-00014760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014770: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00014780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014790: 2020 6466 5f77 6964 6572 203d 2073 656c    df_wider = sel
-000147a0: 662e 5f66 6574 6368 5966 4869 7374 6f72  f._fetchYfHistor
-000147b0: 795f 6461 7465 5261 6e67 6528 6665 7463  y_dateRange(fetc
-000147c0: 685f 7374 6172 742c 2066 6574 6368 5f65  h_start, fetch_e
-000147d0: 6e64 2c20 7072 6570 6f73 742c 2064 6562  nd, prepost, deb
-000147e0: 7567 290a 2020 2020 2020 2020 2020 2020  ug).            
-000147f0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00014800: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
+000146a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000146b0: 2020 2020 2020 2020 2064 6620 3d20 7365           df = se
+000146c0: 6c66 2e5f 6665 7463 6859 6648 6973 746f  lf._fetchYfHisto
+000146d0: 7279 5f64 6174 6552 616e 6765 2866 6574  ry_dateRange(fet
+000146e0: 6368 5f73 7461 7274 5f70 6164 2c20 6665  ch_start_pad, fe
+000146f0: 7463 685f 656e 642c 2070 7265 706f 7374  tch_end, prepost
+00014700: 2c20 6465 6275 6729 0a20 2020 2020 2020  , debug).       
+00014710: 2020 2020 2020 2020 2020 2020 2064 6620               df 
+00014720: 3d20 6466 2e6c 6f63 5b73 7472 2866 6574  = df.loc[str(fet
+00014730: 6368 5f73 7461 7274 293a 5d2e 636f 7079  ch_start):].copy
+00014740: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00014750: 2020 2065 7863 6570 7420 7966 6364 2e4e     except yfcd.N
+00014760: 6f50 7269 6365 4461 7461 496e 5261 6e67  oPriceDataInRang
+00014770: 6545 7863 6570 7469 6f6e 2061 7320 653a  eException as e:
+00014780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014790: 2020 2020 2066 6972 7374 5f66 6574 6368       first_fetch
+000147a0: 5f66 6169 6c65 6420 3d20 5472 7565 0a20  _failed = True. 
+000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147c0: 2020 2065 7820 3d20 650a 0a20 2020 2020     ex = e..     
+000147d0: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
+000147e0: 7273 745f 6665 7463 685f 6661 696c 6564  rst_fetch_failed
+000147f0: 2061 6e64 2066 6574 6368 5f65 6e64 2069   and fetch_end i
+00014800: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
 00014810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014820: 2020 2020 2020 6d73 6720 3d20 222d 2073        msg = "- s
-00014830: 6563 6f6e 6420 6665 7463 6820 7265 7475  econd fetch retu
-00014840: 726e 6564 3a22 0a20 2020 2020 2020 2020  rned:".         
-00014850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014860: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
-00014870: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
-00014880: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-00014890: 2829 2065 6c73 6520 7072 696e 7428 6d73  () else print(ms
-000148a0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-000148b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000148c0: 7269 6e74 2864 665f 7769 6465 7229 0a20  rint(df_wider). 
-000148d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148e0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000148f0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00014900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014910: 2020 6966 2022 4461 7461 2064 6f65 736e    if "Data doesn
-00014920: 2774 2065 7869 7374 2066 6f72 2073 7461  't exist for sta
-00014930: 7274 4461 7465 2220 696e 2073 7472 2865  rtDate" in str(e
-00014940: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00014950: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014960: 6563 6f6e 645f 6665 7463 685f 6661 696c  econd_fetch_fail
-00014970: 6564 203d 2054 7275 650a 2020 2020 2020  ed = True.      
-00014980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014990: 2020 656c 6966 2022 4e6f 2064 6174 6120    elif "No data 
-000149a0: 666f 756e 6420 666f 7220 7468 6973 2064  found for this d
-000149b0: 6174 6520 7261 6e67 6522 2069 6e20 7374  ate range" in st
-000149c0: 7228 6529 3a0a 2020 2020 2020 2020 2020  r(e):.          
-000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149e0: 2020 7365 636f 6e64 5f66 6574 6368 5f66    second_fetch_f
-000149f0: 6169 6c65 6420 3d20 5472 7565 0a20 2020  ailed = True.   
-00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a30: 2020 2020 2020 2072 6169 7365 2065 0a0a         raise e..
-00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a50: 2020 2020 6966 2064 665f 7769 6465 7220      if df_wider 
-00014a60: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00014a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a80: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
-00014a90: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
-00014aa0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00014ab0: 7269 6e74 2822 2d20 6465 7465 6374 6564  rint("- detected
-00014ac0: 206c 6973 7469 6e67 2064 6174 6520 3d22   listing date ="
-00014ad0: 2c20 6466 5f77 6964 6572 2e69 6e64 6578  , df_wider.index
-00014ae0: 5b30 5d2e 6461 7465 2829 290a 2020 2020  [0].date()).    
-00014af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b00: 2020 2020 7966 636d 2e53 746f 7265 4361      yfcm.StoreCa
-00014b10: 6368 6544 6174 756d 2873 656c 662e 7469  cheDatum(self.ti
-00014b20: 636b 6572 2c20 226c 6973 7469 6e67 5f64  cker, "listing_d
-00014b30: 6174 6522 2c20 6466 5f77 6964 6572 2e69  ate", df_wider.i
-00014b40: 6e64 6578 5b30 5d2e 6461 7465 2829 290a  ndex[0].date()).
-00014b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b60: 2020 2020 2020 2020 6466 203d 2064 665f          df = df_
-00014b70: 7769 6465 720a 2020 2020 2020 2020 2020  wider.          
-00014b80: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014b90: 2066 6574 6368 5f73 7461 7274 2069 7320   fetch_start is 
-00014ba0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00014bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bc0: 2020 2020 2020 6466 203d 2064 662e 6c6f        df = df.lo
-00014bd0: 635b 6665 7463 685f 7374 6172 745f 6474  c[fetch_start_dt
-00014be0: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-00014bf0: 2020 2020 2020 2020 2020 2069 6620 6665             if fe
-00014c00: 7463 685f 656e 6420 6973 206e 6f74 204e  tch_end is not N
-00014c10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00014820: 2320 5472 7920 7769 7468 2077 6964 6572  # Try with wider
+00014830: 2064 6174 6520 7261 6e67 652c 206d 6179   date range, may
+00014840: 6265 2065 6e74 6972 6520 7261 6e67 6520  be entire range 
+00014850: 6973 206a 7573 7420 6265 666f 7265 206c  is just before l
+00014860: 6973 7469 6e67 2064 6174 650a 2020 2020  isting date.    
+00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014880: 7365 636f 6e64 5f66 6574 6368 5f66 6169  second_fetch_fai
+00014890: 6c65 6420 3d20 4661 6c73 650a 2020 2020  led = False.    
+000148a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148b0: 6466 5f77 6964 6572 203d 204e 6f6e 650a  df_wider = None.
+000148c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000148d0: 2020 2020 6c69 7374 696e 675f 6461 7465      listing_date
+000148e0: 5f63 6865 636b 5f74 6f6c 203d 2079 6663  _check_tol = yfc
+000148f0: 642e 6c69 7374 696e 675f 6461 7465 5f63  d.listing_date_c
+00014900: 6865 636b 5f74 6f6c 735b 7365 6c66 2e69  heck_tols[self.i
+00014910: 6e74 6572 7661 6c5d 0a20 2020 2020 2020  nterval].       
+00014920: 2020 2020 2020 2020 2020 2020 2066 6574               fet
+00014930: 6368 5f73 7461 7274 202d 3d20 322a 6c69  ch_start -= 2*li
+00014940: 7374 696e 675f 6461 7465 5f63 6865 636b  sting_date_check
+00014950: 5f74 6f6c 0a20 2020 2020 2020 2020 2020  _tol.           
+00014960: 2020 2020 2020 2020 2066 6574 6368 5f65           fetch_e
+00014970: 6e64 202b 3d20 322a 6c69 7374 696e 675f  nd += 2*listing_
+00014980: 6461 7465 5f63 6865 636b 5f74 6f6c 0a20  date_check_tol. 
+00014990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149a0: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
+000149b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000149c0: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
+000149d0: 2d20 6669 7273 7420 6665 7463 6820 6661  - first fetch fa
+000149e0: 696c 6564 2c20 7472 7969 6e67 2061 6761  iled, trying aga
+000149f0: 696e 2077 6974 6820 7769 6465 7220 7261  in with wider ra
+00014a00: 6e67 653a 207b 7d20 2d3e 207b 7d22 2e66  nge: {} -> {}".f
+00014a10: 6f72 6d61 7428 6665 7463 685f 7374 6172  ormat(fetch_star
+00014a20: 742c 2066 6574 6368 5f65 6e64 290a 2020  t, fetch_end).  
+00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a40: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
+00014a50: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
+00014a60: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
+00014a70: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
+00014a80: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
+00014a90: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00014aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ab0: 2020 2020 2020 2064 665f 7769 6465 7220         df_wider 
+00014ac0: 3d20 7365 6c66 2e5f 6665 7463 6859 6648  = self._fetchYfH
+00014ad0: 6973 746f 7279 5f64 6174 6552 616e 6765  istory_dateRange
+00014ae0: 2866 6574 6368 5f73 7461 7274 2c20 6665  (fetch_start, fe
+00014af0: 7463 685f 656e 642c 2070 7265 706f 7374  tch_end, prepost
+00014b00: 2c20 6465 6275 6729 0a20 2020 2020 2020  , debug).       
+00014b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b20: 2069 6620 6465 6275 675f 7966 633a 0a20   if debug_yfc:. 
+00014b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b40: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00014b50: 2022 2d20 7365 636f 6e64 2066 6574 6368   "- second fetch
+00014b60: 2072 6574 7572 6e65 643a 220a 2020 2020   returned:".    
+00014b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b80: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00014b90: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+00014ba0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00014bb0: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+00014bc0: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
+00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014be0: 2020 2020 7072 696e 7428 6466 5f77 6964      print(df_wid
+00014bf0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00014c00: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00014c10: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
 00014c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c30: 2064 6620 3d20 6466 2e6c 6f63 5b3a 6665   df = df.loc[:fe
-00014c40: 7463 685f 656e 645f 6474 2d74 696d 6564  tch_end_dt-timed
-00014c50: 656c 7461 286d 696c 6c69 7365 636f 6e64  elta(millisecond
-00014c60: 733d 3129 5d0a 0a20 2020 2020 2020 2020  s=1)]..         
-00014c70: 2020 2020 2020 2069 6620 6669 7273 745f         if first_
-00014c80: 6665 7463 685f 6661 696c 6564 3a0a 2020  fetch_failed:.  
-00014c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ca0: 2020 6966 2073 6563 6f6e 645f 6665 7463    if second_fetc
-00014cb0: 685f 6661 696c 6564 3a0a 2020 2020 2020  h_failed:.      
-00014cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014cd0: 2020 2320 486f 7065 6675 6c6c 7920 636f    # Hopefully co
-00014ce0: 6465 206e 6576 6572 2063 6f6d 6573 2068  de never comes h
-00014cf0: 6572 650a 2020 2020 2020 2020 2020 2020  ere.            
-00014d00: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00014d10: 6520 6578 0a20 2020 2020 2020 2020 2020  e ex.           
-00014d20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00014d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d40: 2020 2020 2020 2023 2052 6571 7565 7374         # Request
-00014d50: 6564 2064 6174 6520 7261 6e67 6520 7761  ed date range wa
-00014d60: 7320 6a75 7374 2062 6566 6f72 6520 7374  s just before st
-00014d70: 6f63 6b20 6c69 7374 696e 6720 6461 7465  ock listing date
-00014d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014d90: 2020 2020 2020 2020 2020 2320 6275 7420            # but 
-00014da0: 7769 6465 7220 7261 6e67 6520 6372 6f73  wider range cros
-00014db0: 7365 7320 6f76 6572 2073 6f20 6361 6e20  ses over so can 
-00014dc0: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014de0: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
-00014df0: 2020 2065 6c69 6620 7365 6c66 2e69 6e74     elif self.int
-00014e00: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
-00014e10: 2020 2020 2020 2064 6620 3d20 7365 6c66         df = self
-00014e20: 2e5f 6665 7463 6859 6648 6973 746f 7279  ._fetchYfHistory
-00014e30: 5f64 6174 6552 616e 6765 2866 6574 6368  _dateRange(fetch
-00014e40: 5f73 7461 7274 2c20 6665 7463 685f 656e  _start, fetch_en
-00014e50: 642c 2070 7265 706f 7374 2c20 6465 6275  d, prepost, debu
-00014e60: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
-00014e70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014e80: 2020 2020 2020 2320 496e 7472 6164 6179        # Intraday
-00014e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014ea0: 2066 6574 6368 5f72 616e 6765 7320 3d20   fetch_ranges = 
-00014eb0: 5b28 6665 7463 685f 7374 6172 742c 2066  [(fetch_start, f
-00014ec0: 6574 6368 5f65 6e64 295d 0a20 2020 2020  etch_end)].     
-00014ed0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00014ee0: 6c66 2e69 6e74 7261 6461 793a 0a20 2020  lf.intraday:.   
-00014ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f00: 206d 6178 5261 6e67 6520 3d20 7966 6364   maxRange = yfcd
-00014f10: 2e79 664d 6178 4665 7463 6852 616e 6765  .yfMaxFetchRange
-00014f20: 5b73 656c 662e 696e 7465 7276 616c 5d0a  [self.interval].
-00014f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f40: 2020 2020 6966 206d 6178 5261 6e67 6520      if maxRange 
-00014f50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00014f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f70: 2020 2020 2074 645f 3164 203d 2074 696d       td_1d = tim
-00014f80: 6564 656c 7461 2864 6179 733d 3129 0a20  edelta(days=1). 
-00014f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014fa0: 2020 2020 2020 2074 645f 3134 6420 3d20         td_14d = 
-00014fb0: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
-00014fc0: 3429 0a20 2020 2020 2020 2020 2020 2020  4).             
-00014fd0: 2020 2020 2020 2020 2020 2073 203d 2079             s = y
-00014fe0: 6663 742e 4765 7445 7863 6861 6e67 6553  fct.GetExchangeS
-00014ff0: 6368 6564 756c 6528 7365 6c66 2e65 7863  chedule(self.exc
-00015000: 6861 6e67 652c 2073 7461 7274 5f64 742e  hange, start_dt.
-00015010: 6461 7465 2829 202d 2074 645f 3134 642c  date() - td_14d,
-00015020: 2065 6e64 5f64 742e 6461 7465 2829 202b   end_dt.date() +
-00015030: 2074 645f 3134 6429 0a20 2020 2020 2020   td_14d).       
-00015040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015050: 2073 5f6f 7269 6720 3d20 730a 2020 2020   s_orig = s.    
-00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015070: 2020 2020 7320 3d20 732e 696c 6f63 5b73      s = s.iloc[s
-00015080: 2e69 6e64 6578 2e67 6574 5f69 6e64 6578  .index.get_index
-00015090: 6572 285b 7374 7228 7374 6172 745f 6474  er([str(start_dt
-000150a0: 2e64 6174 6528 2929 5d2c 206d 6574 686f  .date())], metho
-000150b0: 643d 2266 6669 6c6c 2229 5b30 5d2d 313a  d="ffill")[0]-1:
-000150c0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000150d0: 2020 2020 2020 2020 2020 7320 3d20 732e            s = s.
-000150e0: 696c 6f63 5b3a 732e 696e 6465 782e 6765  iloc[:s.index.ge
-000150f0: 745f 696e 6465 7865 7228 5b73 7472 2865  t_indexer([str(e
-00015100: 6e64 5f64 742e 6461 7465 2829 295d 2c20  nd_dt.date())], 
-00015110: 6d65 7468 6f64 3d22 6266 696c 6c22 295b  method="bfill")[
-00015120: 305d 2b31 2b31 5d0a 2020 2020 2020 2020  0]+1+1].        
-00015130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015140: 6c61 6720 3d20 7966 6364 2e65 7863 6861  lag = yfcd.excha
-00015150: 6e67 6554 6f59 664c 6167 5b73 656c 662e  ngeToYfLag[self.
-00015160: 6578 6368 616e 6765 5d0a 2020 2020 2020  exchange].      
-00015170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015180: 2020 6966 2073 7461 7274 5f64 7420 3e20    if start_dt > 
-00015190: 735b 2263 6c6f 7365 225d 2e69 6c6f 635b  s["close"].iloc[
-000151a0: 315d 2b6c 6167 3a0a 2020 2020 2020 2020  1]+lag:.        
-000151b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151c0: 2020 2020 7320 3d20 732e 6472 6f70 2873      s = s.drop(s
-000151d0: 2e69 6e64 6578 5b30 5d29 0a20 2020 2020  .index[0]).     
-000151e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151f0: 2020 2069 6620 656e 645f 6474 203c 2073     if end_dt < s
-00015200: 5b22 6f70 656e 225d 2e69 6c6f 635b 2d32  ["open"].iloc[-2
-00015210: 5d2b 6c61 673a 0a20 2020 2020 2020 2020  ]+lag:.         
-00015220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015230: 2020 2073 203d 2073 2e64 726f 7028 732e     s = s.drop(s.
-00015240: 696e 6465 785b 2d31 5d29 0a20 2020 2020  index[-1]).     
-00015250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015260: 2020 2023 2066 6574 6368 5f72 616e 6765     # fetch_range
-00015270: 7320 3d20 7966 6375 2e43 6875 6e6b 4461  s = yfcu.ChunkDa
-00015280: 7465 7349 6e74 6f59 6646 6574 6368 6573  tesIntoYfFetches
-00015290: 2873 7461 7274 5f64 2c20 656e 645f 642c  (start_d, end_d,
-000152a0: 2073 2c20 6d61 7852 616e 6765 2e64 6179   s, maxRange.day
-000152b0: 732c 206f 7665 726c 6170 4461 7973 3d32  s, overlapDays=2
-000152c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000152d0: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
-000152e0: 7261 6e67 6573 203d 2079 6663 752e 4368  ranges = yfcu.Ch
-000152f0: 756e 6b44 6174 6573 496e 746f 5966 4665  unkDatesIntoYfFe
-00015300: 7463 6865 7328 732c 206d 6178 5261 6e67  tches(s, maxRang
-00015310: 652e 6461 7973 2c20 6f76 6572 6c61 7044  e.days, overlapD
-00015320: 6179 733d 3229 0a20 2020 2020 2020 2020  ays=2).         
-00015330: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015340: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
-00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015360: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-00015370: 2d20 6665 7463 685f 7261 6e67 6573 3a22  - fetch_ranges:"
-00015380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015390: 2020 2020 2020 2020 2020 2020 2020 7070                pp
-000153a0: 7269 6e74 2866 6574 6368 5f72 616e 6765  rint(fetch_range
-000153b0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-000153c0: 2020 2020 2020 2020 2020 2023 2044 6f6e             # Don
-000153d0: 2774 206e 6565 6420 746f 2066 6574 6368  't need to fetch
-000153e0: 2061 6c6c 206f 6620 7061 6464 696e 6720   all of padding 
-000153f0: 6461 7973 2c20 6a75 7374 2074 6865 2065  days, just the e
-00015400: 6e64 2f73 7461 7274 206f 6620 7365 7373  nd/start of sess
-00015410: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-00015420: 2020 2020 2020 2020 2020 2020 2320 6665              # fe
-00015430: 7463 685f 7261 6e67 6573 5b30 5d5b 305d  tch_ranges[0][0]
-00015440: 203d 2073 5b22 636c 6f73 6522 5d2e 696c   = s["close"].il
-00015450: 6f63 5b30 5d20 2d20 7469 6d65 6465 6c74  oc[0] - timedelt
-00015460: 6128 686f 7572 733d 3229 0a20 2020 2020  a(hours=2).     
-00015470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015480: 2020 2023 2066 6574 6368 5f72 616e 6765     # fetch_range
-00015490: 735b 2d31 5d5b 315d 203d 2073 5b22 6f70  s[-1][1] = s["op
-000154a0: 656e 225d 2e69 6c6f 635b 2d31 5d20 2b20  en"].iloc[-1] + 
-000154b0: 7469 6d65 6465 6c74 6128 686f 7572 733d  timedelta(hours=
-000154c0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-000154d0: 2020 2020 2020 2020 2020 2023 2066 6574             # fet
-000154e0: 6368 5f72 616e 6765 735b 305d 5b22 6665  ch_ranges[0]["fe
-000154f0: 7463 6820 7374 6172 7422 5d20 3d20 735b  tch start"] = s[
-00015500: 2263 6c6f 7365 225d 2e69 6c6f 635b 305d  "close"].iloc[0]
-00015510: 202d 2074 696d 6564 656c 7461 2868 6f75   - timedelta(hou
-00015520: 7273 3d32 290a 2020 2020 2020 2020 2020  rs=2).          
-00015530: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015540: 5570 6461 7465 3a20 6e65 6564 2073 7461  Update: need sta
-00015550: 7274 2066 7572 7468 6572 2062 6163 6b20  rt further back 
-00015560: 666f 7220 6c6f 772d 766f 6c75 6d65 2074  for low-volume t
-00015570: 6963 6b65 7273 0a20 2020 2020 2020 2020  ickers.         
-00015580: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00015590: 6574 6368 5f72 616e 6765 735b 305d 5b22  etch_ranges[0]["
-000155a0: 6665 7463 6820 7374 6172 7422 5d20 3d20  fetch start"] = 
-000155b0: 735b 226f 7065 6e22 5d2e 696c 6f63 5b30  s["open"].iloc[0
-000155c0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000155d0: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
-000155e0: 7261 6e67 6573 5b2d 315d 5b22 6665 7463  ranges[-1]["fetc
-000155f0: 6820 656e 6422 5d20 3d20 735b 226f 7065  h end"] = s["ope
-00015600: 6e22 5d2e 696c 6f63 5b2d 315d 202b 2074  n"].iloc[-1] + t
-00015610: 696d 6564 656c 7461 2868 6f75 7273 3d32  imedelta(hours=2
-00015620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015630: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-00015640: 7428 222d 2066 6574 6368 5f72 616e 6765  t("- fetch_range
-00015650: 733a 2229 0a20 2020 2020 2020 2020 2020  s:").           
-00015660: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-00015670: 7072 696e 7428 6665 7463 685f 7261 6e67  print(fetch_rang
-00015680: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-00015690: 2020 2020 2020 2020 2020 2020 6d61 784c              maxL
-000156a0: 6f6f 6b62 6163 6b20 3d20 7966 6364 2e79  ookback = yfcd.y
-000156b0: 664d 6178 4665 7463 684c 6f6f 6b62 6163  fMaxFetchLookbac
-000156c0: 6b5b 7365 6c66 2e69 6e74 6572 7661 6c5d  k[self.interval]
-000156d0: 202d 2074 696d 6564 656c 7461 2873 6563   - timedelta(sec
-000156e0: 6f6e 6473 3d31 3029 0a20 2020 2020 2020  onds=10).       
-000156f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015700: 2069 6620 6d61 784c 6f6f 6b62 6163 6b20   if maxLookback 
-00015710: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00015720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015730: 2020 2020 2020 2020 206d 6178 4c6f 6f6b           maxLook
-00015740: 6261 636b 5f64 7420 3d20 2864 745f 6e6f  back_dt = (dt_no
-00015750: 7720 2d20 6d61 784c 6f6f 6b62 6163 6b29  w - maxLookback)
-00015760: 2e74 7a5f 636f 6e76 6572 7428 747a 5f65  .tz_convert(tz_e
-00015770: 7863 6861 6e67 6529 0a20 2020 2020 2020  xchange).       
-00015780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015790: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-000157a0: 6e67 6528 6c65 6e28 6665 7463 685f 7261  nge(len(fetch_ra
-000157b0: 6e67 6573 292d 312c 202d 312c 202d 3129  nges)-1, -1, -1)
-000157c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000157d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157e0: 2020 6966 2066 6574 6368 5f72 616e 6765    if fetch_range
-000157f0: 735b 695d 5b22 6665 7463 6820 7374 6172  s[i]["fetch star
-00015800: 7422 5d20 3c20 6d61 784c 6f6f 6b62 6163  t"] < maxLookbac
-00015810: 6b5f 6474 3a0a 2020 2020 2020 2020 2020  k_dt:.          
-00015820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015830: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
-00015840: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
-00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c30: 2020 2020 2020 2069 6620 2244 6174 6120         if "Data 
+00014c40: 646f 6573 6e27 7420 6578 6973 7420 666f  doesn't exist fo
+00014c50: 7220 7374 6172 7444 6174 6522 2069 6e20  r startDate" in 
+00014c60: 7374 7228 6529 3a0a 2020 2020 2020 2020  str(e):.        
+00014c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c80: 2020 2020 7365 636f 6e64 5f66 6574 6368      second_fetch
+00014c90: 5f66 6169 6c65 6420 3d20 5472 7565 0a20  _failed = True. 
+00014ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014cb0: 2020 2020 2020 2065 6c69 6620 224e 6f20         elif "No 
+00014cc0: 6461 7461 2066 6f75 6e64 2066 6f72 2074  data found for t
+00014cd0: 6869 7320 6461 7465 2072 616e 6765 2220  his date range" 
+00014ce0: 696e 2073 7472 2865 293a 0a20 2020 2020  in str(e):.     
+00014cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d00: 2020 2020 2020 2073 6563 6f6e 645f 6665         second_fe
+00014d10: 7463 685f 6661 696c 6564 203d 2054 7275  tch_failed = Tru
+00014d20: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00014d30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00014d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d50: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00014d60: 6520 650a 0a20 2020 2020 2020 2020 2020  e e..           
+00014d70: 2020 2020 2020 2020 2069 6620 6466 5f77           if df_w
+00014d80: 6964 6572 2069 7320 6e6f 7420 4e6f 6e65  ider is not None
+00014d90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014da0: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00014db0: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+00014dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014dd0: 2020 2020 7072 696e 7428 222d 2064 6574      print("- det
+00014de0: 6563 7465 6420 6c69 7374 696e 6720 6461  ected listing da
+00014df0: 7465 203d 222c 2064 665f 7769 6465 722e  te =", df_wider.
+00014e00: 696e 6465 785b 305d 2e64 6174 6528 2929  index[0].date())
+00014e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014e20: 2020 2020 2020 2020 2079 6663 6d2e 5374           yfcm.St
+00014e30: 6f72 6543 6163 6865 4461 7475 6d28 7365  oreCacheDatum(se
+00014e40: 6c66 2e74 6963 6b65 722c 2022 6c69 7374  lf.ticker, "list
+00014e50: 696e 675f 6461 7465 222c 2064 665f 7769  ing_date", df_wi
+00014e60: 6465 722e 696e 6465 785b 305d 2e64 6174  der.index[0].dat
+00014e70: 6528 2929 0a20 2020 2020 2020 2020 2020  e()).           
+00014e80: 2020 2020 2020 2020 2020 2020 2064 6620               df 
+00014e90: 3d20 6466 5f77 6964 6572 0a20 2020 2020  = df_wider.     
+00014ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014eb0: 2020 2069 6620 6665 7463 685f 7374 6172     if fetch_star
+00014ec0: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ee0: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
+00014ef0: 6466 2e6c 6f63 5b66 6574 6368 5f73 7461  df.loc[fetch_sta
+00014f00: 7274 5f64 743a 5d0a 2020 2020 2020 2020  rt_dt:].        
+00014f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f20: 6966 2066 6574 6368 5f65 6e64 2069 7320  if fetch_end is 
+00014f30: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00014f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f50: 2020 2020 2020 6466 203d 2064 662e 6c6f        df = df.lo
+00014f60: 635b 3a66 6574 6368 5f65 6e64 5f64 742d  c[:fetch_end_dt-
+00014f70: 7469 6d65 6465 6c74 6128 6d69 6c6c 6973  timedelta(millis
+00014f80: 6563 6f6e 6473 3d31 295d 0a0a 2020 2020  econds=1)]..    
+00014f90: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00014fa0: 6972 7374 5f66 6574 6368 5f66 6169 6c65  irst_fetch_faile
+00014fb0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00014fc0: 2020 2020 2020 2069 6620 7365 636f 6e64         if second
+00014fd0: 5f66 6574 6368 5f66 6169 6c65 643a 0a20  _fetch_failed:. 
+00014fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ff0: 2020 2020 2020 2023 2048 6f70 6566 756c         # Hopeful
+00015000: 6c79 2063 6f64 6520 6e65 7665 7220 636f  ly code never co
+00015010: 6d65 7320 6865 7265 0a20 2020 2020 2020  mes here.       
+00015020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015030: 2072 6169 7365 2065 780a 2020 2020 2020   raise ex.      
+00015040: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00015050: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00015060: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00015070: 7175 6573 7465 6420 6461 7465 2072 616e  quested date ran
+00015080: 6765 2077 6173 206a 7573 7420 6265 666f  ge was just befo
+00015090: 7265 2073 746f 636b 206c 6973 7469 6e67  re stock listing
+000150a0: 2064 6174 652c 0a20 2020 2020 2020 2020   date,.         
+000150b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000150c0: 2062 7574 2077 6964 6572 2072 616e 6765   but wider range
+000150d0: 2063 726f 7373 6573 206f 7665 7220 736f   crosses over so
+000150e0: 2063 616e 2063 6f6e 7469 6e75 650a 2020   can continue.  
+000150f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015100: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
+00015110: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+00015120: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
+00015130: 2020 2020 2020 2020 2020 2020 2320 4164              # Ad
+00015140: 6420 7061 6464 696e 6720 6461 7973 2074  d padding days t
+00015150: 6f20 656e 7375 7265 2059 6168 6f6f 2072  o ensure Yahoo r
+00015160: 6574 7572 6e73 2063 6f72 7265 6374 2056  eturns correct V
+00015170: 6f6c 756d 650a 2020 2020 2020 2020 2020  olume.          
+00015180: 2020 2020 2020 7320 3d20 7966 6374 2e47        s = yfct.G
+00015190: 6574 4578 6368 616e 6765 5363 6865 6475  etExchangeSchedu
+000151a0: 6c65 2873 656c 662e 6578 6368 616e 6765  le(self.exchange
+000151b0: 2c20 6665 7463 685f 7374 6172 7420 2d20  , fetch_start - 
+000151c0: 322a 7365 6c66 2e69 7464 2c20 6665 7463  2*self.itd, fetc
+000151d0: 685f 656e 6420 2b20 322a 7365 6c66 2e69  h_end + 2*self.i
+000151e0: 7464 290a 2020 2020 2020 2020 2020 2020  td).            
+000151f0: 2020 2020 6665 7463 685f 7374 6172 745f      fetch_start_
+00015200: 7061 6420 3d20 732e 696c 6f63 5b73 2e69  pad = s.iloc[s.i
+00015210: 6e64 6578 2e67 6574 5f69 6e64 6578 6572  ndex.get_indexer
+00015220: 285b 7374 7228 6665 7463 685f 7374 6172  ([str(fetch_star
+00015230: 7429 5d2c 206d 6574 686f 643d 2266 6669  t)], method="ffi
+00015240: 6c6c 2229 5b30 5d2d 315d 2e6e 616d 652e  ll")[0]-1].name.
+00015250: 6461 7465 2829 0a20 2020 2020 2020 2020  date().         
+00015260: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
+00015270: 5f70 6164 2020 203d 2073 2e69 6c6f 635b  _pad   = s.iloc[
+00015280: 732e 696e 6465 782e 6765 745f 696e 6465  s.index.get_inde
+00015290: 7865 7228 5b73 7472 2866 6574 6368 5f65  xer([str(fetch_e
+000152a0: 6e64 295d 2c20 6d65 7468 6f64 3d22 6266  nd)], method="bf
+000152b0: 696c 6c22 295b 305d 2b31 5d2e 6e61 6d65  ill")[0]+1].name
+000152c0: 2e64 6174 6528 290a 0a20 2020 2020 2020  .date()..       
+000152d0: 2020 2020 2020 2020 2064 6620 3d20 7365           df = se
+000152e0: 6c66 2e5f 6665 7463 6859 6648 6973 746f  lf._fetchYfHisto
+000152f0: 7279 5f64 6174 6552 616e 6765 2866 6574  ry_dateRange(fet
+00015300: 6368 5f73 7461 7274 5f70 6164 2c20 6665  ch_start_pad, fe
+00015310: 7463 685f 656e 645f 7061 642c 2070 7265  tch_end_pad, pre
+00015320: 706f 7374 2c20 6465 6275 6729 0a20 2020  post, debug).   
+00015330: 2020 2020 2020 2020 2020 2020 2064 6620               df 
+00015340: 3d20 6466 2e6c 6f63 5b73 7472 2866 6574  = df.loc[str(fet
+00015350: 6368 5f73 7461 7274 2920 3a20 7374 7228  ch_start) : str(
+00015360: 6665 7463 685f 656e 642d 7464 5f31 6429  fetch_end-td_1d)
+00015370: 5d2e 636f 7079 2829 0a0a 2020 2020 2020  ].copy()..      
+00015380: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00015390: 2020 2020 2020 2020 2020 2020 2320 496e              # In
+000153a0: 7472 6164 6179 0a20 2020 2020 2020 2020  traday.         
+000153b0: 2020 2020 2020 2066 6574 6368 5f72 616e         fetch_ran
+000153c0: 6765 7320 3d20 5b28 6665 7463 685f 7374  ges = [(fetch_st
+000153d0: 6172 742c 2066 6574 6368 5f65 6e64 295d  art, fetch_end)]
+000153e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000153f0: 2069 6620 7365 6c66 2e69 6e74 7261 6461   if self.intrada
+00015400: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00015410: 2020 2020 2020 2023 2041 6464 2070 6164         # Add pad
+00015420: 6469 6e67 2064 6179 7320 746f 2065 6e73  ding days to ens
+00015430: 7572 6520 5961 686f 6f20 7265 7475 726e  ure Yahoo return
+00015440: 7320 636f 7272 6563 7420 566f 6c75 6d65  s correct Volume
+00015450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015460: 2020 2020 206d 6178 5261 6e67 6520 3d20       maxRange = 
+00015470: 7966 6364 2e79 664d 6178 4665 7463 6852  yfcd.yfMaxFetchR
+00015480: 616e 6765 5b73 656c 662e 696e 7465 7276  ange[self.interv
+00015490: 616c 5d0a 2020 2020 2020 2020 2020 2020  al].            
+000154a0: 2020 2020 2020 2020 6966 206d 6178 5261          if maxRa
+000154b0: 6e67 6520 6973 206e 6f74 204e 6f6e 653a  nge is not None:
+000154c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000154d0: 2020 2020 2020 2020 2073 203d 2079 6663           s = yfc
+000154e0: 742e 4765 7445 7863 6861 6e67 6553 6368  t.GetExchangeSch
+000154f0: 6564 756c 6528 7365 6c66 2e65 7863 6861  edule(self.excha
+00015500: 6e67 652c 2073 7461 7274 5f64 742e 6461  nge, start_dt.da
+00015510: 7465 2829 202d 2074 645f 3134 642c 2065  te() - td_14d, e
+00015520: 6e64 5f64 742e 6461 7465 2829 202b 2074  nd_dt.date() + t
+00015530: 645f 3134 6429 0a20 2020 2020 2020 2020  d_14d).         
+00015540: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00015550: 203d 2073 2e69 6c6f 635b 732e 696e 6465   = s.iloc[s.inde
+00015560: 782e 6765 745f 696e 6465 7865 7228 5b73  x.get_indexer([s
+00015570: 7472 2873 7461 7274 5f64 742e 6461 7465  tr(start_dt.date
+00015580: 2829 295d 2c20 6d65 7468 6f64 3d22 6666  ())], method="ff
+00015590: 696c 6c22 295b 305d 2d31 3a5d 0a20 2020  ill")[0]-1:].   
+000155a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155b0: 2020 2020 2073 203d 2073 2e69 6c6f 635b       s = s.iloc[
+000155c0: 3a73 2e69 6e64 6578 2e67 6574 5f69 6e64  :s.index.get_ind
+000155d0: 6578 6572 285b 7374 7228 656e 645f 6474  exer([str(end_dt
+000155e0: 2e64 6174 6528 2929 5d2c 206d 6574 686f  .date())], metho
+000155f0: 643d 2262 6669 6c6c 2229 5b30 5d2b 312b  d="bfill")[0]+1+
+00015600: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+00015610: 2020 2020 2020 2020 2020 206c 6167 203d             lag =
+00015620: 2079 6663 642e 6578 6368 616e 6765 546f   yfcd.exchangeTo
+00015630: 5966 4c61 675b 7365 6c66 2e65 7863 6861  YfLag[self.excha
+00015640: 6e67 655d 0a20 2020 2020 2020 2020 2020  nge].           
+00015650: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00015660: 7374 6172 745f 6474 203e 2073 5b22 636c  start_dt > s["cl
+00015670: 6f73 6522 5d2e 696c 6f63 5b31 5d2b 6c61  ose"].iloc[1]+la
+00015680: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00015690: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000156a0: 203d 2073 2e64 726f 7028 732e 696e 6465   = s.drop(s.inde
+000156b0: 785b 305d 290a 2020 2020 2020 2020 2020  x[0]).          
+000156c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000156d0: 2065 6e64 5f64 7420 3c20 735b 226f 7065   end_dt < s["ope
+000156e0: 6e22 5d2e 696c 6f63 5b2d 325d 2b6c 6167  n"].iloc[-2]+lag
+000156f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015700: 2020 2020 2020 2020 2020 2020 2020 7320                s 
+00015710: 3d20 732e 6472 6f70 2873 2e69 6e64 6578  = s.drop(s.index
+00015720: 5b2d 315d 290a 2020 2020 2020 2020 2020  [-1]).          
+00015730: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015740: 6665 7463 685f 7261 6e67 6573 203d 2079  fetch_ranges = y
+00015750: 6663 752e 4368 756e 6b44 6174 6573 496e  fcu.ChunkDatesIn
+00015760: 746f 5966 4665 7463 6865 7328 7374 6172  toYfFetches(star
+00015770: 745f 642c 2065 6e64 5f64 2c20 732c 206d  t_d, end_d, s, m
+00015780: 6178 5261 6e67 652e 6461 7973 2c20 6f76  axRange.days, ov
+00015790: 6572 6c61 7044 6179 733d 3229 0a20 2020  erlapDays=2).   
+000157a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000157b0: 2020 2020 2066 6574 6368 5f72 616e 6765       fetch_range
+000157c0: 7320 3d20 7966 6375 2e43 6875 6e6b 4461  s = yfcu.ChunkDa
+000157d0: 7465 7349 6e74 6f59 6646 6574 6368 6573  tesIntoYfFetches
+000157e0: 2873 2c20 6d61 7852 616e 6765 2e64 6179  (s, maxRange.day
+000157f0: 732c 206f 7665 726c 6170 4461 7973 3d32  s, overlapDays=2
+00015800: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015810: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
+00015820: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
+00015830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015840: 2020 2020 7072 696e 7428 222d 2066 6574      print("- fet
+00015850: 6368 5f72 616e 6765 733a 2229 0a20 2020  ch_ranges:").   
 00015860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015870: 7072 696e 7428 222d 2063 6170 7069 6e67  print("- capping
-00015880: 2073 7461 7274 2074 6f20 6d61 784c 6f6f   start to maxLoo
-00015890: 6b62 6163 6b5f 6474 2229 0a20 2020 2020  kback_dt").     
-000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000158c0: 2066 6574 6368 5f72 616e 6765 735b 695d   fetch_ranges[i]
-000158d0: 5b22 6665 7463 6820 7374 6172 7422 5d20  ["fetch start"] 
-000158e0: 3d20 6d61 784c 6f6f 6b62 6163 6b5f 6474  = maxLookback_dt
-000158f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015910: 2020 2020 2066 6574 6368 5f72 616e 6765       fetch_range
-00015920: 735b 695d 5b22 6665 7463 6820 7374 6172  s[i]["fetch star
-00015930: 7422 5d20 3d20 6d61 784c 6f6f 6b62 6163  t"] = maxLookbac
-00015940: 6b5f 6474 2e63 6569 6c28 2244 2229 0a20  k_dt.ceil("D"). 
-00015950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015970: 2020 2066 6574 6368 5f72 616e 6765 735b     fetch_ranges[
-00015980: 695d 5b22 636f 7265 2073 7461 7274 225d  i]["core start"]
-00015990: 203d 2066 6574 6368 5f72 616e 6765 735b   = fetch_ranges[
-000159a0: 695d 5b22 6665 7463 6820 7374 6172 7422  i]["fetch start"
-000159b0: 5d20 2b20 7464 5f31 640a 2020 2020 2020  ] + td_1d.      
-000159c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000159d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000159e0: 2066 6574 6368 5f72 616e 6765 735b 695d   fetch_ranges[i]
-000159f0: 5b22 6665 7463 6820 7374 6172 7422 5d20  ["fetch start"] 
-00015a00: 3e3d 2066 6574 6368 5f72 616e 6765 735b  >= fetch_ranges[
-00015a10: 695d 5b22 6665 7463 6820 656e 6422 5d3a  i]["fetch end"]:
-00015a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a40: 2020 2020 2020 2020 2064 656c 2066 6574           del fet
-00015a50: 6368 5f72 616e 6765 735b 695d 0a0a 2020  ch_ranges[i]..  
-00015a60: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00015a70: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00015a80: 2020 2020 2020 2020 666f 7220 7220 696e          for r in
-00015a90: 2066 6574 6368 5f72 616e 6765 733a 0a20   fetch_ranges:. 
+00015870: 2020 2020 2020 2020 2070 7072 696e 7428           pprint(
+00015880: 6665 7463 685f 7261 6e67 6573 290a 2020  fetch_ranges).  
+00015890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158a0: 2020 2020 2020 2320 446f 6e27 7420 6e65        # Don't ne
+000158b0: 6564 2074 6f20 6665 7463 6820 616c 6c20  ed to fetch all 
+000158c0: 6f66 2070 6164 6469 6e67 2064 6179 732c  of padding days,
+000158d0: 206a 7573 7420 7468 6520 656e 642f 7374   just the end/st
+000158e0: 6172 7420 6f66 2073 6573 7369 6f6e 0a20  art of session. 
+000158f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015900: 2020 2020 2020 2023 2066 6574 6368 5f72         # fetch_r
+00015910: 616e 6765 735b 305d 5b30 5d20 3d20 735b  anges[0][0] = s[
+00015920: 2263 6c6f 7365 225d 2e69 6c6f 635b 305d  "close"].iloc[0]
+00015930: 202d 2074 696d 6564 656c 7461 2868 6f75   - timedelta(hou
+00015940: 7273 3d32 290a 2020 2020 2020 2020 2020  rs=2).          
+00015950: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015960: 6665 7463 685f 7261 6e67 6573 5b2d 315d  fetch_ranges[-1]
+00015970: 5b31 5d20 3d20 735b 226f 7065 6e22 5d2e  [1] = s["open"].
+00015980: 696c 6f63 5b2d 315d 202b 2074 696d 6564  iloc[-1] + timed
+00015990: 656c 7461 2868 6f75 7273 3d32 290a 2020  elta(hours=2).  
+000159a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000159b0: 2020 2020 2020 2320 6665 7463 685f 7261        # fetch_ra
+000159c0: 6e67 6573 5b30 5d5b 2266 6574 6368 2073  nges[0]["fetch s
+000159d0: 7461 7274 225d 203d 2073 5b22 636c 6f73  tart"] = s["clos
+000159e0: 6522 5d2e 696c 6f63 5b30 5d20 2d20 7469  e"].iloc[0] - ti
+000159f0: 6d65 6465 6c74 6128 686f 7572 733d 3229  medelta(hours=2)
+00015a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015a10: 2020 2020 2020 2020 2023 2055 7064 6174           # Updat
+00015a20: 653a 206e 6565 6420 7374 6172 7420 6675  e: need start fu
+00015a30: 7274 6865 7220 6261 636b 2066 6f72 206c  rther back for l
+00015a40: 6f77 2d76 6f6c 756d 6520 7469 636b 6572  ow-volume ticker
+00015a50: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00015a60: 2020 2020 2020 2020 2020 6665 7463 685f            fetch_
+00015a70: 7261 6e67 6573 5b30 5d5b 2266 6574 6368  ranges[0]["fetch
+00015a80: 2073 7461 7274 225d 203d 2073 5b22 6f70   start"] = s["op
+00015a90: 656e 225d 2e69 6c6f 635b 305d 0a20 2020  en"].iloc[0].   
 00015aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ab0: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
-00015ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ad0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-00015ae0: 2d20 6665 7463 6869 6e67 3a22 290a 2020  - fetching:").  
-00015af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b00: 2020 2020 2020 7072 696e 7428 7229 0a20        print(r). 
-00015b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b20: 2020 2066 6574 6368 5f73 7461 7274 203d     fetch_start =
-00015b30: 2072 5b22 6665 7463 6820 7374 6172 7422   r["fetch start"
-00015b40: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00015b50: 2020 2020 2020 6665 7463 685f 656e 6420        fetch_end 
-00015b60: 3d20 725b 2266 6574 6368 2065 6e64 225d  = r["fetch end"]
-00015b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b80: 2020 2020 2064 6672 203d 2073 656c 662e       dfr = self.
-00015b90: 5f66 6574 6368 5966 4869 7374 6f72 795f  _fetchYfHistory_
-00015ba0: 6461 7465 5261 6e67 6528 6665 7463 685f  dateRange(fetch_
-00015bb0: 7374 6172 742c 2066 6574 6368 5f65 6e64  start, fetch_end
-00015bc0: 2c20 7072 6570 6f73 742c 2064 6562 7567  , prepost, debug
-00015bd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015be0: 2020 2020 2020 2320 4469 7363 6172 6420        # Discard 
-00015bf0: 7061 6464 696e 6720 6461 7973 3a0a 2020  padding days:.  
+00015ab0: 2020 2020 2066 6574 6368 5f72 616e 6765       fetch_range
+00015ac0: 735b 2d31 5d5b 2266 6574 6368 2065 6e64  s[-1]["fetch end
+00015ad0: 225d 203d 2073 5b22 6f70 656e 225d 2e69  "] = s["open"].i
+00015ae0: 6c6f 635b 2d31 5d20 2b20 7469 6d65 6465  loc[-1] + timede
+00015af0: 6c74 6128 686f 7572 733d 3229 0a20 2020  lta(hours=2).   
+00015b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b10: 2020 2020 2023 2070 7269 6e74 2822 2d20       # print("- 
+00015b20: 6665 7463 685f 7261 6e67 6573 3a22 290a  fetch_ranges:").
+00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b40: 2020 2020 2020 2020 2320 7070 7269 6e74          # pprint
+00015b50: 2866 6574 6368 5f72 616e 6765 7329 0a20  (fetch_ranges). 
+00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b70: 2020 2020 2020 206d 6178 4c6f 6f6b 6261         maxLookba
+00015b80: 636b 203d 2079 6663 642e 7966 4d61 7846  ck = yfcd.yfMaxF
+00015b90: 6574 6368 4c6f 6f6b 6261 636b 5b73 656c  etchLookback[sel
+00015ba0: 662e 696e 7465 7276 616c 5d20 2d20 7469  f.interval] - ti
+00015bb0: 6d65 6465 6c74 6128 7365 636f 6e64 733d  medelta(seconds=
+00015bc0: 3130 290a 2020 2020 2020 2020 2020 2020  10).            
+00015bd0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00015be0: 6178 4c6f 6f6b 6261 636b 2069 7320 6e6f  axLookback is no
+00015bf0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
 00015c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c10: 2020 6466 7220 3d20 6466 722e 6c6f 635b    dfr = dfr.loc[
-00015c20: 725b 2263 6f72 6520 7374 6172 7422 5d3a  r["core start"]:
-00015c30: 2072 5b22 636f 7265 2065 6e64 225d 202d   r["core end"] -
-00015c40: 2074 696d 6564 656c 7461 286d 696c 6c69   timedelta(milli
-00015c50: 7365 636f 6e64 733d 3129 5d0a 2020 2020  seconds=1)].    
+00015c10: 2020 2020 6d61 784c 6f6f 6b62 6163 6b5f      maxLookback_
+00015c20: 6474 203d 2028 6474 5f6e 6f77 202d 206d  dt = (dt_now - m
+00015c30: 6178 4c6f 6f6b 6261 636b 292e 747a 5f63  axLookback).tz_c
+00015c40: 6f6e 7665 7274 2874 7a5f 6578 6368 616e  onvert(tz_exchan
+00015c50: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
 00015c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c70: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-00015c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c90: 2020 2020 2020 7072 696e 7428 222d 2064        print("- d
-00015ca0: 6672 2061 6674 6572 2064 6973 6361 7264  fr after discard
-00015cb0: 696e 6720 7061 6464 696e 6720 6461 7973  ing padding days
-00015cc0: 3a22 290a 2020 2020 2020 2020 2020 2020  :").            
-00015cd0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00015ce0: 7428 6466 725b 5b63 2066 6f72 2063 2069  t(dfr[[c for c i
-00015cf0: 6e20 5b22 4f70 656e 222c 2022 4c6f 7722  n ["Open", "Low"
-00015d00: 2c20 2248 6967 6822 2c20 2243 6c6f 7365  , "High", "Close
-00015d10: 222c 2022 4469 7669 6465 6e64 7322 2c20  ", "Dividends", 
-00015d20: 2256 6f6c 756d 6522 5d20 6966 2063 2069  "Volume"] if c i
-00015d30: 6e20 6466 722e 636f 6c75 6d6e 735d 5d29  n dfr.columns]])
-00015d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d50: 2020 2020 2069 6620 6466 2069 7320 4e6f       if df is No
-00015d60: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00015d70: 2020 2020 2020 2020 2020 2020 6466 203d              df =
-00015d80: 2064 6672 0a20 2020 2020 2020 2020 2020   dfr.           
-00015d90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015db0: 2020 2020 2020 2064 6620 3d20 7064 2e63         df = pd.c
-00015dc0: 6f6e 6361 7428 5b64 662c 2064 6672 5d2c  oncat([df, dfr],
-00015dd0: 2073 6f72 743d 5472 7565 290a 2020 2020   sort=True).    
+00015c70: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+00015c80: 656e 2866 6574 6368 5f72 616e 6765 7329  en(fetch_ranges)
+00015c90: 2d31 2c20 2d31 2c20 2d31 293a 0a20 2020  -1, -1, -1):.   
+00015ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015cb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00015cc0: 6665 7463 685f 7261 6e67 6573 5b69 5d5b  fetch_ranges[i][
+00015cd0: 2266 6574 6368 2073 7461 7274 225d 203c  "fetch start"] <
+00015ce0: 206d 6178 4c6f 6f6b 6261 636b 5f64 743a   maxLookback_dt:
+00015cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d10: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
+00015d20: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d40: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00015d50: 2822 2d20 6361 7070 696e 6720 7374 6172  ("- capping star
+00015d60: 7420 746f 206d 6178 4c6f 6f6b 6261 636b  t to maxLookback
+00015d70: 5f64 7422 290a 2020 2020 2020 2020 2020  _dt").          
+00015d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d90: 2020 2020 2020 2020 2020 2320 6665 7463            # fetc
+00015da0: 685f 7261 6e67 6573 5b69 5d5b 2266 6574  h_ranges[i]["fet
+00015db0: 6368 2073 7461 7274 225d 203d 206d 6178  ch start"] = max
+00015dc0: 4c6f 6f6b 6261 636b 5f64 740a 2020 2020  Lookback_dt.    
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015df0: 6966 2064 662e 696e 6465 782e 6475 706c  if df.index.dupl
-00015e00: 6963 6174 6564 2829 2e61 6e79 2829 3a0a  icated().any():.
-00015e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e20: 2020 2020 2020 2020 7261 6973 6520 4578          raise Ex
-00015e30: 6365 7074 696f 6e28 2264 6620 636f 6e74  ception("df cont
-00015e40: 6169 6e73 2064 7570 6c69 6361 7465 6420  ains duplicated 
-00015e50: 6461 7465 7322 290a 0a20 2020 2020 2020  dates")..       
-00015e60: 2066 6574 6368 5f64 745f 7574 6320 3d20   fetch_dt_utc = 
-00015e70: 7064 2e54 696d 6573 7461 6d70 2e75 7463  pd.Timestamp.utc
-00015e80: 6e6f 7728 292e 747a 5f63 6f6e 7665 7274  now().tz_convert
-00015e90: 285a 6f6e 6549 6e66 6f28 2255 5443 2229  (ZoneInfo("UTC")
-00015ea0: 290a 0a20 2020 2020 2020 2069 6620 2864  )..        if (d
-00015eb0: 6620 6973 206e 6f74 204e 6f6e 6529 2061  f is not None) a
-00015ec0: 6e64 2028 6466 2e69 6e64 6578 2e74 7a20  nd (df.index.tz 
-00015ed0: 6973 206e 6f74 204e 6f6e 6529 2061 6e64  is not None) and
-00015ee0: 2028 6e6f 7420 6973 696e 7374 616e 6365   (not isinstance
-00015ef0: 2864 662e 696e 6465 782e 747a 2c20 5a6f  (df.index.tz, Zo
-00015f00: 6e65 496e 666f 2929 3a0a 2020 2020 2020  neInfo)):.      
-00015f10: 2020 2020 2020 2320 436f 6e76 6572 7420        # Convert 
-00015f20: 746f 205a 6f6e 6549 6e66 6f0a 2020 2020  to ZoneInfo.    
-00015f30: 2020 2020 2020 2020 6466 2e69 6e64 6578          df.index
-00015f40: 203d 2064 662e 696e 6465 782e 747a 5f63   = df.index.tz_c
-00015f50: 6f6e 7665 7274 2874 7a5f 6578 6368 616e  onvert(tz_exchan
-00015f60: 6765 290a 0a20 2020 2020 2020 2069 6620  ge)..        if 
-00015f70: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
-00015f80: 2020 2020 2020 2069 6620 6466 2069 7320         if df is 
-00015f90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00015fa0: 2020 2020 2020 6d73 6720 3d20 222d 2059        msg = "- Y
-00015fb0: 4620 7265 7475 726e 6564 204e 6f6e 6522  F returned None"
-00015fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015fd0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
-00015fe0: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
-00015ff0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-00016000: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
-00016010: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00016020: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00016030: 2020 2023 2070 6173 730a 2020 2020 2020     # pass.      
-00016040: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-00016050: 222d 2059 4620 7265 7475 726e 6564 2074  "- YF returned t
-00016060: 6162 6c65 3a22 0a20 2020 2020 2020 2020  able:".         
-00016070: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00016080: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
-00016090: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-000160a0: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
-000160b0: 7428 6d73 6729 0a20 2020 2020 2020 2020  t(msg).         
-000160c0: 2020 2020 2020 2070 7269 6e74 2864 665b         print(df[
-000160d0: 5b63 2066 6f72 2063 2069 6e20 5b22 4f70  [c for c in ["Op
-000160e0: 656e 222c 2022 4c6f 7722 2c20 2248 6967  en", "Low", "Hig
-000160f0: 6822 2c20 2243 6c6f 7365 222c 2022 4469  h", "Close", "Di
-00016100: 7669 6465 6e64 7322 2c20 2256 6f6c 756d  vidends", "Volum
-00016110: 6522 5d20 6966 2063 2069 6e20 6466 2e63  e"] if c in df.c
-00016120: 6f6c 756d 6e73 5d5d 290a 0a20 2020 2020  olumns]])..     
-00016130: 2020 2023 2044 6574 6563 7420 6c69 7374     # Detect list
-00016140: 696e 6720 6461 790a 2020 2020 2020 2020  ing day.        
-00016150: 6c69 7374 696e 675f 6461 7920 3d20 7966  listing_day = yf
-00016160: 636d 2e52 6561 6443 6163 6865 4461 7475  cm.ReadCacheDatu
-00016170: 6d28 7365 6c66 2e74 6963 6b65 722c 2022  m(self.ticker, "
-00016180: 6c69 7374 696e 675f 6461 7465 2229 0a20  listing_date"). 
-00016190: 2020 2020 2020 2069 6620 6c69 7374 696e         if listin
-000161a0: 675f 6461 7920 6973 204e 6f6e 653a 0a20  g_day is None:. 
-000161b0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000161c0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-000161d0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-000161e0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-000161f0: 2020 2020 666f 756e 645f 6c69 7374 696e      found_listin
-00016200: 675f 6461 7920 3d20 4661 6c73 650a 2020  g_day = False.  
-00016210: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00016220: 7374 696e 675f 6461 7920 3d20 4e6f 6e65  sting_day = None
-00016230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016240: 2069 6620 6466 2069 7320 6e6f 7420 4e6f   if df is not No
-00016250: 6e65 2061 6e64 206e 6f74 2064 662e 656d  ne and not df.em
-00016260: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
-00016270: 2020 2020 2020 2020 2069 6620 7073 7472           if pstr
-00016280: 203d 3d20 226d 6178 223a 0a20 2020 2020   == "max":.     
-00016290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162a0: 2020 2066 6f75 6e64 5f6c 6973 7469 6e67     found_listing
-000162b0: 5f64 6179 203d 2054 7275 650a 2020 2020  _day = True.    
-000162c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162d0: 2020 2020 6c69 7374 696e 675f 6461 7920      listing_day 
-000162e0: 3d20 6466 2e69 6e64 6578 5b30 5d0a 2020  = df.index[0].  
+00015df0: 6665 7463 685f 7261 6e67 6573 5b69 5d5b  fetch_ranges[i][
+00015e00: 2266 6574 6368 2073 7461 7274 225d 203d  "fetch start"] =
+00015e10: 206d 6178 4c6f 6f6b 6261 636b 5f64 742e   maxLookback_dt.
+00015e20: 6365 696c 2822 4422 290a 2020 2020 2020  ceil("D").      
+00015e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e40: 2020 2020 2020 2020 2020 2020 2020 6665                fe
+00015e50: 7463 685f 7261 6e67 6573 5b69 5d5b 2263  tch_ranges[i]["c
+00015e60: 6f72 6520 7374 6172 7422 5d20 3d20 6665  ore start"] = fe
+00015e70: 7463 685f 7261 6e67 6573 5b69 5d5b 2266  tch_ranges[i]["f
+00015e80: 6574 6368 2073 7461 7274 225d 202b 2074  etch start"] + t
+00015e90: 645f 3164 0a20 2020 2020 2020 2020 2020  d_1d.           
+00015ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015eb0: 2020 2020 2020 2020 2069 6620 6665 7463           if fetc
+00015ec0: 685f 7261 6e67 6573 5b69 5d5b 2266 6574  h_ranges[i]["fet
+00015ed0: 6368 2073 7461 7274 225d 203e 3d20 6665  ch start"] >= fe
+00015ee0: 7463 685f 7261 6e67 6573 5b69 5d5b 2266  tch_ranges[i]["f
+00015ef0: 6574 6368 2065 6e64 225d 3a0a 2020 2020  etch end"]:.    
+00015f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f20: 2020 2020 6465 6c20 6665 7463 685f 7261      del fetch_ra
+00015f30: 6e67 6573 5b69 5d0a 0a20 2020 2020 2020  nges[i]..       
+00015f40: 2020 2020 2020 2020 2064 6620 3d20 4e6f           df = No
+00015f50: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+00015f60: 2020 2066 6f72 2072 2069 6e20 6665 7463     for r in fetc
+00015f70: 685f 7261 6e67 6573 3a0a 2020 2020 2020  h_ranges:.      
+00015f80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00015f90: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
+00015fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fb0: 2020 2020 7072 696e 7428 222d 2066 6574      print("- fet
+00015fc0: 6368 696e 673a 2229 0a20 2020 2020 2020  ching:").       
+00015fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fe0: 2070 7269 6e74 2872 290a 2020 2020 2020   print(r).      
+00015ff0: 2020 2020 2020 2020 2020 2020 2020 6665                fe
+00016000: 7463 685f 7374 6172 7420 3d20 725b 2266  tch_start = r["f
+00016010: 6574 6368 2073 7461 7274 225d 0a20 2020  etch start"].   
+00016020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016030: 2066 6574 6368 5f65 6e64 203d 2072 5b22   fetch_end = r["
+00016040: 6665 7463 6820 656e 6422 5d0a 2020 2020  fetch end"].    
+00016050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016060: 6466 7220 3d20 7365 6c66 2e5f 6665 7463  dfr = self._fetc
+00016070: 6859 6648 6973 746f 7279 5f64 6174 6552  hYfHistory_dateR
+00016080: 616e 6765 2866 6574 6368 5f73 7461 7274  ange(fetch_start
+00016090: 2c20 6665 7463 685f 656e 642c 2070 7265  , fetch_end, pre
+000160a0: 706f 7374 2c20 6465 6275 6729 0a20 2020  post, debug).   
+000160b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160c0: 2023 2044 6973 6361 7264 2070 6164 6469   # Discard paddi
+000160d0: 6e67 2064 6179 733a 0a20 2020 2020 2020  ng days:.       
+000160e0: 2020 2020 2020 2020 2020 2020 2064 6672               dfr
+000160f0: 203d 2064 6672 2e6c 6f63 5b72 5b22 636f   = dfr.loc[r["co
+00016100: 7265 2073 7461 7274 225d 3a20 725b 2263  re start"]: r["c
+00016110: 6f72 6520 656e 6422 5d20 2d20 7469 6d65  ore end"] - time
+00016120: 6465 6c74 6128 6d69 6c6c 6973 6563 6f6e  delta(millisecon
+00016130: 6473 3d31 295d 0a20 2020 2020 2020 2020  ds=1)].         
+00016140: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00016150: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
+00016160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016170: 2070 7269 6e74 2822 2d20 6466 7220 6166   print("- dfr af
+00016180: 7465 7220 6469 7363 6172 6469 6e67 2070  ter discarding p
+00016190: 6164 6469 6e67 2064 6179 733a 2229 0a20  adding days:"). 
+000161a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161b0: 2020 2020 2020 2070 7269 6e74 2864 6672         print(dfr
+000161c0: 5b5b 6320 666f 7220 6320 696e 205b 224f  [[c for c in ["O
+000161d0: 7065 6e22 2c20 224c 6f77 222c 2022 4869  pen", "Low", "Hi
+000161e0: 6768 222c 2022 436c 6f73 6522 2c20 2244  gh", "Close", "D
+000161f0: 6976 6964 656e 6473 222c 2022 566f 6c75  ividends", "Volu
+00016200: 6d65 225d 2069 6620 6320 696e 2064 6672  me"] if c in dfr
+00016210: 2e63 6f6c 756d 6e73 5d5d 290a 2020 2020  .columns]]).    
+00016220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016230: 6966 2064 6620 6973 204e 6f6e 653a 0a20  if df is None:. 
+00016240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016250: 2020 2020 2020 2064 6620 3d20 6466 720a         df = dfr.
+00016260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016270: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00016280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016290: 2020 6466 203d 2070 642e 636f 6e63 6174    df = pd.concat
+000162a0: 285b 6466 2c20 6466 725d 2c20 736f 7274  ([df, dfr], sort
+000162b0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+000162c0: 2020 2020 2020 2020 2020 2069 6620 6466             if df
+000162d0: 2e69 6e64 6578 2e64 7570 6c69 6361 7465  .index.duplicate
+000162e0: 6428 292e 616e 7928 293a 0a20 2020 2020  d().any():.     
 000162f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00016310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016320: 6966 2070 7374 7220 6973 206e 6f74 204e  if pstr is not N
-00016330: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00016340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016350: 2066 6574 6368 5f73 7461 7274 2c20 6665   fetch_start, fe
-00016360: 7463 685f 656e 645f 6420 3d20 7966 6374  tch_end_d = yfct
-00016370: 2e4d 6170 5065 7269 6f64 546f 4461 7465  .MapPeriodToDate
-00016380: 7328 7365 6c66 2e65 7863 6861 6e67 652c  s(self.exchange,
-00016390: 2079 6663 642e 7065 7269 6f64 5374 7254   yfcd.periodStrT
-000163a0: 6f45 6e75 6d5b 7073 7472 5d2c 2073 656c  oEnum[pstr], sel
-000163b0: 662e 696e 7465 7276 616c 290a 2020 2020  f.interval).    
-000163c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163d0: 2020 2020 746f 6c20 3d20 7966 6364 2e6c      tol = yfcd.l
-000163e0: 6973 7469 6e67 5f64 6174 655f 6368 6563  isting_date_chec
-000163f0: 6b5f 746f 6c73 5b73 656c 662e 696e 7465  k_tols[self.inte
-00016400: 7276 616c 5d0a 2020 2020 2020 2020 2020  rval].          
-00016410: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00016420: 2066 6574 6368 5f73 7461 7274 2069 7320   fetch_start is 
-00016430: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00016440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016450: 2020 2020 2020 6665 7463 685f 7374 6172        fetch_star
-00016460: 745f 6420 3d20 6665 7463 685f 7374 6172  t_d = fetch_star
-00016470: 742e 6461 7465 2829 2069 6620 6973 696e  t.date() if isin
-00016480: 7374 616e 6365 2866 6574 6368 5f73 7461  stance(fetch_sta
-00016490: 7274 2c20 6461 7465 7469 6d65 2920 656c  rt, datetime) el
-000164a0: 7365 2066 6574 6368 5f73 7461 7274 0a20  se fetch_start. 
-000164b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164c0: 2020 2020 2020 2020 2020 2069 6620 2864             if (d
-000164d0: 662e 696e 6465 785b 305d 2e64 6174 6528  f.index[0].date(
-000164e0: 2920 2d20 6665 7463 685f 7374 6172 745f  ) - fetch_start_
-000164f0: 6429 203e 2074 6f6c 3a0a 2020 2020 2020  d) > tol:.      
-00016500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016510: 2020 2020 2020 2020 2020 2320 5961 686f            # Yaho
-00016520: 6f20 7265 7475 726e 6564 2064 6174 6120  o returned data 
-00016530: 7374 6172 7469 6e67 2073 6967 6e69 6669  starting signifi
-00016540: 6361 6e74 6c79 2061 6674 6572 2072 6571  cantly after req
-00016550: 7565 7374 6564 2073 7461 7274 2064 6174  uested start dat
-00016560: 652c 2069 6e64 6963 6174 6573 0a20 2020  e, indicates.   
-00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016580: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-00016590: 6571 7565 7374 2069 7320 6265 666f 7265  equest is before
-000165a0: 2073 746f 636b 206c 6973 7465 6420 6f6e   stock listed on
-000165b0: 2065 7863 6861 6e67 650a 2020 2020 2020   exchange.      
-000165c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165d0: 2020 2020 2020 2020 2020 666f 756e 645f            found_
-000165e0: 6c69 7374 696e 675f 6461 7920 3d20 5472  listing_day = Tr
-000165f0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00016600: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00016610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016620: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00016630: 7274 5f65 7870 6563 7465 6420 3d20 7966  rt_expected = yf
-00016640: 6374 2e44 7453 7562 7472 6163 7450 6572  ct.DtSubtractPer
-00016650: 696f 6428 6665 7463 685f 6474 5f75 7463  iod(fetch_dt_utc
-00016660: 2e64 6174 6528 292b 7464 5f31 642c 2079  .date()+td_1d, y
-00016670: 6663 642e 7065 7269 6f64 5374 7254 6f45  fcd.periodStrToE
-00016680: 6e75 6d5b 7073 7472 5d29 0a20 2020 2020  num[pstr]).     
-00016690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166a0: 2020 2020 2020 2023 2069 6620 7365 6c66         # if self
-000166b0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-000166c0: 642e 496e 7465 7276 616c 2e57 6565 6b3a  d.Interval.Week:
-000166d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000166e0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-000166f0: 2020 2073 7461 7274 5f65 7870 6563 7465     start_expecte
-00016700: 6420 2d3d 2074 696d 6564 656c 7461 2864  d -= timedelta(d
-00016710: 6179 733d 7374 6172 745f 6578 7065 6374  ays=start_expect
-00016720: 6564 2e77 6565 6b64 6179 2829 290a 2020  ed.weekday()).  
-00016730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016740: 2020 2020 2020 2020 2020 6966 2028 6466            if (df
-00016750: 2e69 6e64 6578 5b30 5d2e 6461 7465 2829  .index[0].date()
-00016760: 202d 2073 7461 7274 5f65 7870 6563 7465   - start_expecte
-00016770: 6429 203e 2074 6f6c 3a0a 2020 2020 2020  d) > tol:.      
-00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016790: 2020 2020 2020 2020 2020 666f 756e 645f            found_
-000167a0: 6c69 7374 696e 675f 6461 7920 3d20 5472  listing_day = Tr
-000167b0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-000167c0: 2020 2020 2020 2069 6620 6465 6275 675f         if debug_
-000167d0: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
-000167e0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-000167f0: 203d 2022 2d20 666f 756e 645f 6c69 7374   = "- found_list
-00016800: 696e 675f 6461 7920 3d20 7b7d 222e 666f  ing_day = {}".fo
-00016810: 726d 6174 2866 6f75 6e64 5f6c 6973 7469  rmat(found_listi
-00016820: 6e67 5f64 6179 290a 2020 2020 2020 2020  ng_day).        
-00016830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016840: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
-00016850: 6d73 6729 2069 6620 7966 636c 2e49 7354  msg) if yfcl.IsT
-00016860: 7261 6369 6e67 456e 6162 6c65 6428 2920  racingEnabled() 
-00016870: 656c 7365 2070 7269 6e74 286d 7367 290a  else print(msg).
-00016880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016890: 2020 2020 6966 2066 6f75 6e64 5f6c 6973      if found_lis
-000168a0: 7469 6e67 5f64 6179 3a0a 2020 2020 2020  ting_day:.      
-000168b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168c0: 2020 6c69 7374 696e 675f 6461 7920 3d20    listing_day = 
-000168d0: 6466 2e69 6e64 6578 5b30 5d2e 6461 7465  df.index[0].date
-000168e0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-000168f0: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-00016900: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
-00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016920: 2020 2020 206d 7367 203d 2022 5946 433a       msg = "YFC:
-00016930: 2069 6e66 6572 7265 6420 6c69 7374 696e   inferred listin
-00016940: 675f 6461 7465 203d 207b 7d22 2e66 6f72  g_date = {}".for
-00016950: 6d61 7428 6c69 7374 696e 675f 6461 7929  mat(listing_day)
-00016960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016970: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-00016980: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-00016990: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-000169a0: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-000169b0: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
-000169c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169d0: 2020 2020 2079 6663 6d2e 5374 6f72 6543       yfcm.StoreC
-000169e0: 6163 6865 4461 7475 6d28 7365 6c66 2e74  acheDatum(self.t
-000169f0: 6963 6b65 722c 2022 6c69 7374 696e 675f  icker, "listing_
-00016a00: 6461 7465 222c 206c 6973 7469 6e67 5f64  date", listing_d
-00016a10: 6179 290a 0a20 2020 2020 2020 2020 2020  ay)..           
-00016a20: 2020 2020 2020 2020 2069 6620 286c 6973           if (lis
-00016a30: 7469 6e67 5f64 6179 2069 7320 6e6f 7420  ting_day is not 
-00016a40: 4e6f 6e65 2920 616e 6420 6669 7273 745f  None) and first_
-00016a50: 6665 7463 685f 6661 696c 6564 3a0a 2020  fetch_failed:.  
-00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a70: 2020 2020 2020 6966 2065 6e64 203c 3d20        if end <= 
-00016a80: 6c69 7374 696e 675f 6461 793a 0a20 2020  listing_day:.   
-00016a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016aa0: 2020 2020 2020 2020 2023 2041 6861 2120           # Aha! 
-00016ab0: 5265 7175 6573 7465 6420 6461 7465 2072  Requested date r
-00016ac0: 616e 6765 2077 6173 2065 6e74 6972 656c  ange was entirel
-00016ad0: 7920 6265 666f 7265 206c 6973 7469 6e67  y before listing
-00016ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016af0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00016b00: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
-00016b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b20: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-00016b30: 2022 2d20 7265 7175 6573 7465 6420 6461   "- requested da
-00016b40: 7465 2072 616e 6765 2077 6173 2062 6566  te range was bef
-00016b50: 6f72 6520 6c69 7374 696e 6720 6461 7465  ore listing date
-00016b60: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00016300: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+00016310: 6f6e 2822 6466 2063 6f6e 7461 696e 7320  on("df contains 
+00016320: 6475 706c 6963 6174 6564 2064 6174 6573  duplicated dates
+00016330: 2229 0a0a 2020 2020 2020 2020 6665 7463  ")..        fetc
+00016340: 685f 6474 5f75 7463 203d 2070 642e 5469  h_dt_utc = pd.Ti
+00016350: 6d65 7374 616d 702e 7574 636e 6f77 2829  mestamp.utcnow()
+00016360: 2e74 7a5f 636f 6e76 6572 7428 5a6f 6e65  .tz_convert(Zone
+00016370: 496e 666f 2822 5554 4322 2929 0a0a 2020  Info("UTC"))..  
+00016380: 2020 2020 2020 6966 2028 6466 2069 7320        if (df is 
+00016390: 6e6f 7420 4e6f 6e65 2920 616e 6420 2864  not None) and (d
+000163a0: 662e 696e 6465 782e 747a 2069 7320 6e6f  f.index.tz is no
+000163b0: 7420 4e6f 6e65 2920 616e 6420 286e 6f74  t None) and (not
+000163c0: 2069 7369 6e73 7461 6e63 6528 6466 2e69   isinstance(df.i
+000163d0: 6e64 6578 2e74 7a2c 205a 6f6e 6549 6e66  ndex.tz, ZoneInf
+000163e0: 6f29 293a 0a20 2020 2020 2020 2020 2020  o)):.           
+000163f0: 2023 2043 6f6e 7665 7274 2074 6f20 5a6f   # Convert to Zo
+00016400: 6e65 496e 666f 0a20 2020 2020 2020 2020  neInfo.         
+00016410: 2020 2064 662e 696e 6465 7820 3d20 6466     df.index = df
+00016420: 2e69 6e64 6578 2e74 7a5f 636f 6e76 6572  .index.tz_conver
+00016430: 7428 747a 5f65 7863 6861 6e67 6529 0a0a  t(tz_exchange)..
+00016440: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00016450: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+00016460: 2020 6966 2064 6620 6973 204e 6f6e 653a    if df is None:
+00016470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016480: 206d 7367 203d 2022 2d20 5946 2072 6574   msg = "- YF ret
+00016490: 7572 6e65 6420 4e6f 6e65 220a 2020 2020  urned None".    
+000164a0: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+000164b0: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
+000164c0: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
+000164d0: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
+000164e0: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
+000164f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00016500: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00016510: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+00016520: 2020 2020 206d 7367 203d 2022 2d20 5946       msg = "- YF
+00016530: 2072 6574 7572 6e65 6420 7461 626c 653a   returned table:
+00016540: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00016550: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
+00016560: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
+00016570: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+00016580: 2920 656c 7365 2070 7269 6e74 286d 7367  ) else print(msg
+00016590: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000165a0: 2020 7072 696e 7428 6466 5b5b 6320 666f    print(df[[c fo
+000165b0: 7220 6320 696e 205b 224f 7065 6e22 2c20  r c in ["Open", 
+000165c0: 224c 6f77 222c 2022 4869 6768 222c 2022  "Low", "High", "
+000165d0: 436c 6f73 6522 2c20 2244 6976 6964 656e  Close", "Dividen
+000165e0: 6473 222c 2022 566f 6c75 6d65 225d 2069  ds", "Volume"] i
+000165f0: 6620 6320 696e 2064 662e 636f 6c75 6d6e  f c in df.column
+00016600: 735d 5d29 0a0a 2020 2020 2020 2020 2320  s]])..        # 
+00016610: 4465 7465 6374 206c 6973 7469 6e67 2064  Detect listing d
+00016620: 6179 0a20 2020 2020 2020 206c 6973 7469  ay.        listi
+00016630: 6e67 5f64 6179 203d 2079 6663 6d2e 5265  ng_day = yfcm.Re
+00016640: 6164 4361 6368 6544 6174 756d 2873 656c  adCacheDatum(sel
+00016650: 662e 7469 636b 6572 2c20 226c 6973 7469  f.ticker, "listi
+00016660: 6e67 5f64 6174 6522 290a 2020 2020 2020  ng_date").      
+00016670: 2020 6966 206c 6973 7469 6e67 5f64 6179    if listing_day
+00016680: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00016690: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+000166a0: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+000166b0: 6e74 6572 7661 6c2e 4461 7973 313a 0a20  nterval.Days1:. 
+000166c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000166d0: 6f75 6e64 5f6c 6973 7469 6e67 5f64 6179  ound_listing_day
+000166e0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+000166f0: 2020 2020 2020 2020 206c 6973 7469 6e67           listing
+00016700: 5f64 6179 203d 204e 6f6e 650a 2020 2020  _day = None.    
+00016710: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00016720: 6620 6973 206e 6f74 204e 6f6e 6520 616e  f is not None an
+00016730: 6420 6e6f 7420 6466 2e65 6d70 7479 3a0a  d not df.empty:.
+00016740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016750: 2020 2020 6966 2070 7374 7220 3d3d 2022      if pstr == "
+00016760: 6d61 7822 3a0a 2020 2020 2020 2020 2020  max":.          
+00016770: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00016780: 756e 645f 6c69 7374 696e 675f 6461 7920  und_listing_day 
+00016790: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+000167a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000167b0: 6973 7469 6e67 5f64 6179 203d 2064 662e  isting_day = df.
+000167c0: 696e 6465 785b 305d 0a20 2020 2020 2020  index[0].       
+000167d0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000167e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000167f0: 2020 2020 2020 2020 2020 2069 6620 7073             if ps
+00016800: 7472 2069 7320 6e6f 7420 4e6f 6e65 3a0a  tr is not None:.
+00016810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016820: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00016830: 685f 7374 6172 742c 2066 6574 6368 5f65  h_start, fetch_e
+00016840: 6e64 5f64 203d 2079 6663 742e 4d61 7050  nd_d = yfct.MapP
+00016850: 6572 696f 6454 6f44 6174 6573 2873 656c  eriodToDates(sel
+00016860: 662e 6578 6368 616e 6765 2c20 7966 6364  f.exchange, yfcd
+00016870: 2e70 6572 696f 6453 7472 546f 456e 756d  .periodStrToEnum
+00016880: 5b70 7374 725d 2c20 7365 6c66 2e69 6e74  [pstr], self.int
+00016890: 6572 7661 6c29 0a20 2020 2020 2020 2020  erval).         
+000168a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000168b0: 6f6c 203d 2079 6663 642e 6c69 7374 696e  ol = yfcd.listin
+000168c0: 675f 6461 7465 5f63 6865 636b 5f74 6f6c  g_date_check_tol
+000168d0: 735b 7365 6c66 2e69 6e74 6572 7661 6c5d  s[self.interval]
+000168e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000168f0: 2020 2020 2020 2020 2069 6620 6665 7463           if fetc
+00016900: 685f 7374 6172 7420 6973 206e 6f74 204e  h_start is not N
+00016910: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00016920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016930: 2066 6574 6368 5f73 7461 7274 5f64 203d   fetch_start_d =
+00016940: 2066 6574 6368 5f73 7461 7274 2e64 6174   fetch_start.dat
+00016950: 6528 2920 6966 2069 7369 6e73 7461 6e63  e() if isinstanc
+00016960: 6528 6665 7463 685f 7374 6172 742c 2064  e(fetch_start, d
+00016970: 6174 6574 696d 6529 2065 6c73 6520 6665  atetime) else fe
+00016980: 7463 685f 7374 6172 740a 2020 2020 2020  tch_start.      
+00016990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169a0: 2020 2020 2020 6966 2028 6466 2e69 6e64        if (df.ind
+000169b0: 6578 5b30 5d2e 6461 7465 2829 202d 2066  ex[0].date() - f
+000169c0: 6574 6368 5f73 7461 7274 5f64 2920 3e20  etch_start_d) > 
+000169d0: 746f 6c3a 0a20 2020 2020 2020 2020 2020  tol:.           
+000169e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169f0: 2020 2020 2023 2059 6168 6f6f 2072 6574       # Yahoo ret
+00016a00: 7572 6e65 6420 6461 7461 2073 7461 7274  urned data start
+00016a10: 696e 6720 7369 676e 6966 6963 616e 746c  ing significantl
+00016a20: 7920 6166 7465 7220 7265 7175 6573 7465  y after requeste
+00016a30: 6420 7374 6172 7420 6461 7465 2c20 696e  d start date, in
+00016a40: 6469 6361 7465 730a 2020 2020 2020 2020  dicates.        
+00016a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a60: 2020 2020 2020 2020 2320 7265 7175 6573          # reques
+00016a70: 7420 6973 2062 6566 6f72 6520 7374 6f63  t is before stoc
+00016a80: 6b20 6c69 7374 6564 206f 6e20 6578 6368  k listed on exch
+00016a90: 616e 6765 0a20 2020 2020 2020 2020 2020  ange.           
+00016aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ab0: 2020 2020 2066 6f75 6e64 5f6c 6973 7469       found_listi
+00016ac0: 6e67 5f64 6179 203d 2054 7275 650a 2020  ng_day = True.  
+00016ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ae0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00016af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b00: 2020 2020 2020 2020 7374 6172 745f 6578          start_ex
+00016b10: 7065 6374 6564 203d 2079 6663 742e 4474  pected = yfct.Dt
+00016b20: 5375 6274 7261 6374 5065 7269 6f64 2866  SubtractPeriod(f
+00016b30: 6574 6368 5f64 745f 7574 632e 6461 7465  etch_dt_utc.date
+00016b40: 2829 2b74 645f 3164 2c20 7966 6364 2e70  ()+td_1d, yfcd.p
+00016b50: 6572 696f 6453 7472 546f 456e 756d 5b70  eriodStrToEnum[p
+00016b60: 7374 725d 290a 2020 2020 2020 2020 2020  str]).          
 00016b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b80: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
-00016b90: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
-00016ba0: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
-00016bb0: 2920 656c 7365 2070 7269 6e74 286d 7367  ) else print(msg
-00016bc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016bd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00016be0: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-00016bf0: 2020 2020 2020 2020 2020 6966 2066 6f75            if fou
-00016c00: 6e64 5f6c 6973 7469 6e67 5f64 6179 2061  nd_listing_day a
-00016c10: 6e64 2073 7461 7274 2069 7320 6e6f 7420  nd start is not 
-00016c20: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00016c30: 2020 2020 2020 2020 2020 2320 4170 706c            # Appl
-00016c40: 7920 746f 2066 6574 6368 2073 7461 7274  y to fetch start
-00016c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016c60: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-00016c70: 6365 2873 7461 7274 2c20 6461 7465 7469  ce(start, dateti
-00016c80: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
-00016c90: 2020 2020 2020 2020 2020 2020 206c 6973               lis
-00016ca0: 7469 6e67 5f64 6174 6520 3d20 6461 7465  ting_date = date
-00016cb0: 7469 6d65 2e63 6f6d 6269 6e65 286c 6973  time.combine(lis
-00016cc0: 7469 6e67 5f64 6179 2c20 7469 6d65 2830  ting_day, time(0
-00016cd0: 292c 2073 656c 662e 747a 290a 2020 2020  ), self.tz).    
-00016ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016cf0: 2020 2020 7374 6172 7420 3d20 6d61 7828      start = max(
-00016d00: 7374 6172 742c 206c 6973 7469 6e67 5f64  start, listing_d
-00016d10: 6174 6529 0a20 2020 2020 2020 2020 2020  ate).           
-00016d20: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00016d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d40: 2020 2020 2020 2073 7461 7274 203d 206d         start = m
-00016d50: 6178 2873 7461 7274 2c20 6c69 7374 696e  ax(start, listin
-00016d60: 675f 6461 7929 0a20 2020 2020 2020 2020  g_day).         
-00016d70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00016d80: 7461 7274 5f64 203d 2073 7461 7274 0a0a  tart_d = start..
-00016d90: 2020 2020 2020 2020 6966 2070 7374 7220          if pstr 
-00016da0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00016db0: 2020 2020 2069 6620 6466 2069 7320 4e6f       if df is No
-00016dc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00016dd0: 2020 2020 7265 6365 6976 6564 5f69 6e74      received_int
-00016de0: 6572 7661 6c5f 7374 6172 7473 203d 204e  erval_starts = N
-00016df0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00016e00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00016e10: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
-00016e20: 7465 7264 6179 3a0a 2020 2020 2020 2020  terday:.        
-00016e30: 2020 2020 2020 2020 2020 2020 7265 6365              rece
-00016e40: 6976 6564 5f69 6e74 6572 7661 6c5f 7374  ived_interval_st
-00016e50: 6172 7473 203d 2064 662e 696e 6465 782e  arts = df.index.
-00016e60: 6461 7465 0a20 2020 2020 2020 2020 2020  date.           
-00016e70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00016e80: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00016e90: 6563 6569 7665 645f 696e 7465 7276 616c  eceived_interval
-00016ea0: 5f73 7461 7274 7320 3d20 6466 2e69 6e64  _starts = df.ind
-00016eb0: 6578 2e74 6f5f 7079 6461 7465 7469 6d65  ex.to_pydatetime
-00016ec0: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
-00016ed0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00016ee0: 2020 2020 696e 7465 7276 616c 735f 6d69      intervals_mi
-00016ef0: 7373 696e 675f 6466 203d 2079 6663 742e  ssing_df = yfct.
-00016f00: 4964 656e 7469 6679 4d69 7373 696e 6749  IdentifyMissingI
-00016f10: 6e74 6572 7661 6c73 2873 656c 662e 6578  ntervals(self.ex
-00016f20: 6368 616e 6765 2c20 7374 6172 742c 2065  change, start, e
-00016f30: 6e64 2c20 7365 6c66 2e69 6e74 6572 7661  nd, self.interva
-00016f40: 6c2c 2072 6563 6569 7665 645f 696e 7465  l, received_inte
-00016f50: 7276 616c 5f73 7461 7274 732c 2069 676e  rval_starts, ign
-00016f60: 6f72 655f 6272 6561 6b73 3d54 7275 6529  ore_breaks=True)
-00016f70: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00016f80: 6570 7420 7966 6364 2e4e 6f49 6e74 6572  ept yfcd.NoInter
-00016f90: 7661 6c73 496e 5261 6e67 6545 7863 6570  valsInRangeExcep
-00016fa0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
-00016fb0: 2020 2020 2020 696e 7465 7276 616c 735f        intervals_
-00016fc0: 6d69 7373 696e 675f 6466 203d 204e 6f6e  missing_df = Non
-00016fd0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00016fe0: 2028 696e 7465 7276 616c 735f 6d69 7373   (intervals_miss
-00016ff0: 696e 675f 6466 2069 7320 6e6f 7420 4e6f  ing_df is not No
-00017000: 6e65 2920 616e 6420 286e 6f74 2069 6e74  ne) and (not int
-00017010: 6572 7661 6c73 5f6d 6973 7369 6e67 5f64  ervals_missing_d
-00017020: 662e 656d 7074 7929 3a0a 2020 2020 2020  f.empty):.      
-00017030: 2020 2020 2020 2020 2020 2320 4669 7273            # Firs
-00017040: 742c 2069 676e 6f72 6520 616e 7920 6d69  t, ignore any mi
-00017050: 7373 696e 6720 696e 7465 7276 616c 7320  ssing intervals 
-00017060: 746f 6461 790a 2020 2020 2020 2020 2020  today.          
-00017070: 2020 2020 2020 2320 466f 7220 6d69 7373        # For miss
-00017080: 696e 6720 696e 7465 7276 616c 7320 6475  ing intervals du
-00017090: 7269 6e67 206c 6173 7420 3220 7765 656b  ring last 2 week
-000170a0: 732c 2069 6620 6665 7720 696e 206e 756d  s, if few in num
-000170b0: 6265 722c 2074 6865 6e20 6669 6c6c 2077  ber, then fill w
-000170c0: 6974 6820 4e61 4e73 0a20 2020 2020 2020  ith NaNs.       
-000170d0: 2020 2020 2020 2020 2023 2046 6f72 206d           # For m
-000170e0: 6973 7369 6e67 2069 6e74 6572 7661 6c73  issing intervals
-000170f0: 206f 6c64 6572 2074 6861 6e20 3220 7765   older than 2 we
-00017100: 656b 732c 2066 696c 6c20 616c 6c20 7769  eks, fill all wi
-00017110: 7468 204e 614e 730a 0a20 2020 2020 2020  th NaNs..       
-00017120: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-00017130: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-00017140: 2020 2020 2020 2020 2020 206e 203d 2069             n = i
-00017150: 6e74 6572 7661 6c73 5f6d 6973 7369 6e67  ntervals_missing
-00017160: 5f64 662e 7368 6170 655b 305d 0a20 2020  _df.shape[0].   
-00017170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017180: 2069 6620 6e20 3c3d 2033 3a0a 2020 2020   if n <= 3:.    
-00017190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171a0: 2020 2020 6d73 6720 3d20 6622 2d20 5946      msg = f"- YF
-000171b0: 2064 6174 6120 6d69 7373 696e 6720 7b6e   data missing {n
-000171c0: 7d20 696e 7465 7276 616c 733a 207b 696e  } intervals: {in
-000171d0: 7465 7276 616c 735f 6d69 7373 696e 675f  tervals_missing_
-000171e0: 6466 5b27 6f70 656e 275d 2e74 6f5f 6e75  df['open'].to_nu
-000171f0: 6d70 7928 297d 220a 2020 2020 2020 2020  mpy()}".        
-00017200: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00017210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017220: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-00017230: 6622 2d20 5946 2064 6174 6120 6d69 7373  f"- YF data miss
-00017240: 696e 6720 7b6e 7d20 696e 7465 7276 616c  ing {n} interval
-00017250: 7322 0a20 2020 2020 2020 2020 2020 2020  s".             
-00017260: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00017270: 6550 7269 6e74 286d 7367 2920 6966 2079  ePrint(msg) if y
-00017280: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
-00017290: 626c 6564 2829 2065 6c73 6520 7072 696e  bled() else prin
-000172a0: 7428 6d73 6729 0a0a 2020 2020 2020 2020  t(msg)..        
-000172b0: 2020 2020 2020 2020 6375 746f 6666 5f64          cutoff_d
-000172c0: 203d 2064 6174 652e 746f 6461 7928 2920   = date.today() 
-000172d0: 2d20 7469 6d65 6465 6c74 6128 6461 7973  - timedelta(days
-000172e0: 3d31 3429 0a20 2020 2020 2020 2020 2020  =14).           
-000172f0: 2020 2020 2064 745f 6e6f 775f 6c6f 6361       dt_now_loca
-00017300: 6c20 3d20 6474 5f6e 6f77 2e61 7374 696d  l = dt_now.astim
-00017310: 657a 6f6e 6528 7365 6c66 2e74 7a29 0a20  ezone(self.tz). 
-00017320: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00017330: 6620 7365 6c66 2e69 6e74 6572 6461 793a  f self.interday:
-00017340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017350: 2020 2020 2066 5f72 6563 656e 7420 3d20       f_recent = 
-00017360: 696e 7465 7276 616c 735f 6d69 7373 696e  intervals_missin
-00017370: 675f 6466 5b22 6f70 656e 225d 2e74 6f5f  g_df["open"].to_
-00017380: 6e75 6d70 7928 2920 3e20 6375 746f 6666  numpy() > cutoff
-00017390: 5f64 0a20 2020 2020 2020 2020 2020 2020  _d.             
-000173a0: 2020 2020 2020 2066 5f74 6f64 6179 203d         f_today =
-000173b0: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
-000173c0: 6e67 5f64 665b 226f 7065 6e22 5d2e 746f  ng_df["open"].to
-000173d0: 5f6e 756d 7079 2829 203d 3d20 6474 5f6e  _numpy() == dt_n
-000173e0: 6f77 5f6c 6f63 616c 2e64 6174 6528 290a  ow_local.date().
-000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017400: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00017410: 2020 2020 2020 2020 2020 665f 7265 6365            f_rece
-00017420: 6e74 203d 2069 6e74 6572 7661 6c73 5f6d  nt = intervals_m
-00017430: 6973 7369 6e67 5f64 665b 226f 7065 6e22  issing_df["open"
-00017440: 5d2e 6474 2e64 6174 6520 3e20 6375 746f  ].dt.date > cuto
-00017450: 6666 5f64 0a20 2020 2020 2020 2020 2020  ff_d.           
-00017460: 2020 2020 2020 2020 2066 5f74 6f64 6179           f_today
-00017470: 203d 2069 6e74 6572 7661 6c73 5f6d 6973   = intervals_mis
-00017480: 7369 6e67 5f64 665b 226f 7065 6e22 5d2e  sing_df["open"].
-00017490: 6474 2e64 6174 6520 3d3d 2064 745f 6e6f  dt.date == dt_no
-000174a0: 775f 6c6f 6361 6c2e 6461 7465 2829 0a20  w_local.date(). 
-000174b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000174c0: 6e74 6572 7661 6c73 5f6d 6973 7369 6e67  ntervals_missing
-000174d0: 5f64 665f 7265 6365 6e74 203d 2069 6e74  _df_recent = int
-000174e0: 6572 7661 6c73 5f6d 6973 7369 6e67 5f64  ervals_missing_d
-000174f0: 665b 665f 7265 6365 6e74 5d0a 2020 2020  f[f_recent].    
-00017500: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00017510: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
-00017520: 5f6f 6c64 203d 2069 6e74 6572 7661 6c73  _old = intervals
-00017530: 5f6d 6973 7369 6e67 5f64 665b 7e66 5f72  _missing_df[~f_r
-00017540: 6563 656e 745d 0a20 2020 2020 2020 2020  ecent].         
-00017550: 2020 2020 2020 206d 6973 7369 6e67 5f69         missing_i
-00017560: 6e74 6572 7661 6c73 5f74 6f5f 6164 6420  ntervals_to_add 
-00017570: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00017580: 2020 2020 2020 2069 6620 6e6f 7420 696e         if not in
-00017590: 7465 7276 616c 735f 6d69 7373 696e 675f  tervals_missing_
-000175a0: 6466 5f6f 6c64 2e65 6d70 7479 3a0a 2020  df_old.empty:.  
-000175b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175c0: 2020 6d69 7373 696e 675f 696e 7465 7276    missing_interv
-000175d0: 616c 735f 746f 5f61 6464 203d 2069 6e74  als_to_add = int
-000175e0: 6572 7661 6c73 5f6d 6973 7369 6e67 5f64  ervals_missing_d
-000175f0: 665f 6f6c 645b 226f 7065 6e22 5d2e 746f  f_old["open"].to
-00017600: 5f6e 756d 7079 2829 0a0a 2020 2020 2020  _numpy()..      
-00017610: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00017620: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
-00017630: 6e67 5f64 665f 7265 6365 6e74 2e65 6d70  ng_df_recent.emp
-00017640: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00017650: 2020 2020 2020 2020 2320 4966 2076 6572          # If ver
-00017660: 7920 6665 7720 696e 7465 7276 616c 7320  y few intervals 
-00017670: 616e 6420 6e6f 7420 746f 6461 7920 2873  and not today (s
-00017680: 6f20 5961 686f 6f20 7368 6f75 6c64 2068  o Yahoo should h
-00017690: 6176 6520 6461 7461 292c 0a20 2020 2020  ave data),.     
-000176a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000176b0: 2074 6865 6e20 6173 7375 6d65 206e 6f20   then assume no 
-000176c0: 7472 6164 696e 6720 6f63 6375 7272 6564  trading occurred
-000176d0: 2061 6e64 2069 6e73 6572 7420 4e61 4e20   and insert NaN 
-000176e0: 726f 7773 2e0a 2020 2020 2020 2020 2020  rows..          
-000176f0: 2020 2020 2020 2020 2020 2320 4e6f 726d            # Norm
-00017700: 616c 6c79 2059 6168 6f6f 2068 6173 2061  ally Yahoo has a
-00017710: 6c72 6561 6479 2066 696c 6c65 6420 7769  lready filled wi
-00017720: 7468 204e 614e 7320 6275 7420 736f 6d65  th NaNs but some
-00017730: 7469 6d65 7320 7468 6579 2066 6f72 6765  times they forge
-00017740: 742f 6172 6520 6c61 7465 0a20 2020 2020  t/are late.     
-00017750: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00017760: 6d20 3d20 696e 7465 7276 616c 735f 6d69  m = intervals_mi
-00017770: 7373 696e 675f 6466 5f72 6563 656e 742e  ssing_df_recent.
-00017780: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-00017790: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000177a0: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-000177b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177c0: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
-000177d0: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
-000177e0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000177f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017800: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00017810: 7464 203c 3d20 7469 6d65 6465 6c74 6128  td <= timedelta(
-00017820: 6d69 6e75 7465 733d 3229 3a0a 2020 2020  minutes=2):.    
-00017830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017840: 2020 2020 2020 2020 7468 7265 7368 6f6c          threshol
-00017850: 6420 3d20 3130 0a20 2020 2020 2020 2020  d = 10.         
-00017860: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00017870: 6c69 6620 7365 6c66 2e69 7464 203c 3d20  lif self.itd <= 
-00017880: 7469 6d65 6465 6c74 6128 6d69 6e75 7465  timedelta(minute
-00017890: 733d 3529 3a0a 2020 2020 2020 2020 2020  s=5):.          
-000178a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178b0: 2020 7468 7265 7368 6f6c 6420 3d20 330a    threshold = 3.
-000178c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000178e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000178f0: 2020 2020 2020 2020 2020 7468 7265 7368            thresh
-00017900: 6f6c 6420 3d20 320a 2020 2020 2020 2020  old = 2.        
-00017910: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00017920: 6d20 3c3d 2074 6872 6573 686f 6c64 3a0a  m <= threshold:.
-00017930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017940: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-00017950: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
-00017960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017970: 2020 6d73 6720 3d20 222d 2066 6f75 6e64    msg = "- found
-00017980: 206d 6973 7369 6e67 2069 6e74 6572 7661   missing interva
-00017990: 6c73 2c20 696e 7365 7274 696e 6720 6e61  ls, inserting na
-000179a0: 6e73 3a22 0a20 2020 2020 2020 2020 2020  ns:".           
-000179b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179c0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
-000179d0: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
-000179e0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-000179f0: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
-00017a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017a10: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00017a20: 6e74 2869 6e74 6572 7661 6c73 5f6d 6973  nt(intervals_mis
-00017a30: 7369 6e67 5f64 665f 7265 6365 6e74 290a  sing_df_recent).
-00017a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a50: 2020 2020 2020 2020 6966 206d 6973 7369          if missi
-00017a60: 6e67 5f69 6e74 6572 7661 6c73 5f74 6f5f  ng_intervals_to_
-00017a70: 6164 6420 6973 204e 6f6e 653a 0a20 2020  add is None:.   
-00017a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a90: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
-00017aa0: 5f69 6e74 6572 7661 6c73 5f74 6f5f 6164  _intervals_to_ad
-00017ab0: 6420 3d20 696e 7465 7276 616c 735f 6d69  d = intervals_mi
-00017ac0: 7373 696e 675f 6466 5f72 6563 656e 745b  ssing_df_recent[
-00017ad0: 226f 7065 6e22 5d2e 746f 5f6e 756d 7079  "open"].to_numpy
-00017ae0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00017af0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00017b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017b10: 2020 2020 2020 2020 2020 2020 206d 6973               mis
-00017b20: 7369 6e67 5f69 6e74 6572 7661 6c73 5f74  sing_intervals_t
-00017b30: 6f5f 6164 6420 3d20 6e70 2e61 7070 656e  o_add = np.appen
-00017b40: 6428 6d69 7373 696e 675f 696e 7465 7276  d(missing_interv
-00017b50: 616c 735f 746f 5f61 6464 2c20 696e 7465  als_to_add, inte
-00017b60: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
-00017b70: 5f72 6563 656e 745b 226f 7065 6e22 5d2e  _recent["open"].
-00017b80: 746f 5f6e 756d 7079 2829 290a 0a20 2020  to_numpy())..   
-00017b90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00017ba0: 6d69 7373 696e 675f 696e 7465 7276 616c  missing_interval
-00017bb0: 735f 746f 5f61 6464 2069 7320 6e6f 7420  s_to_add is not 
-00017bc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00017bd0: 2020 2020 2020 2020 2020 6966 2064 6562            if deb
-00017be0: 7567 5f79 6663 3a0a 2020 2020 2020 2020  ug_yfc:.        
-00017bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c00: 6e20 3d20 6d69 7373 696e 675f 696e 7465  n = missing_inte
-00017c10: 7276 616c 735f 746f 5f61 6464 2e73 6861  rvals_to_add.sha
-00017c20: 7065 5b30 5d0a 2020 2020 2020 2020 2020  pe[0].          
-00017c30: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00017c40: 206e 203c 3d20 333a 0a20 2020 2020 2020   n <= 3:.       
-00017c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c60: 2020 2020 206d 7367 203d 2066 222d 2069       msg = f"- i
-00017c70: 6e73 6572 7469 6e67 7320 4e61 4e73 2066  nsertings NaNs f
-00017c80: 6f72 207b 6e7d 206d 6973 7369 6e67 2069  or {n} missing i
-00017c90: 6e74 6572 7661 6c73 3a20 7b6d 6973 7369  ntervals: {missi
-00017ca0: 6e67 5f69 6e74 6572 7661 6c73 5f74 6f5f  ng_intervals_to_
-00017cb0: 6164 647d 220a 2020 2020 2020 2020 2020  add}".          
+00016b80: 2020 2320 6966 2073 656c 662e 696e 7465    # if self.inte
+00016b90: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
+00016ba0: 6572 7661 6c2e 5765 656b 3a0a 2020 2020  erval.Week:.    
+00016bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016bc0: 2020 2020 2020 2020 2320 2020 2020 7374          #     st
+00016bd0: 6172 745f 6578 7065 6374 6564 202d 3d20  art_expected -= 
+00016be0: 7469 6d65 6465 6c74 6128 6461 7973 3d73  timedelta(days=s
+00016bf0: 7461 7274 5f65 7870 6563 7465 642e 7765  tart_expected.we
+00016c00: 656b 6461 7928 2929 0a20 2020 2020 2020  ekday()).       
+00016c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c20: 2020 2020 2069 6620 2864 662e 696e 6465       if (df.inde
+00016c30: 785b 305d 2e64 6174 6528 2920 2d20 7374  x[0].date() - st
+00016c40: 6172 745f 6578 7065 6374 6564 2920 3e20  art_expected) > 
+00016c50: 746f 6c3a 0a20 2020 2020 2020 2020 2020  tol:.           
+00016c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c70: 2020 2020 2066 6f75 6e64 5f6c 6973 7469       found_listi
+00016c80: 6e67 5f64 6179 203d 2054 7275 650a 2020  ng_day = True.  
+00016c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ca0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+00016cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016cc0: 2020 2020 2020 2020 6d73 6720 3d20 222d          msg = "-
+00016cd0: 2066 6f75 6e64 5f6c 6973 7469 6e67 5f64   found_listing_d
+00016ce0: 6179 203d 207b 7d22 2e66 6f72 6d61 7428  ay = {}".format(
+00016cf0: 666f 756e 645f 6c69 7374 696e 675f 6461  found_listing_da
+00016d00: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
+00016d10: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+00016d20: 5472 6163 6550 7269 6e74 286d 7367 2920  TracePrint(msg) 
+00016d30: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
+00016d40: 6745 6e61 626c 6564 2829 2065 6c73 6520  gEnabled() else 
+00016d50: 7072 696e 7428 6d73 6729 0a20 2020 2020  print(msg).     
+00016d60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016d70: 6620 666f 756e 645f 6c69 7374 696e 675f  f found_listing_
+00016d80: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
+00016d90: 2020 2020 2020 2020 2020 2020 206c 6973               lis
+00016da0: 7469 6e67 5f64 6179 203d 2064 662e 696e  ting_day = df.in
+00016db0: 6465 785b 305d 2e64 6174 6528 290a 2020  dex[0].date().  
+00016dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016dd0: 2020 2020 2020 6966 2064 6562 7567 5f79        if debug_y
+00016de0: 6663 3a0a 2020 2020 2020 2020 2020 2020  fc:.            
+00016df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e00: 6d73 6720 3d20 2259 4643 3a20 696e 6665  msg = "YFC: infe
+00016e10: 7272 6564 206c 6973 7469 6e67 5f64 6174  rred listing_dat
+00016e20: 6520 3d20 7b7d 222e 666f 726d 6174 286c  e = {}".format(l
+00016e30: 6973 7469 6e67 5f64 6179 290a 2020 2020  isting_day).    
+00016e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e50: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00016e60: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+00016e70: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00016e80: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+00016e90: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
+00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016eb0: 7966 636d 2e53 746f 7265 4361 6368 6544  yfcm.StoreCacheD
+00016ec0: 6174 756d 2873 656c 662e 7469 636b 6572  atum(self.ticker
+00016ed0: 2c20 226c 6973 7469 6e67 5f64 6174 6522  , "listing_date"
+00016ee0: 2c20 6c69 7374 696e 675f 6461 7929 0a0a  , listing_day)..
+00016ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f00: 2020 2020 6966 2028 6c69 7374 696e 675f      if (listing_
+00016f10: 6461 7920 6973 206e 6f74 204e 6f6e 6529  day is not None)
+00016f20: 2061 6e64 2066 6972 7374 5f66 6574 6368   and first_fetch
+00016f30: 5f66 6169 6c65 643a 0a20 2020 2020 2020  _failed:.       
+00016f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f50: 2069 6620 656e 6420 3c3d 206c 6973 7469   if end <= listi
+00016f60: 6e67 5f64 6179 3a0a 2020 2020 2020 2020  ng_day:.        
+00016f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f80: 2020 2020 2320 4168 6121 2052 6571 7565      # Aha! Reque
+00016f90: 7374 6564 2064 6174 6520 7261 6e67 6520  sted date range 
+00016fa0: 7761 7320 656e 7469 7265 6c79 2062 6566  was entirely bef
+00016fb0: 6f72 6520 6c69 7374 696e 670a 2020 2020  ore listing.    
+00016fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016fd0: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00016fe0: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
+00016ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017000: 2020 2020 2020 6d73 6720 3d20 222d 2072        msg = "- r
+00017010: 6571 7565 7374 6564 2064 6174 6520 7261  equested date ra
+00017020: 6e67 6520 7761 7320 6265 666f 7265 206c  nge was before l
+00017030: 6973 7469 6e67 2064 6174 6522 0a20 2020  isting date".   
+00017040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017050: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+00017060: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+00017070: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+00017080: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+00017090: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
+000170a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000170b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000170c0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000170d0: 2020 2020 2069 6620 666f 756e 645f 6c69       if found_li
+000170e0: 7374 696e 675f 6461 7920 616e 6420 7374  sting_day and st
+000170f0: 6172 7420 6973 206e 6f74 204e 6f6e 653a  art is not None:
+00017100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017110: 2020 2020 2023 2041 7070 6c79 2074 6f20       # Apply to 
+00017120: 6665 7463 6820 7374 6172 740a 2020 2020  fetch start.    
+00017130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017140: 6966 2069 7369 6e73 7461 6e63 6528 7374  if isinstance(st
+00017150: 6172 742c 2064 6174 6574 696d 6529 3a0a  art, datetime):.
+00017160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017170: 2020 2020 2020 2020 6c69 7374 696e 675f          listing_
+00017180: 6461 7465 203d 2064 6174 6574 696d 652e  date = datetime.
+00017190: 636f 6d62 696e 6528 6c69 7374 696e 675f  combine(listing_
+000171a0: 6461 792c 2074 696d 6528 3029 2c20 7365  day, time(0), se
+000171b0: 6c66 2e74 7a29 0a20 2020 2020 2020 2020  lf.tz).         
+000171c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000171d0: 7461 7274 203d 206d 6178 2873 7461 7274  tart = max(start
+000171e0: 2c20 6c69 7374 696e 675f 6461 7465 290a  , listing_date).
+000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017200: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00017210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017220: 2020 7374 6172 7420 3d20 6d61 7828 7374    start = max(st
+00017230: 6172 742c 206c 6973 7469 6e67 5f64 6179  art, listing_day
+00017240: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00017250: 2020 2020 2020 2020 2020 7374 6172 745f            start_
+00017260: 6420 3d20 7374 6172 740a 0a20 2020 2020  d = start..     
+00017270: 2020 2069 6620 7073 7472 2069 7320 4e6f     if pstr is No
+00017280: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00017290: 6966 2064 6620 6973 204e 6f6e 653a 0a20  if df is None:. 
+000172a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000172b0: 6563 6569 7665 645f 696e 7465 7276 616c  eceived_interval
+000172c0: 5f73 7461 7274 7320 3d20 4e6f 6e65 0a20  _starts = None. 
+000172d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000172e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000172f0: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
+00017300: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00017310: 2020 2020 2020 2072 6563 6569 7665 645f         received_
+00017320: 696e 7465 7276 616c 5f73 7461 7274 7320  interval_starts 
+00017330: 3d20 6466 2e69 6e64 6578 2e64 6174 650a  = df.index.date.
+00017340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017350: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017360: 2020 2020 2020 2020 2020 7265 6365 6976            receiv
+00017370: 6564 5f69 6e74 6572 7661 6c5f 7374 6172  ed_interval_star
+00017380: 7473 203d 2064 662e 696e 6465 782e 746f  ts = df.index.to
+00017390: 5f70 7964 6174 6574 696d 6528 290a 2020  _pydatetime().  
+000173a0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+000173b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000173c0: 6e74 6572 7661 6c73 5f6d 6973 7369 6e67  ntervals_missing
+000173d0: 5f64 6620 3d20 7966 6374 2e49 6465 6e74  _df = yfct.Ident
+000173e0: 6966 794d 6973 7369 6e67 496e 7465 7276  ifyMissingInterv
+000173f0: 616c 7328 7365 6c66 2e65 7863 6861 6e67  als(self.exchang
+00017400: 652c 2073 7461 7274 2c20 656e 642c 2073  e, start, end, s
+00017410: 656c 662e 696e 7465 7276 616c 2c20 7265  elf.interval, re
+00017420: 6365 6976 6564 5f69 6e74 6572 7661 6c5f  ceived_interval_
+00017430: 7374 6172 7473 2c20 6967 6e6f 7265 5f62  starts, ignore_b
+00017440: 7265 616b 733d 5472 7565 290a 2020 2020  reaks=True).    
+00017450: 2020 2020 2020 2020 6578 6365 7074 2079          except y
+00017460: 6663 642e 4e6f 496e 7465 7276 616c 7349  fcd.NoIntervalsI
+00017470: 6e52 616e 6765 4578 6365 7074 696f 6e3a  nRangeException:
+00017480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017490: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
+000174a0: 6e67 5f64 6620 3d20 4e6f 6e65 0a20 2020  ng_df = None.   
+000174b0: 2020 2020 2020 2020 2069 6620 2869 6e74           if (int
+000174c0: 6572 7661 6c73 5f6d 6973 7369 6e67 5f64  ervals_missing_d
+000174d0: 6620 6973 206e 6f74 204e 6f6e 6529 2061  f is not None) a
+000174e0: 6e64 2028 6e6f 7420 696e 7465 7276 616c  nd (not interval
+000174f0: 735f 6d69 7373 696e 675f 6466 2e65 6d70  s_missing_df.emp
+00017500: 7479 293a 0a20 2020 2020 2020 2020 2020  ty):.           
+00017510: 2020 2020 2023 2046 6972 7374 2c20 6967       # First, ig
+00017520: 6e6f 7265 2061 6e79 206d 6973 7369 6e67  nore any missing
+00017530: 2069 6e74 6572 7661 6c73 2074 6f64 6179   intervals today
+00017540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017550: 2023 2046 6f72 206d 6973 7369 6e67 2069   # For missing i
+00017560: 6e74 6572 7661 6c73 2064 7572 696e 6720  ntervals during 
+00017570: 6c61 7374 2032 2077 6565 6b73 2c20 6966  last 2 weeks, if
+00017580: 2066 6577 2069 6e20 6e75 6d62 6572 2c20   few in number, 
+00017590: 7468 656e 2066 696c 6c20 7769 7468 204e  then fill with N
+000175a0: 614e 730a 2020 2020 2020 2020 2020 2020  aNs.            
+000175b0: 2020 2020 2320 466f 7220 6d69 7373 696e      # For missin
+000175c0: 6720 696e 7465 7276 616c 7320 6f6c 6465  g intervals olde
+000175d0: 7220 7468 616e 2032 2077 6565 6b73 2c20  r than 2 weeks, 
+000175e0: 6669 6c6c 2061 6c6c 2077 6974 6820 4e61  fill all with Na
+000175f0: 4e73 0a0a 2020 2020 2020 2020 2020 2020  Ns..            
+00017600: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
+00017610: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017620: 2020 2020 2020 6e20 3d20 696e 7465 7276        n = interv
+00017630: 616c 735f 6d69 7373 696e 675f 6466 2e73  als_missing_df.s
+00017640: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
+00017650: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00017660: 203c 3d20 333a 0a20 2020 2020 2020 2020   <= 3:.         
+00017670: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00017680: 7367 203d 2066 2259 4620 6461 7461 206d  sg = f"YF data m
+00017690: 6973 7369 6e67 207b 6e7d 2069 6e74 6572  issing {n} inter
+000176a0: 7661 6c73 3a20 7b69 6e74 6572 7661 6c73  vals: {intervals
+000176b0: 5f6d 6973 7369 6e67 5f64 665b 276f 7065  _missing_df['ope
+000176c0: 6e27 5d2e 746f 5f6e 756d 7079 2829 7d22  n'].to_numpy()}"
+000176d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000176e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000176f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017700: 2020 206d 7367 203d 2066 2259 4620 6461     msg = f"YF da
+00017710: 7461 206d 6973 7369 6e67 207b 6e7d 2069  ta missing {n} i
+00017720: 6e74 6572 7661 6c73 220a 2020 2020 2020  ntervals".      
+00017730: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+00017740: 636c 2e54 7261 6365 5072 696e 7428 272d  cl.TracePrint('-
+00017750: 2027 202b 206d 7367 2920 6966 2079 6663   ' + msg) if yfc
+00017760: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
+00017770: 6564 2829 2065 6c73 6520 7072 696e 7428  ed() else print(
+00017780: 272d 2027 202b 206d 7367 290a 0a20 2020  '- ' + msg)..   
+00017790: 2020 2020 2020 2020 2020 2020 2063 7574               cut
+000177a0: 6f66 665f 6420 3d20 6461 7465 2e74 6f64  off_d = date.tod
+000177b0: 6179 2829 202d 2074 696d 6564 656c 7461  ay() - timedelta
+000177c0: 2864 6179 733d 3134 290a 2020 2020 2020  (days=14).      
+000177d0: 2020 2020 2020 2020 2020 6474 5f6e 6f77            dt_now
+000177e0: 5f6c 6f63 616c 203d 2064 745f 6e6f 772e  _local = dt_now.
+000177f0: 6173 7469 6d65 7a6f 6e65 2873 656c 662e  astimezone(self.
+00017800: 747a 290a 2020 2020 2020 2020 2020 2020  tz).            
+00017810: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00017820: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00017830: 2020 2020 2020 2020 2020 665f 7265 6365            f_rece
+00017840: 6e74 203d 2069 6e74 6572 7661 6c73 5f6d  nt = intervals_m
+00017850: 6973 7369 6e67 5f64 665b 226f 7065 6e22  issing_df["open"
+00017860: 5d2e 746f 5f6e 756d 7079 2829 203e 2063  ].to_numpy() > c
+00017870: 7574 6f66 665f 640a 2020 2020 2020 2020  utoff_d.        
+00017880: 2020 2020 2020 2020 2020 2020 665f 746f              f_to
+00017890: 6461 7920 3d20 696e 7465 7276 616c 735f  day = intervals_
+000178a0: 6d69 7373 696e 675f 6466 5b22 6f70 656e  missing_df["open
+000178b0: 225d 2e74 6f5f 6e75 6d70 7928 2920 3d3d  "].to_numpy() ==
+000178c0: 2064 745f 6e6f 775f 6c6f 6361 6c2e 6461   dt_now_local.da
+000178d0: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
+000178e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000178f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017900: 5f72 6563 656e 7420 3d20 696e 7465 7276  _recent = interv
+00017910: 616c 735f 6d69 7373 696e 675f 6466 5b22  als_missing_df["
+00017920: 6f70 656e 225d 2e64 742e 6461 7465 203e  open"].dt.date >
+00017930: 2063 7574 6f66 665f 640a 2020 2020 2020   cutoff_d.      
+00017940: 2020 2020 2020 2020 2020 2020 2020 665f                f_
+00017950: 746f 6461 7920 3d20 696e 7465 7276 616c  today = interval
+00017960: 735f 6d69 7373 696e 675f 6466 5b22 6f70  s_missing_df["op
+00017970: 656e 225d 2e64 742e 6461 7465 203d 3d20  en"].dt.date == 
+00017980: 6474 5f6e 6f77 5f6c 6f63 616c 2e64 6174  dt_now_local.dat
+00017990: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+000179a0: 2020 2020 696e 7465 7276 616c 735f 6d69      intervals_mi
+000179b0: 7373 696e 675f 6466 5f72 6563 656e 7420  ssing_df_recent 
+000179c0: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
+000179d0: 696e 675f 6466 5b66 5f72 6563 656e 745d  ing_df[f_recent]
+000179e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000179f0: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
+00017a00: 6e67 5f64 665f 6f6c 6420 3d20 696e 7465  ng_df_old = inte
+00017a10: 7276 616c 735f 6d69 7373 696e 675f 6466  rvals_missing_df
+00017a20: 5b7e 665f 7265 6365 6e74 5d0a 2020 2020  [~f_recent].    
+00017a30: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
+00017a40: 696e 675f 696e 7465 7276 616c 735f 746f  ing_intervals_to
+00017a50: 5f61 6464 203d 204e 6f6e 650a 2020 2020  _add = None.    
+00017a60: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00017a70: 6f74 2069 6e74 6572 7661 6c73 5f6d 6973  ot intervals_mis
+00017a80: 7369 6e67 5f64 665f 6f6c 642e 656d 7074  sing_df_old.empt
+00017a90: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00017aa0: 2020 2020 2020 206d 6973 7369 6e67 5f69         missing_i
+00017ab0: 6e74 6572 7661 6c73 5f74 6f5f 6164 6420  ntervals_to_add 
+00017ac0: 3d20 696e 7465 7276 616c 735f 6d69 7373  = intervals_miss
+00017ad0: 696e 675f 6466 5f6f 6c64 5b22 6f70 656e  ing_df_old["open
+00017ae0: 225d 2e74 6f5f 6e75 6d70 7928 290a 0a20  "].to_numpy().. 
+00017af0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00017b00: 6620 6e6f 7420 696e 7465 7276 616c 735f  f not intervals_
+00017b10: 6d69 7373 696e 675f 6466 5f72 6563 656e  missing_df_recen
+00017b20: 742e 656d 7074 793a 0a20 2020 2020 2020  t.empty:.       
+00017b30: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00017b40: 6620 7665 7279 2066 6577 2069 6e74 6572  f very few inter
+00017b50: 7661 6c73 2061 6e64 206e 6f74 2074 6f64  vals and not tod
+00017b60: 6179 2028 736f 2059 6168 6f6f 2073 686f  ay (so Yahoo sho
+00017b70: 756c 6420 6861 7665 2064 6174 6129 2c0a  uld have data),.
+00017b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b90: 2020 2020 2320 7468 656e 2061 7373 756d      # then assum
+00017ba0: 6520 6e6f 2074 7261 6469 6e67 206f 6363  e no trading occ
+00017bb0: 7572 7265 6420 616e 6420 696e 7365 7274  urred and insert
+00017bc0: 204e 614e 2072 6f77 732e 0a20 2020 2020   NaN rows..     
+00017bd0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017be0: 204e 6f72 6d61 6c6c 7920 5961 686f 6f20   Normally Yahoo 
+00017bf0: 6861 7320 616c 7265 6164 7920 6669 6c6c  has already fill
+00017c00: 6564 2077 6974 6820 4e61 4e73 2062 7574  ed with NaNs but
+00017c10: 2073 6f6d 6574 696d 6573 2074 6865 7920   sometimes they 
+00017c20: 666f 7267 6574 2f61 7265 206c 6174 650a  forget/are late.
+00017c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c40: 2020 2020 6e6d 203d 2069 6e74 6572 7661      nm = interva
+00017c50: 6c73 5f6d 6973 7369 6e67 5f64 665f 7265  ls_missing_df_re
+00017c60: 6365 6e74 2e73 6861 7065 5b30 5d0a 2020  cent.shape[0].  
+00017c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c80: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
+00017c90: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+00017ca0: 2020 2020 2020 2020 2020 2020 7468 7265              thre
+00017cb0: 7368 6f6c 6420 3d20 310a 2020 2020 2020  shold = 1.      
 00017cc0: 2020 2020 2020 2020 2020 2020 2020 656c                el
 00017cd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cf0: 6d73 6720 3d20 6622 2d20 696e 7365 7274  msg = f"- insert
-00017d00: 696e 6773 204e 614e 7320 666f 7220 7b6e  ings NaNs for {n
-00017d10: 7d20 6d69 7373 696e 6720 696e 7465 7276  } missing interv
-00017d20: 616c 7322 0a20 2020 2020 2020 2020 2020  als".           
-00017d30: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-00017d40: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
-00017d50: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
-00017d60: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
-00017d70: 6520 7072 696e 7428 6d73 6729 0a0a 2020  e print(msg)..  
+00017ce0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00017cf0: 656c 662e 6974 6420 3c3d 2074 696d 6564  elf.itd <= timed
+00017d00: 656c 7461 286d 696e 7574 6573 3d32 293a  elta(minutes=2):
+00017d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017d20: 2020 2020 2020 2020 2020 2020 2074 6872               thr
+00017d30: 6573 686f 6c64 203d 2031 300a 2020 2020  eshold = 10.    
+00017d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d50: 2020 2020 656c 6966 2073 656c 662e 6974      elif self.it
+00017d60: 6420 3c3d 2074 696d 6564 656c 7461 286d  d <= timedelta(m
+00017d70: 696e 7574 6573 3d35 293a 0a20 2020 2020  inutes=5):.     
 00017d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d90: 2020 6e6d 203d 206d 6973 7369 6e67 5f69    nm = missing_i
-00017da0: 6e74 6572 7661 6c73 5f74 6f5f 6164 642e  ntervals_to_add.
-00017db0: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-00017dc0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00017dd0: 6d69 7373 696e 6720 3d20 7064 2e44 6174  missing = pd.Dat
-00017de0: 6146 7261 6d65 2864 6174 613d 7b6b 3a20  aFrame(data={k: 
-00017df0: 5b6e 702e 6e61 6e5d 2a6e 6d20 666f 7220  [np.nan]*nm for 
-00017e00: 6b20 696e 2079 6663 642e 7966 5f64 6174  k in yfcd.yf_dat
-00017e10: 615f 636f 6c73 7d2c 2069 6e64 6578 3d6d  a_cols}, index=m
-00017e20: 6973 7369 6e67 5f69 6e74 6572 7661 6c73  issing_intervals
-00017e30: 5f74 6f5f 6164 6429 0a20 2020 2020 2020  _to_add).       
-00017e40: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-00017e50: 6d69 7373 696e 672e 696e 6465 7820 3d20  missing.index = 
-00017e60: 7064 2e74 6f5f 6461 7465 7469 6d65 2864  pd.to_datetime(d
-00017e70: 665f 6d69 7373 696e 672e 696e 6465 7829  f_missing.index)
-00017e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017e90: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
-00017ea0: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
-00017eb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00017ec0: 665f 6d69 7373 696e 672e 696e 6465 7820  f_missing.index 
-00017ed0: 3d20 6466 5f6d 6973 7369 6e67 2e69 6e64  = df_missing.ind
-00017ee0: 6578 2e74 7a5f 6c6f 6361 6c69 7a65 2874  ex.tz_localize(t
-00017ef0: 7a5f 6578 6368 616e 6765 290a 2020 2020  z_exchange).    
-00017f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f10: 666f 7220 6320 696e 205b 2256 6f6c 756d  for c in ["Volum
-00017f20: 6522 2c20 2244 6976 6964 656e 6473 222c  e", "Dividends",
-00017f30: 2022 5374 6f63 6b20 5370 6c69 7473 225d   "Stock Splits"]
-00017f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017f50: 2020 2020 2020 2020 2020 6466 5f6d 6973            df_mis
-00017f60: 7369 6e67 5b63 5d20 3d20 300a 2020 2020  sing[c] = 0.    
-00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f80: 6966 2064 6620 6973 204e 6f6e 653a 0a20  if df is None:. 
-00017f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fa0: 2020 2020 2020 2064 6620 3d20 6466 5f6d         df = df_m
-00017fb0: 6973 7369 6e67 0a20 2020 2020 2020 2020  issing.         
-00017fc0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00017fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017fe0: 2020 2020 2020 2020 2064 6620 3d20 7064           df = pd
-00017ff0: 2e63 6f6e 6361 7428 5b64 662c 2064 665f  .concat([df, df_
-00018000: 6d69 7373 696e 675d 2c20 736f 7274 3d54  missing], sort=T
-00018010: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00018020: 2020 2020 2020 2020 2020 2020 2064 662e               df.
-00018030: 696e 6465 7820 3d20 7064 2e74 6f5f 6461  index = pd.to_da
-00018040: 7465 7469 6d65 2864 662e 696e 6465 782c  tetime(df.index,
-00018050: 2075 7463 3d54 7275 6529 2e74 7a5f 636f   utc=True).tz_co
-00018060: 6e76 6572 7428 747a 5f65 7863 6861 6e67  nvert(tz_exchang
-00018070: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00018080: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
-00018090: 6466 2e73 6f72 745f 696e 6465 7828 290a  df.sort_index().
-000180a0: 0a20 2020 2020 2020 2023 2049 6d70 726f  .        # Impro
-000180b0: 7665 2074 6f6c 6572 616e 6365 2074 6f20  ve tolerance to 
-000180c0: 6361 6c65 6e64 6172 206d 6973 7369 6e67  calendar missing
-000180d0: 2061 2072 6563 656e 7420 6e65 7720 686f   a recent new ho
-000180e0: 6c69 6461 793a 0a20 2020 2020 2020 2069  liday:.        i
-000180f0: 6620 2864 6620 6973 204e 6f6e 6529 206f  f (df is None) o
-00018100: 7220 6466 2e65 6d70 7479 3a0a 2020 2020  r df.empty:.    
-00018110: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00018120: 6f6e 650a 0a20 2020 2020 2020 206e 203d  one..        n =
-00018130: 2064 662e 7368 6170 655b 305d 0a0a 2020   df.shape[0]..  
-00018140: 2020 2020 2020 6665 7463 685f 6474 203d        fetch_dt =
-00018150: 2066 6574 6368 5f64 745f 7574 632e 7265   fetch_dt_utc.re
-00018160: 706c 6163 6528 747a 696e 666f 3d5a 6f6e  place(tzinfo=Zon
-00018170: 6549 6e66 6f28 2255 5443 2229 290a 0a20  eInfo("UTC")).. 
-00018180: 2020 2020 2020 2069 6620 286e 203e 2030         if (n > 0
-00018190: 2920 616e 6420 2870 7374 7220 6973 204e  ) and (pstr is N
-000181a0: 6f6e 6529 3a0a 2020 2020 2020 2020 2020  one):.          
-000181b0: 2020 2320 5265 6d6f 7665 2061 6e79 206f    # Remove any o
-000181c0: 7574 2d6f 662d 7261 6e67 6520 6461 7461  ut-of-range data
-000181d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000181e0: 4e4f 5445 3a20 5946 2068 6173 2061 2062  NOTE: YF has a b
-000181f0: 7567 2d66 6978 2070 656e 6469 6e67 206d  ug-fix pending m
-00018200: 6572 6765 3a20 6874 7470 733a 2f2f 6769  erge: https://gi
-00018210: 7468 7562 2e63 6f6d 2f72 616e 6172 6f75  thub.com/ranarou
-00018220: 7373 692f 7966 696e 616e 6365 2f70 756c  ssi/yfinance/pul
-00018230: 6c2f 3130 3132 0a20 2020 2020 2020 2020  l/1012.         
-00018240: 2020 2069 6620 656e 6420 6973 206e 6f74     if end is not
-00018250: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00018260: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00018270: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
-00018280: 2020 2020 2020 2020 2020 2020 2064 6620               df 
-00018290: 3d20 6466 5b64 662e 696e 6465 782e 6461  = df[df.index.da
-000182a0: 7465 203c 2065 6e64 5f64 5d0a 2020 2020  te < end_d].    
-000182b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000182c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000182d0: 2020 2020 2020 6466 203d 2064 665b 6466        df = df[df
-000182e0: 2e69 6e64 6578 203c 2065 6e64 5f64 745d  .index < end_dt]
-000182f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018300: 206e 203d 2064 662e 7368 6170 655b 305d   n = df.shape[0]
-00018310: 0a20 2020 2020 2020 2020 2020 2023 0a20  .            #. 
-00018320: 2020 2020 2020 2020 2020 2023 2041 6e64             # And
-00018330: 2061 6761 696e 2066 6f72 2070 7265 2d73   again for pre-s
-00018340: 7461 7274 2064 6174 613a 0a20 2020 2020  tart data:.     
-00018350: 2020 2020 2020 2069 6620 7374 6172 7420         if start 
-00018360: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00018370: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018380: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
-00018390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183a0: 2020 2064 6620 3d20 6466 5b64 662e 696e     df = df[df.in
-000183b0: 6465 782e 6461 7465 203e 3d20 7374 6172  dex.date >= star
-000183c0: 745f 645d 0a20 2020 2020 2020 2020 2020  t_d].           
-000183d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000183e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000183f0: 6620 3d20 6466 5b64 662e 696e 6465 7820  f = df[df.index 
-00018400: 3e3d 2073 7461 7274 5f64 745d 0a20 2020  >= start_dt].   
-00018410: 2020 2020 2020 2020 2020 2020 206e 203d               n =
-00018420: 2064 662e 7368 6170 655b 305d 0a0a 2020   df.shape[0]..  
-00018430: 2020 2020 2020 6966 206e 203d 3d20 303a        if n == 0:
-00018440: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00018450: 7365 2079 6663 642e 4e6f 5072 6963 6544  se yfcd.NoPriceD
-00018460: 6174 6149 6e52 616e 6765 4578 6365 7074  ataInRangeExcept
-00018470: 696f 6e28 7365 6c66 2e74 6963 6b65 722c  ion(self.ticker,
-00018480: 2073 656c 662e 6973 7472 2c20 7374 6172   self.istr, star
-00018490: 742c 2065 6e64 290a 2020 2020 2020 2020  t, end).        
-000184a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000184b0: 2020 2320 5665 7269 6679 2074 6861 7420    # Verify that 
-000184c0: 616c 6c20 6461 7465 7469 6d65 7320 6d61  all datetimes ma
-000184d0: 7463 6820 7570 2077 6974 6820 6163 7475  tch up with actu
-000184e0: 616c 2069 6e74 6572 7661 6c73 3a0a 2020  al intervals:.  
-000184f0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00018500: 662e 696e 7465 7264 6179 3a0a 2020 2020  f.interday:.    
-00018510: 2020 2020 2020 2020 2020 2020 6620 3d20              f = 
-00018520: 6466 2e69 6e64 6578 2e74 696d 6520 213d  df.index.time !=
-00018530: 2074 696d 6528 3029 0a20 2020 2020 2020   time(0).       
-00018540: 2020 2020 2020 2020 2069 6620 662e 616e           if f.an
-00018550: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-00018560: 2020 2020 2020 2020 2070 7269 6e74 2864           print(d
-00018570: 665b 665d 290a 2020 2020 2020 2020 2020  f[f]).          
-00018580: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00018590: 4578 6365 7074 696f 6e28 2249 6e74 6572  Exception("Inter
-000185a0: 6461 7920 6461 7461 2063 6f6e 7461 696e  day data contain
-000185b0: 7320 7469 6d65 7320 696e 2069 6e64 6578  s times in index
-000185c0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-000185d0: 2020 2079 6649 6e74 6572 7661 6c53 7461     yfIntervalSta
-000185e0: 7274 7320 3d20 6466 2e69 6e64 6578 2e64  rts = df.index.d
-000185f0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-00018600: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00018610: 2020 2020 2020 7966 496e 7465 7276 616c        yfInterval
-00018620: 5374 6172 7473 203d 2064 662e 696e 6465  Starts = df.inde
-00018630: 782e 746f 5f70 7964 6174 6574 696d 6528  x.to_pydatetime(
-00018640: 290a 2020 2020 2020 2020 2020 2020 230a  ).            #.
-00018650: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00018660: 656c 662e 696e 7472 6164 6179 2061 6e64  elf.intraday and
-00018670: 2028 7365 6c66 2e65 7863 6861 6e67 6520   (self.exchange 
-00018680: 696e 2079 6663 642e 6578 6368 616e 6765  in yfcd.exchange
-00018690: 7357 6974 6842 7265 616b 7329 3a0a 2020  sWithBreaks):.  
-000186a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000186b0: 4469 7363 6172 6420 616e 7920 696e 7465  Discard any inte
-000186c0: 7276 616c 7320 6675 6c6c 7920 7769 7468  rvals fully with
-000186d0: 696e 2061 2062 7265 616b 0a20 2020 2020  in a break.     
-000186e0: 2020 2020 2020 2020 2020 2066 5f69 6e5f             f_in_
-000186f0: 6272 6561 6b20 3d20 7966 6374 2e54 696d  break = yfct.Tim
-00018700: 6573 7461 6d70 496e 4272 6561 6b5f 6261  estampInBreak_ba
-00018710: 7463 6828 7365 6c66 2e65 7863 6861 6e67  tch(self.exchang
-00018720: 652c 2079 6649 6e74 6572 7661 6c53 7461  e, yfIntervalSta
-00018730: 7274 732c 2073 656c 662e 696e 7465 7276  rts, self.interv
-00018740: 616c 290a 2020 2020 2020 2020 2020 2020  al).            
-00018750: 2020 2020 6966 2066 5f69 6e5f 6272 6561      if f_in_brea
-00018760: 6b2e 616e 7928 293a 0a20 2020 2020 2020  k.any():.       
-00018770: 2020 2020 2020 2020 2020 2020 2023 2044               # D
-00018780: 6973 6361 7264 2074 6865 7365 0a20 2020  iscard these.   
-00018790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187a0: 2069 6620 6465 6275 675f 7966 633a 0a20   if debug_yfc:. 
-000187b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187c0: 2020 2020 2020 206d 7367 203d 2022 2d20         msg = "- 
-000187d0: 6472 6f70 7069 6e67 2072 6f77 7320 696e  dropping rows in
-000187e0: 2062 7265 616b 2074 696d 6573 220a 2020   break times".  
-000187f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018800: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-00018810: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
-00018820: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
-00018830: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
-00018840: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
-00018850: 2020 2020 2020 2020 2020 7966 496e 7465            yfInte
-00018860: 7276 616c 5374 6172 7473 203d 2079 6649  rvalStarts = yfI
-00018870: 6e74 6572 7661 6c53 7461 7274 735b 7e66  ntervalStarts[~f
-00018880: 5f69 6e5f 6272 6561 6b5d 0a20 2020 2020  _in_break].     
-00018890: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000188a0: 6620 3d20 6466 5b7e 665f 696e 5f62 7265  f = df[~f_in_bre
-000188b0: 616b 5d0a 2020 2020 2020 2020 2020 2020  ak].            
-000188c0: 2020 2020 2020 2020 6e20 3d20 6466 2e73          n = df.s
-000188d0: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
-000188e0: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
-000188f0: 2020 696e 7465 7276 616c 7320 3d20 7966    intervals = yf
-00018900: 6374 2e47 6574 5469 6d65 7374 616d 7043  ct.GetTimestampC
-00018910: 7572 7265 6e74 496e 7465 7276 616c 5f62  urrentInterval_b
-00018920: 6174 6368 2873 656c 662e 6578 6368 616e  atch(self.exchan
-00018930: 6765 2c20 7966 496e 7465 7276 616c 5374  ge, yfIntervalSt
-00018940: 6172 7473 2c20 7365 6c66 2e69 6e74 6572  arts, self.inter
-00018950: 7661 6c2c 2064 6973 6361 7264 5469 6d65  val, discardTime
-00018960: 733d 7365 6c66 2e69 6e74 6572 6461 792c  s=self.interday,
-00018970: 2069 676e 6f72 655f 6272 6561 6b73 3d54   ignore_breaks=T
-00018980: 7275 6529 0a0a 2020 2020 2020 2020 2020  rue)..          
-00018990: 2020 665f 6e61 203d 2069 6e74 6572 7661    f_na = interva
-000189a0: 6c73 5b22 696e 7465 7276 616c 5f6f 7065  ls["interval_ope
-000189b0: 6e22 5d2e 6973 6e61 2829 2e74 6f5f 6e75  n"].isna().to_nu
-000189c0: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-000189d0: 2020 6966 2076 6572 6966 795f 696e 7465    if verify_inte
-000189e0: 7276 616c 7320 616e 6420 665f 6e61 2e61  rvals and f_na.a
-000189f0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00018a00: 2020 2020 2020 7473 203d 2069 6e74 6572        ts = inter
-00018a10: 7661 6c73 5b22 696e 7465 7276 616c 5f6f  vals["interval_o
-00018a20: 7065 6e22 5d0a 2020 2020 2020 2020 2020  pen"].          
-00018a30: 2020 2020 2020 6966 206c 656e 2874 7329        if len(ts)
-00018a40: 2021 3d20 6c65 6e28 7365 7428 7473 2929   != len(set(ts))
-00018a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018a60: 2020 2020 2020 6475 7073 203d 2074 735b        dups = ts[
-00018a70: 7473 2e64 7570 6c69 6361 7465 6428 6b65  ts.duplicated(ke
-00018a80: 6570 3d46 616c 7365 295d 0a20 2020 2020  ep=False)].     
-00018a90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00018aa0: 2044 726f 7020 726f 7773 2074 6861 7420   Drop rows that 
-00018ab0: 6d61 7020 746f 2064 7570 6c69 6361 7465  map to duplicate
-00018ac0: 2069 6e74 6572 7661 6c73 2069 6620 6e6f   intervals if no
-00018ad0: 2074 7261 6469 6e67 206f 6363 7572 7265   trading occurre
-00018ae0: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-00018af0: 2020 2020 2020 2066 5f6e 6f5f 7472 6164         f_no_trad
-00018b00: 6573 203d 2028 6466 5b22 566f 6c75 6d65  es = (df["Volume
-00018b10: 225d 203d 3d20 3029 2026 2028 2864 665b  "] == 0) & ((df[
-00018b20: 224c 6f77 225d 203d 3d20 6466 5b22 4869  "Low"] == df["Hi
-00018b30: 6768 225d 2920 7c20 6466 5b22 436c 6f73  gh"]) | df["Clos
-00018b40: 6522 5d2e 6973 6e61 2829 290a 2020 2020  e"].isna()).    
-00018b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b60: 6472 6f70 5f64 7473 203d 204e 6f6e 650a  drop_dts = None.
-00018b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b80: 2020 2020 666f 7220 6920 696e 2064 7570      for i in dup
-00018b90: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00018ba0: 2020 2020 2020 2020 2020 2064 7473 203d             dts =
-00018bb0: 2069 6e74 6572 7661 6c73 2e69 6e64 6578   intervals.index
-00018bc0: 5b69 6e74 6572 7661 6c73 5b22 696e 7465  [intervals["inte
-00018bd0: 7276 616c 5f6f 7065 6e22 5d20 3d3d 2069  rval_open"] == i
-00018be0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00018bf0: 2020 2020 2020 2020 2020 6474 735f 6973            dts_is
-00018c00: 5f6e 616e 203d 206e 702e 6172 7261 7928  _nan = np.array(
-00018c10: 5b66 5f6e 6f5f 7472 6164 6573 5b64 662e  [f_no_trades[df.
-00018c20: 696e 6465 782e 6765 745f 6c6f 6328 6474  index.get_loc(dt
-00018c30: 295d 2066 6f72 2064 7420 696e 2064 7473  )] for dt in dts
-00018c40: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00018c50: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-00018c60: 735f 6973 5f6e 616e 2e61 6c6c 2829 3a0a  s_is_nan.all():.
-00018c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c80: 2020 2020 2020 2020 2020 2020 2320 4b65              # Ke
-00018c90: 6570 2066 6972 7374 2c20 6472 6f70 206f  ep first, drop o
-00018ca0: 7468 6572 730a 2020 2020 2020 2020 2020  thers.          
-00018cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cc0: 2020 6472 6f70 5f64 7473 5f73 7562 203d    drop_dts_sub =
-00018cd0: 2064 7473 5b31 3a5d 0a20 2020 2020 2020   dts[1:].       
-00018ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00018d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d10: 2020 2023 204b 6565 7020 6e6f 6e2d 6e61     # Keep non-na
-00018d20: 6e2c 2064 726f 7020 6e61 6e73 0a20 2020  n, drop nans.   
+00017d90: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
+00017da0: 203d 2033 0a20 2020 2020 2020 2020 2020   = 3.           
+00017db0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00017dc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00017dd0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00017de0: 6872 6573 686f 6c64 203d 2032 0a20 2020  hreshold = 2.   
+00017df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e00: 2069 6620 6e6d 203c 3d20 7468 7265 7368   if nm <= thresh
+00017e10: 6f6c 643a 0a20 2020 2020 2020 2020 2020  old:.           
+00017e20: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00017e30: 6465 6275 675f 7966 633a 0a20 2020 2020  debug_yfc:.     
+00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e50: 2020 2020 2020 206d 7367 203d 2022 2d20         msg = "- 
+00017e60: 666f 756e 6420 6d69 7373 696e 6720 696e  found missing in
+00017e70: 7465 7276 616c 732c 2069 6e73 6572 7469  tervals, inserti
+00017e80: 6e67 206e 616e 733a 220a 2020 2020 2020  ng nans:".      
+00017e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ea0: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
+00017eb0: 5072 696e 7428 6d73 6729 2069 6620 7966  Print(msg) if yf
+00017ec0: 636c 2e49 7354 7261 6369 6e67 456e 6162  cl.IsTracingEnab
+00017ed0: 6c65 6428 2920 656c 7365 2070 7269 6e74  led() else print
+00017ee0: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
+00017ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f00: 2020 7072 696e 7428 696e 7465 7276 616c    print(interval
+00017f10: 735f 6d69 7373 696e 675f 6466 5f72 6563  s_missing_df_rec
+00017f20: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+00017f30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00017f40: 6d69 7373 696e 675f 696e 7465 7276 616c  missing_interval
+00017f50: 735f 746f 5f61 6464 2069 7320 4e6f 6e65  s_to_add is None
+00017f60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017f70: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+00017f80: 7373 696e 675f 696e 7465 7276 616c 735f  ssing_intervals_
+00017f90: 746f 5f61 6464 203d 2069 6e74 6572 7661  to_add = interva
+00017fa0: 6c73 5f6d 6973 7369 6e67 5f64 665f 7265  ls_missing_df_re
+00017fb0: 6365 6e74 5b22 6f70 656e 225d 2e74 6f5f  cent["open"].to_
+00017fc0: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
+00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fe0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018000: 2020 6d69 7373 696e 675f 696e 7465 7276    missing_interv
+00018010: 616c 735f 746f 5f61 6464 203d 206e 702e  als_to_add = np.
+00018020: 6170 7065 6e64 286d 6973 7369 6e67 5f69  append(missing_i
+00018030: 6e74 6572 7661 6c73 5f74 6f5f 6164 642c  ntervals_to_add,
+00018040: 2069 6e74 6572 7661 6c73 5f6d 6973 7369   intervals_missi
+00018050: 6e67 5f64 665f 7265 6365 6e74 5b22 6f70  ng_df_recent["op
+00018060: 656e 225d 2e74 6f5f 6e75 6d70 7928 2929  en"].to_numpy())
+00018070: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018080: 2020 6966 206d 6973 7369 6e67 5f69 6e74    if missing_int
+00018090: 6572 7661 6c73 5f74 6f5f 6164 6420 6973  ervals_to_add is
+000180a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000180b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000180c0: 203d 206d 6973 7369 6e67 5f69 6e74 6572   = missing_inter
+000180d0: 7661 6c73 5f74 6f5f 6164 642e 7368 6170  vals_to_add.shap
+000180e0: 655b 305d 0a20 2020 2020 2020 2020 2020  e[0].           
+000180f0: 2020 2020 2020 2020 2069 6620 6e20 3c3d           if n <=
+00018100: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
+00018110: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+00018120: 3d20 6622 696e 7365 7274 696e 6773 204e  = f"insertings N
+00018130: 614e 7320 666f 7220 7b6e 7d20 6d69 7373  aNs for {n} miss
+00018140: 696e 6720 696e 7465 7276 616c 733a 207b  ing intervals: {
+00018150: 6d69 7373 696e 675f 696e 7465 7276 616c  missing_interval
+00018160: 735f 746f 5f61 6464 7d22 0a20 2020 2020  s_to_add}".     
+00018170: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00018180: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00018190: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+000181a0: 203d 2066 2269 6e73 6572 7469 6e67 7320   = f"insertings 
+000181b0: 4e61 4e73 2066 6f72 207b 6e7d 206d 6973  NaNs for {n} mis
+000181c0: 7369 6e67 2069 6e74 6572 7661 6c73 220a  sing intervals".
+000181d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181e0: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
+000181f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018200: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00018210: 7261 6365 5072 696e 7428 272d 2027 202b  racePrint('- ' +
+00018220: 206d 7367 2920 6966 2079 6663 6c2e 4973   msg) if yfcl.Is
+00018230: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+00018240: 2065 6c73 6520 7072 696e 7428 272d 2027   else print('- '
+00018250: 202b 206d 7367 290a 2020 2020 2020 2020   + msg).        
+00018260: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00018270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018280: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00018290: 616e 6167 6572 2e4c 6f67 4576 656e 7428  anager.LogEvent(
+000182a0: 2269 6e66 6f22 2c20 2250 7269 6365 4d61  "info", "PriceMa
+000182b0: 6e61 6765 7222 2c20 6d73 6729 0a0a 2020  nager", msg)..  
+000182c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000182d0: 2020 6e6d 203d 206d 6973 7369 6e67 5f69    nm = missing_i
+000182e0: 6e74 6572 7661 6c73 5f74 6f5f 6164 642e  ntervals_to_add.
+000182f0: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
+00018300: 2020 2020 2020 2020 2020 2020 2064 665f               df_
+00018310: 6d69 7373 696e 6720 3d20 7064 2e44 6174  missing = pd.Dat
+00018320: 6146 7261 6d65 2864 6174 613d 7b6b 3a20  aFrame(data={k: 
+00018330: 5b6e 702e 6e61 6e5d 2a6e 6d20 666f 7220  [np.nan]*nm for 
+00018340: 6b20 696e 2079 6663 642e 7966 5f64 6174  k in yfcd.yf_dat
+00018350: 615f 636f 6c73 7d2c 2069 6e64 6578 3d6d  a_cols}, index=m
+00018360: 6973 7369 6e67 5f69 6e74 6572 7661 6c73  issing_intervals
+00018370: 5f74 6f5f 6164 6429 0a20 2020 2020 2020  _to_add).       
+00018380: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00018390: 2252 6570 6169 7265 643f 2220 696e 2064  "Repaired?" in d
+000183a0: 662e 636f 6c75 6d6e 733a 0a20 2020 2020  f.columns:.     
+000183b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183c0: 2020 2064 665f 6d69 7373 696e 675b 2252     df_missing["R
+000183d0: 6570 6169 7265 643f 225d 203d 2046 616c  epaired?"] = Fal
+000183e0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+000183f0: 2020 2020 2020 2064 665f 6d69 7373 696e         df_missin
+00018400: 672e 696e 6465 7820 3d20 7064 2e74 6f5f  g.index = pd.to_
+00018410: 6461 7465 7469 6d65 2864 665f 6d69 7373  datetime(df_miss
+00018420: 696e 672e 696e 6465 7829 0a20 2020 2020  ing.index).     
+00018430: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018440: 6620 7365 6c66 2e69 6e74 6572 6461 793a  f self.interday:
+00018450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018460: 2020 2020 2020 2020 2064 665f 6d69 7373           df_miss
+00018470: 696e 672e 696e 6465 7820 3d20 6466 5f6d  ing.index = df_m
+00018480: 6973 7369 6e67 2e69 6e64 6578 2e74 7a5f  issing.index.tz_
+00018490: 6c6f 6361 6c69 7a65 2874 7a5f 6578 6368  localize(tz_exch
+000184a0: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
+000184b0: 2020 2020 2020 2020 2020 666f 7220 6320            for c 
+000184c0: 696e 205b 2256 6f6c 756d 6522 2c20 2244  in ["Volume", "D
+000184d0: 6976 6964 656e 6473 222c 2022 5374 6f63  ividends", "Stoc
+000184e0: 6b20 5370 6c69 7473 225d 3a0a 2020 2020  k Splits"]:.    
+000184f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018500: 2020 2020 6466 5f6d 6973 7369 6e67 5b63      df_missing[c
+00018510: 5d20 3d20 300a 2020 2020 2020 2020 2020  ] = 0.          
+00018520: 2020 2020 2020 2020 2020 6966 2064 6620            if df 
+00018530: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00018540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018550: 2064 6620 3d20 6466 5f6d 6973 7369 6e67   df = df_missing
+00018560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018570: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018590: 2020 2064 6620 3d20 7064 2e63 6f6e 6361     df = pd.conca
+000185a0: 7428 5b64 662c 2064 665f 6d69 7373 696e  t([df, df_missin
+000185b0: 675d 2c20 736f 7274 3d54 7275 6529 0a20  g], sort=True). 
+000185c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185d0: 2020 2020 2020 2064 662e 696e 6465 7820         df.index 
+000185e0: 3d20 7064 2e74 6f5f 6461 7465 7469 6d65  = pd.to_datetime
+000185f0: 2864 662e 696e 6465 782c 2075 7463 3d54  (df.index, utc=T
+00018600: 7275 6529 2e74 7a5f 636f 6e76 6572 7428  rue).tz_convert(
+00018610: 747a 5f65 7863 6861 6e67 6529 0a20 2020  tz_exchange).   
+00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018630: 2020 2020 2064 6620 3d20 6466 2e73 6f72       df = df.sor
+00018640: 745f 696e 6465 7828 290a 0a20 2020 2020  t_index()..     
+00018650: 2020 2023 2049 6d70 726f 7665 2074 6f6c     # Improve tol
+00018660: 6572 616e 6365 2074 6f20 6361 6c65 6e64  erance to calend
+00018670: 6172 206d 6973 7369 6e67 2061 2072 6563  ar missing a rec
+00018680: 656e 7420 6e65 7720 686f 6c69 6461 793a  ent new holiday:
+00018690: 0a20 2020 2020 2020 2069 6620 2864 6620  .        if (df 
+000186a0: 6973 204e 6f6e 6529 206f 7220 6466 2e65  is None) or df.e
+000186b0: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
+000186c0: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+000186d0: 2020 2020 2020 206e 203d 2064 662e 7368         n = df.sh
+000186e0: 6170 655b 305d 0a0a 2020 2020 2020 2020  ape[0]..        
+000186f0: 6665 7463 685f 6474 203d 2066 6574 6368  fetch_dt = fetch
+00018700: 5f64 745f 7574 632e 7265 706c 6163 6528  _dt_utc.replace(
+00018710: 747a 696e 666f 3d5a 6f6e 6549 6e66 6f28  tzinfo=ZoneInfo(
+00018720: 2255 5443 2229 290a 0a20 2020 2020 2020  "UTC"))..       
+00018730: 2023 2052 656d 6f76 6520 616e 7920 6f75   # Remove any ou
+00018740: 742d 6f66 2d72 616e 6765 2064 6174 613a  t-of-range data:
+00018750: 0a20 2020 2020 2020 2069 6620 286e 203e  .        if (n >
+00018760: 2030 2920 616e 6420 2870 7374 7220 6973   0) and (pstr is
+00018770: 204e 6f6e 6529 3a0a 2020 2020 2020 2020   None):.        
+00018780: 2020 2020 2320 4e4f 5445 3a20 5946 2068      # NOTE: YF h
+00018790: 6173 2061 2062 7567 2d66 6978 2070 656e  as a bug-fix pen
+000187a0: 6469 6e67 206d 6572 6765 3a20 6874 7470  ding merge: http
+000187b0: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f72  s://github.com/r
+000187c0: 616e 6172 6f75 7373 692f 7966 696e 616e  anaroussi/yfinan
+000187d0: 6365 2f70 756c 6c2f 3130 3132 0a20 2020  ce/pull/1012.   
+000187e0: 2020 2020 2020 2020 2069 6620 656e 6420           if end 
+000187f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00018800: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00018810: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
+00018820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018830: 2020 2064 6620 3d20 6466 5b64 662e 696e     df = df[df.in
+00018840: 6465 782e 6461 7465 203c 2065 6e64 5f64  dex.date < end_d
+00018850: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00018860: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018870: 2020 2020 2020 2020 2020 2020 6466 203d              df =
+00018880: 2064 665b 6466 2e69 6e64 6578 203c 2065   df[df.index < e
+00018890: 6e64 5f64 745d 0a20 2020 2020 2020 2020  nd_dt].         
+000188a0: 2020 2020 2020 206e 203d 2064 662e 7368         n = df.sh
+000188b0: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
+000188c0: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
+000188d0: 2023 2041 6e64 2061 6761 696e 2066 6f72   # And again for
+000188e0: 2070 7265 2d73 7461 7274 2064 6174 613a   pre-start data:
+000188f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00018900: 7374 6172 7420 6973 206e 6f74 204e 6f6e  start is not Non
+00018910: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00018920: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
+00018930: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
+00018940: 2020 2020 2020 2020 2064 6620 3d20 6466           df = df
+00018950: 5b64 662e 696e 6465 782e 6461 7465 203e  [df.index.date >
+00018960: 3d20 7374 6172 745f 645d 0a20 2020 2020  = start_d].     
+00018970: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00018980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018990: 2020 2020 2064 6620 3d20 6466 5b64 662e       df = df[df.
+000189a0: 696e 6465 7820 3e3d 2073 7461 7274 5f64  index >= start_d
+000189b0: 745d 0a20 2020 2020 2020 2020 2020 2020  t].             
+000189c0: 2020 206e 203d 2064 662e 7368 6170 655b     n = df.shape[
+000189d0: 305d 0a0a 2020 2020 2020 2020 2320 5665  0]..        # Ve
+000189e0: 7269 6679 2074 6861 7420 616c 6c20 6461  rify that all da
+000189f0: 7465 7469 6d65 7320 6d61 7463 6820 7570  tetimes match up
+00018a00: 2077 6974 6820 6163 7475 616c 2069 6e74   with actual int
+00018a10: 6572 7661 6c73 3a0a 2020 2020 2020 2020  ervals:.        
+00018a20: 6966 206e 203d 3d20 303a 0a20 2020 2020  if n == 0:.     
+00018a30: 2020 2020 2020 2072 6169 7365 2079 6663         raise yfc
+00018a40: 642e 4e6f 5072 6963 6544 6174 6149 6e52  d.NoPriceDataInR
+00018a50: 616e 6765 4578 6365 7074 696f 6e28 7365  angeException(se
+00018a60: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
+00018a70: 6973 7472 2c20 7374 6172 742c 2065 6e64  istr, start, end
+00018a80: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00018a90: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00018aa0: 656c 662e 696e 7465 7264 6179 3a0a 2020  elf.interday:.  
+00018ab0: 2020 2020 2020 2020 2020 2020 2020 6620                f 
+00018ac0: 3d20 6466 2e69 6e64 6578 2e74 696d 6520  = df.index.time 
+00018ad0: 213d 2074 696d 6528 3029 0a20 2020 2020  != time(0).     
+00018ae0: 2020 2020 2020 2020 2020 2069 6620 662e             if f.
+00018af0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+00018b00: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00018b10: 2864 665b 665d 290a 2020 2020 2020 2020  (df[f]).        
+00018b20: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00018b30: 6520 4578 6365 7074 696f 6e28 2249 6e74  e Exception("Int
+00018b40: 6572 6461 7920 6461 7461 2063 6f6e 7461  erday data conta
+00018b50: 696e 7320 7469 6d65 7320 696e 2069 6e64  ins times in ind
+00018b60: 6578 2229 0a20 2020 2020 2020 2020 2020  ex").           
+00018b70: 2020 2020 2079 6649 6e74 6572 7661 6c53       yfIntervalS
+00018b80: 7461 7274 7320 3d20 6466 2e69 6e64 6578  tarts = df.index
+00018b90: 2e64 6174 650a 2020 2020 2020 2020 2020  .date.          
+00018ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018bb0: 2020 2020 2020 2020 7966 496e 7465 7276          yfInterv
+00018bc0: 616c 5374 6172 7473 203d 2064 662e 696e  alStarts = df.in
+00018bd0: 6465 782e 746f 5f70 7964 6174 6574 696d  dex.to_pydatetim
+00018be0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00018bf0: 230a 2020 2020 2020 2020 2020 2020 6966  #.            if
+00018c00: 2073 656c 662e 696e 7472 6164 6179 2061   self.intraday a
+00018c10: 6e64 2028 7365 6c66 2e65 7863 6861 6e67  nd (self.exchang
+00018c20: 6520 696e 2079 6663 642e 6578 6368 616e  e in yfcd.exchan
+00018c30: 6765 7357 6974 6842 7265 616b 7329 3a0a  gesWithBreaks):.
+00018c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c50: 2320 4469 7363 6172 6420 616e 7920 696e  # Discard any in
+00018c60: 7465 7276 616c 7320 6675 6c6c 7920 7769  tervals fully wi
+00018c70: 7468 696e 2061 2062 7265 616b 0a20 2020  thin a break.   
+00018c80: 2020 2020 2020 2020 2020 2020 2066 5f69               f_i
+00018c90: 6e5f 6272 6561 6b20 3d20 7966 6374 2e54  n_break = yfct.T
+00018ca0: 696d 6573 7461 6d70 496e 4272 6561 6b5f  imestampInBreak_
+00018cb0: 6261 7463 6828 7365 6c66 2e65 7863 6861  batch(self.excha
+00018cc0: 6e67 652c 2079 6649 6e74 6572 7661 6c53  nge, yfIntervalS
+00018cd0: 7461 7274 732c 2073 656c 662e 696e 7465  tarts, self.inte
+00018ce0: 7276 616c 290a 2020 2020 2020 2020 2020  rval).          
+00018cf0: 2020 2020 2020 6966 2066 5f69 6e5f 6272        if f_in_br
+00018d00: 6561 6b2e 616e 7928 293a 0a20 2020 2020  eak.any():.     
+00018d10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018d20: 2044 6973 6361 7264 2074 6865 7365 0a20   Discard these. 
 00018d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d40: 2020 2020 2020 2020 2064 726f 705f 6474           drop_dt
-00018d50: 735f 7375 6220 3d20 6474 735b 6474 735f  s_sub = dts[dts_
-00018d60: 6973 5f6e 616e 5d0a 2020 2020 2020 2020  is_nan].        
-00018d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d80: 6472 6f70 5f64 7473 203d 2064 726f 705f  drop_dts = drop_
-00018d90: 6474 735f 7375 6220 6966 2064 726f 705f  dts_sub if drop_
-00018da0: 6474 7320 6973 204e 6f6e 6520 656c 7365  dts is None else
-00018db0: 206e 702e 6170 7065 6e64 2864 726f 705f   np.append(drop_
-00018dc0: 6474 732c 2064 726f 705f 6474 735f 7375  dts, drop_dts_su
-00018dd0: 6229 0a20 2020 2020 2020 2020 2020 2020  b).             
-00018de0: 2020 2020 2020 2023 2070 7269 6e74 2822         # print("
-00018df0: 6472 6f70 7069 6e67 3a22 2c20 6472 6f70  dropping:", drop
-00018e00: 5f64 7473 290a 2020 2020 2020 2020 2020  _dts).          
-00018e10: 2020 2020 2020 2020 2020 7966 496e 7465            yfInte
-00018e20: 7276 616c 5374 6172 7473 203d 206e 702e  rvalStarts = np.
-00018e30: 6465 6c65 7465 2879 6649 6e74 6572 7661  delete(yfInterva
-00018e40: 6c53 7461 7274 732c 205b 6466 2e69 6e64  lStarts, [df.ind
-00018e50: 6578 2e67 6574 5f6c 6f63 2864 7429 2066  ex.get_loc(dt) f
-00018e60: 6f72 2064 7420 696e 2064 726f 705f 6474  or dt in drop_dt
-00018e70: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
-00018e80: 2020 2020 2020 2020 696e 7465 7276 616c          interval
-00018e90: 7320 3d20 696e 7465 7276 616c 732e 6472  s = intervals.dr
-00018ea0: 6f70 2864 726f 705f 6474 7329 0a20 2020  op(drop_dts).   
-00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ec0: 2064 6620 3d20 6466 2e64 726f 7028 6472   df = df.drop(dr
-00018ed0: 6f70 5f64 7473 290a 2020 2020 2020 2020  op_dts).        
-00018ee0: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
-00018ef0: 6466 2e73 6861 7065 5b30 5d0a 2020 2020  df.shape[0].    
-00018f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f10: 665f 6e61 203d 2069 6e74 6572 7661 6c73  f_na = intervals
-00018f20: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
-00018f30: 5d2e 6973 6e61 2829 2e74 6f5f 6e75 6d70  ].isna().to_nump
-00018f40: 7928 290a 0a20 2020 2020 2020 2020 2020  y()..           
-00018f50: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00018f60: 2e69 6e74 6572 6461 793a 0a20 2020 2020  .interday:.     
-00018f70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00018f80: 2046 6f72 2073 6f6d 6520 6578 6368 616e   For some exchan
-00018f90: 6765 7320 2865 2e67 2e20 4a53 4529 2059  ges (e.g. JSE) Y
-00018fa0: 6168 6f6f 2072 6574 7572 6e73 2069 6e74  ahoo returns int
-00018fb0: 7261 6461 7920 7469 6d65 7374 616d 7073  raday timestamps
-00018fc0: 2072 6967 6874 206f 6e20 6d61 726b 6574   right on market
-00018fd0: 2063 6c6f 7365 2e0a 2020 2020 2020 2020   close..        
-00018fe0: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
-00018ff0: 7265 6d6f 7665 2069 6620 766f 6c75 6d65  remove if volume
-00019000: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00019010: 2020 2020 2020 2023 202d 2065 6c73 652c         # - else,
-00019020: 206d 6572 6765 2077 6974 6820 7072 6576   merge with prev
-00019030: 696f 7573 2069 6e74 6572 7661 6c0a 2020  ious interval.  
-00019040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019050: 2020 6466 3220 3d20 6466 2e63 6f70 7928    df2 = df.copy(
-00019060: 2920 3b20 6466 325b 225f 6461 7465 225d  ) ; df2["_date"]
-00019070: 203d 2064 6632 2e69 6e64 6578 2e64 6174   = df2.index.dat
-00019080: 6520 3b20 6466 325b 225f 696e 7465 7276  e ; df2["_interv
-00019090: 616c 5374 6172 7422 5d20 3d20 6466 322e  alStart"] = df2.
-000190a0: 696e 6465 780a 2020 2020 2020 2020 2020  index.          
-000190b0: 2020 2020 2020 2020 2020 7363 6865 6420            sched 
-000190c0: 3d20 7966 6374 2e47 6574 4578 6368 616e  = yfct.GetExchan
-000190d0: 6765 5363 6865 6475 6c65 2873 656c 662e  geSchedule(self.
-000190e0: 6578 6368 616e 6765 2c20 6466 325b 225f  exchange, df2["_
-000190f0: 6461 7465 225d 2e6d 696e 2829 2c20 6466  date"].min(), df
-00019100: 325b 225f 6461 7465 225d 2e6d 6178 2829  2["_date"].max()
-00019110: 2b74 645f 3164 290a 2020 2020 2020 2020  +td_1d).        
-00019120: 2020 2020 2020 2020 2020 2020 7265 6e61              rena
-00019130: 6d65 5f63 6f6c 7320 3d20 7b22 6f70 656e  me_cols = {"open
-00019140: 223a 2022 6d61 726b 6574 5f6f 7065 6e22  ": "market_open"
-00019150: 2c20 2263 6c6f 7365 223a 2022 6d61 726b  , "close": "mark
-00019160: 6574 5f63 6c6f 7365 227d 0a20 2020 2020  et_close"}.     
-00019170: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019180: 6368 6564 2e63 6f6c 756d 6e73 203d 205b  ched.columns = [
-00019190: 7265 6e61 6d65 5f63 6f6c 735b 635d 2069  rename_cols[c] i
-000191a0: 6620 6320 696e 2072 656e 616d 655f 636f  f c in rename_co
-000191b0: 6c73 2065 6c73 6520 6320 666f 7220 6320  ls else c for c 
-000191c0: 696e 2073 6368 6564 2e63 6f6c 756d 6e73  in sched.columns
-000191d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000191e0: 2020 2020 2020 7363 6865 645f 6466 203d        sched_df =
-000191f0: 2073 6368 6564 2e63 6f70 7928 290a 2020   sched.copy().  
-00019200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019210: 2020 7363 6865 645f 6466 5b22 5f64 6174    sched_df["_dat
-00019220: 6522 5d20 3d20 7363 6865 645f 6466 2e69  e"] = sched_df.i
-00019230: 6e64 6578 2e64 6174 650a 2020 2020 2020  ndex.date.      
-00019240: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00019250: 3220 3d20 6466 322e 6d65 7267 6528 7363  2 = df2.merge(sc
-00019260: 6865 645f 6466 2c20 6f6e 3d22 5f64 6174  hed_df, on="_dat
-00019270: 6522 2c20 686f 773d 226c 6566 7422 290a  e", how="left").
+00018d40: 2020 2069 6620 6465 6275 675f 7966 633a     if debug_yfc:
+00018d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018d60: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
+00018d70: 2d20 6472 6f70 7069 6e67 2072 6f77 7320  - dropping rows 
+00018d80: 696e 2062 7265 616b 2074 696d 6573 220a  in break times".
+00018d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018da0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00018db0: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+00018dc0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+00018dd0: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+00018de0: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
+00018df0: 2020 2020 2020 2020 2020 2020 7966 496e              yfIn
+00018e00: 7465 7276 616c 5374 6172 7473 203d 2079  tervalStarts = y
+00018e10: 6649 6e74 6572 7661 6c53 7461 7274 735b  fIntervalStarts[
+00018e20: 7e66 5f69 6e5f 6272 6561 6b5d 0a20 2020  ~f_in_break].   
+00018e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e40: 2064 6620 3d20 6466 5b7e 665f 696e 5f62   df = df[~f_in_b
+00018e50: 7265 616b 5d0a 2020 2020 2020 2020 2020  reak].          
+00018e60: 2020 2020 2020 2020 2020 6e20 3d20 6466            n = df
+00018e70: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+00018e80: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00018e90: 2020 2020 696e 7465 7276 616c 7320 3d20      intervals = 
+00018ea0: 7966 6374 2e47 6574 5469 6d65 7374 616d  yfct.GetTimestam
+00018eb0: 7043 7572 7265 6e74 496e 7465 7276 616c  pCurrentInterval
+00018ec0: 5f62 6174 6368 2873 656c 662e 6578 6368  _batch(self.exch
+00018ed0: 616e 6765 2c20 7966 496e 7465 7276 616c  ange, yfInterval
+00018ee0: 5374 6172 7473 2c20 7365 6c66 2e69 6e74  Starts, self.int
+00018ef0: 6572 7661 6c2c 2064 6973 6361 7264 5469  erval, discardTi
+00018f00: 6d65 733d 7365 6c66 2e69 6e74 6572 6461  mes=self.interda
+00018f10: 792c 2069 676e 6f72 655f 6272 6561 6b73  y, ignore_breaks
+00018f20: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+00018f30: 2020 2020 665f 6e61 203d 2069 6e74 6572      f_na = inter
+00018f40: 7661 6c73 5b22 696e 7465 7276 616c 5f6f  vals["interval_o
+00018f50: 7065 6e22 5d2e 6973 6e61 2829 2e74 6f5f  pen"].isna().to_
+00018f60: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
+00018f70: 2020 2020 6966 2076 6572 6966 795f 696e      if verify_in
+00018f80: 7465 7276 616c 7320 616e 6420 665f 6e61  tervals and f_na
+00018f90: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+00018fa0: 2020 2020 2020 2020 7473 203d 2069 6e74          ts = int
+00018fb0: 6572 7661 6c73 5b22 696e 7465 7276 616c  ervals["interval
+00018fc0: 5f6f 7065 6e22 5d0a 2020 2020 2020 2020  _open"].        
+00018fd0: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
+00018fe0: 7329 2021 3d20 6c65 6e28 7365 7428 7473  s) != len(set(ts
+00018ff0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00019000: 2020 2020 2020 2020 6475 7073 203d 2074          dups = t
+00019010: 735b 7473 2e64 7570 6c69 6361 7465 6428  s[ts.duplicated(
+00019020: 6b65 6570 3d46 616c 7365 295d 0a20 2020  keep=False)].   
+00019030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019040: 2023 2044 726f 7020 726f 7773 2074 6861   # Drop rows tha
+00019050: 7420 6d61 7020 746f 2064 7570 6c69 6361  t map to duplica
+00019060: 7465 2069 6e74 6572 7661 6c73 2069 6620  te intervals if 
+00019070: 6e6f 2074 7261 6469 6e67 206f 6363 7572  no trading occur
+00019080: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
+00019090: 2020 2020 2020 2020 2066 5f6e 6f5f 7472           f_no_tr
+000190a0: 6164 6573 203d 2028 6466 5b22 566f 6c75  ades = (df["Volu
+000190b0: 6d65 225d 203d 3d20 3029 2026 2028 2864  me"] == 0) & ((d
+000190c0: 665b 224c 6f77 225d 203d 3d20 6466 5b22  f["Low"] == df["
+000190d0: 4869 6768 225d 2920 7c20 6466 5b22 436c  High"]) | df["Cl
+000190e0: 6f73 6522 5d2e 6973 6e61 2829 290a 2020  ose"].isna()).  
+000190f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019100: 2020 6472 6f70 5f64 7473 203d 204e 6f6e    drop_dts = Non
+00019110: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00019120: 2020 2020 2020 666f 7220 6920 696e 2064        for i in d
+00019130: 7570 733a 0a20 2020 2020 2020 2020 2020  ups:.           
+00019140: 2020 2020 2020 2020 2020 2020 2064 7473               dts
+00019150: 203d 2069 6e74 6572 7661 6c73 2e69 6e64   = intervals.ind
+00019160: 6578 5b69 6e74 6572 7661 6c73 5b22 696e  ex[intervals["in
+00019170: 7465 7276 616c 5f6f 7065 6e22 5d20 3d3d  terval_open"] ==
+00019180: 2069 5d0a 2020 2020 2020 2020 2020 2020   i].            
+00019190: 2020 2020 2020 2020 2020 2020 6474 735f              dts_
+000191a0: 6973 5f6e 616e 203d 206e 702e 6172 7261  is_nan = np.arra
+000191b0: 7928 5b66 5f6e 6f5f 7472 6164 6573 5b64  y([f_no_trades[d
+000191c0: 662e 696e 6465 782e 6765 745f 6c6f 6328  f.index.get_loc(
+000191d0: 6474 295d 2066 6f72 2064 7420 696e 2064  dt)] for dt in d
+000191e0: 7473 5d29 0a20 2020 2020 2020 2020 2020  ts]).           
+000191f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00019200: 6474 735f 6973 5f6e 616e 2e61 6c6c 2829  dts_is_nan.all()
+00019210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019220: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019230: 4b65 6570 2066 6972 7374 2c20 6472 6f70  Keep first, drop
+00019240: 206f 7468 6572 730a 2020 2020 2020 2020   others.        
+00019250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019260: 2020 2020 6472 6f70 5f64 7473 5f73 7562      drop_dts_sub
+00019270: 203d 2064 7473 5b31 3a5d 0a20 2020 2020   = dts[1:].     
 00019280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019290: 2020 2020 6466 322e 696e 6465 7820 3d20      df2.index = 
-000192a0: 6466 2e69 6e64 6578 0a20 2020 2020 2020  df.index.       
-000192b0: 2020 2020 2020 2020 2020 2020 2066 5f63               f_c
-000192c0: 6c6f 7365 203d 2028 6466 325b 225f 696e  lose = (df2["_in
-000192d0: 7465 7276 616c 5374 6172 7422 5d20 3d3d  tervalStart"] ==
-000192e0: 2064 6632 5b22 6d61 726b 6574 5f63 6c6f   df2["market_clo
-000192f0: 7365 225d 292e 746f 5f6e 756d 7079 2829  se"]).to_numpy()
-00019300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019310: 2020 2020 2066 5f63 6c6f 7365 203d 2066       f_close = f
-00019320: 5f63 6c6f 7365 2026 2066 5f6e 610a 2020  _close & f_na.  
-00019330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019340: 2020 665f 766f 6c30 203d 2064 6632 5b22    f_vol0 = df2["
-00019350: 566f 6c75 6d65 225d 203d 3d20 300a 2020  Volume"] == 0.  
-00019360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019370: 2020 665f 6472 6f70 203d 2066 5f76 6f6c    f_drop = f_vol
-00019380: 3020 2620 665f 636c 6f73 650a 2020 2020  0 & f_close.    
-00019390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193a0: 6966 2066 5f64 726f 702e 616e 7928 293a  if f_drop.any():
-000193b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000193c0: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-000193d0: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-000193e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193f0: 2020 206d 7367 203d 2022 2d20 6472 6f70     msg = "- drop
-00019400: 7069 6e67 2030 2d76 6f6c 756d 6520 726f  ping 0-volume ro
-00019410: 7773 2073 7461 7274 696e 6720 6174 206d  ws starting at m
-00019420: 6172 6b65 7420 636c 6f73 6522 0a20 2020  arket close".   
-00019430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019440: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-00019450: 6163 6550 7269 6e74 286d 7367 2920 6966  acePrint(msg) if
-00019460: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
-00019470: 6e61 626c 6564 2829 2065 6c73 6520 7072  nabled() else pr
-00019480: 696e 7428 6d73 6729 0a20 2020 2020 2020  int(msg).       
-00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194a0: 2079 6649 6e74 6572 7661 6c53 7461 7274   yfIntervalStart
-000194b0: 7320 3d20 7966 496e 7465 7276 616c 5374  s = yfIntervalSt
-000194c0: 6172 7473 5b7e 665f 6472 6f70 5d0a 2020  arts[~f_drop].  
-000194d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194e0: 2020 2020 2020 696e 7465 7276 616c 7320        intervals 
-000194f0: 3d20 696e 7465 7276 616c 735b 7e66 5f64  = intervals[~f_d
-00019500: 726f 705d 0a20 2020 2020 2020 2020 2020  rop].           
-00019510: 2020 2020 2020 2020 2020 2020 2064 6620               df 
-00019520: 3d20 6466 5b7e 665f 6472 6f70 5d0a 2020  = df[~f_drop].  
-00019530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019540: 2020 2020 2020 6466 3220 3d20 6466 325b        df2 = df2[
-00019550: 7e66 5f64 726f 705d 0a20 2020 2020 2020  ~f_drop].       
-00019560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019570: 206e 203d 2064 662e 7368 6170 655b 305d   n = df.shape[0]
-00019580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019590: 2020 2020 2020 2020 2066 5f6e 6120 3d20           f_na = 
-000195a0: 696e 7465 7276 616c 735b 2269 6e74 6572  intervals["inter
-000195b0: 7661 6c5f 6f70 656e 225d 2e69 736e 6128  val_open"].isna(
-000195c0: 292e 746f 5f6e 756d 7079 2829 0a20 2020  ).to_numpy().   
-000195d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195e0: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
-000195f0: 2020 2020 2020 2066 5f63 6c6f 7365 203d         f_close =
-00019600: 2028 6466 325b 225f 696e 7465 7276 616c   (df2["_interval
-00019610: 5374 6172 7422 5d20 3d3d 2064 6632 5b22  Start"] == df2["
-00019620: 6d61 726b 6574 5f63 6c6f 7365 225d 292e  market_close"]).
-00019630: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-00019640: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00019650: 5f63 6c6f 7365 203d 2066 5f63 6c6f 7365  _close = f_close
-00019660: 2026 2066 5f6e 610a 2020 2020 2020 2020   & f_na.        
-00019670: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00019680: 5f63 6c6f 7365 2e61 6e79 2829 3a0a 2020  _close.any():.  
-00019690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196a0: 2020 2020 2020 2320 4d75 7374 206d 6572        # Must mer
-000196b0: 6765 2077 6974 6820 7072 6576 696f 7573  ge with previous
-000196c0: 2069 6e74 6572 7661 6c2e 2054 7269 636b   interval. Trick
-000196d0: 7921 0a20 2020 2020 2020 2020 2020 2020  y!.             
-000196e0: 2020 2020 2020 2020 2020 2064 6633 203d             df3 =
-000196f0: 2064 6632 5b66 5f63 6c6f 7365 5d0a 2020   df2[f_close].  
-00019700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019710: 2020 2020 2020 6466 335f 696e 6465 785f        df3_index_
-00019720: 7265 7620 3d20 736f 7274 6564 286c 6973  rev = sorted(lis
-00019730: 7428 6466 332e 696e 6465 7829 2c20 7265  t(df3.index), re
-00019740: 7665 7273 653d 5472 7565 290a 2020 2020  verse=True).    
-00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019760: 2020 2020 666f 7220 6474 2069 6e20 6466      for dt in df
-00019770: 335f 696e 6465 785f 7265 763a 0a20 2020  3_index_rev:.   
-00019780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019790: 2020 2020 2020 2020 2069 203d 2064 662e           i = df.
-000197a0: 696e 6465 782e 6765 745f 6c6f 6328 6474  index.get_loc(dt
-000197b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000197c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000197d0: 2069 203d 3d20 303a 0a20 2020 2020 2020   i == 0:.       
+00019290: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000192a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192b0: 2020 2020 2023 204b 6565 7020 6e6f 6e2d       # Keep non-
+000192c0: 6e61 6e2c 2064 726f 7020 6e61 6e73 0a20  nan, drop nans. 
+000192d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192e0: 2020 2020 2020 2020 2020 2064 726f 705f             drop_
+000192f0: 6474 735f 7375 6220 3d20 6474 735b 6474  dts_sub = dts[dt
+00019300: 735f 6973 5f6e 616e 5d0a 2020 2020 2020  s_is_nan].      
+00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019320: 2020 6472 6f70 5f64 7473 203d 2064 726f    drop_dts = dro
+00019330: 705f 6474 735f 7375 6220 6966 2064 726f  p_dts_sub if dro
+00019340: 705f 6474 7320 6973 204e 6f6e 6520 656c  p_dts is None el
+00019350: 7365 206e 702e 6170 7065 6e64 2864 726f  se np.append(dro
+00019360: 705f 6474 732c 2064 726f 705f 6474 735f  p_dts, drop_dts_
+00019370: 7375 6229 0a20 2020 2020 2020 2020 2020  sub).           
+00019380: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+00019390: 2822 6472 6f70 7069 6e67 3a22 2c20 6472  ("dropping:", dr
+000193a0: 6f70 5f64 7473 290a 2020 2020 2020 2020  op_dts).        
+000193b0: 2020 2020 2020 2020 2020 2020 7966 496e              yfIn
+000193c0: 7465 7276 616c 5374 6172 7473 203d 206e  tervalStarts = n
+000193d0: 702e 6465 6c65 7465 2879 6649 6e74 6572  p.delete(yfInter
+000193e0: 7661 6c53 7461 7274 732c 205b 6466 2e69  valStarts, [df.i
+000193f0: 6e64 6578 2e67 6574 5f6c 6f63 2864 7429  ndex.get_loc(dt)
+00019400: 2066 6f72 2064 7420 696e 2064 726f 705f   for dt in drop_
+00019410: 6474 735d 290a 2020 2020 2020 2020 2020  dts]).          
+00019420: 2020 2020 2020 2020 2020 696e 7465 7276            interv
+00019430: 616c 7320 3d20 696e 7465 7276 616c 732e  als = intervals.
+00019440: 6472 6f70 2864 726f 705f 6474 7329 0a20  drop(drop_dts). 
+00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019460: 2020 2064 6620 3d20 6466 2e64 726f 7028     df = df.drop(
+00019470: 6472 6f70 5f64 7473 290a 2020 2020 2020  drop_dts).      
+00019480: 2020 2020 2020 2020 2020 2020 2020 6e20                n 
+00019490: 3d20 6466 2e73 6861 7065 5b30 5d0a 2020  = df.shape[0].  
+000194a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194b0: 2020 665f 6e61 203d 2069 6e74 6572 7661    f_na = interva
+000194c0: 6c73 5b22 696e 7465 7276 616c 5f6f 7065  ls["interval_ope
+000194d0: 6e22 5d2e 6973 6e61 2829 2e74 6f5f 6e75  n"].isna().to_nu
+000194e0: 6d70 7928 290a 0a20 2020 2020 2020 2020  mpy()..         
+000194f0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00019500: 6c66 2e69 6e74 6572 6461 793a 0a20 2020  lf.interday:.   
+00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019520: 2023 2046 6f72 2073 6f6d 6520 6578 6368   # For some exch
+00019530: 616e 6765 7320 2865 2e67 2e20 4a53 4529  anges (e.g. JSE)
+00019540: 2059 6168 6f6f 2072 6574 7572 6e73 2069   Yahoo returns i
+00019550: 6e74 7261 6461 7920 7469 6d65 7374 616d  ntraday timestam
+00019560: 7073 2072 6967 6874 206f 6e20 6d61 726b  ps right on mark
+00019570: 6574 2063 6c6f 7365 2e0a 2020 2020 2020  et close..      
+00019580: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019590: 2d20 7265 6d6f 7665 2069 6620 766f 6c75  - remove if volu
+000195a0: 6d65 2030 0a20 2020 2020 2020 2020 2020  me 0.           
+000195b0: 2020 2020 2020 2020 2023 202d 2065 6c73           # - els
+000195c0: 652c 206d 6572 6765 2077 6974 6820 7072  e, merge with pr
+000195d0: 6576 696f 7573 2069 6e74 6572 7661 6c0a  evious interval.
+000195e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000195f0: 2020 2020 6466 3220 3d20 6466 2e63 6f70      df2 = df.cop
+00019600: 7928 2920 3b20 6466 325b 225f 6461 7465  y() ; df2["_date
+00019610: 225d 203d 2064 6632 2e69 6e64 6578 2e64  "] = df2.index.d
+00019620: 6174 6520 3b20 6466 325b 225f 696e 7465  ate ; df2["_inte
+00019630: 7276 616c 5374 6172 7422 5d20 3d20 6466  rvalStart"] = df
+00019640: 322e 696e 6465 780a 2020 2020 2020 2020  2.index.        
+00019650: 2020 2020 2020 2020 2020 2020 7363 6865              sche
+00019660: 6420 3d20 7966 6374 2e47 6574 4578 6368  d = yfct.GetExch
+00019670: 616e 6765 5363 6865 6475 6c65 2873 656c  angeSchedule(sel
+00019680: 662e 6578 6368 616e 6765 2c20 6466 325b  f.exchange, df2[
+00019690: 225f 6461 7465 225d 2e6d 696e 2829 2c20  "_date"].min(), 
+000196a0: 6466 325b 225f 6461 7465 225d 2e6d 6178  df2["_date"].max
+000196b0: 2829 2b74 645f 3164 290a 2020 2020 2020  ()+td_1d).      
+000196c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000196d0: 6e61 6d65 5f63 6f6c 7320 3d20 7b22 6f70  name_cols = {"op
+000196e0: 656e 223a 2022 6d61 726b 6574 5f6f 7065  en": "market_ope
+000196f0: 6e22 2c20 2263 6c6f 7365 223a 2022 6d61  n", "close": "ma
+00019700: 726b 6574 5f63 6c6f 7365 227d 0a20 2020  rket_close"}.   
+00019710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019720: 2073 6368 6564 2e63 6f6c 756d 6e73 203d   sched.columns =
+00019730: 205b 7265 6e61 6d65 5f63 6f6c 735b 635d   [rename_cols[c]
+00019740: 2069 6620 6320 696e 2072 656e 616d 655f   if c in rename_
+00019750: 636f 6c73 2065 6c73 6520 6320 666f 7220  cols else c for 
+00019760: 6320 696e 2073 6368 6564 2e63 6f6c 756d  c in sched.colum
+00019770: 6e73 5d0a 2020 2020 2020 2020 2020 2020  ns].            
+00019780: 2020 2020 2020 2020 7363 6865 645f 6466          sched_df
+00019790: 203d 2073 6368 6564 2e63 6f70 7928 290a   = sched.copy().
+000197a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000197b0: 2020 2020 7363 6865 645f 6466 5b22 5f64      sched_df["_d
+000197c0: 6174 6522 5d20 3d20 7363 6865 645f 6466  ate"] = sched_df
+000197d0: 2e69 6e64 6578 2e64 6174 650a 2020 2020  .index.date.    
 000197e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197f0: 2020 2020 2020 2020 2023 2043 616e 2774           # Can't
-00019800: 2066 6978 0a20 2020 2020 2020 2020 2020   fix.           
-00019810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019820: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00019830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019840: 2020 2020 2020 2020 2020 6474 5f62 6566            dt_bef
-00019850: 6f72 6520 3d20 6466 2e69 6e64 6578 5b69  ore = df.index[i
-00019860: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
-00019870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019880: 6966 2028 6474 2d64 745f 6265 666f 7265  if (dt-dt_before
-00019890: 2920 3c3d 2073 656c 662e 6974 643a 0a20  ) <= self.itd:. 
-000198a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000198c0: 204d 6572 6765 0a20 2020 2020 2020 2020   Merge.         
+000197f0: 6466 3220 3d20 6466 322e 6d65 7267 6528  df2 = df2.merge(
+00019800: 7363 6865 645f 6466 2c20 6f6e 3d22 5f64  sched_df, on="_d
+00019810: 6174 6522 2c20 686f 773d 226c 6566 7422  ate", how="left"
+00019820: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00019830: 2020 2020 2020 6466 322e 696e 6465 7820        df2.index 
+00019840: 3d20 6466 2e69 6e64 6578 0a20 2020 2020  = df.index.     
+00019850: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00019860: 5f63 6c6f 7365 203d 2028 6466 325b 225f  _close = (df2["_
+00019870: 696e 7465 7276 616c 5374 6172 7422 5d20  intervalStart"] 
+00019880: 3d3d 2064 6632 5b22 6d61 726b 6574 5f63  == df2["market_c
+00019890: 6c6f 7365 225d 292e 746f 5f6e 756d 7079  lose"]).to_numpy
+000198a0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000198b0: 2020 2020 2020 2066 5f63 6c6f 7365 203d         f_close =
+000198c0: 2066 5f63 6c6f 7365 2026 2066 5f6e 610a   f_close & f_na.
 000198d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198e0: 2020 2020 2020 2064 665f 726f 7773 203d         df_rows =
-000198f0: 2064 662e 696c 6f63 5b69 2d31 3a69 2b31   df.iloc[i-1:i+1
-00019900: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00019910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019920: 2020 6466 2e6c 6f63 5b64 745f 6265 666f    df.loc[dt_befo
-00019930: 7265 2c20 224c 6f77 225d 203d 2064 665f  re, "Low"] = df_
-00019940: 726f 7773 5b22 4c6f 7722 5d2e 6472 6f70  rows["Low"].drop
-00019950: 6e61 2829 2e6d 696e 2829 0a20 2020 2020  na().min().     
-00019960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019970: 2020 2020 2020 2020 2020 2064 662e 6c6f             df.lo
-00019980: 635b 6474 5f62 6566 6f72 652c 2022 4869  c[dt_before, "Hi
-00019990: 6768 225d 203d 2064 665f 726f 7773 5b22  gh"] = df_rows["
-000199a0: 4869 6768 225d 2e64 726f 706e 6128 292e  High"].dropna().
-000199b0: 6d61 7828 290a 2020 2020 2020 2020 2020  max().          
-000199c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199d0: 2020 2020 2020 6466 2e6c 6f63 5b64 745f        df.loc[dt_
-000199e0: 6265 666f 7265 2c20 224f 7065 6e22 5d20  before, "Open"] 
-000199f0: 3d20 6466 5f72 6f77 735b 224f 7065 6e22  = df_rows["Open"
-00019a00: 5d2e 6472 6f70 6e61 2829 5b30 5d0a 2020  ].dropna()[0].  
-00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a20: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00019a30: 2e6c 6f63 5b64 745f 6265 666f 7265 2c20  .loc[dt_before, 
-00019a40: 2243 6c6f 7365 225d 203d 2064 665f 726f  "Close"] = df_ro
-00019a50: 7773 5b22 436c 6f73 6522 5d2e 6472 6f70  ws["Close"].drop
-00019a60: 6e61 2829 5b2d 315d 0a20 2020 2020 2020  na()[-1].       
+000198e0: 2020 2020 665f 766f 6c30 203d 2064 6632      f_vol0 = df2
+000198f0: 5b22 566f 6c75 6d65 225d 203d 3d20 300a  ["Volume"] == 0.
+00019900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019910: 2020 2020 665f 6472 6f70 203d 2066 5f76      f_drop = f_v
+00019920: 6f6c 3020 2620 665f 636c 6f73 650a 2020  ol0 & f_close.  
+00019930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019940: 2020 6966 2066 5f64 726f 702e 616e 7928    if f_drop.any(
+00019950: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019960: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00019970: 6275 675f 7966 633a 0a20 2020 2020 2020  bug_yfc:.       
+00019980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019990: 2020 2020 206d 7367 203d 2022 2d20 6472       msg = "- dr
+000199a0: 6f70 7069 6e67 2030 2d76 6f6c 756d 6520  opping 0-volume 
+000199b0: 726f 7773 2073 7461 7274 696e 6720 6174  rows starting at
+000199c0: 206d 6172 6b65 7420 636c 6f73 6522 0a20   market close". 
+000199d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199e0: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+000199f0: 5472 6163 6550 7269 6e74 286d 7367 2920  TracePrint(msg) 
+00019a00: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
+00019a10: 6745 6e61 626c 6564 2829 2065 6c73 6520  gEnabled() else 
+00019a20: 7072 696e 7428 6d73 6729 0a20 2020 2020  print(msg).     
+00019a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a40: 2020 2079 6649 6e74 6572 7661 6c53 7461     yfIntervalSta
+00019a50: 7274 7320 3d20 7966 496e 7465 7276 616c  rts = yfInterval
+00019a60: 5374 6172 7473 5b7e 665f 6472 6f70 5d0a  Starts[~f_drop].
 00019a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a80: 2020 2020 2020 2020 2064 662e 6c6f 635b           df.loc[
-00019a90: 6474 5f62 6566 6f72 652c 2022 4164 6a20  dt_before, "Adj 
-00019aa0: 436c 6f73 6522 5d20 3d20 6466 5f72 6f77  Close"] = df_row
-00019ab0: 735b 2241 646a 2043 6c6f 7365 225d 2e64  s["Adj Close"].d
-00019ac0: 726f 706e 6128 295b 2d31 5d0a 2020 2020  ropna()[-1].    
+00019a80: 2020 2020 2020 2020 696e 7465 7276 616c          interval
+00019a90: 7320 3d20 696e 7465 7276 616c 735b 7e66  s = intervals[~f
+00019aa0: 5f64 726f 705d 0a20 2020 2020 2020 2020  _drop].         
+00019ab0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00019ac0: 6620 3d20 6466 5b7e 665f 6472 6f70 5d0a  f = df[~f_drop].
 00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ae0: 2020 2020 2020 2020 2020 2020 6466 2e6c              df.l
-00019af0: 6f63 5b64 745f 6265 666f 7265 2c20 2256  oc[dt_before, "V
-00019b00: 6f6c 756d 6522 5d20 3d20 6466 5f72 6f77  olume"] = df_row
-00019b10: 735b 2256 6f6c 756d 6522 5d2e 6472 6f70  s["Volume"].drop
-00019b20: 6e61 2829 2e73 756d 2829 0a0a 2020 2020  na().sum()..    
-00019b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b40: 2020 2020 2020 2020 2020 2020 7966 496e              yfIn
-00019b50: 7465 7276 616c 5374 6172 7473 203d 206e  tervalStarts = n
-00019b60: 702e 6465 6c65 7465 2879 6649 6e74 6572  p.delete(yfInter
-00019b70: 7661 6c53 7461 7274 732c 2069 290a 2020  valStarts, i).  
-00019b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019b90: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00019ba0: 7465 7276 616c 7320 3d20 696e 7465 7276  tervals = interv
-00019bb0: 616c 732e 6472 6f70 2864 7429 0a20 2020  als.drop(dt).   
-00019bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019bd0: 2020 2020 2020 2020 2020 2020 2064 6620               df 
-00019be0: 3d20 6466 2e64 726f 7028 6474 290a 2020  = df.drop(dt).  
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c00: 2020 2020 2020 2020 2020 2020 2020 6e20                n 
-00019c10: 3d20 6466 2e73 6861 7065 5b30 5d0a 2020  = df.shape[0].  
-00019c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c30: 2020 2020 2020 2020 2020 2020 2020 665f                f_
-00019c40: 6e61 203d 2069 6e74 6572 7661 6c73 5b22  na = intervals["
-00019c50: 696e 7465 7276 616c 5f6f 7065 6e22 5d2e  interval_open"].
-00019c60: 6973 6e61 2829 2e74 6f5f 6e75 6d70 7928  isna().to_numpy(
-00019c70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00019c80: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00019c90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00019ae0: 2020 2020 2020 2020 6466 3220 3d20 6466          df2 = df
+00019af0: 325b 7e66 5f64 726f 705d 0a20 2020 2020  2[~f_drop].     
+00019b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b10: 2020 206e 203d 2064 662e 7368 6170 655b     n = df.shape[
+00019b20: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00019b30: 2020 2020 2020 2020 2020 2066 5f6e 6120             f_na 
+00019b40: 3d20 696e 7465 7276 616c 735b 2269 6e74  = intervals["int
+00019b50: 6572 7661 6c5f 6f70 656e 225d 2e69 736e  erval_open"].isn
+00019b60: 6128 292e 746f 5f6e 756d 7079 2829 0a20  a().to_numpy(). 
+00019b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b80: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
+00019b90: 2020 2020 2020 2020 2066 5f63 6c6f 7365           f_close
+00019ba0: 203d 2028 6466 325b 225f 696e 7465 7276   = (df2["_interv
+00019bb0: 616c 5374 6172 7422 5d20 3d3d 2064 6632  alStart"] == df2
+00019bc0: 5b22 6d61 726b 6574 5f63 6c6f 7365 225d  ["market_close"]
+00019bd0: 292e 746f 5f6e 756d 7079 2829 0a20 2020  ).to_numpy().   
+00019be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019bf0: 2066 5f63 6c6f 7365 203d 2066 5f63 6c6f   f_close = f_clo
+00019c00: 7365 2026 2066 5f6e 610a 2020 2020 2020  se & f_na.      
+00019c10: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019c20: 2066 5f63 6c6f 7365 2e61 6e79 2829 3a0a   f_close.any():.
+00019c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c40: 2020 2020 2020 2020 2320 4d75 7374 206d          # Must m
+00019c50: 6572 6765 2077 6974 6820 7072 6576 696f  erge with previo
+00019c60: 7573 2069 6e74 6572 7661 6c2e 2054 7269  us interval. Tri
+00019c70: 636b 7921 0a20 2020 2020 2020 2020 2020  cky!.           
+00019c80: 2020 2020 2020 2020 2020 2020 2064 6633               df3
+00019c90: 203d 2064 6632 5b66 5f63 6c6f 7365 5d0a   = df2[f_close].
 00019ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cb0: 2020 2020 2320 5072 6576 696f 7573 2069      # Previous i
-00019cc0: 6e74 6572 7661 6c20 746f 6f20 6661 722c  nterval too far,
-00019cd0: 206d 7573 7420 696e 7365 7274 2061 206e   must insert a n
-00019ce0: 6577 2069 6e74 6572 7661 6c0a 2020 2020  ew interval.    
+00019cb0: 2020 2020 2020 2020 6466 335f 696e 6465          df3_inde
+00019cc0: 785f 7265 7620 3d20 736f 7274 6564 286c  x_rev = sorted(l
+00019cd0: 6973 7428 6466 332e 696e 6465 7829 2c20  ist(df3.index), 
+00019ce0: 7265 7665 7273 653d 5472 7565 290a 2020  reverse=True).  
 00019cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d00: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00019d10: 6520 4578 6365 7074 696f 6e28 2274 6869  e Exception("thi
-00019d20: 7320 636f 6465 2070 6174 6820 6e6f 7420  s code path not 
-00019d30: 7465 7374 6564 2c20 7265 7669 6577 2229  tested, review")
-00019d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d60: 2064 745f 636f 7272 6563 7420 3d20 6474   dt_correct = dt
-00019d70: 5f62 6566 6f72 6520 2b20 7365 6c66 2e69  _before + self.i
-00019d80: 7464 0a20 2020 2020 2020 2020 2020 2020  td.             
-00019d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019da0: 2020 2069 6620 6474 5f63 6f72 7265 6374     if dt_correct
-00019db0: 203e 3d20 6474 3a0a 2020 2020 2020 2020   >= dt:.        
-00019dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019dd0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00019de0: 6520 4578 6365 7074 696f 6e28 6622 6474  e Exception(f"dt
-00019df0: 5f63 6f72 7265 6374 3d7b 6474 5f63 6f72  _correct={dt_cor
-00019e00: 7265 6374 7d20 3e3d 2064 743d 7b64 747d  rect} >= dt={dt}
-00019e10: 202c 2065 7870 6563 7465 6420 3c22 290a   , expected <").
-00019e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e40: 6966 2064 745f 636f 7272 6563 742e 6461  if dt_correct.da
-00019e50: 7465 2829 2021 3d20 6474 2e64 6174 6528  te() != dt.date(
-00019e60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019d00: 2020 2020 2020 666f 7220 6474 2069 6e20        for dt in 
+00019d10: 6466 335f 696e 6465 785f 7265 763a 0a20  df3_index_rev:. 
+00019d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d30: 2020 2020 2020 2020 2020 2069 203d 2064             i = d
+00019d40: 662e 696e 6465 782e 6765 745f 6c6f 6328  f.index.get_loc(
+00019d50: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
+00019d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d70: 6966 2069 203d 3d20 303a 0a20 2020 2020  if i == 0:.     
+00019d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d90: 2020 2020 2020 2020 2020 2023 2043 616e             # Can
+00019da0: 2774 2066 6978 0a20 2020 2020 2020 2020  't fix.         
+00019db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019dc0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019de0: 2020 2020 2020 2020 2020 2020 6474 5f62              dt_b
+00019df0: 6566 6f72 6520 3d20 6466 2e69 6e64 6578  efore = df.index
+00019e00: 5b69 2d31 5d0a 2020 2020 2020 2020 2020  [i-1].          
+00019e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e20: 2020 6966 2028 6474 2d64 745f 6265 666f    if (dt-dt_befo
+00019e30: 7265 2920 3c3d 2073 656c 662e 6974 643a  re) <= self.itd:
+00019e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e60: 2023 204d 6572 6765 0a20 2020 2020 2020   # Merge.       
 00019e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e80: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-00019e90: 6570 7469 6f6e 2866 2264 745f 636f 7272  eption(f"dt_corr
-00019ea0: 6563 743d 7b64 745f 636f 7272 6563 747d  ect={dt_correct}
-00019eb0: 2026 2064 743d 7b64 747d 202c 2065 7870   & dt={dt} , exp
-00019ec0: 6563 7465 6420 7361 6d65 2064 6179 2229  ected same day")
-00019ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ef0: 2064 662e 6c6f 635b 6474 5f63 6f72 7265   df.loc[dt_corre
-00019f00: 6374 5d20 3d20 6466 2e6c 6f63 5b64 745d  ct] = df.loc[dt]
-00019f10: 203b 2064 6620 3d20 6466 2e64 726f 7028   ; df = df.drop(
-00019f20: 6474 292e 736f 7274 5f69 6e64 6578 2829  dt).sort_index()
-00019f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f50: 2079 6649 6e74 6572 7661 6c53 7461 7274   yfIntervalStart
-00019f60: 735b 695d 203d 2064 745f 636f 7272 6563  s[i] = dt_correc
-00019f70: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00019f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f90: 2020 696e 7465 7276 616c 7320 3d20 696e    intervals = in
-00019fa0: 7465 7276 616c 732e 6472 6f70 2864 7429  tervals.drop(dt)
-00019fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019e80: 2020 2020 2020 2020 2064 665f 726f 7773           df_rows
+00019e90: 203d 2064 662e 696c 6f63 5b69 2d31 3a69   = df.iloc[i-1:i
+00019ea0: 2b31 5d0a 2020 2020 2020 2020 2020 2020  +1].            
+00019eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ec0: 2020 2020 6466 2e6c 6f63 5b64 745f 6265      df.loc[dt_be
+00019ed0: 666f 7265 2c20 224c 6f77 225d 203d 2064  fore, "Low"] = d
+00019ee0: 665f 726f 7773 5b22 4c6f 7722 5d2e 6472  f_rows["Low"].dr
+00019ef0: 6f70 6e61 2829 2e6d 696e 2829 0a20 2020  opna().min().   
+00019f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f10: 2020 2020 2020 2020 2020 2020 2064 662e               df.
+00019f20: 6c6f 635b 6474 5f62 6566 6f72 652c 2022  loc[dt_before, "
+00019f30: 4869 6768 225d 203d 2064 665f 726f 7773  High"] = df_rows
+00019f40: 5b22 4869 6768 225d 2e64 726f 706e 6128  ["High"].dropna(
+00019f50: 292e 6d61 7828 290a 2020 2020 2020 2020  ).max().        
+00019f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f70: 2020 2020 2020 2020 6466 2e6c 6f63 5b64          df.loc[d
+00019f80: 745f 6265 666f 7265 2c20 224f 7065 6e22  t_before, "Open"
+00019f90: 5d20 3d20 6466 5f72 6f77 735b 224f 7065  ] = df_rows["Ope
+00019fa0: 6e22 5d2e 6472 6f70 6e61 2829 5b30 5d0a  n"].dropna()[0].
+00019fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fd0: 2069 6e74 6572 7661 6c73 2e6c 6f63 5b64   intervals.loc[d
-00019fe0: 745f 636f 7272 6563 745d 203d 207b 2269  t_correct] = {"i
-00019ff0: 6e74 6572 7661 6c5f 6f70 656e 223a 2064  nterval_open": d
-0001a000: 745f 636f 7272 6563 742c 2022 696e 7465  t_correct, "inte
-0001a010: 7276 616c 5f63 6c6f 7365 223a 2064 6632  rval_close": df2
-0001a020: 2e6c 6f63 5b64 742c 2022 6d61 726b 6574  .loc[dt, "market
-0001a030: 5f63 6c6f 7365 225d 7d0a 2020 2020 2020  _close"]}.      
-0001a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a050: 2020 2020 2020 2020 2020 665f 6e61 203d            f_na =
-0001a060: 2069 6e74 6572 7661 6c73 5b22 696e 7465   intervals["inte
-0001a070: 7276 616c 5f6f 7065 6e22 5d2e 6973 6e61  rval_open"].isna
-0001a080: 2829 2e74 6f5f 6e75 6d70 7928 290a 0a20  ().to_numpy().. 
-0001a090: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a0a0: 6620 665f 6e61 2e61 6e79 2829 3a0a 2020  f f_na.any():.  
-0001a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0c0: 2020 2320 466f 7220 736f 6d65 206e 6174    # For some nat
-0001a0d0: 696f 6e61 6c20 686f 6c69 6461 7973 2077  ional holidays w
-0001a0e0: 6865 6e20 6578 6368 616e 6765 2063 6c6f  hen exchange clo
-0001a0f0: 7365 642c 2059 6168 6f6f 2066 696c 6c73  sed, Yahoo fills
-0001a100: 2069 6e20 726f 772e 2043 6c75 6520 6973   in row. Clue is
-0001a110: 2030 2076 6f6c 756d 652e 0a20 2020 2020   0 volume..     
-0001a120: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001a130: 2053 6f6c 7574 696f 6e20 3d20 6472 6f70   Solution = drop
-0001a140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a150: 2020 2020 2020 665f 6e61 5f7a 6572 6f56        f_na_zeroV
-0001a160: 6f6c 203d 2066 5f6e 6120 2620 2864 665b  ol = f_na & (df[
-0001a170: 2256 6f6c 756d 6522 5d20 3d3d 2030 292e  "Volume"] == 0).
-0001a180: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
-0001a190: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a1a0: 6620 665f 6e61 5f7a 6572 6f56 6f6c 2e61  f f_na_zeroVol.a
-0001a1b0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-0001a1c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001a1d0: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
-0001a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1f0: 2020 2020 2020 2020 6d73 6720 3d20 222d          msg = "-
-0001a200: 2064 726f 7070 696e 6720 7b7d 2030 2d76   dropping {} 0-v
-0001a210: 6f6c 756d 6520 726f 7773 2077 6974 6820  olume rows with 
-0001a220: 6e6f 206d 6174 6368 696e 6720 696e 7465  no matching inte
-0001a230: 7276 616c 222e 666f 726d 6174 2873 756d  rval".format(sum
-0001a240: 2866 5f6e 615f 7a65 726f 566f 6c29 290a  (f_na_zeroVol)).
-0001a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a260: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
-0001a270: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
-0001a280: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
-0001a290: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
-0001a2a0: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
-0001a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2c0: 2020 2020 665f 6472 6f70 203d 2066 5f6e      f_drop = f_n
-0001a2d0: 615f 7a65 726f 566f 6c0a 2020 2020 2020  a_zeroVol.      
-0001a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2f0: 2020 7966 496e 7465 7276 616c 5374 6172    yfIntervalStar
-0001a300: 7473 203d 2079 6649 6e74 6572 7661 6c53  ts = yfIntervalS
-0001a310: 7461 7274 735b 7e66 5f64 726f 705d 0a20  tarts[~f_drop]. 
-0001a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a330: 2020 2020 2020 2069 6e74 6572 7661 6c73         intervals
-0001a340: 203d 2069 6e74 6572 7661 6c73 5b7e 665f   = intervals[~f_
-0001a350: 6472 6f70 5d0a 2020 2020 2020 2020 2020  drop].          
-0001a360: 2020 2020 2020 2020 2020 2020 2020 6466                df
-0001a370: 203d 2064 665b 7e66 5f64 726f 705d 0a20   = df[~f_drop]. 
-0001a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a390: 2020 2020 2020 206e 203d 2064 662e 7368         n = df.sh
-0001a3a0: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001a3c0: 5f6e 6120 3d20 696e 7465 7276 616c 735b  _na = intervals[
-0001a3d0: 2269 6e74 6572 7661 6c5f 6f70 656e 225d  "interval_open"]
-0001a3e0: 2e69 736e 6128 292e 746f 5f6e 756d 7079  .isna().to_numpy
-0001a3f0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0001a400: 2020 2020 2020 2023 2054 4f44 4f20 2e2e         # TODO ..
-0001a410: 2e20 616e 6f74 6865 7220 636c 7565 2069  . another clue i
-0001a420: 7320 726f 7720 6973 2069 6465 6e74 6963  s row is identic
-0001a430: 616c 2074 6f20 7072 6576 696f 7573 2074  al to previous t
-0001a440: 7261 6469 6e67 2064 6179 0a20 2020 2020  rading day.     
-0001a450: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a460: 6620 665f 6e61 2e61 6e79 2829 3a0a 2020  f f_na.any():.  
-0001a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a480: 2020 2020 2020 665f 6472 6f70 203d 206e        f_drop = n
-0001a490: 702e 6172 7261 7928 5b46 616c 7365 5d2a  p.array([False]*
-0001a4a0: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-0001a4b0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-0001a4c0: 2069 6e20 6e70 2e77 6865 7265 2866 5f6e   in np.where(f_n
-0001a4d0: 6129 5b30 5d3a 0a20 2020 2020 2020 2020  a)[0]:.         
+00019fd0: 6466 2e6c 6f63 5b64 745f 6265 666f 7265  df.loc[dt_before
+00019fe0: 2c20 2243 6c6f 7365 225d 203d 2064 665f  , "Close"] = df_
+00019ff0: 726f 7773 5b22 436c 6f73 6522 5d2e 6472  rows["Close"].dr
+0001a000: 6f70 6e61 2829 5b2d 315d 0a20 2020 2020  opna()[-1].     
+0001a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a020: 2020 2020 2020 2020 2020 2064 662e 6c6f             df.lo
+0001a030: 635b 6474 5f62 6566 6f72 652c 2022 4164  c[dt_before, "Ad
+0001a040: 6a20 436c 6f73 6522 5d20 3d20 6466 5f72  j Close"] = df_r
+0001a050: 6f77 735b 2241 646a 2043 6c6f 7365 225d  ows["Adj Close"]
+0001a060: 2e64 726f 706e 6128 295b 2d31 5d0a 2020  .dropna()[-1].  
+0001a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a080: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001a090: 2e6c 6f63 5b64 745f 6265 666f 7265 2c20  .loc[dt_before, 
+0001a0a0: 2256 6f6c 756d 6522 5d20 3d20 6466 5f72  "Volume"] = df_r
+0001a0b0: 6f77 735b 2256 6f6c 756d 6522 5d2e 6472  ows["Volume"].dr
+0001a0c0: 6f70 6e61 2829 2e73 756d 2829 0a0a 2020  opna().sum()..  
+0001a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a0e0: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+0001a0f0: 496e 7465 7276 616c 5374 6172 7473 203d  IntervalStarts =
+0001a100: 206e 702e 6465 6c65 7465 2879 6649 6e74   np.delete(yfInt
+0001a110: 6572 7661 6c53 7461 7274 732c 2069 290a  ervalStarts, i).
+0001a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a140: 696e 7465 7276 616c 7320 3d20 696e 7465  intervals = inte
+0001a150: 7276 616c 732e 6472 6f70 2864 7429 0a20  rvals.drop(dt). 
+0001a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a170: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001a180: 6620 3d20 6466 2e64 726f 7028 6474 290a  f = df.drop(dt).
+0001a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1b0: 6e20 3d20 6466 2e73 6861 7065 5b30 5d0a  n = df.shape[0].
+0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1e0: 665f 6e61 203d 2069 6e74 6572 7661 6c73  f_na = intervals
+0001a1f0: 5b22 696e 7465 7276 616c 5f6f 7065 6e22  ["interval_open"
+0001a200: 5d2e 6973 6e61 2829 2e74 6f5f 6e75 6d70  ].isna().to_nump
+0001a210: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0001a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a230: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a250: 2020 2020 2020 2320 5072 6576 696f 7573        # Previous
+0001a260: 2069 6e74 6572 7661 6c20 746f 6f20 6661   interval too fa
+0001a270: 722c 206d 7573 7420 696e 7365 7274 2061  r, must insert a
+0001a280: 206e 6577 2069 6e74 6572 7661 6c0a 2020   new interval.  
+0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a2a0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0001a2b0: 6973 6520 4578 6365 7074 696f 6e28 2274  ise Exception("t
+0001a2c0: 6869 7320 636f 6465 2070 6174 6820 6e6f  his code path no
+0001a2d0: 7420 7465 7374 6564 2c20 7265 7669 6577  t tested, review
+0001a2e0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0001a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a300: 2020 2064 745f 636f 7272 6563 7420 3d20     dt_correct = 
+0001a310: 6474 5f62 6566 6f72 6520 2b20 7365 6c66  dt_before + self
+0001a320: 2e69 7464 0a20 2020 2020 2020 2020 2020  .itd.           
+0001a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a340: 2020 2020 2069 6620 6474 5f63 6f72 7265       if dt_corre
+0001a350: 6374 203e 3d20 6474 3a0a 2020 2020 2020  ct >= dt:.      
+0001a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a370: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0001a380: 6973 6520 4578 6365 7074 696f 6e28 6622  ise Exception(f"
+0001a390: 6474 5f63 6f72 7265 6374 3d7b 6474 5f63  dt_correct={dt_c
+0001a3a0: 6f72 7265 6374 7d20 3e3d 2064 743d 7b64  orrect} >= dt={d
+0001a3b0: 747d 202c 2065 7870 6563 7465 6420 3c22  t} , expected <"
+0001a3c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3e0: 2020 6966 2064 745f 636f 7272 6563 742e    if dt_correct.
+0001a3f0: 6461 7465 2829 2021 3d20 6474 2e64 6174  date() != dt.dat
+0001a400: 6528 293a 0a20 2020 2020 2020 2020 2020  e():.           
+0001a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a420: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+0001a430: 7863 6570 7469 6f6e 2866 2264 745f 636f  xception(f"dt_co
+0001a440: 7272 6563 743d 7b64 745f 636f 7272 6563  rrect={dt_correc
+0001a450: 747d 2026 2064 743d 7b64 747d 202c 2065  t} & dt={dt} , e
+0001a460: 7870 6563 7465 6420 7361 6d65 2064 6179  xpected same day
+0001a470: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0001a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a490: 2020 2064 662e 6c6f 635b 6474 5f63 6f72     df.loc[dt_cor
+0001a4a0: 7265 6374 5d20 3d20 6466 2e6c 6f63 5b64  rect] = df.loc[d
+0001a4b0: 745d 203b 2064 6620 3d20 6466 2e64 726f  t] ; df = df.dro
+0001a4c0: 7028 6474 292e 736f 7274 5f69 6e64 6578  p(dt).sort_index
+0001a4d0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
 0001a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4f0: 2020 2069 6620 6920 3e20 303a 0a20 2020     if i > 0:.   
-0001a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a510: 2020 2020 2020 2020 2020 2020 2064 7420               dt 
-0001a520: 3d20 6466 2e69 6e64 6578 5b69 5d0a 2020  = df.index[i].  
-0001a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a540: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0001a550: 7374 5f64 7420 3d20 6466 2e69 6e64 6578  st_dt = df.index
-0001a560: 5b69 2d31 5d0a 2020 2020 2020 2020 2020  [i-1].          
-0001a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a580: 2020 2020 2020 6966 2028 6466 2e6c 6f63        if (df.loc
-0001a590: 5b64 742c 2079 6663 642e 7966 5f64 6174  [dt, yfcd.yf_dat
-0001a5a0: 615f 636f 6c73 5d20 3d3d 2064 662e 6c6f  a_cols] == df.lo
-0001a5b0: 635b 6c61 7374 5f64 742c 2079 6663 642e  c[last_dt, yfcd.
-0001a5c0: 7966 5f64 6174 615f 636f 6c73 5d29 2e61  yf_data_cols]).a
-0001a5d0: 6c6c 2829 3a0a 2020 2020 2020 2020 2020  ll():.          
+0001a4f0: 2020 2079 6649 6e74 6572 7661 6c53 7461     yfIntervalSta
+0001a500: 7274 735b 695d 203d 2064 745f 636f 7272  rts[i] = dt_corr
+0001a510: 6563 740a 2020 2020 2020 2020 2020 2020  ect.            
+0001a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a530: 2020 2020 696e 7465 7276 616c 7320 3d20      intervals = 
+0001a540: 696e 7465 7276 616c 732e 6472 6f70 2864  intervals.drop(d
+0001a550: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+0001a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a570: 2020 2069 6e74 6572 7661 6c73 2e6c 6f63     intervals.loc
+0001a580: 5b64 745f 636f 7272 6563 745d 203d 207b  [dt_correct] = {
+0001a590: 2269 6e74 6572 7661 6c5f 6f70 656e 223a  "interval_open":
+0001a5a0: 2064 745f 636f 7272 6563 742c 2022 696e   dt_correct, "in
+0001a5b0: 7465 7276 616c 5f63 6c6f 7365 223a 2064  terval_close": d
+0001a5c0: 6632 2e6c 6f63 5b64 742c 2022 6d61 726b  f2.loc[dt, "mark
+0001a5d0: 6574 5f63 6c6f 7365 225d 7d0a 2020 2020  et_close"]}.    
 0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5f0: 2020 2020 2020 2020 2020 665f 6472 6f70            f_drop
-0001a600: 5b69 5d20 3d20 5472 7565 0a20 2020 2020  [i] = True.     
-0001a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a620: 2020 2069 6620 665f 6472 6f70 2e61 6e79     if f_drop.any
-0001a630: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a650: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-0001a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a670: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-0001a680: 6720 3d20 222d 2064 726f 7070 696e 6720  g = "- dropping 
-0001a690: 726f 7773 2077 6974 6820 6e6f 2069 6e74  rows with no int
-0001a6a0: 6572 7661 6c20 7468 6174 2061 7265 2069  erval that are i
-0001a6b0: 6465 6e74 6963 616c 2074 6f20 7072 6576  dentical to prev
-0001a6c0: 696f 7573 2072 6f77 220a 2020 2020 2020  ious row".      
-0001a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6e0: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-0001a6f0: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
-0001a700: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-0001a710: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
-0001a720: 7269 6e74 286d 7367 290a 2020 2020 2020  rint(msg).      
+0001a5f0: 2020 2020 2020 2020 2020 2020 665f 6e61              f_na
+0001a600: 203d 2069 6e74 6572 7661 6c73 5b22 696e   = intervals["in
+0001a610: 7465 7276 616c 5f6f 7065 6e22 5d2e 6973  terval_open"].is
+0001a620: 6e61 2829 2e74 6f5f 6e75 6d70 7928 290a  na().to_numpy().
+0001a630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a640: 2069 6620 665f 6e61 2e61 6e79 2829 3a0a   if f_na.any():.
+0001a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a660: 2020 2020 2320 466f 7220 736f 6d65 206e      # For some n
+0001a670: 6174 696f 6e61 6c20 686f 6c69 6461 7973  ational holidays
+0001a680: 2077 6865 6e20 6578 6368 616e 6765 2063   when exchange c
+0001a690: 6c6f 7365 642c 2059 6168 6f6f 2066 696c  losed, Yahoo fil
+0001a6a0: 6c73 2069 6e20 726f 772e 2043 6c75 6520  ls in row. Clue 
+0001a6b0: 6973 2030 2076 6f6c 756d 652e 0a20 2020  is 0 volume..   
+0001a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6d0: 2023 2053 6f6c 7574 696f 6e20 3d20 6472   # Solution = dr
+0001a6e0: 6f70 3a0a 2020 2020 2020 2020 2020 2020  op:.            
+0001a6f0: 2020 2020 2020 2020 665f 6e61 5f7a 6572          f_na_zer
+0001a700: 6f56 6f6c 203d 2066 5f6e 6120 2620 2864  oVol = f_na & (d
+0001a710: 665b 2256 6f6c 756d 6522 5d20 3d3d 2030  f["Volume"] == 0
+0001a720: 292e 746f 5f6e 756d 7079 2829 0a20 2020  ).to_numpy().   
 0001a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a740: 2020 2020 2020 7966 496e 7465 7276 616c        yfInterval
-0001a750: 5374 6172 7473 203d 2079 6649 6e74 6572  Starts = yfInter
-0001a760: 7661 6c53 7461 7274 735b 7e66 5f64 726f  valStarts[~f_dro
-0001a770: 705d 0a20 2020 2020 2020 2020 2020 2020  p].             
-0001a780: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001a790: 6e74 6572 7661 6c73 203d 2069 6e74 6572  ntervals = inter
-0001a7a0: 7661 6c73 5b7e 665f 6472 6f70 5d0a 2020  vals[~f_drop].  
-0001a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7c0: 2020 2020 2020 2020 2020 6466 203d 2064            df = d
-0001a7d0: 665b 7e66 5f64 726f 705d 0a20 2020 2020  f[~f_drop].     
-0001a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a7f0: 2020 2020 2020 206e 203d 2064 662e 7368         n = df.sh
-0001a800: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
-0001a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a820: 2020 2066 5f6e 6120 3d20 696e 7465 7276     f_na = interv
-0001a830: 616c 735b 2269 6e74 6572 7661 6c5f 6f70  als["interval_op
-0001a840: 656e 225d 2e69 736e 6128 292e 746f 5f6e  en"].isna().to_n
-0001a850: 756d 7079 2829 0a0a 2020 2020 2020 2020  umpy()..        
-0001a860: 2020 2020 2020 2020 6966 2066 5f6e 612e          if f_na.
-0001a870: 616e 7928 2920 616e 6420 7365 6c66 2e69  any() and self.i
-0001a880: 6e74 6572 7661 6c20 3d3d 2079 6663 642e  nterval == yfcd.
-0001a890: 496e 7465 7276 616c 2e4d 696e 7331 3a0a  Interval.Mins1:.
-0001a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a8b0: 2020 2020 2320 4966 2031 2d6d 696e 7574      # If 1-minut
-0001a8c0: 6520 696e 7465 7276 616c 2061 7420 6d61  e interval at ma
-0001a8d0: 726b 6574 2063 6c6f 7365 2c20 7468 656e  rket close, then
-0001a8e0: 206d 6572 6765 2077 6974 6820 7072 6576   merge with prev
-0001a8f0: 696f 7573 206d 696e 7574 650a 2020 2020  ious minute.    
+0001a740: 2069 6620 665f 6e61 5f7a 6572 6f56 6f6c   if f_na_zeroVol
+0001a750: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+0001a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a770: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
+0001a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a790: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
+0001a7a0: 222d 2064 726f 7070 696e 6720 7b7d 2030  "- dropping {} 0
+0001a7b0: 2d76 6f6c 756d 6520 726f 7773 2077 6974  -volume rows wit
+0001a7c0: 6820 6e6f 206d 6174 6368 696e 6720 696e  h no matching in
+0001a7d0: 7465 7276 616c 222e 666f 726d 6174 2873  terval".format(s
+0001a7e0: 756d 2866 5f6e 615f 7a65 726f 566f 6c29  um(f_na_zeroVol)
+0001a7f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a800: 2020 2020 2020 2020 2020 2020 2020 7966                yf
+0001a810: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
+0001a820: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
+0001a830: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
+0001a840: 7365 2070 7269 6e74 286d 7367 290a 2020  se print(msg).  
+0001a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a860: 2020 2020 2020 665f 6472 6f70 203d 2066        f_drop = f
+0001a870: 5f6e 615f 7a65 726f 566f 6c0a 2020 2020  _na_zeroVol.    
+0001a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a890: 2020 2020 7966 496e 7465 7276 616c 5374      yfIntervalSt
+0001a8a0: 6172 7473 203d 2079 6649 6e74 6572 7661  arts = yfInterva
+0001a8b0: 6c53 7461 7274 735b 7e66 5f64 726f 705d  lStarts[~f_drop]
+0001a8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a8d0: 2020 2020 2020 2020 2069 6e74 6572 7661           interva
+0001a8e0: 6c73 203d 2069 6e74 6572 7661 6c73 5b7e  ls = intervals[~
+0001a8f0: 665f 6472 6f70 5d0a 2020 2020 2020 2020  f_drop].        
 0001a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a910: 696e 6469 6365 7320 3d20 736f 7274 6564  indices = sorted
-0001a920: 286e 702e 7768 6572 6528 665f 6e61 295b  (np.where(f_na)[
-0001a930: 305d 2c20 7265 7665 7273 653d 5472 7565  0], reverse=True
-0001a940: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001a950: 2020 2020 2020 666f 7220 6964 7820 696e        for idx in
-0001a960: 2069 6e64 6963 6573 3a0a 2020 2020 2020   indices:.      
-0001a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a980: 2020 6474 203d 2064 662e 696e 6465 785b    dt = df.index[
-0001a990: 6964 785d 0a20 2020 2020 2020 2020 2020  idx].           
-0001a9a0: 2020 2020 2020 2020 2020 2020 2073 6368               sch
-0001a9b0: 6564 203d 2079 6663 742e 4765 7445 7863  ed = yfct.GetExc
-0001a9c0: 6861 6e67 6553 6368 6564 756c 6528 7365  hangeSchedule(se
-0001a9d0: 6c66 2e65 7863 6861 6e67 652c 2064 742e  lf.exchange, dt.
-0001a9e0: 6461 7465 2829 2c20 6474 2e64 6174 6528  date(), dt.date(
-0001a9f0: 292b 7464 5f31 6429 0a20 2020 2020 2020  )+td_1d).       
-0001aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa10: 2069 6620 6474 2e74 696d 6528 2920 3d3d   if dt.time() ==
-0001aa20: 2073 6368 6564 5b22 636c 6f73 6522 5d2e   sched["close"].
-0001aa30: 696c 6f63 5b30 5d2e 7469 6d65 2829 3a0a  iloc[0].time():.
-0001aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa50: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0001aa60: 6478 203d 3d20 303a 0a20 2020 2020 2020  dx == 0:.       
-0001aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa80: 2020 2020 2020 2020 2023 2044 6973 6361           # Disca
-0001aa90: 7264 0a20 2020 2020 2020 2020 2020 2020  rd.             
+0001a910: 6466 203d 2064 665b 7e66 5f64 726f 705d  df = df[~f_drop]
+0001a920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a930: 2020 2020 2020 2020 206e 203d 2064 662e           n = df.
+0001a940: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
+0001a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a960: 2066 5f6e 6120 3d20 696e 7465 7276 616c   f_na = interval
+0001a970: 735b 2269 6e74 6572 7661 6c5f 6f70 656e  s["interval_open
+0001a980: 225d 2e69 736e 6128 292e 746f 5f6e 756d  "].isna().to_num
+0001a990: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+0001a9a0: 2020 2020 2020 2020 2023 2054 4f44 4f20           # TODO 
+0001a9b0: 2e2e 2e20 616e 6f74 6865 7220 636c 7565  ... another clue
+0001a9c0: 2069 7320 726f 7720 6973 2069 6465 6e74   is row is ident
+0001a9d0: 6963 616c 2074 6f20 7072 6576 696f 7573  ical to previous
+0001a9e0: 2074 7261 6469 6e67 2064 6179 0a20 2020   trading day.   
+0001a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa00: 2069 6620 665f 6e61 2e61 6e79 2829 3a0a   if f_na.any():.
+0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa20: 2020 2020 2020 2020 665f 6472 6f70 203d          f_drop =
+0001aa30: 206e 702e 6172 7261 7928 5b46 616c 7365   np.array([False
+0001aa40: 5d2a 6e29 0a20 2020 2020 2020 2020 2020  ]*n).           
+0001aa50: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001aa60: 2069 2069 6e20 6e70 2e77 6865 7265 2866   i in np.where(f
+0001aa70: 5f6e 6129 5b30 5d3a 0a20 2020 2020 2020  _na)[0]:.       
+0001aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa90: 2020 2020 2069 6620 6920 3e20 303a 0a20       if i > 0:. 
 0001aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aab0: 2020 2070 7269 6e74 2822 6469 7363 6172     print("discar
-0001aac0: 6469 6e67 2229 0a20 2020 2020 2020 2020  ding").         
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001aac0: 7420 3d20 6466 2e69 6e64 6578 5b69 5d0a  t = df.index[i].
 0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aae0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0001aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aaf0: 6c61 7374 5f64 7420 3d20 6466 2e69 6e64  last_dt = df.ind
+0001ab00: 6578 5b69 2d31 5d0a 2020 2020 2020 2020  ex[i-1].        
 0001ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab20: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001ab30: 696e 7428 226d 6572 6769 6e67 2229 0a20  int("merging"). 
-0001ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001ab60: 204d 6572 6765 2077 6974 6820 7072 6576   Merge with prev
-0001ab70: 696f 7573 0a20 2020 2020 2020 2020 2020  ious.           
+0001ab20: 2020 2020 2020 2020 6966 2028 6466 2e6c          if (df.l
+0001ab30: 6f63 5b64 742c 2079 6663 642e 7966 5f64  oc[dt, yfcd.yf_d
+0001ab40: 6174 615f 636f 6c73 5d20 3d3d 2064 662e  ata_cols] == df.
+0001ab50: 6c6f 635b 6c61 7374 5f64 742c 2079 6663  loc[last_dt, yfc
+0001ab60: 642e 7966 5f64 6174 615f 636f 6c73 5d29  d.yf_data_cols])
+0001ab70: 2e61 6c6c 2829 3a0a 2020 2020 2020 2020  .all():.        
 0001ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab90: 2020 2020 2064 7431 203d 2064 662e 696e       dt1 = df.in
-0001aba0: 6465 785b 6964 782d 315d 0a20 2020 2020  dex[idx-1].     
+0001ab90: 2020 2020 2020 2020 2020 2020 665f 6472              f_dr
+0001aba0: 6f70 5b69 5d20 3d20 5472 7565 0a20 2020  op[i] = True.   
 0001abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abc0: 2020 2020 2020 2020 2020 2064 662e 6c6f             df.lo
-0001abd0: 635b 6474 312c 2022 436c 6f73 6522 5d20  c[dt1, "Close"] 
-0001abe0: 3d20 6466 5b22 436c 6f73 6522 5d2e 696c  = df["Close"].il
-0001abf0: 6f63 5b69 6478 5d0a 2020 2020 2020 2020  oc[idx].        
+0001abc0: 2020 2020 2069 6620 665f 6472 6f70 2e61       if f_drop.a
+0001abd0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abf0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
 0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac10: 2020 2020 2020 2020 6466 2e6c 6f63 5b64          df.loc[d
-0001ac20: 7431 2c20 2248 6967 6822 5d20 3d20 6466  t1, "High"] = df
-0001ac30: 5b22 4869 6768 225d 2e69 6c6f 635b 6964  ["High"].iloc[id
-0001ac40: 782d 313a 6964 782b 315d 2e6d 6178 2829  x-1:idx+1].max()
-0001ac50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac70: 2064 662e 6c6f 635b 6474 312c 2022 4c6f   df.loc[dt1, "Lo
-0001ac80: 7722 5d20 3d20 6466 5b22 4c6f 7722 5d2e  w"] = df["Low"].
-0001ac90: 696c 6f63 5b69 6478 2d31 3a69 6478 2b31  iloc[idx-1:idx+1
-0001aca0: 5d2e 6d69 6e28 290a 2020 2020 2020 2020  ].min().        
-0001acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acc0: 2020 2020 2020 2020 6466 2e6c 6f63 5b64          df.loc[d
-0001acd0: 7431 2c20 2256 6f6c 756d 6522 5d20 3d20  t1, "Volume"] = 
-0001ace0: 6466 5b22 566f 6c75 6d65 225d 2e69 6c6f  df["Volume"].ilo
-0001acf0: 635b 6964 782d 313a 6964 782b 315d 2e73  c[idx-1:idx+1].s
-0001ad00: 756d 2829 0a20 2020 2020 2020 2020 2020  um().           
-0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad20: 2064 6620 3d20 6466 2e64 726f 7028 6474   df = df.drop(dt
-0001ad30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001ad40: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0001ad50: 7465 7276 616c 7320 3d20 696e 7465 7276  tervals = interv
-0001ad60: 616c 732e 6472 6f70 2864 7429 0a20 2020  als.drop(dt).   
-0001ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad80: 2020 2020 2020 2020 2079 6649 6e74 6572           yfInter
-0001ad90: 7661 6c53 7461 7274 7320 3d20 6e70 2e64  valStarts = np.d
-0001ada0: 656c 6574 6528 7966 496e 7465 7276 616c  elete(yfInterval
-0001adb0: 5374 6172 7473 2c20 6964 7829 0a20 2020  Starts, idx).   
-0001adc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001add0: 2066 5f6e 6120 3d20 696e 7465 7276 616c   f_na = interval
-0001ade0: 735b 2269 6e74 6572 7661 6c5f 6f70 656e  s["interval_open
-0001adf0: 225d 2e69 736e 6128 292e 746f 5f6e 756d  "].isna().to_num
-0001ae00: 7079 2829 0a0a 2020 2020 2020 2020 2020  py()..          
-0001ae10: 2020 2020 2020 6966 2066 5f6e 612e 616e        if f_na.an
-0001ae20: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-0001ae30: 2020 2020 2020 2020 2023 2063 7472 203d           # ctr =
-0001ae40: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-0001ae50: 2020 2020 2020 2023 2066 6f72 2069 6478         # for idx
-0001ae60: 2069 6e20 6e70 2e77 6865 7265 2866 5f6e   in np.where(f_n
-0001ae70: 6129 5b30 5d3a 0a20 2020 2020 2020 2020  a)[0]:.         
-0001ae80: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0001ae90: 2064 7420 3d20 6466 2e69 6e64 6578 5b69   dt = df.index[i
-0001aea0: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
-0001aeb0: 2020 2020 2020 2020 2320 2020 2020 6374          #     ct
-0001aec0: 7220 2b3d 2031 0a20 2020 2020 2020 2020  r += 1.         
-0001aed0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0001aee0: 2069 6620 6374 7220 3c20 3130 3a0a 2020   if ctr < 10:.  
-0001aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af00: 2020 2320 2020 2020 2020 2020 7072 696e    #         prin
-0001af10: 7428 2246 6169 6c65 6420 746f 206d 6170  t("Failed to map
-0001af20: 3a20 7b7d 2028 6578 6368 616e 6765 3d7b  : {} (exchange={
-0001af30: 7d2c 2078 6361 6c3d 7b7d 2922 2e66 6f72  }, xcal={})".for
-0001af40: 6d61 7428 6474 2c20 7365 6c66 2e65 7863  mat(dt, self.exc
-0001af50: 6861 6e67 652c 2079 6663 642e 6578 6368  hange, yfcd.exch
-0001af60: 616e 6765 546f 5863 616c 4578 6368 616e  angeToXcalExchan
-0001af70: 6765 5b73 656c 662e 6578 6368 616e 6765  ge[self.exchange
-0001af80: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-0001af90: 2020 2020 2020 2020 2320 2020 2020 2020          #       
-0001afa0: 2020 7072 696e 7428 6466 2e6c 6f63 5b64    print(df.loc[d
-0001afb0: 745d 290a 2020 2020 2020 2020 2020 2020  t]).            
-0001afc0: 2020 2020 2020 2020 2320 2020 2020 656c          #     el
-0001afd0: 6966 2063 7472 203d 3d20 3130 3a0a 2020  if ctr == 10:.  
-0001afe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aff0: 2020 2320 2020 2020 2020 2020 7072 696e    #         prin
-0001b000: 7428 222d 2073 746f 7070 6564 2070 7269  t("- stopped pri
-0001b010: 6e74 696e 6720 6174 2031 3020 6661 696c  nting at 10 fail
-0001b020: 7572 6573 2229 0a20 2020 2020 2020 2020  ures").         
-0001b030: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+0001ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac20: 6d73 6720 3d20 222d 2064 726f 7070 696e  msg = "- droppin
+0001ac30: 6720 726f 7773 2077 6974 6820 6e6f 2069  g rows with no i
+0001ac40: 6e74 6572 7661 6c20 7468 6174 2061 7265  nterval that are
+0001ac50: 2069 6465 6e74 6963 616c 2074 6f20 7072   identical to pr
+0001ac60: 6576 696f 7573 2072 6f77 220a 2020 2020  evious row".    
+0001ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac80: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+0001ac90: 2e54 7261 6365 5072 696e 7428 6d73 6729  .TracePrint(msg)
+0001aca0: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
+0001acb0: 6e67 456e 6162 6c65 6428 2920 656c 7365  ngEnabled() else
+0001acc0: 2070 7269 6e74 286d 7367 290a 2020 2020   print(msg).    
+0001acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ace0: 2020 2020 2020 2020 7966 496e 7465 7276          yfInterv
+0001acf0: 616c 5374 6172 7473 203d 2079 6649 6e74  alStarts = yfInt
+0001ad00: 6572 7661 6c53 7461 7274 735b 7e66 5f64  ervalStarts[~f_d
+0001ad10: 726f 705d 0a20 2020 2020 2020 2020 2020  rop].           
+0001ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad30: 2069 6e74 6572 7661 6c73 203d 2069 6e74   intervals = int
+0001ad40: 6572 7661 6c73 5b7e 665f 6472 6f70 5d0a  ervals[~f_drop].
+0001ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad60: 2020 2020 2020 2020 2020 2020 6466 203d              df =
+0001ad70: 2064 665b 7e66 5f64 726f 705d 0a20 2020   df[~f_drop].   
+0001ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad90: 2020 2020 2020 2020 206e 203d 2064 662e           n = df.
+0001ada0: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
+0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adc0: 2020 2020 2066 5f6e 6120 3d20 696e 7465       f_na = inte
+0001add0: 7276 616c 735b 2269 6e74 6572 7661 6c5f  rvals["interval_
+0001ade0: 6f70 656e 225d 2e69 736e 6128 292e 746f  open"].isna().to
+0001adf0: 5f6e 756d 7079 2829 0a0a 2020 2020 2020  _numpy()..      
+0001ae00: 2020 2020 2020 2020 2020 6966 2066 5f6e            if f_n
+0001ae10: 612e 616e 7928 2920 616e 6420 7365 6c66  a.any() and self
+0001ae20: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+0001ae30: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
+0001ae40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ae50: 2020 2020 2020 2320 4966 2031 2d6d 696e        # If 1-min
+0001ae60: 7574 6520 696e 7465 7276 616c 2061 7420  ute interval at 
+0001ae70: 6d61 726b 6574 2063 6c6f 7365 2c20 7468  market close, th
+0001ae80: 656e 206d 6572 6765 2077 6974 6820 7072  en merge with pr
+0001ae90: 6576 696f 7573 206d 696e 7574 650a 2020  evious minute.  
+0001aea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aeb0: 2020 696e 6469 6365 7320 3d20 736f 7274    indices = sort
+0001aec0: 6564 286e 702e 7768 6572 6528 665f 6e61  ed(np.where(f_na
+0001aed0: 295b 305d 2c20 7265 7665 7273 653d 5472  )[0], reverse=Tr
+0001aee0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0001aef0: 2020 2020 2020 2020 666f 7220 6964 7820          for idx 
+0001af00: 696e 2069 6e64 6963 6573 3a0a 2020 2020  in indices:.    
+0001af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001af20: 2020 2020 6474 203d 2064 662e 696e 6465      dt = df.inde
+0001af30: 785b 6964 785d 0a20 2020 2020 2020 2020  x[idx].         
+0001af40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001af50: 6368 6564 203d 2079 6663 742e 4765 7445  ched = yfct.GetE
+0001af60: 7863 6861 6e67 6553 6368 6564 756c 6528  xchangeSchedule(
+0001af70: 7365 6c66 2e65 7863 6861 6e67 652c 2064  self.exchange, d
+0001af80: 742e 6461 7465 2829 2c20 6474 2e64 6174  t.date(), dt.dat
+0001af90: 6528 292b 7464 5f31 6429 0a20 2020 2020  e()+td_1d).     
+0001afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001afb0: 2020 2069 6620 6474 2e74 696d 6528 2920     if dt.time() 
+0001afc0: 3d3d 2073 6368 6564 5b22 636c 6f73 6522  == sched["close"
+0001afd0: 5d2e 696c 6f63 5b30 5d2e 7469 6d65 2829  ].iloc[0].time()
+0001afe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001aff0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001b000: 2069 6478 203d 3d20 303a 0a20 2020 2020   idx == 0:.     
+0001b010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b020: 2020 2020 2020 2020 2020 2023 2044 6973             # Dis
+0001b030: 6361 7264 0a20 2020 2020 2020 2020 2020  card.           
 0001b040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b050: 2064 665f 6e61 203d 2064 665b 665f 6e61   df_na = df[f_na
-0001b060: 5d5b 5b22 436c 6f73 6522 2c20 2256 6f6c  ][["Close", "Vol
-0001b070: 756d 6522 2c20 2244 6976 6964 656e 6473  ume", "Dividends
-0001b080: 222c 2022 5374 6f63 6b20 5370 6c69 7473  ", "Stock Splits
-0001b090: 225d 5d0a 2020 2020 2020 2020 2020 2020  "]].            
-0001b0a0: 2020 2020 2020 2020 6e20 3d20 6466 5f6e          n = df_n
-0001b0b0: 612e 7368 6170 655b 305d 0a20 2020 2020  a.shape[0].     
-0001b0c0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001b0d0: 6172 6e69 6e67 5f6d 7367 203d 2066 2246  arning_msg = f"F
-0001b0e0: 6169 6c65 6420 746f 206d 6170 2074 6865  ailed to map the
-0001b0f0: 7365 2059 6168 6f6f 2069 6e74 6572 7661  se Yahoo interva
-0001b100: 6c73 2074 6f20 7863 616c 3a20 2865 7863  ls to xcal: (exc
-0001b110: 6861 6e67 653d 7b73 656c 662e 6578 6368  hange={self.exch
-0001b120: 616e 6765 7d2c 2078 6361 6c3d 7b79 6663  ange}, xcal={yfc
-0001b130: 642e 6578 6368 616e 6765 546f 5863 616c  d.exchangeToXcal
-0001b140: 4578 6368 616e 6765 5b73 656c 662e 6578  Exchange[self.ex
-0001b150: 6368 616e 6765 5d7d 292e 220a 2020 2020  change]}).".    
-0001b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b170: 7761 726e 696e 675f 6d73 6720 2b3d 2022  warning_msg += "
-0001b180: 204e 6f72 6d61 6c6c 7920 6861 7070 656e   Normally happen
-0001b190: 7320 7768 656e 2027 6578 6368 616e 6765  s when 'exchange
-0001b1a0: 5f63 616c 656e 6461 7273 2720 6973 2077  _calendars' is w
-0001b1b0: 726f 6e67 2073 6f20 696e 666f 726d 2064  rong so inform d
-0001b1c0: 6576 656c 6f70 6572 732e 220a 2020 2020  evelopers.".    
-0001b1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1e0: 7072 696e 7428 2222 290a 2020 2020 2020  print("").      
-0001b1f0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001b200: 696e 7428 7761 726e 696e 675f 6d73 6729  int(warning_msg)
-0001b210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b220: 2020 2020 2070 7269 6e74 2864 665f 6e61       print(df_na
-0001b230: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001b240: 2020 2020 2020 6d73 6720 3d20 2241 6363        msg = "Acc
-0001b250: 6570 7420 696e 746f 2063 6163 6865 2061  ept into cache a
-0001b260: 6e79 7761 793f 220a 2020 2020 2020 2020  nyway?".        
-0001b270: 2020 2020 2020 2020 2020 2020 6966 2046              if F
-0001b280: 616c 7365 3a0a 2020 2020 2020 2020 2020  alse:.          
-0001b290: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-0001b2a0: 6365 7074 203d 2054 7275 650a 2020 2020  cept = True.    
+0001b050: 2020 2020 2070 7269 6e74 2822 6469 7363       print("disc
+0001b060: 6172 6469 6e67 2229 0a20 2020 2020 2020  arding").       
+0001b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b080: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+0001b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0d0: 7072 696e 7428 226d 6572 6769 6e67 2229  print("merging")
+0001b0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b100: 2023 204d 6572 6765 2077 6974 6820 7072   # Merge with pr
+0001b110: 6576 696f 7573 0a20 2020 2020 2020 2020  evious.         
+0001b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b130: 2020 2020 2020 2064 7431 203d 2064 662e         dt1 = df.
+0001b140: 696e 6465 785b 6964 782d 315d 0a20 2020  index[idx-1].   
+0001b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b160: 2020 2020 2020 2020 2020 2020 2064 662e               df.
+0001b170: 6c6f 635b 6474 312c 2022 436c 6f73 6522  loc[dt1, "Close"
+0001b180: 5d20 3d20 6466 5b22 436c 6f73 6522 5d2e  ] = df["Close"].
+0001b190: 696c 6f63 5b69 6478 5d0a 2020 2020 2020  iloc[idx].      
+0001b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1b0: 2020 2020 2020 2020 2020 6466 2e6c 6f63            df.loc
+0001b1c0: 5b64 7431 2c20 2248 6967 6822 5d20 3d20  [dt1, "High"] = 
+0001b1d0: 6466 5b22 4869 6768 225d 2e69 6c6f 635b  df["High"].iloc[
+0001b1e0: 6964 782d 313a 6964 782b 315d 2e6d 6178  idx-1:idx+1].max
+0001b1f0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b210: 2020 2064 662e 6c6f 635b 6474 312c 2022     df.loc[dt1, "
+0001b220: 4c6f 7722 5d20 3d20 6466 5b22 4c6f 7722  Low"] = df["Low"
+0001b230: 5d2e 696c 6f63 5b69 6478 2d31 3a69 6478  ].iloc[idx-1:idx
+0001b240: 2b31 5d2e 6d69 6e28 290a 2020 2020 2020  +1].min().      
+0001b250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b260: 2020 2020 2020 2020 2020 6466 2e6c 6f63            df.loc
+0001b270: 5b64 7431 2c20 2256 6f6c 756d 6522 5d20  [dt1, "Volume"] 
+0001b280: 3d20 6466 5b22 566f 6c75 6d65 225d 2e69  = df["Volume"].i
+0001b290: 6c6f 635b 6964 782d 313a 6964 782b 315d  loc[idx-1:idx+1]
+0001b2a0: 2e73 756d 2829 0a20 2020 2020 2020 2020  .sum().         
 0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001b2d0: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-0001b2e0: 6365 7074 203d 2063 6c69 636b 2e63 6f6e  cept = click.con
-0001b2f0: 6669 726d 286d 7367 2c20 6465 6661 756c  firm(msg, defaul
-0001b300: 743d 4661 6c73 6529 0a20 2020 2020 2020  t=False).       
-0001b310: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001b320: 6163 6365 7074 3a0a 2020 2020 2020 2020  accept:.        
-0001b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b340: 666f 7220 6964 7820 696e 206e 702e 7768  for idx in np.wh
-0001b350: 6572 6528 665f 6e61 295b 305d 3a0a 2020  ere(f_na)[0]:.  
+0001b2c0: 2020 2064 6620 3d20 6466 2e64 726f 7028     df = df.drop(
+0001b2d0: 6474 290a 2020 2020 2020 2020 2020 2020  dt).            
+0001b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2f0: 696e 7465 7276 616c 7320 3d20 696e 7465  intervals = inte
+0001b300: 7276 616c 732e 6472 6f70 2864 7429 0a20  rvals.drop(dt). 
+0001b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b320: 2020 2020 2020 2020 2020 2079 6649 6e74             yfInt
+0001b330: 6572 7661 6c53 7461 7274 7320 3d20 6e70  ervalStarts = np
+0001b340: 2e64 656c 6574 6528 7966 496e 7465 7276  .delete(yfInterv
+0001b350: 616c 5374 6172 7473 2c20 6964 7829 0a20  alStarts, idx). 
 0001b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b370: 2020 2020 2020 2020 2020 6474 203d 2069            dt = i
-0001b380: 6e74 6572 7661 6c73 2e69 6e64 6578 5b69  ntervals.index[i
-0001b390: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
-0001b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3b0: 696e 7465 7276 616c 732e 6c6f 635b 6474  intervals.loc[dt
-0001b3c0: 2c20 2269 6e74 6572 7661 6c5f 6f70 656e  , "interval_open
-0001b3d0: 225d 203d 2064 662e 696e 6465 785b 6964  "] = df.index[id
-0001b3e0: 785d 0a20 2020 2020 2020 2020 2020 2020  x].             
-0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001b400: 6e74 6572 7661 6c73 2e6c 6f63 5b64 742c  ntervals.loc[dt,
-0001b410: 2022 696e 7465 7276 616c 5f63 6c6f 7365   "interval_close
-0001b420: 225d 203d 2064 662e 696e 6465 785b 6964  "] = df.index[id
-0001b430: 785d 202b 2073 656c 662e 6974 640a 2020  x] + self.itd.  
-0001b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b450: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b470: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0001b480: 2250 726f 626c 656d 2077 6974 6820 6461  "Problem with da
-0001b490: 7465 7320 7265 7475 726e 6564 2062 7920  tes returned by 
-0001b4a0: 5961 686f 6f2c 2073 6565 2061 626f 7665  Yahoo, see above
-0001b4b0: 2229 0a0a 2020 2020 2020 2020 6466 203d  ")..        df =
-0001b4c0: 2064 662e 636f 7079 2829 0a0a 2020 2020   df.copy()..    
-0001b4d0: 2020 2020 6966 206e 6f74 2064 6973 6162      if not disab
-0001b4e0: 6c65 5f79 6663 5f6d 6574 6164 6174 613a  le_yfc_metadata:
-0001b4f0: 0a20 2020 2020 2020 2020 2020 206c 6173  .            las
-0001b500: 7444 6174 6144 7473 203d 2079 6663 742e  tDataDts = yfct.
-0001b510: 4361 6c63 496e 7465 7276 616c 4c61 7374  CalcIntervalLast
-0001b520: 4461 7461 4474 5f62 6174 6368 2873 656c  DataDt_batch(sel
-0001b530: 662e 6578 6368 616e 6765 2c20 696e 7465  f.exchange, inte
-0001b540: 7276 616c 735b 2269 6e74 6572 7661 6c5f  rvals["interval_
-0001b550: 6f70 656e 225d 2e74 6f5f 6e75 6d70 7928  open"].to_numpy(
-0001b560: 292c 2073 656c 662e 696e 7465 7276 616c  ), self.interval
-0001b570: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001b580: 2066 5f6e 612e 616e 7928 293a 0a20 2020   f_na.any():.   
-0001b590: 2020 2020 2020 2020 2020 2020 2023 2048               # H
-0001b5a0: 6163 6b79 2073 6f6c 7574 696f 6e20 746f  acky solution to
-0001b5b0: 2068 616e 646c 6520 7863 616c 2068 6176   handle xcal hav
-0001b5c0: 696e 6720 696e 636f 7272 6563 7420 7363  ing incorrect sc
-0001b5d0: 6865 6475 6c65 2c20 666f 7220 7661 6c69  hedule, for vali
-0001b5e0: 6420 5961 686f 6f20 6461 7461 0a20 2020  d Yahoo data.   
-0001b5f0: 2020 2020 2020 2020 2020 2020 206c 6173               las
-0001b600: 7444 6174 6144 7473 5b66 5f6e 615d 203d  tDataDts[f_na] =
-0001b610: 2069 6e74 6572 7661 6c73 2e69 6e64 6578   intervals.index
-0001b620: 5b66 5f6e 615d 202b 2073 656c 662e 6974  [f_na] + self.it
-0001b630: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0001b640: 2020 6966 2073 656c 662e 696e 7472 6164    if self.intrad
-0001b650: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
-0001b660: 2020 2020 2020 2020 6c61 7374 4461 7461          lastData
-0001b670: 4474 735b 665f 6e61 5d20 2b3d 2079 6663  Dts[f_na] += yfc
-0001b680: 742e 4765 7445 7863 6861 6e67 6544 6174  t.GetExchangeDat
-0001b690: 6144 656c 6179 2873 656c 662e 6578 6368  aDelay(self.exch
-0001b6a0: 616e 6765 290a 2020 2020 2020 2020 2020  ange).          
-0001b6b0: 2020 2020 2020 2020 2020 2320 466f 7220            # For 
-0001b6c0: 736f 6d65 2065 7863 6861 6e67 6573 2c20  some exchanges, 
-0001b6d0: 5961 686f 6f20 6861 7320 7472 6164 6573  Yahoo has trades
-0001b6e0: 2074 6861 7420 6f63 6375 7272 6564 2073   that occurred s
-0001b6f0: 6f6f 6e20 6166 6572 206f 6666 6963 6961  oon afer officia
-0001b700: 6c20 6d61 726b 6574 2063 6c6f 7365 2c20  l market close, 
-0001b710: 652e 672e 204a 6f68 616e 6e65 7362 7572  e.g. Johannesbur
-0001b720: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-0001b730: 2020 2020 2020 2069 6620 7365 6c66 2e65         if self.e
-0001b740: 7863 6861 6e67 6520 696e 205b 224a 4e42  xchange in ["JNB
-0001b750: 225d 3a0a 2020 2020 2020 2020 2020 2020  "]:.            
-0001b760: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-0001b770: 4461 7461 4474 735b 665f 6e61 5d20 2b3d  DataDts[f_na] +=
-0001b780: 2074 696d 6564 656c 7461 286d 696e 7574   timedelta(minut
-0001b790: 6573 3d31 3529 0a20 2020 2020 2020 2020  es=15).         
-0001b7a0: 2020 2064 6174 615f 6669 6e61 6c20 3d20     data_final = 
-0001b7b0: 6665 7463 685f 6474 203e 3d20 6c61 7374  fetch_dt >= last
-0001b7c0: 4461 7461 4474 730a 2020 2020 2020 2020  DataDts.        
-0001b7d0: 2020 2020 6466 5b22 4669 6e61 6c3f 225d      df["Final?"]
-0001b7e0: 203d 2064 6174 615f 6669 6e61 6c0a 0a20   = data_final.. 
-0001b7f0: 2020 2020 2020 2020 2020 2023 2064 665b             # df[
-0001b800: 2246 6574 6368 4461 7465 225d 203d 2070  "FetchDate"] = p
-0001b810: 642e 5469 6d65 7374 616d 7028 6665 7463  d.Timestamp(fetc
-0001b820: 685f 6474 5f75 7463 292e 747a 5f6c 6f63  h_dt_utc).tz_loc
-0001b830: 616c 697a 6528 2255 5443 2229 0a20 2020  alize("UTC").   
-0001b840: 2020 2020 2020 2020 2064 665b 2246 6574           df["Fet
-0001b850: 6368 4461 7465 225d 203d 2066 6574 6368  chDate"] = fetch
-0001b860: 5f64 745f 7574 630a 0a20 2020 2020 2020  _dt_utc..       
-0001b870: 2020 2020 2064 665b 2243 2d43 6865 636b       df["C-Check
-0001b880: 3f22 5d20 3d20 4661 6c73 650a 0a20 2020  ?"] = False..   
-0001b890: 2020 2020 206c 6f67 5f6d 7367 203d 2066       log_msg = f
-0001b8a0: 2250 4d3a 3a5f 6665 7463 6859 6648 6973  "PM::_fetchYfHis
-0001b8b0: 746f 7279 2829 2072 6574 7572 6e69 6e67  tory() returning
-0001b8c0: 2044 4620 7b64 662e 696e 6465 785b 305d   DF {df.index[0]
-0001b8d0: 7d20 2d3e 207b 6466 2e69 6e64 6578 5b2d  } -> {df.index[-
-0001b8e0: 315d 7d22 0a20 2020 2020 2020 2069 6620  1]}".        if 
-0001b8f0: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-0001b900: 6162 6c65 6428 293a 0a20 2020 2020 2020  abled():.       
-0001b910: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
-0001b920: 7869 7428 6c6f 675f 6d73 6729 0a20 2020  xit(log_msg).   
-0001b930: 2020 2020 2065 6c69 6620 6465 6275 675f       elif debug_
-0001b940: 7966 633a 0a20 2020 2020 2020 2020 2020  yfc:.           
-0001b950: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
-0001b960: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
-0001b970: 6e61 6765 722e 4c6f 6745 7665 6e74 2822  nager.LogEvent("
-0001b980: 696e 666f 222c 2022 5072 6963 654d 616e  info", "PriceMan
-0001b990: 6167 6572 222c 2066 2266 6574 6368 6564  ager", f"fetched
-0001b9a0: 2066 726f 6d20 5946 3a20 7b73 656c 662e   from YF: {self.
-0001b9b0: 6973 7472 7d20 7b64 662e 696e 6465 785b  istr} {df.index[
-0001b9c0: 305d 7d20 2d3e 207b 6466 2e69 6e64 6578  0]} -> {df.index
-0001b9d0: 5b2d 315d 7d22 290a 0a20 2020 2020 2020  [-1]}")..       
-0001b9e0: 2072 6574 7572 6e20 6466 0a0a 2020 2020   return df..    
-0001b9f0: 6465 6620 5f66 6574 6368 5966 4869 7374  def _fetchYfHist
-0001ba00: 6f72 795f 7065 7269 6f64 2873 656c 662c  ory_period(self,
-0001ba10: 2070 7374 722c 2070 7265 706f 7374 2c20   pstr, prepost, 
-0001ba20: 6465 6275 6729 3a0a 2020 2020 2020 2020  debug):.        
-0001ba30: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0001ba40: 2249 2061 6d20 7265 7469 7269 6e67 205f  "I am retiring _
-0001ba50: 6665 7463 6859 6648 6973 746f 7279 5f70  fetchYfHistory_p
-0001ba60: 6572 696f 6428 2922 290a 2020 2020 2020  eriod()").      
-0001ba70: 2020 7966 6375 2e54 7970 6543 6865 636b    yfcu.TypeCheck
-0001ba80: 5374 7228 7073 7472 2c20 2270 7374 7222  Str(pstr, "pstr"
-0001ba90: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
-0001baa0: 7970 6543 6865 636b 426f 6f6c 2870 7265  ypeCheckBool(pre
-0001bab0: 706f 7374 2c20 2270 7265 706f 7374 2229  post, "prepost")
-0001bac0: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
-0001bad0: 7065 4368 6563 6b42 6f6f 6c28 6465 6275  peCheckBool(debu
-0001bae0: 672c 2022 6465 6275 6722 290a 0a20 2020  g, "debug")..   
-0001baf0: 2020 2020 2064 6562 7567 5f79 6663 203d       debug_yfc =
-0001bb00: 2046 616c 7365 0a20 2020 2020 2020 2023   False.        #
-0001bb10: 2064 6562 7567 5f79 6663 203d 2054 7275   debug_yfc = Tru
-0001bb20: 650a 0a20 2020 2020 2020 206c 6f67 5f6d  e..        log_m
-0001bb30: 7367 203d 2066 2250 4d3a 3a5f 6665 7463  sg = f"PM::_fetc
-0001bb40: 6859 6648 6973 746f 7279 5f70 6572 696f  hYfHistory_perio
-0001bb50: 642d 7b73 656c 662e 6973 7472 7d28 7073  d-{self.istr}(ps
-0001bb60: 7472 3d7b 7073 7472 7d20 2c20 7072 6570  tr={pstr} , prep
-0001bb70: 6f73 743d 7b70 7265 706f 7374 7d29 220a  ost={prepost})".
-0001bb80: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
-0001bb90: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-0001bba0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001bbb0: 7966 636c 2e54 7261 6365 456e 7465 7228  yfcl.TraceEnter(
-0001bbc0: 6c6f 675f 6d73 6729 0a20 2020 2020 2020  log_msg).       
-0001bbd0: 2065 6c69 6620 6465 6275 675f 7966 633a   elif debug_yfc:
-0001bbe0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0001bbf0: 6e74 2822 2229 0a20 2020 2020 2020 2020  nt("").         
-0001bc00: 2020 2070 7269 6e74 286c 6f67 5f6d 7367     print(log_msg
-0001bc10: 290a 0a20 2020 2020 2020 2068 6973 746f  )..        histo
-0001bc20: 7279 5f61 7267 7320 3d20 7b22 7065 7269  ry_args = {"peri
-0001bc30: 6f64 223a 2070 7374 722c 0a20 2020 2020  od": pstr,.     
-0001bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc50: 2020 2022 696e 7465 7276 616c 223a 2073     "interval": s
-0001bc60: 656c 662e 6973 7472 2c0a 2020 2020 2020  elf.istr,.      
-0001bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc80: 2020 2270 7265 706f 7374 223a 2070 7265    "prepost": pre
-0001bc90: 706f 7374 2c0a 2020 2020 2020 2020 2020  post,.          
-0001bca0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
-0001bcb0: 6374 696f 6e73 223a 2054 7275 652c 2020  ctions": True,  
-0001bcc0: 2320 416c 7761 7973 2066 6574 6368 0a20  # Always fetch. 
-0001bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bce0: 2020 2020 2020 2022 6b65 6570 6e61 223a         "keepna":
-0001bcf0: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
-0001bd00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001bd10: 7265 7061 6972 223a 2022 7369 6c65 6e74  repair": "silent
-0001bd20: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0001bd30: 2020 2020 2020 2020 2020 2022 6175 746f             "auto
-0001bd40: 5f61 646a 7573 7422 3a20 4661 6c73 652c  _adjust": False,
-0001bd50: 2020 2320 7374 6f72 6520 7261 7720 6461    # store raw da
-0001bd60: 7461 2c20 6164 6a75 7374 206d 7973 656c  ta, adjust mysel
-0001bd70: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-0001bd80: 2020 2020 2020 2020 2020 2262 6163 6b5f            "back_
-0001bd90: 6164 6a75 7374 223a 2046 616c 7365 2c20  adjust": False, 
-0001bda0: 2023 2073 746f 7265 2072 6177 2064 6174   # store raw dat
-0001bdb0: 612c 2061 646a 7573 7420 6d79 7365 6c66  a, adjust myself
-0001bdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bdd0: 2020 2020 2020 2020 2022 7072 6f78 7922           "proxy"
-0001bde0: 3a20 7365 6c66 2e70 726f 7879 2c0a 2020  : self.proxy,.  
-0001bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be00: 2020 2020 2020 2272 6f75 6e64 696e 6722        "rounding"
-0001be10: 3a20 4661 6c73 652c 2020 2320 7374 6f72  : False,  # stor
-0001be20: 6520 7261 7720 6461 7461 2c20 726f 756e  e raw data, roun
-0001be30: 6420 6d79 7365 6c66 0a20 2020 2020 2020  d myself.       
-0001be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be50: 2022 7261 6973 655f 6572 726f 7273 223a   "raise_errors":
-0001be60: 2054 7275 652c 0a20 2020 2020 2020 2020   True,.         
-0001be70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001be80: 6465 6275 6722 3a20 6465 6275 677d 0a0a  debug": debug}..
-0001be90: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-0001bea0: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
-0001beb0: 2020 6d73 6720 3d20 6622 2d20 7b73 656c    msg = f"- {sel
-0001bec0: 662e 7469 636b 6572 7d3a 2066 6574 6368  f.ticker}: fetch
-0001bed0: 696e 6720 7b70 7374 727d 2070 6572 696f  ing {pstr} perio
-0001bee0: 6422 0a20 2020 2020 2020 2020 2020 2079  d".            y
-0001bef0: 6663 6c2e 5472 6163 6550 7269 6e74 286d  fcl.TracePrint(m
-0001bf00: 7367 2920 6966 2079 6663 6c2e 4973 5472  sg) if yfcl.IsTr
-0001bf10: 6163 696e 6745 6e61 626c 6564 2829 2065  acingEnabled() e
-0001bf20: 6c73 6520 7072 696e 7428 6d73 6729 0a0a  lse print(msg)..
-0001bf30: 2020 2020 2020 2020 6466 203d 2073 656c          df = sel
-0001bf40: 662e 6461 742e 6869 7374 6f72 7928 2a2a  f.dat.history(**
-0001bf50: 6869 7374 6f72 795f 6172 6773 290a 0a20  history_args).. 
-0001bf60: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
-0001bf70: 2066 2250 4d3a 3a5f 6665 7463 6859 6648   f"PM::_fetchYfH
-0001bf80: 6973 746f 7279 5f70 6572 696f 6428 2920  istory_period() 
-0001bf90: 7265 7475 726e 696e 6720 4446 207b 6466  returning DF {df
-0001bfa0: 2e69 6e64 6578 5b30 5d7d 202d 3e20 7b64  .index[0]} -> {d
-0001bfb0: 662e 696e 6465 785b 2d31 5d7d 220a 2020  f.index[-1]}".  
-0001bfc0: 2020 2020 2020 6966 2079 6663 6c2e 4973        if yfcl.Is
-0001bfd0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-0001bfe0: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
-0001bff0: 636c 2e54 7261 6365 4578 6974 286c 6f67  cl.TraceExit(log
-0001c000: 5f6d 7367 290a 2020 2020 2020 2020 656c  _msg).        el
-0001c010: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-0001c020: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0001c030: 6c6f 675f 6d73 6729 0a0a 2020 2020 2020  log_msg)..      
-0001c040: 2020 7265 7475 726e 2064 660a 0a20 2020    return df..   
-0001c050: 2064 6566 205f 6665 7463 6859 6648 6973   def _fetchYfHis
-0001c060: 746f 7279 5f64 6174 6552 616e 6765 2873  tory_dateRange(s
-0001c070: 656c 662c 2073 7461 7274 2c20 656e 642c  elf, start, end,
-0001c080: 2070 7265 706f 7374 2c20 6465 6275 6729   prepost, debug)
-0001c090: 3a0a 2020 2020 2020 2020 7966 6375 2e54  :.        yfcu.T
-0001c0a0: 7970 6543 6865 636b 496e 7465 7276 616c  ypeCheckInterval
-0001c0b0: 4474 2873 7461 7274 2c20 7365 6c66 2e69  Dt(start, self.i
-0001c0c0: 6e74 6572 7661 6c2c 2022 7374 6172 7422  nterval, "start"
-0001c0d0: 290a 2020 2020 2020 2020 7966 6375 2e54  ).        yfcu.T
-0001c0e0: 7970 6543 6865 636b 496e 7465 7276 616c  ypeCheckInterval
-0001c0f0: 4474 2865 6e64 2c20 7365 6c66 2e69 6e74  Dt(end, self.int
-0001c100: 6572 7661 6c2c 2022 656e 6422 290a 2020  erval, "end").  
-0001c110: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
-0001c120: 6865 636b 426f 6f6c 2870 7265 706f 7374  heckBool(prepost
-0001c130: 2c20 2270 7265 706f 7374 2229 0a20 2020  , "prepost").   
-0001c140: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-0001c150: 6563 6b42 6f6f 6c28 6465 6275 672c 2022  eckBool(debug, "
-0001c160: 6465 6275 6722 290a 0a20 2020 2020 2020  debug")..       
-0001c170: 2064 6562 7567 5f79 6663 203d 2046 616c   debug_yfc = Fal
-0001c180: 7365 0a20 2020 2020 2020 2023 2064 6562  se.        # deb
-0001c190: 7567 5f79 6663 203d 2054 7275 650a 0a20  ug_yfc = True.. 
-0001c1a0: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
-0001c1b0: 2066 2250 4d3a 3a5f 6665 7463 6859 6648   f"PM::_fetchYfH
-0001c1c0: 6973 746f 7279 5f64 6174 6552 616e 6765  istory_dateRange
-0001c1d0: 2d7b 7365 6c66 2e69 7374 727d 2873 7461  -{self.istr}(sta
-0001c1e0: 7274 3d7b 7374 6172 747d 202c 2065 6e64  rt={start} , end
-0001c1f0: 3d7b 656e 647d 202c 2070 7265 706f 7374  ={end} , prepost
-0001c200: 3d7b 7072 6570 6f73 747d 2922 0a20 2020  ={prepost})".   
-0001c210: 2020 2020 2069 6620 7966 636c 2e49 7354       if yfcl.IsT
-0001c220: 7261 6369 6e67 456e 6162 6c65 6428 293a  racingEnabled():
-0001c230: 0a20 2020 2020 2020 2020 2020 2079 6663  .            yfc
-0001c240: 6c2e 5472 6163 6545 6e74 6572 286c 6f67  l.TraceEnter(log
-0001c250: 5f6d 7367 290a 2020 2020 2020 2020 656c  _msg).        el
-0001c260: 6966 2064 6562 7567 5f79 6663 3a0a 2020  if debug_yfc:.  
-0001c270: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0001c280: 2222 290a 2020 2020 2020 2020 2020 2020  "").            
-0001c290: 7072 696e 7428 6c6f 675f 6d73 6729 0a0a  print(log_msg)..
-0001c2a0: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
-0001c2b0: 6172 7420 3d20 7374 6172 740a 2020 2020  art = start.    
-0001c2c0: 2020 2020 6665 7463 685f 656e 6420 3d20      fetch_end = 
-0001c2d0: 656e 640a 2020 2020 2020 2020 6966 206e  end.        if n
-0001c2e0: 6f74 2069 7369 6e73 7461 6e63 6528 6665  ot isinstance(fe
-0001c2f0: 7463 685f 7374 6172 742c 2028 6461 7465  tch_start, (date
-0001c300: 7469 6d65 2c20 7064 2e54 696d 6573 7461  time, pd.Timesta
-0001c310: 6d70 2929 3a0a 2020 2020 2020 2020 2020  mp)):.          
-0001c320: 2020 6665 7463 685f 7374 6172 745f 6474    fetch_start_dt
-0001c330: 203d 2064 6174 6574 696d 652e 636f 6d62   = datetime.comb
-0001c340: 696e 6528 6665 7463 685f 7374 6172 742c  ine(fetch_start,
-0001c350: 2074 696d 6528 3029 2c20 7365 6c66 2e74   time(0), self.t
-0001c360: 7a29 0a20 2020 2020 2020 2065 6c73 653a  z).        else:
-0001c370: 0a20 2020 2020 2020 2020 2020 2066 6574  .            fet
-0001c380: 6368 5f73 7461 7274 5f64 7420 3d20 6665  ch_start_dt = fe
-0001c390: 7463 685f 7374 6172 740a 2020 2020 2020  tch_start.      
-0001c3a0: 2020 2320 6966 206e 6f74 2069 7369 6e73    # if not isins
-0001c3b0: 7461 6e63 6528 6665 7463 685f 656e 642c  tance(fetch_end,
-0001c3c0: 2028 6461 7465 7469 6d65 2c20 7064 2e54   (datetime, pd.T
-0001c3d0: 696d 6573 7461 6d70 2929 3a0a 2020 2020  imestamp)):.    
-0001c3e0: 2020 2020 2320 2020 2020 6665 7463 685f      #     fetch_
-0001c3f0: 656e 645f 6474 203d 2064 6174 6574 696d  end_dt = datetim
-0001c400: 652e 636f 6d62 696e 6528 6665 7463 685f  e.combine(fetch_
-0001c410: 656e 642c 2074 696d 6528 3029 2c20 7365  end, time(0), se
-0001c420: 6c66 2e74 7a29 0a20 2020 2020 2020 2023  lf.tz).        #
-0001c430: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
-0001c440: 2020 2020 2066 6574 6368 5f65 6e64 5f64       fetch_end_d
-0001c450: 7420 3d20 6665 7463 685f 656e 640a 0a20  t = fetch_end.. 
-0001c460: 2020 2020 2020 2068 6973 746f 7279 5f61         history_a
-0001c470: 7267 7320 3d20 7b22 7065 7269 6f64 223a  rgs = {"period":
-0001c480: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
-0001c490: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001c4a0: 696e 7465 7276 616c 223a 2073 656c 662e  interval": self.
-0001c4b0: 6973 7472 2c0a 2020 2020 2020 2020 2020  istr,.          
-0001c4c0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0001c4d0: 7461 7274 223a 2066 6574 6368 5f73 7461  tart": fetch_sta
-0001c4e0: 7274 2c20 2265 6e64 223a 2066 6574 6368  rt, "end": fetch
-0001c4f0: 5f65 6e64 2c0a 2020 2020 2020 2020 2020  _end,.          
-0001c500: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-0001c510: 7265 706f 7374 223a 2070 7265 706f 7374  repost": prepost
-0001c520: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c530: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
-0001c540: 6e73 223a 2054 7275 652c 2020 2320 416c  ns": True,  # Al
-0001c550: 7761 7973 2066 6574 6368 0a20 2020 2020  ways fetch.     
-0001c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c570: 2020 2022 6b65 6570 6e61 223a 2054 7275     "keepna": Tru
-0001c580: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001c590: 2020 2020 2020 2020 2020 2022 7265 7061             "repa
-0001c5a0: 6972 223a 2022 7369 6c65 6e74 222c 0a20  ir": "silent",. 
+0001b370: 2020 2066 5f6e 6120 3d20 696e 7465 7276     f_na = interv
+0001b380: 616c 735b 2269 6e74 6572 7661 6c5f 6f70  als["interval_op
+0001b390: 656e 225d 2e69 736e 6128 292e 746f 5f6e  en"].isna().to_n
+0001b3a0: 756d 7079 2829 0a0a 2020 2020 2020 2020  umpy()..        
+0001b3b0: 2020 2020 2020 2020 6966 2066 5f6e 612e          if f_na.
+0001b3c0: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+0001b3d0: 2020 2020 2020 2020 2020 2023 2063 7472             # ctr
+0001b3e0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0001b3f0: 2020 2020 2020 2020 2023 2066 6f72 2069           # for i
+0001b400: 6478 2069 6e20 6e70 2e77 6865 7265 2866  dx in np.where(f
+0001b410: 5f6e 6129 5b30 5d3a 0a20 2020 2020 2020  _na)[0]:.       
+0001b420: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+0001b430: 2020 2064 7420 3d20 6466 2e69 6e64 6578     dt = df.index
+0001b440: 5b69 6478 5d0a 2020 2020 2020 2020 2020  [idx].          
+0001b450: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+0001b460: 6374 7220 2b3d 2031 0a20 2020 2020 2020  ctr += 1.       
+0001b470: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+0001b480: 2020 2069 6620 6374 7220 3c20 3130 3a0a     if ctr < 10:.
+0001b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b4a0: 2020 2020 2320 2020 2020 2020 2020 7072      #         pr
+0001b4b0: 696e 7428 2246 6169 6c65 6420 746f 206d  int("Failed to m
+0001b4c0: 6170 3a20 7b7d 2028 6578 6368 616e 6765  ap: {} (exchange
+0001b4d0: 3d7b 7d2c 2078 6361 6c3d 7b7d 2922 2e66  ={}, xcal={})".f
+0001b4e0: 6f72 6d61 7428 6474 2c20 7365 6c66 2e65  ormat(dt, self.e
+0001b4f0: 7863 6861 6e67 652c 2079 6663 642e 6578  xchange, yfcd.ex
+0001b500: 6368 616e 6765 546f 5863 616c 4578 6368  changeToXcalExch
+0001b510: 616e 6765 5b73 656c 662e 6578 6368 616e  ange[self.exchan
+0001b520: 6765 5d29 290a 2020 2020 2020 2020 2020  ge])).          
+0001b530: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+0001b540: 2020 2020 7072 696e 7428 6466 2e6c 6f63      print(df.loc
+0001b550: 5b64 745d 290a 2020 2020 2020 2020 2020  [dt]).          
+0001b560: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+0001b570: 656c 6966 2063 7472 203d 3d20 3130 3a0a  elif ctr == 10:.
+0001b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b590: 2020 2020 2320 2020 2020 2020 2020 7072      #         pr
+0001b5a0: 696e 7428 222d 2073 746f 7070 6564 2070  int("- stopped p
+0001b5b0: 7269 6e74 696e 6720 6174 2031 3020 6661  rinting at 10 fa
+0001b5c0: 696c 7572 6573 2229 0a20 2020 2020 2020  ilures").       
+0001b5d0: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
+0001b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5f0: 2020 2064 665f 6e61 203d 2064 665b 665f     df_na = df[f_
+0001b600: 6e61 5d5b 5b22 436c 6f73 6522 2c20 2256  na][["Close", "V
+0001b610: 6f6c 756d 6522 2c20 2244 6976 6964 656e  olume", "Dividen
+0001b620: 6473 222c 2022 5374 6f63 6b20 5370 6c69  ds", "Stock Spli
+0001b630: 7473 225d 5d0a 2020 2020 2020 2020 2020  ts"]].          
+0001b640: 2020 2020 2020 2020 2020 6e20 3d20 6466            n = df
+0001b650: 5f6e 612e 7368 6170 655b 305d 0a20 2020  _na.shape[0].   
+0001b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b670: 2077 6172 6e69 6e67 5f6d 7367 203d 2066   warning_msg = f
+0001b680: 2246 6169 6c65 6420 746f 206d 6170 2074  "Failed to map t
+0001b690: 6865 7365 2059 6168 6f6f 2069 6e74 6572  hese Yahoo inter
+0001b6a0: 7661 6c73 2074 6f20 7863 616c 3a20 2865  vals to xcal: (e
+0001b6b0: 7863 6861 6e67 653d 7b73 656c 662e 6578  xchange={self.ex
+0001b6c0: 6368 616e 6765 7d2c 2078 6361 6c3d 7b79  change}, xcal={y
+0001b6d0: 6663 642e 6578 6368 616e 6765 546f 5863  fcd.exchangeToXc
+0001b6e0: 616c 4578 6368 616e 6765 5b73 656c 662e  alExchange[self.
+0001b6f0: 6578 6368 616e 6765 5d7d 292e 220a 2020  exchange]}).".  
+0001b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b710: 2020 7761 726e 696e 675f 6d73 6720 2b3d    warning_msg +=
+0001b720: 2022 204e 6f72 6d61 6c6c 7920 6861 7070   " Normally happ
+0001b730: 656e 7320 7768 656e 2027 6578 6368 616e  ens when 'exchan
+0001b740: 6765 5f63 616c 656e 6461 7273 2720 6973  ge_calendars' is
+0001b750: 2077 726f 6e67 2073 6f20 696e 666f 726d   wrong so inform
+0001b760: 2064 6576 656c 6f70 6572 732e 220a 2020   developers.".  
+0001b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b780: 2020 7072 696e 7428 2222 290a 2020 2020    print("").    
+0001b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b7a0: 7072 696e 7428 7761 726e 696e 675f 6d73  print(warning_ms
+0001b7b0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+0001b7c0: 2020 2020 2020 2070 7269 6e74 2864 665f         print(df_
+0001b7d0: 6e61 290a 2020 2020 2020 2020 2020 2020  na).            
+0001b7e0: 2020 2020 2020 2020 6d73 6720 3d20 2241          msg = "A
+0001b7f0: 6363 6570 7420 696e 746f 2063 6163 6865  ccept into cache
+0001b800: 2061 6e79 7761 793f 220a 2020 2020 2020   anyway?".      
+0001b810: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001b820: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
+0001b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b840: 6163 6365 7074 203d 2054 7275 650a 2020  accept = True.  
+0001b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b860: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b880: 6163 6365 7074 203d 2063 6c69 636b 2e63  accept = click.c
+0001b890: 6f6e 6669 726d 286d 7367 2c20 6465 6661  onfirm(msg, defa
+0001b8a0: 756c 743d 4661 6c73 6529 0a20 2020 2020  ult=False).     
+0001b8b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b8c0: 6620 6163 6365 7074 3a0a 2020 2020 2020  f accept:.      
+0001b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8e0: 2020 666f 7220 6964 7820 696e 206e 702e    for idx in np.
+0001b8f0: 7768 6572 6528 665f 6e61 295b 305d 3a0a  where(f_na)[0]:.
+0001b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b910: 2020 2020 2020 2020 2020 2020 6474 203d              dt =
+0001b920: 2069 6e74 6572 7661 6c73 2e69 6e64 6578   intervals.index
+0001b930: 5b69 6478 5d0a 2020 2020 2020 2020 2020  [idx].          
+0001b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b950: 2020 6966 2069 6e74 6572 6461 793a 0a20    if interday:. 
+0001b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b970: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001b980: 6e74 6572 7661 6c73 2e6c 6f63 5b64 742c  ntervals.loc[dt,
+0001b990: 2022 696e 7465 7276 616c 5f6f 7065 6e22   "interval_open"
+0001b9a0: 5d20 3d20 6466 2e69 6e64 6578 5b69 6478  ] = df.index[idx
+0001b9b0: 5d2e 6461 7465 2829 0a20 2020 2020 2020  ].date().       
+0001b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b9d0: 2020 2020 2020 2020 2069 6e74 6572 7661           interva
+0001b9e0: 6c73 2e6c 6f63 5b64 742c 2022 696e 7465  ls.loc[dt, "inte
+0001b9f0: 7276 616c 5f63 6c6f 7365 225d 203d 2064  rval_close"] = d
+0001ba00: 662e 696e 6465 785b 6964 785d 2e64 6174  f.index[idx].dat
+0001ba10: 6528 2920 2b20 7365 6c66 2e69 7464 0a20  e() + self.itd. 
+0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba30: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001ba40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba60: 2069 6e74 6572 7661 6c73 2e6c 6f63 5b64   intervals.loc[d
+0001ba70: 742c 2022 696e 7465 7276 616c 5f6f 7065  t, "interval_ope
+0001ba80: 6e22 5d20 3d20 6466 2e69 6e64 6578 5b69  n"] = df.index[i
+0001ba90: 6478 5d0a 2020 2020 2020 2020 2020 2020  dx].            
+0001baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bab0: 2020 2020 696e 7465 7276 616c 732e 6c6f      intervals.lo
+0001bac0: 635b 6474 2c20 2269 6e74 6572 7661 6c5f  c[dt, "interval_
+0001bad0: 636c 6f73 6522 5d20 3d20 6466 2e69 6e64  close"] = df.ind
+0001bae0: 6578 5b69 6478 5d20 2b20 7365 6c66 2e69  ex[idx] + self.i
+0001baf0: 7464 0a20 2020 2020 2020 2020 2020 2020  td.             
+0001bb00: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb20: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
+0001bb30: 7469 6f6e 2822 5072 6f62 6c65 6d20 7769  tion("Problem wi
+0001bb40: 7468 2064 6174 6573 2072 6574 7572 6e65  th dates returne
+0001bb50: 6420 6279 2059 6168 6f6f 2c20 7365 6520  d by Yahoo, see 
+0001bb60: 6162 6f76 6522 290a 0a20 2020 2020 2020  above")..       
+0001bb70: 2064 6620 3d20 6466 2e63 6f70 7928 290a   df = df.copy().
+0001bb80: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001bb90: 6469 7361 626c 655f 7966 635f 6d65 7461  disable_yfc_meta
+0001bba0: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+0001bbb0: 2020 6c61 7374 4461 7461 4474 7320 3d20    lastDataDts = 
+0001bbc0: 7966 6374 2e43 616c 6349 6e74 6572 7661  yfct.CalcInterva
+0001bbd0: 6c4c 6173 7444 6174 6144 745f 6261 7463  lLastDataDt_batc
+0001bbe0: 6828 7365 6c66 2e65 7863 6861 6e67 652c  h(self.exchange,
+0001bbf0: 2069 6e74 6572 7661 6c73 5b22 696e 7465   intervals["inte
+0001bc00: 7276 616c 5f6f 7065 6e22 5d2e 746f 5f6e  rval_open"].to_n
+0001bc10: 756d 7079 2829 2c20 7365 6c66 2e69 6e74  umpy(), self.int
+0001bc20: 6572 7661 6c29 0a20 2020 2020 2020 2020  erval).         
+0001bc30: 2020 2069 6620 665f 6e61 2e61 6e79 2829     if f_na.any()
+0001bc40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bc50: 2020 2320 4861 636b 7920 736f 6c75 7469    # Hacky soluti
+0001bc60: 6f6e 2074 6f20 6861 6e64 6c65 2078 6361  on to handle xca
+0001bc70: 6c20 6861 7669 6e67 2069 6e63 6f72 7265  l having incorre
+0001bc80: 6374 2073 6368 6564 756c 652c 2066 6f72  ct schedule, for
+0001bc90: 2076 616c 6964 2059 6168 6f6f 2064 6174   valid Yahoo dat
+0001bca0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0001bcb0: 2020 6c61 7374 4461 7461 4474 735b 665f    lastDataDts[f_
+0001bcc0: 6e61 5d20 3d20 696e 7465 7276 616c 732e  na] = intervals.
+0001bcd0: 696e 6465 785b 665f 6e61 5d20 2b20 7365  index[f_na] + se
+0001bce0: 6c66 2e69 7464 0a20 2020 2020 2020 2020  lf.itd.         
+0001bcf0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+0001bd00: 6e74 7261 6461 793a 0a20 2020 2020 2020  ntraday:.       
+0001bd10: 2020 2020 2020 2020 2020 2020 206c 6173               las
+0001bd20: 7444 6174 6144 7473 5b66 5f6e 615d 202b  tDataDts[f_na] +
+0001bd30: 3d20 7966 6374 2e47 6574 4578 6368 616e  = yfct.GetExchan
+0001bd40: 6765 4461 7461 4465 6c61 7928 7365 6c66  geDataDelay(self
+0001bd50: 2e65 7863 6861 6e67 6529 0a20 2020 2020  .exchange).     
+0001bd60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001bd70: 2046 6f72 2073 6f6d 6520 6578 6368 616e   For some exchan
+0001bd80: 6765 732c 2059 6168 6f6f 2068 6173 2074  ges, Yahoo has t
+0001bd90: 7261 6465 7320 7468 6174 206f 6363 7572  rades that occur
+0001bda0: 7265 6420 736f 6f6e 2061 6665 7220 6f66  red soon afer of
+0001bdb0: 6669 6369 616c 206d 6172 6b65 7420 636c  ficial market cl
+0001bdc0: 6f73 652c 2065 2e67 2e20 4a6f 6861 6e6e  ose, e.g. Johann
+0001bdd0: 6573 6275 7267 3a0a 2020 2020 2020 2020  esburg:.        
+0001bde0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001bdf0: 656c 662e 6578 6368 616e 6765 2069 6e20  elf.exchange in 
+0001be00: 5b22 4a4e 4222 5d3a 0a20 2020 2020 2020  ["JNB"]:.       
+0001be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001be20: 206c 6173 7444 6174 6144 7473 5b66 5f6e   lastDataDts[f_n
+0001be30: 615d 202b 3d20 7469 6d65 6465 6c74 6128  a] += timedelta(
+0001be40: 6d69 6e75 7465 733d 3135 290a 2020 2020  minutes=15).    
+0001be50: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001be60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001be70: 2020 2020 2020 2320 4164 6420 7e31 3020        # Add ~10 
+0001be80: 686f 7572 7320 746f 2065 6e73 7572 6520  hours to ensure 
+0001be90: 6869 7420 6e65 7874 206d 6172 6b65 7420  hit next market 
+0001bea0: 6f70 656e 0a20 2020 2020 2020 2020 2020  open.           
+0001beb0: 2020 2020 2020 2020 206c 6173 7444 6174           lastDat
+0001bec0: 6144 7473 5b66 5f6e 615d 202b 3d20 7469  aDts[f_na] += ti
+0001bed0: 6d65 6465 6c74 6128 686f 7572 733d 3130  medelta(hours=10
+0001bee0: 290a 2020 2020 2020 2020 2020 2020 6461  ).            da
+0001bef0: 7461 5f66 696e 616c 203d 2066 6574 6368  ta_final = fetch
+0001bf00: 5f64 7420 3e3d 206c 6173 7444 6174 6144  _dt >= lastDataD
+0001bf10: 7473 0a20 2020 2020 2020 2020 2020 2064  ts.            d
+0001bf20: 665b 2246 696e 616c 3f22 5d20 3d20 6461  f["Final?"] = da
+0001bf30: 7461 5f66 696e 616c 0a0a 2020 2020 2020  ta_final..      
+0001bf40: 2020 2020 2020 2320 6466 5b22 4665 7463        # df["Fetc
+0001bf50: 6844 6174 6522 5d20 3d20 7064 2e54 696d  hDate"] = pd.Tim
+0001bf60: 6573 7461 6d70 2866 6574 6368 5f64 745f  estamp(fetch_dt_
+0001bf70: 7574 6329 2e74 7a5f 6c6f 6361 6c69 7a65  utc).tz_localize
+0001bf80: 2822 5554 4322 290a 2020 2020 2020 2020  ("UTC").        
+0001bf90: 2020 2020 6466 5b22 4665 7463 6844 6174      df["FetchDat
+0001bfa0: 6522 5d20 3d20 6665 7463 685f 6474 5f75  e"] = fetch_dt_u
+0001bfb0: 7463 0a0a 2020 2020 2020 2020 2020 2020  tc..            
+0001bfc0: 6466 5b22 432d 4368 6563 6b3f 225d 203d  df["C-Check?"] =
+0001bfd0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+0001bfe0: 6c6f 675f 6d73 6720 3d20 6622 504d 3a3a  log_msg = f"PM::
+0001bff0: 5f66 6574 6368 5966 4869 7374 6f72 7928  _fetchYfHistory(
+0001c000: 2920 7265 7475 726e 696e 6720 4446 207b  ) returning DF {
+0001c010: 6466 2e69 6e64 6578 5b30 5d7d 202d 3e20  df.index[0]} -> 
+0001c020: 7b64 662e 696e 6465 785b 2d31 5d7d 220a  {df.index[-1]}".
+0001c030: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
+0001c040: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+0001c050: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+0001c060: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
+0001c070: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
+0001c080: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
+0001c090: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001c0a0: 7428 6c6f 675f 6d73 6729 0a0a 2020 2020  t(log_msg)..    
+0001c0b0: 2020 2020 7365 6c66 2e6d 616e 6167 6572      self.manager
+0001c0c0: 2e4c 6f67 4576 656e 7428 2269 6e66 6f22  .LogEvent("info"
+0001c0d0: 2c20 2250 7269 6365 4d61 6e61 6765 7222  , "PriceManager"
+0001c0e0: 2c20 6622 7072 6f63 6573 7365 6420 5946  , f"processed YF
+0001c0f0: 2072 6573 706f 6e73 6520 3d20 7b73 656c   response = {sel
+0001c100: 662e 6973 7472 7d20 7b64 662e 696e 6465  f.istr} {df.inde
+0001c110: 785b 305d 7d20 2d3e 207b 6466 2e69 6e64  x[0]} -> {df.ind
+0001c120: 6578 5b2d 315d 7d22 290a 0a20 2020 2020  ex[-1]}")..     
+0001c130: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
+0001c140: 2020 6465 6620 5f66 6574 6368 5966 4869    def _fetchYfHi
+0001c150: 7374 6f72 795f 6461 7465 5261 6e67 6528  story_dateRange(
+0001c160: 7365 6c66 2c20 7374 6172 742c 2065 6e64  self, start, end
+0001c170: 2c20 7072 6570 6f73 742c 2064 6562 7567  , prepost, debug
+0001c180: 293a 0a20 2020 2020 2020 2079 6663 752e  ):.        yfcu.
+0001c190: 5479 7065 4368 6563 6b49 6e74 6572 7661  TypeCheckInterva
+0001c1a0: 6c44 7428 7374 6172 742c 2073 656c 662e  lDt(start, self.
+0001c1b0: 696e 7465 7276 616c 2c20 2273 7461 7274  interval, "start
+0001c1c0: 2229 0a20 2020 2020 2020 2079 6663 752e  ").        yfcu.
+0001c1d0: 5479 7065 4368 6563 6b49 6e74 6572 7661  TypeCheckInterva
+0001c1e0: 6c44 7428 656e 642c 2073 656c 662e 696e  lDt(end, self.in
+0001c1f0: 7465 7276 616c 2c20 2265 6e64 2229 0a20  terval, "end"). 
+0001c200: 2020 2020 2020 2079 6663 752e 5479 7065         yfcu.Type
+0001c210: 4368 6563 6b42 6f6f 6c28 7072 6570 6f73  CheckBool(prepos
+0001c220: 742c 2022 7072 6570 6f73 7422 290a 2020  t, "prepost").  
+0001c230: 2020 2020 2020 7966 6375 2e54 7970 6543        yfcu.TypeC
+0001c240: 6865 636b 426f 6f6c 2864 6562 7567 2c20  heckBool(debug, 
+0001c250: 2264 6562 7567 2229 0a0a 2020 2020 2020  "debug")..      
+0001c260: 2020 6465 6275 675f 7966 6320 3d20 4661    debug_yfc = Fa
+0001c270: 6c73 650a 2020 2020 2020 2020 2320 6465  lse.        # de
+0001c280: 6275 675f 7966 6320 3d20 5472 7565 0a0a  bug_yfc = True..
+0001c290: 2020 2020 2020 2020 6c6f 675f 6d73 6720          log_msg 
+0001c2a0: 3d20 6622 504d 3a3a 5f66 6574 6368 5966  = f"PM::_fetchYf
+0001c2b0: 4869 7374 6f72 795f 6461 7465 5261 6e67  History_dateRang
+0001c2c0: 652d 7b73 656c 662e 6973 7472 7d28 7374  e-{self.istr}(st
+0001c2d0: 6172 743d 7b73 7461 7274 7d20 2c20 656e  art={start} , en
+0001c2e0: 643d 7b65 6e64 7d20 2c20 7072 6570 6f73  d={end} , prepos
+0001c2f0: 743d 7b70 7265 706f 7374 7d29 220a 2020  t={prepost})".  
+0001c300: 2020 2020 2020 6966 2079 6663 6c2e 4973        if yfcl.Is
+0001c310: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+0001c320: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
+0001c330: 636c 2e54 7261 6365 456e 7465 7228 6c6f  cl.TraceEnter(lo
+0001c340: 675f 6d73 6729 0a20 2020 2020 2020 2065  g_msg).        e
+0001c350: 6c69 6620 6465 6275 675f 7966 633a 0a20  lif debug_yfc:. 
+0001c360: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0001c370: 2822 2229 0a20 2020 2020 2020 2020 2020  ("").           
+0001c380: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
+0001c390: 0a20 2020 2020 2020 2066 6574 6368 5f73  .        fetch_s
+0001c3a0: 7461 7274 203d 2073 7461 7274 0a20 2020  tart = start.   
+0001c3b0: 2020 2020 2066 6574 6368 5f65 6e64 203d       fetch_end =
+0001c3c0: 2065 6e64 0a20 2020 2020 2020 2069 6620   end.        if 
+0001c3d0: 6e6f 7420 6973 696e 7374 616e 6365 2866  not isinstance(f
+0001c3e0: 6574 6368 5f73 7461 7274 2c20 2864 6174  etch_start, (dat
+0001c3f0: 6574 696d 652c 2070 642e 5469 6d65 7374  etime, pd.Timest
+0001c400: 616d 7029 293a 0a20 2020 2020 2020 2020  amp)):.         
+0001c410: 2020 2066 6574 6368 5f73 7461 7274 5f64     fetch_start_d
+0001c420: 7420 3d20 6461 7465 7469 6d65 2e63 6f6d  t = datetime.com
+0001c430: 6269 6e65 2866 6574 6368 5f73 7461 7274  bine(fetch_start
+0001c440: 2c20 7469 6d65 2830 292c 2073 656c 662e  , time(0), self.
+0001c450: 747a 290a 2020 2020 2020 2020 656c 7365  tz).        else
+0001c460: 3a0a 2020 2020 2020 2020 2020 2020 6665  :.            fe
+0001c470: 7463 685f 7374 6172 745f 6474 203d 2066  tch_start_dt = f
+0001c480: 6574 6368 5f73 7461 7274 0a0a 2020 2020  etch_start..    
+0001c490: 2020 2020 6869 7374 6f72 795f 6172 6773      history_args
+0001c4a0: 203d 207b 2270 6572 696f 6422 3a20 4e6f   = {"period": No
+0001c4b0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0001c4c0: 2020 2020 2020 2020 2020 2020 2269 6e74              "int
+0001c4d0: 6572 7661 6c22 3a20 7365 6c66 2e69 7374  erval": self.ist
+0001c4e0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0001c4f0: 2020 2020 2020 2020 2020 2022 7374 6172             "star
+0001c500: 7422 3a20 6665 7463 685f 7374 6172 742c  t": fetch_start,
+0001c510: 2022 656e 6422 3a20 6665 7463 685f 656e   "end": fetch_en
+0001c520: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0001c530: 2020 2020 2020 2020 2020 2022 7072 6570             "prep
+0001c540: 6f73 7422 3a20 7072 6570 6f73 742c 0a20  ost": prepost,. 
+0001c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c560: 2020 2020 2020 2022 6163 7469 6f6e 7322         "actions"
+0001c570: 3a20 5472 7565 2c20 2023 2041 6c77 6179  : True,  # Alway
+0001c580: 7320 6665 7463 680a 2020 2020 2020 2020  s fetch.        
+0001c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5a0: 226b 6565 706e 6122 3a20 5472 7565 2c0a  "keepna": True,.
 0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5c0: 2020 2020 2020 2022 6175 746f 5f61 646a         "auto_adj
-0001c5d0: 7573 7422 3a20 4661 6c73 652c 2020 2320  ust": False,  # 
-0001c5e0: 7374 6f72 6520 7261 7720 6461 7461 2c20  store raw data, 
-0001c5f0: 6164 6a75 7374 206d 7973 656c 660a 2020  adjust myself.  
-0001c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c610: 2020 2020 2020 2262 6163 6b5f 6164 6a75        "back_adju
-0001c620: 7374 223a 2046 616c 7365 2c20 2023 2073  st": False,  # s
-0001c630: 746f 7265 2072 6177 2064 6174 612c 2061  tore raw data, a
-0001c640: 646a 7573 7420 6d79 7365 6c66 0a20 2020  djust myself.   
-0001c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c660: 2020 2020 2022 7072 6f78 7922 3a20 7365       "proxy": se
-0001c670: 6c66 2e70 726f 7879 2c0a 2020 2020 2020  lf.proxy,.      
+0001c5c0: 2020 2020 2020 2020 2272 6570 6169 7222          "repair"
+0001c5d0: 3a20 2273 696c 656e 7422 2c0a 2020 2020  : "silent",.    
+0001c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5f0: 2020 2020 2261 7574 6f5f 6164 6a75 7374      "auto_adjust
+0001c600: 223a 2046 616c 7365 2c20 2023 2073 746f  ": False,  # sto
+0001c610: 7265 2072 6177 2064 6174 612c 2061 646a  re raw data, adj
+0001c620: 7573 7420 6d79 7365 6c66 0a20 2020 2020  ust myself.     
+0001c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c640: 2020 2022 6261 636b 5f61 646a 7573 7422     "back_adjust"
+0001c650: 3a20 4661 6c73 652c 2020 2320 7374 6f72  : False,  # stor
+0001c660: 6520 7261 7720 6461 7461 2c20 6164 6a75  e raw data, adju
+0001c670: 7374 206d 7973 656c 660a 2020 2020 2020  st myself.      
 0001c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c690: 2020 2272 6f75 6e64 696e 6722 3a20 4661    "rounding": Fa
-0001c6a0: 6c73 652c 2020 2320 7374 6f72 6520 7261  lse,  # store ra
-0001c6b0: 7720 6461 7461 2c20 726f 756e 6420 6d79  w data, round my
-0001c6c0: 7365 6c66 0a20 2020 2020 2020 2020 2020  self.           
-0001c6d0: 2020 2020 2020 2020 2020 2020 2022 7261               "ra
-0001c6e0: 6973 655f 6572 726f 7273 223a 2054 7275  ise_errors": Tru
-0001c6f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001c700: 2020 2020 2020 2020 2020 2022 6465 6275             "debu
-0001c710: 6722 3a20 6465 6275 677d 0a0a 2020 2020  g": debug}..    
-0001c720: 2020 2020 6966 2064 6562 7567 5f79 6663      if debug_yfc
-0001c730: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0001c740: 2028 6e6f 7420 6973 696e 7374 616e 6365   (not isinstance
-0001c750: 2866 6574 6368 5f73 7461 7274 2c20 6461  (fetch_start, da
-0001c760: 7465 7469 6d65 2929 206f 7220 6665 7463  tetime)) or fetc
-0001c770: 685f 7374 6172 742e 7469 6d65 2829 203d  h_start.time() =
-0001c780: 3d20 7469 6d65 2830 293a 0a20 2020 2020  = time(0):.     
-0001c790: 2020 2020 2020 2020 2020 2073 7461 7274             start
-0001c7a0: 5f73 7472 203d 2066 6574 6368 5f73 7461  _str = fetch_sta
-0001c7b0: 7274 2e73 7472 6674 696d 6528 2225 592d  rt.strftime("%Y-
-0001c7c0: 256d 2d25 6422 290a 2020 2020 2020 2020  %m-%d").        
-0001c7d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001c7e0: 2020 2020 2020 2020 2020 7374 6172 745f            start_
-0001c7f0: 7374 7220 3d20 6665 7463 685f 7374 6172  str = fetch_star
-0001c800: 742e 7374 7266 7469 6d65 2822 2559 2d25  t.strftime("%Y-%
-0001c810: 6d2d 2564 2025 483a 254d 3a25 5322 290a  m-%d %H:%M:%S").
-0001c820: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-0001c830: 6e6f 7420 6973 696e 7374 616e 6365 2866  not isinstance(f
-0001c840: 6574 6368 5f65 6e64 2c20 6461 7465 7469  etch_end, dateti
-0001c850: 6d65 2929 206f 7220 6665 7463 685f 656e  me)) or fetch_en
-0001c860: 642e 7469 6d65 2829 203d 3d20 7469 6d65  d.time() == time
-0001c870: 2830 293a 0a20 2020 2020 2020 2020 2020  (0):.           
-0001c880: 2020 2020 2065 6e64 5f73 7472 203d 2066       end_str = f
-0001c890: 6574 6368 5f65 6e64 2e73 7472 6674 696d  etch_end.strftim
-0001c8a0: 6528 2225 592d 256d 2d25 6422 290a 2020  e("%Y-%m-%d").  
-0001c8b0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c8d0: 656e 645f 7374 7220 3d20 6665 7463 685f  end_str = fetch_
-0001c8e0: 656e 642e 7374 7266 7469 6d65 2822 2559  end.strftime("%Y
-0001c8f0: 2d25 6d2d 2564 2025 483a 254d 3a25 5322  -%m-%d %H:%M:%S"
-0001c900: 290a 2020 2020 2020 2020 2020 2020 6d73  ).            ms
-0001c910: 6720 3d20 6622 2d20 7b73 656c 662e 7469  g = f"- {self.ti
-0001c920: 636b 6572 7d3a 2066 6574 6368 696e 6720  cker}: fetching 
-0001c930: 7b73 656c 662e 6973 7472 7d20 7b73 7461  {self.istr} {sta
-0001c940: 7274 5f73 7472 7d20 2d3e 207b 656e 645f  rt_str} -> {end_
-0001c950: 7374 727d 220a 2020 2020 2020 2020 2020  str}".          
-0001c960: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
-0001c970: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
-0001c980: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
-0001c990: 2920 656c 7365 2070 7269 6e74 286d 7367  ) else print(msg
-0001c9a0: 290a 0a20 2020 2020 2020 2066 6972 7374  )..        first
-0001c9b0: 5f66 6574 6368 5f66 6169 6c65 6420 3d20  _fetch_failed = 
-0001c9c0: 4661 6c73 650a 2020 2020 2020 2020 7472  False.        tr
-0001c9d0: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
-0001c9e0: 6620 6465 6275 675f 7966 633a 0a20 2020  f debug_yfc:.   
-0001c9f0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-0001ca00: 203d 2066 222d 2066 6574 6368 5f73 7461   = f"- fetch_sta
-0001ca10: 7274 3d7b 6665 7463 685f 7374 6172 747d  rt={fetch_start}
-0001ca20: 203b 2066 6574 6368 5f65 6e64 3d7b 6665   ; fetch_end={fe
-0001ca30: 7463 685f 656e 647d 220a 2020 2020 2020  tch_end}".      
-0001ca40: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
-0001ca50: 7261 6365 5072 696e 7428 6d73 6729 2069  racePrint(msg) i
-0001ca60: 6620 7966 636c 2e49 7354 7261 6369 6e67  f yfcl.IsTracing
-0001ca70: 456e 6162 6c65 6428 2920 656c 7365 2070  Enabled() else p
-0001ca80: 7269 6e74 286d 7367 290a 2020 2020 2020  rint(msg).      
-0001ca90: 2020 2020 2020 6466 203d 2073 656c 662e        df = self.
-0001caa0: 6461 742e 6869 7374 6f72 7928 2a2a 6869  dat.history(**hi
-0001cab0: 7374 6f72 795f 6172 6773 290a 2020 2020  story_args).    
-0001cac0: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
-0001cad0: 5f79 6663 3a0a 2020 2020 2020 2020 2020  _yfc:.          
-0001cae0: 2020 2020 2020 6966 2064 6620 6973 204e        if df is N
-0001caf0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001cb00: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-0001cb10: 2d20 5946 2072 6574 7572 6e65 6420 4e6f  - YF returned No
-0001cb20: 6e65 220a 2020 2020 2020 2020 2020 2020  ne".            
-0001cb30: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-0001cb40: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
-0001cb50: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
-0001cb60: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
-0001cb70: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
-0001cb80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cba0: 2020 6d73 6720 3d20 222d 2059 4620 7265    msg = "- YF re
-0001cbb0: 7475 726e 6564 2074 6162 6c65 3a22 0a20  turned table:". 
-0001cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbd0: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
-0001cbe0: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
-0001cbf0: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-0001cc00: 2829 2065 6c73 6520 7072 696e 7428 6d73  () else print(ms
-0001cc10: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-0001cc20: 2020 2020 2020 2070 7269 6e74 2864 665b         print(df[
-0001cc30: 5b63 2066 6f72 2063 2069 6e20 5b22 4f70  [c for c in ["Op
-0001cc40: 656e 222c 2022 4c6f 7722 2c20 2248 6967  en", "Low", "Hig
-0001cc50: 6822 2c20 2243 6c6f 7365 222c 2022 4469  h", "Close", "Di
-0001cc60: 7669 6465 6e64 7322 2c20 2256 6f6c 756d  vidends", "Volum
-0001cc70: 6522 5d20 6966 2063 2069 6e20 6466 2e63  e"] if c in df.c
-0001cc80: 6f6c 756d 6e73 5d5d 290a 2020 2020 2020  olumns]]).      
-0001cc90: 2020 2020 2020 6966 2064 6620 6973 204e        if df is N
-0001cca0: 6f6e 6520 6f72 2064 662e 656d 7074 793a  one or df.empty:
-0001ccb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ccc0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-0001ccd0: 2822 4e6f 2064 6174 6120 666f 756e 6420  ("No data found 
-0001cce0: 666f 7220 7468 6973 2064 6174 6520 7261  for this date ra
-0001ccf0: 6e67 6522 290a 2020 2020 2020 2020 6578  nge").        ex
-0001cd00: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-0001cd10: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-0001cd20: 2066 6972 7374 5f66 6574 6368 5f66 6169   first_fetch_fai
-0001cd30: 6c65 6420 3d20 5472 7565 0a20 2020 2020  led = True.     
-0001cd40: 2020 2020 2020 2069 6620 2244 6174 6120         if "Data 
-0001cd50: 646f 6573 6e27 7420 6578 6973 7420 666f  doesn't exist fo
-0001cd60: 7220 7374 6172 7444 6174 6522 2069 6e20  r startDate" in 
-0001cd70: 7374 7228 6529 3a0a 2020 2020 2020 2020  str(e):.        
-0001cd80: 2020 2020 2020 2020 6578 203d 2079 6663          ex = yfc
-0001cd90: 642e 4e6f 5072 6963 6544 6174 6149 6e52  d.NoPriceDataInR
-0001cda0: 616e 6765 4578 6365 7074 696f 6e28 7365  angeException(se
-0001cdb0: 6c66 2e74 6963 6b65 722c 2073 656c 662e  lf.ticker, self.
-0001cdc0: 6973 7472 2c20 7374 6172 742c 2065 6e64  istr, start, end
-0001cdd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001cde0: 2020 7261 6973 6520 6578 0a20 2020 2020    raise ex.     
-0001cdf0: 2020 2020 2020 2065 6c69 6620 224e 6f20         elif "No 
-0001ce00: 6461 7461 2066 6f75 6e64 2066 6f72 2074  data found for t
-0001ce10: 6869 7320 6461 7465 2072 616e 6765 2220  his date range" 
-0001ce20: 696e 2073 7472 2865 293a 0a20 2020 2020  in str(e):.     
-0001ce30: 2020 2020 2020 2020 2020 2065 7820 3d20             ex = 
-0001ce40: 7966 6364 2e4e 6f50 7269 6365 4461 7461  yfcd.NoPriceData
-0001ce50: 496e 5261 6e67 6545 7863 6570 7469 6f6e  InRangeException
-0001ce60: 2873 656c 662e 7469 636b 6572 2c20 7365  (self.ticker, se
-0001ce70: 6c66 2e69 7374 722c 2073 7461 7274 2c20  lf.istr, start, 
-0001ce80: 656e 6429 0a20 2020 2020 2020 2020 2020  end).           
-0001ce90: 2020 2020 2072 6169 7365 2065 780a 2020       raise ex.  
-0001cea0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cec0: 7072 696e 7428 2264 663a 2229 0a20 2020  print("df:").   
-0001ced0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0001cee0: 6e74 2864 6629 0a20 2020 2020 2020 2020  nt(df).         
-0001cef0: 2020 2020 2020 2072 6169 7365 2065 0a0a         raise e..
-0001cf00: 2020 2020 2020 2020 6966 206e 6f74 2066          if not f
-0001cf10: 6972 7374 5f66 6574 6368 5f66 6169 6c65  irst_fetch_faile
-0001cf20: 6420 616e 6420 6665 7463 685f 7374 6172  d and fetch_star
-0001cf30: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-0001cf40: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
-0001cf50: 6466 2e6c 6f63 5b66 6574 6368 5f73 7461  df.loc[fetch_sta
-0001cf60: 7274 5f64 743a 5d0a 2020 2020 2020 2020  rt_dt:].        
-0001cf70: 2020 2020 6966 2064 662e 656d 7074 793a      if df.empty:
-0001cf80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cf90: 2066 6972 7374 5f66 6574 6368 5f66 6169   first_fetch_fai
-0001cfa0: 6c65 6420 3d20 5472 7565 0a20 2020 2020  led = True.     
-0001cfb0: 2020 2020 2020 2020 2020 2065 7820 3d20             ex = 
-0001cfc0: 7966 6364 2e4e 6f50 7269 6365 4461 7461  yfcd.NoPriceData
-0001cfd0: 496e 5261 6e67 6545 7863 6570 7469 6f6e  InRangeException
-0001cfe0: 2873 656c 662e 7469 636b 6572 2c20 7365  (self.ticker, se
-0001cff0: 6c66 2e69 7374 722c 2073 7461 7274 2c20  lf.istr, start, 
-0001d000: 656e 6429 0a0a 2020 2020 2020 2020 2320  end)..        # 
-0001d010: 4368 6563 6b20 7468 6174 2077 6565 6b6c  Check that weekl
-0001d020: 7920 616c 6967 6e65 6420 746f 204d 6f6e  y aligned to Mon
-0001d030: 6461 792e 2049 6620 6e6f 742c 2073 6869  day. If not, shi
-0001d040: 6674 2073 7461 7274 2064 6174 6520 6261  ft start date ba
-0001d050: 636b 2061 6e64 2072 652d 6665 7463 680a  ck and re-fetch.
-0001d060: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001d070: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-0001d080: 2e49 6e74 6572 7661 6c2e 5765 656b 2061  .Interval.Week a
-0001d090: 6e64 2028 6e6f 7420 6466 2e65 6d70 7479  nd (not df.empty
-0001d0a0: 2920 616e 6420 2864 662e 696e 6465 785b  ) and (df.index[
-0001d0b0: 305d 2e77 6565 6b64 6179 2829 2021 3d20  0].weekday() != 
-0001d0c0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-0001d0d0: 2320 4465 7370 6974 6520 6665 7463 685f  # Despite fetch_
-0001d0e0: 7374 6172 7420 616c 6967 6e65 6420 746f  start aligned to
-0001d0f0: 204d 6f6e 6461 792c 2073 6f6d 6574 696d   Monday, sometim
-0001d100: 6573 2059 6168 6f6f 2072 6574 7572 6e73  es Yahoo returns
-0001d110: 2077 6565 6b6c 790a 2020 2020 2020 2020   weekly.        
-0001d120: 2020 2020 2320 6461 7461 2073 7461 7274      # data start
-0001d130: 696e 6720 6120 6469 6666 6572 656e 7420  ing a different 
-0001d140: 6461 792e 2053 6869 6674 696e 6720 6261  day. Shifting ba
-0001d150: 636b 2061 206c 6974 746c 6520 6669 7865  ck a little fixe
-0001d160: 730a 2020 2020 2020 2020 2020 2020 7368  s.            sh
-0001d170: 6966 745f 6261 636b 7320 3d20 5b32 2c20  ift_backs = [2, 
-0001d180: 345d 0a20 2020 2020 2020 2020 2020 2066  4].            f
-0001d190: 6f72 2064 2069 6e20 7368 6966 745f 6261  or d in shift_ba
-0001d1a0: 636b 733a 0a20 2020 2020 2020 2020 2020  cks:.           
-0001d1b0: 2020 2020 2066 6574 6368 5f73 7461 7274       fetch_start
-0001d1c0: 3220 3d20 6665 7463 685f 7374 6172 7420  2 = fetch_start 
-0001d1d0: 2d20 7469 6d65 6465 6c74 6128 6461 7973  - timedelta(days
-0001d1e0: 3d64 290a 2020 2020 2020 2020 2020 2020  =d).            
-0001d1f0: 2020 2020 6869 7374 6f72 795f 6172 6773      history_args
-0001d200: 5b22 7374 6172 7422 5d20 3d20 6665 7463  ["start"] = fetc
-0001d210: 685f 7374 6172 7432 0a20 2020 2020 2020  h_start2.       
-0001d220: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-0001d230: 675f 7966 633a 0a20 2020 2020 2020 2020  g_yfc:.         
-0001d240: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0001d250: 2022 2d20 7765 656b 6c79 2064 6174 6120   "- weekly data 
-0001d260: 6e6f 7420 616c 6967 6e65 6420 746f 204d  not aligned to M
-0001d270: 6f6e 6461 792c 2072 652d 6665 7463 6869  onday, re-fetchi
-0001d280: 6e67 2066 726f 6d20 7b7d 222e 666f 726d  ng from {}".form
-0001d290: 6174 2866 6574 6368 5f73 7461 7274 3229  at(fetch_start2)
-0001d2a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d2b0: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
-0001d2c0: 7269 6e74 286d 7367 2920 6966 2079 6663  rint(msg) if yfc
-0001d2d0: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
-0001d2e0: 6564 2829 2065 6c73 6520 7072 696e 7428  ed() else print(
-0001d2f0: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-0001d300: 2020 2020 2064 6620 3d20 7365 6c66 2e64       df = self.d
-0001d310: 6174 2e68 6973 746f 7279 282a 2a68 6973  at.history(**his
-0001d320: 746f 7279 5f61 7267 7329 0a20 2020 2020  tory_args).     
-0001d330: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0001d340: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-0001d350: 6663 642e 496e 7465 7276 616c 2e57 6565  fcd.Interval.Wee
-0001d360: 6b20 616e 6420 2864 662e 696e 6465 785b  k and (df.index[
-0001d370: 305d 2e77 6565 6b64 6179 2829 203d 3d20  0].weekday() == 
-0001d380: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
-0001d390: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-0001d3a0: 7461 6e63 6528 7374 6172 742c 2064 6174  tance(start, dat
-0001d3b0: 6574 696d 6529 3a0a 2020 2020 2020 2020  etime):.        
-0001d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d3d0: 7374 6172 745f 6474 203d 2073 7461 7274  start_dt = start
-0001d3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d3f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d410: 2020 2073 7461 7274 5f64 7420 3d20 6461     start_dt = da
-0001d420: 7465 7469 6d65 2e63 6f6d 6269 6e65 2873  tetime.combine(s
-0001d430: 7461 7274 2c20 7469 6d65 2830 292c 2073  tart, time(0), s
-0001d440: 656c 662e 747a 290a 2020 2020 2020 2020  elf.tz).        
-0001d450: 2020 2020 2020 2020 2020 2020 6466 203d              df =
-0001d460: 2064 662e 6c6f 635b 7374 6172 745f 6474   df.loc[start_dt
-0001d470: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-0001d480: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-0001d490: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0001d4a0: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-0001d4b0: 6364 2e49 6e74 6572 7661 6c2e 5765 656b  cd.Interval.Week
-0001d4c0: 2061 6e64 2028 6466 2e69 6e64 6578 5b30   and (df.index[0
-0001d4d0: 5d2e 7765 656b 6461 7928 2920 213d 2030  ].weekday() != 0
-0001d4e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001d4f0: 2020 2023 2070 7269 6e74 2822 4461 7465     # print("Date
-0001d500: 2072 616e 6765 2072 6571 7565 7374 6564   range requested
-0001d510: 3a20 7b7d 202d 3e20 7b7d 222e 666f 726d  : {} -> {}".form
-0001d520: 6174 2866 6574 6368 5f73 7461 7274 2c20  at(fetch_start, 
-0001d530: 6665 7463 685f 656e 6429 290a 2020 2020  fetch_end)).    
-0001d540: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0001d550: 7428 6466 290a 2020 2020 2020 2020 2020  t(df).          
-0001d560: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
-0001d570: 7074 696f 6e28 2257 6565 6b6c 7920 6461  ption("Weekly da
-0001d580: 7461 2072 6574 7572 6e65 6420 6279 2059  ta returned by Y
-0001d590: 4620 646f 6573 6e27 7420 6265 6769 6e20  F doesn't begin 
-0001d5a0: 4d6f 6e64 6179 2062 7574 207b 7d22 2e66  Monday but {}".f
-0001d5b0: 6f72 6d61 7428 6466 2e69 6e64 6578 5b30  ormat(df.index[0
-0001d5c0: 5d2e 7765 656b 6461 7928 2929 290a 0a20  ].weekday())).. 
-0001d5d0: 2020 2020 2020 2069 6620 6466 2069 7320         if df is 
-0001d5e0: 6e6f 7420 4e6f 6e65 2061 6e64 2064 662e  not None and df.
-0001d5f0: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
-0001d600: 2020 2064 6620 3d20 4e6f 6e65 0a0a 2020     df = None..  
-0001d610: 2020 2020 2020 6966 2064 6620 6973 204e        if df is N
-0001d620: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001d630: 206c 6f67 5f6d 7367 203d 2022 504d 3a3a   log_msg = "PM::
-0001d640: 5f66 6574 6368 5966 4869 7374 6f72 795f  _fetchYfHistory_
-0001d650: 6461 7465 5261 6e67 6528 2920 7265 7475  dateRange() retu
-0001d660: 726e 696e 6720 4e6f 6e65 220a 2020 2020  rning None".    
-0001d670: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001d680: 2020 2020 2020 6c6f 675f 6d73 6720 3d20        log_msg = 
-0001d690: 6622 504d 3a3a 5f66 6574 6368 5966 4869  f"PM::_fetchYfHi
-0001d6a0: 7374 6f72 795f 6461 7465 5261 6e67 6528  story_dateRange(
-0001d6b0: 2920 7265 7475 726e 696e 6720 4446 207b  ) returning DF {
-0001d6c0: 6466 2e69 6e64 6578 5b30 5d7d 202d 3e20  df.index[0]} -> 
-0001d6d0: 7b64 662e 696e 6465 785b 2d31 5d7d 220a  {df.index[-1]}".
-0001d6e0: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
-0001d6f0: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
-0001d700: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001d710: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
-0001d720: 6f67 5f6d 7367 290a 2020 2020 2020 2020  og_msg).        
-0001d730: 656c 6966 2064 6562 7567 5f79 6663 3a0a  elif debug_yfc:.
-0001d740: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0001d750: 7428 6c6f 675f 6d73 6729 0a0a 2020 2020  t(log_msg)..    
-0001d760: 2020 2020 7265 7475 726e 2064 660a 0a20      return df.. 
-0001d770: 2020 2064 6566 205f 7265 636f 6e73 7472     def _reconstr
-0001d780: 7563 745f 696e 7465 7276 616c 735f 6261  uct_intervals_ba
-0001d790: 7463 6828 7365 6c66 2c20 6466 2c20 7461  tch(self, df, ta
-0001d7a0: 673d 2d31 293a 0a20 2020 2020 2020 2069  g=-1):.        i
-0001d7b0: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-0001d7c0: 2864 662c 2070 642e 4461 7461 4672 616d  (df, pd.DataFram
-0001d7d0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0001d7e0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
-0001d7f0: 2227 6466 2720 6d75 7374 2062 6520 6120  "'df' must be a 
-0001d800: 5061 6e64 6173 2044 6174 6146 7261 6d65  Pandas DataFrame
-0001d810: 206e 6f74 222c 2074 7970 6528 6466 2929   not", type(df))
-0001d820: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001d830: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-0001d840: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
-0001d850: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001d860: 7475 726e 2064 660a 0a20 2020 2020 2020  turn df..       
-0001d870: 2023 2052 6563 6f6e 7374 7275 6374 2076   # Reconstruct v
-0001d880: 616c 7565 7320 696e 2064 6620 7573 696e  alues in df usin
-0001d890: 6720 6669 6e65 722d 6772 6169 6e65 6420  g finer-grained 
-0001d8a0: 7072 6963 6520 6461 7461 2e20 4465 6c69  price data. Deli
-0001d8b0: 6d69 7465 7220 6d61 726b 7320 7768 6174  miter marks what
-0001d8c0: 2074 6f20 7265 636f 6e73 7472 7563 740a   to reconstruct.
-0001d8d0: 0a20 2020 2020 2020 2064 6562 7567 203d  .        debug =
-0001d8e0: 2046 616c 7365 0a20 2020 2020 2020 2023   False.        #
-0001d8f0: 2064 6562 7567 203d 2054 7275 650a 0a20   debug = True.. 
-0001d900: 2020 2020 2020 2070 7269 6365 5f63 6f6c         price_col
-0001d910: 7320 3d20 5b63 2066 6f72 2063 2069 6e20  s = [c for c in 
-0001d920: 5b22 4f70 656e 222c 2022 4869 6768 222c  ["Open", "High",
-0001d930: 2022 4c6f 7722 2c20 2243 6c6f 7365 222c   "Low", "Close",
-0001d940: 2022 4164 6a20 436c 6f73 6522 5d20 6966   "Adj Close"] if
-0001d950: 2063 2069 6e20 6466 5d0a 2020 2020 2020   c in df].      
-0001d960: 2020 6461 7461 5f63 6f6c 7320 3d20 7072    data_cols = pr
-0001d970: 6963 655f 636f 6c73 202b 205b 2256 6f6c  ice_cols + ["Vol
-0001d980: 756d 6522 5d0a 0a20 2020 2020 2020 206c  ume"]..        l
-0001d990: 6f67 5f6d 7367 203d 2066 2250 4d3a 3a5f  og_msg = f"PM::_
-0001d9a0: 7265 636f 6e73 7472 7563 745f 696e 7465  reconstruct_inte
-0001d9b0: 7276 616c 735f 6261 7463 682d 7b73 656c  rvals_batch-{sel
-0001d9c0: 662e 6973 7472 7d28 6474 303d 7b64 662e  f.istr}(dt0={df.
-0001d9d0: 696e 6465 785b 305d 7d29 220a 2020 2020  index[0]})".    
-0001d9e0: 2020 2020 7966 636c 2e54 7261 6365 456e      yfcl.TraceEn
-0001d9f0: 7465 7228 6c6f 675f 6d73 6729 0a0a 2020  ter(log_msg)..  
-0001da00: 2020 2020 2020 2320 4966 2069 6e74 6572        # If inter
-0001da10: 7661 6c20 6973 2077 6565 6b6c 7920 7468  val is weekly th
-0001da20: 656e 2063 616e 2063 6f6e 7374 7275 6374  en can construct
-0001da30: 2077 6974 6820 6461 696c 792e 2042 7574   with daily. But
-0001da40: 2069 6620 736d 616c 6c65 7220 696e 7465   if smaller inte
-0001da50: 7276 616c 7320 7468 656e 0a20 2020 2020  rvals then.     
-0001da60: 2020 2023 2072 6573 7472 6963 7465 6420     # restricted 
-0001da70: 746f 2072 6563 656e 7420 7469 6d65 733a  to recent times:
-0001da80: 0a20 2020 2020 2020 206d 696e 5f6c 6f6f  .        min_loo
-0001da90: 6b62 6163 6b20 3d20 4e6f 6e65 0a20 2020  kback = None.   
-0001daa0: 2020 2020 2023 202d 2064 6169 6c79 203d       # - daily =
-0001dab0: 2068 6f75 726c 7920 7265 7374 7269 6374   hourly restrict
-0001dac0: 6564 2074 6f20 6c61 7374 2037 3330 2064  ed to last 730 d
-0001dad0: 6179 730a 2020 2020 2020 2020 6966 2073  ays.        if s
-0001dae0: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-0001daf0: 7966 6364 2e49 6e74 6572 7661 6c2e 5765  yfcd.Interval.We
-0001db00: 656b 3a0a 2020 2020 2020 2020 2020 2020  ek:.            
-0001db10: 2320 436f 7272 6563 7420 6279 2066 6574  # Correct by fet
-0001db20: 6368 696e 6720 7765 656b 206f 6620 6461  ching week of da
-0001db30: 696c 7920 6461 7461 0a20 2020 2020 2020  ily data.       
-0001db40: 2020 2020 2073 7562 5f69 6e74 6572 7661       sub_interva
-0001db50: 6c20 3d20 7966 6364 2e49 6e74 6572 7661  l = yfcd.Interva
-0001db60: 6c2e 4461 7973 310a 2020 2020 2020 2020  l.Days1.        
-0001db70: 2020 2020 7464 5f72 616e 6765 203d 2074      td_range = t
-0001db80: 696d 6564 656c 7461 2864 6179 733d 3729  imedelta(days=7)
-0001db90: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-0001dba0: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-0001dbb0: 6663 642e 496e 7465 7276 616c 2e44 6179  fcd.Interval.Day
-0001dbc0: 7331 3a0a 2020 2020 2020 2020 2020 2020  s1:.            
-0001dbd0: 2320 436f 7272 6563 7420 6279 2066 6574  # Correct by fet
-0001dbe0: 6368 696e 6720 6461 7920 6f66 2068 6f75  ching day of hou
-0001dbf0: 726c 7920 6461 7461 0a20 2020 2020 2020  rly data.       
-0001dc00: 2020 2020 2073 7562 5f69 6e74 6572 7661       sub_interva
-0001dc10: 6c20 3d20 7966 6364 2e49 6e74 6572 7661  l = yfcd.Interva
-0001dc20: 6c2e 486f 7572 7331 0a20 2020 2020 2020  l.Hours1.       
-0001dc30: 2020 2020 2074 645f 7261 6e67 6520 3d20       td_range = 
-0001dc40: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
-0001dc50: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
-0001dc60: 6e5f 6c6f 6f6b 6261 636b 203d 2074 696d  n_lookback = tim
-0001dc70: 6564 656c 7461 2864 6179 733d 3733 3029  edelta(days=730)
-0001dc80: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-0001dc90: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
-0001dca0: 6663 642e 496e 7465 7276 616c 2e48 6f75  fcd.Interval.Hou
-0001dcb0: 7273 313a 0a20 2020 2020 2020 2020 2020  rs1:.           
-0001dcc0: 2023 2043 6f72 7265 6374 2062 7920 6665   # Correct by fe
-0001dcd0: 7463 6869 6e67 2068 6f75 7220 6f66 2033  tching hour of 3
-0001dce0: 306d 2064 6174 610a 2020 2020 2020 2020  0m data.        
-0001dcf0: 2020 2020 7375 625f 696e 7465 7276 616c      sub_interval
-0001dd00: 203d 2079 6663 642e 496e 7465 7276 616c   = yfcd.Interval
-0001dd10: 2e4d 696e 7333 300a 2020 2020 2020 2020  .Mins30.        
-0001dd20: 2020 2020 7464 5f72 616e 6765 203d 2074      td_range = t
-0001dd30: 696d 6564 656c 7461 2868 6f75 7273 3d31  imedelta(hours=1
-0001dd40: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
-0001dd50: 6e5f 6c6f 6f6b 6261 636b 203d 2074 696d  n_lookback = tim
-0001dd60: 6564 656c 7461 2864 6179 733d 3630 290a  edelta(days=60).
-0001dd70: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-0001dd80: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-0001dd90: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
-0001dda0: 3330 3a0a 2020 2020 2020 2020 2020 2020  30:.            
-0001ddb0: 2320 436f 7272 6563 7420 6279 2066 6574  # Correct by fet
-0001ddc0: 6368 696e 6720 686f 7572 206f 6620 3135  ching hour of 15
-0001ddd0: 6d20 6461 7461 0a20 2020 2020 2020 2020  m data.         
-0001dde0: 2020 2073 7562 5f69 6e74 6572 7661 6c20     sub_interval 
-0001ddf0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-0001de00: 4d69 6e73 3135 0a20 2020 2020 2020 2020  Mins15.         
-0001de10: 2020 2074 645f 7261 6e67 6520 3d20 7469     td_range = ti
-0001de20: 6d65 6465 6c74 6128 6d69 6e75 7465 733d  medelta(minutes=
-0001de30: 3330 290a 2020 2020 2020 2020 2020 2020  30).            
-0001de40: 6d69 6e5f 6c6f 6f6b 6261 636b 203d 2074  min_lookback = t
-0001de50: 696d 6564 656c 7461 2864 6179 733d 3630  imedelta(days=60
-0001de60: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-0001de70: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-0001de80: 7966 6364 2e49 6e74 6572 7661 6c2e 4d69  yfcd.Interval.Mi
-0001de90: 6e73 3135 3a0a 2020 2020 2020 2020 2020  ns15:.          
-0001dea0: 2020 2320 436f 7272 6563 7420 6279 2066    # Correct by f
-0001deb0: 6574 6368 696e 6720 686f 7572 206f 6620  etching hour of 
-0001dec0: 356d 2064 6174 610a 2020 2020 2020 2020  5m data.        
-0001ded0: 2020 2020 7375 625f 696e 7465 7276 616c      sub_interval
-0001dee0: 203d 2079 6663 642e 496e 7465 7276 616c   = yfcd.Interval
-0001def0: 2e4d 696e 7335 0a20 2020 2020 2020 2020  .Mins5.         
-0001df00: 2020 2074 645f 7261 6e67 6520 3d20 7469     td_range = ti
-0001df10: 6d65 6465 6c74 6128 6d69 6e75 7465 733d  medelta(minutes=
-0001df20: 3135 290a 2020 2020 2020 2020 2020 2020  15).            
-0001df30: 6d69 6e5f 6c6f 6f6b 6261 636b 203d 2074  min_lookback = t
-0001df40: 696d 6564 656c 7461 2864 6179 733d 3630  imedelta(days=60
-0001df50: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-0001df60: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-0001df70: 7966 6364 2e49 6e74 6572 7661 6c2e 4d69  yfcd.Interval.Mi
-0001df80: 6e73 353a 0a20 2020 2020 2020 2020 2020  ns5:.           
-0001df90: 2023 2043 6f72 7265 6374 2062 7920 6665   # Correct by fe
-0001dfa0: 7463 6869 6e67 2068 6f75 7220 6f66 2032  tching hour of 2
-0001dfb0: 6d20 6461 7461 0a20 2020 2020 2020 2020  m data.         
-0001dfc0: 2020 2073 7562 5f69 6e74 6572 7661 6c20     sub_interval 
-0001dfd0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-0001dfe0: 4d69 6e73 320a 2020 2020 2020 2020 2020  Mins2.          
-0001dff0: 2020 7464 5f72 616e 6765 203d 2074 696d    td_range = tim
-0001e000: 6564 656c 7461 286d 696e 7574 6573 3d35  edelta(minutes=5
-0001e010: 290a 2020 2020 2020 2020 2020 2020 6d69  ).            mi
-0001e020: 6e5f 6c6f 6f6b 6261 636b 203d 2074 696d  n_lookback = tim
-0001e030: 6564 656c 7461 2864 6179 733d 3630 290a  edelta(days=60).
-0001e040: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
-0001e050: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
-0001e060: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
-0001e070: 323a 0a20 2020 2020 2020 2020 2020 2023  2:.            #
-0001e080: 2043 6f72 7265 6374 2062 7920 6665 7463   Correct by fetc
-0001e090: 6869 6e67 2068 6f75 7220 6f66 2031 6d20  hing hour of 1m 
-0001e0a0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-0001e0b0: 2073 7562 5f69 6e74 6572 7661 6c20 3d20   sub_interval = 
-0001e0c0: 7966 6364 2e49 6e74 6572 7661 6c2e 4d69  yfcd.Interval.Mi
-0001e0d0: 6e73 310a 2020 2020 2020 2020 2020 2020  ns1.            
-0001e0e0: 7464 5f72 616e 6765 203d 2074 696d 6564  td_range = timed
-0001e0f0: 656c 7461 286d 696e 7574 6573 3d32 290a  elta(minutes=2).
-0001e100: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-0001e110: 6c6f 6f6b 6261 636b 203d 2074 696d 6564  lookback = timed
-0001e120: 656c 7461 2864 6179 733d 3330 290a 2020  elta(days=30).  
-0001e130: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001e140: 2020 2020 2020 2020 6d73 6720 3d20 6622          msg = f"
-0001e150: 5741 524e 494e 473a 2048 6176 6520 6e6f  WARNING: Have no
-0001e160: 7420 696d 706c 656d 656e 7465 6420 7265  t implemented re
-0001e170: 7061 6972 2066 6f72 2027 7b73 656c 662e  pair for '{self.
-0001e180: 696e 7465 7276 616c 7d27 2069 6e74 6572  interval}' inter
-0001e190: 7661 6c2e 2043 6f6e 7461 6374 2064 6576  val. Contact dev
-0001e1a0: 656c 6f70 6572 7322 0a20 2020 2020 2020  elopers".       
-0001e1b0: 2020 2020 2079 6663 6c2e 5472 6163 6550       yfcl.TraceP
-0001e1c0: 7269 6e74 286d 7367 2920 6966 2079 6663  rint(msg) if yfc
-0001e1d0: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
-0001e1e0: 6564 2829 2065 6c73 6520 7072 696e 7428  ed() else print(
-0001e1f0: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-0001e200: 206c 6f67 5f6d 7367 203d 2022 504d 3a3a   log_msg = "PM::
-0001e210: 5f72 6563 6f6e 7374 7275 6374 5f69 6e74  _reconstruct_int
-0001e220: 6572 7661 6c73 5f62 6174 6368 2829 2072  ervals_batch() r
-0001e230: 6574 7572 6e69 6e67 220a 2020 2020 2020  eturning".      
-0001e240: 2020 2020 2020 7966 636c 2e54 7261 6365        yfcl.Trace
-0001e250: 4578 6974 286c 6f67 5f6d 7367 290a 2020  Exit(log_msg).  
-0001e260: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001e270: 2064 660a 2020 2020 2020 2020 7375 625f   df.        sub_
-0001e280: 696e 7465 7264 6179 203d 2073 7562 5f69  interday = sub_i
-0001e290: 6e74 6572 7661 6c20 696e 205b 7966 6364  nterval in [yfcd
-0001e2a0: 2e49 6e74 6572 7661 6c2e 4461 7973 312c  .Interval.Days1,
-0001e2b0: 2079 6663 642e 496e 7465 7276 616c 2e57   yfcd.Interval.W
-0001e2c0: 6565 6b2c 2079 6663 642e 496e 7465 7276  eek, yfcd.Interv
-0001e2d0: 616c 2e4d 6f6e 7468 7331 2c20 7966 6364  al.Months1, yfcd
-0001e2e0: 2e49 6e74 6572 7661 6c2e 4d6f 6e74 6873  .Interval.Months
-0001e2f0: 335d 0a20 2020 2020 2020 2073 7562 5f69  3].        sub_i
-0001e300: 6e74 7261 6461 7920 3d20 6e6f 7420 7375  ntraday = not su
-0001e310: 625f 696e 7465 7264 6179 0a0a 2020 2020  b_interday..    
-0001e320: 2020 2020 6466 203d 2064 662e 736f 7274      df = df.sort
-0001e330: 5f69 6e64 6578 2829 0a0a 2020 2020 2020  _index()..      
-0001e340: 2020 665f 7265 7061 6972 203d 2064 665b    f_repair = df[
-0001e350: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-0001e360: 6d70 7928 2920 3d3d 2074 6167 0a20 2020  mpy() == tag.   
-0001e370: 2020 2020 2066 5f72 6570 6169 725f 726f       f_repair_ro
-0001e380: 7773 203d 2066 5f72 6570 6169 722e 616e  ws = f_repair.an
-0001e390: 7928 6178 6973 3d31 290a 0a20 2020 2020  y(axis=1)..     
-0001e3a0: 2020 2023 2049 676e 6f72 6520 6f6c 6420     # Ignore old 
-0001e3b0: 696e 7465 7276 616c 7320 666f 7220 7768  intervals for wh
-0001e3c0: 6963 6820 5961 686f 6f20 776f 6e27 7420  ich Yahoo won't 
-0001e3d0: 7265 7475 726e 2066 696e 6572 2064 6174  return finer dat
-0001e3e0: 613a 0a20 2020 2020 2020 2023 2069 6620  a:.        # if 
-0001e3f0: 7375 625f 696e 7465 7276 616c 203d 3d20  sub_interval == 
-0001e400: 7966 6364 2e49 6e74 6572 7661 6c2e 486f  yfcd.Interval.Ho
-0001e410: 7572 7331 3a0a 2020 2020 2020 2020 2320  urs1:.        # 
-0001e420: 2020 2020 665f 7265 6365 6e74 203d 2064      f_recent = d
-0001e430: 6174 652e 746f 6461 7928 2920 2d20 6466  ate.today() - df
-0001e440: 2e69 6e64 6578 2e64 6174 6520 3c20 7469  .index.date < ti
-0001e450: 6d65 6465 6c74 6128 6461 7973 3d37 3330  medelta(days=730
-0001e460: 290a 2020 2020 2020 2020 2320 2020 2020  ).        #     
-0001e470: 665f 7265 7061 6972 5f72 6f77 7320 3d20  f_repair_rows = 
-0001e480: 665f 7265 7061 6972 5f72 6f77 7320 2620  f_repair_rows & 
-0001e490: 665f 7265 6365 6e74 0a20 2020 2020 2020  f_recent.       
-0001e4a0: 2023 2065 6c69 6620 7375 625f 696e 7465   # elif sub_inte
-0001e4b0: 7276 616c 2069 6e20 5b79 6663 642e 496e  rval in [yfcd.In
-0001e4c0: 7465 7276 616c 2e4d 696e 7333 302c 2079  terval.Mins30, y
-0001e4d0: 6663 642e 496e 7465 7276 616c 2e4d 696e  fcd.Interval.Min
-0001e4e0: 7331 355d 3a0a 2020 2020 2020 2020 2320  s15]:.        # 
-0001e4f0: 2020 2020 665f 7265 6365 6e74 203d 2064      f_recent = d
-0001e500: 6174 652e 746f 6461 7928 2920 2d20 6466  ate.today() - df
-0001e510: 2e69 6e64 6578 2e64 6174 6520 3c20 7469  .index.date < ti
-0001e520: 6d65 6465 6c74 6128 6461 7973 3d36 3029  medelta(days=60)
-0001e530: 0a20 2020 2020 2020 2023 2020 2020 2066  .        #     f
-0001e540: 5f72 6570 6169 725f 726f 7773 203d 2066  _repair_rows = f
-0001e550: 5f72 6570 6169 725f 726f 7773 2026 2066  _repair_rows & f
-0001e560: 5f72 6563 656e 740a 2020 2020 2020 2020  _recent.        
-0001e570: 6966 206d 696e 5f6c 6f6f 6b62 6163 6b20  if min_lookback 
-0001e580: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0001e590: 2020 2020 206d 696e 5f64 7420 3d20 4e6f       min_dt = No
-0001e5a0: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
-0001e5b0: 0a20 2020 2020 2020 2020 2020 206d 696e  .            min
-0001e5c0: 5f64 7420 3d20 7064 2e54 696d 6573 7461  _dt = pd.Timesta
-0001e5d0: 6d70 2e75 7463 6e6f 7728 292e 747a 5f63  mp.utcnow().tz_c
-0001e5e0: 6f6e 7665 7274 285a 6f6e 6549 6e66 6f28  onvert(ZoneInfo(
-0001e5f0: 2255 5443 2229 2920 2d20 6d69 6e5f 6c6f  "UTC")) - min_lo
-0001e600: 6f6b 6261 636b 0a20 2020 2020 2020 2069  okback.        i
-0001e610: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-0001e620: 2020 2020 2070 7269 6e74 2866 222d 206d       print(f"- m
-0001e630: 696e 5f64 743d 7b6d 696e 5f64 747d 2069  in_dt={min_dt} i
-0001e640: 6e74 6572 7661 6c3d 7b73 656c 662e 696e  nterval={self.in
-0001e650: 7465 7276 616c 7d20 7375 625f 696e 7465  terval} sub_inte
-0001e660: 7276 616c 3d7b 7375 625f 696e 7465 7276  rval={sub_interv
-0001e670: 616c 7d22 290a 2020 2020 2020 2020 6966  al}").        if
-0001e680: 206d 696e 5f64 7420 6973 206e 6f74 204e   min_dt is not N
-0001e690: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001e6a0: 2066 5f72 6563 656e 7420 3d20 6466 2e69   f_recent = df.i
-0001e6b0: 6e64 6578 203e 206d 696e 5f64 740a 2020  ndex > min_dt.  
-0001e6c0: 2020 2020 2020 2020 2020 665f 7265 7061            f_repa
-0001e6d0: 6972 5f72 6f77 7320 3d20 665f 7265 7061  ir_rows = f_repa
-0001e6e0: 6972 5f72 6f77 7320 2620 665f 7265 6365  ir_rows & f_rece
-0001e6f0: 6e74 0a20 2020 2020 2020 2020 2020 2069  nt.            i
-0001e700: 6620 6e6f 7420 665f 7265 7061 6972 5f72  f not f_repair_r
-0001e710: 6f77 732e 616e 7928 293a 0a20 2020 2020  ows.any():.     
-0001e720: 2020 2020 2020 2020 2020 2069 6620 6465             if de
-0001e730: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
-0001e740: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-0001e750: 2d20 6461 7461 2074 6f6f 206f 6c64 2074  - data too old t
-0001e760: 6f20 7265 7061 6972 2229 0a20 2020 2020  o repair").     
-0001e770: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001e780: 6e20 6466 0a0a 2020 2020 2020 2020 6474  n df..        dt
-0001e790: 735f 746f 5f72 6570 6169 7220 3d20 6466  s_to_repair = df
-0001e7a0: 2e69 6e64 6578 5b66 5f72 6570 6169 725f  .index[f_repair_
-0001e7b0: 726f 7773 5d0a 2020 2020 2020 2020 2320  rows].        # 
-0001e7c0: 696e 6469 6365 735f 746f 5f72 6570 6169  indices_to_repai
-0001e7d0: 7220 3d20 6e70 2e77 6865 7265 2866 5f72  r = np.where(f_r
-0001e7e0: 6570 6169 725f 726f 7773 295b 305d 0a0a  epair_rows)[0]..
-0001e7f0: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
-0001e800: 7473 5f74 6f5f 7265 7061 6972 2920 3d3d  ts_to_repair) ==
-0001e810: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-0001e820: 7265 7475 726e 2064 660a 0a20 2020 2020  return df..     
-0001e830: 2020 2064 665f 7632 203d 2064 662e 636f     df_v2 = df.co
-0001e840: 7079 2829 0a20 2020 2020 2020 2064 665f  py().        df_
-0001e850: 676f 6f64 203d 2064 665b 7e64 665b 7072  good = df[~df[pr
-0001e860: 6963 655f 636f 6c73 5d2e 6973 6e61 2829  ice_cols].isna()
-0001e870: 2e61 6e79 2861 7869 733d 3129 5d0a 2020  .any(axis=1)].  
-0001e880: 2020 2020 2020 665f 7461 6720 3d20 6466        f_tag = df
-0001e890: 5f76 325b 7072 6963 655f 636f 6c73 5d2e  _v2[price_cols].
-0001e8a0: 746f 5f6e 756d 7079 2829 203d 3d20 7461  to_numpy() == ta
-0001e8b0: 670a 0a20 2020 2020 2020 2023 2047 726f  g..        # Gro
-0001e8c0: 7570 206e 6561 7262 7920 4e61 4e2d 696e  up nearby NaN-in
-0001e8d0: 7465 7276 616c 7320 746f 6765 7468 6572  tervals together
-0001e8e0: 2074 6f20 7265 6475 6365 206e 756d 6265   to reduce numbe
-0001e8f0: 7220 6f66 2059 6168 6f6f 2066 6574 6368  r of Yahoo fetch
-0001e900: 6573 0a20 2020 2020 2020 2064 7473 5f67  es.        dts_g
-0001e910: 726f 7570 7320 3d20 5b5b 6474 735f 746f  roups = [[dts_to
-0001e920: 5f72 6570 6169 725b 305d 5d5d 0a20 2020  _repair[0]]].   
-0001e930: 2020 2020 2023 206c 6173 745f 6474 203d       # last_dt =
-0001e940: 2064 7473 5f74 6f5f 7265 7061 6972 5b30   dts_to_repair[0
-0001e950: 5d0a 2020 2020 2020 2020 2320 6c61 7374  ].        # last
-0001e960: 5f69 6e64 203d 2069 6e64 6963 6573 5f74  _ind = indices_t
-0001e970: 6f5f 7265 7061 6972 5b30 5d0a 2020 2020  o_repair[0].    
-0001e980: 2020 2020 2320 7464 203d 2079 6663 642e      # td = yfcd.
-0001e990: 696e 7465 7276 616c 546f 5469 6d65 6465  intervalToTimede
-0001e9a0: 6c74 615b 7365 6c66 2e69 6e74 6572 7661  lta[self.interva
-0001e9b0: 6c5d 0a20 2020 2020 2020 2023 2069 6620  l].        # if 
-0001e9c0: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
-0001e9d0: 2079 6663 642e 496e 7465 7276 616c 2e4d   yfcd.Interval.M
-0001e9e0: 6f6e 7468 7331 3a0a 2020 2020 2020 2020  onths1:.        
-0001e9f0: 2320 2020 2020 6772 705f 7464 5f74 6872  #     grp_td_thr
-0001ea00: 6573 686f 6c64 203d 2074 696d 6564 656c  eshold = timedel
-0001ea10: 7461 2864 6179 733d 3238 290a 2020 2020  ta(days=28).    
-0001ea20: 2020 2020 2320 656c 6966 2073 656c 662e      # elif self.
-0001ea30: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-0001ea40: 2e49 6e74 6572 7661 6c2e 5765 656b 3a0a  .Interval.Week:.
-0001ea50: 2020 2020 2020 2020 2320 2020 2020 6772          #     gr
-0001ea60: 705f 7464 5f74 6872 6573 686f 6c64 203d  p_td_threshold =
-0001ea70: 2074 696d 6564 656c 7461 2864 6179 733d   timedelta(days=
-0001ea80: 3238 290a 2020 2020 2020 2020 2320 656c  28).        # el
-0001ea90: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
-0001eaa0: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
-0001eab0: 6c2e 4461 7973 313a 0a20 2020 2020 2020  l.Days1:.       
-0001eac0: 2023 2020 2020 2067 7270 5f74 645f 7468   #     grp_td_th
-0001ead0: 7265 7368 6f6c 6420 3d20 7469 6d65 6465  reshold = timede
-0001eae0: 6c74 6128 6461 7973 3d31 3429 0a20 2020  lta(days=14).   
-0001eaf0: 2020 2020 2023 2065 6c69 6620 7365 6c66       # elif self
-0001eb00: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-0001eb10: 642e 496e 7465 7276 616c 2e48 6f75 7273  d.Interval.Hours
-0001eb20: 313a 0a20 2020 2020 2020 2023 2020 2020  1:.        #    
-0001eb30: 2067 7270 5f74 645f 7468 7265 7368 6f6c   grp_td_threshol
-0001eb40: 6420 3d20 7469 6d65 6465 6c74 6128 6461  d = timedelta(da
-0001eb50: 7973 3d37 290a 2020 2020 2020 2020 2320  ys=7).        # 
-0001eb60: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-0001eb70: 2020 2020 6772 705f 7464 5f74 6872 6573      grp_td_thres
-0001eb80: 686f 6c64 203d 2074 696d 6564 656c 7461  hold = timedelta
-0001eb90: 2864 6179 733d 3229 0a20 2020 2020 2020  (days=2).       
-0001eba0: 2023 2020 2020 2023 2067 7270 5f74 645f   #     # grp_td_
-0001ebb0: 7468 7265 7368 6f6c 6420 3d20 7469 6d65  threshold = time
-0001ebc0: 6465 6c74 6128 6461 7973 3d37 290a 2020  delta(days=7).  
-0001ebd0: 2020 2020 2020 2320 666f 7220 6920 696e        # for i in
-0001ebe0: 2072 616e 6765 2831 2c20 6c65 6e28 6474   range(1, len(dt
-0001ebf0: 735f 746f 5f72 6570 6169 7229 293a 0a20  s_to_repair)):. 
-0001ec00: 2020 2020 2020 2023 2020 2020 2069 6e64         #     ind
-0001ec10: 203d 2069 6e64 6963 6573 5f74 6f5f 7265   = indices_to_re
-0001ec20: 7061 6972 5b69 5d0a 2020 2020 2020 2020  pair[i].        
-0001ec30: 2320 2020 2020 6474 203d 2064 7473 5f74  #     dt = dts_t
-0001ec40: 6f5f 7265 7061 6972 5b69 5d0a 2020 2020  o_repair[i].    
-0001ec50: 2020 2020 2320 2020 2020 6966 2028 6474      #     if (dt
-0001ec60: 2d64 7473 5f67 726f 7570 735b 2d31 5d5b  -dts_groups[-1][
-0001ec70: 2d31 5d29 203c 2067 7270 5f74 645f 7468  -1]) < grp_td_th
-0001ec80: 7265 7368 6f6c 643a 0a20 2020 2020 2020  reshold:.       
-0001ec90: 2023 2020 2020 2020 2020 2064 7473 5f67   #         dts_g
-0001eca0: 726f 7570 735b 2d31 5d2e 6170 7065 6e64  roups[-1].append
-0001ecb0: 2864 7429 0a20 2020 2020 2020 2023 2020  (dt).        #  
-0001ecc0: 2020 2065 6c69 6620 696e 6420 2d20 6c61     elif ind - la
-0001ecd0: 7374 5f69 6e64 203c 3d20 333a 0a20 2020  st_ind <= 3:.   
-0001ece0: 2020 2020 2023 2020 2020 2020 2020 2064       #         d
-0001ecf0: 7473 5f67 726f 7570 735b 2d31 5d2e 6170  ts_groups[-1].ap
-0001ed00: 7065 6e64 2864 7429 0a20 2020 2020 2020  pend(dt).       
-0001ed10: 2023 2020 2020 2065 6c73 653a 0a20 2020   #     else:.   
-0001ed20: 2020 2020 2023 2020 2020 2020 2020 2064       #         d
-0001ed30: 7473 5f67 726f 7570 732e 6170 7065 6e64  ts_groups.append
-0001ed40: 285b 6474 5d29 0a20 2020 2020 2020 2023  ([dt]).        #
-0001ed50: 2020 2020 206c 6173 745f 6474 203d 2064       last_dt = d
-0001ed60: 740a 2020 2020 2020 2020 2320 2020 2020  t.        #     
-0001ed70: 6c61 7374 5f69 6e64 203d 2069 6e64 0a20  last_ind = ind. 
-0001ed80: 2020 2020 2020 2023 2066 6f72 2069 2069         # for i i
-0001ed90: 6e20 7261 6e67 6528 312c 206c 656e 2864  n range(1, len(d
-0001eda0: 7473 5f74 6f5f 7265 7061 6972 2929 3a0a  ts_to_repair)):.
-0001edb0: 2020 2020 2020 2020 2320 2020 2020 696e          #     in
-0001edc0: 6420 3d20 696e 6469 6365 735f 746f 5f72  d = indices_to_r
-0001edd0: 6570 6169 725b 695d 0a20 2020 2020 2020  epair[i].       
-0001ede0: 2023 2020 2020 2064 7420 3d20 6474 735f   #     dt = dts_
-0001edf0: 746f 5f72 6570 6169 725b 695d 0a20 2020  to_repair[i].   
-0001ee00: 2020 2020 2023 2020 2020 2069 6620 2864       #     if (d
-0001ee10: 742d 6474 735f 6772 6f75 7073 5b2d 315d  t-dts_groups[-1]
-0001ee20: 5b2d 315d 2920 3c20 6772 705f 7464 5f74  [-1]) < grp_td_t
-0001ee30: 6872 6573 686f 6c64 3a0a 2020 2020 2020  hreshold:.      
-0001ee40: 2020 2320 2020 2020 2020 2020 6474 735f    #         dts_
-0001ee50: 6772 6f75 7073 5b2d 315d 2e61 7070 656e  groups[-1].appen
-0001ee60: 6428 6474 290a 2020 2020 2020 2020 2320  d(dt).        # 
-0001ee70: 2020 2020 656c 6966 2069 6e64 202d 206c      elif ind - l
-0001ee80: 6173 745f 696e 6420 3c3d 2033 3a0a 2020  ast_ind <= 3:.  
-0001ee90: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0001eea0: 6474 735f 6772 6f75 7073 5b2d 315d 2e61  dts_groups[-1].a
-0001eeb0: 7070 656e 6428 6474 290a 2020 2020 2020  ppend(dt).      
-0001eec0: 2020 2320 2020 2020 656c 7365 3a0a 2020    #     else:.  
-0001eed0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0001eee0: 6474 735f 6772 6f75 7073 2e61 7070 656e  dts_groups.appen
-0001eef0: 6428 5b64 745d 290a 2020 2020 2020 2020  d([dt]).        
-0001ef00: 2320 2020 2020 6c61 7374 5f64 7420 3d20  #     last_dt = 
-0001ef10: 6474 0a20 2020 2020 2020 2023 2020 2020  dt.        #    
-0001ef20: 206c 6173 745f 696e 6420 3d20 696e 640a   last_ind = ind.
-0001ef30: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001ef40: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
-0001ef50: 2e49 6e74 6572 7661 6c2e 4d6f 6e74 6873  .Interval.Months
-0001ef60: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
-0001ef70: 7270 5f6d 6178 5f73 697a 6520 3d20 6461  rp_max_size = da
-0001ef80: 7465 7574 696c 2e72 656c 6174 6976 6564  teutil.relatived
-0001ef90: 656c 7461 2e72 656c 6174 6976 6564 656c  elta.relativedel
-0001efa0: 7461 2879 6561 7273 3d32 290a 2020 2020  ta(years=2).    
-0001efb0: 2020 2020 656c 6966 2073 656c 662e 696e      elif self.in
-0001efc0: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
-0001efd0: 6e74 6572 7661 6c2e 5765 656b 3a0a 2020  nterval.Week:.  
-0001efe0: 2020 2020 2020 2020 2020 6772 705f 6d61            grp_ma
-0001eff0: 785f 7369 7a65 203d 2064 6174 6575 7469  x_size = dateuti
-0001f000: 6c2e 7265 6c61 7469 7665 6465 6c74 612e  l.relativedelta.
-0001f010: 7265 6c61 7469 7665 6465 6c74 6128 7965  relativedelta(ye
-0001f020: 6172 733d 3229 0a20 2020 2020 2020 2065  ars=2).        e
-0001f030: 6c69 6620 7365 6c66 2e69 6e74 6572 7661  lif self.interva
-0001f040: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
-0001f050: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
-0001f060: 2020 2020 2020 6772 705f 6d61 785f 7369        grp_max_si
-0001f070: 7a65 203d 2064 6174 6575 7469 6c2e 7265  ze = dateutil.re
-0001f080: 6c61 7469 7665 6465 6c74 612e 7265 6c61  lativedelta.rela
-0001f090: 7469 7665 6465 6c74 6128 7965 6172 733d  tivedelta(years=
-0001f0a0: 3229 0a20 2020 2020 2020 2065 6c69 6620  2).        elif 
-0001f0b0: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
-0001f0c0: 2079 6663 642e 496e 7465 7276 616c 2e48   yfcd.Interval.H
-0001f0d0: 6f75 7273 313a 0a20 2020 2020 2020 2020  ours1:.         
-0001f0e0: 2020 2067 7270 5f6d 6178 5f73 697a 6520     grp_max_size 
-0001f0f0: 3d20 6461 7465 7574 696c 2e72 656c 6174  = dateutil.relat
-0001f100: 6976 6564 656c 7461 2e72 656c 6174 6976  ivedelta.relativ
-0001f110: 6564 656c 7461 2879 6561 7273 3d31 290a  edelta(years=1).
-0001f120: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001f130: 2020 2020 2020 2020 2020 6772 705f 6d61            grp_ma
-0001f140: 785f 7369 7a65 203d 2074 696d 6564 656c  x_size = timedel
-0001f150: 7461 2864 6179 733d 3330 290a 2020 2020  ta(days=30).    
-0001f160: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
-0001f170: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0001f180: 222d 2067 7270 5f6d 6178 5f73 697a 6520  "- grp_max_size 
-0001f190: 3d22 2c20 6772 705f 6d61 785f 7369 7a65  =", grp_max_size
-0001f1a0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
-0001f1b0: 696e 2072 616e 6765 2831 2c20 6c65 6e28  in range(1, len(
-0001f1c0: 6474 735f 746f 5f72 6570 6169 7229 293a  dts_to_repair)):
-0001f1d0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-0001f1e0: 6e64 203d 2069 6e64 6963 6573 5f74 6f5f  nd = indices_to_
-0001f1f0: 7265 7061 6972 5b69 5d0a 2020 2020 2020  repair[i].      
-0001f200: 2020 2020 2020 6474 203d 2064 7473 5f74        dt = dts_t
-0001f210: 6f5f 7265 7061 6972 5b69 5d0a 2020 2020  o_repair[i].    
-0001f220: 2020 2020 2020 2020 6966 2064 742e 6461          if dt.da
-0001f230: 7465 2829 203c 2064 7473 5f67 726f 7570  te() < dts_group
-0001f240: 735b 2d31 5d5b 305d 2e64 6174 6528 292b  s[-1][0].date()+
-0001f250: 6772 705f 6d61 785f 7369 7a65 3a0a 2020  grp_max_size:.  
-0001f260: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-0001f270: 735f 6772 6f75 7073 5b2d 315d 2e61 7070  s_groups[-1].app
-0001f280: 656e 6428 6474 290a 2020 2020 2020 2020  end(dt).        
-0001f290: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001f2a0: 2020 2020 2020 2020 2020 6474 735f 6772            dts_gr
-0001f2b0: 6f75 7073 2e61 7070 656e 6428 5b64 745d  oups.append([dt]
-0001f2c0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0001f2d0: 6c61 7374 5f64 7420 3d20 6474 0a20 2020  last_dt = dt.   
-0001f2e0: 2020 2020 2020 2020 2023 206c 6173 745f           # last_
-0001f2f0: 696e 6420 3d20 696e 640a 0a20 2020 2020  ind = ind..     
-0001f300: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
-0001f310: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-0001f320: 5265 7061 6972 2067 726f 7570 733a 2229  Repair groups:")
-0001f330: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001f340: 2067 2069 6e20 6474 735f 6772 6f75 7073   g in dts_groups
-0001f350: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f360: 2020 7072 696e 7428 6622 2d20 7b67 5b30    print(f"- {g[0
-0001f370: 5d7d 202d 3e20 7b67 5b2d 315d 7d22 290a  ]} -> {g[-1]}").
-0001f380: 0a20 2020 2020 2020 2023 2041 6464 2073  .        # Add s
-0001f390: 6f6d 6520 676f 6f64 2064 6174 6120 746f  ome good data to
-0001f3a0: 2065 6163 6820 6772 6f75 702c 2073 6f20   each group, so 
-0001f3b0: 6361 6e20 6361 6c69 6272 6174 6520 6c61  can calibrate la
-0001f3c0: 7465 723a 0a20 2020 2020 2020 2023 2066  ter:.        # f
-0001f3d0: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-0001f3e0: 6e28 6474 735f 6772 6f75 7073 2929 3a0a  n(dts_groups)):.
-0001f3f0: 2020 2020 2020 2020 2320 2020 2020 6720          #     g 
-0001f400: 3d20 6474 735f 6772 6f75 7073 5b69 5d0a  = dts_groups[i].
-0001f410: 2020 2020 2020 2020 2320 2020 2020 6730          #     g0
-0001f420: 203d 2067 5b30 5d0a 2020 2020 2020 2020   = g[0].        
-0001f430: 2320 2020 2020 6930 203d 2064 665f 676f  #     i0 = df_go
-0001f440: 6f64 2e69 6e64 6578 2e67 6574 5f6c 6f63  od.index.get_loc
-0001f450: 2867 3029 0a20 2020 2020 2020 2023 2020  (g0).        #  
-0001f460: 2020 2069 6620 6930 203e 2030 3a0a 2020     if i0 > 0:.  
-0001f470: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0001f480: 6474 735f 6772 6f75 7073 5b69 5d2e 696e  dts_groups[i].in
-0001f490: 7365 7274 2830 2c20 6466 5f67 6f6f 642e  sert(0, df_good.
-0001f4a0: 696e 6465 785b 6930 2d31 5d29 0a20 2020  index[i0-1]).   
-0001f4b0: 2020 2020 2023 2020 2020 2067 6c20 3d20       #     gl = 
-0001f4c0: 675b 2d31 5d0a 2020 2020 2020 2020 2320  g[-1].        # 
-0001f4d0: 2020 2020 696c 203d 2064 665f 676f 6f64      il = df_good
-0001f4e0: 2e69 6e64 6578 2e67 6574 5f6c 6f63 2867  .index.get_loc(g
-0001f4f0: 6c29 0a20 2020 2020 2020 2023 2020 2020  l).        #    
-0001f500: 2069 6620 696c 203c 206c 656e 2864 665f   if il < len(df_
-0001f510: 676f 6f64 292d 313a 0a20 2020 2020 2020  good)-1:.       
-0001f520: 2023 2020 2020 2020 2020 2064 7473 5f67   #         dts_g
-0001f530: 726f 7570 735b 695d 2e61 7070 656e 6428  roups[i].append(
-0001f540: 6466 5f67 6f6f 642e 696e 6465 785b 696c  df_good.index[il
-0001f550: 2b31 5d29 0a20 2020 2020 2020 2066 6f72  +1]).        for
-0001f560: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-0001f570: 6474 735f 6772 6f75 7073 2929 3a0a 2020  dts_groups)):.  
-0001f580: 2020 2020 2020 2020 2020 6720 3d20 6474            g = dt
-0001f590: 735f 6772 6f75 7073 5b69 5d0a 2020 2020  s_groups[i].    
-0001f5a0: 2020 2020 2020 2020 6730 203d 2067 5b30          g0 = g[0
-0001f5b0: 5d0a 2020 2020 2020 2020 2020 2020 6930  ].            i0
-0001f5c0: 203d 2064 665f 676f 6f64 2e69 6e64 6578   = df_good.index
-0001f5d0: 2e67 6574 5f69 6e64 6578 6572 285b 6730  .get_indexer([g0
-0001f5e0: 5d2c 206d 6574 686f 643d 226e 6561 7265  ], method="neare
-0001f5f0: 7374 2229 5b30 5d0a 2020 2020 2020 2020  st")[0].        
-0001f600: 2020 2020 6966 2069 3020 3e20 303a 0a20      if i0 > 0:. 
-0001f610: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001f620: 6620 286d 696e 5f64 7420 6973 204e 6f6e  f (min_dt is Non
-0001f630: 6520 6f72 2064 665f 676f 6f64 2e69 6e64  e or df_good.ind
-0001f640: 6578 5b69 302d 315d 203e 3d20 6d69 6e5f  ex[i0-1] >= min_
-0001f650: 6474 2920 5c0a 2020 2020 2020 2020 2020  dt) \.          
-0001f660: 2020 2020 2020 2020 2020 616e 6420 2828            and ((
-0001f670: 6e6f 7420 7365 6c66 2e69 6e74 7261 6461  not self.intrada
-0001f680: 7929 206f 7220 6466 5f67 6f6f 642e 696e  y) or df_good.in
-0001f690: 6465 785b 6930 2d31 5d2e 6461 7465 2829  dex[i0-1].date()
-0001f6a0: 203d 3d20 6730 2e64 6174 6528 2929 3a0a   == g0.date()):.
-0001f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f6c0: 2020 2020 6930 202d 3d20 310a 2020 2020      i0 -= 1.    
-0001f6d0: 2020 2020 2020 2020 676c 203d 2067 5b2d          gl = g[-
-0001f6e0: 315d 0a20 2020 2020 2020 2020 2020 2069  1].            i
-0001f6f0: 6c20 3d20 6466 5f67 6f6f 642e 696e 6465  l = df_good.inde
-0001f700: 782e 6765 745f 696e 6465 7865 7228 5b67  x.get_indexer([g
-0001f710: 6c5d 2c20 6d65 7468 6f64 3d22 6e65 6172  l], method="near
-0001f720: 6573 7422 295b 305d 0a20 2020 2020 2020  est")[0].       
-0001f730: 2020 2020 2069 6620 696c 203c 206c 656e       if il < len
-0001f740: 2864 665f 676f 6f64 292d 313a 0a20 2020  (df_good)-1:.   
-0001f750: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001f760: 286e 6f74 2073 656c 662e 696e 7472 6164  (not self.intrad
-0001f770: 6179 2920 6f72 2064 665f 676f 6f64 2e69  ay) or df_good.i
-0001f780: 6e64 6578 5b69 6c2b 315d 2e64 6174 6528  ndex[il+1].date(
-0001f790: 2920 3d3d 2067 6c2e 6461 7465 2829 3a0a  ) == gl.date():.
-0001f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7b0: 2020 2020 696c 202b 3d20 310a 2020 2020      il += 1.    
-0001f7c0: 2020 2020 2020 2020 676f 6f64 5f64 7473          good_dts
-0001f7d0: 203d 2064 665f 676f 6f64 2e69 6e64 6578   = df_good.index
-0001f7e0: 5b69 303a 696c 2b31 5d0a 2020 2020 2020  [i0:il+1].      
-0001f7f0: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
-0001f800: 5b69 5d20 2b3d 2067 6f6f 645f 6474 732e  [i] += good_dts.
-0001f810: 746f 5f6c 6973 7428 290a 2020 2020 2020  to_list().      
-0001f820: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
-0001f830: 5b69 5d2e 736f 7274 2829 0a0a 2020 2020  [i].sort()..    
-0001f840: 2020 2020 6e5f 6669 7865 6420 3d20 300a      n_fixed = 0.
-0001f850: 2020 2020 2020 2020 666f 7220 6720 696e          for g in
-0001f860: 2064 7473 5f67 726f 7570 733a 0a20 2020   dts_groups:.   
-0001f870: 2020 2020 2020 2020 2064 665f 626c 6f63           df_bloc
-0001f880: 6b20 3d20 6466 5b64 662e 696e 6465 782e  k = df[df.index.
-0001f890: 6973 696e 2867 295d 0a0a 2020 2020 2020  isin(g)]..      
-0001f8a0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
-0001f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8c0: 7072 696e 7428 2264 665f 626c 6f63 6b3a  print("df_block:
-0001f8d0: 2229 203b 2070 7269 6e74 2864 665f 626c  ") ; print(df_bl
-0001f8e0: 6f63 6b29 0a0a 2020 2020 2020 2020 2020  ock)..          
-0001f8f0: 2020 7374 6172 745f 6474 203d 2067 5b30    start_dt = g[0
-0001f900: 5d0a 2020 2020 2020 2020 2020 2020 7374  ].            st
-0001f910: 6172 745f 6420 3d20 7374 6172 745f 6474  art_d = start_dt
-0001f920: 2e64 6174 6528 290a 0a20 2020 2020 2020  .date()..       
-0001f930: 2020 2020 2069 6620 7375 625f 696e 7465       if sub_inte
-0001f940: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-0001f950: 6572 7661 6c2e 486f 7572 7331 2061 6e64  erval.Hours1 and
-0001f960: 2028 6461 7465 2e74 6f64 6179 2829 2d73   (date.today()-s
-0001f970: 7461 7274 5f64 2920 3e20 7469 6d65 6465  tart_d) > timede
-0001f980: 6c74 6128 6461 7973 3d37 3239 293a 0a20  lta(days=729):. 
-0001f990: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001f9a0: 2044 6f6e 2774 2062 6f74 6865 7220 7265   Don't bother re
-0001f9b0: 7175 6573 7469 6e67 206d 6f72 6520 7072  questing more pr
-0001f9c0: 6963 6520 6461 7461 2c20 5961 686f 6f20  ice data, Yahoo 
-0001f9d0: 7769 6c6c 2072 656a 6563 740a 2020 2020  will reject.    
-0001f9e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001f9f0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-0001fa00: 2065 6c69 6620 7375 625f 696e 7465 7276   elif sub_interv
-0001fa10: 616c 2069 6e20 5b79 6663 642e 496e 7465  al in [yfcd.Inte
-0001fa20: 7276 616c 2e4d 696e 7333 302c 2079 6663  rval.Mins30, yfc
-0001fa30: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
-0001fa40: 355d 2061 6e64 2028 6461 7465 2e74 6f64  5] and (date.tod
-0001fa50: 6179 2829 2d73 7461 7274 5f64 2920 3e20  ay()-start_d) > 
-0001fa60: 7469 6d65 6465 6c74 6128 6461 7973 3d35  timedelta(days=5
-0001fa70: 3929 3a0a 2020 2020 2020 2020 2020 2020  9):.            
-0001fa80: 2020 2020 2320 446f 6e27 7420 626f 7468      # Don't both
-0001fa90: 6572 2072 6571 7565 7374 696e 6720 6d6f  er requesting mo
-0001faa0: 7265 2070 7269 6365 2064 6174 612c 2059  re price data, Y
-0001fab0: 6168 6f6f 2077 696c 6c20 7265 6a65 6374  ahoo will reject
-0001fac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fad0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0001fae0: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-0001faf0: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
-0001fb00: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-0001fb10: 2020 2020 2320 4c6f 6720 6675 6e63 7469      # Log functi
-0001fb20: 6f6e 2063 616c 6c73 2074 6f20 6465 7465  on calls to dete
-0001fb30: 6374 2061 6e64 206d 616e 6167 6520 696e  ct and manage in
-0001fb40: 6669 6e69 7465 2072 6563 7572 7369 6f6e  finite recursion
-0001fb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fb60: 2066 6e5f 7475 706c 6520 3d20 2822 5f72   fn_tuple = ("_r
-0001fb70: 6563 6f6e 7374 7275 6374 5f69 6e74 6572  econstruct_inter
-0001fb80: 7661 6c73 5f62 6174 6368 2829 222c 2066  vals_batch()", f
-0001fb90: 2264 7430 3d7b 6466 2e69 6e64 6578 5b30  "dt0={df.index[0
-0001fba0: 5d7d 222c 2066 2269 6e74 6572 7661 6c3d  ]}", f"interval=
-0001fbb0: 7b73 656c 662e 696e 7465 7276 616c 7d22  {self.interval}"
-0001fbc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001fbd0: 2020 6966 2066 6e5f 7475 706c 6520 696e    if fn_tuple in
-0001fbe0: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
-0001fbf0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
-0001fc00: 2020 2020 2020 2020 2320 4465 7465 6374          # Detect
-0001fc10: 6564 2061 2070 6f74 656e 7469 616c 2072  ed a potential r
-0001fc20: 6563 7572 7369 6f6e 206c 6f6f 700a 2020  ecursion loop.  
-0001fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc40: 2020 7265 636f 6e73 7472 7563 745f 6465    reconstruct_de
-0001fc50: 7465 6374 6564 203d 2046 616c 7365 0a20  tected = False. 
-0001fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc70: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0001fc80: 6528 6c65 6e28 7365 6c66 2e5f 7374 6163  e(len(self._stac
-0001fc90: 6b5f 7472 6163 6529 2d31 2c20 2d31 2c20  k_trace)-1, -1, 
-0001fca0: 2d31 293a 0a20 2020 2020 2020 2020 2020  -1):.           
-0001fcb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001fcc0: 225f 7265 636f 6e73 7472 7563 745f 696e  "_reconstruct_in
-0001fcd0: 7465 7276 616c 735f 6261 7463 6822 2069  tervals_batch" i
-0001fce0: 6e20 7374 7228 7365 6c66 2e5f 7374 6163  n str(self._stac
-0001fcf0: 6b5f 7472 6163 655b 695d 293a 0a20 2020  k_trace[i]):.   
+0001c690: 2020 2270 726f 7879 223a 2073 656c 662e    "proxy": self.
+0001c6a0: 7072 6f78 792c 0a20 2020 2020 2020 2020  proxy,.         
+0001c6b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c6c0: 726f 756e 6469 6e67 223a 2046 616c 7365  rounding": False
+0001c6d0: 2c20 2023 2073 746f 7265 2072 6177 2064  ,  # store raw d
+0001c6e0: 6174 612c 2072 6f75 6e64 206d 7973 656c  ata, round mysel
+0001c6f0: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
+0001c700: 2020 2020 2020 2020 2020 2272 6169 7365            "raise
+0001c710: 5f65 7272 6f72 7322 3a20 5472 7565 7d0a  _errors": True}.
+0001c720: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+0001c730: 3a0a 2020 2020 2020 2020 2020 2020 7966  :.            yf
+0001c740: 5f6c 6f67 6765 7220 3d20 6c6f 6767 696e  _logger = loggin
+0001c750: 672e 6765 744c 6f67 6765 7228 2779 6669  g.getLogger('yfi
+0001c760: 6e61 6e63 6527 290a 2020 2020 2020 2020  nance').        
+0001c770: 2020 2020 7966 5f6c 6f67 6765 722e 7365      yf_logger.se
+0001c780: 744c 6576 656c 286c 6f67 6769 6e67 2e44  tLevel(logging.D
+0001c790: 4542 5547 2920 2023 2076 6572 626f 7365  EBUG)  # verbose
+0001c7a0: 3a20 7072 696e 7420 6572 726f 7273 2026  : print errors &
+0001c7b0: 2064 6562 7567 2069 6e66 6f0a 0a20 2020   debug info..   
+0001c7c0: 2020 2020 2069 6620 6465 6275 675f 7966       if debug_yf
+0001c7d0: 633a 0a20 2020 2020 2020 2020 2020 2069  c:.            i
+0001c7e0: 6620 286e 6f74 2069 7369 6e73 7461 6e63  f (not isinstanc
+0001c7f0: 6528 6665 7463 685f 7374 6172 742c 2064  e(fetch_start, d
+0001c800: 6174 6574 696d 6529 2920 6f72 2066 6574  atetime)) or fet
+0001c810: 6368 5f73 7461 7274 2e74 696d 6528 2920  ch_start.time() 
+0001c820: 3d3d 2074 696d 6528 3029 3a0a 2020 2020  == time(0):.    
+0001c830: 2020 2020 2020 2020 2020 2020 7374 6172              star
+0001c840: 745f 7374 7220 3d20 6665 7463 685f 7374  t_str = fetch_st
+0001c850: 6172 742e 7374 7266 7469 6d65 2822 2559  art.strftime("%Y
+0001c860: 2d25 6d2d 2564 2229 0a20 2020 2020 2020  -%m-%d").       
+0001c870: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001c880: 2020 2020 2020 2020 2020 2073 7461 7274             start
+0001c890: 5f73 7472 203d 2066 6574 6368 5f73 7461  _str = fetch_sta
+0001c8a0: 7274 2e73 7472 6674 696d 6528 2225 592d  rt.strftime("%Y-
+0001c8b0: 256d 2d25 6420 2548 3a25 4d3a 2553 2229  %m-%d %H:%M:%S")
+0001c8c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c8d0: 286e 6f74 2069 7369 6e73 7461 6e63 6528  (not isinstance(
+0001c8e0: 6665 7463 685f 656e 642c 2064 6174 6574  fetch_end, datet
+0001c8f0: 696d 6529 2920 6f72 2066 6574 6368 5f65  ime)) or fetch_e
+0001c900: 6e64 2e74 696d 6528 2920 3d3d 2074 696d  nd.time() == tim
+0001c910: 6528 3029 3a0a 2020 2020 2020 2020 2020  e(0):.          
+0001c920: 2020 2020 2020 656e 645f 7374 7220 3d20        end_str = 
+0001c930: 6665 7463 685f 656e 642e 7374 7266 7469  fetch_end.strfti
+0001c940: 6d65 2822 2559 2d25 6d2d 2564 2229 0a20  me("%Y-%m-%d"). 
+0001c950: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001c960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c970: 2065 6e64 5f73 7472 203d 2066 6574 6368   end_str = fetch
+0001c980: 5f65 6e64 2e73 7472 6674 696d 6528 2225  _end.strftime("%
+0001c990: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
+0001c9a0: 2229 0a20 2020 2020 2020 2020 2020 206d  ").            m
+0001c9b0: 7367 203d 2066 222d 207b 7365 6c66 2e74  sg = f"- {self.t
+0001c9c0: 6963 6b65 727d 3a20 6665 7463 6869 6e67  icker}: fetching
+0001c9d0: 207b 7365 6c66 2e69 7374 727d 207b 7374   {self.istr} {st
+0001c9e0: 6172 745f 7374 727d 202d 3e20 7b65 6e64  art_str} -> {end
+0001c9f0: 5f73 7472 7d22 0a20 2020 2020 2020 2020  _str}".         
+0001ca00: 2020 2079 6663 6c2e 5472 6163 6550 7269     yfcl.TracePri
+0001ca10: 6e74 286d 7367 2920 6966 2079 6663 6c2e  nt(msg) if yfcl.
+0001ca20: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+0001ca30: 2829 2065 6c73 6520 7072 696e 7428 6d73  () else print(ms
+0001ca40: 6729 0a0a 2020 2020 2020 2020 6669 7273  g)..        firs
+0001ca50: 745f 6665 7463 685f 6661 696c 6564 203d  t_fetch_failed =
+0001ca60: 2046 616c 7365 0a20 2020 2020 2020 2064   False.        d
+0001ca70: 6620 3d20 4e6f 6e65 0a20 2020 2020 2020  f = None.       
+0001ca80: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001ca90: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+0001caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cab0: 6d73 6720 3d20 6622 2d20 6665 7463 685f  msg = f"- fetch_
+0001cac0: 7374 6172 743d 7b66 6574 6368 5f73 7461  start={fetch_sta
+0001cad0: 7274 7d20 3b20 6665 7463 685f 656e 643d  rt} ; fetch_end=
+0001cae0: 7b66 6574 6368 5f65 6e64 7d22 0a20 2020  {fetch_end}".   
+0001caf0: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+0001cb00: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+0001cb10: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+0001cb20: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+0001cb30: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
+0001cb40: 2020 2020 2020 2020 2064 6620 3d20 7365           df = se
+0001cb50: 6c66 2e64 6174 2e68 6973 746f 7279 282a  lf.dat.history(*
+0001cb60: 2a68 6973 746f 7279 5f61 7267 7329 0a20  *history_args). 
+0001cb70: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
+0001cb80: 6466 2e73 6f72 745f 696e 6465 7828 290a  df.sort_index().
+0001cb90: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0001cba0: 6f74 2022 5265 7061 6972 6564 3f22 2069  ot "Repaired?" i
+0001cbb0: 6e20 6466 2e63 6f6c 756d 6e73 3a0a 2020  n df.columns:.  
+0001cbc0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+0001cbd0: 5b22 5265 7061 6972 6564 3f22 5d20 3d20  ["Repaired?"] = 
+0001cbe0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0001cbf0: 2020 6966 2064 6562 7567 5f79 6663 3a0a    if debug_yfc:.
+0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc10: 6966 2064 6620 6973 204e 6f6e 653a 0a20  if df is None:. 
+0001cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc30: 2020 206d 7367 203d 2022 2d20 5946 2072     msg = "- YF r
+0001cc40: 6574 7572 6e65 6420 4e6f 6e65 220a 2020  eturned None".  
+0001cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc60: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
+0001cc70: 7428 6d73 6729 2069 6620 7966 636c 2e49  t(msg) if yfcl.I
+0001cc80: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+0001cc90: 2920 656c 7365 2070 7269 6e74 286d 7367  ) else print(msg
+0001cca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001ccb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ccc0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+0001ccd0: 3d20 222d 2059 4620 7265 7475 726e 6564  = "- YF returned
+0001cce0: 2074 6162 6c65 3a22 0a20 2020 2020 2020   table:".       
+0001ccf0: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
+0001cd00: 6c2e 5472 6163 6550 7269 6e74 286d 7367  l.TracePrint(msg
+0001cd10: 2920 6966 2079 6663 6c2e 4973 5472 6163  ) if yfcl.IsTrac
+0001cd20: 696e 6745 6e61 626c 6564 2829 2065 6c73  ingEnabled() els
+0001cd30: 6520 7072 696e 7428 6d73 6729 0a20 2020  e print(msg).   
+0001cd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd50: 2070 7269 6e74 2864 665b 5b63 2066 6f72   print(df[[c for
+0001cd60: 2063 2069 6e20 5b22 4f70 656e 222c 2022   c in ["Open", "
+0001cd70: 4c6f 7722 2c20 2248 6967 6822 2c20 2243  Low", "High", "C
+0001cd80: 6c6f 7365 222c 2022 4469 7669 6465 6e64  lose", "Dividend
+0001cd90: 7322 2c20 2256 6f6c 756d 6522 5d20 6966  s", "Volume"] if
+0001cda0: 2063 2069 6e20 6466 2e63 6f6c 756d 6e73   c in df.columns
+0001cdb0: 5d5d 290a 2020 2020 2020 2020 2020 2020  ]]).            
+0001cdc0: 6966 2064 6620 6973 204e 6f6e 6520 6f72  if df is None or
+0001cdd0: 2064 662e 656d 7074 793a 0a20 2020 2020   df.empty:.     
+0001cde0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001cdf0: 2045 7863 6570 7469 6f6e 2822 4e6f 2064   Exception("No d
+0001ce00: 6174 6120 666f 756e 6420 666f 7220 7468  ata found for th
+0001ce10: 6973 2064 6174 6520 7261 6e67 6522 290a  is date range").
+0001ce20: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0001ce30: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+0001ce40: 2020 2020 2020 2020 2020 2066 6972 7374             first
+0001ce50: 5f66 6574 6368 5f66 6169 6c65 6420 3d20  _fetch_failed = 
+0001ce60: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001ce70: 2069 6620 2244 6174 6120 646f 6573 6e27   if "Data doesn'
+0001ce80: 7420 6578 6973 7420 666f 7220 7374 6172  t exist for star
+0001ce90: 7444 6174 6522 2069 6e20 7374 7228 6529  tDate" in str(e)
+0001cea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ceb0: 2020 7261 6973 6520 7966 6364 2e4e 6f50    raise yfcd.NoP
+0001cec0: 7269 6365 4461 7461 496e 5261 6e67 6545  riceDataInRangeE
+0001ced0: 7863 6570 7469 6f6e 2873 656c 662e 7469  xception(self.ti
+0001cee0: 636b 6572 2c20 7365 6c66 2e69 7374 722c  cker, self.istr,
+0001cef0: 2073 7461 7274 2c20 656e 6429 0a20 2020   start, end).   
+0001cf00: 2020 2020 2020 2020 2065 6c69 6620 224e           elif "N
+0001cf10: 6f20 6461 7461 2066 6f75 6e64 2066 6f72  o data found for
+0001cf20: 2074 6869 7320 6461 7465 2072 616e 6765   this date range
+0001cf30: 2220 696e 2073 7472 2865 293a 0a20 2020  " in str(e):.   
+0001cf40: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001cf50: 7365 2079 6663 642e 4e6f 5072 6963 6544  se yfcd.NoPriceD
+0001cf60: 6174 6149 6e52 616e 6765 4578 6365 7074  ataInRangeExcept
+0001cf70: 696f 6e28 7365 6c66 2e74 6963 6b65 722c  ion(self.ticker,
+0001cf80: 2073 656c 662e 6973 7472 2c20 7374 6172   self.istr, star
+0001cf90: 742c 2065 6e64 290a 2020 2020 2020 2020  t, end).        
+0001cfa0: 2020 2020 656c 6966 2022 4e6f 2070 7269      elif "No pri
+0001cfb0: 6365 2064 6174 6120 666f 756e 642c 2073  ce data found, s
+0001cfc0: 796d 626f 6c20 6d61 7920 6265 2064 656c  ymbol may be del
+0001cfd0: 6973 7465 6422 2069 6e20 7374 7228 6529  isted" in str(e)
+0001cfe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cff0: 2020 7261 6973 6520 7966 6364 2e4e 6f50    raise yfcd.NoP
+0001d000: 7269 6365 4461 7461 496e 5261 6e67 6545  riceDataInRangeE
+0001d010: 7863 6570 7469 6f6e 2873 656c 662e 7469  xception(self.ti
+0001d020: 636b 6572 2c20 7365 6c66 2e69 7374 722c  cker, self.istr,
+0001d030: 2073 7461 7274 2c20 656e 6429 0a20 2020   start, end).   
+0001d040: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001d050: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001d060: 7269 6e74 2822 6466 3a22 290a 2020 2020  rint("df:").    
+0001d070: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001d080: 7428 6466 290a 2020 2020 2020 2020 2020  t(df).          
+0001d090: 2020 2020 2020 7261 6973 6520 650a 0a20        raise e.. 
+0001d0a0: 2020 2020 2020 2069 6620 6e6f 7420 6669         if not fi
+0001d0b0: 7273 745f 6665 7463 685f 6661 696c 6564  rst_fetch_failed
+0001d0c0: 2061 6e64 2066 6574 6368 5f73 7461 7274   and fetch_start
+0001d0d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001d0e0: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
+0001d0f0: 6720 3d20 6622 7265 7175 6573 7465 6420  g = f"requested 
+0001d100: 6672 6f6d 2059 463a 207b 7365 6c66 2e69  from YF: {self.i
+0001d110: 7374 727d 207b 6869 7374 6f72 795f 6172  str} {history_ar
+0001d120: 6773 5b27 7374 6172 7427 5d7d 202d 3e20  gs['start']} -> 
+0001d130: 7b68 6973 746f 7279 5f61 7267 735b 2765  {history_args['e
+0001d140: 6e64 275d 7d22 0a20 2020 2020 2020 2020  nd']}".         
+0001d150: 2020 206c 6f67 5f6d 7367 202b 3d20 6622     log_msg += f"
+0001d160: 2c20 7265 6365 6976 6564 3a20 7b64 662e  , received: {df.
+0001d170: 696e 6465 785b 305d 7d20 2d3e 207b 6466  index[0]} -> {df
+0001d180: 2e69 6e64 6578 5b2d 315d 7d22 0a20 2020  .index[-1]}".   
+0001d190: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+0001d1a0: 6e61 6765 722e 4c6f 6745 7665 6e74 2822  nager.LogEvent("
+0001d1b0: 696e 666f 222c 2022 5072 6963 654d 616e  info", "PriceMan
+0001d1c0: 6167 6572 222c 206c 6f67 5f6d 7367 290a  ager", log_msg).
+0001d1d0: 0a20 2020 2020 2020 2020 2020 2064 6620  .            df 
+0001d1e0: 3d20 6466 2e6c 6f63 5b66 6574 6368 5f73  = df.loc[fetch_s
+0001d1f0: 7461 7274 5f64 743a 5d0a 2020 2020 2020  tart_dt:].      
+0001d200: 2020 2020 2020 6966 2064 662e 656d 7074        if df.empt
+0001d210: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0001d220: 2020 2066 6972 7374 5f66 6574 6368 5f66     first_fetch_f
+0001d230: 6169 6c65 6420 3d20 5472 7565 0a20 2020  ailed = True.   
+0001d240: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001d250: 7365 2079 6663 642e 4e6f 5072 6963 6544  se yfcd.NoPriceD
+0001d260: 6174 6149 6e52 616e 6765 4578 6365 7074  ataInRangeExcept
+0001d270: 696f 6e28 7365 6c66 2e74 6963 6b65 722c  ion(self.ticker,
+0001d280: 2073 656c 662e 6973 7472 2c20 7374 6172   self.istr, star
+0001d290: 742c 2065 6e64 290a 0a20 2020 2020 2020  t, end)..       
+0001d2a0: 2023 2043 6865 636b 2074 6861 7420 7765   # Check that we
+0001d2b0: 656b 6c79 2061 6c69 676e 6564 2074 6f20  ekly aligned to 
+0001d2c0: 4d6f 6e64 6179 2e20 4966 206e 6f74 2c20  Monday. If not, 
+0001d2d0: 7368 6966 7420 7374 6172 7420 6461 7465  shift start date
+0001d2e0: 2062 6163 6b20 616e 6420 7265 2d66 6574   back and re-fet
+0001d2f0: 6368 0a20 2020 2020 2020 2069 6620 7365  ch.        if se
+0001d300: 6c66 2e69 6e74 6572 7661 6c20 3d3d 2079  lf.interval == y
+0001d310: 6663 642e 496e 7465 7276 616c 2e57 6565  fcd.Interval.Wee
+0001d320: 6b20 616e 6420 286e 6f74 2064 662e 656d  k and (not df.em
+0001d330: 7074 7929 2061 6e64 2028 6466 2e69 6e64  pty) and (df.ind
+0001d340: 6578 5b30 5d2e 7765 656b 6461 7928 2920  ex[0].weekday() 
+0001d350: 213d 2030 293a 0a20 2020 2020 2020 2020  != 0):.         
+0001d360: 2020 2023 2044 6573 7069 7465 2066 6574     # Despite fet
+0001d370: 6368 5f73 7461 7274 2061 6c69 676e 6564  ch_start aligned
+0001d380: 2074 6f20 4d6f 6e64 6179 2c20 736f 6d65   to Monday, some
+0001d390: 7469 6d65 7320 5961 686f 6f20 7265 7475  times Yahoo retu
+0001d3a0: 726e 7320 7765 656b 6c79 0a20 2020 2020  rns weekly.     
+0001d3b0: 2020 2020 2020 2023 2064 6174 6120 7374         # data st
+0001d3c0: 6172 7469 6e67 2061 2064 6966 6665 7265  arting a differe
+0001d3d0: 6e74 2064 6179 2e20 5368 6966 7469 6e67  nt day. Shifting
+0001d3e0: 2062 6163 6b20 6120 6c69 7474 6c65 2066   back a little f
+0001d3f0: 6978 6573 0a20 2020 2020 2020 2020 2020  ixes.           
+0001d400: 2073 6869 6674 5f62 6163 6b73 203d 205b   shift_backs = [
+0001d410: 322c 2034 5d0a 2020 2020 2020 2020 2020  2, 4].          
+0001d420: 2020 666f 7220 6420 696e 2073 6869 6674    for d in shift
+0001d430: 5f62 6163 6b73 3a0a 2020 2020 2020 2020  _backs:.        
+0001d440: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
+0001d450: 6172 7432 203d 2066 6574 6368 5f73 7461  art2 = fetch_sta
+0001d460: 7274 202d 2074 696d 6564 656c 7461 2864  rt - timedelta(d
+0001d470: 6179 733d 6429 0a20 2020 2020 2020 2020  ays=d).         
+0001d480: 2020 2020 2020 2068 6973 746f 7279 5f61         history_a
+0001d490: 7267 735b 2273 7461 7274 225d 203d 2066  rgs["start"] = f
+0001d4a0: 6574 6368 5f73 7461 7274 320a 2020 2020  etch_start2.    
+0001d4b0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0001d4c0: 6562 7567 5f79 6663 3a0a 2020 2020 2020  ebug_yfc:.      
+0001d4d0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+0001d4e0: 6720 3d20 222d 2077 6565 6b6c 7920 6461  g = "- weekly da
+0001d4f0: 7461 206e 6f74 2061 6c69 676e 6564 2074  ta not aligned t
+0001d500: 6f20 4d6f 6e64 6179 2c20 7265 2d66 6574  o Monday, re-fet
+0001d510: 6368 696e 6720 6672 6f6d 207b 7d22 2e66  ching from {}".f
+0001d520: 6f72 6d61 7428 6665 7463 685f 7374 6172  ormat(fetch_star
+0001d530: 7432 290a 2020 2020 2020 2020 2020 2020  t2).            
+0001d540: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+0001d550: 6365 5072 696e 7428 6d73 6729 2069 6620  cePrint(msg) if 
+0001d560: 7966 636c 2e49 7354 7261 6369 6e67 456e  yfcl.IsTracingEn
+0001d570: 6162 6c65 6428 2920 656c 7365 2070 7269  abled() else pri
+0001d580: 6e74 286d 7367 290a 2020 2020 2020 2020  nt(msg).        
+0001d590: 2020 2020 2020 2020 6466 203d 2073 656c          df = sel
+0001d5a0: 662e 6461 742e 6869 7374 6f72 7928 2a2a  f.dat.history(**
+0001d5b0: 6869 7374 6f72 795f 6172 6773 290a 2020  history_args).  
+0001d5c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001d5d0: 206e 6f74 2022 5265 7061 6972 6564 3f22   not "Repaired?"
+0001d5e0: 2069 6e20 6466 2e63 6f6c 756d 6e73 3a0a   in df.columns:.
+0001d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d600: 2020 2020 6466 5b22 5265 7061 6972 6564      df["Repaired
+0001d610: 3f22 5d20 3d20 4661 6c73 650a 2020 2020  ?"] = False.    
+0001d620: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001d630: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
+0001d640: 7966 6364 2e49 6e74 6572 7661 6c2e 5765  yfcd.Interval.We
+0001d650: 656b 2061 6e64 2028 6466 2e69 6e64 6578  ek and (df.index
+0001d660: 5b30 5d2e 7765 656b 6461 7928 2920 3d3d  [0].weekday() ==
+0001d670: 2030 293a 0a20 2020 2020 2020 2020 2020   0):.           
+0001d680: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+0001d690: 203d 2066 2272 6571 7565 7374 6564 2066   = f"requested f
+0001d6a0: 726f 6d20 5946 3a20 7b73 656c 662e 6973  rom YF: {self.is
+0001d6b0: 7472 7d20 7b68 6973 746f 7279 5f61 7267  tr} {history_arg
+0001d6c0: 735b 2773 7461 7274 275d 7d20 2d3e 207b  s['start']} -> {
+0001d6d0: 6869 7374 6f72 795f 6172 6773 5b27 656e  history_args['en
+0001d6e0: 6427 5d7d 220a 2020 2020 2020 2020 2020  d']}".          
+0001d6f0: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
+0001d700: 6720 2b3d 2066 222c 2072 6563 6569 7665  g += f", receive
+0001d710: 643a 207b 6466 2e69 6e64 6578 5b30 5d7d  d: {df.index[0]}
+0001d720: 202d 3e20 7b64 662e 696e 6465 785b 2d31   -> {df.index[-1
+0001d730: 5d7d 220a 2020 2020 2020 2020 2020 2020  ]}".            
+0001d740: 2020 2020 2020 2020 7365 6c66 2e6d 616e          self.man
+0001d750: 6167 6572 2e4c 6f67 4576 656e 7428 2269  ager.LogEvent("i
+0001d760: 6e66 6f22 2c20 2250 7269 6365 4d61 6e61  nfo", "PriceMana
+0001d770: 6765 7222 2c20 6c6f 675f 6d73 6729 0a0a  ger", log_msg)..
+0001d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d790: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0001d7a0: 6528 7374 6172 742c 2064 6174 6574 696d  e(start, datetim
+0001d7b0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+0001d7c0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+0001d7d0: 745f 6474 203d 2073 7461 7274 0a20 2020  t_dt = start.   
+0001d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001d800: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001d810: 7461 7274 5f64 7420 3d20 6461 7465 7469  tart_dt = dateti
+0001d820: 6d65 2e63 6f6d 6269 6e65 2873 7461 7274  me.combine(start
+0001d830: 2c20 7469 6d65 2830 292c 2073 656c 662e  , time(0), self.
+0001d840: 747a 290a 2020 2020 2020 2020 2020 2020  tz).            
+0001d850: 2020 2020 2020 2020 6466 203d 2064 662e          df = df.
+0001d860: 6c6f 635b 7374 6172 745f 6474 3a5d 0a20  loc[start_dt:]. 
+0001d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d880: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+0001d890: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
+0001d8a0: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0001d8b0: 6e74 6572 7661 6c2e 5765 656b 2061 6e64  nterval.Week and
+0001d8c0: 2028 6466 2e69 6e64 6578 5b30 5d2e 7765   (df.index[0].we
+0001d8d0: 656b 6461 7928 2920 213d 2030 293a 0a20  ekday() != 0):. 
+0001d8e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001d8f0: 2070 7269 6e74 2822 4461 7465 2072 616e   print("Date ran
+0001d900: 6765 2072 6571 7565 7374 6564 3a20 7b7d  ge requested: {}
+0001d910: 202d 3e20 7b7d 222e 666f 726d 6174 2866   -> {}".format(f
+0001d920: 6574 6368 5f73 7461 7274 2c20 6665 7463  etch_start, fetc
+0001d930: 685f 656e 6429 290a 2020 2020 2020 2020  h_end)).        
+0001d940: 2020 2020 2020 2020 7072 696e 7428 6466          print(df
+0001d950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001d960: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+0001d970: 6e28 2257 6565 6b6c 7920 6461 7461 2072  n("Weekly data r
+0001d980: 6574 7572 6e65 6420 6279 2059 4620 646f  eturned by YF do
+0001d990: 6573 6e27 7420 6265 6769 6e20 4d6f 6e64  esn't begin Mond
+0001d9a0: 6179 2062 7574 207b 7d22 2e66 6f72 6d61  ay but {}".forma
+0001d9b0: 7428 6466 2e69 6e64 6578 5b30 5d2e 7765  t(df.index[0].we
+0001d9c0: 656b 6461 7928 2929 290a 0a20 2020 2020  ekday()))..     
+0001d9d0: 2020 2069 6620 6466 2069 7320 6e6f 7420     if df is not 
+0001d9e0: 4e6f 6e65 2061 6e64 2064 662e 656d 7074  None and df.empt
+0001d9f0: 793a 0a20 2020 2020 2020 2020 2020 2064  y:.            d
+0001da00: 6620 3d20 4e6f 6e65 0a0a 2020 2020 2020  f = None..      
+0001da10: 2020 6966 2064 6620 6973 204e 6f6e 653a    if df is None:
+0001da20: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001da30: 5f6d 7367 203d 2022 504d 3a3a 5f66 6574  _msg = "PM::_fet
+0001da40: 6368 5966 4869 7374 6f72 795f 6461 7465  chYfHistory_date
+0001da50: 5261 6e67 6528 2920 7265 7475 726e 696e  Range() returnin
+0001da60: 6720 4e6f 6e65 220a 2020 2020 2020 2020  g None".        
+0001da70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001da80: 2020 6c6f 675f 6d73 6720 3d20 6622 504d    log_msg = f"PM
+0001da90: 3a3a 5f66 6574 6368 5966 4869 7374 6f72  ::_fetchYfHistor
+0001daa0: 795f 6461 7465 5261 6e67 6528 2920 7265  y_dateRange() re
+0001dab0: 7475 726e 696e 6720 4446 207b 6466 2e69  turning DF {df.i
+0001dac0: 6e64 6578 5b30 5d7d 202d 3e20 7b64 662e  ndex[0]} -> {df.
+0001dad0: 696e 6465 785b 2d31 5d7d 220a 2020 2020  index[-1]}".    
+0001dae0: 2020 2020 6966 2079 6663 6c2e 4973 5472      if yfcl.IsTr
+0001daf0: 6163 696e 6745 6e61 626c 6564 2829 3a0a  acingEnabled():.
+0001db00: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+0001db10: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+0001db20: 7367 290a 2020 2020 2020 2020 656c 6966  sg).        elif
+0001db30: 2064 6562 7567 5f79 6663 3a0a 2020 2020   debug_yfc:.    
+0001db40: 2020 2020 2020 2020 7072 696e 7428 6c6f          print(lo
+0001db50: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
+0001db60: 7265 7475 726e 2064 660a 0a20 2020 2064  return df..    d
+0001db70: 6566 205f 7265 636f 6e73 7472 7563 745f  ef _reconstruct_
+0001db80: 696e 7465 7276 616c 735f 6261 7463 6828  intervals_batch(
+0001db90: 7365 6c66 2c20 6466 2c20 7461 673d 2d31  self, df, tag=-1
+0001dba0: 293a 0a20 2020 2020 2020 2069 6620 6e6f  ):.        if no
+0001dbb0: 7420 6973 696e 7374 616e 6365 2864 662c  t isinstance(df,
+0001dbc0: 2070 642e 4461 7461 4672 616d 6529 3a0a   pd.DataFrame):.
+0001dbd0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001dbe0: 6520 4578 6365 7074 696f 6e28 2227 6466  e Exception("'df
+0001dbf0: 2720 6d75 7374 2062 6520 6120 5061 6e64  ' must be a Pand
+0001dc00: 6173 2044 6174 6146 7261 6d65 206e 6f74  as DataFrame not
+0001dc10: 222c 2074 7970 6528 6466 2929 0a20 2020  ", type(df)).   
+0001dc20: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+0001dc30: 6572 7661 6c20 3d3d 2079 6663 642e 496e  erval == yfcd.In
+0001dc40: 7465 7276 616c 2e4d 696e 7331 3a0a 2020  terval.Mins1:.  
+0001dc50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001dc60: 2064 660a 0a20 2020 2020 2020 2023 2052   df..        # R
+0001dc70: 6563 6f6e 7374 7275 6374 2076 616c 7565  econstruct value
+0001dc80: 7320 696e 2064 6620 7573 696e 6720 6669  s in df using fi
+0001dc90: 6e65 722d 6772 6169 6e65 6420 7072 6963  ner-grained pric
+0001dca0: 6520 6461 7461 2e20 4465 6c69 6d69 7465  e data. Delimite
+0001dcb0: 7220 6d61 726b 7320 7768 6174 2074 6f20  r marks what to 
+0001dcc0: 7265 636f 6e73 7472 7563 740a 0a20 2020  reconstruct..   
+0001dcd0: 2020 2020 2064 6562 7567 203d 2046 616c       debug = Fal
+0001dce0: 7365 0a20 2020 2020 2020 2023 2064 6562  se.        # deb
+0001dcf0: 7567 203d 2054 7275 650a 0a20 2020 2020  ug = True..     
+0001dd00: 2020 2070 7269 6365 5f63 6f6c 7320 3d20     price_cols = 
+0001dd10: 5b63 2066 6f72 2063 2069 6e20 5b22 4f70  [c for c in ["Op
+0001dd20: 656e 222c 2022 4869 6768 222c 2022 4c6f  en", "High", "Lo
+0001dd30: 7722 2c20 2243 6c6f 7365 222c 2022 4164  w", "Close", "Ad
+0001dd40: 6a20 436c 6f73 6522 5d20 6966 2063 2069  j Close"] if c i
+0001dd50: 6e20 6466 5d0a 2020 2020 2020 2020 6461  n df].        da
+0001dd60: 7461 5f63 6f6c 7320 3d20 7072 6963 655f  ta_cols = price_
+0001dd70: 636f 6c73 202b 205b 2256 6f6c 756d 6522  cols + ["Volume"
+0001dd80: 5d0a 0a20 2020 2020 2020 206c 6f67 5f6d  ]..        log_m
+0001dd90: 7367 203d 2066 2250 4d3a 3a5f 7265 636f  sg = f"PM::_reco
+0001dda0: 6e73 7472 7563 745f 696e 7465 7276 616c  nstruct_interval
+0001ddb0: 735f 6261 7463 682d 7b73 656c 662e 6973  s_batch-{self.is
+0001ddc0: 7472 7d28 6474 303d 7b64 662e 696e 6465  tr}(dt0={df.inde
+0001ddd0: 785b 305d 7d29 220a 2020 2020 2020 2020  x[0]})".        
+0001dde0: 7966 636c 2e54 7261 6365 456e 7465 7228  yfcl.TraceEnter(
+0001ddf0: 6c6f 675f 6d73 6729 0a0a 2020 2020 2020  log_msg)..      
+0001de00: 2020 2320 4966 2069 6e74 6572 7661 6c20    # If interval 
+0001de10: 6973 2077 6565 6b6c 7920 7468 656e 2063  is weekly then c
+0001de20: 616e 2063 6f6e 7374 7275 6374 2077 6974  an construct wit
+0001de30: 6820 6461 696c 792e 2042 7574 2069 6620  h daily. But if 
+0001de40: 736d 616c 6c65 7220 696e 7465 7276 616c  smaller interval
+0001de50: 7320 7468 656e 0a20 2020 2020 2020 2023  s then.        #
+0001de60: 2072 6573 7472 6963 7465 6420 746f 2072   restricted to r
+0001de70: 6563 656e 7420 7469 6d65 733a 0a20 2020  ecent times:.   
+0001de80: 2020 2020 206d 696e 5f6c 6f6f 6b62 6163       min_lookbac
+0001de90: 6b20 3d20 4e6f 6e65 0a20 2020 2020 2020  k = None.       
+0001dea0: 2023 202d 2064 6169 6c79 203d 2068 6f75   # - daily = hou
+0001deb0: 726c 7920 7265 7374 7269 6374 6564 2074  rly restricted t
+0001dec0: 6f20 6c61 7374 2037 3330 2064 6179 730a  o last 730 days.
+0001ded0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001dee0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0001def0: 2e49 6e74 6572 7661 6c2e 5765 656b 3a0a  .Interval.Week:.
+0001df00: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+0001df10: 7272 6563 7420 6279 2066 6574 6368 696e  rrect by fetchin
+0001df20: 6720 7765 656b 206f 6620 6461 696c 7920  g week of daily 
+0001df30: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0001df40: 2073 7562 5f69 6e74 6572 7661 6c20 3d20   sub_interval = 
+0001df50: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
+0001df60: 7973 310a 2020 2020 2020 2020 2020 2020  ys1.            
+0001df70: 7464 5f72 616e 6765 203d 2074 696d 6564  td_range = timed
+0001df80: 656c 7461 2864 6179 733d 3729 0a20 2020  elta(days=7).   
+0001df90: 2020 2020 2065 6c69 6620 7365 6c66 2e69       elif self.i
+0001dfa0: 6e74 6572 7661 6c20 3d3d 2079 6663 642e  nterval == yfcd.
+0001dfb0: 496e 7465 7276 616c 2e44 6179 7331 3a0a  Interval.Days1:.
+0001dfc0: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+0001dfd0: 7272 6563 7420 6279 2066 6574 6368 696e  rrect by fetchin
+0001dfe0: 6720 6461 7920 6f66 2068 6f75 726c 7920  g day of hourly 
+0001dff0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0001e000: 2073 7562 5f69 6e74 6572 7661 6c20 3d20   sub_interval = 
+0001e010: 7966 6364 2e49 6e74 6572 7661 6c2e 486f  yfcd.Interval.Ho
+0001e020: 7572 7331 0a20 2020 2020 2020 2020 2020  urs1.           
+0001e030: 2074 645f 7261 6e67 6520 3d20 7469 6d65   td_range = time
+0001e040: 6465 6c74 6128 6461 7973 3d31 290a 2020  delta(days=1).  
+0001e050: 2020 2020 2020 2020 2020 6d69 6e5f 6c6f            min_lo
+0001e060: 6f6b 6261 636b 203d 2074 696d 6564 656c  okback = timedel
+0001e070: 7461 2864 6179 733d 3733 3029 0a20 2020  ta(days=730).   
+0001e080: 2020 2020 2065 6c69 6620 7365 6c66 2e69       elif self.i
+0001e090: 6e74 6572 7661 6c20 3d3d 2079 6663 642e  nterval == yfcd.
+0001e0a0: 496e 7465 7276 616c 2e48 6f75 7273 313a  Interval.Hours1:
+0001e0b0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0001e0c0: 6f72 7265 6374 2062 7920 6665 7463 6869  orrect by fetchi
+0001e0d0: 6e67 2068 6f75 7220 6f66 2033 306d 2064  ng hour of 30m d
+0001e0e0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+0001e0f0: 7375 625f 696e 7465 7276 616c 203d 2079  sub_interval = y
+0001e100: 6663 642e 496e 7465 7276 616c 2e4d 696e  fcd.Interval.Min
+0001e110: 7333 300a 2020 2020 2020 2020 2020 2020  s30.            
+0001e120: 7464 5f72 616e 6765 203d 2074 696d 6564  td_range = timed
+0001e130: 656c 7461 2868 6f75 7273 3d31 290a 2020  elta(hours=1).  
+0001e140: 2020 2020 2020 2020 2020 6d69 6e5f 6c6f            min_lo
+0001e150: 6f6b 6261 636b 203d 2074 696d 6564 656c  okback = timedel
+0001e160: 7461 2864 6179 733d 3630 290a 2020 2020  ta(days=60).    
+0001e170: 2020 2020 656c 6966 2073 656c 662e 696e      elif self.in
+0001e180: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0001e190: 6e74 6572 7661 6c2e 4d69 6e73 3330 3a0a  nterval.Mins30:.
+0001e1a0: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
+0001e1b0: 7272 6563 7420 6279 2066 6574 6368 696e  rrect by fetchin
+0001e1c0: 6720 686f 7572 206f 6620 3135 6d20 6461  g hour of 15m da
+0001e1d0: 7461 0a20 2020 2020 2020 2020 2020 2073  ta.            s
+0001e1e0: 7562 5f69 6e74 6572 7661 6c20 3d20 7966  ub_interval = yf
+0001e1f0: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
+0001e200: 3135 0a20 2020 2020 2020 2020 2020 2074  15.            t
+0001e210: 645f 7261 6e67 6520 3d20 7469 6d65 6465  d_range = timede
+0001e220: 6c74 6128 6d69 6e75 7465 733d 3330 290a  lta(minutes=30).
+0001e230: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+0001e240: 6c6f 6f6b 6261 636b 203d 2074 696d 6564  lookback = timed
+0001e250: 656c 7461 2864 6179 733d 3630 290a 2020  elta(days=60).  
+0001e260: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+0001e270: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0001e280: 2e49 6e74 6572 7661 6c2e 4d69 6e73 3135  .Interval.Mins15
+0001e290: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001e2a0: 436f 7272 6563 7420 6279 2066 6574 6368  Correct by fetch
+0001e2b0: 696e 6720 686f 7572 206f 6620 356d 2064  ing hour of 5m d
+0001e2c0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+0001e2d0: 7375 625f 696e 7465 7276 616c 203d 2079  sub_interval = y
+0001e2e0: 6663 642e 496e 7465 7276 616c 2e4d 696e  fcd.Interval.Min
+0001e2f0: 7335 0a20 2020 2020 2020 2020 2020 2074  s5.            t
+0001e300: 645f 7261 6e67 6520 3d20 7469 6d65 6465  d_range = timede
+0001e310: 6c74 6128 6d69 6e75 7465 733d 3135 290a  lta(minutes=15).
+0001e320: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+0001e330: 6c6f 6f6b 6261 636b 203d 2074 696d 6564  lookback = timed
+0001e340: 656c 7461 2864 6179 733d 3630 290a 2020  elta(days=60).  
+0001e350: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+0001e360: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0001e370: 2e49 6e74 6572 7661 6c2e 4d69 6e73 353a  .Interval.Mins5:
+0001e380: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0001e390: 6f72 7265 6374 2062 7920 6665 7463 6869  orrect by fetchi
+0001e3a0: 6e67 2068 6f75 7220 6f66 2032 6d20 6461  ng hour of 2m da
+0001e3b0: 7461 0a20 2020 2020 2020 2020 2020 2073  ta.            s
+0001e3c0: 7562 5f69 6e74 6572 7661 6c20 3d20 7966  ub_interval = yf
+0001e3d0: 6364 2e49 6e74 6572 7661 6c2e 4d69 6e73  cd.Interval.Mins
+0001e3e0: 320a 2020 2020 2020 2020 2020 2020 7464  2.            td
+0001e3f0: 5f72 616e 6765 203d 2074 696d 6564 656c  _range = timedel
+0001e400: 7461 286d 696e 7574 6573 3d35 290a 2020  ta(minutes=5).  
+0001e410: 2020 2020 2020 2020 2020 6d69 6e5f 6c6f            min_lo
+0001e420: 6f6b 6261 636b 203d 2074 696d 6564 656c  okback = timedel
+0001e430: 7461 2864 6179 733d 3630 290a 2020 2020  ta(days=60).    
+0001e440: 2020 2020 656c 6966 2073 656c 662e 696e      elif self.in
+0001e450: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0001e460: 6e74 6572 7661 6c2e 4d69 6e73 323a 0a20  nterval.Mins2:. 
+0001e470: 2020 2020 2020 2020 2020 2023 2043 6f72             # Cor
+0001e480: 7265 6374 2062 7920 6665 7463 6869 6e67  rect by fetching
+0001e490: 2068 6f75 7220 6f66 2031 6d20 6461 7461   hour of 1m data
+0001e4a0: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
+0001e4b0: 5f69 6e74 6572 7661 6c20 3d20 7966 6364  _interval = yfcd
+0001e4c0: 2e49 6e74 6572 7661 6c2e 4d69 6e73 310a  .Interval.Mins1.
+0001e4d0: 2020 2020 2020 2020 2020 2020 7464 5f72              td_r
+0001e4e0: 616e 6765 203d 2074 696d 6564 656c 7461  ange = timedelta
+0001e4f0: 286d 696e 7574 6573 3d32 290a 2020 2020  (minutes=2).    
+0001e500: 2020 2020 2020 2020 6d69 6e5f 6c6f 6f6b          min_look
+0001e510: 6261 636b 203d 2074 696d 6564 656c 7461  back = timedelta
+0001e520: 2864 6179 733d 3330 290a 2020 2020 2020  (days=30).      
+0001e530: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001e540: 2020 2020 6d73 6720 3d20 6622 5741 524e      msg = f"WARN
+0001e550: 494e 473a 2048 6176 6520 6e6f 7420 696d  ING: Have not im
+0001e560: 706c 656d 656e 7465 6420 7265 7061 6972  plemented repair
+0001e570: 2066 6f72 2027 7b73 656c 662e 696e 7465   for '{self.inte
+0001e580: 7276 616c 7d27 2069 6e74 6572 7661 6c2e  rval}' interval.
+0001e590: 2043 6f6e 7461 6374 2064 6576 656c 6f70   Contact develop
+0001e5a0: 6572 7322 0a20 2020 2020 2020 2020 2020  ers".           
+0001e5b0: 2079 6663 6c2e 5472 6163 6550 7269 6e74   yfcl.TracePrint
+0001e5c0: 286d 7367 2920 6966 2079 6663 6c2e 4973  (msg) if yfcl.Is
+0001e5d0: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+0001e5e0: 2065 6c73 6520 7072 696e 7428 6d73 6729   else print(msg)
+0001e5f0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001e600: 5f6d 7367 203d 2022 504d 3a3a 5f72 6563  _msg = "PM::_rec
+0001e610: 6f6e 7374 7275 6374 5f69 6e74 6572 7661  onstruct_interva
+0001e620: 6c73 5f62 6174 6368 2829 2072 6574 7572  ls_batch() retur
+0001e630: 6e69 6e67 220a 2020 2020 2020 2020 2020  ning".          
+0001e640: 2020 7966 636c 2e54 7261 6365 4578 6974    yfcl.TraceExit
+0001e650: 286c 6f67 5f6d 7367 290a 2020 2020 2020  (log_msg).      
+0001e660: 2020 2020 2020 7265 7475 726e 2064 660a        return df.
+0001e670: 2020 2020 2020 2020 7375 625f 696e 7465          sub_inte
+0001e680: 7264 6179 203d 2073 7562 5f69 6e74 6572  rday = sub_inter
+0001e690: 7661 6c20 696e 205b 7966 6364 2e49 6e74  val in [yfcd.Int
+0001e6a0: 6572 7661 6c2e 4461 7973 312c 2079 6663  erval.Days1, yfc
+0001e6b0: 642e 496e 7465 7276 616c 2e57 6565 6b2c  d.Interval.Week,
+0001e6c0: 2079 6663 642e 496e 7465 7276 616c 2e4d   yfcd.Interval.M
+0001e6d0: 6f6e 7468 7331 2c20 7966 6364 2e49 6e74  onths1, yfcd.Int
+0001e6e0: 6572 7661 6c2e 4d6f 6e74 6873 335d 0a20  erval.Months3]. 
+0001e6f0: 2020 2020 2020 2073 7562 5f69 6e74 7261         sub_intra
+0001e700: 6461 7920 3d20 6e6f 7420 7375 625f 696e  day = not sub_in
+0001e710: 7465 7264 6179 0a0a 2020 2020 2020 2020  terday..        
+0001e720: 6466 203d 2064 662e 736f 7274 5f69 6e64  df = df.sort_ind
+0001e730: 6578 2829 0a0a 2020 2020 2020 2020 665f  ex()..        f_
+0001e740: 7265 7061 6972 203d 2064 665b 6461 7461  repair = df[data
+0001e750: 5f63 6f6c 735d 2e74 6f5f 6e75 6d70 7928  _cols].to_numpy(
+0001e760: 2920 3d3d 2074 6167 0a20 2020 2020 2020  ) == tag.       
+0001e770: 2066 5f72 6570 6169 725f 726f 7773 203d   f_repair_rows =
+0001e780: 2066 5f72 6570 6169 722e 616e 7928 6178   f_repair.any(ax
+0001e790: 6973 3d31 290a 0a20 2020 2020 2020 2023  is=1)..        #
+0001e7a0: 2049 676e 6f72 6520 6f6c 6420 696e 7465   Ignore old inte
+0001e7b0: 7276 616c 7320 666f 7220 7768 6963 6820  rvals for which 
+0001e7c0: 5961 686f 6f20 776f 6e27 7420 7265 7475  Yahoo won't retu
+0001e7d0: 726e 2066 696e 6572 2064 6174 613a 0a20  rn finer data:. 
+0001e7e0: 2020 2020 2020 2023 2069 6620 7375 625f         # if sub_
+0001e7f0: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0001e800: 2e49 6e74 6572 7661 6c2e 486f 7572 7331  .Interval.Hours1
+0001e810: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
+0001e820: 665f 7265 6365 6e74 203d 2064 6174 652e  f_recent = date.
+0001e830: 746f 6461 7928 2920 2d20 6466 2e69 6e64  today() - df.ind
+0001e840: 6578 2e64 6174 6520 3c20 7469 6d65 6465  ex.date < timede
+0001e850: 6c74 6128 6461 7973 3d37 3330 290a 2020  lta(days=730).  
+0001e860: 2020 2020 2020 2320 2020 2020 665f 7265        #     f_re
+0001e870: 7061 6972 5f72 6f77 7320 3d20 665f 7265  pair_rows = f_re
+0001e880: 7061 6972 5f72 6f77 7320 2620 665f 7265  pair_rows & f_re
+0001e890: 6365 6e74 0a20 2020 2020 2020 2023 2065  cent.        # e
+0001e8a0: 6c69 6620 7375 625f 696e 7465 7276 616c  lif sub_interval
+0001e8b0: 2069 6e20 5b79 6663 642e 496e 7465 7276   in [yfcd.Interv
+0001e8c0: 616c 2e4d 696e 7333 302c 2079 6663 642e  al.Mins30, yfcd.
+0001e8d0: 496e 7465 7276 616c 2e4d 696e 7331 355d  Interval.Mins15]
+0001e8e0: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
+0001e8f0: 665f 7265 6365 6e74 203d 2064 6174 652e  f_recent = date.
+0001e900: 746f 6461 7928 2920 2d20 6466 2e69 6e64  today() - df.ind
+0001e910: 6578 2e64 6174 6520 3c20 7469 6d65 6465  ex.date < timede
+0001e920: 6c74 6128 6461 7973 3d36 3029 0a20 2020  lta(days=60).   
+0001e930: 2020 2020 2023 2020 2020 2066 5f72 6570       #     f_rep
+0001e940: 6169 725f 726f 7773 203d 2066 5f72 6570  air_rows = f_rep
+0001e950: 6169 725f 726f 7773 2026 2066 5f72 6563  air_rows & f_rec
+0001e960: 656e 740a 2020 2020 2020 2020 6966 206d  ent.        if m
+0001e970: 696e 5f6c 6f6f 6b62 6163 6b20 6973 204e  in_lookback is N
+0001e980: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001e990: 206d 696e 5f64 7420 3d20 4e6f 6e65 0a20   min_dt = None. 
+0001e9a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001e9b0: 2020 2020 2020 2020 206d 696e 5f64 7420           min_dt 
+0001e9c0: 3d20 7064 2e54 696d 6573 7461 6d70 2e75  = pd.Timestamp.u
+0001e9d0: 7463 6e6f 7728 292e 747a 5f63 6f6e 7665  tcnow().tz_conve
+0001e9e0: 7274 285a 6f6e 6549 6e66 6f28 2255 5443  rt(ZoneInfo("UTC
+0001e9f0: 2229 2920 2d20 6d69 6e5f 6c6f 6f6b 6261  ")) - min_lookba
+0001ea00: 636b 0a20 2020 2020 2020 2069 6620 6465  ck.        if de
+0001ea10: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+0001ea20: 2070 7269 6e74 2866 222d 206d 696e 5f64   print(f"- min_d
+0001ea30: 743d 7b6d 696e 5f64 747d 2069 6e74 6572  t={min_dt} inter
+0001ea40: 7661 6c3d 7b73 656c 662e 696e 7465 7276  val={self.interv
+0001ea50: 616c 7d20 7375 625f 696e 7465 7276 616c  al} sub_interval
+0001ea60: 3d7b 7375 625f 696e 7465 7276 616c 7d22  ={sub_interval}"
+0001ea70: 290a 2020 2020 2020 2020 6966 206d 696e  ).        if min
+0001ea80: 5f64 7420 6973 206e 6f74 204e 6f6e 653a  _dt is not None:
+0001ea90: 0a20 2020 2020 2020 2020 2020 2066 5f72  .            f_r
+0001eaa0: 6563 656e 7420 3d20 6466 2e69 6e64 6578  ecent = df.index
+0001eab0: 203e 206d 696e 5f64 740a 2020 2020 2020   > min_dt.      
+0001eac0: 2020 2020 2020 665f 7265 7061 6972 5f72        f_repair_r
+0001ead0: 6f77 7320 3d20 665f 7265 7061 6972 5f72  ows = f_repair_r
+0001eae0: 6f77 7320 2620 665f 7265 6365 6e74 0a20  ows & f_recent. 
+0001eaf0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001eb00: 7420 665f 7265 7061 6972 5f72 6f77 732e  t f_repair_rows.
+0001eb10: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
+0001eb20: 2020 2020 2020 2069 6620 6465 6275 673a         if debug:
+0001eb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001eb40: 2020 2020 2070 7269 6e74 2822 2d20 6461       print("- da
+0001eb50: 7461 2074 6f6f 206f 6c64 2074 6f20 7265  ta too old to re
+0001eb60: 7061 6972 2229 0a20 2020 2020 2020 2020  pair").         
+0001eb70: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
+0001eb80: 0a0a 2020 2020 2020 2020 6474 735f 746f  ..        dts_to
+0001eb90: 5f72 6570 6169 7220 3d20 6466 2e69 6e64  _repair = df.ind
+0001eba0: 6578 5b66 5f72 6570 6169 725f 726f 7773  ex[f_repair_rows
+0001ebb0: 5d0a 2020 2020 2020 2020 2320 696e 6469  ].        # indi
+0001ebc0: 6365 735f 746f 5f72 6570 6169 7220 3d20  ces_to_repair = 
+0001ebd0: 6e70 2e77 6865 7265 2866 5f72 6570 6169  np.where(f_repai
+0001ebe0: 725f 726f 7773 295b 305d 0a0a 2020 2020  r_rows)[0]..    
+0001ebf0: 2020 2020 6966 206c 656e 2864 7473 5f74      if len(dts_t
+0001ec00: 6f5f 7265 7061 6972 2920 3d3d 2030 3a0a  o_repair) == 0:.
+0001ec10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001ec20: 726e 2064 660a 0a20 2020 2020 2020 2064  rn df..        d
+0001ec30: 665f 7632 203d 2064 662e 636f 7079 2829  f_v2 = df.copy()
+0001ec40: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001ec50: 2252 6570 6169 7265 643f 2220 696e 2064  "Repaired?" in d
+0001ec60: 665f 7632 2e63 6f6c 756d 6e73 3a0a 2020  f_v2.columns:.  
+0001ec70: 2020 2020 2020 2020 2020 6466 5f76 325b            df_v2[
+0001ec80: 2252 6570 6169 7265 643f 225d 203d 2046  "Repaired?"] = F
+0001ec90: 616c 7365 0a20 2020 2020 2020 2064 665f  alse.        df_
+0001eca0: 676f 6f64 203d 2064 665b 7e64 665b 7072  good = df[~df[pr
+0001ecb0: 6963 655f 636f 6c73 5d2e 6973 6e61 2829  ice_cols].isna()
+0001ecc0: 2e61 6e79 2861 7869 733d 3129 5d0a 2020  .any(axis=1)].  
+0001ecd0: 2020 2020 2020 665f 7461 6720 3d20 6466        f_tag = df
+0001ece0: 5f76 325b 7072 6963 655f 636f 6c73 5d2e  _v2[price_cols].
+0001ecf0: 746f 5f6e 756d 7079 2829 203d 3d20 7461  to_numpy() == ta
+0001ed00: 670a 0a20 2020 2020 2020 2023 2047 726f  g..        # Gro
+0001ed10: 7570 206e 6561 7262 7920 4e61 4e2d 696e  up nearby NaN-in
+0001ed20: 7465 7276 616c 7320 746f 6765 7468 6572  tervals together
+0001ed30: 2074 6f20 7265 6475 6365 206e 756d 6265   to reduce numbe
+0001ed40: 7220 6f66 2059 6168 6f6f 2066 6574 6368  r of Yahoo fetch
+0001ed50: 6573 0a20 2020 2020 2020 2064 7473 5f67  es.        dts_g
+0001ed60: 726f 7570 7320 3d20 5b5b 6474 735f 746f  roups = [[dts_to
+0001ed70: 5f72 6570 6169 725b 305d 5d5d 0a20 2020  _repair[0]]].   
+0001ed80: 2020 2020 2023 206c 6173 745f 6474 203d       # last_dt =
+0001ed90: 2064 7473 5f74 6f5f 7265 7061 6972 5b30   dts_to_repair[0
+0001eda0: 5d0a 2020 2020 2020 2020 2320 6c61 7374  ].        # last
+0001edb0: 5f69 6e64 203d 2069 6e64 6963 6573 5f74  _ind = indices_t
+0001edc0: 6f5f 7265 7061 6972 5b30 5d0a 2020 2020  o_repair[0].    
+0001edd0: 2020 2020 2320 7464 203d 2079 6663 642e      # td = yfcd.
+0001ede0: 696e 7465 7276 616c 546f 5469 6d65 6465  intervalToTimede
+0001edf0: 6c74 615b 7365 6c66 2e69 6e74 6572 7661  lta[self.interva
+0001ee00: 6c5d 0a20 2020 2020 2020 2023 2069 6620  l].        # if 
+0001ee10: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+0001ee20: 2079 6663 642e 496e 7465 7276 616c 2e4d   yfcd.Interval.M
+0001ee30: 6f6e 7468 7331 3a0a 2020 2020 2020 2020  onths1:.        
+0001ee40: 2320 2020 2020 6772 705f 7464 5f74 6872  #     grp_td_thr
+0001ee50: 6573 686f 6c64 203d 2074 696d 6564 656c  eshold = timedel
+0001ee60: 7461 2864 6179 733d 3238 290a 2020 2020  ta(days=28).    
+0001ee70: 2020 2020 2320 656c 6966 2073 656c 662e      # elif self.
+0001ee80: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0001ee90: 2e49 6e74 6572 7661 6c2e 5765 656b 3a0a  .Interval.Week:.
+0001eea0: 2020 2020 2020 2020 2320 2020 2020 6772          #     gr
+0001eeb0: 705f 7464 5f74 6872 6573 686f 6c64 203d  p_td_threshold =
+0001eec0: 2074 696d 6564 656c 7461 2864 6179 733d   timedelta(days=
+0001eed0: 3238 290a 2020 2020 2020 2020 2320 656c  28).        # el
+0001eee0: 6966 2073 656c 662e 696e 7465 7276 616c  if self.interval
+0001eef0: 203d 3d20 7966 6364 2e49 6e74 6572 7661   == yfcd.Interva
+0001ef00: 6c2e 4461 7973 313a 0a20 2020 2020 2020  l.Days1:.       
+0001ef10: 2023 2020 2020 2067 7270 5f74 645f 7468   #     grp_td_th
+0001ef20: 7265 7368 6f6c 6420 3d20 7469 6d65 6465  reshold = timede
+0001ef30: 6c74 6128 6461 7973 3d31 3429 0a20 2020  lta(days=14).   
+0001ef40: 2020 2020 2023 2065 6c69 6620 7365 6c66       # elif self
+0001ef50: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+0001ef60: 642e 496e 7465 7276 616c 2e48 6f75 7273  d.Interval.Hours
+0001ef70: 313a 0a20 2020 2020 2020 2023 2020 2020  1:.        #    
+0001ef80: 2067 7270 5f74 645f 7468 7265 7368 6f6c   grp_td_threshol
+0001ef90: 6420 3d20 7469 6d65 6465 6c74 6128 6461  d = timedelta(da
+0001efa0: 7973 3d37 290a 2020 2020 2020 2020 2320  ys=7).        # 
+0001efb0: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
+0001efc0: 2020 2020 6772 705f 7464 5f74 6872 6573      grp_td_thres
+0001efd0: 686f 6c64 203d 2074 696d 6564 656c 7461  hold = timedelta
+0001efe0: 2864 6179 733d 3229 0a20 2020 2020 2020  (days=2).       
+0001eff0: 2023 2020 2020 2023 2067 7270 5f74 645f   #     # grp_td_
+0001f000: 7468 7265 7368 6f6c 6420 3d20 7469 6d65  threshold = time
+0001f010: 6465 6c74 6128 6461 7973 3d37 290a 2020  delta(days=7).  
+0001f020: 2020 2020 2020 2320 666f 7220 6920 696e        # for i in
+0001f030: 2072 616e 6765 2831 2c20 6c65 6e28 6474   range(1, len(dt
+0001f040: 735f 746f 5f72 6570 6169 7229 293a 0a20  s_to_repair)):. 
+0001f050: 2020 2020 2020 2023 2020 2020 2069 6e64         #     ind
+0001f060: 203d 2069 6e64 6963 6573 5f74 6f5f 7265   = indices_to_re
+0001f070: 7061 6972 5b69 5d0a 2020 2020 2020 2020  pair[i].        
+0001f080: 2320 2020 2020 6474 203d 2064 7473 5f74  #     dt = dts_t
+0001f090: 6f5f 7265 7061 6972 5b69 5d0a 2020 2020  o_repair[i].    
+0001f0a0: 2020 2020 2320 2020 2020 6966 2028 6474      #     if (dt
+0001f0b0: 2d64 7473 5f67 726f 7570 735b 2d31 5d5b  -dts_groups[-1][
+0001f0c0: 2d31 5d29 203c 2067 7270 5f74 645f 7468  -1]) < grp_td_th
+0001f0d0: 7265 7368 6f6c 643a 0a20 2020 2020 2020  reshold:.       
+0001f0e0: 2023 2020 2020 2020 2020 2064 7473 5f67   #         dts_g
+0001f0f0: 726f 7570 735b 2d31 5d2e 6170 7065 6e64  roups[-1].append
+0001f100: 2864 7429 0a20 2020 2020 2020 2023 2020  (dt).        #  
+0001f110: 2020 2065 6c69 6620 696e 6420 2d20 6c61     elif ind - la
+0001f120: 7374 5f69 6e64 203c 3d20 333a 0a20 2020  st_ind <= 3:.   
+0001f130: 2020 2020 2023 2020 2020 2020 2020 2064       #         d
+0001f140: 7473 5f67 726f 7570 735b 2d31 5d2e 6170  ts_groups[-1].ap
+0001f150: 7065 6e64 2864 7429 0a20 2020 2020 2020  pend(dt).       
+0001f160: 2023 2020 2020 2065 6c73 653a 0a20 2020   #     else:.   
+0001f170: 2020 2020 2023 2020 2020 2020 2020 2064       #         d
+0001f180: 7473 5f67 726f 7570 732e 6170 7065 6e64  ts_groups.append
+0001f190: 285b 6474 5d29 0a20 2020 2020 2020 2023  ([dt]).        #
+0001f1a0: 2020 2020 206c 6173 745f 6474 203d 2064       last_dt = d
+0001f1b0: 740a 2020 2020 2020 2020 2320 2020 2020  t.        #     
+0001f1c0: 6c61 7374 5f69 6e64 203d 2069 6e64 0a20  last_ind = ind. 
+0001f1d0: 2020 2020 2020 2023 2066 6f72 2069 2069         # for i i
+0001f1e0: 6e20 7261 6e67 6528 312c 206c 656e 2864  n range(1, len(d
+0001f1f0: 7473 5f74 6f5f 7265 7061 6972 2929 3a0a  ts_to_repair)):.
+0001f200: 2020 2020 2020 2020 2320 2020 2020 696e          #     in
+0001f210: 6420 3d20 696e 6469 6365 735f 746f 5f72  d = indices_to_r
+0001f220: 6570 6169 725b 695d 0a20 2020 2020 2020  epair[i].       
+0001f230: 2023 2020 2020 2064 7420 3d20 6474 735f   #     dt = dts_
+0001f240: 746f 5f72 6570 6169 725b 695d 0a20 2020  to_repair[i].   
+0001f250: 2020 2020 2023 2020 2020 2069 6620 2864       #     if (d
+0001f260: 742d 6474 735f 6772 6f75 7073 5b2d 315d  t-dts_groups[-1]
+0001f270: 5b2d 315d 2920 3c20 6772 705f 7464 5f74  [-1]) < grp_td_t
+0001f280: 6872 6573 686f 6c64 3a0a 2020 2020 2020  hreshold:.      
+0001f290: 2020 2320 2020 2020 2020 2020 6474 735f    #         dts_
+0001f2a0: 6772 6f75 7073 5b2d 315d 2e61 7070 656e  groups[-1].appen
+0001f2b0: 6428 6474 290a 2020 2020 2020 2020 2320  d(dt).        # 
+0001f2c0: 2020 2020 656c 6966 2069 6e64 202d 206c      elif ind - l
+0001f2d0: 6173 745f 696e 6420 3c3d 2033 3a0a 2020  ast_ind <= 3:.  
+0001f2e0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0001f2f0: 6474 735f 6772 6f75 7073 5b2d 315d 2e61  dts_groups[-1].a
+0001f300: 7070 656e 6428 6474 290a 2020 2020 2020  ppend(dt).      
+0001f310: 2020 2320 2020 2020 656c 7365 3a0a 2020    #     else:.  
+0001f320: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0001f330: 6474 735f 6772 6f75 7073 2e61 7070 656e  dts_groups.appen
+0001f340: 6428 5b64 745d 290a 2020 2020 2020 2020  d([dt]).        
+0001f350: 2320 2020 2020 6c61 7374 5f64 7420 3d20  #     last_dt = 
+0001f360: 6474 0a20 2020 2020 2020 2023 2020 2020  dt.        #    
+0001f370: 206c 6173 745f 696e 6420 3d20 696e 640a   last_ind = ind.
+0001f380: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001f390: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+0001f3a0: 2e49 6e74 6572 7661 6c2e 4d6f 6e74 6873  .Interval.Months
+0001f3b0: 313a 0a20 2020 2020 2020 2020 2020 2067  1:.            g
+0001f3c0: 7270 5f6d 6178 5f73 697a 6520 3d20 6461  rp_max_size = da
+0001f3d0: 7465 7574 696c 2e72 656c 6174 6976 6564  teutil.relatived
+0001f3e0: 656c 7461 2e72 656c 6174 6976 6564 656c  elta.relativedel
+0001f3f0: 7461 2879 6561 7273 3d32 290a 2020 2020  ta(years=2).    
+0001f400: 2020 2020 656c 6966 2073 656c 662e 696e      elif self.in
+0001f410: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+0001f420: 6e74 6572 7661 6c2e 5765 656b 3a0a 2020  nterval.Week:.  
+0001f430: 2020 2020 2020 2020 2020 6772 705f 6d61            grp_ma
+0001f440: 785f 7369 7a65 203d 2064 6174 6575 7469  x_size = dateuti
+0001f450: 6c2e 7265 6c61 7469 7665 6465 6c74 612e  l.relativedelta.
+0001f460: 7265 6c61 7469 7665 6465 6c74 6128 7965  relativedelta(ye
+0001f470: 6172 733d 3229 0a20 2020 2020 2020 2065  ars=2).        e
+0001f480: 6c69 6620 7365 6c66 2e69 6e74 6572 7661  lif self.interva
+0001f490: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
+0001f4a0: 616c 2e44 6179 7331 3a0a 2020 2020 2020  al.Days1:.      
+0001f4b0: 2020 2020 2020 6772 705f 6d61 785f 7369        grp_max_si
+0001f4c0: 7a65 203d 2064 6174 6575 7469 6c2e 7265  ze = dateutil.re
+0001f4d0: 6c61 7469 7665 6465 6c74 612e 7265 6c61  lativedelta.rela
+0001f4e0: 7469 7665 6465 6c74 6128 7965 6172 733d  tivedelta(years=
+0001f4f0: 3229 0a20 2020 2020 2020 2065 6c69 6620  2).        elif 
+0001f500: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+0001f510: 2079 6663 642e 496e 7465 7276 616c 2e48   yfcd.Interval.H
+0001f520: 6f75 7273 313a 0a20 2020 2020 2020 2020  ours1:.         
+0001f530: 2020 2067 7270 5f6d 6178 5f73 697a 6520     grp_max_size 
+0001f540: 3d20 6461 7465 7574 696c 2e72 656c 6174  = dateutil.relat
+0001f550: 6976 6564 656c 7461 2e72 656c 6174 6976  ivedelta.relativ
+0001f560: 6564 656c 7461 2879 6561 7273 3d31 290a  edelta(years=1).
+0001f570: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001f580: 2020 2020 2020 2020 2020 6772 705f 6d61            grp_ma
+0001f590: 785f 7369 7a65 203d 2074 696d 6564 656c  x_size = timedel
+0001f5a0: 7461 2864 6179 733d 3330 290a 2020 2020  ta(days=30).    
+0001f5b0: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
+0001f5c0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0001f5d0: 222d 2067 7270 5f6d 6178 5f73 697a 6520  "- grp_max_size 
+0001f5e0: 3d22 2c20 6772 705f 6d61 785f 7369 7a65  =", grp_max_size
+0001f5f0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
+0001f600: 696e 2072 616e 6765 2831 2c20 6c65 6e28  in range(1, len(
+0001f610: 6474 735f 746f 5f72 6570 6169 7229 293a  dts_to_repair)):
+0001f620: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+0001f630: 6e64 203d 2069 6e64 6963 6573 5f74 6f5f  nd = indices_to_
+0001f640: 7265 7061 6972 5b69 5d0a 2020 2020 2020  repair[i].      
+0001f650: 2020 2020 2020 6474 203d 2064 7473 5f74        dt = dts_t
+0001f660: 6f5f 7265 7061 6972 5b69 5d0a 2020 2020  o_repair[i].    
+0001f670: 2020 2020 2020 2020 6966 2064 742e 6461          if dt.da
+0001f680: 7465 2829 203c 2064 7473 5f67 726f 7570  te() < dts_group
+0001f690: 735b 2d31 5d5b 305d 2e64 6174 6528 292b  s[-1][0].date()+
+0001f6a0: 6772 705f 6d61 785f 7369 7a65 3a0a 2020  grp_max_size:.  
+0001f6b0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+0001f6c0: 735f 6772 6f75 7073 5b2d 315d 2e61 7070  s_groups[-1].app
+0001f6d0: 656e 6428 6474 290a 2020 2020 2020 2020  end(dt).        
+0001f6e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001f6f0: 2020 2020 2020 2020 2020 6474 735f 6772            dts_gr
+0001f700: 6f75 7073 2e61 7070 656e 6428 5b64 745d  oups.append([dt]
+0001f710: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0001f720: 6c61 7374 5f64 7420 3d20 6474 0a20 2020  last_dt = dt.   
+0001f730: 2020 2020 2020 2020 2023 206c 6173 745f           # last_
+0001f740: 696e 6420 3d20 696e 640a 0a20 2020 2020  ind = ind..     
+0001f750: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
+0001f760: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+0001f770: 5265 7061 6972 2067 726f 7570 733a 2229  Repair groups:")
+0001f780: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001f790: 2067 2069 6e20 6474 735f 6772 6f75 7073   g in dts_groups
+0001f7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f7b0: 2020 7072 696e 7428 6622 2d20 7b67 5b30    print(f"- {g[0
+0001f7c0: 5d7d 202d 3e20 7b67 5b2d 315d 7d22 290a  ]} -> {g[-1]}").
+0001f7d0: 0a20 2020 2020 2020 2023 2041 6464 2073  .        # Add s
+0001f7e0: 6f6d 6520 676f 6f64 2064 6174 6120 746f  ome good data to
+0001f7f0: 2065 6163 6820 6772 6f75 702c 2073 6f20   each group, so 
+0001f800: 6361 6e20 6361 6c69 6272 6174 6520 6c61  can calibrate la
+0001f810: 7465 723a 0a20 2020 2020 2020 2023 2066  ter:.        # f
+0001f820: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+0001f830: 6e28 6474 735f 6772 6f75 7073 2929 3a0a  n(dts_groups)):.
+0001f840: 2020 2020 2020 2020 2320 2020 2020 6720          #     g 
+0001f850: 3d20 6474 735f 6772 6f75 7073 5b69 5d0a  = dts_groups[i].
+0001f860: 2020 2020 2020 2020 2320 2020 2020 6730          #     g0
+0001f870: 203d 2067 5b30 5d0a 2020 2020 2020 2020   = g[0].        
+0001f880: 2320 2020 2020 6930 203d 2064 665f 676f  #     i0 = df_go
+0001f890: 6f64 2e69 6e64 6578 2e67 6574 5f6c 6f63  od.index.get_loc
+0001f8a0: 2867 3029 0a20 2020 2020 2020 2023 2020  (g0).        #  
+0001f8b0: 2020 2069 6620 6930 203e 2030 3a0a 2020     if i0 > 0:.  
+0001f8c0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+0001f8d0: 6474 735f 6772 6f75 7073 5b69 5d2e 696e  dts_groups[i].in
+0001f8e0: 7365 7274 2830 2c20 6466 5f67 6f6f 642e  sert(0, df_good.
+0001f8f0: 696e 6465 785b 6930 2d31 5d29 0a20 2020  index[i0-1]).   
+0001f900: 2020 2020 2023 2020 2020 2067 6c20 3d20       #     gl = 
+0001f910: 675b 2d31 5d0a 2020 2020 2020 2020 2320  g[-1].        # 
+0001f920: 2020 2020 696c 203d 2064 665f 676f 6f64      il = df_good
+0001f930: 2e69 6e64 6578 2e67 6574 5f6c 6f63 2867  .index.get_loc(g
+0001f940: 6c29 0a20 2020 2020 2020 2023 2020 2020  l).        #    
+0001f950: 2069 6620 696c 203c 206c 656e 2864 665f   if il < len(df_
+0001f960: 676f 6f64 292d 313a 0a20 2020 2020 2020  good)-1:.       
+0001f970: 2023 2020 2020 2020 2020 2064 7473 5f67   #         dts_g
+0001f980: 726f 7570 735b 695d 2e61 7070 656e 6428  roups[i].append(
+0001f990: 6466 5f67 6f6f 642e 696e 6465 785b 696c  df_good.index[il
+0001f9a0: 2b31 5d29 0a20 2020 2020 2020 2066 6f72  +1]).        for
+0001f9b0: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+0001f9c0: 6474 735f 6772 6f75 7073 2929 3a0a 2020  dts_groups)):.  
+0001f9d0: 2020 2020 2020 2020 2020 6720 3d20 6474            g = dt
+0001f9e0: 735f 6772 6f75 7073 5b69 5d0a 2020 2020  s_groups[i].    
+0001f9f0: 2020 2020 2020 2020 6730 203d 2067 5b30          g0 = g[0
+0001fa00: 5d0a 2020 2020 2020 2020 2020 2020 6930  ].            i0
+0001fa10: 203d 2064 665f 676f 6f64 2e69 6e64 6578   = df_good.index
+0001fa20: 2e67 6574 5f69 6e64 6578 6572 285b 6730  .get_indexer([g0
+0001fa30: 5d2c 206d 6574 686f 643d 226e 6561 7265  ], method="neare
+0001fa40: 7374 2229 5b30 5d0a 2020 2020 2020 2020  st")[0].        
+0001fa50: 2020 2020 6966 2069 3020 3e20 303a 0a20      if i0 > 0:. 
+0001fa60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001fa70: 6620 286d 696e 5f64 7420 6973 204e 6f6e  f (min_dt is Non
+0001fa80: 6520 6f72 2064 665f 676f 6f64 2e69 6e64  e or df_good.ind
+0001fa90: 6578 5b69 302d 315d 203e 3d20 6d69 6e5f  ex[i0-1] >= min_
+0001faa0: 6474 2920 5c0a 2020 2020 2020 2020 2020  dt) \.          
+0001fab0: 2020 2020 2020 2020 2020 616e 6420 2828            and ((
+0001fac0: 6e6f 7420 7365 6c66 2e69 6e74 7261 6461  not self.intrada
+0001fad0: 7929 206f 7220 6466 5f67 6f6f 642e 696e  y) or df_good.in
+0001fae0: 6465 785b 6930 2d31 5d2e 6461 7465 2829  dex[i0-1].date()
+0001faf0: 203d 3d20 6730 2e64 6174 6528 2929 3a0a   == g0.date()):.
+0001fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb10: 2020 2020 6930 202d 3d20 310a 2020 2020      i0 -= 1.    
+0001fb20: 2020 2020 2020 2020 676c 203d 2067 5b2d          gl = g[-
+0001fb30: 315d 0a20 2020 2020 2020 2020 2020 2069  1].            i
+0001fb40: 6c20 3d20 6466 5f67 6f6f 642e 696e 6465  l = df_good.inde
+0001fb50: 782e 6765 745f 696e 6465 7865 7228 5b67  x.get_indexer([g
+0001fb60: 6c5d 2c20 6d65 7468 6f64 3d22 6e65 6172  l], method="near
+0001fb70: 6573 7422 295b 305d 0a20 2020 2020 2020  est")[0].       
+0001fb80: 2020 2020 2069 6620 696c 203c 206c 656e       if il < len
+0001fb90: 2864 665f 676f 6f64 292d 313a 0a20 2020  (df_good)-1:.   
+0001fba0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001fbb0: 286e 6f74 2073 656c 662e 696e 7472 6164  (not self.intrad
+0001fbc0: 6179 2920 6f72 2064 665f 676f 6f64 2e69  ay) or df_good.i
+0001fbd0: 6e64 6578 5b69 6c2b 315d 2e64 6174 6528  ndex[il+1].date(
+0001fbe0: 2920 3d3d 2067 6c2e 6461 7465 2829 3a0a  ) == gl.date():.
+0001fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fc00: 2020 2020 696c 202b 3d20 310a 2020 2020      il += 1.    
+0001fc10: 2020 2020 2020 2020 676f 6f64 5f64 7473          good_dts
+0001fc20: 203d 2064 665f 676f 6f64 2e69 6e64 6578   = df_good.index
+0001fc30: 5b69 303a 696c 2b31 5d0a 2020 2020 2020  [i0:il+1].      
+0001fc40: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
+0001fc50: 5b69 5d20 2b3d 2067 6f6f 645f 6474 732e  [i] += good_dts.
+0001fc60: 746f 5f6c 6973 7428 290a 2020 2020 2020  to_list().      
+0001fc70: 2020 2020 2020 6474 735f 6772 6f75 7073        dts_groups
+0001fc80: 5b69 5d2e 736f 7274 2829 0a0a 2020 2020  [i].sort()..    
+0001fc90: 2020 2020 6e5f 6669 7865 6420 3d20 300a      n_fixed = 0.
+0001fca0: 2020 2020 2020 2020 666f 7220 6720 696e          for g in
+0001fcb0: 2064 7473 5f67 726f 7570 733a 0a20 2020   dts_groups:.   
+0001fcc0: 2020 2020 2020 2020 2064 665f 626c 6f63           df_bloc
+0001fcd0: 6b20 3d20 6466 5b64 662e 696e 6465 782e  k = df[df.index.
+0001fce0: 6973 696e 2867 295d 0a0a 2020 2020 2020  isin(g)]..      
+0001fcf0: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
 0001fd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd10: 2020 2020 2020 2020 2072 6563 6f6e 7374           reconst
-0001fd20: 7275 6374 5f64 6574 6563 7465 6420 3d20  ruct_detected = 
-0001fd30: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd50: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
-0001fd60: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0001fd70: 636f 6e73 7472 7563 745f 6465 7465 6374  construct_detect
-0001fd80: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0001fd90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001fda0: 2e5f 696e 6669 6e69 7465 5f72 6563 7572  ._infinite_recur
-0001fdb0: 7369 6f6e 5f64 6574 6563 7465 6420 3d20  sion_detected = 
-0001fdc0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001fdd0: 2020 2020 2073 656c 662e 5f73 7461 636b       self._stack
-0001fde0: 5f74 7261 6365 2e61 7070 656e 6428 666e  _trace.append(fn
-0001fdf0: 5f74 7570 6c65 290a 0a20 2020 2020 2020  _tuple)..       
-0001fe00: 2020 2020 2023 2049 6e66 696e 6974 6520       # Infinite 
-0001fe10: 6c6f 6f70 2070 6f74 656e 7469 616c 2068  loop potential h
-0001fe20: 6572 6520 7669 6120 7265 7061 6972 3a0a  ere via repair:.
-0001fe30: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
-0001fe40: 7265 7175 6573 7420 6669 6e65 2d67 7261  request fine-gra
-0001fe50: 696e 6564 2064 6174 6120 652e 672e 2031  ined data e.g. 1
-0001fe60: 480a 2020 2020 2020 2020 2020 2020 2320  H.            # 
-0001fe70: 2d20 3148 2072 6571 7569 7265 7320 6163  - 1H requires ac
-0001fe80: 6375 7261 7465 2064 6976 6964 656e 6420  curate dividend 
-0001fe90: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-0001fea0: 2023 202d 2074 7269 6767 6572 7320 6665   # - triggers fe
-0001feb0: 7463 6820 6f66 2031 4420 6461 7461 2077  tch of 1D data w
-0001fec0: 6869 6368 206d 7573 7420 6265 206b 6570  hich must be kep
-0001fed0: 7420 636f 6e74 6967 756f 7573 0a20 2020  t contiguous.   
-0001fee0: 2020 2020 2020 2020 2023 202d 2074 7269           # - tri
-0001fef0: 6767 6572 7320 6665 7463 6820 6f66 206f  ggers fetch of o
-0001ff00: 6c64 6572 2031 4420 6461 7461 2077 6869  lder 1D data whi
-0001ff10: 6368 2072 6571 7569 7265 7320 7265 7061  ch requires repa
-0001ff20: 6972 2075 7369 6e67 2031 4820 6461 7461  ir using 1H data
-0001ff30: 202d 3e20 7265 6375 7273 696f 6e20 6c6f   -> recursion lo
-0001ff40: 6f70 0a20 2020 2020 2020 2020 2020 2023  op.            #
-0001ff50: 2053 6f6c 7574 696f 6e3a 0a20 2020 2020   Solution:.     
-0001ff60: 2020 2020 2020 2023 2031 2920 6164 6420         # 1) add 
-0001ff70: 7475 706c 6520 746f 2066 6e20 7374 6163  tuple to fn stac
-0001ff80: 6b20 6275 7920 7769 7468 2059 463d 5472  k buy with YF=Tr
-0001ff90: 7565 0a20 2020 2020 2020 2020 2020 2023  ue.            #
-0001ffa0: 2032 2920 6966 2074 6861 7420 7475 706c   2) if that tupl
-0001ffb0: 6520 616c 7265 6164 7920 696e 2073 7461  e already in sta
-0001ffc0: 636b 2074 6865 6e20 7261 6973 6520 4578  ck then raise Ex
-0001ffd0: 6365 7074 696f 6e0a 2020 2020 2020 2020  ception.        
-0001ffe0: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
-0001fff0: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
-00020000: 6572 7661 6c2e 5765 656b 3a0a 2020 2020  erval.Week:.    
-00020010: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
-00020020: 685f 7374 6172 7420 3d20 7374 6172 745f  h_start = start_
-00020030: 6420 2d20 7464 5f72 616e 6765 2020 2320  d - td_range  # 
-00020040: 6e65 6564 2070 7265 7669 6f75 7320 7765  need previous we
-00020050: 656b 2074 6f6f 0a20 2020 2020 2020 2020  ek too.         
-00020060: 2020 2020 2020 2066 6574 6368 5f65 6e64         fetch_end
-00020070: 203d 2067 5b2d 315d 2e64 6174 6528 2920   = g[-1].date() 
-00020080: 2b20 7464 5f72 616e 6765 0a20 2020 2020  + td_range.     
-00020090: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-000200a0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-000200b0: 642e 496e 7465 7276 616c 2e44 6179 7331  d.Interval.Days1
-000200c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000200d0: 2020 6665 7463 685f 7374 6172 7420 3d20    fetch_start = 
-000200e0: 7374 6172 745f 640a 2020 2020 2020 2020  start_d.        
-000200f0: 2020 2020 2020 2020 6665 7463 685f 656e          fetch_en
-00020100: 6420 3d20 675b 2d31 5d2e 6461 7465 2829  d = g[-1].date()
-00020110: 202b 2074 645f 7261 6e67 650a 2020 2020   + td_range.    
-00020120: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00020130: 2020 2020 2020 2020 2020 2020 2020 6665                fe
-00020140: 7463 685f 7374 6172 7420 3d20 675b 305d  tch_start = g[0]
-00020150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020160: 2066 6574 6368 5f65 6e64 203d 2067 5b2d   fetch_end = g[-
-00020170: 315d 202b 2074 645f 7261 6e67 650a 2020  1] + td_range.  
-00020180: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-00020190: 7428 6622 6665 7463 685f 7374 6172 743d  t(f"fetch_start=
-000201a0: 7b66 6574 6368 5f73 7461 7274 7d20 6665  {fetch_start} fe
-000201b0: 7463 685f 656e 643d 7b66 6574 6368 5f65  tch_end={fetch_e
-000201c0: 6e64 7d22 290a 0a20 2020 2020 2020 2020  nd}")..         
-000201d0: 2020 2023 2070 7265 706f 7374 203d 2073     # prepost = s
-000201e0: 656c 662e 696e 7465 7276 616c 203d 3d20  elf.interval == 
-000201f0: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
-00020200: 7973 310a 2020 2020 2020 2020 2020 2020  ys1.            
-00020210: 7072 6570 6f73 7420 3d20 7365 6c66 2e69  prepost = self.i
-00020220: 6e74 6572 6461 790a 2020 2020 2020 2020  nterday.        
-00020230: 2020 2020 6966 2064 6562 7567 3a0a 2020      if debug:.  
-00020240: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00020250: 696e 7428 6622 2d20 6665 7463 685f 7374  int(f"- fetch_st
-00020260: 6172 743d 7b66 6574 6368 5f73 7461 7274  art={fetch_start
-00020270: 7d2c 2066 6574 6368 5f65 6e64 3d7b 6665  }, fetch_end={fe
-00020280: 7463 685f 656e 647d 2070 7265 706f 7374  tch_end} prepost
-00020290: 3d7b 7072 6570 6f73 747d 2229 0a20 2020  ={prepost}").   
-000202a0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000202b0: 2e5f 696e 6669 6e69 7465 5f72 6563 7572  ._infinite_recur
-000202c0: 7369 6f6e 5f64 6574 6563 7465 643a 0a20  sion_detected:. 
-000202d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000202e0: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-000202f0: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
-00020300: 6163 6529 293a 0a20 2020 2020 2020 2020  ace)):.         
-00020310: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00020320: 2822 2020 222a 6920 2b20 7374 7228 7365  ("  "*i + str(se
-00020330: 6c66 2e5f 7374 6163 6b5f 7472 6163 655b  lf._stack_trace[
-00020340: 695d 2929 0a20 2020 2020 2020 2020 2020  i])).           
-00020350: 2020 2020 2072 6169 7365 2045 7863 6570       raise Excep
-00020360: 7469 6f6e 2822 5741 524e 494e 473a 2049  tion("WARNING: I
-00020370: 6e66 696e 6974 6520 7265 6375 7273 696f  nfinite recursio
-00020380: 6e20 6465 7465 6374 6564 2028 7365 6520  n detected (see 
-00020390: 7374 6163 6b20 7472 6163 6520 6162 6f76  stack trace abov
-000203a0: 6529 2e20 5377 6974 6368 2074 6f20 6665  e). Switch to fe
-000203b0: 7463 6869 6e67 2070 7269 6365 7320 6469  tching prices di
-000203c0: 7265 6374 2066 726f 6d20 5946 2229 0a20  rect from YF"). 
-000203d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000203e0: 7269 6e74 2822 5741 524e 494e 473a 2049  rint("WARNING: I
-000203f0: 6e66 696e 6974 6520 7265 6375 7273 696f  nfinite recursio
-00020400: 6e20 6465 7465 6374 6564 2028 7365 6520  n detected (see 
-00020410: 7374 6163 6b20 7472 6163 6520 6162 6f76  stack trace abov
-00020420: 6529 2e20 5377 6974 6368 2074 6f20 6665  e). Switch to fe
-00020430: 7463 6869 6e67 2070 7269 6365 7320 6469  tching prices di
-00020440: 7265 6374 2066 726f 6d20 5946 2229 0a20  rect from YF"). 
-00020450: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00020460: 2064 665f 6669 6e65 203d 2073 656c 662e   df_fine = self.
-00020470: 6461 742e 6869 7374 6f72 7928 7374 6172  dat.history(star
-00020480: 743d 6665 7463 685f 7374 6172 742c 2065  t=fetch_start, e
-00020490: 6e64 3d66 6574 6368 5f65 6e64 2c20 696e  nd=fetch_end, in
-000204a0: 7465 7276 616c 3d79 6663 642e 696e 7465  terval=yfcd.inte
-000204b0: 7276 616c 546f 5374 7269 6e67 5b73 7562  rvalToString[sub
-000204c0: 5f69 6e74 6572 7661 6c5d 2c20 6175 746f  _interval], auto
-000204d0: 5f61 646a 7573 743d 4661 6c73 652c 2070  _adjust=False, p
-000204e0: 7265 706f 7374 3d70 7265 706f 7374 2c20  repost=prepost, 
-000204f0: 6b65 6570 6e61 3d54 7275 6529 0a20 2020  keepna=True).   
-00020500: 2020 2020 2020 2020 2023 2065 6c69 6620           # elif 
-00020510: 7365 6c66 2e69 6e74 6572 7661 6c20 696e  self.interval in
-00020520: 205b 7966 6364 2e49 6e74 6572 7661 6c2e   [yfcd.Interval.
-00020530: 4461 7973 315d 3a20 2023 206f 7220 7365  Days1]:  # or se
-00020540: 6c66 2e5f 696e 6669 6e69 7465 5f72 6563  lf._infinite_rec
-00020550: 7572 7369 6f6e 5f64 6574 6563 7465 643a  ursion_detected:
-00020560: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00020570: 2020 2023 2041 7373 756d 6520 696e 6669     # Assume infi
-00020580: 6e69 7465 2072 6563 7572 7369 6f6e 2077  nite recursion w
-00020590: 696c 6c20 6861 7070 656e 0a20 2020 2020  ill happen.     
-000205a0: 2020 2020 2020 2023 2020 2020 2064 665f         #     df_
-000205b0: 6669 6e65 203d 2073 656c 662e 6461 742e  fine = self.dat.
-000205c0: 6869 7374 6f72 7928 7374 6172 743d 6665  history(start=fe
-000205d0: 7463 685f 7374 6172 742c 2065 6e64 3d66  tch_start, end=f
-000205e0: 6574 6368 5f65 6e64 2c20 696e 7465 7276  etch_end, interv
-000205f0: 616c 3d79 6663 642e 696e 7465 7276 616c  al=yfcd.interval
-00020600: 546f 5374 7269 6e67 5b73 7562 5f69 6e74  ToString[sub_int
-00020610: 6572 7661 6c5d 2c20 6175 746f 5f61 646a  erval], auto_adj
-00020620: 7573 743d 4661 6c73 652c 2072 6570 6169  ust=False, repai
-00020630: 723d 2273 696c 656e 7422 290a 2020 2020  r="silent").    
-00020640: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00020650: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00020660: 2070 7265 706f 7374 2061 6e64 2073 7562   prepost and sub
-00020670: 5f69 6e74 7261 6461 793a 0a20 2020 2020  _intraday:.     
-00020680: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00020690: 2059 4643 2063 616e 6e6f 7420 6861 6e64   YFC cannot hand
-000206a0: 6c65 2069 6e74 7261 6461 7920 7072 652d  le intraday pre-
-000206b0: 2061 6e64 2070 6f73 742d 6d61 726b 6574   and post-market
-000206c0: 2c20 736f 2066 6574 6368 2076 6961 2079  , so fetch via y
-000206d0: 6669 6e61 6e63 650a 2020 2020 2020 2020  finance.        
-000206e0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-000206f0: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
-00020700: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00020710: 7072 696e 7428 222d 2066 6574 6368 696e  print("- fetchin
-00020720: 6720 6466 5f66 696e 6520 6469 7265 6374  g df_fine direct
-00020730: 2066 726f 6d20 5946 2229 0a20 2020 2020   from YF").     
-00020740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020750: 2020 2070 7269 6e74 2866 222d 202d 2066     print(f"- - f
-00020760: 6574 6368 5f73 7461 7274 3d7b 6665 7463  etch_start={fetc
-00020770: 685f 7374 6172 747d 2066 6574 6368 5f65  h_start} fetch_e
-00020780: 6e64 3d7b 6665 7463 685f 656e 647d 2229  nd={fetch_end}")
-00020790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000207a0: 2020 2020 2064 665f 6669 6e65 5f6f 6c64       df_fine_old
-000207b0: 203d 2073 656c 662e 6461 742e 6869 7374   = self.dat.hist
-000207c0: 6f72 7928 7374 6172 743d 6665 7463 685f  ory(start=fetch_
-000207d0: 7374 6172 742c 2065 6e64 3d66 6574 6368  start, end=fetch
-000207e0: 5f65 6e64 2c20 696e 7465 7276 616c 3d79  _end, interval=y
-000207f0: 6663 642e 696e 7465 7276 616c 546f 5374  fcd.intervalToSt
-00020800: 7269 6e67 5b73 7562 5f69 6e74 6572 7661  ring[sub_interva
-00020810: 6c5d 2c20 6175 746f 5f61 646a 7573 743d  l], auto_adjust=
-00020820: 5472 7565 2c20 7072 6570 6f73 743d 7072  True, prepost=pr
-00020830: 6570 6f73 7429 0a20 2020 2020 2020 2020  epost).         
-00020840: 2020 2020 2020 2020 2020 2068 6973 745f             hist_
-00020850: 7375 6220 3d20 7365 6c66 2e6d 616e 6167  sub = self.manag
-00020860: 6572 2e47 6574 4869 7374 6f72 7928 7375  er.GetHistory(su
-00020870: 625f 696e 7465 7276 616c 290a 2020 2020  b_interval).    
-00020880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020890: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-000208a0: 6528 6665 7463 685f 7374 6172 742c 2064  e(fetch_start, d
-000208b0: 6174 6574 696d 6529 3a0a 2020 2020 2020  atetime):.      
-000208c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000208d0: 2020 6665 7463 685f 7374 6172 7420 3d20    fetch_start = 
-000208e0: 6461 7465 7469 6d65 2e63 6f6d 6269 6e65  datetime.combine
-000208f0: 2866 6574 6368 5f73 7461 7274 2c20 7469  (fetch_start, ti
-00020900: 6d65 2830 292c 205a 6f6e 6549 6e66 6f28  me(0), ZoneInfo(
-00020910: 7365 6c66 2e74 7a4e 616d 6529 290a 2020  self.tzName)).  
-00020920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020930: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-00020940: 6e63 6528 6665 7463 685f 656e 642c 2064  nce(fetch_end, d
-00020950: 6174 6574 696d 6529 3a0a 2020 2020 2020  atetime):.      
-00020960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020970: 2020 6665 7463 685f 656e 6420 3d20 6461    fetch_end = da
-00020980: 7465 7469 6d65 2e63 6f6d 6269 6e65 2866  tetime.combine(f
-00020990: 6574 6368 5f65 6e64 2c20 7469 6d65 2830  etch_end, time(0
-000209a0: 292c 205a 6f6e 6549 6e66 6f28 7365 6c66  ), ZoneInfo(self
-000209b0: 2e74 7a4e 616d 6529 290a 2020 2020 2020  .tzName)).      
-000209c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000209d0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-000209e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000209f0: 7072 696e 7428 222d 2066 6574 6368 696e  print("- fetchin
-00020a00: 6720 6466 5f66 696e 6520 7669 6120 5f66  g df_fine via _f
-00020a10: 6574 6368 5966 4869 7374 6f72 7928 2920  etchYfHistory() 
-00020a20: 7772 6170 7065 7222 290a 2020 2020 2020  wrapper").      
-00020a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a40: 2020 7072 696e 7428 6622 2d20 2d20 6665    print(f"- - fe
-00020a50: 7463 685f 7374 6172 743d 7b66 6574 6368  tch_start={fetch
-00020a60: 5f73 7461 7274 7d20 6665 7463 685f 656e  _start} fetch_en
-00020a70: 643d 7b66 6574 6368 5f65 6e64 7d22 290a  d={fetch_end}").
-00020a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00020aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ab0: 2064 665f 6669 6e65 203d 2068 6973 745f   df_fine = hist_
-00020ac0: 7375 622e 5f66 6574 6368 5966 4869 7374  sub._fetchYfHist
-00020ad0: 6f72 7928 7073 7472 3d4e 6f6e 652c 2073  ory(pstr=None, s
-00020ae0: 7461 7274 3d66 6574 6368 5f73 7461 7274  tart=fetch_start
-00020af0: 2c20 656e 643d 6665 7463 685f 656e 642c  , end=fetch_end,
-00020b00: 2070 7265 706f 7374 3d70 7265 706f 7374   prepost=prepost
-00020b10: 2c20 6465 6275 673d 4661 6c73 652c 2076  , debug=False, v
-00020b20: 6572 6966 795f 696e 7465 7276 616c 733d  erify_intervals=
-00020b30: 4661 6c73 652c 2064 6973 6162 6c65 5f79  False, disable_y
-00020b40: 6663 5f6d 6574 6164 6174 613d 5472 7565  fc_metadata=True
-00020b50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00020b60: 2020 2020 2020 6578 6365 7074 2079 6663        except yfc
-00020b70: 642e 4e6f 5072 6963 6544 6174 6149 6e52  d.NoPriceDataInR
-00020b80: 616e 6765 4578 6365 7074 696f 6e20 6173  angeException as
-00020b90: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00020ba0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00020bb0: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
-00020bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020bd0: 2020 7072 696e 7428 222d 2066 6574 6368    print("- fetch
-00020be0: 206f 6620 6669 6e65 2070 7269 6365 2064   of fine price d
-00020bf0: 6174 6120 6661 696c 6564 3a22 202b 2073  ata failed:" + s
-00020c00: 7472 2865 2929 0a20 2020 2020 2020 2020  tr(e)).         
-00020c10: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00020c20: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00020c30: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00020c40: 665f 6669 6e65 2069 7320 6e6f 7420 4e6f  f_fine is not No
-00020c50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00020c60: 2020 2020 2020 2020 2020 2020 6164 6a20              adj 
-00020c70: 3d20 2864 665f 6669 6e65 5b22 4164 6a20  = (df_fine["Adj 
-00020c80: 436c 6f73 6522 5d2f 6466 5f66 696e 655b  Close"]/df_fine[
-00020c90: 2243 6c6f 7365 225d 292e 746f 5f6e 756d  "Close"]).to_num
-00020ca0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
-00020cb0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00020cc0: 2063 2069 6e20 5b22 4f70 656e 222c 2022   c in ["Open", "
-00020cd0: 4c6f 7722 2c20 2248 6967 6822 2c20 2243  Low", "High", "C
-00020ce0: 6c6f 7365 225d 3a0a 2020 2020 2020 2020  lose"]:.        
-00020cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d00: 2020 2020 6466 5f66 696e 655b 635d 202a      df_fine[c] *
-00020d10: 3d20 6164 6a0a 2020 2020 2020 2020 2020  = adj.          
-00020d20: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00020d30: 5f66 696e 6520 3d20 6466 5f66 696e 655b  _fine = df_fine[
-00020d40: 5b22 4f70 656e 222c 2022 4c6f 7722 2c20  ["Open", "Low", 
-00020d50: 2248 6967 6822 2c20 2243 6c6f 7365 222c  "High", "Close",
-00020d60: 2022 566f 6c75 6d65 222c 2022 4469 7669   "Volume", "Divi
-00020d70: 6465 6e64 7322 2c20 2253 746f 636b 2053  dends", "Stock S
-00020d80: 706c 6974 7322 5d5d 0a20 2020 2020 2020  plits"]].       
-00020d90: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00020da0: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-00020db0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00020dc0: 7269 6e74 2822 6466 5f66 696e 655f 6f6c  rint("df_fine_ol
-00020dd0: 643a 2229 0a20 2020 2020 2020 2020 2020  d:").           
-00020de0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00020df0: 6e74 2864 665f 6669 6e65 5f6f 6c64 290a  nt(df_fine_old).
-00020e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e10: 2020 2020 2020 2020 7072 696e 7428 2264          print("d
-00020e20: 665f 6669 6e65 3a22 290a 2020 2020 2020  f_fine:").      
-00020e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e40: 2020 7072 696e 7428 6466 5f66 696e 6529    print(df_fine)
-00020e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020e60: 2020 2020 2023 2072 6169 7365 2045 7863       # raise Exc
-00020e70: 6570 7469 6f6e 2822 6865 7265 2229 0a20  eption("here"). 
-00020e80: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00020e90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00020ea0: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
-00020eb0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00020ec0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00020ed0: 2822 2d20 6665 7463 6869 6e67 2064 665f  ("- fetching df_
-00020ee0: 6669 6e65 2076 6961 2059 4643 2229 0a20  fine via YFC"). 
-00020ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f00: 2020 2068 6973 745f 7375 6220 3d20 7365     hist_sub = se
-00020f10: 6c66 2e6d 616e 6167 6572 2e47 6574 4869  lf.manager.GetHi
-00020f20: 7374 6f72 7928 7375 625f 696e 7465 7276  story(sub_interv
-00020f30: 616c 290a 2020 2020 2020 2020 2020 2020  al).            
-00020f40: 2020 2020 2020 2020 6466 5f66 696e 6520          df_fine 
-00020f50: 3d20 6869 7374 5f73 7562 2e67 6574 2866  = hist_sub.get(f
-00020f60: 6574 6368 5f73 7461 7274 2c20 6665 7463  etch_start, fetc
-00020f70: 685f 656e 642c 2061 646a 7573 745f 7370  h_end, adjust_sp
-00020f80: 6c69 7473 3d46 616c 7365 2c20 6164 6a75  lits=False, adju
-00020f90: 7374 5f64 6976 733d 4661 6c73 652c 2072  st_divs=False, r
-00020fa0: 6570 6169 723d 4661 6c73 652c 2070 7265  epair=False, pre
-00020fb0: 706f 7374 3d70 7265 706f 7374 290a 2020  post=prepost).  
-00020fc0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00020fd0: 6466 5f66 696e 655b 2241 646a 2043 6c6f  df_fine["Adj Clo
-00020fe0: 7365 225d 203d 2064 665f 6669 6e65 5b22  se"] = df_fine["
-00020ff0: 436c 6f73 6522 5d20 2a20 6466 5f66 696e  Close"] * df_fin
-00021000: 655b 2243 4446 225d 0a20 2020 2020 2020  e["CDF"].       
-00021010: 2020 2020 2069 6620 6465 6275 673a 0a20       if debug:. 
-00021020: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00021030: 7269 6e74 2822 2d20 6466 5f66 696e 653a  rint("- df_fine:
-00021040: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00021050: 2020 2070 7269 6e74 2864 665f 6669 6e65     print(df_fine
-00021060: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00021070: 2064 665f 6669 6e65 2069 7320 4e6f 6e65   df_fine is None
-00021080: 206f 7220 6c65 6e28 6466 5f66 696e 6529   or len(df_fine)
-00021090: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-000210a0: 2020 2020 2020 2070 7269 6e74 2822 5946         print("YF
-000210b0: 3a20 5741 524e 494e 473a 2043 616e 6e6f  : WARNING: Canno
-000210c0: 7420 7265 636f 6e73 7472 7563 7420 6265  t reconstruct be
-000210d0: 6361 7573 6520 5961 686f 6f20 6e6f 7420  cause Yahoo not 
-000210e0: 7265 7475 726e 696e 6720 6461 7461 2069  returning data i
-000210f0: 6e20 696e 7465 7276 616c 2229 0a20 2020  n interval").   
-00021100: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00021110: 7365 6c66 2e5f 7265 636f 7264 5f73 7461  self._record_sta
-00021120: 636b 5f74 7261 6365 3a0a 2020 2020 2020  ck_trace:.      
-00021130: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00021140: 506f 7020 7374 6163 6b20 7472 6163 650a  Pop stack trace.
-00021150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021160: 2020 2020 6966 206c 656e 2873 656c 662e      if len(self.
-00021170: 5f73 7461 636b 5f74 7261 6365 2920 3d3d  _stack_trace) ==
-00021180: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00021190: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000211a0: 6520 4578 6365 7074 696f 6e28 2246 6169  e Exception("Fai
-000211b0: 6c69 6e67 2074 6f20 636f 7272 6563 746c  ling to correctl
-000211c0: 7920 7075 7368 2f70 6f70 2073 7461 636b  y push/pop stack
-000211d0: 2074 7261 6365 2028 6973 2065 6d70 7479   trace (is empty
-000211e0: 2074 6f6f 2065 6172 6c79 2922 290a 2020   too early)").  
-000211f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021200: 2020 6966 206e 6f74 2073 656c 662e 5f73    if not self._s
-00021210: 7461 636b 5f74 7261 6365 5b2d 315d 203d  tack_trace[-1] =
-00021220: 3d20 666e 5f74 7570 6c65 3a0a 2020 2020  = fn_tuple:.    
-00021230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021240: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00021250: 6765 286c 656e 2873 656c 662e 5f73 7461  ge(len(self._sta
-00021260: 636b 5f74 7261 6365 2929 3a0a 2020 2020  ck_trace)):.    
-00021270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021280: 2020 2020 2020 2020 7072 696e 7428 2220          print(" 
-00021290: 2022 2a69 202b 2073 7472 2873 656c 662e   "*i + str(self.
-000212a0: 5f73 7461 636b 5f74 7261 6365 5b69 5d29  _stack_trace[i])
-000212b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000212c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000212d0: 4578 6365 7074 696f 6e28 2246 6169 6c69  Exception("Faili
-000212e0: 6e67 2074 6f20 636f 7272 6563 746c 7920  ng to correctly 
-000212f0: 7075 7368 2f70 6f70 2073 7461 636b 2074  push/pop stack t
-00021300: 7261 6365 2028 7365 6520 6162 6f76 6529  race (see above)
-00021310: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-00021320: 2020 2020 2020 2073 656c 662e 5f73 7461         self._sta
-00021330: 636b 5f74 7261 6365 2e70 6f70 286c 656e  ck_trace.pop(len
-00021340: 2873 656c 662e 5f73 7461 636b 5f74 7261  (self._stack_tra
-00021350: 6365 2920 2d20 3129 0a20 2020 2020 2020  ce) - 1).       
-00021360: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00021370: 650a 0a20 2020 2020 2020 2020 2020 2064  e..            d
-00021380: 665f 6669 6e65 5b22 6374 7222 5d20 3d20  f_fine["ctr"] = 
-00021390: 300a 2020 2020 2020 2020 2020 2020 6966  0.            if
-000213a0: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
-000213b0: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
-000213c0: 5765 656b 3a0a 2020 2020 2020 2020 2020  Week:.          
-000213d0: 2020 2020 2020 2320 6466 5f66 696e 655b        # df_fine[
-000213e0: 2257 6565 6b20 5374 6172 7422 5d20 3d20  "Week Start"] = 
-000213f0: 6466 5f66 696e 652e 696e 6465 782e 747a  df_fine.index.tz
-00021400: 5f6c 6f63 616c 697a 6528 4e6f 6e65 292e  _localize(None).
-00021410: 746f 5f70 6572 696f 6428 2257 2d53 554e  to_period("W-SUN
-00021420: 2229 2e73 7461 7274 5f74 696d 650a 2020  ").start_time.  
-00021430: 2020 2020 2020 2020 2020 2020 2020 7765                we
-00021440: 656b 6461 7973 203d 205b 224d 4f4e 222c  ekdays = ["MON",
-00021450: 2022 5455 4522 2c20 2257 4544 222c 2022   "TUE", "WED", "
-00021460: 5448 5522 2c20 2246 5249 222c 2022 5341  THU", "FRI", "SA
-00021470: 5422 2c20 2253 554e 225d 0a20 2020 2020  T", "SUN"].     
-00021480: 2020 2020 2020 2020 2020 2077 6565 6b5f             week_
-00021490: 656e 645f 6461 7920 3d20 7765 656b 6461  end_day = weekda
-000214a0: 7973 5b28 6466 5f62 6c6f 636b 2e69 6e64  ys[(df_block.ind
-000214b0: 6578 5b30 5d2e 7765 656b 6461 7928 2920  ex[0].weekday() 
-000214c0: 2b20 3720 2d20 3129 2025 2037 5d0a 2020  + 7 - 1) % 7].  
-000214d0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000214e0: 5f66 696e 655b 2257 6565 6b20 5374 6172  _fine["Week Star
-000214f0: 7422 5d20 3d20 6466 5f66 696e 652e 696e  t"] = df_fine.in
-00021500: 6465 782e 747a 5f6c 6f63 616c 697a 6528  dex.tz_localize(
-00021510: 4e6f 6e65 292e 746f 5f70 6572 696f 6428  None).to_period(
-00021520: 2257 2d22 2b77 6565 6b5f 656e 645f 6461  "W-"+week_end_da
-00021530: 7929 2e73 7461 7274 5f74 696d 650a 2020  y).start_time.  
-00021540: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00021550: 705f 636f 6c20 3d20 2257 6565 6b20 5374  p_col = "Week St
-00021560: 6172 7422 0a20 2020 2020 2020 2020 2020  art".           
-00021570: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
-00021580: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
-00021590: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
-000215a0: 2020 2020 2020 2020 2020 2020 6466 5f66              df_f
-000215b0: 696e 655b 2244 6179 2053 7461 7274 225d  ine["Day Start"]
-000215c0: 203d 2070 642e 746f 5f64 6174 6574 696d   = pd.to_datetim
-000215d0: 6528 6466 5f66 696e 652e 696e 6465 782e  e(df_fine.index.
-000215e0: 6461 7465 290a 2020 2020 2020 2020 2020  date).          
-000215f0: 2020 2020 2020 6772 705f 636f 6c20 3d20        grp_col = 
-00021600: 2244 6179 2053 7461 7274 220a 2020 2020  "Day Start".    
-00021610: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00021620: 2020 2020 2020 2020 2020 2020 2020 6466                df
-00021630: 5f66 696e 652e 6c6f 635b 6466 5f66 696e  _fine.loc[df_fin
-00021640: 652e 696e 6465 782e 6973 696e 2864 665f  e.index.isin(df_
-00021650: 626c 6f63 6b2e 696e 6465 7829 2c20 2263  block.index), "c
-00021660: 7472 225d 203d 2031 0a20 2020 2020 2020  tr"] = 1.       
-00021670: 2020 2020 2020 2020 2064 665f 6669 6e65           df_fine
-00021680: 5b22 696e 7465 7276 616c 4944 225d 203d  ["intervalID"] =
-00021690: 2064 665f 6669 6e65 5b22 6374 7222 5d2e   df_fine["ctr"].
-000216a0: 6375 6d73 756d 2829 0a20 2020 2020 2020  cumsum().       
-000216b0: 2020 2020 2020 2020 2064 665f 6669 6e65           df_fine
-000216c0: 203d 2064 665f 6669 6e65 2e64 726f 7028   = df_fine.drop(
-000216d0: 2263 7472 222c 2061 7869 733d 3129 0a20  "ctr", axis=1). 
-000216e0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-000216f0: 7270 5f63 6f6c 203d 2022 696e 7465 7276  rp_col = "interv
-00021700: 616c 4944 220a 2020 2020 2020 2020 2020  alID".          
-00021710: 2020 2320 6466 5f66 696e 6520 3d20 6466    # df_fine = df
-00021720: 5f66 696e 655b 7e64 665f 6669 6e65 5b70  _fine[~df_fine[p
-00021730: 7269 6365 5f63 6f6c 735d 2e69 736e 6128  rice_cols].isna(
-00021740: 292e 616c 6c28 6178 6973 3d31 295d 0a0a  ).all(axis=1)]..
-00021750: 2020 2020 2020 2020 2020 2020 6466 5f6e              df_n
-00021760: 6577 203d 2064 665f 6669 6e65 2e67 726f  ew = df_fine.gro
-00021770: 7570 6279 2867 7270 5f63 6f6c 292e 6167  upby(grp_col).ag
-00021780: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00021790: 2020 204f 7065 6e3d 2822 4f70 656e 222c     Open=("Open",
-000217a0: 2022 6669 7273 7422 292c 0a20 2020 2020   "first"),.     
-000217b0: 2020 2020 2020 2020 2020 2043 6c6f 7365             Close
-000217c0: 3d28 2243 6c6f 7365 222c 2022 6c61 7374  =("Close", "last
-000217d0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-000217e0: 2020 2020 2320 4164 6a43 6c6f 7365 3d28      # AdjClose=(
-000217f0: 2241 646a 2043 6c6f 7365 222c 2022 6c61  "Adj Close", "la
-00021800: 7374 2229 2c0a 2020 2020 2020 2020 2020  st"),.          
-00021810: 2020 2020 2020 4c6f 773d 2822 4c6f 7722        Low=("Low"
-00021820: 2c20 226d 696e 2229 2c0a 2020 2020 2020  , "min"),.      
-00021830: 2020 2020 2020 2020 2020 4869 6768 3d28            High=(
-00021840: 2248 6967 6822 2c20 226d 6178 2229 2c0a  "High", "max"),.
-00021850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021860: 566f 6c75 6d65 3d28 2256 6f6c 756d 6522  Volume=("Volume"
-00021870: 2c20 2273 756d 2229 290a 2020 2020 2020  , "sum")).      
-00021880: 2020 2020 2020 2020 2020 2320 4353 463d            # CSF=
-00021890: 2822 4353 4622 2c20 2266 6972 7374 2229  ("CSF", "first")
-000218a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000218b0: 2020 2320 4344 463d 2822 4344 4622 2c20    # CDF=("CDF", 
-000218c0: 2266 6972 7374 2229 2923 2e72 656e 616d  "first"))#.renam
-000218d0: 6528 636f 6c75 6d6e 733d 7b22 4164 6a43  e(columns={"AdjC
-000218e0: 6c6f 7365 223a 2022 4164 6a20 436c 6f73  lose": "Adj Clos
-000218f0: 6522 7d29 0a20 2020 2020 2020 2020 2020  e"}).           
-00021900: 2069 6620 6772 705f 636f 6c20 696e 205b   if grp_col in [
-00021910: 2257 6565 6b20 5374 6172 7422 2c20 2244  "Week Start", "D
-00021920: 6179 2053 7461 7274 225d 3a0a 2020 2020  ay Start"]:.    
-00021930: 2020 2020 2020 2020 2020 2020 6466 5f6e              df_n
-00021940: 6577 2e69 6e64 6578 203d 2064 665f 6e65  ew.index = df_ne
-00021950: 772e 696e 6465 782e 747a 5f6c 6f63 616c  w.index.tz_local
-00021960: 697a 6528 6466 5f66 696e 652e 696e 6465  ize(df_fine.inde
-00021970: 782e 747a 290a 2020 2020 2020 2020 2020  x.tz).          
-00021980: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00021990: 2020 2020 2020 2020 6466 5f66 696e 655b          df_fine[
-000219a0: 2264 6966 6622 5d20 3d20 6466 5f66 696e  "diff"] = df_fin
-000219b0: 655b 2269 6e74 6572 7661 6c49 4422 5d2e  e["intervalID"].
-000219c0: 6469 6666 2829 0a20 2020 2020 2020 2020  diff().         
-000219d0: 2020 2020 2020 206e 6577 5f69 6e64 6578         new_index
-000219e0: 203d 206e 702e 6170 7065 6e64 285b 6466   = np.append([df
-000219f0: 5f66 696e 652e 696e 6465 785b 305d 5d2c  _fine.index[0]],
-00021a00: 2064 665f 6669 6e65 2e69 6e64 6578 5b64   df_fine.index[d
-00021a10: 665f 6669 6e65 5b22 696e 7465 7276 616c  f_fine["interval
-00021a20: 4944 225d 2e64 6966 6628 2920 3e20 305d  ID"].diff() > 0]
-00021a30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00021a40: 2020 6466 5f6e 6577 2e69 6e64 6578 203d    df_new.index =
-00021a50: 206e 6577 5f69 6e64 6578 0a0a 2020 2020   new_index..    
-00021a60: 2020 2020 2020 2020 2320 4361 6c69 6272          # Calibr
-00021a70: 6174 6521 2043 6865 636b 2077 6865 7468  ate! Check wheth
-00021a80: 6572 2027 6466 5f66 696e 6527 2068 6173  er 'df_fine' has
-00021a90: 2064 6966 6665 7265 6e74 2073 706c 6974   different split
-00021aa0: 2d61 646a 7573 746d 656e 742e 0a20 2020  -adjustment..   
-00021ab0: 2020 2020 2020 2020 2023 2049 6620 6469           # If di
-00021ac0: 6666 6572 656e 742c 2074 6865 6e20 6164  fferent, then ad
-00021ad0: 6a75 7374 2074 6f20 6d61 7463 6820 2764  just to match 'd
-00021ae0: 6627 0a20 2020 2020 2020 2020 2020 2064  f'.            d
-00021af0: 665f 626c 6f63 6b5f 6361 6c69 6220 3d20  f_block_calib = 
-00021b00: 6466 5f62 6c6f 636b 5b70 7269 6365 5f63  df_block[price_c
-00021b10: 6f6c 735d 0a20 2020 2020 2020 2020 2020  ols].           
-00021b20: 2023 2064 665f 6e65 775f 6361 6c69 6220   # df_new_calib 
-00021b30: 3d20 6466 5f6e 6577 5b64 665f 6e65 772e  = df_new[df_new.
-00021b40: 696e 6465 782e 6973 696e 2864 665f 626c  index.isin(df_bl
-00021b50: 6f63 6b5f 6361 6c69 622e 696e 6465 7829  ock_calib.index)
-00021b60: 5d5b 7072 6963 655f 636f 6c73 5d0a 2020  ][price_cols].  
-00021b70: 2020 2020 2020 2020 2020 2320 6466 5f62            # df_b
-00021b80: 6c6f 636b 5f63 616c 6962 203d 2064 665f  lock_calib = df_
-00021b90: 626c 6f63 6b5f 6361 6c69 625b 6466 5f62  block_calib[df_b
-00021ba0: 6c6f 636b 5f63 616c 6962 2e69 6e64 6578  lock_calib.index
-00021bb0: 2e69 7369 6e28 6466 5f6e 6577 5f63 616c  .isin(df_new_cal
-00021bc0: 6962 295d 0a20 2020 2020 2020 2020 2020  ib)].           
-00021bd0: 2063 6f6d 6d6f 6e5f 696e 6465 7820 3d20   common_index = 
-00021be0: 6e70 2e69 6e74 6572 7365 6374 3164 2864  np.intersect1d(d
-00021bf0: 665f 626c 6f63 6b5f 6361 6c69 622e 696e  f_block_calib.in
-00021c00: 6465 782c 2064 665f 6e65 772e 696e 6465  dex, df_new.inde
-00021c10: 7829 0a20 2020 2020 2020 2020 2020 2064  x).            d
-00021c20: 665f 6e65 775f 6361 6c69 6220 3d20 6466  f_new_calib = df
-00021c30: 5f6e 6577 5b70 7269 6365 5f63 6f6c 735d  _new[price_cols]
-00021c40: 2e6c 6f63 5b63 6f6d 6d6f 6e5f 696e 6465  .loc[common_inde
-00021c50: 785d 0a20 2020 2020 2020 2020 2020 2064  x].            d
-00021c60: 665f 626c 6f63 6b5f 6361 6c69 6220 3d20  f_block_calib = 
-00021c70: 6466 5f62 6c6f 636b 5f63 616c 6962 2e6c  df_block_calib.l
-00021c80: 6f63 5b63 6f6d 6d6f 6e5f 696e 6465 785d  oc[common_index]
-00021c90: 0a20 2020 2020 2020 2020 2020 2063 616c  .            cal
-00021ca0: 6962 5f66 696c 7465 7220 3d20 2864 665f  ib_filter = (df_
-00021cb0: 626c 6f63 6b5f 6361 6c69 6220 213d 2074  block_calib != t
-00021cc0: 6167 292e 746f 5f6e 756d 7079 2829 0a20  ag).to_numpy(). 
-00021cd0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00021ce0: 7420 6361 6c69 625f 6669 6c74 6572 2e61  t calib_filter.a
-00021cf0: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
-00021d00: 2020 2020 2020 2320 4361 6e27 7420 6361        # Can't ca
-00021d10: 6c69 6272 6174 6520 736f 2064 6f6e 2774  librate so don't
-00021d20: 2061 7474 656d 7074 2072 6570 6169 720a   attempt repair.
-00021d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d40: 6966 2073 656c 662e 5f72 6563 6f72 645f  if self._record_
-00021d50: 7374 6163 6b5f 7472 6163 653a 0a20 2020  stack_trace:.   
-00021d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d70: 2023 2050 6f70 2073 7461 636b 2074 7261   # Pop stack tra
-00021d80: 6365 0a20 2020 2020 2020 2020 2020 2020  ce.             
-00021d90: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
-00021da0: 6c66 2e5f 7374 6163 6b5f 7472 6163 6529  lf._stack_trace)
-00021db0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00021dc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00021dd0: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
-00021de0: 4661 696c 696e 6720 746f 2063 6f72 7265  Failing to corre
-00021df0: 6374 6c79 2070 7573 682f 706f 7020 7374  ctly push/pop st
-00021e00: 6163 6b20 7472 6163 6520 2869 7320 656d  ack trace (is em
-00021e10: 7074 7920 746f 6f20 6561 726c 7929 2229  pty too early)")
-00021e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021e30: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00021e40: 2e5f 7374 6163 6b5f 7472 6163 655b 2d31  ._stack_trace[-1
-00021e50: 5d20 3d3d 2066 6e5f 7475 706c 653a 0a20  ] == fn_tuple:. 
-00021e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e70: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00021e80: 7261 6e67 6528 6c65 6e28 7365 6c66 2e5f  range(len(self._
-00021e90: 7374 6163 6b5f 7472 6163 6529 293a 0a20  stack_trace)):. 
-00021ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021eb0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00021ec0: 2822 2020 222a 6920 2b20 7374 7228 7365  ("  "*i + str(se
-00021ed0: 6c66 2e5f 7374 6163 6b5f 7472 6163 655b  lf._stack_trace[
-00021ee0: 695d 2929 0a20 2020 2020 2020 2020 2020  i])).           
-00021ef0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00021f00: 7365 2045 7863 6570 7469 6f6e 2822 4661  se Exception("Fa
-00021f10: 696c 696e 6720 746f 2063 6f72 7265 6374  iling to correct
-00021f20: 6c79 2070 7573 682f 706f 7020 7374 6163  ly push/pop stac
-00021f30: 6b20 7472 6163 6520 2873 6565 2061 626f  k trace (see abo
-00021f40: 7665 2922 290a 2020 2020 2020 2020 2020  ve)").          
-00021f50: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00021f60: 7374 6163 6b5f 7472 6163 652e 706f 7028  stack_trace.pop(
-00021f70: 6c65 6e28 7365 6c66 2e5f 7374 6163 6b5f  len(self._stack_
-00021f80: 7472 6163 6529 202d 2031 290a 2020 2020  trace) - 1).    
-00021f90: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00021fa0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00021fb0: 2069 6620 6465 6275 673a 0a20 2020 2020   if debug:.     
-00021fc0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00021fd0: 2822 6361 6c69 625f 6669 6c74 6572 3a22  ("calib_filter:"
-00021fe0: 2920 3b20 7072 696e 7428 6361 6c69 625f  ) ; print(calib_
-00021ff0: 6669 6c74 6572 290a 2020 2020 2020 2020  filter).        
-00022000: 2020 2020 2020 2020 7072 696e 7428 2264          print("d
-00022010: 665f 6e65 775f 6361 6c69 623a 2229 203b  f_new_calib:") ;
-00022020: 2070 7269 6e74 2864 665f 6e65 775f 6361   print(df_new_ca
-00022030: 6c69 6229 0a20 2020 2020 2020 2020 2020  lib).           
-00022040: 2020 2020 2070 7269 6e74 2822 6466 5f62       print("df_b
-00022050: 6c6f 636b 5f63 616c 6962 3a22 2920 3b20  lock_calib:") ; 
-00022060: 7072 696e 7428 6466 5f62 6c6f 636b 5f63  print(df_block_c
-00022070: 616c 6962 290a 2020 2020 2020 2020 2020  alib).          
-00022080: 2020 2320 4176 6f69 6420 6469 7669 6465    # Avoid divide
-00022090: 2d62 792d 7a65 726f 2077 6172 6e69 6e67  -by-zero warning
-000220a0: 7320 7072 696e 7469 6e67 3a0a 2020 2020  s printing:.    
-000220b0: 2020 2020 2020 2020 6466 5f6e 6577 5f63          df_new_c
-000220c0: 616c 6962 203d 2064 665f 6e65 775f 6361  alib = df_new_ca
-000220d0: 6c69 622e 746f 5f6e 756d 7079 2829 0a20  lib.to_numpy(). 
-000220e0: 2020 2020 2020 2020 2020 2064 665f 626c             df_bl
-000220f0: 6f63 6b5f 6361 6c69 6220 3d20 6466 5f62  ock_calib = df_b
-00022100: 6c6f 636b 5f63 616c 6962 2e74 6f5f 6e75  lock_calib.to_nu
-00022110: 6d70 7928 290a 2020 2020 2020 2020 2020  mpy().          
-00022120: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
-00022130: 286c 656e 2870 7269 6365 5f63 6f6c 7329  (len(price_cols)
-00022140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00022150: 2020 2063 203d 2070 7269 6365 5f63 6f6c     c = price_col
-00022160: 735b 6a5d 0a20 2020 2020 2020 2020 2020  s[j].           
-00022170: 2020 2020 2066 203d 207e 6361 6c69 625f       f = ~calib_
-00022180: 6669 6c74 6572 5b3a 2c20 6a5d 0a20 2020  filter[:, j].   
-00022190: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000221a0: 662e 616e 7928 293a 0a20 2020 2020 2020  f.any():.       
-000221b0: 2020 2020 2020 2020 2020 2020 2064 665f               df_
-000221c0: 626c 6f63 6b5f 6361 6c69 625b 662c 206a  block_calib[f, j
-000221d0: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
-000221e0: 2020 2020 2020 2020 2020 6466 5f6e 6577            df_new
-000221f0: 5f63 616c 6962 5b66 2c20 6a5d 203d 2031  _calib[f, j] = 1
-00022200: 0a20 2020 2020 2020 2020 2020 2072 6174  .            rat
-00022210: 696f 7320 3d20 2864 665f 626c 6f63 6b5f  ios = (df_block_
-00022220: 6361 6c69 6220 2f20 6466 5f6e 6577 5f63  calib / df_new_c
-00022230: 616c 6962 295b 6361 6c69 625f 6669 6c74  alib)[calib_filt
-00022240: 6572 5d0a 2020 2020 2020 2020 2020 2020  er].            
-00022250: 7261 7469 6f20 3d20 6e70 2e6d 6561 6e28  ratio = np.mean(
-00022260: 7261 7469 6f73 290a 2020 2020 2020 2020  ratios).        
-00022270: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
-00022280: 2020 7261 7469 6f5f 7263 7020 3d20 726f    ratio_rcp = ro
-00022290: 756e 6428 312e 3020 2f20 7261 7469 6f2c  und(1.0 / ratio,
-000222a0: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-000222b0: 7261 7469 6f20 3d20 726f 756e 6428 7261  ratio = round(ra
-000222c0: 7469 6f2c 2031 290a 2020 2020 2020 2020  tio, 1).        
-000222d0: 2020 2020 6966 2072 6174 696f 203d 3d20      if ratio == 
-000222e0: 3120 616e 6420 7261 7469 6f5f 7263 7020  1 and ratio_rcp 
-000222f0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-00022300: 2020 2020 2020 2320 476f 6f64 210a 2020        # Good!.  
-00022310: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00022320: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-00022330: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00022340: 2020 2020 2069 6620 7261 7469 6f20 3e20       if ratio > 
-00022350: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00022360: 2020 2020 2020 2023 2064 6174 6120 6861         # data ha
-00022370: 7320 6469 6666 6572 656e 7420 7370 6c69  s different spli
-00022380: 742d 6164 6a75 7374 6d65 6e74 2074 6861  t-adjustment tha
-00022390: 6e20 6669 6e65 2d67 7261 696e 6564 2064  n fine-grained d
-000223a0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
-000223b0: 2020 2020 2020 2020 2320 4164 6a75 7374          # Adjust
-000223c0: 2066 696e 652d 6772 6169 6e65 6420 746f   fine-grained to
-000223d0: 206d 6174 6368 0a20 2020 2020 2020 2020   match.         
-000223e0: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
-000223f0: 775b 7072 6963 655f 636f 6c73 5d20 2a3d  w[price_cols] *=
-00022400: 2072 6174 696f 0a20 2020 2020 2020 2020   ratio.         
-00022410: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
-00022420: 775b 2256 6f6c 756d 6522 5d20 2f3d 2072  w["Volume"] /= r
-00022430: 6174 696f 0a20 2020 2020 2020 2020 2020  atio.           
-00022440: 2020 2020 2065 6c69 6620 7261 7469 6f5f       elif ratio_
-00022450: 7263 7020 3e20 313a 0a20 2020 2020 2020  rcp > 1:.       
-00022460: 2020 2020 2020 2020 2020 2020 2023 2064               # d
-00022470: 6174 6120 6861 7320 6469 6666 6572 656e  ata has differen
-00022480: 7420 7370 6c69 742d 6164 6a75 7374 6d65  t split-adjustme
-00022490: 6e74 2074 6861 6e20 6669 6e65 2d67 7261  nt than fine-gra
-000224a0: 696e 6564 2064 6174 610a 2020 2020 2020  ined data.      
-000224b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000224c0: 4164 6a75 7374 2066 696e 652d 6772 6169  Adjust fine-grai
-000224d0: 6e65 6420 746f 206d 6174 6368 0a20 2020  ned to match.   
-000224e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000224f0: 2064 665f 6e65 775b 7072 6963 655f 636f   df_new[price_co
-00022500: 6c73 5d20 2a3d 2031 2e30 202f 2072 6174  ls] *= 1.0 / rat
-00022510: 696f 5f72 6370 0a20 2020 2020 2020 2020  io_rcp.         
-00022520: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
-00022530: 775b 2256 6f6c 756d 6522 5d20 2a3d 2072  w["Volume"] *= r
-00022540: 6174 696f 5f72 6370 0a0a 2020 2020 2020  atio_rcp..      
-00022550: 2020 2020 2020 2320 5265 7061 6972 210a        # Repair!.
-00022560: 2020 2020 2020 2020 2020 2020 6261 645f              bad_
-00022570: 6474 7320 3d20 6466 5f62 6c6f 636b 2e69  dts = df_block.i
-00022580: 6e64 6578 5b28 6466 5f62 6c6f 636b 5b70  ndex[(df_block[p
-00022590: 7269 6365 5f63 6f6c 735d 203d 3d20 7461  rice_cols] == ta
-000225a0: 6729 2e61 6e79 2861 7869 733d 3129 5d0a  g).any(axis=1)].
-000225b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000225c0: 2069 6478 2069 6e20 6261 645f 6474 733a   idx in bad_dts:
-000225d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000225e0: 2069 6620 6964 7820 6e6f 7420 696e 2064   if idx not in d
-000225f0: 665f 6e65 772e 696e 6465 783a 0a20 2020  f_new.index:.   
-00022600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022610: 2023 2059 6168 6f6f 2064 6964 6e27 7420   # Yahoo didn't 
-00022620: 7265 7475 726e 2066 696e 6572 2d67 7261  return finer-gra
-00022630: 696e 2064 6174 6120 666f 7220 7468 6973  in data for this
-00022640: 2069 6e74 6572 7661 6c2c 0a20 2020 2020   interval,.     
-00022650: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00022660: 2073 6f20 7072 6f62 6162 6c79 206e 6f20   so probably no 
-00022670: 7472 6164 696e 6720 6861 7070 656e 6564  trading happened
-00022680: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00022690: 2020 2020 2020 2320 7072 696e 7428 226e        # print("n
-000226a0: 6f20 6669 6e65 2064 6174 6122 290a 2020  o fine data").  
-000226b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226c0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-000226d0: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
-000226e0: 775f 726f 7720 3d20 6466 5f6e 6577 2e6c  w_row = df_new.l
-000226f0: 6f63 5b69 6478 5d0a 0a20 2020 2020 2020  oc[idx]..       
-00022700: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00022710: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
-00022720: 642e 496e 7465 7276 616c 2e57 6565 6b3a  d.Interval.Week:
-00022730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022740: 2020 2020 2064 665f 6c61 7374 5f77 6565       df_last_wee
-00022750: 6b20 3d20 6466 5f6e 6577 2e69 6c6f 635b  k = df_new.iloc[
-00022760: 6466 5f6e 6577 2e69 6e64 6578 2e67 6574  df_new.index.get
-00022770: 5f6c 6f63 2869 6478 292d 315d 0a20 2020  _loc(idx)-1].   
-00022780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022790: 2064 665f 6669 6e65 203d 2064 665f 6669   df_fine = df_fi
-000227a0: 6e65 2e6c 6f63 5b69 6478 3a5d 0a0a 2020  ne.loc[idx:]..  
-000227b0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000227c0: 5f62 6164 5f72 6f77 203d 2064 662e 6c6f  _bad_row = df.lo
-000227d0: 635b 6964 785d 0a20 2020 2020 2020 2020  c[idx].         
-000227e0: 2020 2020 2020 2062 6164 5f66 6965 6c64         bad_field
-000227f0: 7320 3d20 6466 5f62 6164 5f72 6f77 2e69  s = df_bad_row.i
-00022800: 6e64 6578 5b64 665f 6261 645f 726f 7720  ndex[df_bad_row 
-00022810: 3d3d 2074 6167 5d2e 746f 5f6e 756d 7079  == tag].to_numpy
-00022820: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00022830: 2020 2069 6620 2248 6967 6822 2069 6e20     if "High" in 
-00022840: 6261 645f 6669 656c 6473 3a0a 2020 2020  bad_fields:.    
-00022850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022860: 6466 5f76 322e 6c6f 635b 6964 782c 2022  df_v2.loc[idx, "
-00022870: 4869 6768 225d 203d 2064 665f 6e65 775f  High"] = df_new_
-00022880: 726f 775b 2248 6967 6822 5d0a 2020 2020  row["High"].    
-00022890: 2020 2020 2020 2020 2020 2020 6966 2022              if "
-000228a0: 4c6f 7722 2069 6e20 6261 645f 6669 656c  Low" in bad_fiel
-000228b0: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
-000228c0: 2020 2020 2020 2020 6466 5f76 322e 6c6f          df_v2.lo
-000228d0: 635b 6964 782c 2022 4c6f 7722 5d20 3d20  c[idx, "Low"] = 
-000228e0: 6466 5f6e 6577 5f72 6f77 5b22 4c6f 7722  df_new_row["Low"
-000228f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00022900: 2020 6966 2022 4f70 656e 2220 696e 2062    if "Open" in b
-00022910: 6164 5f66 6965 6c64 733a 0a20 2020 2020  ad_fields:.     
-00022920: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00022930: 6620 7365 6c66 2e69 6e74 6572 7661 6c20  f self.interval 
-00022940: 3d3d 2079 6663 642e 496e 7465 7276 616c  == yfcd.Interval
-00022950: 2e57 6565 6b20 616e 6420 6964 7820 213d  .Week and idx !=
-00022960: 2064 665f 6669 6e65 2e69 6e64 6578 5b30   df_fine.index[0
-00022970: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00022980: 2020 2020 2020 2020 2020 2023 2045 7863             # Exc
-00022990: 6861 6e67 6520 636c 6f73 6564 204d 6f6e  hange closed Mon
-000229a0: 6461 792e 2049 6e20 7468 6973 2063 6173  day. In this cas
-000229b0: 652c 2059 6168 6f6f 2073 6574 7320 4f70  e, Yahoo sets Op
-000229c0: 656e 2074 6f20 6c61 7374 2077 6565 6b20  en to last week 
-000229d0: 636c 6f73 650a 2020 2020 2020 2020 2020  close.          
-000229e0: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000229f0: 5f76 322e 6c6f 635b 6964 782c 2022 4f70  _v2.loc[idx, "Op
-00022a00: 656e 225d 203d 2064 665f 6c61 7374 5f77  en"] = df_last_w
-00022a10: 6565 6b5b 2243 6c6f 7365 225d 0a20 2020  eek["Close"].   
-00022a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a30: 2020 2020 2064 665f 7632 2e6c 6f63 5b69       df_v2.loc[i
-00022a40: 6478 2c20 224c 6f77 225d 203d 206d 696e  dx, "Low"] = min
-00022a50: 2864 665f 7632 2e6c 6f63 5b69 6478 2c20  (df_v2.loc[idx, 
-00022a60: 224f 7065 6e22 5d2c 2064 665f 7632 2e6c  "Open"], df_v2.l
-00022a70: 6f63 5b69 6478 2c20 224c 6f77 225d 290a  oc[idx, "Low"]).
-00022a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ab0: 2020 6466 5f76 322e 6c6f 635b 6964 782c    df_v2.loc[idx,
-00022ac0: 2022 4f70 656e 225d 203d 2064 665f 6e65   "Open"] = df_ne
-00022ad0: 775f 726f 775b 224f 7065 6e22 5d0a 2020  w_row["Open"].  
-00022ae0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00022af0: 2022 436c 6f73 6522 2069 6e20 6261 645f   "Close" in bad_
-00022b00: 6669 656c 6473 3a0a 2020 2020 2020 2020  fields:.        
-00022b10: 2020 2020 2020 2020 2020 2020 6466 5f76              df_v
-00022b20: 322e 6c6f 635b 6964 782c 2022 436c 6f73  2.loc[idx, "Clos
-00022b30: 6522 5d20 3d20 6466 5f6e 6577 5f72 6f77  e"] = df_new_row
-00022b40: 5b22 436c 6f73 6522 5d0a 2020 2020 2020  ["Close"].      
-00022b50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00022b60: 5368 6f75 6c64 206e 6f74 206e 6565 6420  Should not need 
-00022b70: 746f 2063 6f70 7920 6f76 6572 2043 4446  to copy over CDF
-00022b80: 2026 2043 5346 2c20 6265 6361 7573 650a   & CSF, because.
-00022b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ba0: 2020 2020 2320 636f 7272 6563 7420 7661      # correct va
-00022bb0: 6c75 6573 2061 7265 2061 6c72 6561 6479  lues are already
-00022bc0: 206d 6572 6765 6420 696e 2066 726f 6d20   merged in from 
-00022bd0: 6461 696c 790a 2020 2020 2020 2020 2020  daily.          
-00022be0: 2020 2020 2020 2020 2020 2320 6466 5f76            # df_v
-00022bf0: 322e 6c6f 635b 6964 782c 2022 4344 4622  2.loc[idx, "CDF"
-00022c00: 5d20 3d20 6466 5f6e 6577 5f72 6f77 5b22  ] = df_new_row["
-00022c10: 4344 4622 5d0a 2020 2020 2020 2020 2020  CDF"].          
-00022c20: 2020 2020 2020 2020 2020 2320 6466 5f76            # df_v
-00022c30: 322e 6c6f 635b 6964 782c 2022 4353 4622  2.loc[idx, "CSF"
-00022c40: 5d20 3d20 6466 5f6e 6577 5f72 6f77 5b22  ] = df_new_row["
-00022c50: 4353 4622 5d0a 2020 2020 2020 2020 2020  CSF"].          
-00022c60: 2020 2020 2020 6966 2022 566f 6c75 6d65        if "Volume
-00022c70: 2220 696e 2062 6164 5f66 6965 6c64 733a  " in bad_fields:
-00022c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022c90: 2020 2020 2064 665f 7632 2e6c 6f63 5b69       df_v2.loc[i
-00022ca0: 6478 2c20 2256 6f6c 756d 6522 5d20 3d20  dx, "Volume"] = 
-00022cb0: 6466 5f6e 6577 5f72 6f77 5b22 566f 6c75  df_new_row["Volu
-00022cc0: 6d65 225d 0a20 2020 2020 2020 2020 2020  me"].           
-00022cd0: 2020 2020 206e 5f66 6978 6564 202b 3d20       n_fixed += 
-00022ce0: 310a 0a20 2020 2020 2020 2020 2020 2023  1..            #
-00022cf0: 2052 6573 746f 7265 2075 6e2d 7265 7061   Restore un-repa
-00022d00: 6972 6564 2062 6164 2076 616c 7565 730a  ired bad values.
-00022d10: 2020 2020 2020 2020 2020 2020 665f 6e61              f_na
-00022d20: 6e20 3d20 6466 5f76 325b 7072 6963 655f  n = df_v2[price_
-00022d30: 636f 6c73 5d2e 6973 6e61 2829 2e74 6f5f  cols].isna().to_
-00022d40: 6e75 6d70 7928 290a 2020 2020 2020 2020  numpy().        
-00022d50: 2020 2020 665f 6661 696c 6564 203d 2066      f_failed = f
-00022d60: 5f74 6167 2026 2066 5f6e 616e 0a20 2020  _tag & f_nan.   
-00022d70: 2020 2020 2020 2020 2066 6f72 206a 2069           for j i
-00022d80: 6e20 7261 6e67 6528 6c65 6e28 7072 6963  n range(len(pric
-00022d90: 655f 636f 6c73 2929 3a0a 2020 2020 2020  e_cols)):.      
-00022da0: 2020 2020 2020 2020 2020 6620 3d20 665f            f = f_
-00022db0: 6661 696c 6564 5b3a 2c20 6a5d 0a20 2020  failed[:, j].   
-00022dc0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00022dd0: 662e 616e 7928 293a 0a20 2020 2020 2020  f.any():.       
-00022de0: 2020 2020 2020 2020 2020 2020 2063 203d               c =
-00022df0: 2070 7269 6365 5f63 6f6c 735b 6a5d 0a20   price_cols[j]. 
-00022e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e10: 2020 2023 2066 6f72 2069 2069 6e20 6e70     # for i in np
-00022e20: 2e77 6865 7265 2866 295b 305d 3a0a 2020  .where(f)[0]:.  
+0001fd10: 7072 696e 7428 2264 665f 626c 6f63 6b3a  print("df_block:
+0001fd20: 2229 203b 2070 7269 6e74 2864 665f 626c  ") ; print(df_bl
+0001fd30: 6f63 6b29 0a0a 2020 2020 2020 2020 2020  ock)..          
+0001fd40: 2020 7374 6172 745f 6474 203d 2067 5b30    start_dt = g[0
+0001fd50: 5d0a 2020 2020 2020 2020 2020 2020 7374  ].            st
+0001fd60: 6172 745f 6420 3d20 7374 6172 745f 6474  art_d = start_dt
+0001fd70: 2e64 6174 6528 290a 0a20 2020 2020 2020  .date()..       
+0001fd80: 2020 2020 2069 6620 7375 625f 696e 7465       if sub_inte
+0001fd90: 7276 616c 203d 3d20 7966 6364 2e49 6e74  rval == yfcd.Int
+0001fda0: 6572 7661 6c2e 486f 7572 7331 2061 6e64  erval.Hours1 and
+0001fdb0: 2028 6461 7465 2e74 6f64 6179 2829 2d73   (date.today()-s
+0001fdc0: 7461 7274 5f64 2920 3e20 7469 6d65 6465  tart_d) > timede
+0001fdd0: 6c74 6128 6461 7973 3d37 3239 293a 0a20  lta(days=729):. 
+0001fde0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001fdf0: 2044 6f6e 2774 2062 6f74 6865 7220 7265   Don't bother re
+0001fe00: 7175 6573 7469 6e67 206d 6f72 6520 7072  questing more pr
+0001fe10: 6963 6520 6461 7461 2c20 5961 686f 6f20  ice data, Yahoo 
+0001fe20: 7769 6c6c 2072 656a 6563 740a 2020 2020  will reject.    
+0001fe30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001fe40: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+0001fe50: 2065 6c69 6620 7375 625f 696e 7465 7276   elif sub_interv
+0001fe60: 616c 2069 6e20 5b79 6663 642e 496e 7465  al in [yfcd.Inte
+0001fe70: 7276 616c 2e4d 696e 7333 302c 2079 6663  rval.Mins30, yfc
+0001fe80: 642e 496e 7465 7276 616c 2e4d 696e 7331  d.Interval.Mins1
+0001fe90: 355d 2061 6e64 2028 6461 7465 2e74 6f64  5] and (date.tod
+0001fea0: 6179 2829 2d73 7461 7274 5f64 2920 3e20  ay()-start_d) > 
+0001feb0: 7469 6d65 6465 6c74 6128 6461 7973 3d35  timedelta(days=5
+0001fec0: 3929 3a0a 2020 2020 2020 2020 2020 2020  9):.            
+0001fed0: 2020 2020 2320 446f 6e27 7420 626f 7468      # Don't both
+0001fee0: 6572 2072 6571 7565 7374 696e 6720 6d6f  er requesting mo
+0001fef0: 7265 2070 7269 6365 2064 6174 612c 2059  re price data, Y
+0001ff00: 6168 6f6f 2077 696c 6c20 7265 6a65 6374  ahoo will reject
+0001ff10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ff20: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0001ff30: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+0001ff40: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
+0001ff50: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+0001ff60: 2020 2020 2320 4c6f 6720 6675 6e63 7469      # Log functi
+0001ff70: 6f6e 2063 616c 6c73 2074 6f20 6465 7465  on calls to dete
+0001ff80: 6374 2061 6e64 206d 616e 6167 6520 696e  ct and manage in
+0001ff90: 6669 6e69 7465 2072 6563 7572 7369 6f6e  finite recursion
+0001ffa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ffb0: 2066 6e5f 7475 706c 6520 3d20 2822 5f72   fn_tuple = ("_r
+0001ffc0: 6563 6f6e 7374 7275 6374 5f69 6e74 6572  econstruct_inter
+0001ffd0: 7661 6c73 5f62 6174 6368 2829 222c 2066  vals_batch()", f
+0001ffe0: 2264 7430 3d7b 6466 2e69 6e64 6578 5b30  "dt0={df.index[0
+0001fff0: 5d7d 222c 2066 2269 6e74 6572 7661 6c3d  ]}", f"interval=
+00020000: 7b73 656c 662e 696e 7465 7276 616c 7d22  {self.interval}"
+00020010: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00020020: 2020 6966 2066 6e5f 7475 706c 6520 696e    if fn_tuple in
+00020030: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
+00020040: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00020050: 2020 2020 2020 2020 2320 4465 7465 6374          # Detect
+00020060: 6564 2061 2070 6f74 656e 7469 616c 2072  ed a potential r
+00020070: 6563 7572 7369 6f6e 206c 6f6f 700a 2020  ecursion loop.  
+00020080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020090: 2020 7265 636f 6e73 7472 7563 745f 6465    reconstruct_de
+000200a0: 7465 6374 6564 203d 2046 616c 7365 0a20  tected = False. 
+000200b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200c0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+000200d0: 6528 6c65 6e28 7365 6c66 2e5f 7374 6163  e(len(self._stac
+000200e0: 6b5f 7472 6163 6529 2d31 2c20 2d31 2c20  k_trace)-1, -1, 
+000200f0: 2d31 293a 0a20 2020 2020 2020 2020 2020  -1):.           
+00020100: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00020110: 225f 7265 636f 6e73 7472 7563 745f 696e  "_reconstruct_in
+00020120: 7465 7276 616c 735f 6261 7463 6822 2069  tervals_batch" i
+00020130: 6e20 7374 7228 7365 6c66 2e5f 7374 6163  n str(self._stac
+00020140: 6b5f 7472 6163 655b 695d 293a 0a20 2020  k_trace[i]):.   
+00020150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020160: 2020 2020 2020 2020 2072 6563 6f6e 7374           reconst
+00020170: 7275 6374 5f64 6574 6563 7465 6420 3d20  ruct_detected = 
+00020180: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00020190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201a0: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+000201b0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+000201c0: 636f 6e73 7472 7563 745f 6465 7465 6374  construct_detect
+000201d0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+000201e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000201f0: 2e5f 696e 6669 6e69 7465 5f72 6563 7572  ._infinite_recur
+00020200: 7369 6f6e 5f64 6574 6563 7465 6420 3d20  sion_detected = 
+00020210: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+00020220: 2020 2020 2073 656c 662e 5f73 7461 636b       self._stack
+00020230: 5f74 7261 6365 2e61 7070 656e 6428 666e  _trace.append(fn
+00020240: 5f74 7570 6c65 290a 0a20 2020 2020 2020  _tuple)..       
+00020250: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00020260: 6572 6461 793a 0a20 2020 2020 2020 2020  erday:.         
+00020270: 2020 2020 2020 206c 6f67 5f6d 7367 203d         log_msg =
+00020280: 2066 2272 6570 6169 7269 6e67 207b 7365   f"repairing {se
+00020290: 6c66 2e69 7374 727d 2062 6c6f 636b 207b  lf.istr} block {
+000202a0: 675b 305d 2e64 6174 6528 297d 202d 3e20  g[0].date()} -> 
+000202b0: 7b67 5b2d 315d 2e64 6174 6528 292b 7469  {g[-1].date()+ti
+000202c0: 6d65 6465 6c74 6128 6461 7973 3d31 297d  medelta(days=1)}
+000202d0: 220a 2020 2020 2020 2020 2020 2020 656c  ".            el
+000202e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000202f0: 2020 2020 6c6f 675f 6d73 6720 3d20 6622      log_msg = f"
+00020300: 7265 7061 6972 696e 6720 7b73 656c 662e  repairing {self.
+00020310: 6973 7472 7d20 626c 6f63 6b20 7b67 5b30  istr} block {g[0
+00020320: 5d7d 202d 3e20 7b67 5b2d 315d 7d22 0a20  ]} -> {g[-1]}". 
+00020330: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00020340: 6d61 6e61 6765 722e 4c6f 6745 7665 6e74  manager.LogEvent
+00020350: 2822 696e 666f 222c 2022 5072 6963 654d  ("info", "PriceM
+00020360: 616e 6167 6572 222c 206c 6f67 5f6d 7367  anager", log_msg
+00020370: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00020380: 2049 6e66 696e 6974 6520 6c6f 6f70 2070   Infinite loop p
+00020390: 6f74 656e 7469 616c 2068 6572 6520 7669  otential here vi
+000203a0: 6120 7265 7061 6972 3a0a 2020 2020 2020  a repair:.      
+000203b0: 2020 2020 2020 2320 2d20 7265 7175 6573        # - reques
+000203c0: 7420 6669 6e65 2d67 7261 696e 6564 2064  t fine-grained d
+000203d0: 6174 6120 652e 672e 2031 480a 2020 2020  ata e.g. 1H.    
+000203e0: 2020 2020 2020 2020 2320 2d20 3148 2072          # - 1H r
+000203f0: 6571 7569 7265 7320 6163 6375 7261 7465  equires accurate
+00020400: 2064 6976 6964 656e 6420 6461 7461 0a20   dividend data. 
+00020410: 2020 2020 2020 2020 2020 2023 202d 2074             # - t
+00020420: 7269 6767 6572 7320 6665 7463 6820 6f66  riggers fetch of
+00020430: 2031 4420 6461 7461 2077 6869 6368 206d   1D data which m
+00020440: 7573 7420 6265 206b 6570 7420 636f 6e74  ust be kept cont
+00020450: 6967 756f 7573 0a20 2020 2020 2020 2020  iguous.         
+00020460: 2020 2023 202d 2074 7269 6767 6572 7320     # - triggers 
+00020470: 6665 7463 6820 6f66 206f 6c64 6572 2031  fetch of older 1
+00020480: 4420 6461 7461 2077 6869 6368 2072 6571  D data which req
+00020490: 7569 7265 7320 7265 7061 6972 2075 7369  uires repair usi
+000204a0: 6e67 2031 4820 6461 7461 202d 3e20 7265  ng 1H data -> re
+000204b0: 6375 7273 696f 6e20 6c6f 6f70 0a20 2020  cursion loop.   
+000204c0: 2020 2020 2020 2020 2023 2053 6f6c 7574           # Solut
+000204d0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+000204e0: 2023 2031 2920 6164 6420 7475 706c 6520   # 1) add tuple 
+000204f0: 746f 2066 6e20 7374 6163 6b20 6275 7920  to fn stack buy 
+00020500: 7769 7468 2059 463d 5472 7565 0a20 2020  with YF=True.   
+00020510: 2020 2020 2020 2020 2023 2032 2920 6966           # 2) if
+00020520: 2074 6861 7420 7475 706c 6520 616c 7265   that tuple alre
+00020530: 6164 7920 696e 2073 7461 636b 2074 6865  ady in stack the
+00020540: 6e20 7261 6973 6520 4578 6365 7074 696f  n raise Exceptio
+00020550: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+00020560: 2073 656c 662e 696e 7465 7276 616c 203d   self.interval =
+00020570: 3d20 7966 6364 2e49 6e74 6572 7661 6c2e  = yfcd.Interval.
+00020580: 5765 656b 3a0a 2020 2020 2020 2020 2020  Week:.          
+00020590: 2020 2020 2020 6665 7463 685f 7374 6172        fetch_star
+000205a0: 7420 3d20 7374 6172 745f 6420 2d20 7464  t = start_d - td
+000205b0: 5f72 616e 6765 2020 2320 6e65 6564 2070  _range  # need p
+000205c0: 7265 7669 6f75 7320 7765 656b 2074 6f6f  revious week too
+000205d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000205e0: 2066 6574 6368 5f65 6e64 203d 2067 5b2d   fetch_end = g[-
+000205f0: 315d 2e64 6174 6528 2920 2b20 7464 5f72  1].date() + td_r
+00020600: 616e 6765 0a20 2020 2020 2020 2020 2020  ange.           
+00020610: 2065 6c69 6620 7365 6c66 2e69 6e74 6572   elif self.inter
+00020620: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
+00020630: 7276 616c 2e44 6179 7331 3a0a 2020 2020  rval.Days1:.    
+00020640: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00020650: 685f 7374 6172 7420 3d20 7374 6172 745f  h_start = start_
+00020660: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00020670: 2020 6665 7463 685f 656e 6420 3d20 675b    fetch_end = g[
+00020680: 2d31 5d2e 6461 7465 2829 202b 2074 645f  -1].date() + td_
+00020690: 7261 6e67 650a 2020 2020 2020 2020 2020  range.          
+000206a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000206b0: 2020 2020 2020 2020 6665 7463 685f 7374          fetch_st
+000206c0: 6172 7420 3d20 675b 305d 0a20 2020 2020  art = g[0].     
+000206d0: 2020 2020 2020 2020 2020 2066 6574 6368             fetch
+000206e0: 5f65 6e64 203d 2067 5b2d 315d 202b 2074  _end = g[-1] + t
+000206f0: 645f 7261 6e67 650a 2020 2020 2020 2020  d_range.        
+00020700: 2020 2020 2320 7072 696e 7428 6622 6665      # print(f"fe
+00020710: 7463 685f 7374 6172 743d 7b66 6574 6368  tch_start={fetch
+00020720: 5f73 7461 7274 7d20 6665 7463 685f 656e  _start} fetch_en
+00020730: 643d 7b66 6574 6368 5f65 6e64 7d22 290a  d={fetch_end}").
+00020740: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
+00020750: 7265 706f 7374 203d 2073 656c 662e 696e  repost = self.in
+00020760: 7465 7276 616c 203d 3d20 7966 6364 2e49  terval == yfcd.I
+00020770: 6e74 6572 7661 6c2e 4461 7973 310a 2020  nterval.Days1.  
+00020780: 2020 2020 2020 2020 2020 7072 6570 6f73            prepos
+00020790: 7420 3d20 7365 6c66 2e69 6e74 6572 6461  t = self.interda
+000207a0: 790a 2020 2020 2020 2020 2020 2020 6966  y.            if
+000207b0: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+000207c0: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
+000207d0: 2d20 6665 7463 685f 7374 6172 743d 7b66  - fetch_start={f
+000207e0: 6574 6368 5f73 7461 7274 7d2c 2066 6574  etch_start}, fet
+000207f0: 6368 5f65 6e64 3d7b 6665 7463 685f 656e  ch_end={fetch_en
+00020800: 647d 2070 7265 706f 7374 3d7b 7072 6570  d} prepost={prep
+00020810: 6f73 747d 2229 0a20 2020 2020 2020 2020  ost}").         
+00020820: 2020 2069 6620 7365 6c66 2e5f 696e 6669     if self._infi
+00020830: 6e69 7465 5f72 6563 7572 7369 6f6e 5f64  nite_recursion_d
+00020840: 6574 6563 7465 643a 0a20 2020 2020 2020  etected:.       
+00020850: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+00020860: 6e20 7261 6e67 6528 6c65 6e28 7365 6c66  n range(len(self
+00020870: 2e5f 7374 6163 6b5f 7472 6163 6529 293a  ._stack_trace)):
+00020880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020890: 2020 2020 2070 7269 6e74 2822 2020 222a       print("  "*
+000208a0: 6920 2b20 7374 7228 7365 6c66 2e5f 7374  i + str(self._st
+000208b0: 6163 6b5f 7472 6163 655b 695d 2929 0a20  ack_trace[i])). 
+000208c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000208d0: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+000208e0: 5741 524e 494e 473a 2049 6e66 696e 6974  WARNING: Infinit
+000208f0: 6520 7265 6375 7273 696f 6e20 6465 7465  e recursion dete
+00020900: 6374 6564 2028 7365 6520 7374 6163 6b20  cted (see stack 
+00020910: 7472 6163 6520 6162 6f76 6529 2e20 5377  trace above). Sw
+00020920: 6974 6368 2074 6f20 6665 7463 6869 6e67  itch to fetching
+00020930: 2070 7269 6365 7320 6469 7265 6374 2066   prices direct f
+00020940: 726f 6d20 5946 2229 0a20 2020 2020 2020  rom YF").       
+00020950: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00020960: 5741 524e 494e 473a 2049 6e66 696e 6974  WARNING: Infinit
+00020970: 6520 7265 6375 7273 696f 6e20 6465 7465  e recursion dete
+00020980: 6374 6564 2028 7365 6520 7374 6163 6b20  cted (see stack 
+00020990: 7472 6163 6520 6162 6f76 6529 2e20 5377  trace above). Sw
+000209a0: 6974 6368 2074 6f20 6665 7463 6869 6e67  itch to fetching
+000209b0: 2070 7269 6365 7320 6469 7265 6374 2066   prices direct f
+000209c0: 726f 6d20 5946 2229 0a20 2020 2020 2020  rom YF").       
+000209d0: 2020 2020 2020 2020 2023 2064 665f 6669           # df_fi
+000209e0: 6e65 203d 2073 656c 662e 6461 742e 6869  ne = self.dat.hi
+000209f0: 7374 6f72 7928 7374 6172 743d 6665 7463  story(start=fetc
+00020a00: 685f 7374 6172 742c 2065 6e64 3d66 6574  h_start, end=fet
+00020a10: 6368 5f65 6e64 2c20 696e 7465 7276 616c  ch_end, interval
+00020a20: 3d79 6663 642e 696e 7465 7276 616c 546f  =yfcd.intervalTo
+00020a30: 5374 7269 6e67 5b73 7562 5f69 6e74 6572  String[sub_inter
+00020a40: 7661 6c5d 2c20 6175 746f 5f61 646a 7573  val], auto_adjus
+00020a50: 743d 4661 6c73 652c 2070 7265 706f 7374  t=False, prepost
+00020a60: 3d70 7265 706f 7374 2c20 6b65 6570 6e61  =prepost, keepna
+00020a70: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+00020a80: 2020 2023 2065 6c69 6620 7365 6c66 2e69     # elif self.i
+00020a90: 6e74 6572 7661 6c20 696e 205b 7966 6364  nterval in [yfcd
+00020aa0: 2e49 6e74 6572 7661 6c2e 4461 7973 315d  .Interval.Days1]
+00020ab0: 3a20 2023 206f 7220 7365 6c66 2e5f 696e  :  # or self._in
+00020ac0: 6669 6e69 7465 5f72 6563 7572 7369 6f6e  finite_recursion
+00020ad0: 5f64 6574 6563 7465 643a 0a20 2020 2020  _detected:.     
+00020ae0: 2020 2020 2020 2023 2020 2020 2023 2041         #     # A
+00020af0: 7373 756d 6520 696e 6669 6e69 7465 2072  ssume infinite r
+00020b00: 6563 7572 7369 6f6e 2077 696c 6c20 6861  ecursion will ha
+00020b10: 7070 656e 0a20 2020 2020 2020 2020 2020  ppen.           
+00020b20: 2023 2020 2020 2064 665f 6669 6e65 203d   #     df_fine =
+00020b30: 2073 656c 662e 6461 742e 6869 7374 6f72   self.dat.histor
+00020b40: 7928 7374 6172 743d 6665 7463 685f 7374  y(start=fetch_st
+00020b50: 6172 742c 2065 6e64 3d66 6574 6368 5f65  art, end=fetch_e
+00020b60: 6e64 2c20 696e 7465 7276 616c 3d79 6663  nd, interval=yfc
+00020b70: 642e 696e 7465 7276 616c 546f 5374 7269  d.intervalToStri
+00020b80: 6e67 5b73 7562 5f69 6e74 6572 7661 6c5d  ng[sub_interval]
+00020b90: 2c20 6175 746f 5f61 646a 7573 743d 4661  , auto_adjust=Fa
+00020ba0: 6c73 652c 2072 6570 6169 723d 2273 696c  lse, repair="sil
+00020bb0: 656e 7422 290a 2020 2020 2020 2020 2020  ent").          
+00020bc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00020bd0: 2020 2020 2020 2020 6966 2070 7265 706f          if prepo
+00020be0: 7374 2061 6e64 2073 7562 5f69 6e74 7261  st and sub_intra
+00020bf0: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
+00020c00: 2020 2020 2020 2020 2023 2059 4643 2063           # YFC c
+00020c10: 616e 6e6f 7420 6861 6e64 6c65 2069 6e74  annot handle int
+00020c20: 7261 6461 7920 7072 652d 2061 6e64 2070  raday pre- and p
+00020c30: 6f73 742d 6d61 726b 6574 2c20 736f 2066  ost-market, so f
+00020c40: 6574 6368 2076 6961 2079 6669 6e61 6e63  etch via yfinanc
+00020c50: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00020c60: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
+00020c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c80: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+00020c90: 222d 2066 6574 6368 696e 6720 6466 5f66  "- fetching df_f
+00020ca0: 696e 6520 6469 7265 6374 2066 726f 6d20  ine direct from 
+00020cb0: 5946 2229 0a20 2020 2020 2020 2020 2020  YF").           
+00020cc0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00020cd0: 6e74 2866 222d 202d 2066 6574 6368 5f73  nt(f"- - fetch_s
+00020ce0: 7461 7274 3d7b 6665 7463 685f 7374 6172  tart={fetch_star
+00020cf0: 747d 2066 6574 6368 5f65 6e64 3d7b 6665  t} fetch_end={fe
+00020d00: 7463 685f 656e 647d 2229 0a20 2020 2020  tch_end}").     
+00020d10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00020d20: 665f 6669 6e65 5f6f 6c64 203d 2073 656c  f_fine_old = sel
+00020d30: 662e 6461 742e 6869 7374 6f72 7928 7374  f.dat.history(st
+00020d40: 6172 743d 6665 7463 685f 7374 6172 742c  art=fetch_start,
+00020d50: 2065 6e64 3d66 6574 6368 5f65 6e64 2c20   end=fetch_end, 
+00020d60: 696e 7465 7276 616c 3d79 6663 642e 696e  interval=yfcd.in
+00020d70: 7465 7276 616c 546f 5374 7269 6e67 5b73  tervalToString[s
+00020d80: 7562 5f69 6e74 6572 7661 6c5d 2c20 6175  ub_interval], au
+00020d90: 746f 5f61 646a 7573 743d 5472 7565 2c20  to_adjust=True, 
+00020da0: 7072 6570 6f73 743d 7072 6570 6f73 7429  prepost=prepost)
+00020db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020dc0: 2020 2020 2068 6973 745f 7375 6220 3d20       hist_sub = 
+00020dd0: 7365 6c66 2e6d 616e 6167 6572 2e47 6574  self.manager.Get
+00020de0: 4869 7374 6f72 7928 7375 625f 696e 7465  History(sub_inte
+00020df0: 7276 616c 290a 2020 2020 2020 2020 2020  rval).          
+00020e00: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00020e10: 2069 7369 6e73 7461 6e63 6528 6665 7463   isinstance(fetc
+00020e20: 685f 7374 6172 742c 2064 6174 6574 696d  h_start, datetim
+00020e30: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00020e40: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00020e50: 685f 7374 6172 7420 3d20 6461 7465 7469  h_start = dateti
+00020e60: 6d65 2e63 6f6d 6269 6e65 2866 6574 6368  me.combine(fetch
+00020e70: 5f73 7461 7274 2c20 7469 6d65 2830 292c  _start, time(0),
+00020e80: 205a 6f6e 6549 6e66 6f28 7365 6c66 2e74   ZoneInfo(self.t
+00020e90: 7a4e 616d 6529 290a 2020 2020 2020 2020  zName)).        
+00020ea0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00020eb0: 6f74 2069 7369 6e73 7461 6e63 6528 6665  ot isinstance(fe
+00020ec0: 7463 685f 656e 642c 2064 6174 6574 696d  tch_end, datetim
+00020ed0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00020ee0: 2020 2020 2020 2020 2020 2020 6665 7463              fetc
+00020ef0: 685f 656e 6420 3d20 6461 7465 7469 6d65  h_end = datetime
+00020f00: 2e63 6f6d 6269 6e65 2866 6574 6368 5f65  .combine(fetch_e
+00020f10: 6e64 2c20 7469 6d65 2830 292c 205a 6f6e  nd, time(0), Zon
+00020f20: 6549 6e66 6f28 7365 6c66 2e74 7a4e 616d  eInfo(self.tzNam
+00020f30: 6529 290a 2020 2020 2020 2020 2020 2020  e)).            
+00020f40: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00020f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020f60: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00020f70: 222d 2066 6574 6368 696e 6720 6466 5f66  "- fetching df_f
+00020f80: 696e 6520 7669 6120 5f66 6574 6368 5966  ine via _fetchYf
+00020f90: 4869 7374 6f72 7928 2920 7772 6170 7065  History() wrappe
+00020fa0: 7222 290a 2020 2020 2020 2020 2020 2020  r").            
+00020fb0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00020fc0: 7428 6622 2d20 2d20 6665 7463 685f 7374  t(f"- - fetch_st
+00020fd0: 6172 743d 7b66 6574 6368 5f73 7461 7274  art={fetch_start
+00020fe0: 7d20 6665 7463 685f 656e 643d 7b66 6574  } fetch_end={fet
+00020ff0: 6368 5f65 6e64 7d22 290a 2020 2020 2020  ch_end}").      
+00021000: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00021010: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00021020: 2020 2020 2020 2020 2020 2064 665f 6669             df_fi
+00021030: 6e65 203d 2068 6973 745f 7375 622e 5f66  ne = hist_sub._f
+00021040: 6574 6368 5966 4869 7374 6f72 7928 7073  etchYfHistory(ps
+00021050: 7472 3d4e 6f6e 652c 2073 7461 7274 3d66  tr=None, start=f
+00021060: 6574 6368 5f73 7461 7274 2c20 656e 643d  etch_start, end=
+00021070: 6665 7463 685f 656e 642c 2070 7265 706f  fetch_end, prepo
+00021080: 7374 3d70 7265 706f 7374 2c20 6465 6275  st=prepost, debu
+00021090: 673d 4661 6c73 652c 2076 6572 6966 795f  g=False, verify_
+000210a0: 696e 7465 7276 616c 733d 4661 6c73 652c  intervals=False,
+000210b0: 2064 6973 6162 6c65 5f79 6663 5f6d 6574   disable_yfc_met
+000210c0: 6164 6174 613d 5472 7565 290a 2020 2020  adata=True).    
+000210d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000210e0: 6578 6365 7074 2079 6663 642e 4e6f 5072  except yfcd.NoPr
+000210f0: 6963 6544 6174 6149 6e52 616e 6765 4578  iceDataInRangeEx
+00021100: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
+00021110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021120: 2020 2020 2020 6966 2064 6562 7567 3a0a        if debug:.
+00021130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021140: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00021150: 7428 222d 2066 6574 6368 206f 6620 6669  t("- fetch of fi
+00021160: 6e65 2070 7269 6365 2064 6174 6120 6661  ne price data fa
+00021170: 696c 6564 3a22 202b 2073 7472 2865 2929  iled:" + str(e))
+00021180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021190: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+000211a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000211b0: 2020 2020 2020 6966 2064 665f 6669 6e65        if df_fine
+000211c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000211d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211e0: 2020 2020 2020 6164 6a20 3d20 2864 665f        adj = (df_
+000211f0: 6669 6e65 5b22 4164 6a20 436c 6f73 6522  fine["Adj Close"
+00021200: 5d2f 6466 5f66 696e 655b 2243 6c6f 7365  ]/df_fine["Close
+00021210: 225d 292e 746f 5f6e 756d 7079 2829 0a20  "]).to_numpy(). 
+00021220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021230: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
+00021240: 5b22 4f70 656e 222c 2022 4c6f 7722 2c20  ["Open", "Low", 
+00021250: 2248 6967 6822 2c20 2243 6c6f 7365 225d  "High", "Close"]
+00021260: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021270: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00021280: 5f66 696e 655b 635d 202a 3d20 6164 6a0a  _fine[c] *= adj.
+00021290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000212a0: 2020 2020 2020 2020 6466 5f66 696e 6520          df_fine 
+000212b0: 3d20 6466 5f66 696e 655b 5b22 4f70 656e  = df_fine[["Open
+000212c0: 222c 2022 4c6f 7722 2c20 2248 6967 6822  ", "Low", "High"
+000212d0: 2c20 2243 6c6f 7365 222c 2022 566f 6c75  , "Close", "Volu
+000212e0: 6d65 222c 2022 4469 7669 6465 6e64 7322  me", "Dividends"
+000212f0: 2c20 2253 746f 636b 2053 706c 6974 7322  , "Stock Splits"
+00021300: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
+00021310: 2020 2020 2020 2069 6620 6465 6275 673a         if debug:
+00021320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021330: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+00021340: 6466 5f66 696e 655f 6f6c 643a 2229 0a20  df_fine_old:"). 
+00021350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021360: 2020 2020 2020 2070 7269 6e74 2864 665f         print(df_
+00021370: 6669 6e65 5f6f 6c64 290a 2020 2020 2020  fine_old).      
+00021380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021390: 2020 7072 696e 7428 2264 665f 6669 6e65    print("df_fine
+000213a0: 3a22 290a 2020 2020 2020 2020 2020 2020  :").            
+000213b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000213c0: 7428 6466 5f66 696e 6529 0a20 2020 2020  t(df_fine).     
+000213d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000213e0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
+000213f0: 2822 6865 7265 2229 0a20 2020 2020 2020  ("here").       
+00021400: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00021410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021420: 2020 2069 6620 6465 6275 673a 0a20 2020     if debug:.   
+00021430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021440: 2020 2020 2070 7269 6e74 2822 2d20 6665       print("- fe
+00021450: 7463 6869 6e67 2064 665f 6669 6e65 2076  tching df_fine v
+00021460: 6961 2059 4643 2229 0a20 2020 2020 2020  ia YFC").       
+00021470: 2020 2020 2020 2020 2020 2020 2068 6973               his
+00021480: 745f 7375 6220 3d20 7365 6c66 2e6d 616e  t_sub = self.man
+00021490: 6167 6572 2e47 6574 4869 7374 6f72 7928  ager.GetHistory(
+000214a0: 7375 625f 696e 7465 7276 616c 290a 2020  sub_interval).  
+000214b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214c0: 2020 6466 5f66 696e 6520 3d20 6869 7374    df_fine = hist
+000214d0: 5f73 7562 2e67 6574 2866 6574 6368 5f73  _sub.get(fetch_s
+000214e0: 7461 7274 2c20 6665 7463 685f 656e 642c  tart, fetch_end,
+000214f0: 2061 646a 7573 745f 7370 6c69 7473 3d46   adjust_splits=F
+00021500: 616c 7365 2c20 6164 6a75 7374 5f64 6976  alse, adjust_div
+00021510: 733d 4661 6c73 652c 2072 6570 6169 723d  s=False, repair=
+00021520: 4661 6c73 652c 2070 7265 706f 7374 3d70  False, prepost=p
+00021530: 7265 706f 7374 290a 2020 2020 2020 2020  repost).        
+00021540: 2020 2020 2020 2020 2320 6466 5f66 696e          # df_fin
+00021550: 655b 2241 646a 2043 6c6f 7365 225d 203d  e["Adj Close"] =
+00021560: 2064 665f 6669 6e65 5b22 436c 6f73 6522   df_fine["Close"
+00021570: 5d20 2a20 6466 5f66 696e 655b 2243 4446  ] * df_fine["CDF
+00021580: 225d 0a20 2020 2020 2020 2020 2020 2069  "].            i
+00021590: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
+000215a0: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
+000215b0: 2d20 6466 5f66 696e 653a 2229 0a20 2020  - df_fine:").   
+000215c0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+000215d0: 6e74 2864 665f 6669 6e65 290a 2020 2020  nt(df_fine).    
+000215e0: 2020 2020 2020 2020 6966 2064 665f 6669          if df_fi
+000215f0: 6e65 2069 7320 4e6f 6e65 206f 7220 6c65  ne is None or le
+00021600: 6e28 6466 5f66 696e 6529 203d 3d20 303a  n(df_fine) == 0:
+00021610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021620: 2070 7269 6e74 2822 5946 3a20 5741 524e   print("YF: WARN
+00021630: 494e 473a 2043 616e 6e6f 7420 7265 636f  ING: Cannot reco
+00021640: 6e73 7472 7563 7420 6265 6361 7573 6520  nstruct because 
+00021650: 5961 686f 6f20 6e6f 7420 7265 7475 726e  Yahoo not return
+00021660: 696e 6720 6461 7461 2069 6e20 696e 7465  ing data in inte
+00021670: 7276 616c 2229 0a20 2020 2020 2020 2020  rval").         
+00021680: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
+00021690: 7265 636f 7264 5f73 7461 636b 5f74 7261  record_stack_tra
+000216a0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+000216b0: 2020 2020 2020 2020 2320 506f 7020 7374          # Pop st
+000216c0: 6163 6b20 7472 6163 650a 2020 2020 2020  ack trace.      
+000216d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000216e0: 206c 656e 2873 656c 662e 5f73 7461 636b   len(self._stack
+000216f0: 5f74 7261 6365 2920 3d3d 2030 3a0a 2020  _trace) == 0:.  
+00021700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021710: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+00021720: 7074 696f 6e28 2246 6169 6c69 6e67 2074  ption("Failing t
+00021730: 6f20 636f 7272 6563 746c 7920 7075 7368  o correctly push
+00021740: 2f70 6f70 2073 7461 636b 2074 7261 6365  /pop stack trace
+00021750: 2028 6973 2065 6d70 7479 2074 6f6f 2065   (is empty too e
+00021760: 6172 6c79 2922 290a 2020 2020 2020 2020  arly)").        
+00021770: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00021780: 6f74 2073 656c 662e 5f73 7461 636b 5f74  ot self._stack_t
+00021790: 7261 6365 5b2d 315d 203d 3d20 666e 5f74  race[-1] == fn_t
+000217a0: 7570 6c65 3a0a 2020 2020 2020 2020 2020  uple:.          
+000217b0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000217c0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
+000217d0: 2873 656c 662e 5f73 7461 636b 5f74 7261  (self._stack_tra
+000217e0: 6365 2929 3a0a 2020 2020 2020 2020 2020  ce)):.          
+000217f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021800: 2020 7072 696e 7428 2220 2022 2a69 202b    print("  "*i +
+00021810: 2073 7472 2873 656c 662e 5f73 7461 636b   str(self._stack
+00021820: 5f74 7261 6365 5b69 5d29 290a 2020 2020  _trace[i])).    
+00021830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021840: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
+00021850: 696f 6e28 2246 6169 6c69 6e67 2074 6f20  ion("Failing to 
+00021860: 636f 7272 6563 746c 7920 7075 7368 2f70  correctly push/p
+00021870: 6f70 2073 7461 636b 2074 7261 6365 2028  op stack trace (
+00021880: 7365 6520 6162 6f76 6529 2229 0a20 2020  see above)").   
+00021890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000218a0: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
+000218b0: 6365 2e70 6f70 286c 656e 2873 656c 662e  ce.pop(len(self.
+000218c0: 5f73 7461 636b 5f74 7261 6365 2920 2d20  _stack_trace) - 
+000218d0: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+000218e0: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+000218f0: 2020 2020 2020 2020 2064 665f 6669 6e65           df_fine
+00021900: 5b22 6374 7222 5d20 3d20 300a 2020 2020  ["ctr"] = 0.    
+00021910: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00021920: 696e 7465 7276 616c 203d 3d20 7966 6364  interval == yfcd
+00021930: 2e49 6e74 6572 7661 6c2e 5765 656b 3a0a  .Interval.Week:.
+00021940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021950: 2320 6466 5f66 696e 655b 2257 6565 6b20  # df_fine["Week 
+00021960: 5374 6172 7422 5d20 3d20 6466 5f66 696e  Start"] = df_fin
+00021970: 652e 696e 6465 782e 747a 5f6c 6f63 616c  e.index.tz_local
+00021980: 697a 6528 4e6f 6e65 292e 746f 5f70 6572  ize(None).to_per
+00021990: 696f 6428 2257 2d53 554e 2229 2e73 7461  iod("W-SUN").sta
+000219a0: 7274 5f74 696d 650a 2020 2020 2020 2020  rt_time.        
+000219b0: 2020 2020 2020 2020 7765 656b 6461 7973          weekdays
+000219c0: 203d 205b 224d 4f4e 222c 2022 5455 4522   = ["MON", "TUE"
+000219d0: 2c20 2257 4544 222c 2022 5448 5522 2c20  , "WED", "THU", 
+000219e0: 2246 5249 222c 2022 5341 5422 2c20 2253  "FRI", "SAT", "S
+000219f0: 554e 225d 0a20 2020 2020 2020 2020 2020  UN"].           
+00021a00: 2020 2020 2077 6565 6b5f 656e 645f 6461       week_end_da
+00021a10: 7920 3d20 7765 656b 6461 7973 5b28 6466  y = weekdays[(df
+00021a20: 5f62 6c6f 636b 2e69 6e64 6578 5b30 5d2e  _block.index[0].
+00021a30: 7765 656b 6461 7928 2920 2b20 3720 2d20  weekday() + 7 - 
+00021a40: 3129 2025 2037 5d0a 2020 2020 2020 2020  1) % 7].        
+00021a50: 2020 2020 2020 2020 6466 5f66 696e 655b          df_fine[
+00021a60: 2257 6565 6b20 5374 6172 7422 5d20 3d20  "Week Start"] = 
+00021a70: 6466 5f66 696e 652e 696e 6465 782e 747a  df_fine.index.tz
+00021a80: 5f6c 6f63 616c 697a 6528 4e6f 6e65 292e  _localize(None).
+00021a90: 746f 5f70 6572 696f 6428 2257 2d22 2b77  to_period("W-"+w
+00021aa0: 6565 6b5f 656e 645f 6461 7929 2e73 7461  eek_end_day).sta
+00021ab0: 7274 5f74 696d 650a 2020 2020 2020 2020  rt_time.        
+00021ac0: 2020 2020 2020 2020 6772 705f 636f 6c20          grp_col 
+00021ad0: 3d20 2257 6565 6b20 5374 6172 7422 0a20  = "Week Start". 
+00021ae0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00021af0: 7365 6c66 2e69 6e74 6572 7661 6c20 3d3d  self.interval ==
+00021b00: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
+00021b10: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
+00021b20: 2020 2020 2020 6466 5f66 696e 655b 2244        df_fine["D
+00021b30: 6179 2053 7461 7274 225d 203d 2070 642e  ay Start"] = pd.
+00021b40: 746f 5f64 6174 6574 696d 6528 6466 5f66  to_datetime(df_f
+00021b50: 696e 652e 696e 6465 782e 6461 7465 290a  ine.index.date).
+00021b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b70: 6772 705f 636f 6c20 3d20 2244 6179 2053  grp_col = "Day S
+00021b80: 7461 7274 220a 2020 2020 2020 2020 2020  tart".          
+00021b90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00021ba0: 2020 2020 2020 2020 6466 5f66 696e 652e          df_fine.
+00021bb0: 6c6f 635b 6466 5f66 696e 652e 696e 6465  loc[df_fine.inde
+00021bc0: 782e 6973 696e 2864 665f 626c 6f63 6b2e  x.isin(df_block.
+00021bd0: 696e 6465 7829 2c20 2263 7472 225d 203d  index), "ctr"] =
+00021be0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00021bf0: 2020 2064 665f 6669 6e65 5b22 696e 7465     df_fine["inte
+00021c00: 7276 616c 4944 225d 203d 2064 665f 6669  rvalID"] = df_fi
+00021c10: 6e65 5b22 6374 7222 5d2e 6375 6d73 756d  ne["ctr"].cumsum
+00021c20: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00021c30: 2020 2064 665f 6669 6e65 203d 2064 665f     df_fine = df_
+00021c40: 6669 6e65 2e64 726f 7028 2263 7472 222c  fine.drop("ctr",
+00021c50: 2061 7869 733d 3129 0a20 2020 2020 2020   axis=1).       
+00021c60: 2020 2020 2020 2020 2067 7270 5f63 6f6c           grp_col
+00021c70: 203d 2022 696e 7465 7276 616c 4944 220a   = "intervalID".
+00021c80: 2020 2020 2020 2020 2020 2020 2320 6466              # df
+00021c90: 5f66 696e 6520 3d20 6466 5f66 696e 655b  _fine = df_fine[
+00021ca0: 7e64 665f 6669 6e65 5b70 7269 6365 5f63  ~df_fine[price_c
+00021cb0: 6f6c 735d 2e69 736e 6128 292e 616c 6c28  ols].isna().all(
+00021cc0: 6178 6973 3d31 295d 0a0a 2020 2020 2020  axis=1)]..      
+00021cd0: 2020 2020 2020 6466 5f6e 6577 203d 2064        df_new = d
+00021ce0: 665f 6669 6e65 2e67 726f 7570 6279 2867  f_fine.groupby(g
+00021cf0: 7270 5f63 6f6c 292e 6167 6728 0a20 2020  rp_col).agg(.   
+00021d00: 2020 2020 2020 2020 2020 2020 204f 7065               Ope
+00021d10: 6e3d 2822 4f70 656e 222c 2022 6669 7273  n=("Open", "firs
+00021d20: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
+00021d30: 2020 2020 2043 6c6f 7365 3d28 2243 6c6f       Close=("Clo
+00021d40: 7365 222c 2022 6c61 7374 2229 2c0a 2020  se", "last"),.  
+00021d50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00021d60: 4164 6a43 6c6f 7365 3d28 2241 646a 2043  AdjClose=("Adj C
+00021d70: 6c6f 7365 222c 2022 6c61 7374 2229 2c0a  lose", "last"),.
+00021d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d90: 4c6f 773d 2822 4c6f 7722 2c20 226d 696e  Low=("Low", "min
+00021da0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00021db0: 2020 2020 4869 6768 3d28 2248 6967 6822      High=("High"
+00021dc0: 2c20 226d 6178 2229 2c0a 2020 2020 2020  , "max"),.      
+00021dd0: 2020 2020 2020 2020 2020 566f 6c75 6d65            Volume
+00021de0: 3d28 2256 6f6c 756d 6522 2c20 2273 756d  =("Volume", "sum
+00021df0: 2229 290a 2020 2020 2020 2020 2020 2020  ")).            
+00021e00: 2020 2020 2320 4353 463d 2822 4353 4622      # CSF=("CSF"
+00021e10: 2c20 2266 6972 7374 2229 2c0a 2020 2020  , "first"),.    
+00021e20: 2020 2020 2020 2020 2020 2020 2320 4344              # CD
+00021e30: 463d 2822 4344 4622 2c20 2266 6972 7374  F=("CDF", "first
+00021e40: 2229 2923 2e72 656e 616d 6528 636f 6c75  "))#.rename(colu
+00021e50: 6d6e 733d 7b22 4164 6a43 6c6f 7365 223a  mns={"AdjClose":
+00021e60: 2022 4164 6a20 436c 6f73 6522 7d29 0a20   "Adj Close"}). 
+00021e70: 2020 2020 2020 2020 2020 2069 6620 6772             if gr
+00021e80: 705f 636f 6c20 696e 205b 2257 6565 6b20  p_col in ["Week 
+00021e90: 5374 6172 7422 2c20 2244 6179 2053 7461  Start", "Day Sta
+00021ea0: 7274 225d 3a0a 2020 2020 2020 2020 2020  rt"]:.          
+00021eb0: 2020 2020 2020 6466 5f6e 6577 2e69 6e64        df_new.ind
+00021ec0: 6578 203d 2064 665f 6e65 772e 696e 6465  ex = df_new.inde
+00021ed0: 782e 747a 5f6c 6f63 616c 697a 6528 6466  x.tz_localize(df
+00021ee0: 5f66 696e 652e 696e 6465 782e 747a 290a  _fine.index.tz).
+00021ef0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00021f00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021f10: 2020 6466 5f66 696e 655b 2264 6966 6622    df_fine["diff"
+00021f20: 5d20 3d20 6466 5f66 696e 655b 2269 6e74  ] = df_fine["int
+00021f30: 6572 7661 6c49 4422 5d2e 6469 6666 2829  ervalID"].diff()
+00021f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021f50: 206e 6577 5f69 6e64 6578 203d 206e 702e   new_index = np.
+00021f60: 6170 7065 6e64 285b 6466 5f66 696e 652e  append([df_fine.
+00021f70: 696e 6465 785b 305d 5d2c 2064 665f 6669  index[0]], df_fi
+00021f80: 6e65 2e69 6e64 6578 5b64 665f 6669 6e65  ne.index[df_fine
+00021f90: 5b22 696e 7465 7276 616c 4944 225d 2e64  ["intervalID"].d
+00021fa0: 6966 6628 2920 3e20 305d 290a 2020 2020  iff() > 0]).    
+00021fb0: 2020 2020 2020 2020 2020 2020 6466 5f6e              df_n
+00021fc0: 6577 2e69 6e64 6578 203d 206e 6577 5f69  ew.index = new_i
+00021fd0: 6e64 6578 0a0a 2020 2020 2020 2020 2020  ndex..          
+00021fe0: 2020 2320 4361 6c69 6272 6174 6521 2043    # Calibrate! C
+00021ff0: 6865 636b 2077 6865 7468 6572 2027 6466  heck whether 'df
+00022000: 5f66 696e 6527 2068 6173 2064 6966 6665  _fine' has diffe
+00022010: 7265 6e74 2073 706c 6974 2d61 646a 7573  rent split-adjus
+00022020: 746d 656e 742e 0a20 2020 2020 2020 2020  tment..         
+00022030: 2020 2023 2049 6620 6469 6666 6572 656e     # If differen
+00022040: 742c 2074 6865 6e20 6164 6a75 7374 2074  t, then adjust t
+00022050: 6f20 6d61 7463 6820 2764 6627 0a20 2020  o match 'df'.   
+00022060: 2020 2020 2020 2020 2064 665f 626c 6f63           df_bloc
+00022070: 6b5f 6361 6c69 6220 3d20 6466 5f62 6c6f  k_calib = df_blo
+00022080: 636b 5b70 7269 6365 5f63 6f6c 735d 0a20  ck[price_cols]. 
+00022090: 2020 2020 2020 2020 2020 2023 2064 665f             # df_
+000220a0: 6e65 775f 6361 6c69 6220 3d20 6466 5f6e  new_calib = df_n
+000220b0: 6577 5b64 665f 6e65 772e 696e 6465 782e  ew[df_new.index.
+000220c0: 6973 696e 2864 665f 626c 6f63 6b5f 6361  isin(df_block_ca
+000220d0: 6c69 622e 696e 6465 7829 5d5b 7072 6963  lib.index)][pric
+000220e0: 655f 636f 6c73 5d0a 2020 2020 2020 2020  e_cols].        
+000220f0: 2020 2020 2320 6466 5f62 6c6f 636b 5f63      # df_block_c
+00022100: 616c 6962 203d 2064 665f 626c 6f63 6b5f  alib = df_block_
+00022110: 6361 6c69 625b 6466 5f62 6c6f 636b 5f63  calib[df_block_c
+00022120: 616c 6962 2e69 6e64 6578 2e69 7369 6e28  alib.index.isin(
+00022130: 6466 5f6e 6577 5f63 616c 6962 295d 0a20  df_new_calib)]. 
+00022140: 2020 2020 2020 2020 2020 2063 6f6d 6d6f             commo
+00022150: 6e5f 696e 6465 7820 3d20 6e70 2e69 6e74  n_index = np.int
+00022160: 6572 7365 6374 3164 2864 665f 626c 6f63  ersect1d(df_bloc
+00022170: 6b5f 6361 6c69 622e 696e 6465 782c 2064  k_calib.index, d
+00022180: 665f 6e65 772e 696e 6465 7829 0a20 2020  f_new.index).   
+00022190: 2020 2020 2020 2020 2064 665f 6e65 775f           df_new_
+000221a0: 6361 6c69 6220 3d20 6466 5f6e 6577 5b70  calib = df_new[p
+000221b0: 7269 6365 5f63 6f6c 735d 2e6c 6f63 5b63  rice_cols].loc[c
+000221c0: 6f6d 6d6f 6e5f 696e 6465 785d 0a20 2020  ommon_index].   
+000221d0: 2020 2020 2020 2020 2064 665f 626c 6f63           df_bloc
+000221e0: 6b5f 6361 6c69 6220 3d20 6466 5f62 6c6f  k_calib = df_blo
+000221f0: 636b 5f63 616c 6962 2e6c 6f63 5b63 6f6d  ck_calib.loc[com
+00022200: 6d6f 6e5f 696e 6465 785d 0a20 2020 2020  mon_index].     
+00022210: 2020 2020 2020 2063 616c 6962 5f66 696c         calib_fil
+00022220: 7465 7220 3d20 2864 665f 626c 6f63 6b5f  ter = (df_block_
+00022230: 6361 6c69 6220 213d 2074 6167 292e 746f  calib != tag).to
+00022240: 5f6e 756d 7079 2829 0a20 2020 2020 2020  _numpy().       
+00022250: 2020 2020 2069 6620 6e6f 7420 6361 6c69       if not cali
+00022260: 625f 6669 6c74 6572 2e61 6e79 2829 3a0a  b_filter.any():.
+00022270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022280: 2320 4361 6e27 7420 6361 6c69 6272 6174  # Can't calibrat
+00022290: 6520 736f 2064 6f6e 2774 2061 7474 656d  e so don't attem
+000222a0: 7074 2072 6570 6169 720a 2020 2020 2020  pt repair.      
+000222b0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000222c0: 662e 5f72 6563 6f72 645f 7374 6163 6b5f  f._record_stack_
+000222d0: 7472 6163 653a 0a20 2020 2020 2020 2020  trace:.         
+000222e0: 2020 2020 2020 2020 2020 2023 2050 6f70             # Pop
+000222f0: 2073 7461 636b 2074 7261 6365 0a20 2020   stack trace.   
+00022300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022310: 2069 6620 6c65 6e28 7365 6c66 2e5f 7374   if len(self._st
+00022320: 6163 6b5f 7472 6163 6529 203d 3d20 303a  ack_trace) == 0:
+00022330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022340: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+00022350: 7863 6570 7469 6f6e 2822 4661 696c 696e  xception("Failin
+00022360: 6720 746f 2063 6f72 7265 6374 6c79 2070  g to correctly p
+00022370: 7573 682f 706f 7020 7374 6163 6b20 7472  ush/pop stack tr
+00022380: 6163 6520 2869 7320 656d 7074 7920 746f  ace (is empty to
+00022390: 6f20 6561 726c 7929 2229 0a20 2020 2020  o early)").     
+000223a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000223b0: 6620 6e6f 7420 7365 6c66 2e5f 7374 6163  f not self._stac
+000223c0: 6b5f 7472 6163 655b 2d31 5d20 3d3d 2066  k_trace[-1] == f
+000223d0: 6e5f 7475 706c 653a 0a20 2020 2020 2020  n_tuple:.       
+000223e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000223f0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00022400: 6c65 6e28 7365 6c66 2e5f 7374 6163 6b5f  len(self._stack_
+00022410: 7472 6163 6529 293a 0a20 2020 2020 2020  trace)):.       
+00022420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022430: 2020 2020 2070 7269 6e74 2822 2020 222a       print("  "*
+00022440: 6920 2b20 7374 7228 7365 6c66 2e5f 7374  i + str(self._st
+00022450: 6163 6b5f 7472 6163 655b 695d 2929 0a20  ack_trace[i])). 
+00022460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022470: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
+00022480: 6570 7469 6f6e 2822 4661 696c 696e 6720  eption("Failing 
+00022490: 746f 2063 6f72 7265 6374 6c79 2070 7573  to correctly pus
+000224a0: 682f 706f 7020 7374 6163 6b20 7472 6163  h/pop stack trac
+000224b0: 6520 2873 6565 2061 626f 7665 2922 290a  e (see above)").
+000224c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000224d0: 2020 2020 7365 6c66 2e5f 7374 6163 6b5f      self._stack_
+000224e0: 7472 6163 652e 706f 7028 6c65 6e28 7365  trace.pop(len(se
+000224f0: 6c66 2e5f 7374 6163 6b5f 7472 6163 6529  lf._stack_trace)
+00022500: 202d 2031 290a 2020 2020 2020 2020 2020   - 1).          
+00022510: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00022520: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00022530: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
+00022540: 2020 2020 2070 7269 6e74 2822 6361 6c69       print("cali
+00022550: 625f 6669 6c74 6572 3a22 2920 3b20 7072  b_filter:") ; pr
+00022560: 696e 7428 6361 6c69 625f 6669 6c74 6572  int(calib_filter
+00022570: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00022580: 2020 7072 696e 7428 2264 665f 6e65 775f    print("df_new_
+00022590: 6361 6c69 623a 2229 203b 2070 7269 6e74  calib:") ; print
+000225a0: 2864 665f 6e65 775f 6361 6c69 6229 0a20  (df_new_calib). 
+000225b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000225c0: 7269 6e74 2822 6466 5f62 6c6f 636b 5f63  rint("df_block_c
+000225d0: 616c 6962 3a22 2920 3b20 7072 696e 7428  alib:") ; print(
+000225e0: 6466 5f62 6c6f 636b 5f63 616c 6962 290a  df_block_calib).
+000225f0: 2020 2020 2020 2020 2020 2020 2320 4176              # Av
+00022600: 6f69 6420 6469 7669 6465 2d62 792d 7a65  oid divide-by-ze
+00022610: 726f 2077 6172 6e69 6e67 7320 7072 696e  ro warnings prin
+00022620: 7469 6e67 3a0a 2020 2020 2020 2020 2020  ting:.          
+00022630: 2020 6466 5f6e 6577 5f63 616c 6962 203d    df_new_calib =
+00022640: 2064 665f 6e65 775f 6361 6c69 622e 746f   df_new_calib.to
+00022650: 5f6e 756d 7079 2829 0a20 2020 2020 2020  _numpy().       
+00022660: 2020 2020 2064 665f 626c 6f63 6b5f 6361       df_block_ca
+00022670: 6c69 6220 3d20 6466 5f62 6c6f 636b 5f63  lib = df_block_c
+00022680: 616c 6962 2e74 6f5f 6e75 6d70 7928 290a  alib.to_numpy().
+00022690: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000226a0: 6a20 696e 2072 616e 6765 286c 656e 2870  j in range(len(p
+000226b0: 7269 6365 5f63 6f6c 7329 293a 0a20 2020  rice_cols)):.   
+000226c0: 2020 2020 2020 2020 2020 2020 2063 203d               c =
+000226d0: 2070 7269 6365 5f63 6f6c 735b 6a5d 0a20   price_cols[j]. 
+000226e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000226f0: 203d 207e 6361 6c69 625f 6669 6c74 6572   = ~calib_filter
+00022700: 5b3a 2c20 6a5d 0a20 2020 2020 2020 2020  [:, j].         
+00022710: 2020 2020 2020 2069 6620 662e 616e 7928         if f.any(
+00022720: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00022730: 2020 2020 2020 2064 665f 626c 6f63 6b5f         df_block_
+00022740: 6361 6c69 625b 662c 206a 5d20 3d20 310a  calib[f, j] = 1.
+00022750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022760: 2020 2020 6466 5f6e 6577 5f63 616c 6962      df_new_calib
+00022770: 5b66 2c20 6a5d 203d 2031 0a20 2020 2020  [f, j] = 1.     
+00022780: 2020 2020 2020 2072 6174 696f 7320 3d20         ratios = 
+00022790: 2864 665f 626c 6f63 6b5f 6361 6c69 6220  (df_block_calib 
+000227a0: 2f20 6466 5f6e 6577 5f63 616c 6962 295b  / df_new_calib)[
+000227b0: 6361 6c69 625f 6669 6c74 6572 5d0a 2020  calib_filter].  
+000227c0: 2020 2020 2020 2020 2020 7261 7469 6f20            ratio 
+000227d0: 3d20 6e70 2e6d 6561 6e28 7261 7469 6f73  = np.mean(ratios
+000227e0: 290a 2020 2020 2020 2020 2020 2020 230a  ).            #.
+000227f0: 2020 2020 2020 2020 2020 2020 7261 7469              rati
+00022800: 6f5f 7263 7020 3d20 726f 756e 6428 312e  o_rcp = round(1.
+00022810: 3020 2f20 7261 7469 6f2c 2031 290a 2020  0 / ratio, 1).  
+00022820: 2020 2020 2020 2020 2020 7261 7469 6f20            ratio 
+00022830: 3d20 726f 756e 6428 7261 7469 6f2c 2031  = round(ratio, 1
+00022840: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00022850: 2072 6174 696f 203d 3d20 3120 616e 6420   ratio == 1 and 
+00022860: 7261 7469 6f5f 7263 7020 3d3d 2031 3a0a  ratio_rcp == 1:.
+00022870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022880: 2320 476f 6f64 210a 2020 2020 2020 2020  # Good!.        
+00022890: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+000228a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000228b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000228c0: 6620 7261 7469 6f20 3e20 313a 0a20 2020  f ratio > 1:.   
+000228d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228e0: 2023 2064 6174 6120 6861 7320 6469 6666   # data has diff
+000228f0: 6572 656e 7420 7370 6c69 742d 6164 6a75  erent split-adju
+00022900: 7374 6d65 6e74 2074 6861 6e20 6669 6e65  stment than fine
+00022910: 2d67 7261 696e 6564 2064 6174 610a 2020  -grained data.  
+00022920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022930: 2020 2320 4164 6a75 7374 2066 696e 652d    # Adjust fine-
+00022940: 6772 6169 6e65 6420 746f 206d 6174 6368  grained to match
+00022950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022960: 2020 2020 2064 665f 6e65 775b 7072 6963       df_new[pric
+00022970: 655f 636f 6c73 5d20 2a3d 2072 6174 696f  e_cols] *= ratio
+00022980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022990: 2020 2020 2064 665f 6e65 775b 2256 6f6c       df_new["Vol
+000229a0: 756d 6522 5d20 2f3d 2072 6174 696f 0a20  ume"] /= ratio. 
+000229b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000229c0: 6c69 6620 7261 7469 6f5f 7263 7020 3e20  lif ratio_rcp > 
+000229d0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+000229e0: 2020 2020 2020 2023 2064 6174 6120 6861         # data ha
+000229f0: 7320 6469 6666 6572 656e 7420 7370 6c69  s different spli
+00022a00: 742d 6164 6a75 7374 6d65 6e74 2074 6861  t-adjustment tha
+00022a10: 6e20 6669 6e65 2d67 7261 696e 6564 2064  n fine-grained d
+00022a20: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00022a30: 2020 2020 2020 2020 2320 4164 6a75 7374          # Adjust
+00022a40: 2066 696e 652d 6772 6169 6e65 6420 746f   fine-grained to
+00022a50: 206d 6174 6368 0a20 2020 2020 2020 2020   match.         
+00022a60: 2020 2020 2020 2020 2020 2064 665f 6e65             df_ne
+00022a70: 775b 7072 6963 655f 636f 6c73 5d20 2a3d  w[price_cols] *=
+00022a80: 2031 2e30 202f 2072 6174 696f 5f72 6370   1.0 / ratio_rcp
+00022a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022aa0: 2020 2020 2064 665f 6e65 775b 2256 6f6c       df_new["Vol
+00022ab0: 756d 6522 5d20 2a3d 2072 6174 696f 5f72  ume"] *= ratio_r
+00022ac0: 6370 0a0a 2020 2020 2020 2020 2020 2020  cp..            
+00022ad0: 2320 5265 7061 6972 210a 2020 2020 2020  # Repair!.      
+00022ae0: 2020 2020 2020 6261 645f 6474 7320 3d20        bad_dts = 
+00022af0: 6466 5f62 6c6f 636b 2e69 6e64 6578 5b28  df_block.index[(
+00022b00: 6466 5f62 6c6f 636b 5b70 7269 6365 5f63  df_block[price_c
+00022b10: 6f6c 735d 203d 3d20 7461 6729 2e61 6e79  ols] == tag).any
+00022b20: 2861 7869 733d 3129 5d0a 0a20 2020 2020  (axis=1)]..     
+00022b30: 2020 2020 2020 2066 6f72 2069 6478 2069         for idx i
+00022b40: 6e20 6261 645f 6474 733a 0a20 2020 2020  n bad_dts:.     
+00022b50: 2020 2020 2020 2020 2020 2069 6620 6964             if id
+00022b60: 7820 6e6f 7420 696e 2064 665f 6e65 772e  x not in df_new.
+00022b70: 696e 6465 783a 0a20 2020 2020 2020 2020  index:.         
+00022b80: 2020 2020 2020 2020 2020 2023 2059 6168             # Yah
+00022b90: 6f6f 2064 6964 6e27 7420 7265 7475 726e  oo didn't return
+00022ba0: 2066 696e 6572 2d67 7261 696e 2064 6174   finer-grain dat
+00022bb0: 6120 666f 7220 7468 6973 2069 6e74 6572  a for this inter
+00022bc0: 7661 6c2c 0a20 2020 2020 2020 2020 2020  val,.           
+00022bd0: 2020 2020 2020 2020 2023 2073 6f20 7072           # so pr
+00022be0: 6f62 6162 6c79 206e 6f20 7472 6164 696e  obably no tradin
+00022bf0: 6720 6861 7070 656e 6564 2e0a 2020 2020  g happened..    
+00022c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c10: 2320 7072 696e 7428 226e 6f20 6669 6e65  # print("no fine
+00022c20: 2064 6174 6122 290a 2020 2020 2020 2020   data").        
+00022c30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00022c40: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00022c50: 2020 2020 2064 665f 6e65 775f 726f 7720       df_new_row 
+00022c60: 3d20 6466 5f6e 6577 2e6c 6f63 5b69 6478  = df_new.loc[idx
+00022c70: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00022c80: 2020 2069 6620 7365 6c66 2e69 6e74 6572     if self.inter
+00022c90: 7661 6c20 3d3d 2079 6663 642e 496e 7465  val == yfcd.Inte
+00022ca0: 7276 616c 2e57 6565 6b3a 0a20 2020 2020  rval.Week:.     
+00022cb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00022cc0: 665f 6c61 7374 5f77 6565 6b20 3d20 6466  f_last_week = df
+00022cd0: 5f6e 6577 2e69 6c6f 635b 6466 5f6e 6577  _new.iloc[df_new
+00022ce0: 2e69 6e64 6578 2e67 6574 5f6c 6f63 2869  .index.get_loc(i
+00022cf0: 6478 292d 315d 0a20 2020 2020 2020 2020  dx)-1].         
+00022d00: 2020 2020 2020 2020 2020 2064 665f 6669             df_fi
+00022d10: 6e65 203d 2064 665f 6669 6e65 2e6c 6f63  ne = df_fine.loc
+00022d20: 5b69 6478 3a5d 0a0a 2020 2020 2020 2020  [idx:]..        
+00022d30: 2020 2020 2020 2020 6466 5f62 6164 5f72          df_bad_r
+00022d40: 6f77 203d 2064 662e 6c6f 635b 6964 785d  ow = df.loc[idx]
+00022d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022d60: 2062 6164 5f66 6965 6c64 7320 3d20 6466   bad_fields = df
+00022d70: 5f62 6164 5f72 6f77 2e69 6e64 6578 5b64  _bad_row.index[d
+00022d80: 665f 6261 645f 726f 7720 3d3d 2074 6167  f_bad_row == tag
+00022d90: 5d2e 746f 5f6e 756d 7079 2829 0a20 2020  ].to_numpy().   
+00022da0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00022db0: 2248 6967 6822 2069 6e20 6261 645f 6669  "High" in bad_fi
+00022dc0: 656c 6473 3a0a 2020 2020 2020 2020 2020  elds:.          
+00022dd0: 2020 2020 2020 2020 2020 6466 5f76 322e            df_v2.
+00022de0: 6c6f 635b 6964 782c 2022 4869 6768 225d  loc[idx, "High"]
+00022df0: 203d 2064 665f 6e65 775f 726f 775b 2248   = df_new_row["H
+00022e00: 6967 6822 5d0a 2020 2020 2020 2020 2020  igh"].          
+00022e10: 2020 2020 2020 6966 2022 4c6f 7722 2069        if "Low" i
+00022e20: 6e20 6261 645f 6669 656c 6473 3a0a 2020  n bad_fields:.  
 00022e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e40: 2020 2320 2020 2020 6964 7820 3d20 6466    #     idx = df
-00022e50: 5f62 6c6f 636b 2e69 6e64 6578 5b69 5d0a  _block.index[i].
-00022e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e70: 2020 2020 2320 2020 2020 6466 5f76 322e      #     df_v2.
-00022e80: 6c6f 635b 6964 782c 2063 5d20 3d20 6466  loc[idx, c] = df
-00022e90: 2e6c 6f63 5b69 6478 2c20 635d 0a20 2020  .loc[idx, c].   
-00022ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022eb0: 2064 665f 7632 2e6c 6f63 5b66 2c20 635d   df_v2.loc[f, c]
-00022ec0: 203d 2064 662e 6c6f 635b 662c 2063 5d0a   = df.loc[f, c].
-00022ed0: 2020 2020 2020 2020 2020 2020 2320 6966              # if
-00022ee0: 2066 5f66 6169 6c65 642e 616e 7928 293a   f_failed.any():
-00022ef0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00022f00: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00022f10: 6f6e 2822 6865 7265 2229 0a0a 2020 2020  on("here")..    
-00022f20: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00022f30: 5f72 6563 6f72 645f 7374 6163 6b5f 7472  _record_stack_tr
-00022f40: 6163 653a 0a20 2020 2020 2020 2020 2020  ace:.           
-00022f50: 2020 2020 2023 2050 6f70 2073 7461 636b       # Pop stack
-00022f60: 2074 7261 6365 0a20 2020 2020 2020 2020   trace.         
-00022f70: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
-00022f80: 6c66 2e5f 7374 6163 6b5f 7472 6163 6529  lf._stack_trace)
-00022f90: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00022fa0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00022fb0: 2045 7863 6570 7469 6f6e 2822 4661 696c   Exception("Fail
-00022fc0: 696e 6720 746f 2063 6f72 7265 6374 6c79  ing to correctly
-00022fd0: 2070 7573 682f 706f 7020 7374 6163 6b20   push/pop stack 
-00022fe0: 7472 6163 6520 2869 7320 656d 7074 7920  trace (is empty 
-00022ff0: 746f 6f20 6561 726c 7929 2229 0a20 2020  too early)").   
-00023000: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00023010: 6e6f 7420 7365 6c66 2e5f 7374 6163 6b5f  not self._stack_
-00023020: 7472 6163 655b 2d31 5d20 3d3d 2066 6e5f  trace[-1] == fn_
-00023030: 7475 706c 653a 0a20 2020 2020 2020 2020  tuple:.         
-00023040: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00023050: 2069 6e20 7261 6e67 6528 6c65 6e28 7365   in range(len(se
-00023060: 6c66 2e5f 7374 6163 6b5f 7472 6163 6529  lf._stack_trace)
-00023070: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00023080: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00023090: 2822 2020 222a 6920 2b20 7374 7228 7365  ("  "*i + str(se
-000230a0: 6c66 2e5f 7374 6163 6b5f 7472 6163 655b  lf._stack_trace[
-000230b0: 695d 2929 0a20 2020 2020 2020 2020 2020  i])).           
-000230c0: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
-000230d0: 7863 6570 7469 6f6e 2822 4661 696c 696e  xception("Failin
-000230e0: 6720 746f 2063 6f72 7265 6374 6c79 2070  g to correctly p
-000230f0: 7573 682f 706f 7020 7374 6163 6b20 7472  ush/pop stack tr
-00023100: 6163 6520 2873 6565 2061 626f 7665 2922  ace (see above)"
-00023110: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00023120: 2020 7365 6c66 2e5f 7374 6163 6b5f 7472    self._stack_tr
-00023130: 6163 652e 706f 7028 6c65 6e28 7365 6c66  ace.pop(len(self
-00023140: 2e5f 7374 6163 6b5f 7472 6163 6529 202d  ._stack_trace) -
-00023150: 2031 290a 0a20 2020 2020 2020 2023 2069   1)..        # i
-00023160: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00023170: 2023 2020 2020 2070 7269 6e74 2822 2d20   #     print("- 
-00023180: 6466 5f76 323a 2229 0a20 2020 2020 2020  df_v2:").       
-00023190: 2023 2020 2020 2070 7269 6e74 2864 665f   #     print(df_
-000231a0: 7632 290a 0a20 2020 2020 2020 206c 6f67  v2)..        log
-000231b0: 5f6d 7367 203d 2022 504d 3a3a 5f72 6563  _msg = "PM::_rec
-000231c0: 6f6e 7374 7275 6374 5f69 6e74 6572 7661  onstruct_interva
-000231d0: 6c73 5f62 6174 6368 2829 2072 6574 7572  ls_batch() retur
-000231e0: 6e69 6e67 220a 2020 2020 2020 2020 7966  ning".        yf
-000231f0: 636c 2e54 7261 6365 4578 6974 286c 6f67  cl.TraceExit(log
-00023200: 5f6d 7367 290a 0a20 2020 2020 2020 2072  _msg)..        r
-00023210: 6574 7572 6e20 6466 5f76 320a 0a20 2020  eturn df_v2..   
-00023220: 2064 6566 205f 7265 7061 6972 556e 6974   def _repairUnit
-00023230: 4d69 7875 7073 2873 656c 662c 2064 662c  Mixups(self, df,
-00023240: 2073 696c 656e 743d 4661 6c73 6529 3a0a   silent=False):.
-00023250: 2020 2020 2020 2020 7966 6375 2e54 7970          yfcu.Typ
-00023260: 6543 6865 636b 4461 7461 4672 616d 6528  eCheckDataFrame(
-00023270: 6466 2c20 2264 6622 290a 0a20 2020 2020  df, "df")..     
-00023280: 2020 2023 2053 6f6d 6574 696d 6573 2059     # Sometimes Y
-00023290: 6168 6f6f 2072 6574 7572 6e73 2066 6577  ahoo returns few
-000232a0: 2070 7269 6365 7320 696e 2063 656e 7473   prices in cents
-000232b0: 2f70 656e 6365 2069 6e73 7465 6164 206f  /pence instead o
-000232c0: 6620 242f c2a3 0a20 2020 2020 2020 2023  f $/...        #
-000232d0: 2049 2e65 2e20 3130 3078 2062 6967 6765   I.e. 100x bigge
-000232e0: 720a 2020 2020 2020 2020 2320 4561 7379  r.        # Easy
-000232f0: 2074 6f20 6465 7465 6374 2061 6e64 2066   to detect and f
-00023300: 6978 2c20 6a75 7374 206c 6f6f 6b20 666f  ix, just look fo
-00023310: 7220 6f75 746c 6965 7273 203d 207e 3130  r outliers = ~10
-00023320: 3078 206c 6f63 616c 206d 6564 6961 6e0a  0x local median.
-00023330: 0a20 2020 2020 2020 2069 6620 6466 2e65  .        if df.e
-00023340: 6d70 7479 3a0a 2020 2020 2020 2020 2020  mpty:.          
-00023350: 2020 7265 7475 726e 2064 660a 2020 2020    return df.    
-00023360: 2020 2020 6966 2064 662e 7368 6170 655b      if df.shape[
-00023370: 305d 203d 3d20 313a 0a20 2020 2020 2020  0] == 1:.       
-00023380: 2020 2020 2023 204e 6565 6420 6d75 6c74       # Need mult
-00023390: 6970 6c65 2072 6f77 7320 746f 2063 6f6e  iple rows to con
-000233a0: 6669 6465 6e74 6c79 2069 6465 6e74 6966  fidently identif
-000233b0: 7920 6f75 746c 6965 7273 0a20 2020 2020  y outliers.     
-000233c0: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
-000233d0: 0a0a 2020 2020 2020 2020 6c6f 675f 6d73  ..        log_ms
-000233e0: 675f 656e 7465 7220 3d20 6622 504d 3a3a  g_enter = f"PM::
-000233f0: 5f72 6570 6169 7255 6e69 744d 6978 7570  _repairUnitMixup
-00023400: 732d 7b73 656c 662e 6973 7472 7d28 2922  s-{self.istr}()"
-00023410: 0a20 2020 2020 2020 206c 6f67 5f6d 7367  .        log_msg
-00023420: 5f65 7869 7420 3d20 6622 504d 3a3a 5f72  _exit = f"PM::_r
-00023430: 6570 6169 7255 6e69 744d 6978 7570 732d  epairUnitMixups-
-00023440: 7b73 656c 662e 6973 7472 7d28 2920 7265  {self.istr}() re
-00023450: 7475 726e 696e 6722 0a20 2020 2020 2020  turning".       
-00023460: 2079 6663 6c2e 5472 6163 6545 6e74 6572   yfcl.TraceEnter
-00023470: 286c 6f67 5f6d 7367 5f65 6e74 6572 290a  (log_msg_enter).
-00023480: 0a20 2020 2020 2020 2064 6632 203d 2064  .        df2 = d
-00023490: 662e 636f 7079 2829 0a0a 2020 2020 2020  f.copy()..      
-000234a0: 2020 6461 7461 5f63 6f6c 7320 3d20 5b22    data_cols = ["
-000234b0: 4869 6768 222c 2022 4f70 656e 222c 2022  High", "Open", "
-000234c0: 4c6f 7722 2c20 2243 6c6f 7365 225d 2020  Low", "Close"]  
-000234d0: 2320 4f72 6465 7220 696d 706f 7274 616e  # Order importan
-000234e0: 742c 2073 6570 6172 6174 6520 4869 6768  t, separate High
-000234f0: 2066 726f 6d20 4c6f 770a 2020 2020 2020   from Low.      
-00023500: 2020 6461 7461 5f63 6f6c 7320 3d20 5b63    data_cols = [c
-00023510: 2066 6f72 2063 2069 6e20 6461 7461 5f63   for c in data_c
-00023520: 6f6c 7320 6966 2063 2069 6e20 6466 322e  ols if c in df2.
-00023530: 636f 6c75 6d6e 735d 0a20 2020 2020 2020  columns].       
-00023540: 2066 5f7a 6572 6f65 7320 3d20 2864 6632   f_zeroes = (df2
-00023550: 5b64 6174 615f 636f 6c73 5d20 3d3d 2030  [data_cols] == 0
-00023560: 292e 616e 7928 6178 6973 3d31 290a 2020  ).any(axis=1).  
-00023570: 2020 2020 2020 6966 2066 5f7a 6572 6f65        if f_zeroe
-00023580: 732e 616e 7928 293a 0a20 2020 2020 2020  s.any():.       
-00023590: 2020 2020 2064 6632 5f7a 6572 6f65 7320       df2_zeroes 
-000235a0: 3d20 6466 325b 665f 7a65 726f 6573 5d0a  = df2[f_zeroes].
-000235b0: 2020 2020 2020 2020 2020 2020 6466 3220              df2 
-000235c0: 3d20 6466 325b 7e66 5f7a 6572 6f65 735d  = df2[~f_zeroes]
-000235d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000235e0: 2020 2020 2020 2020 2020 2064 6632 5f7a             df2_z
-000235f0: 6572 6f65 7320 3d20 4e6f 6e65 0a20 2020  eroes = None.   
-00023600: 2020 2020 2069 6620 6466 322e 7368 6170       if df2.shap
-00023610: 655b 305d 203c 3d20 313a 0a20 2020 2020  e[0] <= 1:.     
-00023620: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
-00023630: 6545 7869 7428 6c6f 675f 6d73 675f 6578  eExit(log_msg_ex
-00023640: 6974 290a 2020 2020 2020 2020 2020 2020  it).            
-00023650: 7265 7475 726e 2064 660a 2020 2020 2020  return df.      
-00023660: 2020 6d65 6469 616e 203d 205f 6e64 696d    median = _ndim
-00023670: 6167 652e 6d65 6469 616e 5f66 696c 7465  age.median_filte
-00023680: 7228 6466 325b 6461 7461 5f63 6f6c 735d  r(df2[data_cols]
-00023690: 2e74 6f5f 6e75 6d70 7928 292c 2073 697a  .to_numpy(), siz
-000236a0: 653d 2833 2c20 3329 2c20 6d6f 6465 3d22  e=(3, 3), mode="
-000236b0: 7772 6170 2229 0a0a 2020 2020 2020 2020  wrap")..        
-000236c0: 6966 2028 6d65 6469 616e 203d 3d20 3029  if (median == 0)
-000236d0: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-000236e0: 2020 2020 7072 696e 7428 2254 6963 6b65      print("Ticke
-000236f0: 7220 3d22 2c20 7365 6c66 2e74 6963 6b65  r =", self.ticke
-00023700: 7229 0a20 2020 2020 2020 2020 2020 2070  r).            p
-00023710: 7269 6e74 2822 7966 203d 222c 2079 6629  rint("yf =", yf)
-00023720: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00023730: 6e74 2822 6466 3a22 290a 2020 2020 2020  nt("df:").      
-00023740: 2020 2020 2020 7072 696e 7428 6466 290a        print(df).
-00023750: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00023760: 6520 4578 6365 7074 696f 6e28 226d 6564  e Exception("med
-00023770: 6961 6e20 636f 6e74 6169 6e73 207a 6572  ian contains zer
-00023780: 6f65 732c 2077 6879 3f22 290a 2020 2020  oes, why?").    
-00023790: 2020 2020 7261 7469 6f20 3d20 6466 325b      ratio = df2[
-000237a0: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-000237b0: 6d70 7928 2920 2f20 6d65 6469 616e 0a20  mpy() / median. 
-000237c0: 2020 2020 2020 2072 6174 696f 5f72 6f75         ratio_rou
-000237d0: 6e64 6564 203d 2028 7261 7469 6f20 2f20  nded = (ratio / 
-000237e0: 3230 292e 726f 756e 6428 2920 2a20 3230  20).round() * 20
-000237f0: 2020 2320 726f 756e 6420 7261 7469 6f20    # round ratio 
-00023800: 746f 206e 6561 7265 7374 2032 300a 2020  to nearest 20.  
-00023810: 2020 2020 2020 6620 3d20 7261 7469 6f5f        f = ratio_
-00023820: 726f 756e 6465 6420 3d3d 2031 3030 0a20  rounded == 100. 
-00023830: 2020 2020 2020 2069 6620 6e6f 7420 662e         if not f.
-00023840: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-00023850: 2020 2079 6663 6c2e 5472 6163 6545 7869     yfcl.TraceExi
-00023860: 7428 6c6f 675f 6d73 675f 6578 6974 290a  t(log_msg_exit).
-00023870: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00023880: 726e 2064 660a 0a20 2020 2020 2020 2023  rn df..        #
-00023890: 204d 6172 6b20 7661 6c75 6573 2074 6f20   Mark values to 
-000238a0: 7365 6e64 2066 6f72 2072 6570 6169 720a  send for repair.
-000238b0: 2020 2020 2020 2020 7461 6720 3d20 2d31          tag = -1
-000238c0: 2e30 0a20 2020 2020 2020 2066 6f72 2069  .0.        for i
-000238d0: 2069 6e20 7261 6e67 6528 6c65 6e28 6461   in range(len(da
-000238e0: 7461 5f63 6f6c 7329 293a 0a20 2020 2020  ta_cols)):.     
-000238f0: 2020 2020 2020 2066 6920 3d20 665b 3a2c         fi = f[:,
-00023900: 2069 5d0a 2020 2020 2020 2020 2020 2020   i].            
-00023910: 6320 3d20 6461 7461 5f63 6f6c 735b 695d  c = data_cols[i]
-00023920: 0a20 2020 2020 2020 2020 2020 2064 6632  .            df2
-00023930: 2e6c 6f63 5b66 692c 2063 5d20 3d20 7461  .loc[fi, c] = ta
-00023940: 670a 0a20 2020 2020 2020 206e 5f62 6566  g..        n_bef
-00023950: 6f72 6520 3d20 2864 6632 5b64 6174 615f  ore = (df2[data_
-00023960: 636f 6c73 5d2e 746f 5f6e 756d 7079 2829  cols].to_numpy()
-00023970: 203d 3d20 7461 6729 2e73 756d 2829 0a20   == tag).sum(). 
-00023980: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00023990: 2020 2020 2020 2020 6466 3220 3d20 7365          df2 = se
-000239a0: 6c66 2e5f 7265 636f 6e73 7472 7563 745f  lf._reconstruct_
-000239b0: 696e 7465 7276 616c 735f 6261 7463 6828  intervals_batch(
-000239c0: 6466 322c 2074 6167 3d74 6167 290a 2020  df2, tag=tag).  
-000239d0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-000239e0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-000239f0: 2020 2020 6966 206c 656e 2873 656c 662e      if len(self.
-00023a00: 5f73 7461 636b 5f74 7261 6365 2920 3e20  _stack_trace) > 
-00023a10: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00023a20: 2020 2073 656c 662e 5f73 7461 636b 5f74     self._stack_t
-00023a30: 7261 6365 2e70 6f70 286c 656e 2873 656c  race.pop(len(sel
-00023a40: 662e 5f73 7461 636b 5f74 7261 6365 2920  f._stack_trace) 
-00023a50: 2d20 3129 0a20 2020 2020 2020 2020 2020  - 1).           
-00023a60: 2072 6169 7365 0a20 2020 2020 2020 206e   raise.        n
-00023a70: 5f61 6674 6572 203d 2028 6466 325b 6461  _after = (df2[da
-00023a80: 7461 5f63 6f6c 735d 2e74 6f5f 6e75 6d70  ta_cols].to_nump
-00023a90: 7928 2920 3d3d 2074 6167 292e 7375 6d28  y() == tag).sum(
-00023aa0: 290a 0a20 2020 2020 2020 2069 6620 6e5f  )..        if n_
-00023ab0: 6166 7465 7220 3e20 303a 0a20 2020 2020  after > 0:.     
-00023ac0: 2020 2020 2020 2023 2054 6869 7320 7365         # This se
-00023ad0: 636f 6e64 2070 6173 7320 7769 6c6c 202a  cond pass will *
-00023ae0: 6372 7564 656c 792a 2022 6669 7822 2061  crudely* "fix" a
-00023af0: 6e79 2072 656d 6169 6e69 6e67 2065 7272  ny remaining err
-00023b00: 6f72 7320 696e 2048 6967 682f 4c6f 770a  ors in High/Low.
-00023b10: 2020 2020 2020 2020 2020 2020 2320 7369              # si
-00023b20: 6d70 6c79 2062 7920 656e 7375 7269 6e67  mply by ensuring
-00023b30: 2074 6865 7920 646f 6e27 7420 636f 6e74   they don't cont
-00023b40: 7261 6469 6374 2065 2e67 2e20 4c6f 7720  radict e.g. Low 
-00023b50: 3d20 3130 3078 2048 6967 682e 0a20 2020  = 100x High..   
-00023b60: 2020 2020 2020 2020 2066 203d 2064 6632           f = df2
-00023b70: 5b64 6174 615f 636f 6c73 5d2e 746f 5f6e  [data_cols].to_n
-00023b80: 756d 7079 2829 203d 3d20 7461 670a 2020  umpy() == tag.  
-00023b90: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-00023ba0: 696e 2072 616e 6765 2866 2e73 6861 7065  in range(f.shape
-00023bb0: 5b30 5d29 3a0a 2020 2020 2020 2020 2020  [0]):.          
-00023bc0: 2020 2020 2020 6669 203d 2066 5b69 2c20        fi = f[i, 
-00023bd0: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
-00023be0: 2020 2069 6620 6e6f 7420 6669 2e61 6e79     if not fi.any
-00023bf0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00023c00: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00023c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023c20: 2069 6478 203d 2064 6632 2e69 6e64 6578   idx = df2.index
-00023c30: 5b69 5d0a 0a20 2020 2020 2020 2020 2020  [i]..           
-00023c40: 2020 2020 2063 203d 2022 4f70 656e 220a       c = "Open".
-00023c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c60: 6a20 3d20 6461 7461 5f63 6f6c 732e 696e  j = data_cols.in
-00023c70: 6465 7828 6329 0a20 2020 2020 2020 2020  dex(c).         
-00023c80: 2020 2020 2020 2069 6620 6669 5b6a 5d3a         if fi[j]:
-00023c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023ca0: 2020 2020 2064 6632 2e6c 6f63 5b69 6478       df2.loc[idx
-00023cb0: 2c20 635d 203d 2064 662e 6c6f 635b 6964  , c] = df.loc[id
-00023cc0: 782c 2063 5d20 2a20 302e 3031 0a20 2020  x, c] * 0.01.   
-00023cd0: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
-00023ce0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00023cf0: 203d 2022 436c 6f73 6522 0a20 2020 2020   = "Close".     
-00023d00: 2020 2020 2020 2020 2020 206a 203d 2064             j = d
-00023d10: 6174 615f 636f 6c73 2e69 6e64 6578 2863  ata_cols.index(c
-00023d20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00023d30: 2020 6966 2066 695b 6a5d 3a0a 2020 2020    if fi[j]:.    
-00023d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d50: 6466 322e 6c6f 635b 6964 782c 2063 5d20  df2.loc[idx, c] 
-00023d60: 3d20 6466 2e6c 6f63 5b69 6478 2c20 635d  = df.loc[idx, c]
-00023d70: 202a 2030 2e30 310a 2020 2020 2020 2020   * 0.01.        
-00023d80: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00023d90: 2020 2020 2020 2020 2020 6320 3d20 2248            c = "H
-00023da0: 6967 6822 0a20 2020 2020 2020 2020 2020  igh".           
-00023db0: 2020 2020 206a 203d 2064 6174 615f 636f       j = data_co
-00023dc0: 6c73 2e69 6e64 6578 2863 290a 2020 2020  ls.index(c).    
-00023dd0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00023de0: 695b 6a5d 3a0a 2020 2020 2020 2020 2020  i[j]:.          
-00023df0: 2020 2020 2020 2020 2020 6466 322e 6c6f            df2.lo
-00023e00: 635b 6964 782c 2063 5d20 3d20 6466 322e  c[idx, c] = df2.
-00023e10: 6c6f 635b 6964 782c 205b 224f 7065 6e22  loc[idx, ["Open"
-00023e20: 2c20 2243 6c6f 7365 225d 5d2e 6d61 7828  , "Close"]].max(
-00023e30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00023e40: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
-00023e50: 2020 2020 6320 3d20 224c 6f77 220a 2020      c = "Low".  
-00023e60: 2020 2020 2020 2020 2020 2020 2020 6a20                j 
-00023e70: 3d20 6461 7461 5f63 6f6c 732e 696e 6465  = data_cols.inde
-00023e80: 7828 6329 0a20 2020 2020 2020 2020 2020  x(c).           
-00023e90: 2020 2020 2069 6620 6669 5b6a 5d3a 0a20       if fi[j]:. 
-00023ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023eb0: 2020 2064 6632 2e6c 6f63 5b69 6478 2c20     df2.loc[idx, 
-00023ec0: 635d 203d 2064 6632 2e6c 6f63 5b69 6478  c] = df2.loc[idx
-00023ed0: 2c20 5b22 4f70 656e 222c 2022 436c 6f73  , ["Open", "Clos
-00023ee0: 6522 5d5d 2e6d 696e 2829 0a0a 2020 2020  e"]].min()..    
-00023ef0: 2020 2020 6e5f 6166 7465 725f 6372 7564      n_after_crud
-00023f00: 6520 3d20 2864 6632 5b64 6174 615f 636f  e = (df2[data_co
-00023f10: 6c73 5d2e 746f 5f6e 756d 7079 2829 203d  ls].to_numpy() =
-00023f20: 3d20 7461 6729 2e73 756d 2829 0a0a 2020  = tag).sum()..  
-00023f30: 2020 2020 2020 6e5f 6669 7865 6420 3d20        n_fixed = 
-00023f40: 6e5f 6265 666f 7265 202d 206e 5f61 6674  n_before - n_aft
-00023f50: 6572 5f63 7275 6465 0a20 2020 2020 2020  er_crude.       
-00023f60: 206e 5f66 6978 6564 5f63 7275 6465 6c79   n_fixed_crudely
-00023f70: 203d 206e 5f61 6674 6572 202d 206e 5f61   = n_after - n_a
-00023f80: 6674 6572 5f63 7275 6465 0a20 2020 2020  fter_crude.     
-00023f90: 2020 2069 6620 6e6f 7420 7369 6c65 6e74     if not silent
-00023fa0: 2061 6e64 206e 5f66 6978 6564 203e 2030   and n_fixed > 0
-00023fb0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00023fc0: 706f 7274 5f6d 7367 203d 2066 227b 7365  port_msg = f"{se
-00023fd0: 6c66 2e74 6963 6b65 727d 3a20 6669 7865  lf.ticker}: fixe
-00023fe0: 6420 7b6e 5f66 6978 6564 7d2f 7b6e 5f62  d {n_fixed}/{n_b
-00023ff0: 6566 6f72 657d 2063 7572 7265 6e63 7920  efore} currency 
-00024000: 756e 6974 206d 6978 7570 7320 220a 2020  unit mixups ".  
-00024010: 2020 2020 2020 2020 2020 6966 206e 5f66            if n_f
-00024020: 6978 6564 5f63 7275 6465 6c79 203e 2030  ixed_crudely > 0
-00024030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00024040: 2020 7265 706f 7274 5f6d 7367 202b 3d20    report_msg += 
-00024050: 6622 287b 6e5f 6669 7865 645f 6372 7564  f"({n_fixed_crud
-00024060: 656c 797d 2063 7275 6465 6c79 2920 220a  ely} crudely) ".
-00024070: 2020 2020 2020 2020 2020 2020 7265 706f              repo
-00024080: 7274 5f6d 7367 202b 3d20 6622 696e 207b  rt_msg += f"in {
-00024090: 7365 6c66 2e69 6e74 6572 7661 6c7d 2070  self.interval} p
-000240a0: 7269 6365 2064 6174 6122 0a20 2020 2020  rice data".     
-000240b0: 2020 2020 2020 2070 7269 6e74 2872 6570         print(rep
-000240c0: 6f72 745f 6d73 6729 0a0a 2020 2020 2020  ort_msg)..      
-000240d0: 2020 2320 5265 7374 6f72 6520 6f72 6967    # Restore orig
-000240e0: 696e 616c 2076 616c 7565 7320 7768 6572  inal values wher
-000240f0: 6520 7265 7061 6972 2066 6169 6c65 640a  e repair failed.
-00024100: 2020 2020 2020 2020 6620 3d20 6466 325b          f = df2[
-00024110: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-00024120: 6d70 7928 2920 3d3d 2074 6167 0a20 2020  mpy() == tag.   
-00024130: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-00024140: 6e67 6528 6c65 6e28 6461 7461 5f63 6f6c  nge(len(data_col
-00024150: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-00024160: 2066 6a20 3d20 665b 3a2c 206a 5d0a 2020   fj = f[:, j].  
-00024170: 2020 2020 2020 2020 2020 6966 2066 6a2e            if fj.
-00024180: 616e 7928 293a 0a20 2020 2020 2020 2020  any():.         
-00024190: 2020 2020 2020 2063 203d 2064 6174 615f         c = data_
-000241a0: 636f 6c73 5b6a 5d0a 2020 2020 2020 2020  cols[j].        
-000241b0: 2020 2020 2020 2020 6466 322e 6c6f 635b          df2.loc[
-000241c0: 666a 2c20 635d 203d 2064 662e 6c6f 635b  fj, c] = df.loc[
-000241d0: 666a 2c20 635d 0a20 2020 2020 2020 2069  fj, c].        i
-000241e0: 6620 6466 325f 7a65 726f 6573 2069 7320  f df2_zeroes is 
-000241f0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00024200: 2020 2020 2020 6466 3220 3d20 7064 2e63        df2 = pd.c
-00024210: 6f6e 6361 7428 5b64 6632 2c20 6466 325f  oncat([df2, df2_
-00024220: 7a65 726f 6573 5d29 2e73 6f72 745f 696e  zeroes]).sort_in
-00024230: 6465 7828 290a 2020 2020 2020 2020 2020  dex().          
-00024240: 2020 6466 322e 696e 6465 7820 3d20 7064    df2.index = pd
-00024250: 2e74 6f5f 6461 7465 7469 6d65 2829 0a0a  .to_datetime()..
-00024260: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
-00024270: 6365 4578 6974 286c 6f67 5f6d 7367 5f65  ceExit(log_msg_e
-00024280: 7869 7429 0a0a 2020 2020 2020 2020 7265  xit)..        re
-00024290: 7475 726e 2064 6632 0a0a 2020 2020 6465  turn df2..    de
-000242a0: 6620 5f72 6570 6169 725a 6572 6f50 7269  f _repairZeroPri
-000242b0: 6365 7328 7365 6c66 2c20 6466 2c20 7369  ces(self, df, si
-000242c0: 6c65 6e74 3d46 616c 7365 293a 0a20 2020  lent=False):.   
-000242d0: 2020 2020 2079 6663 752e 5479 7065 4368       yfcu.TypeCh
-000242e0: 6563 6b44 6174 6146 7261 6d65 2864 662c  eckDataFrame(df,
-000242f0: 2022 6466 2229 0a0a 2020 2020 2020 2020   "df")..        
-00024300: 2320 536f 6d65 7469 6d65 7320 5961 686f  # Sometimes Yaho
-00024310: 6f20 7265 7475 726e 7320 7072 6963 6573  o returns prices
-00024320: 3d30 2077 6865 6e20 6f62 7669 6f75 736c  =0 when obviousl
-00024330: 7920 7772 6f6e 6720 652e 672e 2056 6f6c  y wrong e.g. Vol
-00024340: 756d 6520 3e20 3020 616e 6420 436c 6f73  ume > 0 and Clos
-00024350: 6520 3e20 302e 0a20 2020 2020 2020 2023  e > 0..        #
-00024360: 2045 6173 7920 746f 2064 6574 6563 7420   Easy to detect 
-00024370: 616e 6420 6669 780a 0a20 2020 2020 2020  and fix..       
-00024380: 2069 6620 6466 2e65 6d70 7479 3a0a 2020   if df.empty:.  
-00024390: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000243a0: 2064 660a 2020 2020 2020 2020 6966 2064   df.        if d
-000243b0: 662e 7368 6170 655b 305d 203d 3d20 313a  f.shape[0] == 1:
-000243c0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-000243d0: 6565 6420 6d75 6c74 6970 6c65 2072 6f77  eed multiple row
-000243e0: 7320 746f 2063 6f6e 6669 6465 6e74 6c79  s to confidently
-000243f0: 2069 6465 6e74 6966 7920 6f75 746c 6965   identify outlie
-00024400: 7273 0a20 2020 2020 2020 2020 2020 2072  rs.            r
-00024410: 6574 7572 6e20 6466 0a0a 2020 2020 2020  eturn df..      
-00024420: 2020 6c6f 675f 6d73 675f 656e 7465 7220    log_msg_enter 
-00024430: 3d20 6622 504d 3a3a 5f72 6570 6169 725a  = f"PM::_repairZ
-00024440: 6572 6f50 7269 6365 732d 7b73 656c 662e  eroPrices-{self.
-00024450: 6973 7472 7d28 6461 7465 5f72 616e 6765  istr}(date_range
-00024460: 3d7b 6466 2e69 6e64 6578 5b30 5d7d 2d3e  ={df.index[0]}->
-00024470: 7b64 662e 696e 6465 785b 2d31 5d2b 7365  {df.index[-1]+se
-00024480: 6c66 2e69 7464 7d29 220a 2020 2020 2020  lf.itd})".      
-00024490: 2020 6c6f 675f 6d73 675f 6578 6974 203d    log_msg_exit =
-000244a0: 2066 2250 4d3a 3a5f 7265 7061 6972 5a65   f"PM::_repairZe
-000244b0: 726f 5072 6963 6573 2d7b 7365 6c66 2e69  roPrices-{self.i
-000244c0: 7374 727d 2829 2072 6574 7572 6e69 6e67  str}() returning
-000244d0: 220a 2020 2020 2020 2020 7966 636c 2e54  ".        yfcl.T
-000244e0: 7261 6365 456e 7465 7228 6c6f 675f 6d73  raceEnter(log_ms
-000244f0: 675f 656e 7465 7229 0a0a 2020 2020 2020  g_enter)..      
-00024500: 2020 6466 3220 3d20 6466 2e63 6f70 7928    df2 = df.copy(
-00024510: 290a 0a20 2020 2020 2020 2070 7269 6365  )..        price
-00024520: 5f63 6f6c 7320 3d20 5b63 2066 6f72 2063  _cols = [c for c
-00024530: 2069 6e20 5b22 4f70 656e 222c 2022 4869   in ["Open", "Hi
-00024540: 6768 222c 2022 4c6f 7722 2c20 2243 6c6f  gh", "Low", "Clo
-00024550: 7365 222c 2022 4164 6a20 436c 6f73 6522  se", "Adj Close"
-00024560: 5d20 6966 2063 2069 6e20 6466 322e 636f  ] if c in df2.co
-00024570: 6c75 6d6e 735d 0a20 2020 2020 2020 2066  lumns].        f
-00024580: 5f7a 6572 6f5f 6f72 5f6e 616e 203d 2028  _zero_or_nan = (
-00024590: 6466 325b 7072 6963 655f 636f 6c73 5d20  df2[price_cols] 
-000245a0: 3d3d 2030 2e30 292e 746f 5f6e 756d 7079  == 0.0).to_numpy
-000245b0: 2829 207c 2064 6632 5b70 7269 6365 5f63  () | df2[price_c
-000245c0: 6f6c 735d 2e69 736e 6128 292e 746f 5f6e  ols].isna().to_n
-000245d0: 756d 7079 2829 0a20 2020 2020 2020 2023  umpy().        #
-000245e0: 2043 6865 636b 2077 6865 7468 6572 2077   Check whether w
-000245f0: 6f72 7468 2061 7474 656d 7074 696e 6720  orth attempting 
-00024600: 7265 7061 6972 0a20 2020 2020 2020 2069  repair.        i
-00024610: 6620 665f 7a65 726f 5f6f 725f 6e61 6e2e  f f_zero_or_nan.
-00024620: 616e 7928 6178 6973 3d31 292e 7375 6d28  any(axis=1).sum(
-00024630: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
-00024640: 2020 2020 7966 636c 2e54 7261 6365 4578      yfcl.TraceEx
-00024650: 6974 286c 6f67 5f6d 7367 5f65 7869 7429  it(log_msg_exit)
-00024660: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00024670: 7572 6e20 6466 0a20 2020 2020 2020 2069  urn df.        i
-00024680: 6620 665f 7a65 726f 5f6f 725f 6e61 6e2e  f f_zero_or_nan.
-00024690: 7375 6d28 2920 3d3d 206c 656e 2870 7269  sum() == len(pri
-000246a0: 6365 5f63 6f6c 7329 2a6c 656e 2864 6632  ce_cols)*len(df2
-000246b0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-000246c0: 204e 6565 6420 736f 6d65 2067 6f6f 6420   Need some good 
-000246d0: 6461 7461 2074 6f20 6361 6c69 6272 6174  data to calibrat
-000246e0: 650a 2020 2020 2020 2020 2020 2020 7966  e.            yf
-000246f0: 636c 2e54 7261 6365 4578 6974 286c 6f67  cl.TraceExit(log
-00024700: 5f6d 7367 5f65 7869 7429 0a20 2020 2020  _msg_exit).     
-00024710: 2020 2020 2020 2072 6574 7572 6e20 6466         return df
-00024720: 0a20 2020 2020 2020 2023 202d 2061 766f  .        # - avo
-00024730: 6964 2072 6570 6169 7220 6966 206d 616e  id repair if man
-00024740: 7920 7a65 726f 6573 2f4e 614e 730a 2020  y zeroes/NaNs.  
-00024750: 2020 2020 2020 7063 745f 7a65 726f 5f6f        pct_zero_o
-00024760: 725f 6e61 6e20 3d20 665f 7a65 726f 5f6f  r_nan = f_zero_o
-00024770: 725f 6e61 6e2e 7375 6d28 2920 2f20 286c  r_nan.sum() / (l
-00024780: 656e 2870 7269 6365 5f63 6f6c 7329 2a6c  en(price_cols)*l
-00024790: 656e 2864 6632 2929 0a20 2020 2020 2020  en(df2)).       
-000247a0: 2069 6620 665f 7a65 726f 5f6f 725f 6e61   if f_zero_or_na
-000247b0: 6e2e 616e 7928 6178 6973 3d31 292e 7375  n.any(axis=1).su
-000247c0: 6d28 2920 3e20 3220 616e 6420 7063 745f  m() > 2 and pct_
-000247d0: 7a65 726f 5f6f 725f 6e61 6e20 3e20 302e  zero_or_nan > 0.
-000247e0: 3035 3a0a 2020 2020 2020 2020 2020 2020  05:.            
-000247f0: 7966 636c 2e54 7261 6365 4578 6974 286c  yfcl.TraceExit(l
-00024800: 6f67 5f6d 7367 5f65 7869 7429 0a20 2020  og_msg_exit).   
-00024810: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00024820: 6466 0a0a 2020 2020 2020 2020 6461 7461  df..        data
-00024830: 5f63 6f6c 7320 3d20 7072 6963 655f 636f  _cols = price_co
-00024840: 6c73 202b 205b 2256 6f6c 756d 6522 5d0a  ls + ["Volume"].
-00024850: 0a20 2020 2020 2020 2023 204d 6172 6b20  .        # Mark 
-00024860: 7661 6c75 6573 2074 6f20 7365 6e64 2066  values to send f
-00024870: 6f72 2072 6570 6169 720a 2020 2020 2020  or repair.      
-00024880: 2020 7461 6720 3d20 2d31 2e30 0a20 2020    tag = -1.0.   
-00024890: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-000248a0: 6e67 6528 6c65 6e28 7072 6963 655f 636f  nge(len(price_co
-000248b0: 6c73 2929 3a0a 2020 2020 2020 2020 2020  ls)):.          
-000248c0: 2020 6320 3d20 7072 6963 655f 636f 6c73    c = price_cols
-000248d0: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
-000248e0: 6466 322e 6c6f 635b 665f 7a65 726f 5f6f  df2.loc[f_zero_o
-000248f0: 725f 6e61 6e5b 3a2c 2069 5d2c 2063 5d20  r_nan[:, i], c] 
-00024900: 3d20 7461 670a 2020 2020 2020 2020 2320  = tag.        # 
-00024910: 4966 2076 6f6c 756d 653d 3020 6f72 204e  If volume=0 or N
-00024920: 614e 2066 6f72 2062 6164 2070 7269 6365  aN for bad price
-00024930: 732c 2074 6865 6e20 7461 6720 766f 6c75  s, then tag volu
-00024940: 6d65 2066 6f72 2072 6570 6169 720a 2020  me for repair.  
-00024950: 2020 2020 2020 6466 322e 6c6f 635b 665f        df2.loc[f_
-00024960: 7a65 726f 5f6f 725f 6e61 6e2e 616e 7928  zero_or_nan.any(
-00024970: 6178 6973 3d31 2920 2620 2864 6632 5b22  axis=1) & (df2["
-00024980: 566f 6c75 6d65 225d 203d 3d20 3029 2c20  Volume"] == 0), 
-00024990: 2256 6f6c 756d 6522 5d20 3d20 7461 670a  "Volume"] = tag.
-000249a0: 2020 2020 2020 2020 6466 322e 6c6f 635b          df2.loc[
-000249b0: 665f 7a65 726f 5f6f 725f 6e61 6e2e 616e  f_zero_or_nan.an
-000249c0: 7928 6178 6973 3d31 2920 2620 2864 6632  y(axis=1) & (df2
-000249d0: 5b22 566f 6c75 6d65 225d 2e69 736e 6128  ["Volume"].isna(
-000249e0: 2929 2c20 2256 6f6c 756d 6522 5d20 3d20  )), "Volume"] = 
-000249f0: 7461 670a 0a20 2020 2020 2020 2023 2070  tag..        # p
-00024a00: 7269 6e74 2864 6632 5b66 5f7a 6572 6f5f  rint(df2[f_zero_
-00024a10: 6f72 5f6e 616e 2e61 6e79 2861 7869 733d  or_nan.any(axis=
-00024a20: 3129 5d29 0a20 2020 2020 2020 206e 5f62  1)]).        n_b
-00024a30: 6566 6f72 6520 3d20 2864 6632 5b64 6174  efore = (df2[dat
-00024a40: 615f 636f 6c73 5d2e 746f 5f6e 756d 7079  a_cols].to_numpy
-00024a50: 2829 203d 3d20 7461 6729 2e73 756d 2829  () == tag).sum()
-00024a60: 0a20 2020 2020 2020 2023 2070 7269 6e74  .        # print
-00024a70: 2822 6e5f 6265 666f 7265 203d 222c 206e  ("n_before =", n
-00024a80: 5f62 6566 6f72 6529 0a20 2020 2020 2020  _before).       
-00024a90: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00024aa0: 2020 6466 3220 3d20 7365 6c66 2e5f 7265    df2 = self._re
-00024ab0: 636f 6e73 7472 7563 745f 696e 7465 7276  construct_interv
-00024ac0: 616c 735f 6261 7463 6828 6466 322c 2074  als_batch(df2, t
-00024ad0: 6167 3d74 6167 290a 2020 2020 2020 2020  ag=tag).        
-00024ae0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-00024af0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00024b00: 206c 656e 2873 656c 662e 5f73 7461 636b   len(self._stack
-00024b10: 5f74 7261 6365 2920 3e20 303a 0a20 2020  _trace) > 0:.   
-00024b20: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00024b30: 662e 5f73 7461 636b 5f74 7261 6365 2e70  f._stack_trace.p
-00024b40: 6f70 286c 656e 2873 656c 662e 5f73 7461  op(len(self._sta
-00024b50: 636b 5f74 7261 6365 2920 2d20 3129 0a20  ck_trace) - 1). 
-00024b60: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00024b70: 0a20 2020 2020 2020 206e 5f61 6674 6572  .        n_after
-00024b80: 203d 2028 6466 325b 6461 7461 5f63 6f6c   = (df2[data_col
-00024b90: 735d 2e74 6f5f 6e75 6d70 7928 2920 3d3d  s].to_numpy() ==
-00024ba0: 2074 6167 292e 7375 6d28 290a 2020 2020   tag).sum().    
-00024bb0: 2020 2020 6e5f 6669 7865 6420 3d20 6e5f      n_fixed = n_
-00024bc0: 6265 666f 7265 202d 206e 5f61 6674 6572  before - n_after
-00024bd0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00024be0: 7369 6c65 6e74 2061 6e64 206e 5f66 6978  silent and n_fix
-00024bf0: 6564 203e 2030 3a0a 2020 2020 2020 2020  ed > 0:.        
-00024c00: 2020 2020 7072 696e 7428 6622 7b73 656c      print(f"{sel
-00024c10: 662e 7469 636b 6572 7d3a 2066 6978 6564  f.ticker}: fixed
-00024c20: 207b 6e5f 6669 7865 647d 2f7b 6e5f 6265   {n_fixed}/{n_be
-00024c30: 666f 7265 7d20 7072 6963 653d 302e 3020  fore} price=0.0 
-00024c40: 6572 726f 7273 2069 6e20 7b73 656c 662e  errors in {self.
-00024c50: 6973 7472 7d20 7072 6963 6520 6461 7461  istr} price data
-00024c60: 2229 0a0a 2020 2020 2020 2020 2320 5265  ")..        # Re
-00024c70: 7374 6f72 6520 6f72 6967 696e 616c 2076  store original v
-00024c80: 616c 7565 7320 7768 6572 6520 7265 7061  alues where repa
-00024c90: 6972 2066 6169 6c65 6420 2869 2e65 2e20  ir failed (i.e. 
-00024ca0: 7265 6d6f 7665 2074 6167 2076 616c 7565  remove tag value
-00024cb0: 7329 0a20 2020 2020 2020 2066 203d 2064  s).        f = d
-00024cc0: 6632 5b64 6174 615f 636f 6c73 5d2e 746f  f2[data_cols].to
-00024cd0: 5f6e 756d 7079 2829 203d 3d20 7461 670a  _numpy() == tag.
-00024ce0: 2020 2020 2020 2020 666f 7220 6a20 696e          for j in
-00024cf0: 2072 616e 6765 286c 656e 2864 6174 615f   range(len(data_
-00024d00: 636f 6c73 2929 3a0a 2020 2020 2020 2020  cols)):.        
-00024d10: 2020 2020 666a 203d 2066 5b3a 2c20 6a5d      fj = f[:, j]
-00024d20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00024d30: 666a 2e61 6e79 2829 3a0a 2020 2020 2020  fj.any():.      
-00024d40: 2020 2020 2020 2020 2020 6320 3d20 6461            c = da
-00024d50: 7461 5f63 6f6c 735b 6a5d 0a20 2020 2020  ta_cols[j].     
-00024d60: 2020 2020 2020 2020 2020 2064 6632 2e6c             df2.l
-00024d70: 6f63 5b66 6a2c 2063 5d20 3d20 6466 2e6c  oc[fj, c] = df.l
-00024d80: 6f63 5b66 6a2c 2063 5d0a 0a20 2020 2020  oc[fj, c]..     
-00024d90: 2020 2079 6663 6c2e 5472 6163 6545 7869     yfcl.TraceExi
-00024da0: 7428 6c6f 675f 6d73 675f 6578 6974 290a  t(log_msg_exit).
-00024db0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00024dc0: 6466 320a 0a20 2020 2064 6566 205f 7265  df2..    def _re
-00024dd0: 7665 7273 6559 6168 6f6f 4164 6a75 7374  verseYahooAdjust
-00024de0: 2873 656c 662c 2064 6629 3a0a 2020 2020  (self, df):.    
-00024df0: 2020 2020 7966 6375 2e54 7970 6543 6865      yfcu.TypeChe
-00024e00: 636b 4461 7461 4672 616d 6528 6466 2c20  ckDataFrame(df, 
-00024e10: 2264 6622 290a 0a20 2020 2020 2020 2023  "df")..        #
-00024e20: 2059 6168 6f6f 2072 6574 7572 6e73 2064   Yahoo returns d
-00024e30: 6174 6120 7370 6c69 742d 6164 6a75 7374  ata split-adjust
-00024e40: 6564 2073 6f20 7265 7665 7273 6520 7468  ed so reverse th
-00024e50: 6174 2e0a 2020 2020 2020 2020 230a 2020  at..        #.  
-00024e60: 2020 2020 2020 2320 4578 6365 7074 2066        # Except f
-00024e70: 6f72 2068 6f75 726c 792f 6d69 6e75 7465  or hourly/minute
-00024e80: 2064 6174 612c 2059 6168 6f6f 2069 736e   data, Yahoo isn
-00024e90: 2774 2063 6f6e 7369 7374 656e 7420 7769  't consistent wi
-00024ea0: 7468 2061 646a 7573 746d 656e 743a 0a20  th adjustment:. 
-00024eb0: 2020 2020 2020 2023 202d 2070 7269 6365         # - price
-00024ec0: 7320 6f6e 6c79 2073 706c 6974 2d61 646a  s only split-adj
-00024ed0: 7573 7465 6420 6966 2064 6174 6520 7261  usted if date ra
-00024ee0: 6e67 6520 636f 6e74 6169 6e73 2061 2073  nge contains a s
-00024ef0: 706c 6974 0a20 2020 2020 2020 2023 202d  plit.        # -
-00024f00: 2064 6976 6964 656e 6420 6170 7065 6172   dividend appear
-00024f10: 7320 7370 6c69 742d 6164 6a75 7374 6564  s split-adjusted
-00024f20: 0a20 2020 2020 2020 2023 2045 6173 7920  .        # Easy 
-00024f30: 746f 2066 6978 2075 7369 6e67 2064 6169  to fix using dai
-00024f40: 6c79 2064 6174 613a 0a20 2020 2020 2020  ly data:.       
-00024f50: 2023 202d 2064 6976 6964 6520 7072 6963   # - divide pric
-00024f60: 6573 2062 7920 6461 696c 7920 746f 2064  es by daily to d
-00024f70: 6574 6572 6d69 6e65 2069 6620 7370 6c69  etermine if spli
-00024f80: 742d 6164 6a75 7374 6564 0a20 2020 2020  t-adjusted.     
-00024f90: 2020 2023 202d 2063 6f70 7920 6469 7669     # - copy divi
-00024fa0: 6465 6e64 7320 6672 6f6d 2064 6169 6c79  dends from daily
-00024fb0: 0a0a 2020 2020 2020 2020 2320 4669 6e61  ..        # Fina
-00024fc0: 6c6c 792c 2061 6464 2027 4353 4627 2026  lly, add 'CSF' &
-00024fd0: 2027 4344 4627 2063 6f6c 756d 6e73 2074   'CDF' columns t
-00024fe0: 6f20 616c 6c6f 7720 6368 6561 7020 6f6e  o allow cheap on
-00024ff0: 2d64 656d 616e 6420 6164 6a75 7374 6d65  -demand adjustme
-00025000: 6e74 0a0a 2020 2020 2020 2020 6966 206e  nt..        if n
-00025010: 6f74 2069 7369 6e73 7461 6e63 6528 6466  ot isinstance(df
-00025020: 2c20 7064 2e44 6174 6146 7261 6d65 293a  , pd.DataFrame):
-00025030: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00025040: 7365 2045 7863 6570 7469 6f6e 2822 2764  se Exception("'d
-00025050: 6627 206d 7573 7420 6265 2070 642e 4461  f' must be pd.Da
-00025060: 7461 4672 616d 6520 6e6f 7420 7b7d 222e  taFrame not {}".
-00025070: 666f 726d 6174 2874 7970 6528 6466 2929  format(type(df))
-00025080: 290a 0a20 2020 2020 2020 2064 6562 7567  )..        debug
-00025090: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-000250a0: 2023 2064 6562 7567 203d 2054 7275 650a   # debug = True.
-000250b0: 0a20 2020 2020 2020 206c 6f67 5f6d 7367  .        log_msg
-000250c0: 203d 2066 2250 4d3a 3a5f 7265 7665 7273   = f"PM::_revers
-000250d0: 6559 6168 6f6f 4164 6a75 7374 2d7b 7365  eYahooAdjust-{se
-000250e0: 6c66 2e69 7374 727d 2c20 7b64 662e 696e  lf.istr}, {df.in
-000250f0: 6465 785b 305d 7d2d 3e7b 6466 2e69 6e64  dex[0]}->{df.ind
-00025100: 6578 5b2d 315d 7d22 0a20 2020 2020 2020  ex[-1]}".       
-00025110: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
-00025120: 6e67 456e 6162 6c65 6428 293a 0a20 2020  ngEnabled():.   
-00025130: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-00025140: 6163 6545 6e74 6572 286c 6f67 5f6d 7367  aceEnter(log_msg
-00025150: 290a 2020 2020 2020 2020 656c 6966 2064  ).        elif d
-00025160: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
-00025170: 2020 7072 696e 7428 2222 290a 2020 2020    print("").    
-00025180: 2020 2020 2020 2020 7072 696e 7428 6c6f          print(lo
-00025190: 675f 6d73 6729 0a0a 2020 2020 2020 2020  g_msg)..        
-000251a0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-000251b0: 2020 2020 2020 7072 696e 7428 6466 5b5b        print(df[[
-000251c0: 224f 7065 6e22 2c20 224c 6f77 222c 2022  "Open", "Low", "
-000251d0: 4869 6768 222c 2022 436c 6f73 6522 2c20  High", "Close", 
-000251e0: 2256 6f6c 756d 6522 5d5d 290a 0a20 2020  "Volume"]])..   
-000251f0: 2020 2020 2063 6466 203d 204e 6f6e 650a       cdf = None.
-00025200: 2020 2020 2020 2020 6373 6620 3d20 4e6f          csf = No
-00025210: 6e65 0a0a 2020 2020 2020 2020 6966 2073  ne..        if s
-00025220: 656c 662e 696e 7465 7276 616c 2021 3d20  elf.interval != 
-00025230: 7966 6364 2e49 6e74 6572 7661 6c2e 4461  yfcd.Interval.Da
-00025240: 7973 313a 0a20 2020 2020 2020 2020 2020  ys1:.           
-00025250: 2023 2054 7269 6767 6572 2075 7064 6174   # Trigger updat
-00025260: 6520 6f66 2064 6169 6c79 2070 7269 6365  e of daily price
-00025270: 2064 6174 612c 2074 6f20 6765 7420 616c   data, to get al
-00025280: 6c20 6576 656e 7473 0a20 2020 2020 2020  l events.       
-00025290: 2020 2020 2068 6973 7444 6169 6c79 203d       histDaily =
-000252a0: 2073 656c 662e 6d61 6e61 6765 722e 4765   self.manager.Ge
-000252b0: 7448 6973 746f 7279 2879 6663 642e 496e  tHistory(yfcd.In
-000252c0: 7465 7276 616c 2e44 6179 7331 290a 2020  terval.Days1).  
-000252d0: 2020 2020 2020 2020 2020 6466 5f64 6169            df_dai
-000252e0: 6c79 5f72 6177 203d 2068 6973 7444 6169  ly_raw = histDai
-000252f0: 6c79 2e67 6574 2873 7461 7274 3d64 662e  ly.get(start=df.
-00025300: 696e 6465 785b 305d 2e64 6174 6528 292c  index[0].date(),
-00025310: 2072 6570 6169 723d 4661 6c73 6529 0a0a   repair=False)..
-00025320: 2020 2020 2020 2020 2320 5374 6570 2031          # Step 1
-00025330: 3a20 656e 7375 7265 2069 6e74 7261 6461  : ensure intrada
-00025340: 7920 7072 6963 6520 6461 7461 2069 7320  y price data is 
-00025350: 616c 7761 7973 2073 706c 6974 2d61 646a  always split-adj
-00025360: 7573 7465 640a 2020 2020 2020 2020 7464  usted.        td
-00025370: 5f37 6420 3d20 7469 6d65 6465 6c74 6128  _7d = timedelta(
-00025380: 6461 7973 3d37 290a 2020 2020 2020 2020  days=7).        
-00025390: 6966 206e 6f74 2073 656c 662e 696e 7465  if not self.inte
-000253a0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
-000253b0: 2020 2320 4765 7420 6461 696c 7920 7072    # Get daily pr
-000253c0: 6963 6520 6461 7461 2064 7572 696e 6720  ice data during 
-000253d0: 616e 6420 6166 7465 7220 2764 6627 0a0a  and after 'df'..
-000253e0: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
-000253f0: 6169 6c79 203d 2064 665f 6461 696c 795f  aily = df_daily_
-00025400: 7261 772e 636f 7079 2829 0a20 2020 2020  raw.copy().     
-00025410: 2020 2020 2020 2066 6f72 2063 2069 6e20         for c in 
-00025420: 5b22 4f70 656e 222c 2022 436c 6f73 6522  ["Open", "Close"
-00025430: 2c20 224c 6f77 222c 2022 4869 6768 225d  , "Low", "High"]
-00025440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00025450: 2020 6466 5f64 6169 6c79 5b63 5d20 2a3d    df_daily[c] *=
-00025460: 2064 665f 6461 696c 795b 2243 5346 225d   df_daily["CSF"]
-00025470: 0a20 2020 2020 2020 2020 2020 2064 665f  .            df_
-00025480: 6461 696c 795b 2256 6f6c 756d 6522 5d20  daily["Volume"] 
-00025490: 2f3d 2064 665f 6461 696c 795b 2243 5346  /= df_daily["CSF
-000254a0: 225d 0a20 2020 2020 2020 2020 2020 2064  "].            d
-000254b0: 665f 6461 696c 7920 3d20 6466 5f64 6169  f_daily = df_dai
-000254c0: 6c79 2e64 726f 7028 2243 5346 222c 2061  ly.drop("CSF", a
-000254d0: 7869 733d 3129 0a0a 2020 2020 2020 2020  xis=1)..        
-000254e0: 2020 2020 6966 2064 665f 6461 696c 7920      if df_daily 
-000254f0: 6973 204e 6f6e 6520 6f72 2064 665f 6461  is None or df_da
-00025500: 696c 792e 656d 7074 793a 0a20 2020 2020  ily.empty:.     
-00025510: 2020 2020 2020 2020 2020 2023 2064 6620             # df 
-00025520: 3d20 6466 2e64 726f 7028 2241 646a 2043  = df.drop("Adj C
-00025530: 6c6f 7365 222c 2061 7869 733d 3129 0a20  lose", axis=1). 
-00025540: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00025550: 665b 2243 5346 225d 203d 2031 2e30 0a20  f["CSF"] = 1.0. 
-00025560: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00025570: 665b 2243 4446 225d 203d 2031 2e30 0a20  f["CDF"] = 1.0. 
-00025580: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00025590: 6574 7572 6e20 6466 0a0a 2020 2020 2020  eturn df..      
-000255a0: 2020 2020 2020 665f 706f 7374 203d 2064        f_post = d
-000255b0: 665f 6461 696c 792e 696e 6465 782e 6461  f_daily.index.da
-000255c0: 7465 203e 2064 662e 696e 6465 785b 2d31  te > df.index[-1
-000255d0: 5d2e 6461 7465 2829 0a20 2020 2020 2020  ].date().       
-000255e0: 2020 2020 2064 665f 6461 696c 795f 6475       df_daily_du
-000255f0: 7269 6e67 203d 2064 665f 6461 696c 795b  ring = df_daily[
-00025600: 7e66 5f70 6f73 745d 2e63 6f70 7928 290a  ~f_post].copy().
-00025610: 2020 2020 2020 2020 2020 2020 6466 5f64              df_d
-00025620: 6169 6c79 5f70 6f73 7420 3d20 6466 5f64  aily_post = df_d
-00025630: 6169 6c79 5b66 5f70 6f73 745d 2e63 6f70  aily[f_post].cop
-00025640: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-00025650: 6466 5f64 6169 6c79 5f64 7572 696e 672e  df_daily_during.
-00025660: 696e 6465 7820 3d20 6466 5f64 6169 6c79  index = df_daily
-00025670: 5f64 7572 696e 672e 696e 6465 782e 6461  _during.index.da
-00025680: 7465 203b 2064 665f 6461 696c 795f 6475  te ; df_daily_du
-00025690: 7269 6e67 2e69 6e64 6578 2e6e 616d 6520  ring.index.name 
-000256a0: 3d20 225f 6461 7465 220a 0a20 2020 2020  = "_date"..     
-000256b0: 2020 2020 2020 2023 2041 6c73 6f20 6765         # Also ge
-000256c0: 7420 7261 7720 6461 696c 7920 6461 7461  t raw daily data
-000256d0: 2066 726f 6d20 6361 6368 650a 2020 2020   from cache.    
-000256e0: 2020 2020 2020 2020 6466 5f64 6169 6c79          df_daily
-000256f0: 5f72 6177 203d 2064 665f 6461 696c 795f  _raw = df_daily_
-00025700: 7261 775b 6466 5f64 6169 6c79 5f72 6177  raw[df_daily_raw
-00025710: 2e69 6e64 6578 2e64 6174 6520 3e3d 2064  .index.date >= d
-00025720: 662e 696e 6465 785b 305d 2e64 6174 6528  f.index[0].date(
-00025730: 295d 0a20 2020 2020 2020 2020 2020 2023  )].            #
-00025740: 0a20 2020 2020 2020 2020 2020 2066 5f70  .            f_p
-00025750: 6f73 7420 3d20 6466 5f64 6169 6c79 5f72  ost = df_daily_r
-00025760: 6177 2e69 6e64 6578 2e64 6174 6520 3e20  aw.index.date > 
-00025770: 6466 2e69 6e64 6578 5b2d 315d 2e64 6174  df.index[-1].dat
-00025780: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00025790: 6466 5f64 6169 6c79 5f72 6177 5f64 7572  df_daily_raw_dur
-000257a0: 696e 6720 3d20 6466 5f64 6169 6c79 5f72  ing = df_daily_r
-000257b0: 6177 5b7e 665f 706f 7374 5d2e 636f 7079  aw[~f_post].copy
-000257c0: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
-000257d0: 665f 6461 696c 795f 7261 775f 6475 7269  f_daily_raw_duri
-000257e0: 6e67 5f64 203d 2064 665f 6461 696c 795f  ng_d = df_daily_
-000257f0: 7261 775f 6475 7269 6e67 2e63 6f70 7928  raw_during.copy(
-00025800: 290a 2020 2020 2020 2020 2020 2020 6466  ).            df
-00025810: 5f64 6169 6c79 5f72 6177 5f64 7572 696e  _daily_raw_durin
-00025820: 675f 642e 696e 6465 7820 3d20 6466 5f64  g_d.index = df_d
-00025830: 6169 6c79 5f72 6177 5f64 7572 696e 675f  aily_raw_during_
-00025840: 642e 696e 6465 782e 6461 7465 203b 2064  d.index.date ; d
-00025850: 665f 6461 696c 795f 7261 775f 6475 7269  f_daily_raw_duri
-00025860: 6e67 5f64 2e69 6e64 6578 2e6e 616d 6520  ng_d.index.name 
-00025870: 3d20 225f 6461 7465 220a 0a20 2020 2020  = "_date"..     
-00025880: 2020 2020 2020 2069 6620 6466 5f64 6169         if df_dai
-00025890: 6c79 5f70 6f73 742e 656d 7074 793a 0a20  ly_post.empty:. 
-000258a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000258b0: 7366 5f70 6f73 7420 3d20 312e 300a 2020  sf_post = 1.0.  
-000258c0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000258d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000258e0: 6373 665f 706f 7374 203d 2079 6663 752e  csf_post = yfcu.
-000258f0: 4765 7443 5346 3028 6466 5f64 6169 6c79  GetCSF0(df_daily
-00025900: 5f70 6f73 7429 0a20 2020 2020 2020 2020  _post).         
-00025910: 2020 2065 7870 6563 7465 6452 6174 696f     expectedRatio
-00025920: 203d 2031 2e30 202f 2063 7366 5f70 6f73   = 1.0 / csf_pos
-00025930: 740a 0a20 2020 2020 2020 2020 2020 2023  t..            #
-00025940: 2023 204d 6572 6765 2027 6466 2720 7769   # Merge 'df' wi
-00025950: 7468 2064 6169 6c79 2064 6174 6120 746f  th daily data to
-00025960: 2063 6f6d 7061 7265 2061 6e64 2069 6e66   compare and inf
-00025970: 6572 2061 646a 7573 746d 656e 740a 2020  er adjustment.  
-00025980: 2020 2020 2020 2020 2020 2320 6466 5f67            # df_g
-00025990: 7270 203d 2064 662e 636f 7079 2829 0a20  rp = df.copy(). 
-000259a0: 2020 2020 2020 2020 2020 2023 2064 665f             # df_
-000259b0: 6772 705b 225f 6461 7465 225d 203d 2064  grp["_date"] = d
-000259c0: 665f 6772 702e 696e 6465 782e 6461 7465  f_grp.index.date
-000259d0: 0a20 2020 2020 2020 2020 2020 2023 2064  .            # d
-000259e0: 665f 6772 7020 3d20 6466 5f67 7270 2e67  f_grp = df_grp.g
-000259f0: 726f 7570 6279 2822 5f64 6174 6522 290a  roupby("_date").
-00025a00: 2020 2020 2020 2020 2020 2020 2320 6466              # df
-00025a10: 5f61 6767 4279 4461 7920 3d20 6466 5f67  _aggByDay = df_g
-00025a20: 7270 2e61 6767 280a 2020 2020 2020 2020  rp.agg(.        
-00025a30: 2020 2020 2320 2020 2020 4c6f 773d 2822      #     Low=("
-00025a40: 4c6f 7722 2c20 226d 696e 2229 2c0a 2020  Low", "min"),.  
-00025a50: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00025a60: 4869 6768 3d28 2248 6967 6822 2c20 226d  High=("High", "m
-00025a70: 6178 2229 2c0a 2020 2020 2020 2020 2020  ax"),.          
-00025a80: 2020 2320 2020 2020 4f70 656e 3d28 224f    #     Open=("O
-00025a90: 7065 6e22 2c20 2266 6972 7374 2229 2c0a  pen", "first"),.
-00025aa0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00025ab0: 2020 436c 6f73 653d 2822 436c 6f73 6522    Close=("Close"
-00025ac0: 2c20 226c 6173 7422 2929 0a0a 2020 2020  , "last"))..    
-00025ad0: 2020 2020 2020 2020 2320 4372 6f73 732d          # Cross-
-00025ae0: 6368 6563 6b20 696e 6665 7272 6564 2073  check inferred s
-00025af0: 706c 6974 2d61 646a 7573 746d 656e 7420  plit-adjustment 
-00025b00: 7673 2065 7870 6563 7465 640a 2020 2020  vs expected.    
-00025b10: 2020 2020 2020 2020 2320 2d20 7570 6461          # - upda
-00025b20: 7465 3a20 6469 7361 626c 652c 2062 6563  te: disable, bec
-00025b30: 6175 7365 206f 6e6c 7920 6661 696c 7320  ause only fails 
-00025b40: 6475 6520 746f 2069 6e73 7566 6669 6369  due to insuffici
-00025b50: 656e 7420 6461 7461 0a20 2020 2020 2020  ent data.       
-00025b60: 2020 2020 2023 2064 6174 615f 636f 6c73       # data_cols
-00025b70: 203d 205b 224f 7065 6e22 2c20 2243 6c6f   = ["Open", "Clo
-00025b80: 7365 222c 2022 4c6f 7722 2c20 2248 6967  se", "Low", "Hig
-00025b90: 6822 5d0a 2020 2020 2020 2020 2020 2020  h"].            
-00025ba0: 2320 6466 3220 3d20 7064 2e6d 6572 6765  # df2 = pd.merge
-00025bb0: 2864 665f 6167 6742 7944 6179 2c20 6466  (df_aggByDay, df
-00025bc0: 5f64 6169 6c79 5f64 7572 696e 672c 2068  _daily_during, h
-00025bd0: 6f77 3d22 6c65 6674 222c 206f 6e3d 225f  ow="left", on="_
-00025be0: 6461 7465 222c 2076 616c 6964 6174 653d  date", validate=
-00025bf0: 226f 6e65 5f74 6f5f 6f6e 6522 2c20 7375  "one_to_one", su
-00025c00: 6666 6978 6573 3d28 2222 2c20 225f 6461  ffixes=("", "_da
-00025c10: 7922 2929 0a20 2020 2020 2020 2020 2020  y")).           
-00025c20: 2023 2023 2049 6620 2764 6627 2068 6173   # # If 'df' has
-00025c30: 206e 6f74 2062 6565 6e20 7370 6c69 742d   not been split-
-00025c40: 6164 6a75 7374 6564 2062 7920 5961 686f  adjusted by Yaho
-00025c50: 6f2c 2062 7574 2069 7420 7368 6f75 6c64  o, but it should
-00025c60: 2068 6176 6520 6265 656e 2c0a 2020 2020   have been,.    
-00025c70: 2020 2020 2020 2020 2320 2320 7468 656e          # # then
-00025c80: 2074 6865 2069 6e66 6572 7265 6420 7370   the inferred sp
-00025c90: 6c69 742d 6164 6a75 7374 2072 6174 696f  lit-adjust ratio
-00025ca0: 2073 686f 756c 6420 6265 2063 6c6f 7365   should be close
-00025cb0: 2074 6f20 312e 302f 706f 7374 5f63 7366   to 1.0/post_csf
-00025cc0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00025cd0: 2320 4170 706c 7920 6120 6665 7720 7361  # Apply a few sa
-00025ce0: 6e69 7479 2074 6573 7473 2061 6761 696e  nity tests again
-00025cf0: 7374 2069 6e66 6572 7265 6420 7261 7469  st inferred rati
-00025d00: 6f20 2d20 6e6f 7420 4e61 4e2c 206c 6f77  o - not NaN, low
-00025d10: 2076 6172 6961 6e63 650a 2020 2020 2020   variance.      
-00025d20: 2020 2020 2020 2320 6966 2064 6632 5b7e        # if df2[~
-00025d30: 6466 325b 2243 6c6f 7365 225d 2e69 736e  df2["Close"].isn
-00025d40: 6128 295d 2e65 6d70 7479 3a0a 2020 2020  a()].empty:.    
-00025d50: 2020 2020 2020 2020 2320 2020 2020 7373          #     ss
-00025d60: 5f72 6174 696f 203d 2065 7870 6563 7465  _ratio = expecte
-00025d70: 6452 6174 696f 0a20 2020 2020 2020 2020  dRatio.         
-00025d80: 2020 2023 2020 2020 2073 7464 6576 5f70     #     stdev_p
-00025d90: 6374 203d 2030 2e30 0a20 2020 2020 2020  ct = 0.0.       
-00025da0: 2020 2020 2023 2065 6c69 6620 6466 2e73       # elif df.s
-00025db0: 6861 7065 5b30 5d20 3d3d 2031 3a0a 2020  hape[0] == 1:.  
-00025dc0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00025dd0: 7373 5f72 6174 696f 203d 2064 6632 5b22  ss_ratio = df2["
-00025de0: 436c 6f73 6522 5d2e 696c 6f63 5b30 5d20  Close"].iloc[0] 
-00025df0: 2f20 6466 325b 2243 6c6f 7365 5f64 6179  / df2["Close_day
-00025e00: 225d 2e69 6c6f 635b 305d 0a20 2020 2020  "].iloc[0].     
-00025e10: 2020 2020 2020 2023 2020 2020 2073 7464         #     std
-00025e20: 6576 5f70 6374 203d 2030 2e30 0a20 2020  ev_pct = 0.0.   
-00025e30: 2020 2020 2020 2020 2023 2065 6c73 653a           # else:
-00025e40: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00025e50: 2020 2072 6174 696f 7320 3d20 6466 325b     ratios = df2[
-00025e60: 6461 7461 5f63 6f6c 735d 2e74 6f5f 6e75  data_cols].to_nu
-00025e70: 6d70 7928 2920 2f20 6466 325b 5b64 6320  mpy() / df2[[dc 
-00025e80: 2b20 225f 6461 7922 2066 6f72 2064 6320  + "_day" for dc 
-00025e90: 696e 2064 6174 615f 636f 6c73 5d5d 2e74  in data_cols]].t
-00025ea0: 6f5f 6e75 6d70 7928 290a 2020 2020 2020  o_numpy().      
-00025eb0: 2020 2020 2020 2320 2020 2020 7261 7469        #     rati
-00025ec0: 6f73 5b64 6632 5b64 6174 615f 636f 6c73  os[df2[data_cols
-00025ed0: 5d2e 6973 6e61 2829 5d20 3d20 312e 300a  ].isna()] = 1.0.
-00025ee0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-00025ef0: 2020 2320 7373 5f72 6174 696f 203d 206e    # ss_ratio = n
-00025f00: 702e 6d65 616e 2872 6174 696f 7329 0a20  p.mean(ratios). 
-00025f10: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00025f20: 2023 2073 7464 6576 5f70 6374 203d 206e   # stdev_pct = n
-00025f30: 702e 7374 6428 7261 7469 6f73 2920 2f20  p.std(ratios) / 
-00025f40: 7373 5f72 6174 696f 0a20 2020 2020 2020  ss_ratio.       
-00025f50: 2020 2020 2023 2020 2020 2023 2057 6569       #     # Wei
-00025f60: 6768 7420 6279 206e 756d 6265 7220 6f66  ght by number of
-00025f70: 2072 6f77 7320 7065 7220 6772 6f75 702c   rows per group,
-00025f80: 2062 6563 6175 7365 2067 726f 7570 7320   because groups 
-00025f90: 7769 7468 2031 2072 6f77 2069 7320 7363  with 1 row is sc
-00025fa0: 7265 7769 6e67 2076 6172 6961 6e63 652e  rewing variance.
-00025fb0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00025fc0: 2020 2073 7464 6576 5f70 6374 203d 2030     stdev_pct = 0
-00025fd0: 2e30 0a20 2020 2020 2020 2020 2020 2023  .0.            #
-00025fe0: 2020 2020 2077 6569 6768 7473 203d 2064       weights = d
-00025ff0: 665f 6772 702e 7369 7a65 2829 2e74 6f5f  f_grp.size().to_
-00026000: 6e75 6d70 7928 292e 6173 7479 7065 2866  numpy().astype(f
-00026010: 6c6f 6174 290a 2020 2020 2020 2020 2020  loat).          
-00026020: 2020 2320 2020 2020 7765 6967 6874 735f    #     weights_
-00026030: 3264 203d 206e 702e 7469 6c65 2877 6569  2d = np.tile(wei
-00026040: 6768 7473 5b3a 2c4e 6f6e 655d 2c20 7261  ghts[:,None], ra
-00026050: 7469 6f73 2e73 6861 7065 5b31 5d29 0a20  tios.shape[1]). 
-00026060: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00026070: 2073 735f 7261 7469 6f2c 2073 7464 203d   ss_ratio, std =
-00026080: 2079 6663 752e 6e70 5f77 6569 6768 7465   yfcu.np_weighte
-00026090: 645f 6d65 616e 5f61 6e64 5f73 7464 2872  d_mean_and_std(r
-000260a0: 6174 696f 732c 2077 6569 6768 7473 5f32  atios, weights_2
-000260b0: 6429 0a20 2020 2020 2020 2020 2020 2023  d).            #
-000260c0: 2020 2020 2073 7464 6576 5f70 6374 203d       stdev_pct =
-000260d0: 2073 7464 202f 2073 735f 7261 7469 6f0a   std / ss_ratio.
-000260e0: 2020 2020 2020 2020 2020 2020 2320 230a              # #.
-000260f0: 2020 2020 2020 2020 2020 2020 2320 2320              # # 
-00026100: 6966 2073 7464 6576 5f70 6374 203e 2030  if stdev_pct > 0
-00026110: 2e30 353a 0a20 2020 2020 2020 2020 2020  .05:.           
-00026120: 2023 2069 6620 7374 6465 765f 7063 7420   # if stdev_pct 
-00026130: 3e20 302e 3033 3a0a 2020 2020 2020 2020  > 0.03:.        
-00026140: 2020 2020 2320 2020 2020 636f 6c73 5f74      #     cols_t
-00026150: 6f5f 7072 696e 7420 3d20 5b5d 0a20 2020  o_print = [].   
-00026160: 2020 2020 2020 2020 2023 2020 2020 2066           #     f
-00026170: 6f72 2064 6320 696e 2064 6174 615f 636f  or dc in data_co
-00026180: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-00026190: 2320 2020 2020 2020 2020 6466 325b 6463  #         df2[dc
-000261a0: 202b 2022 5f72 225d 203d 2064 6632 5b64   + "_r"] = df2[d
-000261b0: 635d 202f 2064 6632 5b64 6320 2b20 225f  c] / df2[dc + "_
-000261c0: 6461 7922 5d0a 2020 2020 2020 2020 2020  day"].          
-000261d0: 2020 2320 2020 2020 2020 2020 636f 6c73    #         cols
-000261e0: 5f74 6f5f 7072 696e 742e 6170 7065 6e64  _to_print.append
-000261f0: 2864 6329 0a20 2020 2020 2020 2020 2020  (dc).           
-00026200: 2023 2020 2020 2020 2020 2063 6f6c 735f   #         cols_
-00026210: 746f 5f70 7269 6e74 2e61 7070 656e 6428  to_print.append(
-00026220: 6463 202b 2022 5f64 6179 2229 0a20 2020  dc + "_day").   
-00026230: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00026240: 2020 2063 6f6c 735f 746f 5f70 7269 6e74     cols_to_print
-00026250: 2e61 7070 656e 6428 6463 202b 2022 5f72  .append(dc + "_r
-00026260: 2229 0a20 2020 2020 2020 2020 2020 2023  ").            #
-00026270: 2020 2020 2070 7269 6e74 2864 6632 5b63       print(df2[c
-00026280: 6f6c 735f 746f 5f70 7269 6e74 5d29 0a20  ols_to_print]). 
-00026290: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-000262a0: 2072 6169 7365 2045 7863 6570 7469 6f6e   raise Exception
-000262b0: 2822 5354 4445 5620 2520 6f66 2065 7374  ("STDEV % of est
-000262c0: 696d 6174 6564 2073 746f 636b 2d73 706c  imated stock-spl
-000262d0: 6974 2072 6174 696f 2069 7320 7b7d 252c  it ratio is {}%,
-000262e0: 2073 686f 756c 6420 6265 206e 6561 7220   should be near 
-000262f0: 7a65 726f 222e 666f 726d 6174 2872 6f75  zero".format(rou
-00026300: 6e64 2873 7464 6576 5f70 6374 202a 2031  nd(stdev_pct * 1
-00026310: 3030 2c20 3129 2929 0a0a 2020 2020 2020  00, 1)))..      
-00026320: 2020 2020 2020 2320 2320 6966 2061 6273        # # if abs
-00026330: 2831 2e30 202d 2073 735f 7261 7469 6f20  (1.0 - ss_ratio 
-00026340: 2f20 6578 7065 6374 6564 5261 7469 6f29  / expectedRatio)
-00026350: 203e 2030 2e30 353a 0a20 2020 2020 2020   > 0.05:.       
-00026360: 2020 2020 2023 2069 6620 6162 7328 312e       # if abs(1.
-00026370: 3020 2d20 7373 5f72 6174 696f 202f 2065  0 - ss_ratio / e
-00026380: 7870 6563 7465 6452 6174 696f 2920 3e20  xpectedRatio) > 
-00026390: 302e 3033 3a0a 2020 2020 2020 2020 2020  0.03:.          
-000263a0: 2020 2320 2020 2020 636f 6c73 5f74 6f5f    #     cols_to_
-000263b0: 7072 696e 7420 3d20 5b5d 0a20 2020 2020  print = [].     
-000263c0: 2020 2020 2020 2023 2020 2020 2066 6f72         #     for
-000263d0: 2064 6320 696e 2064 6174 615f 636f 6c73   dc in data_cols
-000263e0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000263f0: 2020 2020 2020 2020 6466 325b 6463 202b          df2[dc +
-00026400: 2022 5f72 225d 203d 2064 6632 5b64 635d   "_r"] = df2[dc]
-00026410: 202f 2064 6632 5b64 6320 2b20 225f 6461   / df2[dc + "_da
-00026420: 7922 5d0a 2020 2020 2020 2020 2020 2020  y"].            
-00026430: 2320 2020 2020 2020 2020 636f 6c73 5f74  #         cols_t
-00026440: 6f5f 7072 696e 742e 6170 7065 6e64 2864  o_print.append(d
-00026450: 6329 0a20 2020 2020 2020 2020 2020 2023  c).            #
-00026460: 2020 2020 2020 2020 2063 6f6c 735f 746f           cols_to
-00026470: 5f70 7269 6e74 2e61 7070 656e 6428 6463  _print.append(dc
-00026480: 202b 2022 5f64 6179 2229 0a20 2020 2020   + "_day").     
-00026490: 2020 2020 2020 2023 2020 2020 2020 2020         #        
-000264a0: 2063 6f6c 735f 746f 5f70 7269 6e74 2e61   cols_to_print.a
-000264b0: 7070 656e 6428 6463 202b 2022 5f72 2229  ppend(dc + "_r")
-000264c0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-000264d0: 2020 2070 7269 6e74 2864 6632 5b63 6f6c     print(df2[col
-000264e0: 735f 746f 5f70 7269 6e74 5d29 0a20 2020  s_to_print]).   
-000264f0: 2020 2020 2020 2020 2023 2020 2020 2070           #     p
-00026500: 7269 6e74 2864 6632 5b63 6f6c 735f 746f  rint(df2[cols_to
-00026510: 5f70 7269 6e74 5d2e 696c 6f63 5b2d 315d  _print].iloc[-1]
-00026520: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00026530: 2020 2020 7072 696e 7428 2264 663a 2229      print("df:")
-00026540: 203b 2070 7269 6e74 2864 6629 0a20 2020   ; print(df).   
-00026550: 2020 2020 2020 2020 2023 2020 2020 2072           #     r
-00026560: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
-00026570: 7373 5f72 6174 696f 3d7b 7d20 213d 2065  ss_ratio={} != e
-00026580: 7870 6563 7465 645f 7261 7469 6f3d 7b7d  xpected_ratio={}
-00026590: 222e 666f 726d 6174 2873 735f 7261 7469  ".format(ss_rati
-000265a0: 6f2c 2065 7870 6563 7465 6452 6174 696f  o, expectedRatio
-000265b0: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-000265c0: 7373 5f72 6174 696f 203d 2065 7870 6563  ss_ratio = expec
-000265d0: 7465 6452 6174 696f 0a20 2020 2020 2020  tedRatio.       
-000265e0: 2020 2020 2073 735f 7261 7469 6f52 6370       ss_ratioRcp
-000265f0: 203d 2031 2e30 202f 2073 735f 7261 7469   = 1.0 / ss_rati
-00026600: 6f0a 2020 2020 2020 2020 2020 2020 230a  o.            #.
-00026610: 2020 2020 2020 2020 2020 2020 7072 6963              pric
-00026620: 655f 6461 7461 5f63 6f6c 7320 3d20 5b22  e_data_cols = ["
-00026630: 4f70 656e 222c 2022 436c 6f73 6522 2c20  Open", "Close", 
-00026640: 2241 646a 2043 6c6f 7365 222c 2022 4c6f  "Adj Close", "Lo
-00026650: 7722 2c20 2248 6967 6822 5d0a 2020 2020  w", "High"].    
-00026660: 2020 2020 2020 2020 6966 2073 735f 7261          if ss_ra
-00026670: 7469 6f20 3e20 312e 3031 3a0a 2020 2020  tio > 1.01:.    
-00026680: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00026690: 6320 696e 2070 7269 6365 5f64 6174 615f  c in price_data_
-000266a0: 636f 6c73 3a0a 2020 2020 2020 2020 2020  cols:.          
-000266b0: 2020 2020 2020 2020 2020 6466 5b63 5d20            df[c] 
-000266c0: 2a3d 2073 735f 7261 7469 6f52 6370 0a20  *= ss_ratioRcp. 
-000266d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000266e0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-000266f0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00026700: 6e74 2822 4170 706c 7969 6e67 2031 3a7b  nt("Applying 1:{
-00026710: 7d20 7374 6f63 6b2d 7370 6c69 7422 2e66  } stock-split".f
-00026720: 6f72 6d61 7428 726f 756e 6428 7373 5f72  ormat(round(ss_r
-00026730: 6174 696f 2c20 3229 2929 0a20 2020 2020  atio, 2))).     
-00026740: 2020 2020 2020 2065 6c69 6620 7373 5f72         elif ss_r
-00026750: 6174 696f 5263 7020 3e20 312e 3031 3a0a  atioRcp > 1.01:.
-00026760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026770: 666f 7220 6320 696e 2070 7269 6365 5f64  for c in price_d
-00026780: 6174 615f 636f 6c73 3a0a 2020 2020 2020  ata_cols:.      
-00026790: 2020 2020 2020 2020 2020 2020 2020 6466                df
-000267a0: 5b63 5d20 2a3d 2073 735f 7261 7469 6f0a  [c] *= ss_ratio.
-000267b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000267c0: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
-000267d0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000267e0: 696e 7428 2241 7070 6c79 696e 6720 7b2e  int("Applying {.
-000267f0: 3266 7d3a 3120 7265 7665 7273 652d 7370  2f}:1 reverse-sp
-00026800: 6c69 742d 7370 6c69 7422 2e66 6f72 6d61  lit-split".forma
-00026810: 7428 7373 5f72 6174 696f 5263 7029 290a  t(ss_ratioRcp)).
-00026820: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00026830: 7465 3a20 766f 6c75 6d65 2061 6c77 6179  te: volume alway
-00026840: 7320 7265 7475 726e 6564 2075 6e61 646a  s returned unadj
-00026850: 7573 7465 640a 0a20 2020 2020 2020 2020  usted..         
-00026860: 2020 2023 2059 6168 6f6f 206d 6573 7365     # Yahoo messe
-00026870: 7320 7570 2064 6976 6964 656e 6420 6164  s up dividend ad
-00026880: 6a75 7374 6d65 6e74 2074 6f6f 2073 6f20  justment too so 
-00026890: 636f 7079 2063 6f72 7265 6374 2064 6976  copy correct div
-000268a0: 6964 656e 6420 6672 6f6d 2064 6169 6c79  idend from daily
-000268b0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-000268c0: 6275 7420 6f6e 6c79 2074 6f20 6669 7273  but only to firs
-000268d0: 7420 7469 6d65 2070 6572 696f 6473 206f  t time periods o
-000268e0: 6620 6561 6368 2064 6179 3a0a 2020 2020  f each day:.    
-000268f0: 2020 2020 2020 2020 6466 5b22 5f64 6174          df["_dat
-00026900: 6522 5d20 3d20 6466 2e69 6e64 6578 2e64  e"] = df.index.d
-00026910: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-00026920: 6466 5b22 5f69 6e64 6578 4261 636b 7570  df["_indexBackup
-00026930: 225d 203d 2064 662e 696e 6465 780a 2020  "] = df.index.  
-00026940: 2020 2020 2020 2020 2020 2320 6466 203d            # df =
-00026950: 2064 662e 6472 6f70 2822 4469 7669 6465   df.drop("Divide
-00026960: 6e64 7322 2c20 6178 6973 3d31 290a 2020  nds", axis=1).  
-00026970: 2020 2020 2020 2020 2020 2320 2320 2d20            # # - 
-00026980: 6765 7420 6669 7273 7420 7469 6d65 730a  get first times.
-00026990: 2020 2020 2020 2020 2020 2020 2320 6466              # df
-000269a0: 5b22 5f74 696d 6522 5d20 3d20 6466 2e69  ["_time"] = df.i
-000269b0: 6e64 6578 2e74 696d 650a 2020 2020 2020  ndex.time.      
-000269c0: 2020 2020 2020 2320 6466 5f6f 7065 6e54        # df_openT
-000269d0: 696d 6573 203d 2064 665b 5b22 5f64 6174  imes = df[["_dat
-000269e0: 6522 2c20 225f 7469 6d65 225d 5d2e 6772  e", "_time"]].gr
-000269f0: 6f75 7062 7928 225f 6461 7465 222c 2061  oupby("_date", a
-00026a00: 735f 696e 6465 783d 4661 6c73 652c 2067  s_index=False, g
-00026a10: 726f 7570 5f6b 6579 733d 4661 6c73 6529  roup_keys=False)
-00026a20: 2e6d 696e 2829 2e72 656e 616d 6528 636f  .min().rename(co
-00026a30: 6c75 6d6e 733d 7b22 5f74 696d 6522 3a20  lumns={"_time": 
-00026a40: 225f 6f70 656e 5f74 696d 6522 7d29 0a20  "_open_time"}). 
-00026a50: 2020 2020 2020 2020 2020 2023 2064 6620             # df 
-00026a60: 3d20 6466 2e64 726f 7028 225f 7469 6d65  = df.drop("_time
-00026a70: 222c 2061 7869 733d 3129 0a20 2020 2020  ", axis=1).     
-00026a80: 2020 2020 2020 2023 2023 202d 206d 6572         # # - mer
-00026a90: 6765 0a20 2020 2020 2020 2020 2020 2023  ge.            #
-00026aa0: 2064 6620 3d20 7064 2e6d 6572 6765 2864   df = pd.merge(d
-00026ab0: 662c 2064 665f 6461 696c 795f 6475 7269  f, df_daily_duri
-00026ac0: 6e67 5b5b 2244 6976 6964 656e 6473 225d  ng[["Dividends"]
-00026ad0: 5d2c 2068 6f77 3d22 6c65 6674 222c 206f  ], how="left", o
-00026ae0: 6e3d 225f 6461 7465 222c 2076 616c 6964  n="_date", valid
-00026af0: 6174 653d 226d 616e 795f 746f 5f6f 6e65  ate="many_to_one
-00026b00: 2229 0a20 2020 2020 2020 2020 2020 2023  ").            #
-00026b10: 2064 6620 3d20 7064 2e6d 6572 6765 2864   df = pd.merge(d
-00026b20: 662c 2064 665f 6f70 656e 5469 6d65 732c  f, df_openTimes,
-00026b30: 2068 6f77 3d22 6c65 6674 222c 206f 6e3d   how="left", on=
-00026b40: 225f 6461 7465 2229 0a20 2020 2020 2020  "_date").       
-00026b50: 2020 2020 2023 2064 662e 696e 6465 7820       # df.index 
-00026b60: 3d20 6466 5b22 5f69 6e64 6578 4261 636b  = df["_indexBack
-00026b70: 7570 225d 203b 2064 662e 696e 6465 782e  up"] ; df.index.
-00026b80: 6e61 6d65 203d 204e 6f6e 650a 2020 2020  name = None.    
-00026b90: 2020 2020 2020 2020 2320 2320 2d20 636f          # # - co
-00026ba0: 7272 6563 7420 6469 7669 6465 6e64 730a  rrect dividends.
-00026bb0: 2020 2020 2020 2020 2020 2020 2320 6466              # df
-00026bc0: 2e6c 6f63 5b64 662e 696e 6465 782e 7469  .loc[df.index.ti
-00026bd0: 6d65 2021 3d20 6466 5b22 5f6f 7065 6e5f  me != df["_open_
-00026be0: 7469 6d65 225d 2c20 2244 6976 6964 656e  time"], "Dividen
-00026bf0: 6473 225d 203d 2030 2e30 0a20 2020 2020  ds"] = 0.0.     
-00026c00: 2020 2020 2020 2023 2064 6620 3d20 6466         # df = df
-00026c10: 2e64 726f 7028 225f 6f70 656e 5f74 696d  .drop("_open_tim
-00026c20: 6522 2c20 6178 6973 3d31 290a 2020 2020  e", axis=1).    
-00026c30: 2020 2020 2020 2020 2320 5550 4441 5445          # UPDATE
-00026c40: 3a20 6b65 6570 206f 7269 6769 6e61 6c20  : keep original 
-00026c50: 6469 7669 6465 6e64 732c 206f 6e6c 7920  dividends, only 
-00026c60: 7472 616e 7366 6572 2043 4446 2026 2043  transfer CDF & C
-00026c70: 5346 0a20 2020 2020 2020 2020 2020 2023  SF.            #
-00026c80: 2043 6f70 7920 6f76 6572 2043 5346 2061   Copy over CSF a
-00026c90: 6e64 2043 4446 2074 6f6f 2066 726f 6d20  nd CDF too from 
-00026ca0: 6461 696c 790a 2020 2020 2020 2020 2020  daily.          
-00026cb0: 2020 6466 203d 2070 642e 6d65 7267 6528    df = pd.merge(
-00026cc0: 6466 2c20 6466 5f64 6169 6c79 5f72 6177  df, df_daily_raw
-00026cd0: 5f64 7572 696e 675f 645b 5b22 4344 4622  _during_d[["CDF"
-00026ce0: 2c20 2243 5346 225d 5d2c 2068 6f77 3d22  , "CSF"]], how="
-00026cf0: 6c65 6674 222c 206f 6e3d 225f 6461 7465  left", on="_date
-00026d00: 222c 2076 616c 6964 6174 653d 226d 616e  ", validate="man
-00026d10: 795f 746f 5f6f 6e65 2229 0a20 2020 2020  y_to_one").     
-00026d20: 2020 2020 2020 2064 662e 696e 6465 7820         df.index 
-00026d30: 3d20 6466 5b22 5f69 6e64 6578 4261 636b  = df["_indexBack
-00026d40: 7570 225d 203b 2064 662e 696e 6465 782e  up"] ; df.index.
-00026d50: 6e61 6d65 203d 204e 6f6e 6520 3b20 6466  name = None ; df
-00026d60: 203d 2064 662e 6472 6f70 285b 225f 696e   = df.drop(["_in
-00026d70: 6465 7842 6163 6b75 7022 2c20 225f 6461  dexBackup", "_da
-00026d80: 7465 225d 2c20 6178 6973 3d31 290a 2020  te"], axis=1).  
-00026d90: 2020 2020 2020 2020 2020 6364 6620 3d20            cdf = 
-00026da0: 6466 5b22 4344 4622 5d0a 2020 2020 2020  df["CDF"].      
-00026db0: 2020 2020 2020 6466 5b22 4164 6a20 436c        df["Adj Cl
-00026dc0: 6f73 6522 5d20 3d20 6466 5b22 436c 6f73  ose"] = df["Clos
-00026dd0: 6522 5d20 2a20 6364 660a 2020 2020 2020  e"] * cdf.      
-00026de0: 2020 2020 2020 6373 6620 3d20 6466 5b22        csf = df["
-00026df0: 4353 4622 5d0a 0a20 2020 2020 2020 2020  CSF"]..         
-00026e00: 2020 2069 6620 6e6f 7420 6466 5f64 6169     if not df_dai
-00026e10: 6c79 5f70 6f73 742e 656d 7074 793a 0a20  ly_post.empty:. 
-00026e20: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00026e30: 6f73 745f 6373 6620 3d20 7966 6375 2e47  ost_csf = yfcu.G
-00026e40: 6574 4353 4630 2864 665f 6461 696c 795f  etCSF0(df_daily_
-00026e50: 706f 7374 290a 0a20 2020 2020 2020 2065  post)..        e
-00026e60: 6c69 6620 7365 6c66 2e69 6e74 6572 7661  lif self.interva
-00026e70: 6c20 3d3d 2079 6663 642e 496e 7465 7276  l == yfcd.Interv
-00026e80: 616c 2e57 6565 6b3a 0a20 2020 2020 2020  al.Week:.       
-00026e90: 2020 2020 2064 665f 6461 696c 7920 3d20       df_daily = 
-00026ea0: 6869 7374 4461 696c 792e 6765 7428 7374  histDaily.get(st
-00026eb0: 6172 743d 6466 2e69 6e64 6578 5b2d 315d  art=df.index[-1]
-00026ec0: 2e64 6174 6528 292b 7464 5f37 642c 2072  .date()+td_7d, r
-00026ed0: 6570 6169 723d 4661 6c73 6529 0a20 2020  epair=False).   
-00026ee0: 2020 2020 2020 2020 2069 6620 2864 665f           if (df_
-00026ef0: 6461 696c 7920 6973 206e 6f74 204e 6f6e  daily is not Non
-00026f00: 6529 2061 6e64 2028 6e6f 7420 6466 5f64  e) and (not df_d
-00026f10: 6169 6c79 2e65 6d70 7479 293a 0a20 2020  aily.empty):.   
-00026f20: 2020 2020 2020 2020 2020 2020 2070 6f73               pos
-00026f30: 745f 6373 6620 3d20 7966 6375 2e47 6574  t_csf = yfcu.Get
-00026f40: 4353 4630 2864 665f 6461 696c 7929 0a20  CSF0(df_daily). 
-00026f50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00026f60: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00026f70: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00026f80: 6e74 2822 2d20 706f 7374 5f63 7366 206f  nt("- post_csf o
-00026f90: 6620 6461 696c 7920 6461 7465 2072 616e  f daily date ran
-00026fa0: 6765 207b 7d2d 3e7b 7d20 3d20 7b7d 222e  ge {}->{} = {}".
-00026fb0: 666f 726d 6174 2864 665f 6461 696c 792e  format(df_daily.
-00026fc0: 696e 6465 785b 305d 2c20 6466 5f64 6169  index[0], df_dai
-00026fd0: 6c79 2e69 6e64 6578 5b2d 315d 2c20 706f  ly.index[-1], po
-00026fe0: 7374 5f63 7366 2929 0a0a 2020 2020 2020  st_csf))..      
-00026ff0: 2020 656c 6966 2073 656c 662e 696e 7465    elif self.inte
-00027000: 7276 616c 2069 6e20 5b79 6663 642e 496e  rval in [yfcd.In
-00027010: 7465 7276 616c 2e4d 6f6e 7468 7331 2c20  terval.Months1, 
-00027020: 7966 6364 2e49 6e74 6572 7661 6c2e 4d6f  yfcd.Interval.Mo
-00027030: 6e74 6873 335d 3a0a 2020 2020 2020 2020  nths3]:.        
-00027040: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-00027050: 696f 6e28 226e 6f74 2069 6d70 6c65 6d65  ion("not impleme
-00027060: 6e74 6564 2229 0a0a 2020 2020 2020 2020  nted")..        
-00027070: 2320 4966 2027 6466 2720 646f 6573 206e  # If 'df' does n
-00027080: 6f74 2063 6f6e 7461 696e 2061 6c6c 2073  ot contain all s
-00027090: 746f 636b 2073 706c 6974 7320 756e 7469  tock splits unti
-000270a0: 6c20 7072 6573 656e 742c 2074 6865 6e0a  l present, then.
-000270b0: 2020 2020 2020 2020 2320 7365 7420 2770          # set 'p
-000270c0: 6f73 745f 6373 6627 2074 6f20 6375 6d75  ost_csf' to cumu
-000270d0: 6c61 7469 7665 2073 746f 636b 2073 706c  lative stock spl
-000270e0: 6974 2066 6163 746f 7220 6a75 7374 2061  it factor just a
-000270f0: 6674 6572 206c 6173 7420 2764 6627 2064  fter last 'df' d
-00027100: 6174 650a 2020 2020 2020 2020 7370 6c69  ate.        spli
-00027110: 7473 5f70 6f73 7420 3d20 7365 6c66 2e6d  ts_post = self.m
-00027120: 616e 6167 6572 2e47 6574 4869 7374 6f72  anager.GetHistor
-00027130: 7928 2245 7665 6e74 7322 292e 4765 7453  y("Events").GetS
-00027140: 706c 6974 7328 7374 6172 743d 6466 2e69  plits(start=df.i
-00027150: 6e64 6578 5b2d 315d 2e64 6174 6528 292b  ndex[-1].date()+
-00027160: 7469 6d65 6465 6c74 6128 6461 7973 3d31  timedelta(days=1
-00027170: 2929 0a20 2020 2020 2020 2069 6620 7370  )).        if sp
-00027180: 6c69 7473 5f70 6f73 7420 6973 206e 6f74  lits_post is not
-00027190: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000271a0: 2020 2070 6f73 745f 6373 6620 3d20 312e     post_csf = 1.
-000271b0: 302f 7370 6c69 7473 5f70 6f73 745b 2253  0/splits_post["S
-000271c0: 746f 636b 2053 706c 6974 7322 5d2e 7072  tock Splits"].pr
-000271d0: 6f64 2829 0a20 2020 2020 2020 2065 6c73  od().        els
-000271e0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-000271f0: 6f73 745f 6373 6620 3d20 4e6f 6e65 0a0a  ost_csf = None..
-00027200: 2020 2020 2020 2020 2320 4375 6d75 6c61          # Cumula
-00027210: 7469 7665 2064 6976 6964 656e 6420 6661  tive dividend fa
-00027220: 6374 6f72 0a20 2020 2020 2020 2069 6620  ctor.        if 
-00027230: 6364 6620 6973 204e 6f6e 653a 0a20 2020  cdf is None:.   
-00027240: 2020 2020 2020 2020 2066 5f6e 6e61 203d           f_nna =
-00027250: 207e 6466 5b22 436c 6f73 6522 5d2e 6973   ~df["Close"].is
-00027260: 6e61 2829 0a20 2020 2020 2020 2020 2020  na().           
-00027270: 2069 6620 6e6f 7420 665f 6e6e 612e 616e   if not f_nna.an
-00027280: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-00027290: 2020 2020 2063 6466 203d 2031 2e30 0a20       cdf = 1.0. 
-000272a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000272b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000272c0: 2063 6466 203d 206e 702e 6675 6c6c 2864   cdf = np.full(d
-000272d0: 662e 7368 6170 655b 305d 2c20 6e70 2e6e  f.shape[0], np.n
-000272e0: 616e 290a 2020 2020 2020 2020 2020 2020  an).            
-000272f0: 2020 2020 6364 665b 665f 6e6e 615d 203d      cdf[f_nna] =
-00027300: 2064 662e 6c6f 635b 665f 6e6e 612c 2022   df.loc[f_nna, "
-00027310: 4164 6a20 436c 6f73 6522 5d20 2f20 6466  Adj Close"] / df
-00027320: 2e6c 6f63 5b66 5f6e 6e61 2c20 2243 6c6f  .loc[f_nna, "Clo
-00027330: 7365 225d 0a20 2020 2020 2020 2020 2020  se"].           
-00027340: 2020 2020 2063 6466 203d 2070 642e 5365       cdf = pd.Se
-00027350: 7269 6573 2863 6466 292e 6669 6c6c 6e61  ries(cdf).fillna
-00027360: 286d 6574 686f 643d 2262 6669 6c6c 2229  (method="bfill")
-00027370: 2e66 696c 6c6e 6128 6d65 7468 6f64 3d22  .fillna(method="
-00027380: 6666 696c 6c22 292e 746f 5f6e 756d 7079  ffill").to_numpy
-00027390: 2829 0a0a 2020 2020 2020 2020 2320 4375  ()..        # Cu
-000273a0: 6d75 6c61 7469 7665 2073 746f 636b 2d73  mulative stock-s
-000273b0: 706c 6974 2066 6163 746f 720a 2020 2020  plit factor.    
-000273c0: 2020 2020 6966 2063 7366 2069 7320 4e6f      if csf is No
-000273d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000273e0: 7373 203d 2064 665b 2253 746f 636b 2053  ss = df["Stock S
-000273f0: 706c 6974 7322 5d2e 636f 7079 2829 0a20  plits"].copy(). 
-00027400: 2020 2020 2020 2020 2020 2073 735b 2873             ss[(s
-00027410: 7320 3d3d 2030 2e30 2920 7c20 7373 2e69  s == 0.0) | ss.i
-00027420: 736e 6128 295d 203d 2031 2e30 0a20 2020  sna()] = 1.0.   
-00027430: 2020 2020 2020 2020 2073 735f 7263 7020           ss_rcp 
-00027440: 3d20 312e 3020 2f20 7373 0a20 2020 2020  = 1.0 / ss.     
-00027450: 2020 2020 2020 2063 7366 203d 2073 735f         csf = ss_
-00027460: 7263 702e 736f 7274 5f69 6e64 6578 2861  rcp.sort_index(a
-00027470: 7363 656e 6469 6e67 3d46 616c 7365 292e  scending=False).
-00027480: 6375 6d70 726f 6428 292e 736f 7274 5f69  cumprod().sort_i
-00027490: 6e64 6578 2861 7363 656e 6469 6e67 3d54  ndex(ascending=T
-000274a0: 7275 6529 2e73 6869 6674 282d 312c 2066  rue).shift(-1, f
-000274b0: 696c 6c5f 7661 6c75 653d 312e 3029 0a20  ill_value=1.0). 
-000274c0: 2020 2020 2020 2020 2020 2069 6620 706f             if po
-000274d0: 7374 5f63 7366 2069 7320 6e6f 7420 4e6f  st_csf is not No
-000274e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000274f0: 2020 2020 6373 6620 2a3d 2070 6f73 745f      csf *= post_
-00027500: 6373 660a 2020 2020 2020 2020 6373 665f  csf.        csf_
-00027510: 7263 7020 3d20 312e 3020 2f20 6373 660a  rcp = 1.0 / csf.
-00027520: 0a20 2020 2020 2020 2023 2052 6576 6572  .        # Rever
-00027530: 7365 2059 6168 6f6f 2773 2073 706c 6974  se Yahoo's split
-00027540: 2061 646a 7573 746d 656e 743a 0a20 2020   adjustment:.   
-00027550: 2020 2020 2064 6174 615f 636f 6c73 203d       data_cols =
-00027560: 205b 224f 7065 6e22 2c20 2248 6967 6822   ["Open", "High"
-00027570: 2c20 224c 6f77 222c 2022 436c 6f73 6522  , "Low", "Close"
-00027580: 2c20 2244 6976 6964 656e 6473 225d 0a20  , "Dividends"]. 
-00027590: 2020 2020 2020 2066 6f72 2064 6320 696e         for dc in
-000275a0: 2064 6174 615f 636f 6c73 3a0a 2020 2020   data_cols:.    
-000275b0: 2020 2020 2020 2020 6466 5b64 635d 203d          df[dc] =
-000275c0: 2064 665b 6463 5d20 2a20 6373 665f 7263   df[dc] * csf_rc
-000275d0: 700a 2020 2020 2020 2020 6966 206e 6f74  p.        if not
-000275e0: 2073 656c 662e 696e 7465 7264 6179 3a0a   self.interday:.
-000275f0: 2020 2020 2020 2020 2020 2020 2320 446f              # Do
-00027600: 6e27 7420 6e65 6564 2074 6f20 6465 2d73  n't need to de-s
-00027610: 706c 6974 2076 6f6c 756d 6520 6461 7461  plit volume data
-00027620: 2062 6563 6175 7365 2059 6168 6f6f 2061   because Yahoo a
-00027630: 6c77 6179 7320 7265 7475 726e 7320 696e  lways returns in
-00027640: 7465 7264 6179 2076 6f6c 756d 6520 756e  terday volume un
-00027650: 6164 6a75 7374 6564 0a20 2020 2020 2020  adjusted.       
-00027660: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-00027670: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00027680: 2020 2020 6466 5b22 566f 6c75 6d65 225d      df["Volume"]
-00027690: 202a 3d20 6373 660a 0a20 2020 2020 2020   *= csf..       
-000276a0: 2023 2044 726f 7020 2741 646a 2043 6c6f   # Drop 'Adj Clo
-000276b0: 7365 272c 2072 6570 6c61 6365 2077 6974  se', replace wit
-000276c0: 6820 7363 616c 696e 6720 6661 6374 6f72  h scaling factor
-000276d0: 733a 0a20 2020 2020 2020 2064 6620 3d20  s:.        df = 
-000276e0: 6466 2e64 726f 7028 2241 646a 2043 6c6f  df.drop("Adj Clo
-000276f0: 7365 222c 2061 7869 733d 3129 0a20 2020  se", axis=1).   
-00027700: 2020 2020 2064 665b 2243 5346 225d 203d       df["CSF"] =
-00027710: 2063 7366 0a20 2020 2020 2020 2064 665b   csf.        df[
-00027720: 2243 4446 225d 203d 2063 6466 0a0a 2020  "CDF"] = cdf..  
-00027730: 2020 2020 2020 685f 6c61 7374 4469 7641        h_lastDivA
-00027740: 646a 7573 7444 7420 3d20 7064 2e54 696d  djustDt = pd.Tim
-00027750: 6573 7461 6d70 2e75 7463 6e6f 7728 292e  estamp.utcnow().
-00027760: 747a 5f63 6f6e 7665 7274 285a 6f6e 6549  tz_convert(ZoneI
-00027770: 6e66 6f28 2255 5443 2229 290a 2020 2020  nfo("UTC")).    
-00027780: 2020 2020 685f 6c61 7374 5370 6c69 7441      h_lastSplitA
-00027790: 646a 7573 7444 7420 3d20 685f 6c61 7374  djustDt = h_last
-000277a0: 4469 7641 646a 7573 7444 740a 2020 2020  DivAdjustDt.    
-000277b0: 2020 2020 6466 5b22 4c61 7374 4469 7641      df["LastDivA
-000277c0: 646a 7573 7444 7422 5d20 3d20 685f 6c61  djustDt"] = h_la
-000277d0: 7374 4469 7641 646a 7573 7444 740a 2020  stDivAdjustDt.  
-000277e0: 2020 2020 2020 6466 5b22 4c61 7374 5370        df["LastSp
-000277f0: 6c69 7441 646a 7573 7444 7422 5d20 3d20  litAdjustDt"] = 
-00027800: 685f 6c61 7374 5370 6c69 7441 646a 7573  h_lastSplitAdjus
-00027810: 7444 740a 0a20 2020 2020 2020 2069 6620  tDt..        if 
-00027820: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-00027830: 2020 2070 7269 6e74 2822 2d20 756e 6164     print("- unad
-00027840: 6a75 7374 6564 3a22 290a 2020 2020 2020  justed:").      
-00027850: 2020 2020 2020 7072 696e 7428 6466 5b5b        print(df[[
-00027860: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
-00027870: 6e64 7322 2c20 2256 6f6c 756d 6522 2c20  nds", "Volume", 
-00027880: 2243 5346 222c 2022 4344 4622 5d5d 290a  "CSF", "CDF"]]).
-00027890: 2020 2020 2020 2020 2020 2020 6620 3d20              f = 
-000278a0: 6466 5b22 4469 7669 6465 6e64 7322 5d20  df["Dividends"] 
-000278b0: 213d 2030 2e30 0a20 2020 2020 2020 2020  != 0.0.         
-000278c0: 2020 2069 6620 662e 616e 7928 293a 0a20     if f.any():. 
-000278d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000278e0: 7269 6e74 2822 2d20 6469 7669 6465 6e64  rint("- dividend
-000278f0: 733a 2229 0a20 2020 2020 2020 2020 2020  s:").           
-00027900: 2020 2020 2070 7269 6e74 2864 662e 6c6f       print(df.lo
-00027910: 635b 662c 205b 224f 7065 6e22 2c20 224c  c[f, ["Open", "L
-00027920: 6f77 222c 2022 4869 6768 222c 2022 436c  ow", "High", "Cl
-00027930: 6f73 6522 2c20 2244 6976 6964 656e 6473  ose", "Dividends
-00027940: 222c 2022 566f 6c75 6d65 222c 2022 4353  ", "Volume", "CS
-00027950: 4622 2c20 2243 4446 225d 5d29 0a20 2020  F", "CDF"]]).   
-00027960: 2020 2020 2020 2020 2070 7269 6e74 2822           print("
-00027970: 2229 0a0a 2020 2020 2020 2020 6c6f 675f  ")..        log_
-00027980: 6d73 6720 3d20 6622 504d 3a3a 5f72 6576  msg = f"PM::_rev
-00027990: 6572 7365 5961 686f 6f41 646a 7573 742d  erseYahooAdjust-
-000279a0: 7b73 656c 662e 6973 7472 7d28 2920 7265  {self.istr}() re
-000279b0: 7475 726e 696e 6722 0a20 2020 2020 2020  turning".       
-000279c0: 2069 6620 7966 636c 2e49 7354 7261 6369   if yfcl.IsTraci
-000279d0: 6e67 456e 6162 6c65 6428 293a 0a20 2020  ngEnabled():.   
-000279e0: 2020 2020 2020 2020 2079 6663 6c2e 5472           yfcl.Tr
-000279f0: 6163 6545 7869 7428 6c6f 675f 6d73 6729  aceExit(log_msg)
-00027a00: 0a20 2020 2020 2020 2065 6c69 6620 6465  .        elif de
-00027a10: 6275 673a 0a20 2020 2020 2020 2020 2020  bug:.           
-00027a20: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
-00027a30: 0a20 2020 2020 2020 2069 6620 6465 6275  .        if debu
-00027a40: 673a 0a20 2020 2020 2020 2020 2020 2070  g:.            p
-00027a50: 7269 6e74 2864 665b 5b22 4f70 656e 222c  rint(df[["Open",
-00027a60: 2022 4c6f 7722 2c20 2248 6967 6822 2c20   "Low", "High", 
-00027a70: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
-00027a80: 6e64 7322 2c20 2256 6f6c 756d 6522 2c20  nds", "Volume", 
-00027a90: 2243 5346 225d 5d29 0a0a 2020 2020 2020  "CSF"]])..      
-00027aa0: 2020 7265 7475 726e 2064 660a 0a20 2020    return df..   
-00027ab0: 2064 6566 205f 6170 706c 794e 6577 4576   def _applyNewEv
-00027ac0: 656e 7473 2873 656c 6629 3a0a 2020 2020  ents(self):.    
-00027ad0: 2020 2020 6966 2073 656c 662e 6820 6973      if self.h is
-00027ae0: 204e 6f6e 6520 6f72 2073 656c 662e 682e   None or self.h.
-00027af0: 656d 7074 793a 0a20 2020 2020 2020 2020  empty:.         
-00027b00: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00027b10: 2020 2064 6562 7567 203d 2046 616c 7365     debug = False
-00027b20: 0a20 2020 2020 2020 2023 2064 6562 7567  .        # debug
-00027b30: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
-00027b40: 2068 5f6d 6f64 6966 6965 6420 3d20 4661   h_modified = Fa
-00027b50: 6c73 650a 0a20 2020 2020 2020 2023 2042  lse..        # B
-00027b60: 6163 6b70 6f72 7420 6e65 7720 7370 6c69  ackport new spli
-00027b70: 7473 2061 6372 6f73 7320 656e 7469 7265  ts across entire
-00027b80: 2068 2074 6162 6c65 0a20 2020 2020 2020   h table.       
-00027b90: 206c 6173 7453 706c 6974 4164 6a75 7374   lastSplitAdjust
-00027ba0: 4474 5f6d 696e 203d 2073 656c 662e 685b  Dt_min = self.h[
-00027bb0: 224c 6173 7453 706c 6974 4164 6a75 7374  "LastSplitAdjust
-00027bc0: 4474 225d 2e6d 696e 2829 0a20 2020 2020  Dt"].min().     
-00027bd0: 2020 2073 706c 6974 735f 7369 6e63 6520     splits_since 
-00027be0: 3d20 7365 6c66 2e6d 616e 6167 6572 2e47  = self.manager.G
-00027bf0: 6574 4869 7374 6f72 7928 2245 7665 6e74  etHistory("Event
-00027c00: 7322 292e 4765 7453 706c 6974 7346 6574  s").GetSplitsFet
-00027c10: 6368 6564 5369 6e63 6528 6c61 7374 5370  chedSince(lastSp
-00027c20: 6c69 7441 646a 7573 7444 745f 6d69 6e29  litAdjustDt_min)
-00027c30: 0a20 2020 2020 2020 2069 6620 7370 6c69  .        if spli
-00027c40: 7473 5f73 696e 6365 2069 7320 6e6f 7420  ts_since is not 
-00027c50: 4e6f 6e65 2061 6e64 206e 6f74 2073 706c  None and not spl
-00027c60: 6974 735f 7369 6e63 652e 656d 7074 793a  its_since.empty:
-00027c70: 0a20 2020 2020 2020 2020 2020 2066 5f73  .            f_s
-00027c80: 7570 203d 2073 706c 6974 735f 7369 6e63  up = splits_sinc
-00027c90: 655b 2253 7570 6572 7365 6465 6420 7370  e["Superseded sp
-00027ca0: 6c69 7422 5d20 213d 2030 2e30 0a20 2020  lit"] != 0.0.   
-00027cb0: 2020 2020 2020 2020 2069 6620 665f 7375           if f_su
-00027cc0: 702e 616e 7928 293a 0a20 2020 2020 2020  p.any():.       
-00027cd0: 2020 2020 2020 2020 2066 6f72 2064 7420           for dt 
-00027ce0: 696e 2073 706c 6974 735f 7369 6e63 652e  in splits_since.
-00027cf0: 696e 6465 785b 665f 7375 705d 3a0a 2020  index[f_sup]:.  
-00027d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027d10: 2020 7370 6c69 7420 3d20 7370 6c69 7473    split = splits
-00027d20: 5f73 696e 6365 2e6c 6f63 5b64 745d 0a20  _since.loc[dt]. 
-00027d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027d40: 2020 2066 203d 2073 656c 662e 685b 224c     f = self.h["L
-00027d50: 6173 7453 706c 6974 4164 6a75 7374 4474  astSplitAdjustDt
-00027d60: 225d 203d 3d20 7370 6c69 745b 2253 7570  "] == split["Sup
-00027d70: 6572 7365 6465 6420 7370 6c69 7420 4665  erseded split Fe
-00027d80: 7463 6844 6174 6522 5d0a 2020 2020 2020  tchDate"].      
-00027d90: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00027da0: 206e 6f74 2066 2e61 6e79 2829 3a0a 2020   not f.any():.  
-00027db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027dc0: 2020 2020 2020 6966 2073 656c 662e 696e        if self.in
-00027dd0: 7465 7276 616c 2021 3d20 7966 6364 2e49  terval != yfcd.I
-00027de0: 6e74 6572 7661 6c2e 4461 7973 313a 0a20  nterval.Days1:. 
-00027df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e00: 2020 2020 2020 2020 2020 2023 2050 726f             # Pro
-00027e10: 6261 626c 7920 6f6b 2c20 6173 7375 6d69  bably ok, assumi
-00027e20: 6e67 2073 7570 6572 7365 6465 6420 7370  ng superseded sp
-00027e30: 6c69 7420 7761 7320 6e65 7665 7220 6170  lit was never ap
-00027e40: 706c 6965 6420 746f 2074 6869 7320 7072  plied to this pr
-00027e50: 6963 6520 6461 7461 0a20 2020 2020 2020  ice data.       
-00027e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e70: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
-00027e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e90: 2020 2020 2020 656c 6966 2064 6562 7567        elif debug
-00027ea0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027eb0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00027ec0: 696e 7428 7370 6c69 7429 0a20 2020 2020  int(split).     
-00027ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ee0: 2020 2020 2020 2072 6169 7365 2045 7863         raise Exc
-00027ef0: 6570 7469 6f6e 2866 2246 6f72 2073 7570  eption(f"For sup
-00027f00: 6572 7365 6465 6420 7370 6c69 7420 6162  erseded split ab
-00027f10: 6f76 652c 2066 6169 6c65 6420 746f 2069  ove, failed to i
-00027f20: 6465 6e74 6966 7920 726f 7773 2074 6f20  dentify rows to 
-00027f30: 756e 646f 2e20 5072 6f62 6c65 6d3f 2229  undo. Problem?")
-00027f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027f50: 2020 2020 2073 656c 662e 682e 6c6f 635b       self.h.loc[
-00027f60: 662c 2022 4353 4622 5d20 2a3d 2073 706c  f, "CSF"] *= spl
-00027f70: 6974 5b22 5375 7065 7273 6564 6564 2062  it["Superseded b
-00027f80: 6163 6b20 6164 6a2e 225d 0a20 2020 2020  ack adj."].     
-00027f90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027fa0: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
-00027fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027fc0: 2070 7269 6e74 2866 2255 6e64 6f6e 6520   print(f"Undone 
-00027fd0: 7375 7065 7273 6564 6564 2073 706c 6974  superseded split
-00027fe0: 2040 207b 6474 7d3a 2229 0a20 2020 2020   @ {dt}:").     
-00027ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028000: 2020 2070 7269 6e74 2873 656c 662e 682e     print(self.h.
-00028010: 6c6f 635b 662c 205b 2243 5346 222c 2022  loc[f, ["CSF", "
-00028020: 4665 7463 6844 6174 6522 2c20 224c 6173  FetchDate", "Las
-00028030: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
-00028040: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00028050: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00028060: 2822 2229 0a0a 2020 2020 2020 2020 2020  ("")..          
-00028070: 2020 666f 7220 6474 2069 6e20 7370 6c69    for dt in spli
-00028080: 7473 5f73 696e 6365 2e69 6e64 6578 3a0a  ts_since.index:.
-00028090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000280a0: 7370 6c69 7420 3d20 7370 6c69 7473 5f73  split = splits_s
-000280b0: 696e 6365 2e6c 6f63 5b64 745d 0a20 2020  ince.loc[dt].   
-000280c0: 2020 2020 2020 2020 2020 2020 2066 3120               f1 
-000280d0: 3d20 7365 6c66 2e68 2e69 6e64 6578 203c  = self.h.index <
-000280e0: 2064 740a 2020 2020 2020 2020 2020 2020   dt.            
-000280f0: 2020 2020 6632 203d 2073 656c 662e 685b      f2 = self.h[
-00028100: 224c 6173 7453 706c 6974 4164 6a75 7374  "LastSplitAdjust
-00028110: 4474 225d 203c 2073 706c 6974 5b22 4665  Dt"] < split["Fe
-00028120: 7463 6844 6174 6522 5d0a 2020 2020 2020  tchDate"].      
-00028130: 2020 2020 2020 2020 2020 6620 3d20 6631            f = f1
-00028140: 2026 2066 320a 2020 2020 2020 2020 2020   & f2.          
-00028150: 2020 2020 2020 6966 2066 2e61 6e79 2829        if f.any()
-00028160: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028170: 2020 2020 2020 6d73 6720 3d20 6622 7b73        msg = f"{s
-00028180: 656c 662e 7469 636b 6572 7d3a 207b 7365  elf.ticker}: {se
-00028190: 6c66 2e69 7374 727d 3a20 4170 706c 7969  lf.istr}: Applyi
-000281a0: 6e67 2073 706c 6974 207b 7370 6c69 745b  ng split {split[
-000281b0: 2753 746f 636b 2053 706c 6974 7327 5d7d  'Stock Splits']}
-000281c0: 2040 207b 6474 2e64 6174 6528 297d 220a   @ {dt.date()}".
-000281d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000281e0: 2020 2020 696e 6469 6365 7320 3d20 6e70      indices = np
-000281f0: 2e77 6865 7265 2866 295b 305d 0a20 2020  .where(f)[0].   
-00028200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028210: 206d 7367 202b 3d20 6622 2061 6372 6f73   msg += f" acros
-00028220: 7320 696e 7465 7276 616c 7320 220a 2020  s intervals ".  
-00028230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028240: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
-00028250: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
-00028260: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00028270: 2b3d 2066 227b 7365 6c66 2e68 2e69 6e64  += f"{self.h.ind
-00028280: 6578 5b69 6e64 6963 6573 5b30 5d5d 2e64  ex[indices[0]].d
-00028290: 6174 6528 297d 202d 3e20 7b73 656c 662e  ate()} -> {self.
-000282a0: 682e 696e 6465 785b 696e 6469 6365 735b  h.index[indices[
-000282b0: 2d31 5d5d 2e64 6174 6528 297d 2028 696e  -1]].date()} (in
-000282c0: 6329 220a 2020 2020 2020 2020 2020 2020  c)".            
-000282d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000282e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000282f0: 2020 2020 2020 6d73 6720 2b3d 2066 227b        msg += f"{
-00028300: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
-00028310: 6963 6573 5b30 5d5d 7d20 2d3e 207b 7365  ices[0]]} -> {se
-00028320: 6c66 2e68 2e69 6e64 6578 5b69 6e64 6963  lf.h.index[indic
-00028330: 6573 5b2d 315d 5d7d 220a 2020 2020 2020  es[-1]]}".      
-00028340: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
-00028350: 6720 2b3d 2066 2220 6c61 7374 2043 5346  g += f" last CSF
-00028360: 203d 207b 7365 6c66 2e68 5b27 4353 4627   = {self.h['CSF'
-00028370: 5d2e 696c 6f63 5b69 6e64 6963 6573 5b2d  ].iloc[indices[-
-00028380: 315d 5d3a 2e35 667d 220a 2020 2020 2020  1]]:.5f}".      
-00028390: 2020 2020 2020 2020 2020 2020 2020 7966                yf
-000283a0: 636c 2e54 7261 6365 5072 696e 7428 6d73  cl.TracePrint(ms
-000283b0: 6729 2069 6620 7966 636c 2e49 7354 7261  g) if yfcl.IsTra
-000283c0: 6369 6e67 456e 6162 6c65 6428 2920 656c  cingEnabled() el
-000283d0: 7365 2070 7269 6e74 2866 227b 7365 6c66  se print(f"{self
-000283e0: 2e74 6963 6b65 727d 3a20 2220 2b20 6d73  .ticker}: " + ms
-000283f0: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
-00028400: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00028410: 7461 6e63 6528 7365 6c66 2e68 5b22 4353  tance(self.h["CS
-00028420: 4622 5d2e 696c 6f63 5b30 5d2c 2028 696e  F"].iloc[0], (in
-00028430: 742c 206e 702e 696e 7436 3429 293a 0a20  t, np.int64)):. 
-00028440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028450: 2020 2020 2020 2073 656c 662e 685b 2243         self.h["C
-00028460: 5346 225d 203d 2073 656c 662e 685b 2243  SF"] = self.h["C
-00028470: 5346 225d 2e61 7374 7970 6528 666c 6f61  SF"].astype(floa
-00028480: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00028490: 2020 2020 2020 2073 656c 662e 682e 6c6f         self.h.lo
-000284a0: 635b 662c 2022 4353 4622 5d20 2f3d 2073  c[f, "CSF"] /= s
-000284b0: 706c 6974 5b22 5374 6f63 6b20 5370 6c69  plit["Stock Spli
-000284c0: 7473 225d 0a20 2020 2020 2020 2020 2020  ts"].           
-000284d0: 2020 2020 2020 2020 2073 656c 662e 682e           self.h.
-000284e0: 6c6f 635b 662c 2022 4c61 7374 5370 6c69  loc[f, "LastSpli
-000284f0: 7441 646a 7573 7444 7422 5d20 3d20 6e70  tAdjustDt"] = np
-00028500: 2e6d 6178 696d 756d 2873 656c 662e 682e  .maximum(self.h.
-00028510: 6c6f 635b 662c 2022 4c61 7374 5370 6c69  loc[f, "LastSpli
-00028520: 7441 646a 7573 7444 7422 5d2c 2073 706c  tAdjustDt"], spl
-00028530: 6974 5b22 4665 7463 6844 6174 6522 5d29  it["FetchDate"])
-00028540: 0a0a 2020 2020 2020 2020 2020 2020 685f  ..            h_
-00028550: 6d6f 6469 6669 6564 203d 2054 7275 650a  modified = True.
-00028560: 0a20 2020 2020 2020 2023 2042 6163 6b70  .        # Backp
-00028570: 6f72 7420 6e65 7720 6469 7673 2061 6372  ort new divs acr
-00028580: 6f73 7320 656e 7469 7265 2068 2074 6162  oss entire h tab
-00028590: 6c65 0a20 2020 2020 2020 206c 6173 7444  le.        lastD
-000285a0: 6976 4164 6a75 7374 4474 5f6d 696e 203d  ivAdjustDt_min =
-000285b0: 2073 656c 662e 685b 224c 6173 7444 6976   self.h["LastDiv
-000285c0: 4164 6a75 7374 4474 225d 2e6d 696e 2829  AdjustDt"].min()
-000285d0: 0a20 2020 2020 2020 2069 6620 6973 696e  .        if isin
-000285e0: 7374 616e 6365 286c 6173 7444 6976 4164  stance(lastDivAd
-000285f0: 6a75 7374 4474 5f6d 696e 2e74 7a69 6e66  justDt_min.tzinf
-00028600: 6f2c 2070 7974 7a2e 4261 7365 547a 496e  o, pytz.BaseTzIn
-00028610: 666f 293a 0a20 2020 2020 2020 2020 2020  fo):.           
-00028620: 2073 656c 662e 685b 224c 6173 7444 6976   self.h["LastDiv
-00028630: 4164 6a75 7374 4474 225d 203d 2073 656c  AdjustDt"] = sel
-00028640: 662e 685b 224c 6173 7444 6976 4164 6a75  f.h["LastDivAdju
-00028650: 7374 4474 225d 2e64 742e 747a 5f63 6f6e  stDt"].dt.tz_con
-00028660: 7665 7274 2873 656c 662e 682e 696e 6465  vert(self.h.inde
-00028670: 782e 747a 290a 2020 2020 2020 2020 2020  x.tz).          
-00028680: 2020 685f 6d6f 6469 6669 6564 203d 2054    h_modified = T
-00028690: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-000286a0: 6c61 7374 4469 7641 646a 7573 7444 745f  lastDivAdjustDt_
-000286b0: 6d69 6e20 3d20 7365 6c66 2e68 5b22 4c61  min = self.h["La
-000286c0: 7374 4469 7641 646a 7573 7444 7422 5d2e  stDivAdjustDt"].
-000286d0: 6d69 6e28 290a 2020 2020 2020 2020 6469  min().        di
-000286e0: 7673 5f73 696e 6365 203d 2073 656c 662e  vs_since = self.
-000286f0: 6d61 6e61 6765 722e 4765 7448 6973 746f  manager.GetHisto
-00028700: 7279 2822 4576 656e 7473 2229 2e47 6574  ry("Events").Get
-00028710: 4469 7673 4665 7463 6865 6453 696e 6365  DivsFetchedSince
-00028720: 286c 6173 7444 6976 4164 6a75 7374 4474  (lastDivAdjustDt
-00028730: 5f6d 696e 290a 2020 2020 2020 2020 6966  _min).        if
-00028740: 2064 6976 735f 7369 6e63 6520 6973 206e   divs_since is n
-00028750: 6f74 204e 6f6e 6520 616e 6420 6e6f 7420  ot None and not 
-00028760: 6469 7673 5f73 696e 6365 2e65 6d70 7479  divs_since.empty
-00028770: 3a0a 2020 2020 2020 2020 2020 2020 665f  :.            f_
-00028780: 7375 7020 3d20 6469 7673 5f73 696e 6365  sup = divs_since
-00028790: 5b22 5375 7065 7273 6564 6564 2062 6163  ["Superseded bac
-000287a0: 6b20 6164 6a2e 225d 2021 3d20 302e 300a  k adj."] != 0.0.
-000287b0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-000287c0: 5f73 7570 2e61 6e79 2829 3a0a 2020 2020  _sup.any():.    
-000287d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000287e0: 6474 2069 6e20 6469 7673 5f73 696e 6365  dt in divs_since
-000287f0: 2e69 6e64 6578 5b66 5f73 7570 5d3a 0a20  .index[f_sup]:. 
-00028800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028810: 2020 2064 6976 203d 2064 6976 735f 7369     div = divs_si
-00028820: 6e63 652e 6c6f 635b 6474 5d0a 2020 2020  nce.loc[dt].    
-00028830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028840: 6620 3d20 7365 6c66 2e68 5b22 4c61 7374  f = self.h["Last
-00028850: 4469 7641 646a 7573 7444 7422 5d20 3d3d  DivAdjustDt"] ==
-00028860: 2064 6976 5b22 5375 7065 7273 6564 6564   div["Superseded
-00028870: 2064 6976 2046 6574 6368 4461 7465 225d   div FetchDate"]
-00028880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028890: 2020 2020 2069 6620 6e6f 7420 662e 616e       if not f.an
-000288a0: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
-000288b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000288c0: 7365 6c66 2e69 6e74 6572 7661 6c20 213d  self.interval !=
-000288d0: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
-000288e0: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
-000288f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028900: 2020 2320 5072 6f62 6162 6c79 206f 6b2c    # Probably ok,
-00028910: 2061 7373 756d 696e 6720 7375 7065 7273   assuming supers
-00028920: 6564 6564 2064 6976 2077 6173 206e 6576  eded div was nev
-00028930: 6572 2061 7070 6c69 6564 2074 6f20 7468  er applied to th
-00028940: 6973 2070 7269 6365 2064 6174 610a 2020  is price data.  
-00028950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028960: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00028970: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00028980: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00028990: 6465 6275 673a 0a20 2020 2020 2020 2020  debug:.         
-000289a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289b0: 2020 2070 7269 6e74 2864 6976 290a 2020     print(div).  
-000289c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000289e0: 4578 6365 7074 696f 6e28 6622 466f 7220  Exception(f"For 
-000289f0: 7375 7065 7273 6564 6564 2064 6976 2061  superseded div a
-00028a00: 626f 7665 2c20 6661 696c 6564 2074 6f20  bove, failed to 
-00028a10: 6964 656e 7469 6679 2072 6f77 7320 746f  identify rows to
-00028a20: 2075 6e64 6f2e 2050 726f 626c 656d 3f22   undo. Problem?"
-00028a30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028a40: 2020 2020 2020 7365 6c66 2e68 2e6c 6f63        self.h.loc
-00028a50: 5b66 2c20 2243 4446 225d 202f 3d20 6469  [f, "CDF"] /= di
-00028a60: 765b 2253 7570 6572 7365 6465 6420 6261  v["Superseded ba
-00028a70: 636b 2061 646a 2e22 5d0a 2020 2020 2020  ck adj."].      
-00028a80: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00028a90: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
-00028aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ab0: 7072 696e 7428 6622 556e 646f 6e65 2073  print(f"Undone s
-00028ac0: 7570 6572 7365 6465 6420 6469 7669 6465  uperseded divide
-00028ad0: 6e64 2040 207b 6474 7d3a 2229 0a20 2020  nd @ {dt}:").   
-00028ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028af0: 2020 2020 2070 7269 6e74 2873 656c 662e       print(self.
-00028b00: 682e 6c6f 635b 662c 205b 2243 4446 222c  h.loc[f, ["CDF",
-00028b10: 2022 4665 7463 6844 6174 6522 2c20 224c   "FetchDate", "L
-00028b20: 6173 7444 6976 4164 6a75 7374 4474 225d  astDivAdjustDt"]
-00028b30: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00028b40: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00028b50: 2822 2229 0a0a 2020 2020 2020 2020 2020  ("")..          
-00028b60: 2020 666f 7220 6474 2069 6e20 6469 7673    for dt in divs
-00028b70: 5f73 696e 6365 2e69 6e64 6578 3a0a 2020  _since.index:.  
-00028b80: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00028b90: 7620 3d20 6469 7673 5f73 696e 6365 2e6c  v = divs_since.l
-00028ba0: 6f63 5b64 745d 0a20 2020 2020 2020 2020  oc[dt].         
-00028bb0: 2020 2020 2020 2066 3120 3d20 7365 6c66         f1 = self
-00028bc0: 2e68 2e69 6e64 6578 203c 2064 740a 2020  .h.index < dt.  
-00028bd0: 2020 2020 2020 2020 2020 2020 2020 6632                f2
-00028be0: 203d 2073 656c 662e 685b 224c 6173 7444   = self.h["LastD
-00028bf0: 6976 4164 6a75 7374 4474 225d 203c 2064  ivAdjustDt"] < d
-00028c00: 6976 5b22 4665 7463 6844 6174 6522 5d0a  iv["FetchDate"].
-00028c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c20: 6620 3d20 6631 2026 2066 320a 2020 2020  f = f1 & f2.    
-00028c30: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00028c40: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
-00028c50: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-00028c60: 6d73 6720 3d20 6622 7b73 656c 662e 6973  msg = f"{self.is
-00028c70: 7472 7d3a 2041 7070 6c79 696e 6720 6469  tr}: Applying di
-00028c80: 7620 5b64 743d 7b64 742e 6461 7465 2829  v [dt={dt.date()
-00028c90: 7d20 7b64 6976 5b27 4469 7669 6465 6e64  } {div['Dividend
-00028ca0: 7327 5d7d 2061 646a 3d7b 6469 765b 2742  s']} adj={div['B
-00028cb0: 6163 6b20 4164 6a2e 275d 3a2e 3566 7d20  ack Adj.']:.5f} 
-00028cc0: 6665 7463 683d 7b64 6976 5b27 4665 7463  fetch={div['Fetc
-00028cd0: 6844 6174 6527 5d7d 5d22 0a20 2020 2020  hDate']}]".     
-00028ce0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00028cf0: 6e64 6963 6573 203d 206e 702e 7768 6572  ndices = np.wher
-00028d00: 6528 6629 5b30 5d0a 2020 2020 2020 2020  e(f)[0].        
-00028d10: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-00028d20: 6d73 6720 2b3d 2066 2220 6163 726f 7373  msg += f" across
-00028d30: 2069 6e74 6572 7661 6c73 2022 0a20 2020   intervals ".   
-00028d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d50: 2069 6620 7365 6c66 2e69 6e74 6572 6461   if self.interda
-00028d60: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00028d70: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
-00028d80: 7367 202b 3d20 6622 7b73 656c 662e 682e  sg += f"{self.h.
-00028d90: 696e 6465 785b 696e 6469 6365 735b 305d  index[indices[0]
-00028da0: 5d2e 6461 7465 2829 7d20 2d3e 207b 7365  ].date()} -> {se
-00028db0: 6c66 2e68 2e69 6e64 6578 5b69 6e64 6963  lf.h.index[indic
-00028dc0: 6573 5b2d 315d 5d2e 6461 7465 2829 7d20  es[-1]].date()} 
-00028dd0: 2869 6e63 2922 0a20 2020 2020 2020 2020  (inc)".         
-00028de0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00028df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028e00: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
-00028e10: 202b 3d20 6622 7b73 656c 662e 682e 696e   += f"{self.h.in
-00028e20: 6465 785b 696e 6469 6365 735b 305d 5d7d  dex[indices[0]]}
-00028e30: 202d 3e20 7b73 656c 662e 682e 696e 6465   -> {self.h.inde
-00028e40: 785b 696e 6469 6365 735b 2d31 5d5d 7d22  x[indices[-1]]}"
-00028e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028e60: 2020 2020 2068 5f6c 6173 7452 6f77 203d       h_lastRow =
-00028e70: 2073 656c 662e 682e 6c6f 635b 7365 6c66   self.h.loc[self
-00028e80: 2e68 2e69 6e64 6578 5b69 6e64 6963 6573  .h.index[indices
-00028e90: 5b2d 315d 5d5d 0a20 2020 2020 2020 2020  [-1]]].         
-00028ea0: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
-00028eb0: 7367 202b 3d20 6622 2e20 4c61 7374 2043  sg += f". Last C
-00028ec0: 4446 203d 207b 685f 6c61 7374 526f 775b  DF = {h_lastRow[
-00028ed0: 2743 4446 275d 3a2e 3566 7d20 4020 7b68  'CDF']:.5f} @ {h
-00028ee0: 5f6c 6173 7452 6f77 5b27 4c61 7374 4469  _lastRow['LastDi
-00028ef0: 7641 646a 7573 7444 7427 5d7d 220a 2020  vAdjustDt']}".  
+00022e40: 2020 6466 5f76 322e 6c6f 635b 6964 782c    df_v2.loc[idx,
+00022e50: 2022 4c6f 7722 5d20 3d20 6466 5f6e 6577   "Low"] = df_new
+00022e60: 5f72 6f77 5b22 4c6f 7722 5d0a 2020 2020  _row["Low"].    
+00022e70: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+00022e80: 4f70 656e 2220 696e 2062 6164 5f66 6965  Open" in bad_fie
+00022e90: 6c64 733a 0a20 2020 2020 2020 2020 2020  lds:.           
+00022ea0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00022eb0: 2e69 6e74 6572 7661 6c20 3d3d 2079 6663  .interval == yfc
+00022ec0: 642e 496e 7465 7276 616c 2e57 6565 6b20  d.Interval.Week 
+00022ed0: 616e 6420 6964 7820 213d 2064 665f 6669  and idx != df_fi
+00022ee0: 6e65 2e69 6e64 6578 5b30 5d3a 0a20 2020  ne.index[0]:.   
+00022ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f00: 2020 2020 2023 2045 7863 6861 6e67 6520       # Exchange 
+00022f10: 636c 6f73 6564 204d 6f6e 6461 792e 2049  closed Monday. I
+00022f20: 6e20 7468 6973 2063 6173 652c 2059 6168  n this case, Yah
+00022f30: 6f6f 2073 6574 7320 4f70 656e 2074 6f20  oo sets Open to 
+00022f40: 6c61 7374 2077 6565 6b20 636c 6f73 650a  last week close.
+00022f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f60: 2020 2020 2020 2020 6466 5f76 322e 6c6f          df_v2.lo
+00022f70: 635b 6964 782c 2022 4f70 656e 225d 203d  c[idx, "Open"] =
+00022f80: 2064 665f 6c61 7374 5f77 6565 6b5b 2243   df_last_week["C
+00022f90: 6c6f 7365 225d 0a20 2020 2020 2020 2020  lose"].         
+00022fa0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00022fb0: 665f 7632 2e6c 6f63 5b69 6478 2c20 224c  f_v2.loc[idx, "L
+00022fc0: 6f77 225d 203d 206d 696e 2864 665f 7632  ow"] = min(df_v2
+00022fd0: 2e6c 6f63 5b69 6478 2c20 224f 7065 6e22  .loc[idx, "Open"
+00022fe0: 5d2c 2064 665f 7632 2e6c 6f63 5b69 6478  ], df_v2.loc[idx
+00022ff0: 2c20 224c 6f77 225d 290a 2020 2020 2020  , "Low"]).      
+00023000: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00023010: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00023020: 2020 2020 2020 2020 2020 2020 6466 5f76              df_v
+00023030: 322e 6c6f 635b 6964 782c 2022 4f70 656e  2.loc[idx, "Open
+00023040: 225d 203d 2064 665f 6e65 775f 726f 775b  "] = df_new_row[
+00023050: 224f 7065 6e22 5d0a 2020 2020 2020 2020  "Open"].        
+00023060: 2020 2020 2020 2020 6966 2022 436c 6f73          if "Clos
+00023070: 6522 2069 6e20 6261 645f 6669 656c 6473  e" in bad_fields
+00023080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023090: 2020 2020 2020 6466 5f76 322e 6c6f 635b        df_v2.loc[
+000230a0: 6964 782c 2022 436c 6f73 6522 5d20 3d20  idx, "Close"] = 
+000230b0: 6466 5f6e 6577 5f72 6f77 5b22 436c 6f73  df_new_row["Clos
+000230c0: 6522 5d0a 2020 2020 2020 2020 2020 2020  e"].            
+000230d0: 2020 2020 2020 2020 2320 5368 6f75 6c64          # Should
+000230e0: 206e 6f74 206e 6565 6420 746f 2063 6f70   not need to cop
+000230f0: 7920 6f76 6572 2043 4446 2026 2043 5346  y over CDF & CSF
+00023100: 2c20 6265 6361 7573 650a 2020 2020 2020  , because.      
+00023110: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00023120: 636f 7272 6563 7420 7661 6c75 6573 2061  correct values a
+00023130: 7265 2061 6c72 6561 6479 206d 6572 6765  re already merge
+00023140: 6420 696e 2066 726f 6d20 6461 696c 790a  d in from daily.
+00023150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023160: 2020 2020 2320 6466 5f76 322e 6c6f 635b      # df_v2.loc[
+00023170: 6964 782c 2022 4344 4622 5d20 3d20 6466  idx, "CDF"] = df
+00023180: 5f6e 6577 5f72 6f77 5b22 4344 4622 5d0a  _new_row["CDF"].
+00023190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231a0: 2020 2020 2320 6466 5f76 322e 6c6f 635b      # df_v2.loc[
+000231b0: 6964 782c 2022 4353 4622 5d20 3d20 6466  idx, "CSF"] = df
+000231c0: 5f6e 6577 5f72 6f77 5b22 4353 4622 5d0a  _new_row["CSF"].
+000231d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231e0: 6966 2022 566f 6c75 6d65 2220 696e 2062  if "Volume" in b
+000231f0: 6164 5f66 6965 6c64 733a 0a20 2020 2020  ad_fields:.     
+00023200: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00023210: 665f 7632 2e6c 6f63 5b69 6478 2c20 2256  f_v2.loc[idx, "V
+00023220: 6f6c 756d 6522 5d20 3d20 6466 5f6e 6577  olume"] = df_new
+00023230: 5f72 6f77 5b22 566f 6c75 6d65 225d 0a20  _row["Volume"]. 
+00023240: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00023250: 665f 7632 2e6c 6f63 5b69 6478 2c20 2252  f_v2.loc[idx, "R
+00023260: 6570 6169 7265 643f 225d 203d 2054 7275  epaired?"] = Tru
+00023270: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00023280: 2020 6e5f 6669 7865 6420 2b3d 2031 0a0a    n_fixed += 1..
+00023290: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+000232a0: 7374 6f72 6520 756e 2d72 6570 6169 7265  store un-repaire
+000232b0: 6420 6261 6420 7661 6c75 6573 0a20 2020  d bad values.   
+000232c0: 2020 2020 2020 2020 2066 5f6e 616e 203d           f_nan =
+000232d0: 2064 665f 7632 5b70 7269 6365 5f63 6f6c   df_v2[price_col
+000232e0: 735d 2e69 736e 6128 292e 746f 5f6e 756d  s].isna().to_num
+000232f0: 7079 2829 0a20 2020 2020 2020 2020 2020  py().           
+00023300: 2066 5f66 6169 6c65 6420 3d20 665f 7461   f_failed = f_ta
+00023310: 6720 2620 665f 6e61 6e0a 2020 2020 2020  g & f_nan.      
+00023320: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
+00023330: 616e 6765 286c 656e 2870 7269 6365 5f63  ange(len(price_c
+00023340: 6f6c 7329 293a 0a20 2020 2020 2020 2020  ols)):.         
+00023350: 2020 2020 2020 2066 203d 2066 5f66 6169         f = f_fai
+00023360: 6c65 645b 3a2c 206a 5d0a 2020 2020 2020  led[:, j].      
+00023370: 2020 2020 2020 2020 2020 6966 2066 2e61            if f.a
+00023380: 6e79 2829 3a0a 2020 2020 2020 2020 2020  ny():.          
+00023390: 2020 2020 2020 2020 2020 6320 3d20 7072            c = pr
+000233a0: 6963 655f 636f 6c73 5b6a 5d0a 2020 2020  ice_cols[j].    
+000233b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233c0: 6466 5f76 322e 6c6f 635b 662c 2063 5d20  df_v2.loc[f, c] 
+000233d0: 3d20 6466 2e6c 6f63 5b66 2c20 635d 0a0a  = df.loc[f, c]..
+000233e0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000233f0: 656c 662e 5f72 6563 6f72 645f 7374 6163  elf._record_stac
+00023400: 6b5f 7472 6163 653a 0a20 2020 2020 2020  k_trace:.       
+00023410: 2020 2020 2020 2020 2023 2050 6f70 2073           # Pop s
+00023420: 7461 636b 2074 7261 6365 0a20 2020 2020  tack trace.     
+00023430: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00023440: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
+00023450: 6163 6529 203d 3d20 303a 0a20 2020 2020  ace) == 0:.     
+00023460: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00023470: 6169 7365 2045 7863 6570 7469 6f6e 2822  aise Exception("
+00023480: 4661 696c 696e 6720 746f 2063 6f72 7265  Failing to corre
+00023490: 6374 6c79 2070 7573 682f 706f 7020 7374  ctly push/pop st
+000234a0: 6163 6b20 7472 6163 6520 2869 7320 656d  ack trace (is em
+000234b0: 7074 7920 746f 6f20 6561 726c 7929 2229  pty too early)")
+000234c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000234d0: 2069 6620 6e6f 7420 7365 6c66 2e5f 7374   if not self._st
+000234e0: 6163 6b5f 7472 6163 655b 2d31 5d20 3d3d  ack_trace[-1] ==
+000234f0: 2066 6e5f 7475 706c 653a 0a20 2020 2020   fn_tuple:.     
+00023500: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00023510: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00023520: 6e28 7365 6c66 2e5f 7374 6163 6b5f 7472  n(self._stack_tr
+00023530: 6163 6529 293a 0a20 2020 2020 2020 2020  ace)):.         
+00023540: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00023550: 7269 6e74 2822 2020 222a 6920 2b20 7374  rint("  "*i + st
+00023560: 7228 7365 6c66 2e5f 7374 6163 6b5f 7472  r(self._stack_tr
+00023570: 6163 655b 695d 2929 0a20 2020 2020 2020  ace[i])).       
+00023580: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00023590: 7365 2045 7863 6570 7469 6f6e 2822 4661  se Exception("Fa
+000235a0: 696c 696e 6720 746f 2063 6f72 7265 6374  iling to correct
+000235b0: 6c79 2070 7573 682f 706f 7020 7374 6163  ly push/pop stac
+000235c0: 6b20 7472 6163 6520 2873 6565 2061 626f  k trace (see abo
+000235d0: 7665 2922 290a 2020 2020 2020 2020 2020  ve)").          
+000235e0: 2020 2020 2020 7365 6c66 2e5f 7374 6163        self._stac
+000235f0: 6b5f 7472 6163 652e 706f 7028 6c65 6e28  k_trace.pop(len(
+00023600: 7365 6c66 2e5f 7374 6163 6b5f 7472 6163  self._stack_trac
+00023610: 6529 202d 2031 290a 0a20 2020 2020 2020  e) - 1)..       
+00023620: 206c 6f67 5f6d 7367 203d 2022 504d 3a3a   log_msg = "PM::
+00023630: 5f72 6563 6f6e 7374 7275 6374 5f69 6e74  _reconstruct_int
+00023640: 6572 7661 6c73 5f62 6174 6368 2829 2072  ervals_batch() r
+00023650: 6574 7572 6e69 6e67 220a 2020 2020 2020  eturning".      
+00023660: 2020 7966 636c 2e54 7261 6365 4578 6974    yfcl.TraceExit
+00023670: 286c 6f67 5f6d 7367 290a 0a20 2020 2020  (log_msg)..     
+00023680: 2020 2072 6574 7572 6e20 6466 5f76 320a     return df_v2.
+00023690: 0a20 2020 2064 6566 205f 7265 7061 6972  .    def _repair
+000236a0: 556e 6974 4d69 7875 7073 2873 656c 662c  UnitMixups(self,
+000236b0: 2064 662c 2073 696c 656e 743d 4661 6c73   df, silent=Fals
+000236c0: 6529 3a0a 2020 2020 2020 2020 7966 6375  e):.        yfcu
+000236d0: 2e54 7970 6543 6865 636b 4461 7461 4672  .TypeCheckDataFr
+000236e0: 616d 6528 6466 2c20 2264 6622 290a 0a20  ame(df, "df").. 
+000236f0: 2020 2020 2020 2023 2053 6f6d 6574 696d         # Sometim
+00023700: 6573 2059 6168 6f6f 2072 6574 7572 6e73  es Yahoo returns
+00023710: 2066 6577 2070 7269 6365 7320 696e 2063   few prices in c
+00023720: 656e 7473 2f70 656e 6365 2069 6e73 7465  ents/pence inste
+00023730: 6164 206f 6620 242f c2a3 0a20 2020 2020  ad of $/...     
+00023740: 2020 2023 2049 2e65 2e20 3130 3078 2062     # I.e. 100x b
+00023750: 6967 6765 720a 2020 2020 2020 2020 2320  igger.        # 
+00023760: 4561 7379 2074 6f20 6465 7465 6374 2061  Easy to detect a
+00023770: 6e64 2066 6978 2c20 6a75 7374 206c 6f6f  nd fix, just loo
+00023780: 6b20 666f 7220 6f75 746c 6965 7273 203d  k for outliers =
+00023790: 207e 3130 3078 206c 6f63 616c 206d 6564   ~100x local med
+000237a0: 6961 6e0a 0a20 2020 2020 2020 2069 6620  ian..        if 
+000237b0: 6466 2e65 6d70 7479 3a0a 2020 2020 2020  df.empty:.      
+000237c0: 2020 2020 2020 7265 7475 726e 2064 660a        return df.
+000237d0: 2020 2020 2020 2020 6966 2064 662e 7368          if df.sh
+000237e0: 6170 655b 305d 203d 3d20 313a 0a20 2020  ape[0] == 1:.   
+000237f0: 2020 2020 2020 2020 2023 204e 6565 6420           # Need 
+00023800: 6d75 6c74 6970 6c65 2072 6f77 7320 746f  multiple rows to
+00023810: 2063 6f6e 6669 6465 6e74 6c79 2069 6465   confidently ide
+00023820: 6e74 6966 7920 6f75 746c 6965 7273 0a20  ntify outliers. 
+00023830: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00023840: 6e20 6466 0a0a 2020 2020 2020 2020 6c6f  n df..        lo
+00023850: 675f 6d73 675f 656e 7465 7220 3d20 6622  g_msg_enter = f"
+00023860: 504d 3a3a 5f72 6570 6169 7255 6e69 744d  PM::_repairUnitM
+00023870: 6978 7570 732d 7b73 656c 662e 6973 7472  ixups-{self.istr
+00023880: 7d28 2922 0a20 2020 2020 2020 206c 6f67  }()".        log
+00023890: 5f6d 7367 5f65 7869 7420 3d20 6622 504d  _msg_exit = f"PM
+000238a0: 3a3a 5f72 6570 6169 7255 6e69 744d 6978  ::_repairUnitMix
+000238b0: 7570 732d 7b73 656c 662e 6973 7472 7d28  ups-{self.istr}(
+000238c0: 2920 7265 7475 726e 696e 6722 0a20 2020  ) returning".   
+000238d0: 2020 2020 2079 6663 6c2e 5472 6163 6545       yfcl.TraceE
+000238e0: 6e74 6572 286c 6f67 5f6d 7367 5f65 6e74  nter(log_msg_ent
+000238f0: 6572 290a 0a20 2020 2020 2020 2064 6632  er)..        df2
+00023900: 203d 2064 662e 636f 7079 2829 0a0a 2020   = df.copy()..  
+00023910: 2020 2020 2020 6461 7461 5f63 6f6c 7320        data_cols 
+00023920: 3d20 5b22 4869 6768 222c 2022 4f70 656e  = ["High", "Open
+00023930: 222c 2022 4c6f 7722 2c20 2243 6c6f 7365  ", "Low", "Close
+00023940: 225d 2020 2320 4f72 6465 7220 696d 706f  "]  # Order impo
+00023950: 7274 616e 742c 2073 6570 6172 6174 6520  rtant, separate 
+00023960: 4869 6768 2066 726f 6d20 4c6f 770a 2020  High from Low.  
+00023970: 2020 2020 2020 6461 7461 5f63 6f6c 7320        data_cols 
+00023980: 3d20 5b63 2066 6f72 2063 2069 6e20 6461  = [c for c in da
+00023990: 7461 5f63 6f6c 7320 6966 2063 2069 6e20  ta_cols if c in 
+000239a0: 6466 322e 636f 6c75 6d6e 735d 0a20 2020  df2.columns].   
+000239b0: 2020 2020 2066 5f7a 6572 6f65 7320 3d20       f_zeroes = 
+000239c0: 2864 6632 5b64 6174 615f 636f 6c73 5d20  (df2[data_cols] 
+000239d0: 3d3d 2030 292e 616e 7928 6178 6973 3d31  == 0).any(axis=1
+000239e0: 290a 2020 2020 2020 2020 6966 2066 5f7a  ).        if f_z
+000239f0: 6572 6f65 732e 616e 7928 293a 0a20 2020  eroes.any():.   
+00023a00: 2020 2020 2020 2020 2064 6632 5f7a 6572           df2_zer
+00023a10: 6f65 7320 3d20 6466 325b 665f 7a65 726f  oes = df2[f_zero
+00023a20: 6573 5d0a 2020 2020 2020 2020 2020 2020  es].            
+00023a30: 6466 3220 3d20 6466 325b 7e66 5f7a 6572  df2 = df2[~f_zer
+00023a40: 6f65 735d 0a20 2020 2020 2020 2065 6c73  oes].        els
+00023a50: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00023a60: 6632 5f7a 6572 6f65 7320 3d20 4e6f 6e65  f2_zeroes = None
+00023a70: 0a20 2020 2020 2020 2069 6620 6466 322e  .        if df2.
+00023a80: 7368 6170 655b 305d 203c 3d20 313a 0a20  shape[0] <= 1:. 
+00023a90: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+00023aa0: 5472 6163 6545 7869 7428 6c6f 675f 6d73  TraceExit(log_ms
+00023ab0: 675f 6578 6974 290a 2020 2020 2020 2020  g_exit).        
+00023ac0: 2020 2020 7265 7475 726e 2064 660a 2020      return df.  
+00023ad0: 2020 2020 2020 6d65 6469 616e 203d 205f        median = _
+00023ae0: 6e64 696d 6167 652e 6d65 6469 616e 5f66  ndimage.median_f
+00023af0: 696c 7465 7228 6466 325b 6461 7461 5f63  ilter(df2[data_c
+00023b00: 6f6c 735d 2e74 6f5f 6e75 6d70 7928 292c  ols].to_numpy(),
+00023b10: 2073 697a 653d 2833 2c20 3329 2c20 6d6f   size=(3, 3), mo
+00023b20: 6465 3d22 7772 6170 2229 0a0a 2020 2020  de="wrap")..    
+00023b30: 2020 2020 6966 2028 6d65 6469 616e 203d      if (median =
+00023b40: 3d20 3029 2e61 6e79 2829 3a0a 2020 2020  = 0).any():.    
+00023b50: 2020 2020 2020 2020 7072 696e 7428 2254          print("T
+00023b60: 6963 6b65 7220 3d22 2c20 7365 6c66 2e74  icker =", self.t
+00023b70: 6963 6b65 7229 0a20 2020 2020 2020 2020  icker).         
+00023b80: 2020 2070 7269 6e74 2822 7966 203d 222c     print("yf =",
+00023b90: 2079 6629 0a20 2020 2020 2020 2020 2020   yf).           
+00023ba0: 2070 7269 6e74 2822 6466 3a22 290a 2020   print("df:").  
+00023bb0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00023bc0: 6466 290a 2020 2020 2020 2020 2020 2020  df).            
+00023bd0: 7261 6973 6520 4578 6365 7074 696f 6e28  raise Exception(
+00023be0: 226d 6564 6961 6e20 636f 6e74 6169 6e73  "median contains
+00023bf0: 207a 6572 6f65 732c 2077 6879 3f22 290a   zeroes, why?").
+00023c00: 2020 2020 2020 2020 7261 7469 6f20 3d20          ratio = 
+00023c10: 6466 325b 6461 7461 5f63 6f6c 735d 2e74  df2[data_cols].t
+00023c20: 6f5f 6e75 6d70 7928 2920 2f20 6d65 6469  o_numpy() / medi
+00023c30: 616e 0a20 2020 2020 2020 2072 6174 696f  an.        ratio
+00023c40: 5f72 6f75 6e64 6564 203d 2028 7261 7469  _rounded = (rati
+00023c50: 6f20 2f20 3230 292e 726f 756e 6428 2920  o / 20).round() 
+00023c60: 2a20 3230 2020 2320 726f 756e 6420 7261  * 20  # round ra
+00023c70: 7469 6f20 746f 206e 6561 7265 7374 2032  tio to nearest 2
+00023c80: 300a 2020 2020 2020 2020 6620 3d20 7261  0.        f = ra
+00023c90: 7469 6f5f 726f 756e 6465 6420 3d3d 2031  tio_rounded == 1
+00023ca0: 3030 0a20 2020 2020 2020 2069 6620 6e6f  00.        if no
+00023cb0: 7420 662e 616e 7928 293a 0a20 2020 2020  t f.any():.     
+00023cc0: 2020 2020 2020 2079 6663 6c2e 5472 6163         yfcl.Trac
+00023cd0: 6545 7869 7428 6c6f 675f 6d73 675f 6578  eExit(log_msg_ex
+00023ce0: 6974 290a 2020 2020 2020 2020 2020 2020  it).            
+00023cf0: 7265 7475 726e 2064 660a 0a20 2020 2020  return df..     
+00023d00: 2020 2023 204d 6172 6b20 7661 6c75 6573     # Mark values
+00023d10: 2074 6f20 7365 6e64 2066 6f72 2072 6570   to send for rep
+00023d20: 6169 720a 2020 2020 2020 2020 7461 6720  air.        tag 
+00023d30: 3d20 2d31 2e30 0a20 2020 2020 2020 2066  = -1.0.        f
+00023d40: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00023d50: 6e28 6461 7461 5f63 6f6c 7329 293a 0a20  n(data_cols)):. 
+00023d60: 2020 2020 2020 2020 2020 2066 6920 3d20             fi = 
+00023d70: 665b 3a2c 2069 5d0a 2020 2020 2020 2020  f[:, i].        
+00023d80: 2020 2020 6320 3d20 6461 7461 5f63 6f6c      c = data_col
+00023d90: 735b 695d 0a20 2020 2020 2020 2020 2020  s[i].           
+00023da0: 2064 6632 2e6c 6f63 5b66 692c 2063 5d20   df2.loc[fi, c] 
+00023db0: 3d20 7461 670a 0a20 2020 2020 2020 206e  = tag..        n
+00023dc0: 5f62 6566 6f72 6520 3d20 2864 6632 5b64  _before = (df2[d
+00023dd0: 6174 615f 636f 6c73 5d2e 746f 5f6e 756d  ata_cols].to_num
+00023de0: 7079 2829 203d 3d20 7461 6729 2e73 756d  py() == tag).sum
+00023df0: 2829 0a20 2020 2020 2020 2074 7279 3a0a  ().        try:.
+00023e00: 2020 2020 2020 2020 2020 2020 6466 3220              df2 
+00023e10: 3d20 7365 6c66 2e5f 7265 636f 6e73 7472  = self._reconstr
+00023e20: 7563 745f 696e 7465 7276 616c 735f 6261  uct_intervals_ba
+00023e30: 7463 6828 6466 322c 2074 6167 3d74 6167  tch(df2, tag=tag
+00023e40: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00023e50: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00023e60: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+00023e70: 656c 662e 5f73 7461 636b 5f74 7261 6365  elf._stack_trace
+00023e80: 2920 3e20 303a 0a20 2020 2020 2020 2020  ) > 0:.         
+00023e90: 2020 2020 2020 2073 656c 662e 5f73 7461         self._sta
+00023ea0: 636b 5f74 7261 6365 2e70 6f70 286c 656e  ck_trace.pop(len
+00023eb0: 2873 656c 662e 5f73 7461 636b 5f74 7261  (self._stack_tra
+00023ec0: 6365 2920 2d20 3129 0a20 2020 2020 2020  ce) - 1).       
+00023ed0: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+00023ee0: 2020 206e 5f61 6674 6572 203d 2028 6466     n_after = (df
+00023ef0: 325b 6461 7461 5f63 6f6c 735d 2e74 6f5f  2[data_cols].to_
+00023f00: 6e75 6d70 7928 2920 3d3d 2074 6167 292e  numpy() == tag).
+00023f10: 7375 6d28 290a 0a20 2020 2020 2020 2069  sum()..        i
+00023f20: 6620 6e5f 6166 7465 7220 3e20 303a 0a20  f n_after > 0:. 
+00023f30: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+00023f40: 7320 7365 636f 6e64 2070 6173 7320 7769  s second pass wi
+00023f50: 6c6c 202a 6372 7564 656c 792a 2022 6669  ll *crudely* "fi
+00023f60: 7822 2061 6e79 2072 656d 6169 6e69 6e67  x" any remaining
+00023f70: 2065 7272 6f72 7320 696e 2048 6967 682f   errors in High/
+00023f80: 4c6f 770a 2020 2020 2020 2020 2020 2020  Low.            
+00023f90: 2320 7369 6d70 6c79 2062 7920 656e 7375  # simply by ensu
+00023fa0: 7269 6e67 2074 6865 7920 646f 6e27 7420  ring they don't 
+00023fb0: 636f 6e74 7261 6469 6374 2065 2e67 2e20  contradict e.g. 
+00023fc0: 4c6f 7720 3d20 3130 3078 2048 6967 682e  Low = 100x High.
+00023fd0: 0a20 2020 2020 2020 2020 2020 2066 203d  .            f =
+00023fe0: 2064 6632 5b64 6174 615f 636f 6c73 5d2e   df2[data_cols].
+00023ff0: 746f 5f6e 756d 7079 2829 203d 3d20 7461  to_numpy() == ta
+00024000: 670a 2020 2020 2020 2020 2020 2020 666f  g.            fo
+00024010: 7220 6920 696e 2072 616e 6765 2866 2e73  r i in range(f.s
+00024020: 6861 7065 5b30 5d29 3a0a 2020 2020 2020  hape[0]):.      
+00024030: 2020 2020 2020 2020 2020 6669 203d 2066            fi = f
+00024040: 5b69 2c20 3a5d 0a20 2020 2020 2020 2020  [i, :].         
+00024050: 2020 2020 2020 2069 6620 6e6f 7420 6669         if not fi
+00024060: 2e61 6e79 2829 3a0a 2020 2020 2020 2020  .any():.        
+00024070: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00024080: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00024090: 2020 2020 2069 6478 203d 2064 6632 2e69       idx = df2.i
+000240a0: 6e64 6578 5b69 5d0a 0a20 2020 2020 2020  ndex[i]..       
+000240b0: 2020 2020 2020 2020 2063 203d 2022 4f70           c = "Op
+000240c0: 656e 220a 2020 2020 2020 2020 2020 2020  en".            
+000240d0: 2020 2020 6a20 3d20 6461 7461 5f63 6f6c      j = data_col
+000240e0: 732e 696e 6465 7828 6329 0a20 2020 2020  s.index(c).     
+000240f0: 2020 2020 2020 2020 2020 2069 6620 6669             if fi
+00024100: 5b6a 5d3a 0a20 2020 2020 2020 2020 2020  [j]:.           
+00024110: 2020 2020 2020 2020 2064 6632 2e6c 6f63           df2.loc
+00024120: 5b69 6478 2c20 635d 203d 2064 662e 6c6f  [idx, c] = df.lo
+00024130: 635b 6964 782c 2063 5d20 2a20 302e 3031  c[idx, c] * 0.01
+00024140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024150: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
+00024160: 2020 2063 203d 2022 436c 6f73 6522 0a20     c = "Close". 
+00024170: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00024180: 203d 2064 6174 615f 636f 6c73 2e69 6e64   = data_cols.ind
+00024190: 6578 2863 290a 2020 2020 2020 2020 2020  ex(c).          
+000241a0: 2020 2020 2020 6966 2066 695b 6a5d 3a0a        if fi[j]:.
+000241b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241c0: 2020 2020 6466 322e 6c6f 635b 6964 782c      df2.loc[idx,
+000241d0: 2063 5d20 3d20 6466 2e6c 6f63 5b69 6478   c] = df.loc[idx
+000241e0: 2c20 635d 202a 2030 2e30 310a 2020 2020  , c] * 0.01.    
+000241f0: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
+00024200: 2020 2020 2020 2020 2020 2020 2020 6320                c 
+00024210: 3d20 2248 6967 6822 0a20 2020 2020 2020  = "High".       
+00024220: 2020 2020 2020 2020 206a 203d 2064 6174           j = dat
+00024230: 615f 636f 6c73 2e69 6e64 6578 2863 290a  a_cols.index(c).
+00024240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024250: 6966 2066 695b 6a5d 3a0a 2020 2020 2020  if fi[j]:.      
+00024260: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00024270: 322e 6c6f 635b 6964 782c 2063 5d20 3d20  2.loc[idx, c] = 
+00024280: 6466 322e 6c6f 635b 6964 782c 205b 224f  df2.loc[idx, ["O
+00024290: 7065 6e22 2c20 2243 6c6f 7365 225d 5d2e  pen", "Close"]].
+000242a0: 6d61 7828 290a 2020 2020 2020 2020 2020  max().          
+000242b0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+000242c0: 2020 2020 2020 2020 6320 3d20 224c 6f77          c = "Low
+000242d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000242e0: 2020 6a20 3d20 6461 7461 5f63 6f6c 732e    j = data_cols.
+000242f0: 696e 6465 7828 6329 0a20 2020 2020 2020  index(c).       
+00024300: 2020 2020 2020 2020 2069 6620 6669 5b6a           if fi[j
+00024310: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00024320: 2020 2020 2020 2064 6632 2e6c 6f63 5b69         df2.loc[i
+00024330: 6478 2c20 635d 203d 2064 6632 2e6c 6f63  dx, c] = df2.loc
+00024340: 5b69 6478 2c20 5b22 4f70 656e 222c 2022  [idx, ["Open", "
+00024350: 436c 6f73 6522 5d5d 2e6d 696e 2829 0a0a  Close"]].min()..
+00024360: 2020 2020 2020 2020 6e5f 6166 7465 725f          n_after_
+00024370: 6372 7564 6520 3d20 2864 6632 5b64 6174  crude = (df2[dat
+00024380: 615f 636f 6c73 5d2e 746f 5f6e 756d 7079  a_cols].to_numpy
+00024390: 2829 203d 3d20 7461 6729 2e73 756d 2829  () == tag).sum()
+000243a0: 0a0a 2020 2020 2020 2020 6e5f 6669 7865  ..        n_fixe
+000243b0: 6420 3d20 6e5f 6265 666f 7265 202d 206e  d = n_before - n
+000243c0: 5f61 6674 6572 5f63 7275 6465 0a20 2020  _after_crude.   
+000243d0: 2020 2020 206e 5f66 6978 6564 5f63 7275       n_fixed_cru
+000243e0: 6465 6c79 203d 206e 5f61 6674 6572 202d  dely = n_after -
+000243f0: 206e 5f61 6674 6572 5f63 7275 6465 0a20   n_after_crude. 
+00024400: 2020 2020 2020 2069 6620 6e6f 7420 7369         if not si
+00024410: 6c65 6e74 2061 6e64 206e 5f66 6978 6564  lent and n_fixed
+00024420: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00024430: 2020 7265 706f 7274 5f6d 7367 203d 2066    report_msg = f
+00024440: 227b 7365 6c66 2e74 6963 6b65 727d 3a20  "{self.ticker}: 
+00024450: 6669 7865 6420 7b6e 5f66 6978 6564 7d2f  fixed {n_fixed}/
+00024460: 7b6e 5f62 6566 6f72 657d 2063 7572 7265  {n_before} curre
+00024470: 6e63 7920 756e 6974 206d 6978 7570 7320  ncy unit mixups 
+00024480: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
+00024490: 206e 5f66 6978 6564 5f63 7275 6465 6c79   n_fixed_crudely
+000244a0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+000244b0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+000244c0: 202b 3d20 6622 287b 6e5f 6669 7865 645f   += f"({n_fixed_
+000244d0: 6372 7564 656c 797d 2063 7275 6465 6c79  crudely} crudely
+000244e0: 2920 220a 2020 2020 2020 2020 2020 2020  ) ".            
+000244f0: 7265 706f 7274 5f6d 7367 202b 3d20 6622  report_msg += f"
+00024500: 696e 207b 7365 6c66 2e69 6e74 6572 7661  in {self.interva
+00024510: 6c7d 2070 7269 6365 2064 6174 6122 0a20  l} price data". 
+00024520: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00024530: 2872 6570 6f72 745f 6d73 6729 0a0a 2020  (report_msg)..  
+00024540: 2020 2020 2020 2320 5265 7374 6f72 6520        # Restore 
+00024550: 6f72 6967 696e 616c 2076 616c 7565 7320  original values 
+00024560: 7768 6572 6520 7265 7061 6972 2066 6169  where repair fai
+00024570: 6c65 640a 2020 2020 2020 2020 6620 3d20  led.        f = 
+00024580: 6466 325b 6461 7461 5f63 6f6c 735d 2e74  df2[data_cols].t
+00024590: 6f5f 6e75 6d70 7928 2920 3d3d 2074 6167  o_numpy() == tag
+000245a0: 0a20 2020 2020 2020 2066 6f72 206a 2069  .        for j i
+000245b0: 6e20 7261 6e67 6528 6c65 6e28 6461 7461  n range(len(data
+000245c0: 5f63 6f6c 7329 293a 0a20 2020 2020 2020  _cols)):.       
+000245d0: 2020 2020 2066 6a20 3d20 665b 3a2c 206a       fj = f[:, j
+000245e0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+000245f0: 2066 6a2e 616e 7928 293a 0a20 2020 2020   fj.any():.     
+00024600: 2020 2020 2020 2020 2020 2063 203d 2064             c = d
+00024610: 6174 615f 636f 6c73 5b6a 5d0a 2020 2020  ata_cols[j].    
+00024620: 2020 2020 2020 2020 2020 2020 6466 322e              df2.
+00024630: 6c6f 635b 666a 2c20 635d 203d 2064 662e  loc[fj, c] = df.
+00024640: 6c6f 635b 666a 2c20 635d 0a20 2020 2020  loc[fj, c].     
+00024650: 2020 2069 6620 6466 325f 7a65 726f 6573     if df2_zeroes
+00024660: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00024670: 2020 2020 2020 2020 2020 6466 3220 3d20            df2 = 
+00024680: 7064 2e63 6f6e 6361 7428 5b64 6632 2c20  pd.concat([df2, 
+00024690: 6466 325f 7a65 726f 6573 5d29 2e73 6f72  df2_zeroes]).sor
+000246a0: 745f 696e 6465 7828 290a 2020 2020 2020  t_index().      
+000246b0: 2020 2020 2020 6466 322e 696e 6465 7820        df2.index 
+000246c0: 3d20 7064 2e74 6f5f 6461 7465 7469 6d65  = pd.to_datetime
+000246d0: 2829 0a0a 2020 2020 2020 2020 7966 636c  ()..        yfcl
+000246e0: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+000246f0: 7367 5f65 7869 7429 0a0a 2020 2020 2020  sg_exit)..      
+00024700: 2020 7265 7475 726e 2064 6632 0a0a 2020    return df2..  
+00024710: 2020 6465 6620 5f72 6570 6169 725a 6572    def _repairZer
+00024720: 6f50 7269 6365 7328 7365 6c66 2c20 6466  oPrices(self, df
+00024730: 2c20 7369 6c65 6e74 3d46 616c 7365 293a  , silent=False):
+00024740: 0a20 2020 2020 2020 2079 6663 752e 5479  .        yfcu.Ty
+00024750: 7065 4368 6563 6b44 6174 6146 7261 6d65  peCheckDataFrame
+00024760: 2864 662c 2022 6466 2229 0a0a 2020 2020  (df, "df")..    
+00024770: 2020 2020 2320 536f 6d65 7469 6d65 7320      # Sometimes 
+00024780: 5961 686f 6f20 7265 7475 726e 7320 7072  Yahoo returns pr
+00024790: 6963 6573 3d30 2077 6865 6e20 6f62 7669  ices=0 when obvi
+000247a0: 6f75 736c 7920 7772 6f6e 6720 652e 672e  ously wrong e.g.
+000247b0: 2056 6f6c 756d 6520 3e20 3020 616e 6420   Volume > 0 and 
+000247c0: 436c 6f73 6520 3e20 302e 0a20 2020 2020  Close > 0..     
+000247d0: 2020 2023 2045 6173 7920 746f 2064 6574     # Easy to det
+000247e0: 6563 7420 616e 6420 6669 780a 0a20 2020  ect and fix..   
+000247f0: 2020 2020 2069 6620 6466 2e65 6d70 7479       if df.empty
+00024800: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00024810: 7475 726e 2064 660a 2020 2020 2020 2020  turn df.        
+00024820: 6966 2064 662e 7368 6170 655b 305d 203d  if df.shape[0] =
+00024830: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00024840: 2023 204e 6565 6420 6d75 6c74 6970 6c65   # Need multiple
+00024850: 2072 6f77 7320 746f 2063 6f6e 6669 6465   rows to confide
+00024860: 6e74 6c79 2069 6465 6e74 6966 7920 6f75  ntly identify ou
+00024870: 746c 6965 7273 0a20 2020 2020 2020 2020  tliers.         
+00024880: 2020 2072 6574 7572 6e20 6466 0a0a 2020     return df..  
+00024890: 2020 2020 2020 6c6f 675f 6d73 675f 656e        log_msg_en
+000248a0: 7465 7220 3d20 6622 504d 3a3a 5f72 6570  ter = f"PM::_rep
+000248b0: 6169 725a 6572 6f50 7269 6365 732d 7b73  airZeroPrices-{s
+000248c0: 656c 662e 6973 7472 7d28 6461 7465 5f72  elf.istr}(date_r
+000248d0: 616e 6765 3d7b 6466 2e69 6e64 6578 5b30  ange={df.index[0
+000248e0: 5d7d 2d3e 7b64 662e 696e 6465 785b 2d31  ]}->{df.index[-1
+000248f0: 5d2b 7365 6c66 2e69 7464 7d29 220a 2020  ]+self.itd})".  
+00024900: 2020 2020 2020 6c6f 675f 6d73 675f 6578        log_msg_ex
+00024910: 6974 203d 2066 2250 4d3a 3a5f 7265 7061  it = f"PM::_repa
+00024920: 6972 5a65 726f 5072 6963 6573 2d7b 7365  irZeroPrices-{se
+00024930: 6c66 2e69 7374 727d 2829 2072 6574 7572  lf.istr}() retur
+00024940: 6e69 6e67 220a 2020 2020 2020 2020 7966  ning".        yf
+00024950: 636c 2e54 7261 6365 456e 7465 7228 6c6f  cl.TraceEnter(lo
+00024960: 675f 6d73 675f 656e 7465 7229 0a0a 2020  g_msg_enter)..  
+00024970: 2020 2020 2020 6466 3220 3d20 6466 2e63        df2 = df.c
+00024980: 6f70 7928 290a 0a20 2020 2020 2020 2070  opy()..        p
+00024990: 7269 6365 5f63 6f6c 7320 3d20 5b63 2066  rice_cols = [c f
+000249a0: 6f72 2063 2069 6e20 5b22 4f70 656e 222c  or c in ["Open",
+000249b0: 2022 4869 6768 222c 2022 4c6f 7722 2c20   "High", "Low", 
+000249c0: 2243 6c6f 7365 222c 2022 4164 6a20 436c  "Close", "Adj Cl
+000249d0: 6f73 6522 5d20 6966 2063 2069 6e20 6466  ose"] if c in df
+000249e0: 322e 636f 6c75 6d6e 735d 0a20 2020 2020  2.columns].     
+000249f0: 2020 2066 5f7a 6572 6f5f 6f72 5f6e 616e     f_zero_or_nan
+00024a00: 203d 2028 6466 325b 7072 6963 655f 636f   = (df2[price_co
+00024a10: 6c73 5d20 3d3d 2030 2e30 292e 746f 5f6e  ls] == 0.0).to_n
+00024a20: 756d 7079 2829 207c 2064 6632 5b70 7269  umpy() | df2[pri
+00024a30: 6365 5f63 6f6c 735d 2e69 736e 6128 292e  ce_cols].isna().
+00024a40: 746f 5f6e 756d 7079 2829 0a20 2020 2020  to_numpy().     
+00024a50: 2020 2023 2043 6865 636b 2077 6865 7468     # Check wheth
+00024a60: 6572 2077 6f72 7468 2061 7474 656d 7074  er worth attempt
+00024a70: 696e 6720 7265 7061 6972 0a20 2020 2020  ing repair.     
+00024a80: 2020 2069 6620 665f 7a65 726f 5f6f 725f     if f_zero_or_
+00024a90: 6e61 6e2e 616e 7928 6178 6973 3d31 292e  nan.any(axis=1).
+00024aa0: 7375 6d28 2920 3d3d 2030 3a0a 2020 2020  sum() == 0:.    
+00024ab0: 2020 2020 2020 2020 7966 636c 2e54 7261          yfcl.Tra
+00024ac0: 6365 4578 6974 286c 6f67 5f6d 7367 5f65  ceExit(log_msg_e
+00024ad0: 7869 7429 0a20 2020 2020 2020 2020 2020  xit).           
+00024ae0: 2072 6574 7572 6e20 6466 0a20 2020 2020   return df.     
+00024af0: 2020 2069 6620 665f 7a65 726f 5f6f 725f     if f_zero_or_
+00024b00: 6e61 6e2e 7375 6d28 2920 3d3d 206c 656e  nan.sum() == len
+00024b10: 2870 7269 6365 5f63 6f6c 7329 2a6c 656e  (price_cols)*len
+00024b20: 2864 6632 293a 0a20 2020 2020 2020 2020  (df2):.         
+00024b30: 2020 2023 204e 6565 6420 736f 6d65 2067     # Need some g
+00024b40: 6f6f 6420 6461 7461 2074 6f20 6361 6c69  ood data to cali
+00024b50: 6272 6174 650a 2020 2020 2020 2020 2020  brate.          
+00024b60: 2020 7966 636c 2e54 7261 6365 4578 6974    yfcl.TraceExit
+00024b70: 286c 6f67 5f6d 7367 5f65 7869 7429 0a20  (log_msg_exit). 
+00024b80: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00024b90: 6e20 6466 0a20 2020 2020 2020 2023 202d  n df.        # -
+00024ba0: 2061 766f 6964 2072 6570 6169 7220 6966   avoid repair if
+00024bb0: 206d 616e 7920 7a65 726f 6573 2f4e 614e   many zeroes/NaN
+00024bc0: 730a 2020 2020 2020 2020 7063 745f 7a65  s.        pct_ze
+00024bd0: 726f 5f6f 725f 6e61 6e20 3d20 665f 7a65  ro_or_nan = f_ze
+00024be0: 726f 5f6f 725f 6e61 6e2e 7375 6d28 2920  ro_or_nan.sum() 
+00024bf0: 2f20 286c 656e 2870 7269 6365 5f63 6f6c  / (len(price_col
+00024c00: 7329 2a6c 656e 2864 6632 2929 0a20 2020  s)*len(df2)).   
+00024c10: 2020 2020 2069 6620 665f 7a65 726f 5f6f       if f_zero_o
+00024c20: 725f 6e61 6e2e 616e 7928 6178 6973 3d31  r_nan.any(axis=1
+00024c30: 292e 7375 6d28 2920 3e20 3220 616e 6420  ).sum() > 2 and 
+00024c40: 7063 745f 7a65 726f 5f6f 725f 6e61 6e20  pct_zero_or_nan 
+00024c50: 3e20 302e 3035 3a0a 2020 2020 2020 2020  > 0.05:.        
+00024c60: 2020 2020 7966 636c 2e54 7261 6365 4578      yfcl.TraceEx
+00024c70: 6974 286c 6f67 5f6d 7367 5f65 7869 7429  it(log_msg_exit)
+00024c80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00024c90: 7572 6e20 6466 0a0a 2020 2020 2020 2020  urn df..        
+00024ca0: 6461 7461 5f63 6f6c 7320 3d20 7072 6963  data_cols = pric
+00024cb0: 655f 636f 6c73 202b 205b 2256 6f6c 756d  e_cols + ["Volum
+00024cc0: 6522 5d0a 0a20 2020 2020 2020 2023 204d  e"]..        # M
+00024cd0: 6172 6b20 7661 6c75 6573 2074 6f20 7365  ark values to se
+00024ce0: 6e64 2066 6f72 2072 6570 6169 720a 2020  nd for repair.  
+00024cf0: 2020 2020 2020 7461 6720 3d20 2d31 2e30        tag = -1.0
+00024d00: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+00024d10: 6e20 7261 6e67 6528 6c65 6e28 7072 6963  n range(len(pric
+00024d20: 655f 636f 6c73 2929 3a0a 2020 2020 2020  e_cols)):.      
+00024d30: 2020 2020 2020 6320 3d20 7072 6963 655f        c = price_
+00024d40: 636f 6c73 5b69 5d0a 2020 2020 2020 2020  cols[i].        
+00024d50: 2020 2020 6466 322e 6c6f 635b 665f 7a65      df2.loc[f_ze
+00024d60: 726f 5f6f 725f 6e61 6e5b 3a2c 2069 5d2c  ro_or_nan[:, i],
+00024d70: 2063 5d20 3d20 7461 670a 2020 2020 2020   c] = tag.      
+00024d80: 2020 2320 4966 2076 6f6c 756d 653d 3020    # If volume=0 
+00024d90: 6f72 204e 614e 2066 6f72 2062 6164 2070  or NaN for bad p
+00024da0: 7269 6365 732c 2074 6865 6e20 7461 6720  rices, then tag 
+00024db0: 766f 6c75 6d65 2066 6f72 2072 6570 6169  volume for repai
+00024dc0: 720a 2020 2020 2020 2020 6466 322e 6c6f  r.        df2.lo
+00024dd0: 635b 665f 7a65 726f 5f6f 725f 6e61 6e2e  c[f_zero_or_nan.
+00024de0: 616e 7928 6178 6973 3d31 2920 2620 2864  any(axis=1) & (d
+00024df0: 6632 5b22 566f 6c75 6d65 225d 203d 3d20  f2["Volume"] == 
+00024e00: 3029 2c20 2256 6f6c 756d 6522 5d20 3d20  0), "Volume"] = 
+00024e10: 7461 670a 2020 2020 2020 2020 6466 322e  tag.        df2.
+00024e20: 6c6f 635b 665f 7a65 726f 5f6f 725f 6e61  loc[f_zero_or_na
+00024e30: 6e2e 616e 7928 6178 6973 3d31 2920 2620  n.any(axis=1) & 
+00024e40: 2864 6632 5b22 566f 6c75 6d65 225d 2e69  (df2["Volume"].i
+00024e50: 736e 6128 2929 2c20 2256 6f6c 756d 6522  sna()), "Volume"
+00024e60: 5d20 3d20 7461 670a 0a20 2020 2020 2020  ] = tag..       
+00024e70: 2023 2070 7269 6e74 2864 6632 5b66 5f7a   # print(df2[f_z
+00024e80: 6572 6f5f 6f72 5f6e 616e 2e61 6e79 2861  ero_or_nan.any(a
+00024e90: 7869 733d 3129 5d29 0a20 2020 2020 2020  xis=1)]).       
+00024ea0: 206e 5f62 6566 6f72 6520 3d20 2864 6632   n_before = (df2
+00024eb0: 5b64 6174 615f 636f 6c73 5d2e 746f 5f6e  [data_cols].to_n
+00024ec0: 756d 7079 2829 203d 3d20 7461 6729 2e73  umpy() == tag).s
+00024ed0: 756d 2829 0a20 2020 2020 2020 2023 2070  um().        # p
+00024ee0: 7269 6e74 2822 6e5f 6265 666f 7265 203d  rint("n_before =
+00024ef0: 222c 206e 5f62 6566 6f72 6529 0a20 2020  ", n_before).   
+00024f00: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00024f10: 2020 2020 2020 6466 3220 3d20 7365 6c66        df2 = self
+00024f20: 2e5f 7265 636f 6e73 7472 7563 745f 696e  ._reconstruct_in
+00024f30: 7465 7276 616c 735f 6261 7463 6828 6466  tervals_batch(df
+00024f40: 322c 2074 6167 3d74 6167 290a 2020 2020  2, tag=tag).    
+00024f50: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00024f60: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+00024f70: 2020 6966 206c 656e 2873 656c 662e 5f73    if len(self._s
+00024f80: 7461 636b 5f74 7261 6365 2920 3e20 303a  tack_trace) > 0:
+00024f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024fa0: 2073 656c 662e 5f73 7461 636b 5f74 7261   self._stack_tra
+00024fb0: 6365 2e70 6f70 286c 656e 2873 656c 662e  ce.pop(len(self.
+00024fc0: 5f73 7461 636b 5f74 7261 6365 2920 2d20  _stack_trace) - 
+00024fd0: 3129 0a20 2020 2020 2020 2020 2020 2072  1).            r
+00024fe0: 6169 7365 0a20 2020 2020 2020 206e 5f61  aise.        n_a
+00024ff0: 6674 6572 203d 2028 6466 325b 6461 7461  fter = (df2[data
+00025000: 5f63 6f6c 735d 2e74 6f5f 6e75 6d70 7928  _cols].to_numpy(
+00025010: 2920 3d3d 2074 6167 292e 7375 6d28 290a  ) == tag).sum().
+00025020: 2020 2020 2020 2020 6e5f 6669 7865 6420          n_fixed 
+00025030: 3d20 6e5f 6265 666f 7265 202d 206e 5f61  = n_before - n_a
+00025040: 6674 6572 0a20 2020 2020 2020 206d 7367  fter.        msg
+00025050: 203d 2066 2246 6978 6564 207b 6e5f 6669   = f"Fixed {n_fi
+00025060: 7865 647d 2f7b 6e5f 6265 666f 7265 7d20  xed}/{n_before} 
+00025070: 7072 6963 653d 302e 3020 6572 726f 7273  price=0.0 errors
+00025080: 2069 6e20 7b73 656c 662e 6973 7472 7d20   in {self.istr} 
+00025090: 7072 6963 6520 6461 7461 220a 2020 2020  price data".    
+000250a0: 2020 2020 6966 206e 6f74 2073 696c 656e      if not silen
+000250b0: 7420 616e 6420 6e5f 6669 7865 6420 3e20  t and n_fixed > 
+000250c0: 303a 0a20 2020 2020 2020 2020 2020 2070  0:.            p
+000250d0: 7269 6e74 2866 227b 7365 6c66 2e74 6963  rint(f"{self.tic
+000250e0: 6b65 727d 3a20 2220 2b20 6d73 6729 0a20  ker}: " + msg). 
+000250f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00025100: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00025110: 6e61 6765 722e 4c6f 6745 7665 6e74 2822  nager.LogEvent("
+00025120: 696e 666f 222c 2022 5072 6963 654d 616e  info", "PriceMan
+00025130: 6167 6572 222c 206d 7367 290a 0a20 2020  ager", msg)..   
+00025140: 2020 2020 2023 2052 6573 746f 7265 206f       # Restore o
+00025150: 7269 6769 6e61 6c20 7661 6c75 6573 2077  riginal values w
+00025160: 6865 7265 2072 6570 6169 7220 6661 696c  here repair fail
+00025170: 6564 2028 692e 652e 2072 656d 6f76 6520  ed (i.e. remove 
+00025180: 7461 6720 7661 6c75 6573 290a 2020 2020  tag values).    
+00025190: 2020 2020 6620 3d20 6466 325b 6461 7461      f = df2[data
+000251a0: 5f63 6f6c 735d 2e74 6f5f 6e75 6d70 7928  _cols].to_numpy(
+000251b0: 2920 3d3d 2074 6167 0a20 2020 2020 2020  ) == tag.       
+000251c0: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
+000251d0: 6c65 6e28 6461 7461 5f63 6f6c 7329 293a  len(data_cols)):
+000251e0: 0a20 2020 2020 2020 2020 2020 2066 6a20  .            fj 
+000251f0: 3d20 665b 3a2c 206a 5d0a 2020 2020 2020  = f[:, j].      
+00025200: 2020 2020 2020 6966 2066 6a2e 616e 7928        if fj.any(
+00025210: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00025220: 2020 2063 203d 2064 6174 615f 636f 6c73     c = data_cols
+00025230: 5b6a 5d0a 2020 2020 2020 2020 2020 2020  [j].            
+00025240: 2020 2020 6466 322e 6c6f 635b 666a 2c20      df2.loc[fj, 
+00025250: 635d 203d 2064 662e 6c6f 635b 666a 2c20  c] = df.loc[fj, 
+00025260: 635d 0a0a 2020 2020 2020 2020 7966 636c  c]..        yfcl
+00025270: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+00025280: 7367 5f65 7869 7429 0a0a 2020 2020 2020  sg_exit)..      
+00025290: 2020 7265 7475 726e 2064 6632 0a0a 2020    return df2..  
+000252a0: 2020 6465 6620 5f72 6576 6572 7365 5961    def _reverseYa
+000252b0: 686f 6f41 646a 7573 7428 7365 6c66 2c20  hooAdjust(self, 
+000252c0: 6466 293a 0a20 2020 2020 2020 2079 6663  df):.        yfc
+000252d0: 752e 5479 7065 4368 6563 6b44 6174 6146  u.TypeCheckDataF
+000252e0: 7261 6d65 2864 662c 2022 6466 2229 0a0a  rame(df, "df")..
+000252f0: 2020 2020 2020 2020 2320 5961 686f 6f20          # Yahoo 
+00025300: 7265 7475 726e 7320 6461 7461 2073 706c  returns data spl
+00025310: 6974 2d61 646a 7573 7465 6420 736f 2072  it-adjusted so r
+00025320: 6576 6572 7365 2074 6861 742e 0a20 2020  everse that..   
+00025330: 2020 2020 2023 0a20 2020 2020 2020 2023       #.        #
+00025340: 2045 7863 6570 7420 666f 7220 686f 7572   Except for hour
+00025350: 6c79 2f6d 696e 7574 6520 6461 7461 2c20  ly/minute data, 
+00025360: 5961 686f 6f20 6973 6e27 7420 636f 6e73  Yahoo isn't cons
+00025370: 6973 7465 6e74 2077 6974 6820 6164 6a75  istent with adju
+00025380: 7374 6d65 6e74 3a0a 2020 2020 2020 2020  stment:.        
+00025390: 2320 2d20 7072 6963 6573 206f 6e6c 7920  # - prices only 
+000253a0: 7370 6c69 742d 6164 6a75 7374 6564 2069  split-adjusted i
+000253b0: 6620 6461 7465 2072 616e 6765 2063 6f6e  f date range con
+000253c0: 7461 696e 7320 6120 7370 6c69 740a 2020  tains a split.  
+000253d0: 2020 2020 2020 2320 2d20 6469 7669 6465        # - divide
+000253e0: 6e64 2061 7070 6561 7273 2073 706c 6974  nd appears split
+000253f0: 2d61 646a 7573 7465 640a 2020 2020 2020  -adjusted.      
+00025400: 2020 2320 4561 7379 2074 6f20 6669 7820    # Easy to fix 
+00025410: 7573 696e 6720 6461 696c 7920 6461 7461  using daily data
+00025420: 3a0a 2020 2020 2020 2020 2320 2d20 6469  :.        # - di
+00025430: 7669 6465 2070 7269 6365 7320 6279 2064  vide prices by d
+00025440: 6169 6c79 2074 6f20 6465 7465 726d 696e  aily to determin
+00025450: 6520 6966 2073 706c 6974 2d61 646a 7573  e if split-adjus
+00025460: 7465 640a 2020 2020 2020 2020 2320 2d20  ted.        # - 
+00025470: 636f 7079 2064 6976 6964 656e 6473 2066  copy dividends f
+00025480: 726f 6d20 6461 696c 790a 0a20 2020 2020  rom daily..     
+00025490: 2020 2023 2046 696e 616c 6c79 2c20 6164     # Finally, ad
+000254a0: 6420 2743 5346 2720 2620 2743 4446 2720  d 'CSF' & 'CDF' 
+000254b0: 636f 6c75 6d6e 7320 746f 2061 6c6c 6f77  columns to allow
+000254c0: 2063 6865 6170 206f 6e2d 6465 6d61 6e64   cheap on-demand
+000254d0: 2061 646a 7573 746d 656e 740a 0a20 2020   adjustment..   
+000254e0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+000254f0: 7374 616e 6365 2864 662c 2070 642e 4461  stance(df, pd.Da
+00025500: 7461 4672 616d 6529 3a0a 2020 2020 2020  taFrame):.      
+00025510: 2020 2020 2020 7261 6973 6520 4578 6365        raise Exce
+00025520: 7074 696f 6e28 2227 6466 2720 6d75 7374  ption("'df' must
+00025530: 2062 6520 7064 2e44 6174 6146 7261 6d65   be pd.DataFrame
+00025540: 206e 6f74 207b 7d22 2e66 6f72 6d61 7428   not {}".format(
+00025550: 7479 7065 2864 6629 2929 0a0a 2020 2020  type(df)))..    
+00025560: 2020 2020 6465 6275 6720 3d20 4661 6c73      debug = Fals
+00025570: 650a 2020 2020 2020 2020 2320 6465 6275  e.        # debu
+00025580: 6720 3d20 5472 7565 0a0a 2020 2020 2020  g = True..      
+00025590: 2020 6c6f 675f 6d73 6720 3d20 6622 504d    log_msg = f"PM
+000255a0: 3a3a 5f72 6576 6572 7365 5961 686f 6f41  ::_reverseYahooA
+000255b0: 646a 7573 742d 7b73 656c 662e 6973 7472  djust-{self.istr
+000255c0: 7d2c 207b 6466 2e69 6e64 6578 5b30 5d7d  }, {df.index[0]}
+000255d0: 2d3e 7b64 662e 696e 6465 785b 2d31 5d7d  ->{df.index[-1]}
+000255e0: 220a 2020 2020 2020 2020 6966 2079 6663  ".        if yfc
+000255f0: 6c2e 4973 5472 6163 696e 6745 6e61 626c  l.IsTracingEnabl
+00025600: 6564 2829 3a0a 2020 2020 2020 2020 2020  ed():.          
+00025610: 2020 7966 636c 2e54 7261 6365 456e 7465    yfcl.TraceEnte
+00025620: 7228 6c6f 675f 6d73 6729 0a20 2020 2020  r(log_msg).     
+00025630: 2020 2065 6c69 6620 6465 6275 673a 0a20     elif debug:. 
+00025640: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00025650: 2822 2229 0a20 2020 2020 2020 2020 2020  ("").           
+00025660: 2070 7269 6e74 286c 6f67 5f6d 7367 290a   print(log_msg).
+00025670: 0a20 2020 2020 2020 2069 6620 6465 6275  .        if debu
+00025680: 673a 0a20 2020 2020 2020 2020 2020 2070  g:.            p
+00025690: 7269 6e74 2864 665b 5b22 4f70 656e 222c  rint(df[["Open",
+000256a0: 2022 4c6f 7722 2c20 2248 6967 6822 2c20   "Low", "High", 
+000256b0: 2243 6c6f 7365 222c 2022 566f 6c75 6d65  "Close", "Volume
+000256c0: 225d 5d29 0a0a 2020 2020 2020 2020 6364  "]])..        cd
+000256d0: 6620 3d20 4e6f 6e65 0a20 2020 2020 2020  f = None.       
+000256e0: 2063 7366 203d 204e 6f6e 650a 0a20 2020   csf = None..   
+000256f0: 2020 2020 2069 6620 7365 6c66 2e69 6e74       if self.int
+00025700: 6572 7661 6c20 213d 2079 6663 642e 496e  erval != yfcd.In
+00025710: 7465 7276 616c 2e44 6179 7331 3a0a 2020  terval.Days1:.  
+00025720: 2020 2020 2020 2020 2020 2320 5472 6967            # Trig
+00025730: 6765 7220 7570 6461 7465 206f 6620 6461  ger update of da
+00025740: 696c 7920 7072 6963 6520 6461 7461 2c20  ily price data, 
+00025750: 746f 2067 6574 2061 6c6c 2065 7665 6e74  to get all event
+00025760: 730a 2020 2020 2020 2020 2020 2020 6869  s.            hi
+00025770: 7374 4461 696c 7920 3d20 7365 6c66 2e6d  stDaily = self.m
+00025780: 616e 6167 6572 2e47 6574 4869 7374 6f72  anager.GetHistor
+00025790: 7928 7966 6364 2e49 6e74 6572 7661 6c2e  y(yfcd.Interval.
+000257a0: 4461 7973 3129 0a20 2020 2020 2020 2020  Days1).         
+000257b0: 2020 2064 665f 6461 696c 795f 7261 7720     df_daily_raw 
+000257c0: 3d20 6869 7374 4461 696c 792e 6765 7428  = histDaily.get(
+000257d0: 7374 6172 743d 6466 2e69 6e64 6578 5b30  start=df.index[0
+000257e0: 5d2e 6461 7465 2829 2c20 7265 7061 6972  ].date(), repair
+000257f0: 3d46 616c 7365 290a 0a20 2020 2020 2020  =False)..       
+00025800: 2023 2053 7465 7020 313a 2065 6e73 7572   # Step 1: ensur
+00025810: 6520 696e 7472 6164 6179 2070 7269 6365  e intraday price
+00025820: 2064 6174 6120 6973 2061 6c77 6179 7320   data is always 
+00025830: 7370 6c69 742d 6164 6a75 7374 6564 0a20  split-adjusted. 
+00025840: 2020 2020 2020 2074 645f 3764 203d 2074         td_7d = t
+00025850: 696d 6564 656c 7461 2864 6179 733d 3729  imedelta(days=7)
+00025860: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00025870: 7365 6c66 2e69 6e74 6572 6461 793a 0a20  self.interday:. 
+00025880: 2020 2020 2020 2020 2020 2023 2047 6574             # Get
+00025890: 2064 6169 6c79 2070 7269 6365 2064 6174   daily price dat
+000258a0: 6120 6475 7269 6e67 2061 6e64 2061 6674  a during and aft
+000258b0: 6572 2027 6466 270a 0a20 2020 2020 2020  er 'df'..       
+000258c0: 2020 2020 2064 665f 6461 696c 7920 3d20       df_daily = 
+000258d0: 6466 5f64 6169 6c79 5f72 6177 2e63 6f70  df_daily_raw.cop
+000258e0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+000258f0: 666f 7220 6320 696e 205b 224f 7065 6e22  for c in ["Open"
+00025900: 2c20 2243 6c6f 7365 222c 2022 4c6f 7722  , "Close", "Low"
+00025910: 2c20 2248 6967 6822 5d3a 0a20 2020 2020  , "High"]:.     
+00025920: 2020 2020 2020 2020 2020 2064 665f 6461             df_da
+00025930: 696c 795b 635d 202a 3d20 6466 5f64 6169  ily[c] *= df_dai
+00025940: 6c79 5b22 4353 4622 5d0a 2020 2020 2020  ly["CSF"].      
+00025950: 2020 2020 2020 6466 5f64 6169 6c79 5b22        df_daily["
+00025960: 566f 6c75 6d65 225d 202f 3d20 6466 5f64  Volume"] /= df_d
+00025970: 6169 6c79 5b22 4353 4622 5d0a 2020 2020  aily["CSF"].    
+00025980: 2020 2020 2020 2020 6466 5f64 6169 6c79          df_daily
+00025990: 203d 2064 665f 6461 696c 792e 6472 6f70   = df_daily.drop
+000259a0: 2822 4353 4622 2c20 6178 6973 3d31 290a  ("CSF", axis=1).
+000259b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000259c0: 6466 5f64 6169 6c79 2069 7320 4e6f 6e65  df_daily is None
+000259d0: 206f 7220 6466 5f64 6169 6c79 2e65 6d70   or df_daily.emp
+000259e0: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+000259f0: 2020 2020 2320 6466 203d 2064 662e 6472      # df = df.dr
+00025a00: 6f70 2822 4164 6a20 436c 6f73 6522 2c20  op("Adj Close", 
+00025a10: 6178 6973 3d31 290a 2020 2020 2020 2020  axis=1).        
+00025a20: 2020 2020 2020 2020 6466 5b22 4353 4622          df["CSF"
+00025a30: 5d20 3d20 312e 300a 2020 2020 2020 2020  ] = 1.0.        
+00025a40: 2020 2020 2020 2020 6466 5b22 4344 4622          df["CDF"
+00025a50: 5d20 3d20 312e 300a 2020 2020 2020 2020  ] = 1.0.        
+00025a60: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00025a70: 660a 0a20 2020 2020 2020 2020 2020 2066  f..            f
+00025a80: 5f70 6f73 7420 3d20 6466 5f64 6169 6c79  _post = df_daily
+00025a90: 2e69 6e64 6578 2e64 6174 6520 3e20 6466  .index.date > df
+00025aa0: 2e69 6e64 6578 5b2d 315d 2e64 6174 6528  .index[-1].date(
+00025ab0: 290a 2020 2020 2020 2020 2020 2020 6466  ).            df
+00025ac0: 5f64 6169 6c79 5f64 7572 696e 6720 3d20  _daily_during = 
+00025ad0: 6466 5f64 6169 6c79 5b7e 665f 706f 7374  df_daily[~f_post
+00025ae0: 5d2e 636f 7079 2829 0a20 2020 2020 2020  ].copy().       
+00025af0: 2020 2020 2064 665f 6461 696c 795f 706f       df_daily_po
+00025b00: 7374 203d 2064 665f 6461 696c 795b 665f  st = df_daily[f_
+00025b10: 706f 7374 5d2e 636f 7079 2829 0a20 2020  post].copy().   
+00025b20: 2020 2020 2020 2020 2064 665f 6461 696c           df_dail
+00025b30: 795f 6475 7269 6e67 2e69 6e64 6578 203d  y_during.index =
+00025b40: 2064 665f 6461 696c 795f 6475 7269 6e67   df_daily_during
+00025b50: 2e69 6e64 6578 2e64 6174 6520 3b20 6466  .index.date ; df
+00025b60: 5f64 6169 6c79 5f64 7572 696e 672e 696e  _daily_during.in
+00025b70: 6465 782e 6e61 6d65 203d 2022 5f64 6174  dex.name = "_dat
+00025b80: 6522 0a0a 2020 2020 2020 2020 2020 2020  e"..            
+00025b90: 2320 416c 736f 2067 6574 2072 6177 2064  # Also get raw d
+00025ba0: 6169 6c79 2064 6174 6120 6672 6f6d 2063  aily data from c
+00025bb0: 6163 6865 0a20 2020 2020 2020 2020 2020  ache.           
+00025bc0: 2064 665f 6461 696c 795f 7261 7720 3d20   df_daily_raw = 
+00025bd0: 6466 5f64 6169 6c79 5f72 6177 5b64 665f  df_daily_raw[df_
+00025be0: 6461 696c 795f 7261 772e 696e 6465 782e  daily_raw.index.
+00025bf0: 6461 7465 203e 3d20 6466 2e69 6e64 6578  date >= df.index
+00025c00: 5b30 5d2e 6461 7465 2829 5d0a 2020 2020  [0].date()].    
+00025c10: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
+00025c20: 2020 2020 2020 665f 706f 7374 203d 2064        f_post = d
+00025c30: 665f 6461 696c 795f 7261 772e 696e 6465  f_daily_raw.inde
+00025c40: 782e 6461 7465 203e 2064 662e 696e 6465  x.date > df.inde
+00025c50: 785b 2d31 5d2e 6461 7465 2829 0a20 2020  x[-1].date().   
+00025c60: 2020 2020 2020 2020 2064 665f 6461 696c           df_dail
+00025c70: 795f 7261 775f 6475 7269 6e67 203d 2064  y_raw_during = d
+00025c80: 665f 6461 696c 795f 7261 775b 7e66 5f70  f_daily_raw[~f_p
+00025c90: 6f73 745d 2e63 6f70 7928 290a 2020 2020  ost].copy().    
+00025ca0: 2020 2020 2020 2020 6466 5f64 6169 6c79          df_daily
+00025cb0: 5f72 6177 5f64 7572 696e 675f 6420 3d20  _raw_during_d = 
+00025cc0: 6466 5f64 6169 6c79 5f72 6177 5f64 7572  df_daily_raw_dur
+00025cd0: 696e 672e 636f 7079 2829 0a20 2020 2020  ing.copy().     
+00025ce0: 2020 2020 2020 2064 665f 6461 696c 795f         df_daily_
+00025cf0: 7261 775f 6475 7269 6e67 5f64 2e69 6e64  raw_during_d.ind
+00025d00: 6578 203d 2064 665f 6461 696c 795f 7261  ex = df_daily_ra
+00025d10: 775f 6475 7269 6e67 5f64 2e69 6e64 6578  w_during_d.index
+00025d20: 2e64 6174 6520 3b20 6466 5f64 6169 6c79  .date ; df_daily
+00025d30: 5f72 6177 5f64 7572 696e 675f 642e 696e  _raw_during_d.in
+00025d40: 6465 782e 6e61 6d65 203d 2022 5f64 6174  dex.name = "_dat
+00025d50: 6522 0a0a 2020 2020 2020 2020 2020 2020  e"..            
+00025d60: 6966 2064 665f 6461 696c 795f 706f 7374  if df_daily_post
+00025d70: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+00025d80: 2020 2020 2020 2020 6373 665f 706f 7374          csf_post
+00025d90: 203d 2031 2e30 0a20 2020 2020 2020 2020   = 1.0.         
+00025da0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00025db0: 2020 2020 2020 2020 2063 7366 5f70 6f73           csf_pos
+00025dc0: 7420 3d20 7966 6375 2e47 6574 4353 4630  t = yfcu.GetCSF0
+00025dd0: 2864 665f 6461 696c 795f 706f 7374 290a  (df_daily_post).
+00025de0: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+00025df0: 6374 6564 5261 7469 6f20 3d20 312e 3020  ctedRatio = 1.0 
+00025e00: 2f20 6373 665f 706f 7374 0a0a 2020 2020  / csf_post..    
+00025e10: 2020 2020 2020 2020 2320 2320 4d65 7267          # # Merg
+00025e20: 6520 2764 6627 2077 6974 6820 6461 696c  e 'df' with dail
+00025e30: 7920 6461 7461 2074 6f20 636f 6d70 6172  y data to compar
+00025e40: 6520 616e 6420 696e 6665 7220 6164 6a75  e and infer adju
+00025e50: 7374 6d65 6e74 0a20 2020 2020 2020 2020  stment.         
+00025e60: 2020 2023 2064 665f 6772 7020 3d20 6466     # df_grp = df
+00025e70: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+00025e80: 2020 2020 2320 6466 5f67 7270 5b22 5f64      # df_grp["_d
+00025e90: 6174 6522 5d20 3d20 6466 5f67 7270 2e69  ate"] = df_grp.i
+00025ea0: 6e64 6578 2e64 6174 650a 2020 2020 2020  ndex.date.      
+00025eb0: 2020 2020 2020 2320 6466 5f67 7270 203d        # df_grp =
+00025ec0: 2064 665f 6772 702e 6772 6f75 7062 7928   df_grp.groupby(
+00025ed0: 225f 6461 7465 2229 0a20 2020 2020 2020  "_date").       
+00025ee0: 2020 2020 2023 2064 665f 6167 6742 7944       # df_aggByD
+00025ef0: 6179 203d 2064 665f 6772 702e 6167 6728  ay = df_grp.agg(
+00025f00: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+00025f10: 2020 204c 6f77 3d28 224c 6f77 222c 2022     Low=("Low", "
+00025f20: 6d69 6e22 292c 0a20 2020 2020 2020 2020  min"),.         
+00025f30: 2020 2023 2020 2020 2048 6967 683d 2822     #     High=("
+00025f40: 4869 6768 222c 2022 6d61 7822 292c 0a20  High", "max"),. 
+00025f50: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00025f60: 204f 7065 6e3d 2822 4f70 656e 222c 2022   Open=("Open", "
+00025f70: 6669 7273 7422 292c 0a20 2020 2020 2020  first"),.       
+00025f80: 2020 2020 2023 2020 2020 2043 6c6f 7365       #     Close
+00025f90: 3d28 2243 6c6f 7365 222c 2022 6c61 7374  =("Close", "last
+00025fa0: 2229 290a 0a20 2020 2020 2020 2020 2020  "))..           
+00025fb0: 2023 2043 726f 7373 2d63 6865 636b 2069   # Cross-check i
+00025fc0: 6e66 6572 7265 6420 7370 6c69 742d 6164  nferred split-ad
+00025fd0: 6a75 7374 6d65 6e74 2076 7320 6578 7065  justment vs expe
+00025fe0: 6374 6564 0a20 2020 2020 2020 2020 2020  cted.           
+00025ff0: 2023 202d 2075 7064 6174 653a 2064 6973   # - update: dis
+00026000: 6162 6c65 2c20 6265 6361 7573 6520 6f6e  able, because on
+00026010: 6c79 2066 6169 6c73 2064 7565 2074 6f20  ly fails due to 
+00026020: 696e 7375 6666 6963 6965 6e74 2064 6174  insufficient dat
+00026030: 610a 2020 2020 2020 2020 2020 2020 2320  a.            # 
+00026040: 6461 7461 5f63 6f6c 7320 3d20 5b22 4f70  data_cols = ["Op
+00026050: 656e 222c 2022 436c 6f73 6522 2c20 224c  en", "Close", "L
+00026060: 6f77 222c 2022 4869 6768 225d 0a20 2020  ow", "High"].   
+00026070: 2020 2020 2020 2020 2023 2064 6632 203d           # df2 =
+00026080: 2070 642e 6d65 7267 6528 6466 5f61 6767   pd.merge(df_agg
+00026090: 4279 4461 792c 2064 665f 6461 696c 795f  ByDay, df_daily_
+000260a0: 6475 7269 6e67 2c20 686f 773d 226c 6566  during, how="lef
+000260b0: 7422 2c20 6f6e 3d22 5f64 6174 6522 2c20  t", on="_date", 
+000260c0: 7661 6c69 6461 7465 3d22 6f6e 655f 746f  validate="one_to
+000260d0: 5f6f 6e65 222c 2073 7566 6669 7865 733d  _one", suffixes=
+000260e0: 2822 222c 2022 5f64 6179 2229 290a 2020  ("", "_day")).  
+000260f0: 2020 2020 2020 2020 2020 2320 2320 4966            # # If
+00026100: 2027 6466 2720 6861 7320 6e6f 7420 6265   'df' has not be
+00026110: 656e 2073 706c 6974 2d61 646a 7573 7465  en split-adjuste
+00026120: 6420 6279 2059 6168 6f6f 2c20 6275 7420  d by Yahoo, but 
+00026130: 6974 2073 686f 756c 6420 6861 7665 2062  it should have b
+00026140: 6565 6e2c 0a20 2020 2020 2020 2020 2020  een,.           
+00026150: 2023 2023 2074 6865 6e20 7468 6520 696e   # # then the in
+00026160: 6665 7272 6564 2073 706c 6974 2d61 646a  ferred split-adj
+00026170: 7573 7420 7261 7469 6f20 7368 6f75 6c64  ust ratio should
+00026180: 2062 6520 636c 6f73 6520 746f 2031 2e30   be close to 1.0
+00026190: 2f70 6f73 745f 6373 662e 0a20 2020 2020  /post_csf..     
+000261a0: 2020 2020 2020 2023 2023 2041 7070 6c79         # # Apply
+000261b0: 2061 2066 6577 2073 616e 6974 7920 7465   a few sanity te
+000261c0: 7374 7320 6167 6169 6e73 7420 696e 6665  sts against infe
+000261d0: 7272 6564 2072 6174 696f 202d 206e 6f74  rred ratio - not
+000261e0: 204e 614e 2c20 6c6f 7720 7661 7269 616e   NaN, low varian
+000261f0: 6365 0a20 2020 2020 2020 2020 2020 2023  ce.            #
+00026200: 2069 6620 6466 325b 7e64 6632 5b22 436c   if df2[~df2["Cl
+00026210: 6f73 6522 5d2e 6973 6e61 2829 5d2e 656d  ose"].isna()].em
+00026220: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+00026230: 2023 2020 2020 2073 735f 7261 7469 6f20   #     ss_ratio 
+00026240: 3d20 6578 7065 6374 6564 5261 7469 6f0a  = expectedRatio.
+00026250: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00026260: 2020 7374 6465 765f 7063 7420 3d20 302e    stdev_pct = 0.
+00026270: 300a 2020 2020 2020 2020 2020 2020 2320  0.            # 
+00026280: 656c 6966 2064 662e 7368 6170 655b 305d  elif df.shape[0]
+00026290: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+000262a0: 2020 2023 2020 2020 2073 735f 7261 7469     #     ss_rati
+000262b0: 6f20 3d20 6466 325b 2243 6c6f 7365 225d  o = df2["Close"]
+000262c0: 2e69 6c6f 635b 305d 202f 2064 6632 5b22  .iloc[0] / df2["
+000262d0: 436c 6f73 655f 6461 7922 5d2e 696c 6f63  Close_day"].iloc
+000262e0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+000262f0: 2320 2020 2020 7374 6465 765f 7063 7420  #     stdev_pct 
+00026300: 3d20 302e 300a 2020 2020 2020 2020 2020  = 0.0.          
+00026310: 2020 2320 656c 7365 3a0a 2020 2020 2020    # else:.      
+00026320: 2020 2020 2020 2320 2020 2020 7261 7469        #     rati
+00026330: 6f73 203d 2064 6632 5b64 6174 615f 636f  os = df2[data_co
+00026340: 6c73 5d2e 746f 5f6e 756d 7079 2829 202f  ls].to_numpy() /
+00026350: 2064 6632 5b5b 6463 202b 2022 5f64 6179   df2[[dc + "_day
+00026360: 2220 666f 7220 6463 2069 6e20 6461 7461  " for dc in data
+00026370: 5f63 6f6c 735d 5d2e 746f 5f6e 756d 7079  _cols]].to_numpy
+00026380: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
+00026390: 2020 2020 2072 6174 696f 735b 6466 325b       ratios[df2[
+000263a0: 6461 7461 5f63 6f6c 735d 2e69 736e 6128  data_cols].isna(
+000263b0: 295d 203d 2031 2e30 0a20 2020 2020 2020  )] = 1.0.       
+000263c0: 2020 2020 2023 2020 2020 2023 2073 735f       #     # ss_
+000263d0: 7261 7469 6f20 3d20 6e70 2e6d 6561 6e28  ratio = np.mean(
+000263e0: 7261 7469 6f73 290a 2020 2020 2020 2020  ratios).        
+000263f0: 2020 2020 2320 2020 2020 2320 7374 6465      #     # stde
+00026400: 765f 7063 7420 3d20 6e70 2e73 7464 2872  v_pct = np.std(r
+00026410: 6174 696f 7329 202f 2073 735f 7261 7469  atios) / ss_rati
+00026420: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+00026430: 2020 2020 2320 5765 6967 6874 2062 7920      # Weight by 
+00026440: 6e75 6d62 6572 206f 6620 726f 7773 2070  number of rows p
+00026450: 6572 2067 726f 7570 2c20 6265 6361 7573  er group, becaus
+00026460: 6520 6772 6f75 7073 2077 6974 6820 3120  e groups with 1 
+00026470: 726f 7720 6973 2073 6372 6577 696e 6720  row is screwing 
+00026480: 7661 7269 616e 6365 2e0a 2020 2020 2020  variance..      
+00026490: 2020 2020 2020 2320 2020 2020 7374 6465        #     stde
+000264a0: 765f 7063 7420 3d20 302e 300a 2020 2020  v_pct = 0.0.    
+000264b0: 2020 2020 2020 2020 2320 2020 2020 7765          #     we
+000264c0: 6967 6874 7320 3d20 6466 5f67 7270 2e73  ights = df_grp.s
+000264d0: 697a 6528 292e 746f 5f6e 756d 7079 2829  ize().to_numpy()
+000264e0: 2e61 7374 7970 6528 666c 6f61 7429 0a20  .astype(float). 
+000264f0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00026500: 2077 6569 6768 7473 5f32 6420 3d20 6e70   weights_2d = np
+00026510: 2e74 696c 6528 7765 6967 6874 735b 3a2c  .tile(weights[:,
+00026520: 4e6f 6e65 5d2c 2072 6174 696f 732e 7368  None], ratios.sh
+00026530: 6170 655b 315d 290a 2020 2020 2020 2020  ape[1]).        
+00026540: 2020 2020 2320 2020 2020 7373 5f72 6174      #     ss_rat
+00026550: 696f 2c20 7374 6420 3d20 7966 6375 2e6e  io, std = yfcu.n
+00026560: 705f 7765 6967 6874 6564 5f6d 6561 6e5f  p_weighted_mean_
+00026570: 616e 645f 7374 6428 7261 7469 6f73 2c20  and_std(ratios, 
+00026580: 7765 6967 6874 735f 3264 290a 2020 2020  weights_2d).    
+00026590: 2020 2020 2020 2020 2320 2020 2020 7374          #     st
+000265a0: 6465 765f 7063 7420 3d20 7374 6420 2f20  dev_pct = std / 
+000265b0: 7373 5f72 6174 696f 0a20 2020 2020 2020  ss_ratio.       
+000265c0: 2020 2020 2023 2023 0a20 2020 2020 2020       # #.       
+000265d0: 2020 2020 2023 2023 2069 6620 7374 6465       # # if stde
+000265e0: 765f 7063 7420 3e20 302e 3035 3a0a 2020  v_pct > 0.05:.  
+000265f0: 2020 2020 2020 2020 2020 2320 6966 2073            # if s
+00026600: 7464 6576 5f70 6374 203e 2030 2e30 333a  tdev_pct > 0.03:
+00026610: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+00026620: 2020 2063 6f6c 735f 746f 5f70 7269 6e74     cols_to_print
+00026630: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00026640: 2020 2320 2020 2020 666f 7220 6463 2069    #     for dc i
+00026650: 6e20 6461 7461 5f63 6f6c 733a 0a20 2020  n data_cols:.   
+00026660: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00026670: 2020 2064 6632 5b64 6320 2b20 225f 7222     df2[dc + "_r"
+00026680: 5d20 3d20 6466 325b 6463 5d20 2f20 6466  ] = df2[dc] / df
+00026690: 325b 6463 202b 2022 5f64 6179 225d 0a20  2[dc + "_day"]. 
+000266a0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+000266b0: 2020 2020 2063 6f6c 735f 746f 5f70 7269       cols_to_pri
+000266c0: 6e74 2e61 7070 656e 6428 6463 290a 2020  nt.append(dc).  
+000266d0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+000266e0: 2020 2020 636f 6c73 5f74 6f5f 7072 696e      cols_to_prin
+000266f0: 742e 6170 7065 6e64 2864 6320 2b20 225f  t.append(dc + "_
+00026700: 6461 7922 290a 2020 2020 2020 2020 2020  day").          
+00026710: 2020 2320 2020 2020 2020 2020 636f 6c73    #         cols
+00026720: 5f74 6f5f 7072 696e 742e 6170 7065 6e64  _to_print.append
+00026730: 2864 6320 2b20 225f 7222 290a 2020 2020  (dc + "_r").    
+00026740: 2020 2020 2020 2020 2320 2020 2020 7072          #     pr
+00026750: 696e 7428 6466 325b 636f 6c73 5f74 6f5f  int(df2[cols_to_
+00026760: 7072 696e 745d 290a 2020 2020 2020 2020  print]).        
+00026770: 2020 2020 2320 2020 2020 7261 6973 6520      #     raise 
+00026780: 4578 6365 7074 696f 6e28 2253 5444 4556  Exception("STDEV
+00026790: 2025 206f 6620 6573 7469 6d61 7465 6420   % of estimated 
+000267a0: 7374 6f63 6b2d 7370 6c69 7420 7261 7469  stock-split rati
+000267b0: 6f20 6973 207b 7d25 2c20 7368 6f75 6c64  o is {}%, should
+000267c0: 2062 6520 6e65 6172 207a 6572 6f22 2e66   be near zero".f
+000267d0: 6f72 6d61 7428 726f 756e 6428 7374 6465  ormat(round(stde
+000267e0: 765f 7063 7420 2a20 3130 302c 2031 2929  v_pct * 100, 1))
+000267f0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00026800: 2023 2069 6620 6162 7328 312e 3020 2d20   # if abs(1.0 - 
+00026810: 7373 5f72 6174 696f 202f 2065 7870 6563  ss_ratio / expec
+00026820: 7465 6452 6174 696f 2920 3e20 302e 3035  tedRatio) > 0.05
+00026830: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00026840: 6966 2061 6273 2831 2e30 202d 2073 735f  if abs(1.0 - ss_
+00026850: 7261 7469 6f20 2f20 6578 7065 6374 6564  ratio / expected
+00026860: 5261 7469 6f29 203e 2030 2e30 333a 0a20  Ratio) > 0.03:. 
+00026870: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00026880: 2063 6f6c 735f 746f 5f70 7269 6e74 203d   cols_to_print =
+00026890: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000268a0: 2320 2020 2020 666f 7220 6463 2069 6e20  #     for dc in 
+000268b0: 6461 7461 5f63 6f6c 733a 0a20 2020 2020  data_cols:.     
+000268c0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+000268d0: 2064 6632 5b64 6320 2b20 225f 7222 5d20   df2[dc + "_r"] 
+000268e0: 3d20 6466 325b 6463 5d20 2f20 6466 325b  = df2[dc] / df2[
+000268f0: 6463 202b 2022 5f64 6179 225d 0a20 2020  dc + "_day"].   
+00026900: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00026910: 2020 2063 6f6c 735f 746f 5f70 7269 6e74     cols_to_print
+00026920: 2e61 7070 656e 6428 6463 290a 2020 2020  .append(dc).    
+00026930: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00026940: 2020 636f 6c73 5f74 6f5f 7072 696e 742e    cols_to_print.
+00026950: 6170 7065 6e64 2864 6320 2b20 225f 6461  append(dc + "_da
+00026960: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
+00026970: 2320 2020 2020 2020 2020 636f 6c73 5f74  #         cols_t
+00026980: 6f5f 7072 696e 742e 6170 7065 6e64 2864  o_print.append(d
+00026990: 6320 2b20 225f 7222 290a 2020 2020 2020  c + "_r").      
+000269a0: 2020 2020 2020 2320 2020 2020 7072 696e        #     prin
+000269b0: 7428 6466 325b 636f 6c73 5f74 6f5f 7072  t(df2[cols_to_pr
+000269c0: 696e 745d 290a 2020 2020 2020 2020 2020  int]).          
+000269d0: 2020 2320 2020 2020 7072 696e 7428 6466    #     print(df
+000269e0: 325b 636f 6c73 5f74 6f5f 7072 696e 745d  2[cols_to_print]
+000269f0: 2e69 6c6f 635b 2d31 5d29 0a20 2020 2020  .iloc[-1]).     
+00026a00: 2020 2020 2020 2023 2020 2020 2070 7269         #     pri
+00026a10: 6e74 2822 6466 3a22 2920 3b20 7072 696e  nt("df:") ; prin
+00026a20: 7428 6466 290a 2020 2020 2020 2020 2020  t(df).          
+00026a30: 2020 2320 2020 2020 7261 6973 6520 4578    #     raise Ex
+00026a40: 6365 7074 696f 6e28 2273 735f 7261 7469  ception("ss_rati
+00026a50: 6f3d 7b7d 2021 3d20 6578 7065 6374 6564  o={} != expected
+00026a60: 5f72 6174 696f 3d7b 7d22 2e66 6f72 6d61  _ratio={}".forma
+00026a70: 7428 7373 5f72 6174 696f 2c20 6578 7065  t(ss_ratio, expe
+00026a80: 6374 6564 5261 7469 6f29 290a 0a20 2020  ctedRatio))..   
+00026a90: 2020 2020 2020 2020 2073 735f 7261 7469           ss_rati
+00026aa0: 6f20 3d20 6578 7065 6374 6564 5261 7469  o = expectedRati
+00026ab0: 6f0a 2020 2020 2020 2020 2020 2020 7373  o.            ss
+00026ac0: 5f72 6174 696f 5263 7020 3d20 312e 3020  _ratioRcp = 1.0 
+00026ad0: 2f20 7373 5f72 6174 696f 0a20 2020 2020  / ss_ratio.     
+00026ae0: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
+00026af0: 2020 2020 2070 7269 6365 5f64 6174 615f       price_data_
+00026b00: 636f 6c73 203d 205b 224f 7065 6e22 2c20  cols = ["Open", 
+00026b10: 2243 6c6f 7365 222c 2022 4164 6a20 436c  "Close", "Adj Cl
+00026b20: 6f73 6522 2c20 224c 6f77 222c 2022 4869  ose", "Low", "Hi
+00026b30: 6768 225d 0a20 2020 2020 2020 2020 2020  gh"].           
+00026b40: 2069 6620 7373 5f72 6174 696f 203e 2031   if ss_ratio > 1
+00026b50: 2e30 313a 0a20 2020 2020 2020 2020 2020  .01:.           
+00026b60: 2020 2020 2066 6f72 2063 2069 6e20 7072       for c in pr
+00026b70: 6963 655f 6461 7461 5f63 6f6c 733a 0a20  ice_data_cols:. 
+00026b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026b90: 2020 2064 665b 635d 202a 3d20 7373 5f72     df[c] *= ss_r
+00026ba0: 6174 696f 5263 700a 2020 2020 2020 2020  atioRcp.        
+00026bb0: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00026bc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026bd0: 2020 2020 2020 7072 696e 7428 2241 7070        print("App
+00026be0: 6c79 696e 6720 313a 7b7d 2073 746f 636b  lying 1:{} stock
+00026bf0: 2d73 706c 6974 222e 666f 726d 6174 2872  -split".format(r
+00026c00: 6f75 6e64 2873 735f 7261 7469 6f2c 2032  ound(ss_ratio, 2
+00026c10: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
+00026c20: 656c 6966 2073 735f 7261 7469 6f52 6370  elif ss_ratioRcp
+00026c30: 203e 2031 2e30 313a 0a20 2020 2020 2020   > 1.01:.       
+00026c40: 2020 2020 2020 2020 2066 6f72 2063 2069           for c i
+00026c50: 6e20 7072 6963 655f 6461 7461 5f63 6f6c  n price_data_col
+00026c60: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00026c70: 2020 2020 2020 2064 665b 635d 202a 3d20         df[c] *= 
+00026c80: 7373 5f72 6174 696f 0a20 2020 2020 2020  ss_ratio.       
+00026c90: 2020 2020 2020 2020 2069 6620 6465 6275           if debu
+00026ca0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00026cb0: 2020 2020 2020 2070 7269 6e74 2822 4170         print("Ap
+00026cc0: 706c 7969 6e67 207b 2e32 667d 3a31 2072  plying {.2f}:1 r
+00026cd0: 6576 6572 7365 2d73 706c 6974 2d73 706c  everse-split-spl
+00026ce0: 6974 222e 666f 726d 6174 2873 735f 7261  it".format(ss_ra
+00026cf0: 7469 6f52 6370 2929 0a20 2020 2020 2020  tioRcp)).       
+00026d00: 2020 2020 2023 204e 6f74 653a 2076 6f6c       # Note: vol
+00026d10: 756d 6520 616c 7761 7973 2072 6574 7572  ume always retur
+00026d20: 6e65 6420 756e 6164 6a75 7374 6564 0a0a  ned unadjusted..
+00026d30: 2020 2020 2020 2020 2020 2020 2320 5961              # Ya
+00026d40: 686f 6f20 6d65 7373 6573 2075 7020 6469  hoo messes up di
+00026d50: 7669 6465 6e64 2061 646a 7573 746d 656e  vidend adjustmen
+00026d60: 7420 746f 6f20 736f 2063 6f70 7920 636f  t too so copy co
+00026d70: 7272 6563 7420 6469 7669 6465 6e64 2066  rrect dividend f
+00026d80: 726f 6d20 6461 696c 792c 0a20 2020 2020  rom daily,.     
+00026d90: 2020 2020 2020 2023 2062 7574 206f 6e6c         # but onl
+00026da0: 7920 746f 2066 6972 7374 2074 696d 6520  y to first time 
+00026db0: 7065 7269 6f64 7320 6f66 2065 6163 6820  periods of each 
+00026dc0: 6461 793a 0a20 2020 2020 2020 2020 2020  day:.           
+00026dd0: 2064 665b 225f 6461 7465 225d 203d 2064   df["_date"] = d
+00026de0: 662e 696e 6465 782e 6461 7465 0a20 2020  f.index.date.   
+00026df0: 2020 2020 2020 2020 2064 665b 225f 696e           df["_in
+00026e00: 6465 7842 6163 6b75 7022 5d20 3d20 6466  dexBackup"] = df
+00026e10: 2e69 6e64 6578 0a20 2020 2020 2020 2020  .index.         
+00026e20: 2020 2023 2064 6620 3d20 6466 2e64 726f     # df = df.dro
+00026e30: 7028 2244 6976 6964 656e 6473 222c 2061  p("Dividends", a
+00026e40: 7869 733d 3129 0a20 2020 2020 2020 2020  xis=1).         
+00026e50: 2020 2023 2023 202d 2067 6574 2066 6972     # # - get fir
+00026e60: 7374 2074 696d 6573 0a20 2020 2020 2020  st times.       
+00026e70: 2020 2020 2023 2064 665b 225f 7469 6d65       # df["_time
+00026e80: 225d 203d 2064 662e 696e 6465 782e 7469  "] = df.index.ti
+00026e90: 6d65 0a20 2020 2020 2020 2020 2020 2023  me.            #
+00026ea0: 2064 665f 6f70 656e 5469 6d65 7320 3d20   df_openTimes = 
+00026eb0: 6466 5b5b 225f 6461 7465 222c 2022 5f74  df[["_date", "_t
+00026ec0: 696d 6522 5d5d 2e67 726f 7570 6279 2822  ime"]].groupby("
+00026ed0: 5f64 6174 6522 2c20 6173 5f69 6e64 6578  _date", as_index
+00026ee0: 3d46 616c 7365 2c20 6772 6f75 705f 6b65  =False, group_ke
+00026ef0: 7973 3d46 616c 7365 292e 6d69 6e28 292e  ys=False).min().
+00026f00: 7265 6e61 6d65 2863 6f6c 756d 6e73 3d7b  rename(columns={
+00026f10: 225f 7469 6d65 223a 2022 5f6f 7065 6e5f  "_time": "_open_
+00026f20: 7469 6d65 227d 290a 2020 2020 2020 2020  time"}).        
+00026f30: 2020 2020 2320 6466 203d 2064 662e 6472      # df = df.dr
+00026f40: 6f70 2822 5f74 696d 6522 2c20 6178 6973  op("_time", axis
+00026f50: 3d31 290a 2020 2020 2020 2020 2020 2020  =1).            
+00026f60: 2320 2320 2d20 6d65 7267 650a 2020 2020  # # - merge.    
+00026f70: 2020 2020 2020 2020 2320 6466 203d 2070          # df = p
+00026f80: 642e 6d65 7267 6528 6466 2c20 6466 5f64  d.merge(df, df_d
+00026f90: 6169 6c79 5f64 7572 696e 675b 5b22 4469  aily_during[["Di
+00026fa0: 7669 6465 6e64 7322 5d5d 2c20 686f 773d  vidends"]], how=
+00026fb0: 226c 6566 7422 2c20 6f6e 3d22 5f64 6174  "left", on="_dat
+00026fc0: 6522 2c20 7661 6c69 6461 7465 3d22 6d61  e", validate="ma
+00026fd0: 6e79 5f74 6f5f 6f6e 6522 290a 2020 2020  ny_to_one").    
+00026fe0: 2020 2020 2020 2020 2320 6466 203d 2070          # df = p
+00026ff0: 642e 6d65 7267 6528 6466 2c20 6466 5f6f  d.merge(df, df_o
+00027000: 7065 6e54 696d 6573 2c20 686f 773d 226c  penTimes, how="l
+00027010: 6566 7422 2c20 6f6e 3d22 5f64 6174 6522  eft", on="_date"
+00027020: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00027030: 6466 2e69 6e64 6578 203d 2064 665b 225f  df.index = df["_
+00027040: 696e 6465 7842 6163 6b75 7022 5d20 3b20  indexBackup"] ; 
+00027050: 6466 2e69 6e64 6578 2e6e 616d 6520 3d20  df.index.name = 
+00027060: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00027070: 2023 2023 202d 2063 6f72 7265 6374 2064   # # - correct d
+00027080: 6976 6964 656e 6473 0a20 2020 2020 2020  ividends.       
+00027090: 2020 2020 2023 2064 662e 6c6f 635b 6466       # df.loc[df
+000270a0: 2e69 6e64 6578 2e74 696d 6520 213d 2064  .index.time != d
+000270b0: 665b 225f 6f70 656e 5f74 696d 6522 5d2c  f["_open_time"],
+000270c0: 2022 4469 7669 6465 6e64 7322 5d20 3d20   "Dividends"] = 
+000270d0: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
+000270e0: 2320 6466 203d 2064 662e 6472 6f70 2822  # df = df.drop("
+000270f0: 5f6f 7065 6e5f 7469 6d65 222c 2061 7869  _open_time", axi
+00027100: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
+00027110: 2023 2055 5044 4154 453a 206b 6565 7020   # UPDATE: keep 
+00027120: 6f72 6967 696e 616c 2064 6976 6964 656e  original dividen
+00027130: 6473 2c20 6f6e 6c79 2074 7261 6e73 6665  ds, only transfe
+00027140: 7220 4344 4620 2620 4353 460a 2020 2020  r CDF & CSF.    
+00027150: 2020 2020 2020 2020 2320 436f 7079 206f          # Copy o
+00027160: 7665 7220 4353 4620 616e 6420 4344 4620  ver CSF and CDF 
+00027170: 746f 6f20 6672 6f6d 2064 6169 6c79 0a20  too from daily. 
+00027180: 2020 2020 2020 2020 2020 2064 6620 3d20             df = 
+00027190: 7064 2e6d 6572 6765 2864 662c 2064 665f  pd.merge(df, df_
+000271a0: 6461 696c 795f 7261 775f 6475 7269 6e67  daily_raw_during
+000271b0: 5f64 5b5b 2243 4446 222c 2022 4353 4622  _d[["CDF", "CSF"
+000271c0: 5d5d 2c20 686f 773d 226c 6566 7422 2c20  ]], how="left", 
+000271d0: 6f6e 3d22 5f64 6174 6522 2c20 7661 6c69  on="_date", vali
+000271e0: 6461 7465 3d22 6d61 6e79 5f74 6f5f 6f6e  date="many_to_on
+000271f0: 6522 290a 2020 2020 2020 2020 2020 2020  e").            
+00027200: 6466 2e69 6e64 6578 203d 2064 665b 225f  df.index = df["_
+00027210: 696e 6465 7842 6163 6b75 7022 5d20 3b20  indexBackup"] ; 
+00027220: 6466 2e69 6e64 6578 2e6e 616d 6520 3d20  df.index.name = 
+00027230: 4e6f 6e65 203b 2064 6620 3d20 6466 2e64  None ; df = df.d
+00027240: 726f 7028 5b22 5f69 6e64 6578 4261 636b  rop(["_indexBack
+00027250: 7570 222c 2022 5f64 6174 6522 5d2c 2061  up", "_date"], a
+00027260: 7869 733d 3129 0a20 2020 2020 2020 2020  xis=1).         
+00027270: 2020 2063 6466 203d 2064 665b 2243 4446     cdf = df["CDF
+00027280: 225d 0a20 2020 2020 2020 2020 2020 2064  "].            d
+00027290: 665b 2241 646a 2043 6c6f 7365 225d 203d  f["Adj Close"] =
+000272a0: 2064 665b 2243 6c6f 7365 225d 202a 2063   df["Close"] * c
+000272b0: 6466 0a20 2020 2020 2020 2020 2020 2063  df.            c
+000272c0: 7366 203d 2064 665b 2243 5346 225d 0a0a  sf = df["CSF"]..
+000272d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000272e0: 6f74 2064 665f 6461 696c 795f 706f 7374  ot df_daily_post
+000272f0: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+00027300: 2020 2020 2020 2020 706f 7374 5f63 7366          post_csf
+00027310: 203d 2079 6663 752e 4765 7443 5346 3028   = yfcu.GetCSF0(
+00027320: 6466 5f64 6169 6c79 5f70 6f73 7429 0a0a  df_daily_post)..
+00027330: 2020 2020 2020 2020 656c 6966 2073 656c          elif sel
+00027340: 662e 696e 7465 7276 616c 203d 3d20 7966  f.interval == yf
+00027350: 6364 2e49 6e74 6572 7661 6c2e 5765 656b  cd.Interval.Week
+00027360: 3a0a 2020 2020 2020 2020 2020 2020 6466  :.            df
+00027370: 5f64 6169 6c79 203d 2068 6973 7444 6169  _daily = histDai
+00027380: 6c79 2e67 6574 2873 7461 7274 3d64 662e  ly.get(start=df.
+00027390: 696e 6465 785b 2d31 5d2e 6461 7465 2829  index[-1].date()
+000273a0: 2b74 645f 3764 2c20 7265 7061 6972 3d46  +td_7d, repair=F
+000273b0: 616c 7365 290a 2020 2020 2020 2020 2020  alse).          
+000273c0: 2020 6966 2028 6466 5f64 6169 6c79 2069    if (df_daily i
+000273d0: 7320 6e6f 7420 4e6f 6e65 2920 616e 6420  s not None) and 
+000273e0: 286e 6f74 2064 665f 6461 696c 792e 656d  (not df_daily.em
+000273f0: 7074 7929 3a0a 2020 2020 2020 2020 2020  pty):.          
+00027400: 2020 2020 2020 706f 7374 5f63 7366 203d        post_csf =
+00027410: 2079 6663 752e 4765 7443 5346 3028 6466   yfcu.GetCSF0(df
+00027420: 5f64 6169 6c79 290a 2020 2020 2020 2020  _daily).        
+00027430: 2020 2020 2020 2020 6966 2064 6562 7567          if debug
+00027440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027450: 2020 2020 2020 7072 696e 7428 222d 2070        print("- p
+00027460: 6f73 745f 6373 6620 6f66 2064 6169 6c79  ost_csf of daily
+00027470: 2064 6174 6520 7261 6e67 6520 7b7d 2d3e   date range {}->
+00027480: 7b7d 203d 207b 7d22 2e66 6f72 6d61 7428  {} = {}".format(
+00027490: 6466 5f64 6169 6c79 2e69 6e64 6578 5b30  df_daily.index[0
+000274a0: 5d2c 2064 665f 6461 696c 792e 696e 6465  ], df_daily.inde
+000274b0: 785b 2d31 5d2c 2070 6f73 745f 6373 6629  x[-1], post_csf)
+000274c0: 290a 0a20 2020 2020 2020 2065 6c69 6620  )..        elif 
+000274d0: 7365 6c66 2e69 6e74 6572 7661 6c20 696e  self.interval in
+000274e0: 205b 7966 6364 2e49 6e74 6572 7661 6c2e   [yfcd.Interval.
+000274f0: 4d6f 6e74 6873 312c 2079 6663 642e 496e  Months1, yfcd.In
+00027500: 7465 7276 616c 2e4d 6f6e 7468 7333 5d3a  terval.Months3]:
+00027510: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00027520: 7365 2045 7863 6570 7469 6f6e 2822 6e6f  se Exception("no
+00027530: 7420 696d 706c 656d 656e 7465 6422 290a  t implemented").
+00027540: 0a20 2020 2020 2020 2023 2049 6620 2764  .        # If 'd
+00027550: 6627 2064 6f65 7320 6e6f 7420 636f 6e74  f' does not cont
+00027560: 6169 6e20 616c 6c20 7374 6f63 6b20 7370  ain all stock sp
+00027570: 6c69 7473 2075 6e74 696c 2070 7265 7365  lits until prese
+00027580: 6e74 2c20 7468 656e 0a20 2020 2020 2020  nt, then.       
+00027590: 2023 2073 6574 2027 706f 7374 5f63 7366   # set 'post_csf
+000275a0: 2720 746f 2063 756d 756c 6174 6976 6520  ' to cumulative 
+000275b0: 7374 6f63 6b20 7370 6c69 7420 6661 6374  stock split fact
+000275c0: 6f72 206a 7573 7420 6166 7465 7220 6c61  or just after la
+000275d0: 7374 2027 6466 2720 6461 7465 0a20 2020  st 'df' date.   
+000275e0: 2020 2020 2073 706c 6974 735f 706f 7374       splits_post
+000275f0: 203d 2073 656c 662e 6d61 6e61 6765 722e   = self.manager.
+00027600: 4765 7448 6973 746f 7279 2822 4576 656e  GetHistory("Even
+00027610: 7473 2229 2e47 6574 5370 6c69 7473 2873  ts").GetSplits(s
+00027620: 7461 7274 3d64 662e 696e 6465 785b 2d31  tart=df.index[-1
+00027630: 5d2e 6461 7465 2829 2b74 696d 6564 656c  ].date()+timedel
+00027640: 7461 2864 6179 733d 3129 290a 2020 2020  ta(days=1)).    
+00027650: 2020 2020 6966 2073 706c 6974 735f 706f      if splits_po
+00027660: 7374 2069 7320 6e6f 7420 4e6f 6e65 3a0a  st is not None:.
+00027670: 2020 2020 2020 2020 2020 2020 706f 7374              post
+00027680: 5f63 7366 203d 2031 2e30 2f73 706c 6974  _csf = 1.0/split
+00027690: 735f 706f 7374 5b22 5374 6f63 6b20 5370  s_post["Stock Sp
+000276a0: 6c69 7473 225d 2e70 726f 6428 290a 2020  lits"].prod().  
+000276b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000276c0: 2020 2020 2020 2020 706f 7374 5f63 7366          post_csf
+000276d0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+000276e0: 2023 2043 756d 756c 6174 6976 6520 6469   # Cumulative di
+000276f0: 7669 6465 6e64 2066 6163 746f 720a 2020  vidend factor.  
+00027700: 2020 2020 2020 6966 2063 6466 2069 7320        if cdf is 
+00027710: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00027720: 2020 665f 6e6e 6120 3d20 7e64 665b 2243    f_nna = ~df["C
+00027730: 6c6f 7365 225d 2e69 736e 6128 290a 2020  lose"].isna().  
+00027740: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00027750: 2066 5f6e 6e61 2e61 6e79 2829 3a0a 2020   f_nna.any():.  
+00027760: 2020 2020 2020 2020 2020 2020 2020 6364                cd
+00027770: 6620 3d20 312e 300a 2020 2020 2020 2020  f = 1.0.        
+00027780: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00027790: 2020 2020 2020 2020 2020 6364 6620 3d20            cdf = 
+000277a0: 6e70 2e66 756c 6c28 6466 2e73 6861 7065  np.full(df.shape
+000277b0: 5b30 5d2c 206e 702e 6e61 6e29 0a20 2020  [0], np.nan).   
+000277c0: 2020 2020 2020 2020 2020 2020 2063 6466               cdf
+000277d0: 5b66 5f6e 6e61 5d20 3d20 6466 2e6c 6f63  [f_nna] = df.loc
+000277e0: 5b66 5f6e 6e61 2c20 2241 646a 2043 6c6f  [f_nna, "Adj Clo
+000277f0: 7365 225d 202f 2064 662e 6c6f 635b 665f  se"] / df.loc[f_
+00027800: 6e6e 612c 2022 436c 6f73 6522 5d0a 2020  nna, "Close"].  
+00027810: 2020 2020 2020 2020 2020 2020 2020 6364                cd
+00027820: 6620 3d20 7064 2e53 6572 6965 7328 6364  f = pd.Series(cd
+00027830: 6629 2e66 696c 6c6e 6128 6d65 7468 6f64  f).fillna(method
+00027840: 3d22 6266 696c 6c22 292e 6669 6c6c 6e61  ="bfill").fillna
+00027850: 286d 6574 686f 643d 2266 6669 6c6c 2229  (method="ffill")
+00027860: 2e74 6f5f 6e75 6d70 7928 290a 0a20 2020  .to_numpy()..   
+00027870: 2020 2020 2023 2043 756d 756c 6174 6976       # Cumulativ
+00027880: 6520 7374 6f63 6b2d 7370 6c69 7420 6661  e stock-split fa
+00027890: 6374 6f72 0a20 2020 2020 2020 2069 6620  ctor.        if 
+000278a0: 6373 6620 6973 204e 6f6e 653a 0a20 2020  csf is None:.   
+000278b0: 2020 2020 2020 2020 2073 7320 3d20 6466           ss = df
+000278c0: 5b22 5374 6f63 6b20 5370 6c69 7473 225d  ["Stock Splits"]
+000278d0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+000278e0: 2020 2020 7373 5b28 7373 203d 3d20 302e      ss[(ss == 0.
+000278f0: 3029 207c 2073 732e 6973 6e61 2829 5d20  0) | ss.isna()] 
+00027900: 3d20 312e 300a 2020 2020 2020 2020 2020  = 1.0.          
+00027910: 2020 7373 5f72 6370 203d 2031 2e30 202f    ss_rcp = 1.0 /
+00027920: 2073 730a 2020 2020 2020 2020 2020 2020   ss.            
+00027930: 6373 6620 3d20 7373 5f72 6370 2e73 6f72  csf = ss_rcp.sor
+00027940: 745f 696e 6465 7828 6173 6365 6e64 696e  t_index(ascendin
+00027950: 673d 4661 6c73 6529 2e63 756d 7072 6f64  g=False).cumprod
+00027960: 2829 2e73 6f72 745f 696e 6465 7828 6173  ().sort_index(as
+00027970: 6365 6e64 696e 673d 5472 7565 292e 7368  cending=True).sh
+00027980: 6966 7428 2d31 2c20 6669 6c6c 5f76 616c  ift(-1, fill_val
+00027990: 7565 3d31 2e30 290a 2020 2020 2020 2020  ue=1.0).        
+000279a0: 2020 2020 6966 2070 6f73 745f 6373 6620      if post_csf 
+000279b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000279c0: 2020 2020 2020 2020 2020 2020 2063 7366               csf
+000279d0: 202a 3d20 706f 7374 5f63 7366 0a20 2020   *= post_csf.   
+000279e0: 2020 2020 2063 7366 5f72 6370 203d 2031       csf_rcp = 1
+000279f0: 2e30 202f 2063 7366 0a0a 2020 2020 2020  .0 / csf..      
+00027a00: 2020 2320 5265 7665 7273 6520 5961 686f    # Reverse Yaho
+00027a10: 6f27 7320 7370 6c69 7420 6164 6a75 7374  o's split adjust
+00027a20: 6d65 6e74 3a0a 2020 2020 2020 2020 6461  ment:.        da
+00027a30: 7461 5f63 6f6c 7320 3d20 5b22 4f70 656e  ta_cols = ["Open
+00027a40: 222c 2022 4869 6768 222c 2022 4c6f 7722  ", "High", "Low"
+00027a50: 2c20 2243 6c6f 7365 222c 2022 4469 7669  , "Close", "Divi
+00027a60: 6465 6e64 7322 5d0a 2020 2020 2020 2020  dends"].        
+00027a70: 666f 7220 6463 2069 6e20 6461 7461 5f63  for dc in data_c
+00027a80: 6f6c 733a 0a20 2020 2020 2020 2020 2020  ols:.           
+00027a90: 2064 665b 6463 5d20 3d20 6466 5b64 635d   df[dc] = df[dc]
+00027aa0: 202a 2063 7366 5f72 6370 0a20 2020 2020   * csf_rcp.     
+00027ab0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+00027ac0: 6e74 6572 6461 793a 0a20 2020 2020 2020  nterday:.       
+00027ad0: 2020 2020 2023 2044 6f6e 2774 206e 6565       # Don't nee
+00027ae0: 6420 746f 2064 652d 7370 6c69 7420 766f  d to de-split vo
+00027af0: 6c75 6d65 2064 6174 6120 6265 6361 7573  lume data becaus
+00027b00: 6520 5961 686f 6f20 616c 7761 7973 2072  e Yahoo always r
+00027b10: 6574 7572 6e73 2069 6e74 6572 6461 7920  eturns interday 
+00027b20: 766f 6c75 6d65 2075 6e61 646a 7573 7465  volume unadjuste
+00027b30: 640a 2020 2020 2020 2020 2020 2020 7061  d.            pa
+00027b40: 7373 0a20 2020 2020 2020 2065 6c73 653a  ss.        else:
+00027b50: 0a20 2020 2020 2020 2020 2020 2064 665b  .            df[
+00027b60: 2256 6f6c 756d 6522 5d20 2a3d 2063 7366  "Volume"] *= csf
+00027b70: 0a0a 2020 2020 2020 2020 6966 2064 665b  ..        if df[
+00027b80: 2256 6f6c 756d 6522 5d2e 6474 7970 6520  "Volume"].dtype 
+00027b90: 213d 2027 696e 7436 3427 3a0a 2020 2020  != 'int64':.    
+00027ba0: 2020 2020 2020 2020 6466 5b22 566f 6c75          df["Volu
+00027bb0: 6d65 225d 203d 2064 665b 2256 6f6c 756d  me"] = df["Volum
+00027bc0: 6522 5d2e 726f 756e 6428 3029 2e61 7374  e"].round(0).ast
+00027bd0: 7970 6528 2769 6e74 2729 0a0a 2020 2020  ype('int')..    
+00027be0: 2020 2020 2320 4472 6f70 2027 4164 6a20      # Drop 'Adj 
+00027bf0: 436c 6f73 6527 2c20 7265 706c 6163 6520  Close', replace 
+00027c00: 7769 7468 2073 6361 6c69 6e67 2066 6163  with scaling fac
+00027c10: 746f 7273 3a0a 2020 2020 2020 2020 6466  tors:.        df
+00027c20: 203d 2064 662e 6472 6f70 2822 4164 6a20   = df.drop("Adj 
+00027c30: 436c 6f73 6522 2c20 6178 6973 3d31 290a  Close", axis=1).
+00027c40: 2020 2020 2020 2020 6466 5b22 4353 4622          df["CSF"
+00027c50: 5d20 3d20 6373 660a 2020 2020 2020 2020  ] = csf.        
+00027c60: 6466 5b22 4344 4622 5d20 3d20 6364 660a  df["CDF"] = cdf.
+00027c70: 0a20 2020 2020 2020 2068 5f6c 6173 7444  .        h_lastD
+00027c80: 6976 4164 6a75 7374 4474 203d 2070 642e  ivAdjustDt = pd.
+00027c90: 5469 6d65 7374 616d 702e 7574 636e 6f77  Timestamp.utcnow
+00027ca0: 2829 2e74 7a5f 636f 6e76 6572 7428 5a6f  ().tz_convert(Zo
+00027cb0: 6e65 496e 666f 2822 5554 4322 2929 0a20  neInfo("UTC")). 
+00027cc0: 2020 2020 2020 2068 5f6c 6173 7453 706c         h_lastSpl
+00027cd0: 6974 4164 6a75 7374 4474 203d 2068 5f6c  itAdjustDt = h_l
+00027ce0: 6173 7444 6976 4164 6a75 7374 4474 0a20  astDivAdjustDt. 
+00027cf0: 2020 2020 2020 2064 665b 224c 6173 7444         df["LastD
+00027d00: 6976 4164 6a75 7374 4474 225d 203d 2068  ivAdjustDt"] = h
+00027d10: 5f6c 6173 7444 6976 4164 6a75 7374 4474  _lastDivAdjustDt
+00027d20: 0a20 2020 2020 2020 2064 665b 224c 6173  .        df["Las
+00027d30: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
+00027d40: 203d 2068 5f6c 6173 7453 706c 6974 4164   = h_lastSplitAd
+00027d50: 6a75 7374 4474 0a0a 2020 2020 2020 2020  justDt..        
+00027d60: 6966 2064 6562 7567 3a0a 2020 2020 2020  if debug:.      
+00027d70: 2020 2020 2020 7072 696e 7428 222d 2075        print("- u
+00027d80: 6e61 646a 7573 7465 643a 2229 0a20 2020  nadjusted:").   
+00027d90: 2020 2020 2020 2020 2070 7269 6e74 2864           print(d
+00027da0: 665b 5b22 436c 6f73 6522 2c20 2244 6976  f[["Close", "Div
+00027db0: 6964 656e 6473 222c 2022 566f 6c75 6d65  idends", "Volume
+00027dc0: 222c 2022 4353 4622 2c20 2243 4446 225d  ", "CSF", "CDF"]
+00027dd0: 5d29 0a20 2020 2020 2020 2020 2020 2066  ]).            f
+00027de0: 203d 2064 665b 2244 6976 6964 656e 6473   = df["Dividends
+00027df0: 225d 2021 3d20 302e 300a 2020 2020 2020  "] != 0.0.      
+00027e00: 2020 2020 2020 6966 2066 2e61 6e79 2829        if f.any()
+00027e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027e20: 2020 7072 696e 7428 222d 2064 6976 6964    print("- divid
+00027e30: 656e 6473 3a22 290a 2020 2020 2020 2020  ends:").        
+00027e40: 2020 2020 2020 2020 7072 696e 7428 6466          print(df
+00027e50: 2e6c 6f63 5b66 2c20 5b22 4f70 656e 222c  .loc[f, ["Open",
+00027e60: 2022 4c6f 7722 2c20 2248 6967 6822 2c20   "Low", "High", 
+00027e70: 2243 6c6f 7365 222c 2022 4469 7669 6465  "Close", "Divide
+00027e80: 6e64 7322 2c20 2256 6f6c 756d 6522 2c20  nds", "Volume", 
+00027e90: 2243 5346 222c 2022 4344 4622 5d5d 290a  "CSF", "CDF"]]).
+00027ea0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00027eb0: 7428 2222 290a 0a20 2020 2020 2020 206c  t("")..        l
+00027ec0: 6f67 5f6d 7367 203d 2066 2250 4d3a 3a5f  og_msg = f"PM::_
+00027ed0: 7265 7665 7273 6559 6168 6f6f 4164 6a75  reverseYahooAdju
+00027ee0: 7374 2d7b 7365 6c66 2e69 7374 727d 2829  st-{self.istr}()
+00027ef0: 2072 6574 7572 6e69 6e67 220a 2020 2020   returning".    
+00027f00: 2020 2020 6966 2079 6663 6c2e 4973 5472      if yfcl.IsTr
+00027f10: 6163 696e 6745 6e61 626c 6564 2829 3a0a  acingEnabled():.
+00027f20: 2020 2020 2020 2020 2020 2020 7966 636c              yfcl
+00027f30: 2e54 7261 6365 4578 6974 286c 6f67 5f6d  .TraceExit(log_m
+00027f40: 7367 290a 2020 2020 2020 2020 656c 6966  sg).        elif
+00027f50: 2064 6562 7567 3a0a 2020 2020 2020 2020   debug:.        
+00027f60: 2020 2020 7072 696e 7428 6c6f 675f 6d73      print(log_ms
+00027f70: 6729 0a0a 2020 2020 2020 2020 6966 2064  g)..        if d
+00027f80: 6562 7567 3a0a 2020 2020 2020 2020 2020  ebug:.          
+00027f90: 2020 7072 696e 7428 6466 5b5b 224f 7065    print(df[["Ope
+00027fa0: 6e22 2c20 224c 6f77 222c 2022 4869 6768  n", "Low", "High
+00027fb0: 222c 2022 436c 6f73 6522 2c20 2244 6976  ", "Close", "Div
+00027fc0: 6964 656e 6473 222c 2022 566f 6c75 6d65  idends", "Volume
+00027fd0: 222c 2022 4353 4622 5d5d 290a 0a20 2020  ", "CSF"]])..   
+00027fe0: 2020 2020 2072 6574 7572 6e20 6466 0a0a       return df..
+00027ff0: 2020 2020 6465 6620 5f61 7070 6c79 4e65      def _applyNe
+00028000: 7745 7665 6e74 7328 7365 6c66 293a 0a20  wEvents(self):. 
+00028010: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
+00028020: 2069 7320 4e6f 6e65 206f 7220 7365 6c66   is None or self
+00028030: 2e68 2e65 6d70 7479 3a0a 2020 2020 2020  .h.empty:.      
+00028040: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00028050: 2020 2020 2020 6465 6275 6720 3d20 4661        debug = Fa
+00028060: 6c73 650a 2020 2020 2020 2020 2320 6465  lse.        # de
+00028070: 6275 6720 3d20 5472 7565 0a0a 2020 2020  bug = True..    
+00028080: 2020 2020 685f 6d6f 6469 6669 6564 203d      h_modified =
+00028090: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+000280a0: 6c6f 675f 6d73 6720 3d20 6622 504d 3a3a  log_msg = f"PM::
+000280b0: 5f61 7070 6c79 4e65 7745 7665 6e74 7328  _applyNewEvents(
+000280c0: 292d 7b73 656c 662e 6973 7472 7d22 0a20  )-{self.istr}". 
+000280d0: 2020 2020 2020 2069 6620 7966 636c 2e49         if yfcl.I
+000280e0: 7354 7261 6369 6e67 456e 6162 6c65 6428  sTracingEnabled(
+000280f0: 293a 0a20 2020 2020 2020 2020 2020 2079  ):.            y
+00028100: 6663 6c2e 5472 6163 6545 6e74 6572 286c  fcl.TraceEnter(l
+00028110: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
+00028120: 2023 2042 6163 6b70 6f72 7420 6e65 7720   # Backport new 
+00028130: 7370 6c69 7473 2061 6372 6f73 7320 656e  splits across en
+00028140: 7469 7265 2068 2074 6162 6c65 0a20 2020  tire h table.   
+00028150: 2020 2020 206c 6173 7453 706c 6974 4164       lastSplitAd
+00028160: 6a75 7374 4474 5f6d 696e 203d 2073 656c  justDt_min = sel
+00028170: 662e 685b 224c 6173 7453 706c 6974 4164  f.h["LastSplitAd
+00028180: 6a75 7374 4474 225d 2e6d 696e 2829 0a20  justDt"].min(). 
+00028190: 2020 2020 2020 2073 706c 6974 735f 7369         splits_si
+000281a0: 6e63 6520 3d20 7365 6c66 2e6d 616e 6167  nce = self.manag
+000281b0: 6572 2e47 6574 4869 7374 6f72 7928 2245  er.GetHistory("E
+000281c0: 7665 6e74 7322 292e 4765 7453 706c 6974  vents").GetSplit
+000281d0: 7346 6574 6368 6564 5369 6e63 6528 6c61  sFetchedSince(la
+000281e0: 7374 5370 6c69 7441 646a 7573 7444 745f  stSplitAdjustDt_
+000281f0: 6d69 6e29 0a20 2020 2020 2020 2069 6620  min).        if 
+00028200: 7370 6c69 7473 5f73 696e 6365 2069 7320  splits_since is 
+00028210: 6e6f 7420 4e6f 6e65 2061 6e64 206e 6f74  not None and not
+00028220: 2073 706c 6974 735f 7369 6e63 652e 656d   splits_since.em
+00028230: 7074 793a 0a20 2020 2020 2020 2020 2020  pty:.           
+00028240: 2066 5f73 7570 203d 2073 706c 6974 735f   f_sup = splits_
+00028250: 7369 6e63 655b 2253 7570 6572 7365 6465  since["Supersede
+00028260: 6420 7370 6c69 7422 5d20 213d 2030 2e30  d split"] != 0.0
+00028270: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028280: 665f 7375 702e 616e 7928 293a 0a20 2020  f_sup.any():.   
+00028290: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000282a0: 2064 7420 696e 2073 706c 6974 735f 7369   dt in splits_si
+000282b0: 6e63 652e 696e 6465 785b 665f 7375 705d  nce.index[f_sup]
+000282c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000282d0: 2020 2020 2020 7370 6c69 7420 3d20 7370        split = sp
+000282e0: 6c69 7473 5f73 696e 6365 2e6c 6f63 5b64  lits_since.loc[d
+000282f0: 745d 0a20 2020 2020 2020 2020 2020 2020  t].             
+00028300: 2020 2020 2020 2064 6966 6620 3d20 2873         diff = (s
+00028310: 656c 662e 685b 224c 6173 7453 706c 6974  elf.h["LastSplit
+00028320: 4164 6a75 7374 4474 225d 202d 2073 706c  AdjustDt"] - spl
+00028330: 6974 5b22 5375 7065 7273 6564 6564 2073  it["Superseded s
+00028340: 706c 6974 2046 6574 6368 4461 7465 225d  plit FetchDate"]
+00028350: 292e 6162 7328 290a 2020 2020 2020 2020  ).abs().        
+00028360: 2020 2020 2020 2020 2020 2020 6620 3d20              f = 
+00028370: 6469 6666 203c 2070 642e 5469 6d65 6465  diff < pd.Timede
+00028380: 6c74 6128 2231 3573 2229 0a20 2020 2020  lta("15s").     
+00028390: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000283a0: 6620 6e6f 7420 662e 616e 7928 293a 0a20  f not f.any():. 
+000283b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000283c0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+000283d0: 6e74 6572 7661 6c20 213d 2079 6663 642e  nterval != yfcd.
+000283e0: 496e 7465 7276 616c 2e44 6179 7331 3a0a  Interval.Days1:.
+000283f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028400: 2020 2020 2020 2020 2020 2020 2320 5072              # Pr
+00028410: 6f62 6162 6c79 206f 6b2c 2061 7373 756d  obably ok, assum
+00028420: 696e 6720 7375 7065 7273 6564 6564 2073  ing superseded s
+00028430: 706c 6974 2077 6173 206e 6576 6572 2061  plit was never a
+00028440: 7070 6c69 6564 2074 6f20 7468 6973 2070  pplied to this p
+00028450: 7269 6365 2064 6174 610a 2020 2020 2020  rice data.      
+00028460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028470: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00028480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028490: 2020 2020 2020 2070 7269 6e74 2873 706c         print(spl
+000284a0: 6974 290a 2020 2020 2020 2020 2020 2020  it).            
+000284b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000284c0: 6520 4578 6365 7074 696f 6e28 6622 466f  e Exception(f"Fo
+000284d0: 7220 7375 7065 7273 6564 6564 2073 706c  r superseded spl
+000284e0: 6974 2061 626f 7665 2c20 6661 696c 6564  it above, failed
+000284f0: 2074 6f20 6964 656e 7469 6679 2072 6f77   to identify row
+00028500: 7320 746f 2075 6e64 6f2e 2050 726f 626c  s to undo. Probl
+00028510: 656d 3f22 290a 2020 2020 2020 2020 2020  em?").          
+00028520: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00028530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028540: 2020 2020 2020 2020 2320 4e65 7874 2063          # Next c
+00028550: 6865 636b 3a20 6578 7065 6374 2063 6163  heck: expect cac
+00028560: 6865 6420 4353 4620 213d 2031 2e30 0a20  hed CSF != 1.0. 
+00028570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028580: 2020 2020 2020 2066 3120 3d20 7365 6c66         f1 = self
+00028590: 2e68 2e6c 6f63 5b66 2c20 2243 5346 225d  .h.loc[f, "CSF"]
+000285a0: 203d 3d20 312e 300a 2020 2020 2020 2020   == 1.0.        
+000285b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000285c0: 6966 2066 312e 616e 7928 293a 0a20 2020  if f1.any():.   
+000285d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000285e0: 2020 2020 2020 2020 2070 7269 6e74 2873           print(s
+000285f0: 706c 6974 290a 2020 2020 2020 2020 2020  plit).          
+00028600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028610: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+00028620: 6e28 6622 466f 7220 7375 7065 7273 6564  n(f"For supersed
+00028630: 6564 2073 706c 6974 2061 626f 7665 2c20  ed split above, 
+00028640: 6174 7465 6d70 7469 6e67 2074 6f20 756e  attempting to un
+00028650: 646f 2073 706c 6974 2d61 646a 7573 7420  do split-adjust 
+00028660: 6672 6f6d 2072 6f77 7320 7768 6572 6520  from rows where 
+00028670: 4353 463d 312e 2049 6e76 6573 7469 6761  CSF=1. Investiga
+00028680: 7465 2e22 290a 0a20 2020 2020 2020 2020  te.")..         
+00028690: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000286a0: 6f67 5f6d 7367 203d 2066 227b 7365 6c66  og_msg = f"{self
+000286b0: 2e69 7374 727d 3a20 5265 7665 7273 696e  .istr}: Reversin
+000286c0: 6720 7370 6c69 7420 5b64 743d 7b64 742e  g split [dt={dt.
+000286d0: 6461 7465 2829 7d20 7b73 706c 6974 5b27  date()} {split['
+000286e0: 5375 7065 7273 6564 6564 2073 706c 6974  Superseded split
+000286f0: 275d 7d20 6665 7463 683d 7b73 706c 6974  ']} fetch={split
+00028700: 5b27 5375 7065 7273 6564 6564 2073 706c  ['Superseded spl
+00028710: 6974 2046 6574 6368 4461 7465 275d 2e73  it FetchDate'].s
+00028720: 7472 6674 696d 6528 2725 592d 256d 2d25  trftime('%Y-%m-%
+00028730: 6420 2548 3a25 4d3a 2553 257a 2729 7d5d  d %H:%M:%S%z')}]
+00028740: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00028750: 2020 2020 2020 2020 2020 696e 6469 6365            indice
+00028760: 7320 3d20 6e70 2e77 6865 7265 2866 295b  s = np.where(f)[
+00028770: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00028780: 2020 2020 2020 2020 2020 206c 6f67 5f6d             log_m
+00028790: 7367 202b 3d20 6622 2066 726f 6d20 696e  sg += f" from in
+000287a0: 7465 7276 616c 7320 220a 2020 2020 2020  tervals ".      
+000287b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000287c0: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
+000287d0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+000287e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000287f0: 6c6f 675f 6d73 6720 2b3d 2066 227b 7365  log_msg += f"{se
+00028800: 6c66 2e68 2e69 6e64 6578 5b69 6e64 6963  lf.h.index[indic
+00028810: 6573 5b30 5d5d 2e64 6174 6528 297d 202d  es[0]].date()} -
+00028820: 3e20 7b73 656c 662e 682e 696e 6465 785b  > {self.h.index[
+00028830: 696e 6469 6365 735b 2d31 5d5d 2e64 6174  indices[-1]].dat
+00028840: 6528 297d 2028 696e 6329 220a 2020 2020  e()} (inc)".    
+00028850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028860: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00028870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028880: 2020 2020 2020 6c6f 675f 6d73 6720 2b3d        log_msg +=
+00028890: 2066 227b 7365 6c66 2e68 2e69 6e64 6578   f"{self.h.index
+000288a0: 5b69 6e64 6963 6573 5b30 5d5d 7d20 2d3e  [indices[0]]} ->
+000288b0: 207b 7365 6c66 2e68 2e69 6e64 6578 5b69   {self.h.index[i
+000288c0: 6e64 6963 6573 5b2d 315d 5d7d 220a 2020  ndices[-1]]}".  
+000288d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000288e0: 2020 2020 2020 685f 6c61 7374 526f 7720        h_lastRow 
+000288f0: 3d20 7365 6c66 2e68 2e6c 6f63 5b73 656c  = self.h.loc[sel
+00028900: 662e 682e 696e 6465 785b 696e 6469 6365  f.h.index[indice
+00028910: 735b 2d31 5d5d 5d0a 2020 2020 2020 2020  s[-1]]].        
+00028920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028930: 6c6f 675f 6d73 6720 2b3d 2066 222e 204c  log_msg += f". L
+00028940: 6173 7420 4353 4620 3d20 7b68 5f6c 6173  ast CSF = {h_las
+00028950: 7452 6f77 5b27 4353 4627 5d3a 2e35 667d  tRow['CSF']:.5f}
+00028960: 2040 207b 685f 6c61 7374 526f 775b 274c   @ {h_lastRow['L
+00028970: 6173 7453 706c 6974 4164 6a75 7374 4474  astSplitAdjustDt
+00028980: 275d 2e73 7472 6674 696d 6528 2725 592d  '].strftime('%Y-
+00028990: 256d 2d25 6420 2548 3a25 4d3a 2553 257a  %m-%d %H:%M:%S%z
+000289a0: 2729 7d22 0a20 2020 2020 2020 2020 2020  ')}".           
+000289b0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000289c0: 662e 6d61 6e61 6765 722e 4c6f 6745 7665  f.manager.LogEve
+000289d0: 6e74 2822 696e 666f 222c 2022 5072 6963  nt("info", "Pric
+000289e0: 654d 616e 6167 6572 222c 206c 6f67 5f6d  eManager", log_m
+000289f0: 7367 290a 2020 2020 2020 2020 2020 2020  sg).            
+00028a00: 2020 2020 2020 2020 2020 2020 6966 2079              if y
+00028a10: 6663 6c2e 4973 5472 6163 696e 6745 6e61  fcl.IsTracingEna
+00028a20: 626c 6564 2829 3a0a 2020 2020 2020 2020  bled():.        
+00028a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028a40: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
+00028a50: 696e 7428 6c6f 675f 6d73 6729 0a20 2020  int(log_msg).   
+00028a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028a70: 2020 2020 2065 6c69 6620 6465 6275 673a       elif debug:
+00028a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028a90: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00028aa0: 6e74 2866 2255 6e64 6f6e 6520 7375 7065  nt(f"Undone supe
+00028ab0: 7273 6564 6564 2073 706c 6974 2040 207b  rseded split @ {
+00028ac0: 6474 7d3a 2229 0a20 2020 2020 2020 2020  dt}:").         
+00028ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ae0: 2020 2070 7269 6e74 2873 656c 662e 682e     print(self.h.
+00028af0: 6c6f 635b 662c 205b 2243 5346 222c 2022  loc[f, ["CSF", "
+00028b00: 4665 7463 6844 6174 6522 2c20 224c 6173  FetchDate", "Las
+00028b10: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
+00028b20: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00028b30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00028b40: 7269 6e74 2822 2229 0a0a 2020 2020 2020  rint("")..      
+00028b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b60: 2020 7365 6c66 2e68 2e6c 6f63 5b66 2c20    self.h.loc[f, 
+00028b70: 2243 5346 225d 202a 3d20 7370 6c69 745b  "CSF"] *= split[
+00028b80: 2253 746f 636b 2053 706c 6974 7322 5d0a  "Stock Splits"].
+00028b90: 0a20 2020 2020 2020 2020 2020 204c 6173  .            Las
+00028ba0: 7453 706c 6974 4164 6a75 7374 4474 5f6e  tSplitAdjustDt_n
+00028bb0: 6577 203d 2073 656c 662e 685b 224c 6173  ew = self.h["Las
+00028bc0: 7453 706c 6974 4164 6a75 7374 4474 225d  tSplitAdjustDt"]
+00028bd0: 2e63 6f70 7928 290a 2020 2020 2020 2020  .copy().        
+00028be0: 2020 2020 666f 7220 6474 2069 6e20 7370      for dt in sp
+00028bf0: 6c69 7473 5f73 696e 6365 2e69 6e64 6578  lits_since.index
+00028c00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028c10: 2020 7370 6c69 7420 3d20 7370 6c69 7473    split = splits
+00028c20: 5f73 696e 6365 2e6c 6f63 5b64 745d 0a20  _since.loc[dt]. 
+00028c30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00028c40: 3120 3d20 7365 6c66 2e68 2e69 6e64 6578  1 = self.h.index
+00028c50: 203c 2064 740a 2020 2020 2020 2020 2020   < dt.          
+00028c60: 2020 2020 2020 6632 203d 2073 656c 662e        f2 = self.
+00028c70: 685b 224c 6173 7453 706c 6974 4164 6a75  h["LastSplitAdju
+00028c80: 7374 4474 225d 203c 2073 706c 6974 5b22  stDt"] < split["
+00028c90: 4665 7463 6844 6174 6522 5d0a 2020 2020  FetchDate"].    
+00028ca0: 2020 2020 2020 2020 2020 2020 6620 3d20              f = 
+00028cb0: 6631 2026 2066 320a 2020 2020 2020 2020  f1 & f2.        
+00028cc0: 2020 2020 2020 2020 6966 2066 2e61 6e79          if f.any
+00028cd0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00028ce0: 2020 2020 2020 2020 6d73 6720 3d20 6622          msg = f"
+00028cf0: 7b73 656c 662e 7469 636b 6572 7d3a 207b  {self.ticker}: {
+00028d00: 7365 6c66 2e69 7374 727d 3a20 4170 706c  self.istr}: Appl
+00028d10: 7969 6e67 2073 706c 6974 207b 7370 6c69  ying split {spli
+00028d20: 745b 2753 746f 636b 2053 706c 6974 7327  t['Stock Splits'
+00028d30: 5d7d 2040 207b 6474 2e64 6174 6528 297d  ]} @ {dt.date()}
+00028d40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00028d50: 2020 2020 2020 696e 6469 6365 7320 3d20        indices = 
+00028d60: 6e70 2e77 6865 7265 2866 295b 305d 0a20  np.where(f)[0]. 
+00028d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d80: 2020 206d 7367 202b 3d20 6622 2061 6372     msg += f" acr
+00028d90: 6f73 7320 696e 7465 7276 616c 7320 220a  oss intervals ".
+00028da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028db0: 2020 2020 6966 2073 656c 662e 696e 7465      if self.inte
+00028dc0: 7264 6179 3a0a 2020 2020 2020 2020 2020  rday:.          
+00028dd0: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00028de0: 6720 2b3d 2066 227b 7365 6c66 2e68 2e69  g += f"{self.h.i
+00028df0: 6e64 6578 5b69 6e64 6963 6573 5b30 5d5d  ndex[indices[0]]
+00028e00: 2e64 6174 6528 297d 202d 3e20 7b73 656c  .date()} -> {sel
+00028e10: 662e 682e 696e 6465 785b 696e 6469 6365  f.h.index[indice
+00028e20: 735b 2d31 5d5d 2e64 6174 6528 297d 2028  s[-1]].date()} (
+00028e30: 696e 6329 220a 2020 2020 2020 2020 2020  inc)".          
+00028e40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00028e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e60: 2020 2020 2020 2020 6d73 6720 2b3d 2066          msg += f
+00028e70: 227b 7365 6c66 2e68 2e69 6e64 6578 5b69  "{self.h.index[i
+00028e80: 6e64 6963 6573 5b30 5d5d 7d20 2d3e 207b  ndices[0]]} -> {
+00028e90: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
+00028ea0: 6963 6573 5b2d 315d 5d7d 220a 2020 2020  ices[-1]]}".    
+00028eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ec0: 6d73 6720 2b3d 2066 2220 6c61 7374 2043  msg += f" last C
+00028ed0: 5346 203d 207b 7365 6c66 2e68 5b27 4353  SF = {self.h['CS
+00028ee0: 4627 5d2e 696c 6f63 5b69 6e64 6963 6573  F'].iloc[indices
+00028ef0: 5b2d 315d 5d3a 2e35 667d 220a 2020 2020  [-1]]:.5f}".    
 00028f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f10: 2020 7365 6c66 2e6d 616e 6167 6572 2e4c    self.manager.L
-00028f20: 6f67 4576 656e 7428 2269 6e66 6f22 2c20  ogEvent("info", 
-00028f30: 2250 7269 6365 4d61 6e61 6765 7222 2c20  "PriceManager", 
-00028f40: 6c6f 675f 6d73 6729 0a20 2020 2020 2020  log_msg).       
-00028f50: 2020 2020 2020 2020 2020 2020 2079 6663               yfc
-00028f60: 6c2e 5472 6163 6550 7269 6e74 286c 6f67  l.TracePrint(log
-00028f70: 5f6d 7367 2920 6966 2079 6663 6c2e 4973  _msg) if yfcl.Is
-00028f80: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
-00028f90: 2065 6c73 6520 7072 696e 7428 6622 7b73   else print(f"{s
-00028fa0: 656c 662e 7469 636b 6572 7d3a 2022 2b6c  elf.ticker}: "+l
-00028fb0: 6f67 5f6d 7367 290a 0a20 2020 2020 2020  og_msg)..       
-00028fc0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00028fd0: 662e 682e 6c6f 635b 662c 2022 4344 4622  f.h.loc[f, "CDF"
-00028fe0: 5d20 2a3d 2064 6976 5b22 4261 636b 2041  ] *= div["Back A
-00028ff0: 646a 2e22 5d0a 2020 2020 2020 2020 2020  dj."].          
-00029000: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
-00029010: 2e6c 6f63 5b66 2c20 224c 6173 7444 6976  .loc[f, "LastDiv
-00029020: 4164 6a75 7374 4474 225d 203d 206e 702e  AdjustDt"] = np.
-00029030: 6d61 7869 6d75 6d28 7365 6c66 2e68 2e6c  maximum(self.h.l
-00029040: 6f63 5b66 2c20 224c 6173 7444 6976 4164  oc[f, "LastDivAd
-00029050: 6a75 7374 4474 225d 2c20 6469 765b 2246  justDt"], div["F
-00029060: 6574 6368 4461 7465 225d 290a 0a20 2020  etchDate"])..   
-00029070: 2020 2020 2020 2020 2068 5f6d 6f64 6966           h_modif
-00029080: 6965 6420 3d20 5472 7565 0a0a 2020 2020  ied = True..    
-00029090: 2020 2020 6966 2068 5f6d 6f64 6966 6965      if h_modifie
-000290a0: 643a 0a20 2020 2020 2020 2020 2020 2073  d:.            s
-000290b0: 656c 662e 5f75 7064 6174 6564 4361 6368  elf._updatedCach
-000290c0: 6564 5072 6963 6573 2873 656c 662e 6829  edPrices(self.h)
-000290d0: 0a                                       .
+00028f10: 6966 2079 6663 6c2e 4973 5472 6163 696e  if yfcl.IsTracin
+00028f20: 6745 6e61 626c 6564 2829 3a0a 2020 2020  gEnabled():.    
+00028f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f40: 2020 2020 7966 636c 2e54 7261 6365 5072      yfcl.TracePr
+00028f50: 696e 7428 6d73 6729 0a20 2020 2020 2020  int(msg).       
+00028f60: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00028f70: 6620 6465 6275 673a 0a20 2020 2020 2020  f debug:.       
+00028f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f90: 2070 7269 6e74 2866 227b 7365 6c66 2e74   print(f"{self.t
+00028fa0: 6963 6b65 727d 3a20 2220 2b20 6d73 6729  icker}: " + msg)
+00028fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028fc0: 2020 2020 206c 6f67 5f6d 7367 203d 2066       log_msg = f
+00028fd0: 227b 7365 6c66 2e69 7374 727d 3a20 4170  "{self.istr}: Ap
+00028fe0: 706c 7969 6e67 2073 706c 6974 205b 6474  plying split [dt
+00028ff0: 3d7b 6474 2e64 6174 6528 297d 207b 7370  ={dt.date()} {sp
+00029000: 6c69 745b 2753 746f 636b 2053 706c 6974  lit['Stock Split
+00029010: 7327 5d7d 2066 6574 6368 3d7b 7370 6c69  s']} fetch={spli
+00029020: 745b 2746 6574 6368 4461 7465 275d 2e73  t['FetchDate'].s
+00029030: 7472 6674 696d 6528 2725 592d 256d 2d25  trftime('%Y-%m-%
+00029040: 6420 2548 3a25 4d3a 2553 257a 2729 7d5d  d %H:%M:%S%z')}]
+00029050: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00029060: 2020 2020 2020 696e 6469 6365 7320 3d20        indices = 
+00029070: 6e70 2e77 6865 7265 2866 295b 305d 0a20  np.where(f)[0]. 
+00029080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029090: 2020 206c 6f67 5f6d 7367 202b 3d20 6622     log_msg += f"
+000290a0: 2061 6372 6f73 7320 696e 7465 7276 616c   across interval
+000290b0: 7320 220a 2020 2020 2020 2020 2020 2020  s ".            
+000290c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000290d0: 696e 7465 7264 6179 3a0a 2020 2020 2020  interday:.      
+000290e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290f0: 2020 6c6f 675f 6d73 6720 2b3d 2066 227b    log_msg += f"{
+00029100: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
+00029110: 6963 6573 5b30 5d5d 2e64 6174 6528 297d  ices[0]].date()}
+00029120: 202d 3e20 7b73 656c 662e 682e 696e 6465   -> {self.h.inde
+00029130: 785b 696e 6469 6365 735b 2d31 5d5d 2e64  x[indices[-1]].d
+00029140: 6174 6528 297d 2028 696e 6329 220a 2020  ate()} (inc)".  
+00029150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029160: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029180: 6c6f 675f 6d73 6720 2b3d 2066 227b 7365  log_msg += f"{se
+00029190: 6c66 2e68 2e69 6e64 6578 5b69 6e64 6963  lf.h.index[indic
+000291a0: 6573 5b30 5d5d 7d20 2d3e 207b 7365 6c66  es[0]]} -> {self
+000291b0: 2e68 2e69 6e64 6578 5b69 6e64 6963 6573  .h.index[indices
+000291c0: 5b2d 315d 5d7d 220a 2020 2020 2020 2020  [-1]]}".        
+000291d0: 2020 2020 2020 2020 2020 2020 685f 6c61              h_la
+000291e0: 7374 526f 7720 3d20 7365 6c66 2e68 2e6c  stRow = self.h.l
+000291f0: 6f63 5b73 656c 662e 682e 696e 6465 785b  oc[self.h.index[
+00029200: 696e 6469 6365 735b 2d31 5d5d 5d0a 2020  indices[-1]]].  
+00029210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029220: 2020 6c6f 675f 6d73 6720 2b3d 2066 222e    log_msg += f".
+00029230: 204c 6173 7420 4353 4620 3d20 7b68 5f6c   Last CSF = {h_l
+00029240: 6173 7452 6f77 5b27 4353 4627 5d3a 2e35  astRow['CSF']:.5
+00029250: 667d 2040 207b 685f 6c61 7374 526f 775b  f} @ {h_lastRow[
+00029260: 274c 6173 7453 706c 6974 4164 6a75 7374  'LastSplitAdjust
+00029270: 4474 275d 2e73 7472 6674 696d 6528 2725  Dt'].strftime('%
+00029280: 592d 256d 2d25 6420 2548 3a25 4d3a 2553  Y-%m-%d %H:%M:%S
+00029290: 257a 2729 7d22 0a20 2020 2020 2020 2020  %z')}".         
+000292a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000292b0: 6d61 6e61 6765 722e 4c6f 6745 7665 6e74  manager.LogEvent
+000292c0: 2822 696e 666f 222c 2022 5072 6963 654d  ("info", "PriceM
+000292d0: 616e 6167 6572 222c 206c 6f67 5f6d 7367  anager", log_msg
+000292e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000292f0: 2020 2020 2020 6966 2079 6663 6c2e 4973        if yfcl.Is
+00029300: 5472 6163 696e 6745 6e61 626c 6564 2829  TracingEnabled()
+00029310: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029320: 2020 2020 2020 2020 2020 7966 636c 2e54            yfcl.T
+00029330: 7261 6365 5072 696e 7428 6c6f 675f 6d73  racePrint(log_ms
+00029340: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+00029350: 2020 2020 2020 2065 6c69 6620 6465 6275         elif debu
+00029360: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00029370: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00029380: 2866 227b 7365 6c66 2e74 6963 6b65 727d  (f"{self.ticker}
+00029390: 3a20 222b 6c6f 675f 6d73 6729 0a0a 2020  : "+log_msg)..  
+000293a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293b0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000293c0: 7365 6c66 2e68 5b22 4353 4622 5d2e 696c  self.h["CSF"].il
+000293d0: 6f63 5b30 5d2c 2028 696e 742c 206e 702e  oc[0], (int, np.
+000293e0: 696e 7436 3429 293a 0a20 2020 2020 2020  int64)):.       
+000293f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029400: 2073 656c 662e 685b 2243 5346 225d 203d   self.h["CSF"] =
+00029410: 2073 656c 662e 685b 2243 5346 225d 2e61   self.h["CSF"].a
+00029420: 7374 7970 6528 666c 6f61 7429 0a20 2020  stype(float).   
+00029430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029440: 2073 656c 662e 682e 6c6f 635b 662c 2022   self.h.loc[f, "
+00029450: 4353 4622 5d20 2f3d 2073 706c 6974 5b22  CSF"] /= split["
+00029460: 5374 6f63 6b20 5370 6c69 7473 225d 0a20  Stock Splits"]. 
+00029470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029480: 2020 204c 6173 7453 706c 6974 4164 6a75     LastSplitAdju
+00029490: 7374 4474 5f6e 6577 5b66 5d20 3d20 6e70  stDt_new[f] = np
+000294a0: 2e6d 6178 696d 756d 284c 6173 7453 706c  .maximum(LastSpl
+000294b0: 6974 4164 6a75 7374 4474 5f6e 6577 5b66  itAdjustDt_new[f
+000294c0: 5d2c 2073 706c 6974 5b22 4665 7463 6844  ], split["FetchD
+000294d0: 6174 6522 5d29 0a20 2020 2020 2020 2020  ate"]).         
+000294e0: 2020 2073 656c 662e 685b 224c 6173 7453     self.h["LastS
+000294f0: 706c 6974 4164 6a75 7374 4474 225d 203d  plitAdjustDt"] =
+00029500: 204c 6173 7453 706c 6974 4164 6a75 7374   LastSplitAdjust
+00029510: 4474 5f6e 6577 0a0a 2020 2020 2020 2020  Dt_new..        
+00029520: 2020 2020 685f 6d6f 6469 6669 6564 203d      h_modified =
+00029530: 2054 7275 650a 0a20 2020 2020 2020 2023   True..        #
+00029540: 2042 6163 6b70 6f72 7420 6e65 7720 6469   Backport new di
+00029550: 7673 2061 6372 6f73 7320 656e 7469 7265  vs across entire
+00029560: 2068 2074 6162 6c65 0a20 2020 2020 2020   h table.       
+00029570: 206c 6173 7444 6976 4164 6a75 7374 4474   lastDivAdjustDt
+00029580: 5f6d 696e 203d 2073 656c 662e 685b 224c  _min = self.h["L
+00029590: 6173 7444 6976 4164 6a75 7374 4474 225d  astDivAdjustDt"]
+000295a0: 2e6d 696e 2829 0a20 2020 2020 2020 2069  .min().        i
+000295b0: 6620 6973 696e 7374 616e 6365 286c 6173  f isinstance(las
+000295c0: 7444 6976 4164 6a75 7374 4474 5f6d 696e  tDivAdjustDt_min
+000295d0: 2e74 7a69 6e66 6f2c 2070 7974 7a2e 4261  .tzinfo, pytz.Ba
+000295e0: 7365 547a 496e 666f 293a 0a20 2020 2020  seTzInfo):.     
+000295f0: 2020 2020 2020 2073 656c 662e 685b 224c         self.h["L
+00029600: 6173 7444 6976 4164 6a75 7374 4474 225d  astDivAdjustDt"]
+00029610: 203d 2073 656c 662e 685b 224c 6173 7444   = self.h["LastD
+00029620: 6976 4164 6a75 7374 4474 225d 2e64 742e  ivAdjustDt"].dt.
+00029630: 747a 5f63 6f6e 7665 7274 2873 656c 662e  tz_convert(self.
+00029640: 682e 696e 6465 782e 747a 290a 2020 2020  h.index.tz).    
+00029650: 2020 2020 2020 2020 685f 6d6f 6469 6669          h_modifi
+00029660: 6564 203d 2054 7275 650a 2020 2020 2020  ed = True.      
+00029670: 2020 2020 2020 6c61 7374 4469 7641 646a        lastDivAdj
+00029680: 7573 7444 745f 6d69 6e20 3d20 7365 6c66  ustDt_min = self
+00029690: 2e68 5b22 4c61 7374 4469 7641 646a 7573  .h["LastDivAdjus
+000296a0: 7444 7422 5d2e 6d69 6e28 290a 2020 2020  tDt"].min().    
+000296b0: 2020 2020 6469 7673 5f73 696e 6365 203d      divs_since =
+000296c0: 2073 656c 662e 6d61 6e61 6765 722e 4765   self.manager.Ge
+000296d0: 7448 6973 746f 7279 2822 4576 656e 7473  tHistory("Events
+000296e0: 2229 2e47 6574 4469 7673 4665 7463 6865  ").GetDivsFetche
+000296f0: 6453 696e 6365 286c 6173 7444 6976 4164  dSince(lastDivAd
+00029700: 6a75 7374 4474 5f6d 696e 290a 2020 2020  justDt_min).    
+00029710: 2020 2020 6966 2064 6976 735f 7369 6e63      if divs_sinc
+00029720: 6520 6973 206e 6f74 204e 6f6e 6520 616e  e is not None an
+00029730: 6420 6e6f 7420 6469 7673 5f73 696e 6365  d not divs_since
+00029740: 2e65 6d70 7479 3a0a 2020 2020 2020 2020  .empty:.        
+00029750: 2020 2020 665f 7375 7020 3d20 6469 7673      f_sup = divs
+00029760: 5f73 696e 6365 5b22 5375 7065 7273 6564  _since["Supersed
+00029770: 6564 2062 6163 6b20 6164 6a2e 225d 2021  ed back adj."] !
+00029780: 3d20 302e 300a 2020 2020 2020 2020 2020  = 0.0.          
+00029790: 2020 6966 2066 5f73 7570 2e61 6e79 2829    if f_sup.any()
+000297a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000297b0: 2020 666f 7220 6474 2069 6e20 6469 7673    for dt in divs
+000297c0: 5f73 696e 6365 2e69 6e64 6578 5b66 5f73  _since.index[f_s
+000297d0: 7570 5d3a 0a20 2020 2020 2020 2020 2020  up]:.           
+000297e0: 2020 2020 2020 2020 2064 6976 203d 2064           div = d
+000297f0: 6976 735f 7369 6e63 652e 6c6f 635b 6474  ivs_since.loc[dt
+00029800: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00029810: 2020 2020 2020 6469 6666 203d 2028 7365        diff = (se
+00029820: 6c66 2e68 5b22 4c61 7374 4469 7641 646a  lf.h["LastDivAdj
+00029830: 7573 7444 7422 5d20 2d20 6469 765b 2253  ustDt"] - div["S
+00029840: 7570 6572 7365 6465 6420 6469 7620 4665  uperseded div Fe
+00029850: 7463 6844 6174 6522 5d29 2e61 6273 2829  tchDate"]).abs()
+00029860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029870: 2020 2020 2066 203d 2028 6469 6666 203c       f = (diff <
+00029880: 2070 642e 5469 6d65 6465 6c74 6128 2231   pd.Timedelta("1
+00029890: 3573 2229 292e 746f 5f6e 756d 7079 2829  5s")).to_numpy()
+000298a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000298b0: 2020 2020 2069 6620 6e6f 7420 662e 616e       if not f.an
+000298c0: 7928 293a 0a20 2020 2020 2020 2020 2020  y():.           
+000298d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000298e0: 7365 6c66 2e69 6e74 6572 7661 6c20 213d  self.interval !=
+000298f0: 2079 6663 642e 496e 7465 7276 616c 2e44   yfcd.Interval.D
+00029900: 6179 7331 3a0a 2020 2020 2020 2020 2020  ays1:.          
+00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029920: 2020 2320 5072 6f62 6162 6c79 206f 6b2c    # Probably ok,
+00029930: 2061 7373 756d 696e 6720 7375 7065 7273   assuming supers
+00029940: 6564 6564 2064 6976 2077 6173 206e 6576  eded div was nev
+00029950: 6572 2061 7070 6c69 6564 2074 6f20 7468  er applied to th
+00029960: 6973 2070 7269 6365 2064 6174 610a 2020  is price data.  
+00029970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029980: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00029990: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+000299a0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000299b0: 2864 6976 290a 2020 2020 2020 2020 2020  (div).          
+000299c0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000299d0: 6973 6520 4578 6365 7074 696f 6e28 6622  ise Exception(f"
+000299e0: 7b73 656c 662e 7469 636b 6572 7d3a 207b  {self.ticker}: {
+000299f0: 7365 6c66 2e69 7374 727d 3a20 466f 7220  self.istr}: For 
+00029a00: 7375 7065 7273 6564 6564 2064 6976 2061  superseded div a
+00029a10: 626f 7665 2c20 6661 696c 6564 2074 6f20  bove, failed to 
+00029a20: 6964 656e 7469 6679 2072 6f77 7320 746f  identify rows to
+00029a30: 2075 6e64 6f2e 2050 726f 626c 656d 3f22   undo. Problem?"
+00029a40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00029a50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00029a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a70: 2020 2020 2320 4e65 7874 2063 6865 636b      # Next check
+00029a80: 3a20 6578 7065 6374 2063 6163 6865 6420  : expect cached 
+00029a90: 4344 4620 3c20 312e 303a 0a20 2020 2020  CDF < 1.0:.     
+00029aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ab0: 2020 2066 3120 3d20 7365 6c66 2e68 2e6c     f1 = self.h.l
+00029ac0: 6f63 5b66 2c20 2243 4446 225d 203d 3d20  oc[f, "CDF"] == 
+00029ad0: 312e 300a 2020 2020 2020 2020 2020 2020  1.0.            
+00029ae0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+00029af0: 312e 616e 7928 293a 0a20 2020 2020 2020  1.any():.       
+00029b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b10: 2020 2020 2070 7269 6e74 2864 6976 290a       print(div).
+00029b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00029b40: 6520 4578 6365 7074 696f 6e28 6622 7b73  e Exception(f"{s
+00029b50: 656c 662e 7469 636b 6572 7d3a 207b 7365  elf.ticker}: {se
+00029b60: 6c66 2e69 7374 727d 3a20 466f 7220 7375  lf.istr}: For su
+00029b70: 7065 7273 6564 6564 2064 6976 2061 626f  perseded div abo
+00029b80: 7665 2c20 6174 7465 6d70 7469 6e67 2074  ve, attempting t
+00029b90: 6f20 756e 646f 2064 6976 2d61 646a 7573  o undo div-adjus
+00029ba0: 7420 6672 6f6d 2072 6f77 7320 7768 6572  t from rows wher
+00029bb0: 6520 4344 463d 312e 2049 6e76 6573 7469  e CDF=1. Investi
+00029bc0: 6761 7465 2e22 290a 0a20 2020 2020 2020  gate.")..       
+00029bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029be0: 206c 6f67 5f6d 7367 203d 2066 227b 7365   log_msg = f"{se
+00029bf0: 6c66 2e69 7374 727d 3a20 5265 7665 7273  lf.istr}: Revers
+00029c00: 696e 6720 6469 7620 5b64 743d 7b64 742e  ing div [dt={dt.
+00029c10: 6461 7465 2829 7d20 7b64 6976 5b27 5375  date()} {div['Su
+00029c20: 7065 7273 6564 6564 2064 6976 275d 7d20  perseded div']} 
+00029c30: 6164 6a3d 7b64 6976 5b27 5375 7065 7273  adj={div['Supers
+00029c40: 6564 6564 2062 6163 6b20 6164 6a2e 275d  eded back adj.']
+00029c50: 3a2e 3566 7d20 6665 7463 683d 7b64 6976  :.5f} fetch={div
+00029c60: 5b27 5375 7065 7273 6564 6564 2064 6976  ['Superseded div
+00029c70: 2046 6574 6368 4461 7465 275d 2e73 7472   FetchDate'].str
+00029c80: 6674 696d 6528 2725 592d 256d 2d25 6420  ftime('%Y-%m-%d 
+00029c90: 2548 3a25 4d3a 2553 257a 2729 7d5d 220a  %H:%M:%S%z')}]".
+00029ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029cb0: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
+00029cc0: 3d20 6e70 2e77 6865 7265 2866 295b 305d  = np.where(f)[0]
+00029cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029ce0: 2020 2020 2020 2020 206c 6f67 5f6d 7367           log_msg
+00029cf0: 202b 3d20 6622 2066 726f 6d20 696e 7465   += f" from inte
+00029d00: 7276 616c 7320 220a 2020 2020 2020 2020  rvals ".        
+00029d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d20: 6966 2073 656c 662e 696e 7465 7264 6179  if self.interday
+00029d30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029d40: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00029d50: 675f 6d73 6720 2b3d 2066 227b 7365 6c66  g_msg += f"{self
+00029d60: 2e68 2e69 6e64 6578 5b69 6e64 6963 6573  .h.index[indices
+00029d70: 5b30 5d5d 2e64 6174 6528 297d 202d 3e20  [0]].date()} -> 
+00029d80: 7b73 656c 662e 682e 696e 6465 785b 696e  {self.h.index[in
+00029d90: 6469 6365 735b 2d31 5d5d 2e64 6174 6528  dices[-1]].date(
+00029da0: 297d 2028 696e 6329 220a 2020 2020 2020  )} (inc)".      
+00029db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029dc0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029de0: 2020 2020 6c6f 675f 6d73 6720 2b3d 2066      log_msg += f
+00029df0: 227b 7365 6c66 2e68 2e69 6e64 6578 5b69  "{self.h.index[i
+00029e00: 6e64 6963 6573 5b30 5d5d 7d20 2d3e 207b  ndices[0]]} -> {
+00029e10: 7365 6c66 2e68 2e69 6e64 6578 5b69 6e64  self.h.index[ind
+00029e20: 6963 6573 5b2d 315d 5d7d 220a 2020 2020  ices[-1]]}".    
+00029e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029e40: 2020 2020 685f 6c61 7374 526f 7720 3d20      h_lastRow = 
+00029e50: 7365 6c66 2e68 2e6c 6f63 5b73 656c 662e  self.h.loc[self.
+00029e60: 682e 696e 6465 785b 696e 6469 6365 735b  h.index[indices[
+00029e70: 2d31 5d5d 5d0a 2020 2020 2020 2020 2020  -1]]].          
+00029e80: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00029e90: 675f 6d73 6720 2b3d 2066 222e 204c 6173  g_msg += f". Las
+00029ea0: 7420 4344 4620 3d20 7b68 5f6c 6173 7452  t CDF = {h_lastR
+00029eb0: 6f77 5b27 4344 4627 5d3a 2e35 667d 2040  ow['CDF']:.5f} @
+00029ec0: 207b 685f 6c61 7374 526f 775b 274c 6173   {h_lastRow['Las
+00029ed0: 7444 6976 4164 6a75 7374 4474 275d 2e73  tDivAdjustDt'].s
+00029ee0: 7472 6674 696d 6528 2725 592d 256d 2d25  trftime('%Y-%m-%
+00029ef0: 6420 2548 3a25 4d3a 2553 257a 2729 7d22  d %H:%M:%S%z')}"
+00029f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029f10: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+00029f20: 6e61 6765 722e 4c6f 6745 7665 6e74 2822  nager.LogEvent("
+00029f30: 696e 666f 222c 2022 5072 6963 654d 616e  info", "PriceMan
+00029f40: 6167 6572 222c 206c 6f67 5f6d 7367 290a  ager", log_msg).
+00029f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029f60: 2020 2020 2020 2020 6966 2079 6663 6c2e          if yfcl.
+00029f70: 4973 5472 6163 696e 6745 6e61 626c 6564  IsTracingEnabled
+00029f80: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00029f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029fa0: 7966 636c 2e54 7261 6365 5072 696e 7428  yfcl.TracePrint(
+00029fb0: 6c6f 675f 6d73 6729 0a20 2020 2020 2020  log_msg).       
+00029fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029fd0: 2065 6c69 6620 6465 6275 673a 0a20 2020   elif debug:.   
+00029fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ff0: 2020 2020 2020 2020 2070 7269 6e74 2866           print(f
+0002a000: 2255 6e64 6f6e 6520 7375 7065 7273 6564  "Undone supersed
+0002a010: 6564 2064 6976 6964 656e 6420 4020 7b64  ed dividend @ {d
+0002a020: 747d 3a22 290a 2020 2020 2020 2020 2020  t}:").          
+0002a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a040: 2020 7072 696e 7428 7365 6c66 2e68 2e6c    print(self.h.l
+0002a050: 6f63 5b66 2c20 5b22 4344 4622 2c20 2246  oc[f, ["CDF", "F
+0002a060: 6574 6368 4461 7465 222c 2022 4c61 7374  etchDate", "Last
+0002a070: 4469 7641 646a 7573 7444 7422 5d5d 290a  DivAdjustDt"]]).
+0002a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a090: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0002a0a0: 7428 2222 290a 0a20 2020 2020 2020 2020  t("")..         
+0002a0b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002a0c0: 656c 662e 682e 6c6f 635b 662c 2022 4344  elf.h.loc[f, "CD
+0002a0d0: 4622 5d20 2f3d 2064 6976 5b22 5375 7065  F"] /= div["Supe
+0002a0e0: 7273 6564 6564 2062 6163 6b20 6164 6a2e  rseded back adj.
+0002a0f0: 225d 0a0a 2020 2020 2020 2020 2020 2020  "]..            
+0002a100: 4c61 7374 4469 7641 646a 7573 7444 745f  LastDivAdjustDt_
+0002a110: 6e65 7720 3d20 7365 6c66 2e68 5b22 4c61  new = self.h["La
+0002a120: 7374 4469 7641 646a 7573 7444 7422 5d2e  stDivAdjustDt"].
+0002a130: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
+0002a140: 2020 2066 6f72 2064 7420 696e 2064 6976     for dt in div
+0002a150: 735f 7369 6e63 652e 696e 6465 783a 0a20  s_since.index:. 
+0002a160: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002a170: 6976 203d 2064 6976 735f 7369 6e63 652e  iv = divs_since.
+0002a180: 6c6f 635b 6474 5d0a 2020 2020 2020 2020  loc[dt].        
+0002a190: 2020 2020 2020 2020 6631 203d 2073 656c          f1 = sel
+0002a1a0: 662e 682e 696e 6465 7820 3c20 6474 0a20  f.h.index < dt. 
+0002a1b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002a1c0: 3220 3d20 7365 6c66 2e68 5b22 4c61 7374  2 = self.h["Last
+0002a1d0: 4469 7641 646a 7573 7444 7422 5d20 3c20  DivAdjustDt"] < 
+0002a1e0: 6469 765b 2246 6574 6368 4461 7465 225d  div["FetchDate"]
+0002a1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a200: 2066 203d 2066 3120 2620 6632 0a20 2020   f = f1 & f2.   
+0002a210: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002a220: 662e 616e 7928 293a 0a20 2020 2020 2020  f.any():.       
+0002a230: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002a240: 5f6d 7367 203d 2066 227b 7365 6c66 2e69  _msg = f"{self.i
+0002a250: 7374 727d 3a20 4170 706c 7969 6e67 2064  str}: Applying d
+0002a260: 6976 205b 6474 3d7b 6474 2e64 6174 6528  iv [dt={dt.date(
+0002a270: 297d 207b 6469 765b 2744 6976 6964 656e  )} {div['Dividen
+0002a280: 6473 275d 7d20 6164 6a3d 7b64 6976 5b27  ds']} adj={div['
+0002a290: 4261 636b 2041 646a 2e27 5d3a 2e35 667d  Back Adj.']:.5f}
+0002a2a0: 2066 6574 6368 3d7b 6469 765b 2746 6574   fetch={div['Fet
+0002a2b0: 6368 4461 7465 275d 2e73 7472 6674 696d  chDate'].strftim
+0002a2c0: 6528 2725 592d 256d 2d25 6420 2548 3a25  e('%Y-%m-%d %H:%
+0002a2d0: 4d3a 2553 257a 2729 7d5d 220a 2020 2020  M:%S%z')}]".    
+0002a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a2f0: 696e 6469 6365 7320 3d20 6e70 2e77 6865  indices = np.whe
+0002a300: 7265 2866 295b 305d 0a20 2020 2020 2020  re(f)[0].       
+0002a310: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002a320: 5f6d 7367 202b 3d20 6622 2061 6372 6f73  _msg += f" acros
+0002a330: 7320 696e 7465 7276 616c 7320 220a 2020  s intervals ".  
+0002a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a350: 2020 6966 2073 656c 662e 696e 7465 7264    if self.interd
+0002a360: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+0002a370: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+0002a380: 6d73 6720 2b3d 2066 227b 7365 6c66 2e68  msg += f"{self.h
+0002a390: 2e69 6e64 6578 5b69 6e64 6963 6573 5b30  .index[indices[0
+0002a3a0: 5d5d 2e64 6174 6528 297d 202d 3e20 7b73  ]].date()} -> {s
+0002a3b0: 656c 662e 682e 696e 6465 785b 696e 6469  elf.h.index[indi
+0002a3c0: 6365 735b 2d31 5d5d 2e64 6174 6528 297d  ces[-1]].date()}
+0002a3d0: 2028 696e 6329 220a 2020 2020 2020 2020   (inc)".        
+0002a3e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002a3f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a400: 2020 2020 2020 2020 2020 6c6f 675f 6d73            log_ms
+0002a410: 6720 2b3d 2066 227b 7365 6c66 2e68 2e69  g += f"{self.h.i
+0002a420: 6e64 6578 5b69 6e64 6963 6573 5b30 5d5d  ndex[indices[0]]
+0002a430: 7d20 2d3e 207b 7365 6c66 2e68 2e69 6e64  } -> {self.h.ind
+0002a440: 6578 5b69 6e64 6963 6573 5b2d 315d 5d7d  ex[indices[-1]]}
+0002a450: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002a460: 2020 2020 2020 685f 6c61 7374 526f 7720        h_lastRow 
+0002a470: 3d20 7365 6c66 2e68 2e6c 6f63 5b73 656c  = self.h.loc[sel
+0002a480: 662e 682e 696e 6465 785b 696e 6469 6365  f.h.index[indice
+0002a490: 735b 2d31 5d5d 5d0a 2020 2020 2020 2020  s[-1]]].        
+0002a4a0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+0002a4b0: 6d73 6720 2b3d 2066 222e 204c 6173 7420  msg += f". Last 
+0002a4c0: 4344 4620 3d20 7b68 5f6c 6173 7452 6f77  CDF = {h_lastRow
+0002a4d0: 5b27 4344 4627 5d3a 2e35 667d 2040 207b  ['CDF']:.5f} @ {
+0002a4e0: 685f 6c61 7374 526f 775b 274c 6173 7444  h_lastRow['LastD
+0002a4f0: 6976 4164 6a75 7374 4474 275d 2e73 7472  ivAdjustDt'].str
+0002a500: 6674 696d 6528 2725 592d 256d 2d25 6420  ftime('%Y-%m-%d 
+0002a510: 2548 3a25 4d3a 2553 257a 2729 7d22 0a20  %H:%M:%S%z')}". 
+0002a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a530: 2020 2073 656c 662e 6d61 6e61 6765 722e     self.manager.
+0002a540: 4c6f 6745 7665 6e74 2822 696e 666f 222c  LogEvent("info",
+0002a550: 2022 5072 6963 654d 616e 6167 6572 222c   "PriceManager",
+0002a560: 206c 6f67 5f6d 7367 290a 2020 2020 2020   log_msg).      
+0002a570: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002a580: 2079 6663 6c2e 4973 5472 6163 696e 6745   yfcl.IsTracingE
+0002a590: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
+0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5b0: 2020 7966 636c 2e54 7261 6365 5072 696e    yfcl.TracePrin
+0002a5c0: 7428 6c6f 675f 6d73 6729 0a20 2020 2020  t(log_msg).     
+0002a5d0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002a5e0: 6c69 6620 6465 6275 673a 0a20 2020 2020  lif debug:.     
+0002a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a600: 2020 2070 7269 6e74 2866 227b 7365 6c66     print(f"{self
+0002a610: 2e74 6963 6b65 727d 3a20 222b 6c6f 675f  .ticker}: "+log_
+0002a620: 6d73 6729 0a0a 2020 2020 2020 2020 2020  msg)..          
+0002a630: 2020 2020 2020 2020 2020 7365 6c66 2e68            self.h
+0002a640: 2e6c 6f63 5b66 2c20 2243 4446 225d 202a  .loc[f, "CDF"] *
+0002a650: 3d20 6469 765b 2242 6163 6b20 4164 6a2e  = div["Back Adj.
+0002a660: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+0002a670: 2020 2020 2020 204c 6173 7444 6976 4164         LastDivAd
+0002a680: 6a75 7374 4474 5f6e 6577 5b66 5d20 3d20  justDt_new[f] = 
+0002a690: 6e70 2e6d 6178 696d 756d 284c 6173 7444  np.maximum(LastD
+0002a6a0: 6976 4164 6a75 7374 4474 5f6e 6577 5b66  ivAdjustDt_new[f
+0002a6b0: 5d2c 2064 6976 5b22 4665 7463 6844 6174  ], div["FetchDat
+0002a6c0: 6522 5d29 0a20 2020 2020 2020 2020 2020  e"]).           
+0002a6d0: 2073 656c 662e 685b 224c 6173 7444 6976   self.h["LastDiv
+0002a6e0: 4164 6a75 7374 4474 225d 203d 204c 6173  AdjustDt"] = Las
+0002a6f0: 7444 6976 4164 6a75 7374 4474 5f6e 6577  tDivAdjustDt_new
+0002a700: 0a0a 2020 2020 2020 2020 2020 2020 685f  ..            h_
+0002a710: 6d6f 6469 6669 6564 203d 2054 7275 650a  modified = True.
+0002a720: 0a20 2020 2020 2020 2069 6620 685f 6d6f  .        if h_mo
+0002a730: 6469 6669 6564 3a0a 2020 2020 2020 2020  dified:.        
+0002a740: 2020 2020 7365 6c66 2e5f 7570 6461 7465      self._update
+0002a750: 6443 6163 6865 6450 7269 6365 7328 7365  dCachedPrices(se
+0002a760: 6c66 2e68 290a 0a20 2020 2020 2020 206c  lf.h)..        l
+0002a770: 6f67 5f6d 7367 203d 2022 504d 3a3a 5f61  og_msg = "PM::_a
+0002a780: 7070 6c79 4e65 7745 7665 6e74 7328 2920  pplyNewEvents() 
+0002a790: 7265 7475 726e 696e 6722 0a20 2020 2020  returning".     
+0002a7a0: 2020 2069 6620 7966 636c 2e49 7354 7261     if yfcl.IsTra
+0002a7b0: 6369 6e67 456e 6162 6c65 6428 293a 0a20  cingEnabled():. 
+0002a7c0: 2020 2020 2020 2020 2020 2079 6663 6c2e             yfcl.
+0002a7d0: 5472 6163 6545 7869 7428 6c6f 675f 6d73  TraceExit(log_ms
+0002a7e0: 6729 0a                                  g).
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_ticker.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_ticker.py`

 * *Files 4% similar despite different names*

```diff
@@ -6,14 +6,15 @@
 from . import yfc_logging as yfcl
 from . import yfc_time as yfct
 from . import yfc_prices_manager as yfcp
 
 import numpy as np
 import pandas as pd
 import datetime
+from dateutil.relativedelta import relativedelta
 from zoneinfo import ZoneInfo
 import os
 import re
 # from time import perf_counter
 
 # TODO: Ticker: add method to delete ticker from cache
 
@@ -87,145 +88,176 @@
         if start is not None or end is not None:
             log_msg = f"Ticker::history(tkr={self.ticker} interval={interval} start={start} end={end} max_age={max_age} trigger_at_market_close={trigger_at_market_close} adjust_splits={adjust_splits}, adjust_divs={adjust_divs})"
         else:
             log_msg = f"Ticker::history(tkr={self.ticker} interval={interval} period={period} max_age={max_age} trigger_at_market_close={trigger_at_market_close} adjust_splits={adjust_splits}, adjust_divs={adjust_divs})"
         yfcl.TraceEnter(log_msg)
 
         td_1d = datetime.timedelta(days=1)
-        exchange = self.fast_info['exchange']
-        tz_name = self.fast_info["timezone"]
-        tz_exchange = ZoneInfo(self.fast_info["timezone"])
-        yfct.SetExchangeTzName(exchange, self.fast_info["timezone"])
-        dt_now = datetime.datetime.utcnow().replace(tzinfo=ZoneInfo("UTC"))
+        exchange = self.info['exchange']
+        if "exchangeTimezoneName" in self.info:
+            tz_name = self.info["exchangeTimezoneName"]
+        else:
+            tz_name = self.info["timeZoneFullName"]
+        tz_exchange = ZoneInfo(tz_name)
+        yfct.SetExchangeTzName(exchange, tz_name)
+        dt_now = pd.Timestamp.utcnow()
 
         # Type checks
         if max_age is not None:
             if isinstance(max_age, str):
                 if max_age.endswith("wk"):
                     max_age = re.sub("wk$", "w", max_age)
                 max_age = pd.Timedelta(max_age)
             if not isinstance(max_age, (datetime.timedelta, pd.Timedelta)):
-                raise Exception("Argument 'max_age' must be Timedelta or valid string")
+                raise Exception("Argument 'max_age' must be Timedelta or equivalent string")
         if period is not None:
             if start is not None or end is not None:
                 raise Exception("Don't set both 'period' and 'start'/'end'' arguments")
             if isinstance(period, str):
-                if period not in yfcd.periodStrToEnum.keys():
-                    raise Exception("'period' if str must be one of: {}".format(yfcd.periodStrToEnum.keys()))
-                period = yfcd.periodStrToEnum[period]
-            if not isinstance(period, yfcd.Period):
-                raise Exception("'period' must be a yfcd.Period")
+                if period in ["max", "ytd"]:
+                    period = yfcd.periodStrToEnum[period]
+                else:
+                    if period.endswith("wk"):
+                        period = re.sub("wk$", "w", period)
+                    if period.endswith("y"):
+                        period = relativedelta(years=int(re.sub("y$", "", period)))
+                    elif period.endswith("mo"):
+                        period = relativedelta(months=int(re.sub("mo", "", period)))
+                    else:
+                        period = pd.Timedelta(period)
+            if not isinstance(period, (yfcd.Period, datetime.timedelta, pd.Timedelta, relativedelta)):
+                raise Exception(f"Argument 'period' must be one of: 'max', 'ytd', Timedelta or equivalent string. Not {type(perio)}")
         if isinstance(interval, str):
             if interval not in yfcd.intervalStrToEnum.keys():
                 raise Exception("'interval' if str must be one of: {}".format(yfcd.intervalStrToEnum.keys()))
             interval = yfcd.intervalStrToEnum[interval]
         if not isinstance(interval, yfcd.Interval):
             raise Exception("'interval' must be yfcd.Interval")
 
         start_d = None ; end_d = None
+        start_dt = None ; end_dt = None
+        interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week, yfcd.Interval.Months1, yfcd.Interval.Months3]
         if start is not None:
-            start, start_d = self._process_user_dt(start)
-            if start > dt_now:
+            start_dt, start_d = self._process_user_dt(start)
+            if start_dt > dt_now:
                 return None
             if interval == yfcd.Interval.Week:
                 # Note: if start is on weekend then Yahoo can return weekly data starting
                 #       on Saturday. This breaks YFC, start must be Monday! So fix here:
-                if start is None:
+                if start_dt is None:
                     # Working with simple dates, easy
                     if start_d.weekday() in [5, 6]:
                         start_d += datetime.timedelta(days=7-start_d.weekday())
                 else:
                     wd = start_d.weekday()
                     if wd in [5, 6]:
                         start_d += datetime.timedelta(days=7-wd)
-                        start = datetime.datetime.combine(start_d, datetime.time(0), tz_exchange)
+                        start_dt = datetime.datetime.combine(start_d, datetime.time(0), tz_exchange)
 
         if end is not None:
-            end, end_d = self._process_user_dt(end)
+            end_dt, end_d = self._process_user_dt(end)
 
-        if start is not None and end is not None and start >= end:
+        if start_dt is not None and end_dt is not None and start_dt >= end_dt:
             raise ValueError("start must be < end")
 
+        if debug_yfc:
+            print("- start_dt={} , end_dt={}".format(start_dt, end_dt))
+
+        if (start_dt is not None) and start_dt == end_dt:
+            return None
+
         if max_age is None:
             if interval == yfcd.Interval.Days1:
                 max_age = datetime.timedelta(hours=4)
             elif interval == yfcd.Interval.Week:
                 max_age = datetime.timedelta(hours=60)
             elif interval == yfcd.Interval.Months1:
                 max_age = datetime.timedelta(days=15)
             elif interval == yfcd.Interval.Months3:
                 max_age = datetime.timedelta(days=45)
             else:
                 max_age = 0.5*yfcd.intervalToTimedelta[interval]
+            if start is not None:
+                max_age = min(max_age, dt_now-start_dt)
 
-        if debug_yfc:
-            print("- start={} , end={}".format(start, end))
+        if period is not None:
+            if isinstance(period, (datetime.timedelta, pd.Timedelta)):
+                if (dt_now - max_age) < (dt_now - period):
+                    raise Exception(f"max_age={max_age} must be less than period={period}")
+            elif period == yfcd.Period.Ytd:
+                dt_now_ex = dt_now.tz_convert(tz_exchange)
+                dt_year_start = pd.Timestamp(year=dt_now_ex.year, month=1, day=1).tz_localize(tz_exchange)
+                if (dt_now - max_age) < dt_year_start:
+                    raise Exception(f"max_age={max_age} must be less than days since this year start")
+        elif start is not None:
+            if (dt_now - max_age) < start_dt:
+                raise Exception(f"max_age={max_age} must be closer to now than start={start}")
 
-        if (start is not None) and start == end:
-            return None
 
-        if start is not None:
+        if start_dt is not None:
             try:
-                sched_14d = yfct.GetExchangeSchedule(exchange, start.date(), start.date()+14*td_1d)
+                sched_14d = yfct.GetExchangeSchedule(exchange, start_dt.date(), start_dt.date()+14*td_1d)
             except Exception as e:
                 if "Need to add mapping" in str(e):
-                    raise Exception("Need to add mapping of exchange {} to xcal (ticker={})".format(self.fast_info["exchange"], self.ticker))
+                    raise Exception("Need to add mapping of exchange {} to xcal (ticker={})".format(self.info["exchange"], self.ticker))
                 else:
                     raise
             if sched_14d is None:
-                raise Exception("sched_14d is None for date range {}->{} and ticker {}".format(start.date(), start.date()+14*td_1d, self.ticker))
+                raise Exception("sched_14d is None for date range {}->{} and ticker {}".format(start_dt.date(), start_dt.date()+14*td_1d, self.ticker))
             if sched_14d["open"][0] > dt_now:
                 # Requested date range is in future
                 return None
         else:
             sched_14d = None
 
         # All date checks passed so can begin fetching
 
-        if ((start_d is None) or (end_d is None)) and (start is not None) and (end is not None):
+        if ((start_d is None) or (end_d is None)) and (start_dt is not None) and (end_dt is not None):
             # if start_d/end_d not set then start/end are datetimes, so need to inspect
             # schedule opens/closes to determine days
             if sched_14d is not None:
                 sched = sched_14d.iloc[0:1]
             else:
-                sched = yfct.GetExchangeSchedule(exchange, start.date(), end.date()+td_1d)
+                sched = yfct.GetExchangeSchedule(exchange, start_dt.date(), end_dt.date()+td_1d)
             n = sched.shape[0]
-            start_d = start.date() if start < sched["open"][0] else start.date()+td_1d
-            end_d = end.date()+td_1d if end >= sched["close"][n-1] else end.date()
+            start_d = start_dt.date() if start_dt < sched["open"][0] else start_dt.date()+td_1d
+            end_d = end_dt.date()+td_1d if end_dt >= sched["close"][n-1] else end_dt.date()
 
         if self._histories_manager is None:
             self._histories_manager = yfcp.HistoriesManager(self.ticker, exchange, tz_name, self.session, proxy)
 
         # t1_setup = perf_counter()
 
         hist = self._histories_manager.GetHistory(interval)
-        interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week, yfcd.Interval.Months1, yfcd.Interval.Months3]
         if period is not None:
             h = hist.get(start=None, end=None, period=period, max_age=max_age, trigger_at_market_close=trigger_at_market_close, quiet=quiet)
         elif interday:
             h = hist.get(start_d, end_d, period=None, max_age=max_age, trigger_at_market_close=trigger_at_market_close, quiet=quiet)
         else:
-            h = hist.get(start, end, period=None, max_age=max_age, trigger_at_market_close=trigger_at_market_close, quiet=quiet)
+            h = hist.get(start_dt, end_dt, period=None, max_age=max_age, trigger_at_market_close=trigger_at_market_close, quiet=quiet)
         if (h is None) or h.shape[0] == 0:
-            if start is not None or end is not None:
-                msg = f"YFC: history() exiting without price data (tkr={self.ticker} start={start} end={end} interval={yfcd.intervalToString[interval]})"
+            msg = f"YFC: history() exiting without price data (tkr={self.ticker}"
+            if start_dt is not None or end_dt is not None:
+                msg += f" start_dt={start_dt} end_dt={end_dt}"
             else:
-                msg = f"YFC: history() exiting without price data (tkr={self.ticker} period={period} interval={yfcd.intervalToString[interval]})"
+                msg += f" period={period}"
+            msg += f" max_age={max_age}"
+            msg += f" interval={yfcd.intervalToString[interval]})"
             raise Exception(msg)
 
         # t2_sync = perf_counter()
 
         f_dups = h.index.duplicated()
         if f_dups.any():
             raise Exception("{}: These timepoints have been duplicated: {}".format(self.ticker, h.index[f_dups]))
 
         # Present table for user:
         h_copied = False
-        if (start is not None) and (end is not None):
-            h = h.loc[start:end-datetime.timedelta(milliseconds=1)].copy()
+        if (start_dt is not None) and (end_dt is not None):
+            h = h.loc[start_dt:end_dt-datetime.timedelta(milliseconds=1)].copy()
             h_copied = True
 
         if not keepna:
             price_data_cols = [c for c in yfcd.yf_data_cols if c in h.columns]
             mask_nan_or_zero = (np.isnan(h[price_data_cols].to_numpy()) | (h[price_data_cols].to_numpy() == 0)).all(axis=1)
             if mask_nan_or_zero.any():
                 h = h.drop(h.index[mask_nan_or_zero])
@@ -236,15 +268,15 @@
             h = None
         else:
             if adjust_splits:
                 if not h_copied:
                     h = h.copy()
                 for c in ["Open", "Close", "Low", "High", "Dividends"]:
                     h[c] = np.multiply(h[c].to_numpy(), h["CSF"].to_numpy())
-                h["Volume"] = np.divide(h["Volume"].to_numpy(), h["CSF"].to_numpy())
+                h["Volume"] = np.round(np.divide(h["Volume"].to_numpy(), h["CSF"].to_numpy()), 0).astype('int')
             if adjust_divs:
                 if not h_copied:
                     h = h.copy()
                 for c in ["Open", "Close", "Low", "High"]:
                     h[c] = np.multiply(h[c].to_numpy(), h["CDF"].to_numpy())
             else:
                 if not h_copied:
@@ -252,17 +284,29 @@
                 h["Adj Close"] = np.multiply(h["Close"].to_numpy(), h["CDF"].to_numpy())
             h = h.drop(["CSF", "CDF"], axis=1)
 
             if rounding:
                 # Round to 4 sig-figs
                 if not h_copied:
                     h = h.copy()
-                rnd = yfcu.CalculateRounding(h["Close"].iloc[-1], 4)
+                f_na = h["Close"].isna()
+                na = f_na.any()
+                if na:
+                    f_nna = ~f_na
+                    if not f_nna.any():
+                        raise Exception(f"{self.ticker}: price table is entirely NaNs. Delisted?" +" \n" + log_msg)
+                    last_close = h["Close"][f_nna].iloc[-1]
+                else:
+                    last_close = h["Close"].iloc[-1]
+                rnd = yfcu.CalculateRounding(last_close, 4)
                 for c in ["Open", "Close", "Low", "High"]:
-                    h[c] = np.round(h[c].to_numpy(), rnd)
+                    if na:
+                        h.loc[f_nna, c] = np.round(h.loc[f_nna, c].to_numpy(), rnd)
+                    else:
+                        h[c] = np.round(h[c].to_numpy(), rnd)
 
             if debug_yfc:
                 print("- h:")
                 cols = [c for c in ["Close", "Dividends", "Volume", "CDF", "CSF"] if c in h.columns]
                 print(h[cols])
                 if "Dividends" in h.columns:
                     f = h["Dividends"] != 0.0
@@ -286,65 +330,74 @@
         # t_adjust *= 100/t_sum
         # print("TIME %:        setup={:.1f}%  sync={:.1f}%  filter={:.1f}%  adjust={:.1f}%".format(t_setup, t_sync, t_filter, t_adju
 
         return h
 
     def _getCachedPrices(self, interval, proxy=None):
         if self._histories_manager is None:
-            exchange = self.fast_info['exchange']
-            tz_name = self.fast_info["timezone"]
+            exchange = self.info['exchange']
+            tz_name = self.info["timeZoneFullName"]
             self._histories_manager = yfcp.HistoriesManager(self.ticker, exchange, tz_name, self.session, proxy)
 
-        return self._histories_manager.GetHistory(interval)._getCachedPrices()
+        if isinstance(interval, str):
+            if interval not in yfcd.intervalStrToEnum.keys():
+                raise Exception("'interval' if str must be one of: {}".format(yfcd.intervalStrToEnum.keys()))
+            interval = yfcd.intervalStrToEnum[interval]
+
+        return self._histories_manager.GetHistory(interval).h
 
     def verify_cached_prices(self, rtol=0.0001, vol_rtol=0.005, correct=False, discard_old=False, quiet=True, debug=False, debug_interval=None):
+        if debug:
+            quiet = False
+
         fn_locals = locals()
         del fn_locals["self"]
 
         interval = yfcd.Interval.Days1
         cache_key = "history-"+yfcd.intervalToString[interval]
         if not yfcm.IsDatumCached(self.ticker, cache_key):
             return True
 
         yfcl.TraceEnter(f"Ticker::verify_cached_prices(tkr={self.ticker} {fn_locals})")
 
         if self._histories_manager is None:
-            exchange = self.fast_info['exchange']
-            tz_name = self.fast_info["timezone"]
+            exchange = self.info['exchange']
+            tz_name = self.info["timeZoneFullName"]
             self._histories_manager = yfcp.HistoriesManager(self.ticker, exchange, tz_name, self.session, proxy=None)
 
         v = True
 
         # First verify 1d
         dt0 = self._histories_manager.GetHistory(interval)._getCachedPrices().index[0]
         self.history(start=dt0.date(), quiet=quiet, trigger_at_market_close=True)  # ensure have all dividends
         v = self._verify_cached_prices_interval(interval, rtol, vol_rtol, correct, discard_old, quiet, debug)
         if debug_interval == yfcd.Interval.Days1:
-            yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v}")
+            yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v} (1st pass)")
             return v
         if not v:
             if debug or not correct:
-                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v}")
+                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v} (1st pass)")
                 return v
         if correct:
             # Rows were removed so re-fetch. Only do for 1d data
             self.history(start=dt0.date(), quiet=quiet)
 
             # repeat verification, because 'fetch backporting' may be buggy
             v2 = self._verify_cached_prices_interval(interval, rtol, vol_rtol, correct, discard_old, quiet, debug)
             if not v2 and debug:
-                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v2}")
+                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v2} (post-correction)")
                 return v2
             if not v2:
-                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v2}")
+                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v2} (post-correction)")
                 return v2
-        if not v and correct:
-            # Stop after correcting first problem, because user won't have been shown the next problem yet
-            yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v}")
-            return v
+
+            if not v:
+                # Stop after correcting first problem, because user won't have been shown the next problem yet
+                yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v} (corrected but user should review next problem)")
+                return v
 
         if debug_interval is not None:
             if debug_interval == yfcd.Interval.Days1:
                 intervals = []
             else:
                 intervals = [debug_interval]
             debug = True
@@ -368,16 +421,17 @@
             v = v and vi
 
         yfcl.TraceExit(f"Ticker::verify_cached_prices() returning {v}")
 
         return v
 
     def _verify_cached_prices_interval(self, interval, rtol=0.0001, vol_rtol=0.005, correct=False, discard_old=False, quiet=True, debug=False):
-        # TODO: iterate over all intervals, but only once I'm sure verify is 100% solid.
-        #       - I remember needing 1d verified first => re-fetch after correction before verifying other intervals?
+        if debug:
+            quiet = False
+
         fn_locals = locals()
         del fn_locals["self"]
 
         if isinstance(interval, str):
             if interval not in yfcd.intervalStrToEnum.keys():
                 raise Exception("'interval' if str must be one of: {}".format(yfcd.intervalStrToEnum.keys()))
             interval = yfcd.intervalStrToEnum[interval]
@@ -386,26 +440,26 @@
         cache_key = "history-"+istr
         if not yfcm.IsDatumCached(self.ticker, cache_key):
             return True
 
         yfcl.TraceEnter(f"Ticker::_verify_cached_prices_interval(tkr={self.ticker}, {fn_locals})")
 
         if self._histories_manager is None:
-            exchange = self.fast_info['exchange']
-            tz_name = self.fast_info["timezone"]
+            exchange = self.info['exchangeName']
+            tz_name = self.info["timeZoneFullName"]
             self._histories_manager = yfcp.HistoriesManager(self.ticker, exchange, tz_name, self.session, proxy=None)
 
         v = self._histories_manager.GetHistory(interval)._verifyCachedPrices(rtol, vol_rtol, correct, discard_old, quiet, debug)
 
         yfcl.TraceExit(f"Ticker::_verify_cached_prices_interval() returning {v}")
         return v
 
     def _process_user_dt(self, dt):
         d = None
-        tz_exchange = ZoneInfo(self.fast_info["timezone"])
+        tz_exchange = ZoneInfo(self.info["timeZoneFullName"])
         if isinstance(dt, str):
             d = datetime.datetime.strptime(dt, "%Y-%m-%d").date()
             dt = datetime.datetime.combine(d, datetime.time(0), tz_exchange)
         elif isinstance(dt, datetime.date) and not isinstance(dt, datetime.datetime):
             d = dt
             dt = datetime.datetime.combine(dt, datetime.time(0), tz_exchange)
         elif not isinstance(dt, datetime.datetime):
@@ -425,14 +479,20 @@
         if yfcm.IsDatumCached(self.ticker, "info"):
             self._info = yfcm.ReadCacheDatum(self.ticker, "info")
             return self._info
 
         self._info = self.dat.info
         yfcm.StoreCacheDatum(self.ticker, "info", self._info)
 
+        if "exchangeTimezoneName" in self._info:
+            tz = self._info["exchangeTimezoneName"]
+        else:
+            tz = self._info["timeZoneFullName"]
+        yfct.SetExchangeTzName(self._info["exchange"], tz)
+
         return self._info
 
     @property
     def fast_info(self):
         if self._fast_info is not None:
             return self._fast_info
 
@@ -683,27 +743,27 @@
         return self._news
 
     @property
     def yf_lag(self):
         if self._yf_lag is not None:
             return self._yf_lag
 
-        exchange_str = "exchange-{0}".format(self.fast_info["exchange"])
+        exchange_str = "exchange-{0}".format(self.info["exchange"])
         if yfcm.IsDatumCached(exchange_str, "yf_lag"):
             self._yf_lag = yfcm.ReadCacheDatum(exchange_str, "yf_lag")
             if self._yf_lag:
                 return self._yf_lag
 
         # Just use specified lag
-        specified_lag = yfcd.exchangeToYfLag[self.fast_info["exchange"]]
+        specified_lag = yfcd.exchangeToYfLag[self.info["exchange"]]
         self._yf_lag = specified_lag
         return self._yf_lag
 
 
-def verify_cached_tickers_prices(session=None, rtol=0.0001, vol_rtol=0.005, correct=False, resume_from_tkr=None, debug_tkr=None, debug_interval=None):
+def verify_cached_tickers_prices(session=None, rtol=0.0001, vol_rtol=0.005, correct=False, halt_on_fail=True, resume_from_tkr=None, debug_tkr=None, debug_interval=None):
     """
     :Parameters:
         session:
             Recommend providing a 'requests_cache' session, in case
             you have to abort and resume verification (likely).
         resume_from_tkr: str
             Resume verification from this ticker (alphabetical order).
@@ -757,20 +817,23 @@
             t.set_description("Verifying " + tkr)
         else:
             print(f"{tkr} : {i+1}/{len(tkrs)}")
 
         dat = Ticker(tkr, session=session)
 
         try:
-            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=correct, quiet=True, debug=debug, debug_interval=debug_interval)
+            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=correct, quiet=not debug, debug=debug, debug_interval=debug_interval)
         except yfcd.NoPriceDataInRangeException as e:
             print(str(e) + " - is it delisted? Aborting verification so you can investigate.")
             return
         if debug:
             return
 
         if correct:
-            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=False, quiet=True, debug=debug, debug_interval=debug_interval)
+            v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=correct, discard_old=False, quiet=not debug, debug=debug, debug_interval=debug_interval)
 
         if not v:
             v = dat.verify_cached_prices(rtol=rtol, vol_rtol=vol_rtol, correct=False, discard_old=False, quiet=False, debug=True, debug_interval=debug_interval)
-            raise Exception(f"{tkr}: verify failing")
+            if halt_on_fail:
+                raise Exception(f"{tkr}: verify failing")
+            else:
+                print(f"{tkr}: verify failing")
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_time.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_time.py`

 * *Files 2% similar despite different names*

```diff
@@ -233,15 +233,15 @@
         s = cal.schedule
 
     if s is not None:
         start_ts = pd.Timestamp(start_d)
         end_ts = pd.Timestamp(end_d_sub1)
         slice_start = s["idx_nanos"].values.searchsorted(start_ts.value, side="left")
         slice_end = s["idx_nanos"].values.searchsorted(end_ts.value, side="right")
-        sched = s[slice_start:slice_end]
+        sched = s[slice_start:slice_end].copy()
     else:
         sched = None
 
     if sched is None or sched.empty:
         df = None
     else:
         cols = ["open", "close"]
@@ -432,14 +432,16 @@
 
     if debug:
         print("GetExchangeWeekSchedule() returning")
     return weeks
 
 
 def MapPeriodToDates(exchange, period, interval):
+    yfcu.TypeCheckPeriod(period, "period")
+
     debug = False
     # debug = True
 
     if debug:
         print(f"MapPeriodToDates(exchange={exchange}, period={period}, interval={interval})")
 
     tz_name = GetExchangeTzName(exchange)
@@ -462,16 +464,18 @@
         print(f"- last_open_day={last_open_day} d_now={d_now}")
     end_d = last_open_day + td_1d
     if period == yfcd.Period.Max:
         start_d = date(yfcd.yf_min_year, 1, 1)
     elif period == yfcd.Period.Ytd:
         start_d = date(d_now.year, 1, 1)
     else:
+        if isinstance(period, yfcd.Period):
+            period = yfcd.periodToTimedelta[period]
         if yfcd.intervalToTimedelta[interval] <= timedelta(days=1):
-            start_d = DtSubtractPeriod(end_d, period)
+            start_d = end_d - period
             while not ExchangeOpenOnDay(exchange, start_d):
                 start_d += td_1d
 
             end_d = last_open_day+td_1d
 
         elif interval == yfcd.Interval.Week:
             if last_open_day.weekday() < 4:
@@ -480,26 +484,27 @@
             else:
                 last_full_week_start = d_now - timedelta(days=d_now.weekday())
             if last_full_week_start > last_open_day:
                 last_full_week_start -= timedelta(days=7)
             if debug:
                 print("- last_full_week_start =", last_full_week_start)
 
-            start_d = last_full_week_start + timedelta(days=7) - yfcd.periodToTimedelta[period]
+            start_d = last_full_week_start + timedelta(days=7) - period
 
         else:
             raise Exception("codepath not implemented")
 
     if debug:
         print(f"MapPeriodToDates() returning {start_d}->{end_d}")
 
     return start_d, end_d
 
 
-def GetExchangeScheduleIntervals(exchange, interval, start, end, discardTimes=None, week7days=True, ignore_breaks=False, exclude_future=True):
+# @lru_cache(maxsize=1000)  # 3.3% speedup
+def GetExchangeScheduleIntervals(exchange, interval, start, end, discardTimes=None, week7days=True, weekForceStartMonday=True, ignore_breaks=False, exclude_future=True):
     yfcu.TypeCheckStr(exchange, "exchange")
     if start >= end:
         raise Exception("start={} must be < end={}".format(start, end))
     yfcu.TypeCheckIntervalDt(start, interval, "start", strict=False)
     yfcu.TypeCheckIntervalDt(end, interval, "end", strict=False)
     if discardTimes is not None:
         yfcu.TypeCheckBool(discardTimes, "discardTimes")
@@ -659,34 +664,36 @@
         s = GetExchangeSchedule(exchange, start_d, end_d)
         if s is None or s.empty:
             return None
         if exclude_future:
             s = s[s["open"] <= dt_now]
             if s.empty:
                 return None
+            s = s.copy()
         if debug:
             print("- sched:")
             print(s)
         if discardTimes:
             open_days = np.array([dt.to_pydatetime().astimezone(tz).date() for dt in s["open"]])
             intervals = yfcd.DateIntervalIndex.from_arrays(open_days, open_days+td_1d, closed="left")
         else:
             if "auction" in s.columns:
                 s["close"] = s["auction"] + yfcd.exchangeAuctionDuration[exchange]
             intervals = pd.IntervalIndex.from_arrays(s["open"], s["close"], closed="left")
 
     elif interval == yfcd.Interval.Week:
+        # There is reason for this madness of conditionally igoring holidays & weekends, don't mess with it.
         if week7days:
-            week_sched = GetExchangeWeekSchedule(exchange, start, end, ignoreHolidays=False, ignoreWeekends=False)
+            week_sched = GetExchangeWeekSchedule(exchange, start, end, ignoreHolidays=False, ignoreWeekends=False, forceStartMonday=True)
             if week_sched is not None:
                 if exclude_future:
                     week_sched = week_sched[week_sched["open"] <= dt_now]
                 intervals = yfcd.DateIntervalIndex.from_arrays(week_sched.index.left.date, week_sched.index.right.date, closed="left")
         else:
-            week_sched = GetExchangeWeekSchedule(exchange, start, end, ignoreHolidays=True, ignoreWeekends=True, forceStartMonday=True)
+            week_sched = GetExchangeWeekSchedule(exchange, start, end, ignoreHolidays=True, ignoreWeekends=True, forceStartMonday=weekForceStartMonday)
             if week_sched is not None:
                 if exclude_future:
                     week_sched = week_sched[week_sched["open"] <= dt_now]
                 if discardTimes:
                     intervals = yfcd.DateIntervalIndex.from_arrays(week_sched["open"].dt.date, week_sched["close"].dt.date+td_1d, closed="left")
                 else:
                     intervals = pd.IntervalIndex.from_arrays(week_sched["open"], week_sched["close"], closed="left")
@@ -989,15 +996,15 @@
             # Monday -> next Monday regardless of exchange schedule
             wd = pd.to_timedelta(ts.weekday, unit='D')
             weekSchedStart = ts - wd
             weekSchedEnd = weekSchedStart + timedelta(days=7)
             weekSchedStart = weekSchedStart.date
             weekSchedEnd = weekSchedEnd.date
         else:
-            week_sched = GetExchangeScheduleIntervals(exchange, interval, t0, tl, discardTimes, week7days=False)
+            week_sched = GetExchangeScheduleIntervals(exchange, interval, t0, tl, discardTimes, week7days=False, weekForceStartMonday=False)
             if debug:
                 print("- week_sched:")
                 print(week_sched)
             weekSchedStart = np.full(n, None)
             weekSchedEnd = np.full(n, None)
             if discardTimes:
                 idx = week_sched.get_indexer(ts_day)
@@ -1125,15 +1132,16 @@
                 print(s)
             interval_open = s["market_open"]
             interval_close = s["market_close"]
         if debug:
             print("GetTimestampNextInterval() returning")
         return {"interval_open": interval_open, "interval_close": interval_close}
     elif interval == yfcd.Interval.Week:
-        week_sched = GetExchangeScheduleIntervals(exchange, interval, ts_day, ts_day+14*td_1d, discardTimes, week7days, ignore_breaks)
+        week_sched = GetExchangeScheduleIntervals(exchange, interval, ts_day, ts_day+14*td_1d, 
+                                                  discardTimes=discardTimes, week7days=week7days, weekForceStartMonday=week7days, ignore_breaks=ignore_breaks)
         if debug:
             print("- week_sched:")
             print(week_sched)
         if not ts_is_datetime:
             if discardTimes:
                 skip_first = ts_day >= week_sched.left[0]
             else:
@@ -1242,14 +1250,17 @@
             print("GetTimestampNextInterval_batch() returning")
         return None
 
     n = len(ts)
     tz = ZoneInfo(GetExchangeTzName(exchange))
     intervals = [None]*n
 
+    if debug:
+        print("- ts:") ; print(ts)
+
     td_1d = timedelta(days=1)
     tz = ZoneInfo(GetExchangeTzName(exchange))
     ts_is_datetimes = isinstance(ts[0], datetime)
     if debug:
         print("- ts_is_datetimes =", ts_is_datetimes)
     if ts_is_datetimes:
         ts = pd.to_datetime(ts)
@@ -1274,15 +1285,15 @@
 
         if week7days:
             # Monday -> next Monday regardless of exchange schedule
             wd = pd.to_timedelta(ts.weekday, unit='D')
             weekSchedStart = (ts - wd + timedelta(days=7)).date
             weekSchedEnd = weekSchedStart + timedelta(days=7)
         else:
-            week_sched = GetExchangeScheduleIntervals(exchange, interval, t0, tl, discardTimes, week7days, exclude_future=False)
+            week_sched = GetExchangeScheduleIntervals(exchange, interval, t0, tl, discardTimes=discardTimes, week7days=week7days, weekForceStartMonday=week7days, exclude_future=False)
             if debug:
                 print("- week_sched:", type(week_sched))
                 for x in week_sched:
                     print(x)
             if ts_is_datetimes and not discardTimes:
                 idx = week_sched.get_indexer(ts)
             else:
@@ -1313,16 +1324,17 @@
                 print(idx)
             weekSchedStart = week_sched.left[idx]
             weekSchedEnd = week_sched.right[idx]
 
         intervals = pd.DataFrame(data={"interval_open": weekSchedStart, "interval_close": weekSchedEnd}, index=ts)
 
     elif interval == yfcd.Interval.Days1:
-        t0 = ts_day[0]
-        tl = ts_day[len(ts_day)-1]
+        f_nna = ~pd.isna(ts_day)
+        t0 = ts_day[f_nna][0]
+        tl = ts_day[f_nna][-1]
         sched = GetExchangeSchedule(exchange, t0, tl+timedelta(days=14))
         if "auction" in sched.columns:
             sched["close"] = sched["auction"] + yfcd.exchangeAuctionDuration[exchange]
         if debug:
             print("- sched:")
             print(sched)
 
@@ -1447,16 +1459,14 @@
         pprint(intervalSched)
 
     if yf_lag is not None:
         yfcu.TypeCheckTimedelta(yf_lag, "yf_lag")
     else:
         yf_lag = GetExchangeDataDelay(exchange)
 
-    yf_lag += timedelta(minutes=15)  # allow 15m extra for Yahoo to update
-
     if intervalSched is None or intervalSched.empty:
         # Exchange closed so data cannot update/expire
         lastDataDt = irange["interval_close"]
         if not isinstance(lastDataDt, pd.Timestamp):
             lastDataDt = pd.Timestamp(lastDataDt).tz_localize(tz)
         if debug:
             print("CalcIntervalLastDataDt() returning {} because exchange closed".format(lastDataDt))
@@ -1507,16 +1517,14 @@
         print(intervalStart)
 
     if yf_lag is not None:
         yfcu.TypeCheckTimedelta(yf_lag, "yf_lag")
     else:
         yf_lag = GetExchangeDataDelay(exchange)
 
-    yf_lag += timedelta(minutes=15)  # allow 15m extra for Yahoo to update
-
     tz = ZoneInfo(GetExchangeTzName(exchange))
     i_td = yfcd.intervalToTimedelta[interval]
     intraday = i_td < timedelta(days=1)
     interday = not intraday
 
     if interday and isinstance(intervalStart[0], (datetime, pd.Timestamp)):
         intervalStart = [dt.date() for dt in intervalStart]
@@ -1571,28 +1579,26 @@
         print(sched)
 
     intervals = intervals.merge(sched, on="interval_open_day", how="left")
     intervals = intervals.rename(columns={"close": "market_close", "open": "market_open"})
     if debug:
         print("- intervals:")
         print(intervals)
-    iopens = intervals["market_open"]
-    if debug:
-        print("- iopens:", type(iopens[0]))
-        print(iopens)
-    icloses = intervals["market_close"]
+    mcloses = intervals["market_close"]
     if debug:
-        print("- icloses:", type(icloses[0]))
+        print("- mcloses:", type(mcloses[0]))
+        print(mcloses)
+        print("- icloses:")
         print(icloses)
 
     # For daily intervals, Yahoo data is updating until midnight. I guess aftermarket.
     i_td = yfcd.intervalToTimedelta[interval]
     if i_td >= timedelta(days=1):
         # lastDataDt = start of next interval, even if next day (or later)
-        next_intervals = GetTimestampNextInterval_batch(exchange, icloses.to_numpy(), yfcd.Interval.Days1, discardTimes=False, ignore_breaks=ignore_breaks)
+        next_intervals = GetTimestampNextInterval_batch(exchange, mcloses.to_numpy(), yfcd.Interval.Days1, discardTimes=False, ignore_breaks=ignore_breaks)
         if debug:
             print("- next_intervals:")
             print(next_intervals)
         lastDataDt = next_intervals["interval_open"].to_numpy() + yf_lag
         if f_na.any():
             lastDataDt[f_na] = pd.NaT
 
@@ -1609,22 +1615,25 @@
 
     if debug:
         print("CalcIntervalLastDataDt_batch() returning")
 
     return lastDataDt
 
 
-def IsPriceDatapointExpired(intervalStart, fetch_dt, max_age, exchange, interval, ignore_breaks=False, triggerExpiryOnClose=True, yf_lag=None, dt_now=None):
+def IsPriceDatapointExpired(intervalStart, fetch_dt, repaired, max_age, exchange, interval, ignore_breaks=False, triggerExpiryOnClose=True, yf_lag=None, dt_now=None):
     yfcu.TypeCheckIntervalDt(intervalStart, interval, "intervalStart", strict=False)
     yfcu.TypeCheckDatetime(fetch_dt, "fetch_dt")
+    yfcu.TypeCheckBool(repaired, "repaired")
     yfcu.TypeCheckTimedelta(max_age, "max_age")
     yfcu.TypeCheckStr(exchange, "exchange")
     yfcu.TypeCheckInterval(interval, "interval")
     yfcu.TypeCheckBool(triggerExpiryOnClose, "triggerExpiryOnClose")
 
+    # TODO: unit tests for 'repaired' arg
+
     debug = False
     # debug = True
 
     if debug:
         print("") ; print("")
         print(f"IsPriceDatapointExpired(exchange={exchange} intervalStart={intervalStart}, fetch_dt={fetch_dt}, max_age={max_age}, interval={interval}, triggerExpiryOnClose={triggerExpiryOnClose}, dt_now={dt_now})")
 
@@ -1656,14 +1665,20 @@
     if debug:
         print("- intervalEnd_d = {0}".format(intervalEnd_d))
 
     lastDataDt = CalcIntervalLastDataDt(exchange, intervalStart, interval, ignore_breaks=ignore_breaks, yf_lag=yf_lag)
     if debug:
         print("- lastDataDt = {}".format(lastDataDt))
 
+    if repaired:
+        # Give Yahoo 1 week to fix their data, so yfinance doesn't have to repair
+        if debug:
+            print("- adding 1wk to lastDataDt because data was repaired")
+        lastDataDt += timedelta(days=7)
+
     # Decide if was fetched after last Yahoo update
     if interval in [yfcd.Interval.Days1, yfcd.Interval.Week]:
         if fetch_dt >= lastDataDt:
             # interval already closed before fetch, nothing to do.
             if debug:
                 print("- fetch_dt > lastDataDt so return FALSE")
             return False
@@ -1705,19 +1720,14 @@
         fetch_d = fetch_dt.date()
         if fetch_dt < lastDataDt:
             if lastDataDt <= dt_now:
                 # Even though fetched data hasn't fully aged, the candle has since closed so treat as expired
                 if debug:
                     print("- triggerExpiryOnClose and interval closed so return TRUE")
                 return True
-            elif interval == yfcd.Interval.Days1 and fetch_d == irange["interval_open"] and dt_now.date() > fetch_d:
-                # Midnight of the trading day has passed so trigger fetch
-                if debug:
-                    print("- triggerExpiryOnClose and 1d interval midnight passed so return TRUE")
-                return True
         if interval in [yfcd.Interval.Days1, yfcd.Interval.Week]:
             # If last fetch was anytime within interval, even post-market,
             # and dt_now is next day (or later) then trigger
             if fetch_dt.date() <= intervalEnd_d and dt_now.date() > intervalEnd_d:
                 if debug:
                     print("- triggerExpiryOnClose and interval midnight passed since fetch so return TRUE")
                 return True
@@ -1902,16 +1912,16 @@
         else:
             return date(dt.year, 1, 1)
 
     elif period == yfcd.Period.Max:
         raise Exception("Codepath not implemented")
 
     else:
-        ptd = yfcd.periodToTimedelta[period]
-        return dt - ptd
+        # 'period' should be type Timedelta
+        return dt - period
 
 
 def GetSystemTz():
     dt = datetime.utcnow().astimezone()
 
     tzn = dt.tzname()
     if tzn == "BST":
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_upgrade.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_upgrade.py`

 * *Files 9% similar despite different names*

```diff
@@ -6,15 +6,15 @@
 import pandas as pd
 import numpy as np
 import datetime
 import click
 
 from . import yfc_cache_manager as yfcm
 # from . import yfc_utils as yfcu
-# from . import yfc_time as yfct
+from . import yfc_time as yfct
 from . import yfc_dat as yfcd
 from . import yfc_ticker as yfc
 from . import yfc_prices_manager as yfcp
 
 import yfinance as yf
 
 
@@ -56,14 +56,20 @@
                 df = prices_pkl["data"]
                 df_modified = False
 
                 if "Adj Close" in df.columns:
                     df = df.drop("Adj Close", axis=1)
                     df_modified = True
 
+                if "Repaired?" in df.columns:
+                    f_na = df["Repaired?"].isna()
+                    if f_na.any():
+                        df.loc[f_na, "Repaired?"] = False
+                        df_modified = True
+
                 if df_modified:
                     prices_pkl["data"] = df
                     with open(prices_fp, 'wb') as f:
                         pickle.dump(prices_pkl, f, 4)
 
     if not os.path.isdir(yfc_dp):
         os.makedirs(yfc_dp)
@@ -233,15 +239,19 @@
             fp = os.path.join(tkrd, "fast_info.pkl")
             if os.path.isfile(fp):
                 with open(fp, 'rb') as f:
                     tz = ZoneInfo(pickle.load(f)["data"]["timezone"])
             else:
                 fp = os.path.join(tkrd, "info.pkl")
                 with open(fp, 'rb') as f:
-                    tz = ZoneInfo(pickle.load(f)["data"]["exchangeTimezoneName"])
+                    info = pickle.load(f)["data"]
+                    if "exchangeTimezoneName" in info:
+                        tz = ZoneInfo(info["exchangeTimezoneName"])
+                    else:
+                        tz = ZoneInfo(info["timeZoneFullName"])
 
             # Add 'FetchDate'
             if divs_df.empty:
                 divs_fetch_dt = pd.NaT
             else:
                 divs_fetch_dt = datetime.datetime.combine(divs_df.index[-1], datetime.time(10), tz)
             divs_df["FetchDate"] = divs_fetch_dt
@@ -478,14 +488,28 @@
         lst_fp = os.path.join(tkrd, "listing_date.json")
         if os.path.isfile(lst_fp):
             dat = yf.Ticker(tkr)
             df = dat.history(period="1d")
             if "firstTradeDate" not in dat.history_metadata:
                 continue
             listing_date = dat.history_metadata["firstTradeDate"]
+            if isinstance(listing_date, int):
+                fp_info = os.path.join(tkrd, "fast_info.pkl")
+                if os.path.isfile(fp_info):
+                    with open(fp_info, 'rb') as f:
+                        tz = pickle.load(f)["data"]["timezone"]
+                else:
+                    fp_info = os.path.join(tkrd, "info.pkl")
+                    with open(fp_info, 'rb') as f:
+                        info = pickle.load(f)["data"]
+                        if "exchangeTimezoneName" in info:
+                            tz = info["exchangeTimezoneName"]
+                        else:
+                            tz = info["timeZoneFullName"]
+                listing_date = pd.to_datetime(listing_date, unit='s', utc=True).tz_convert(tz)
             yfcm.StoreCacheDatum(tkr, "listing_date", listing_date.date())
 
             for interval in yfcd.Interval:
                 istr = yfcd.intervalToString[interval]
                 prices_fp = os.path.join(tkrd, f"history-{istr}.pkl")
                 if not os.path.isfile(prices_fp):
                     continue
@@ -558,56 +582,161 @@
 
     if not os.path.isdir(yfc_dp):
         os.makedirs(yfc_dp)
     with open(state_fp, 'w') as f:
         pass
 
 
-# def _fix_lost_divs():
-#     d = yfcm.GetCacheDirpath()
-#     yfc_dp = os.path.join(d, "_YFC_")
-#     state_fp = os.path.join(yfc_dp, "have-fixed-lost-divs")
-#     if os.path.isfile(state_fp):
-#         return
-
-#     if not os.path.isdir(d):
-#         if not os.path.isdir(yfc_dp):
-#             os.makedirs(yfc_dp)
-#         with open(state_fp, 'w') as f:
-#             pass
-#         return
-
-#     for tkr in os.listdir(d):
-#         if tkr.startswith("EXCHANGE-") or tkr.startswith('_'):
-#             # Not a security
-#             continue
-#         tkrd = os.path.join(d, tkr)
-
-#         prices_fp = os.path.join(tkrd, "history-1d.pkl")
-#         if not os.path.isfile(prices_fp):
-#             continue
-
-#         with open(prices_fp, 'rb') as f:
-#             prices_pkl = pickle.load(f)
-#         df = prices_pkl["data"]
-#         divs = df.loc[df["Dividends"]!=0, ["Dividends", "FetchDate"]]
-#         if divs.empty:
-#             continue
-
-#         divs["Close day before"] = np.nan
-#         for dt in divs.index:
-#             if dt >= df.index[1]:
-#                 idx = df.index.get_loc(dt)
-#                 close_day_before = df["Close"].iloc[idx-1]
-#             else:
-#                 close_day_before = df["Close"].iloc[0]
-#             divs.loc[dt, "Close day before"] = close_day_before
-
-#         # histories_manager = yfcp.HistoriesManager(tkr, exchange, tz_name, self.session, proxy)
-#         dat = yfc.Ticker(tkr)
-#         dat._getCachedPrices(yfcd.Interval.Days1)  # initialises history manager
-#         dat._histories_manager.GetHistory("Events").UpdateDividends(divs)
-
-#     if not os.path.isdir(yfc_dp):
-#         os.makedirs(yfc_dp)
-#     with open(state_fp, 'w') as f:
-#         pass
+def _add_repaired_column():
+    d = yfcm.GetCacheDirpath()
+    yfc_dp = os.path.join(d, "_YFC_")
+    state_fp = os.path.join(yfc_dp, "have-added-repaired-column")
+    if os.path.isfile(state_fp):
+        return
+
+    if not os.path.isdir(d):
+        if not os.path.isdir(yfc_dp):
+            os.makedirs(yfc_dp)
+        with open(state_fp, 'w') as f:
+            pass
+        return
+
+    tkrs = os.listdir(d)
+    for tkr in tkrs:
+        tkrd = os.path.join(d, tkr)
+
+        for interval in yfcd.intervalToString.values():
+            prices_fp = os.path.join(tkrd, f"history-{interval}.pkl")
+            if os.path.isfile(prices_fp):
+                with open(prices_fp, 'rb') as f:
+                    prices_pkl = pickle.load(f)
+                df = prices_pkl["data"]
+                df_modified = False
+
+                if not "Repaired?" in df.columns:
+                    df["Repaired?"] = False
+                    df_modified = True
+
+                if df_modified:
+                    prices_pkl["data"] = df
+                    with open(prices_fp, 'wb') as f:
+                        pickle.dump(prices_pkl, f, 4)
+
+    if not os.path.isdir(yfc_dp):
+        os.makedirs(yfc_dp)
+    with open(state_fp, 'w') as f:
+        pass
+
+
+def _recalc_final_column():
+    d = yfcm.GetCacheDirpath()
+    yfc_dp = os.path.join(d, "_YFC_")
+    state_fp = os.path.join(yfc_dp, "have-recalced-final-column")
+    if os.path.isfile(state_fp):
+        return
+
+    if not os.path.isdir(d):
+        if not os.path.isdir(yfc_dp):
+            os.makedirs(yfc_dp)
+        with open(state_fp, 'w') as f:
+            pass
+        return
+
+    # print("Running: _recalc_final_column()")
+    print("Fixing 'Final?' column, may take a few minutes (~500 symbols per minute)")
+
+    tkrs = os.listdir(d)
+    try:
+        import tqdm
+        tkrs = tqdm.tqdm(tkrs)
+    except:
+        pass
+    for tkr in tkrs:
+        tkrd = os.path.join(d, tkr)
+
+        exchange = None
+
+        for interval in yfcd.intervalToString.keys():
+            istr = yfcd.intervalToString[interval]
+            prices_fp = os.path.join(tkrd, f"history-{istr}.pkl")
+            if os.path.isfile(prices_fp):
+                with open(prices_fp, 'rb') as f:
+                    prices_pkl = pickle.load(f)
+                df = prices_pkl["data"]
+                df_modified = False
+
+                if exchange is None:
+                    fp = os.path.join(tkrd, "fast_info.pkl")
+                    if not os.path.isfile(fp):
+                        fp = os.path.join(tkrd, "info.pkl")
+                    with open(fp, 'rb') as f:
+                        exchange = pickle.load(f)["data"]["exchange"]
+
+                interday = interval in [yfcd.Interval.Days1, yfcd.Interval.Week, yfcd.Interval.Months1, yfcd.Interval.Months3]
+                intervals = yfct.GetTimestampCurrentInterval_batch(exchange, df.index.to_numpy(), interval, discardTimes=interday, ignore_breaks=True)
+                lastDataDts = yfct.CalcIntervalLastDataDt_batch(exchange, intervals["interval_open"].to_numpy(), interval)
+                f_na = intervals["interval_open"].isna().to_numpy()
+                if f_na.any():
+                    # Hacky solution to handle xcal having incorrect schedule, for valid Yahoo data
+                    itd = yfcd.intervalToTimedelta[interval]
+                    lastDataDts[f_na] = intervals.index[f_na] + itd
+                    if not interday:
+                        lastDataDts[f_na] += yfct.GetExchangeDataDelay(exchange)
+                        # For some exchanges, Yahoo has trades that occurred soon afer official market close, e.g. Johannesburg:
+                        if exchange in ["JNB"]:
+                            lastDataDts[f_na] += timedelta(minutes=15)
+                data_final = (df["FetchDate"] >= lastDataDts).to_numpy()
+                df_modified = (data_final != df["Final?"].to_numpy()).any()
+                if df_modified:
+                    df["Final?"] = data_final
+                    prices_pkl["data"] = df
+                    with open(prices_fp, 'wb') as f:
+                        pickle.dump(prices_pkl, f, 4)
+
+    if not os.path.isdir(yfc_dp):
+        os.makedirs(yfc_dp)
+    with open(state_fp, 'w') as f:
+        pass
+
+
+def _upgrade_divs_supersede_again():
+    d = yfcm.GetCacheDirpath()
+    yfc_dp = os.path.join(d, "_YFC_")
+    state_fp = os.path.join(yfc_dp, "have-upgraded-div-supersede-again")
+    if os.path.isfile(state_fp):
+        return
+
+    if not os.path.isdir(d):
+        if not os.path.isdir(yfc_dp):
+            os.makedirs(yfc_dp)
+        with open(state_fp, 'w') as f:
+            pass
+        return
+
+    for tkr in os.listdir(d):
+        if tkr.startswith("EXCHANGE-") or tkr.startswith('_'):
+            # Not a security
+            continue
+
+        tkrd = os.path.join(d, tkr)
+
+        divs_fp = os.path.join(tkrd, "dividends.pkl")
+        if os.path.isfile(divs_fp):
+            with open(divs_fp, 'rb') as f:
+                divsPklData = pickle.load(f)
+            divs_df = divsPklData["data"]
+
+            # Add column "Superseded div"
+            divs_df["Superseded div"] = 0.0
+            f = divs_df["Superseded back adj."].to_numpy() != 0.0
+            if f.any():
+                ratio = (1.0-divs_df.loc[f,"Superseded back adj."].to_numpy()) / (1.0-divs_df.loc[f,"Back Adj."].to_numpy())
+                divs_df.loc[f,"Superseded div"] = ratio * divs_df.loc[f,"Dividends"].to_numpy()
+
+            divsPklData["data"] = divs_df
+            with open(divs_fp, 'wb') as f:
+                pickle.dump(divsPklData, f, 4)
+
+    if not os.path.isdir(yfc_dp):
+        os.makedirs(yfc_dp)
+    with open(state_fp, 'w') as f:
+        pass
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache/yfc_utils.py` & `yfinance-cache-0.4.4/yfinance_cache/yfc_utils.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,23 +1,24 @@
 from datetime import datetime, date, timedelta
+from dateutil.relativedelta import relativedelta
 from zoneinfo import ZoneInfo
 import re
 from pprint import pprint
 import numpy as np
 import math
 import pandas as pd
 
 from . import yfc_dat as yfcd
 
 
 def TypeCheckStr(var, varName):
     if not isinstance(var, str):
         raise TypeError(f"'{varName}' must be str not {type(var)}")
 def TypeCheckBool(var, varName):
-    if not isinstance(var, bool):
+    if not isinstance(var, (bool, np.bool_)):
         raise TypeError(f"'{varName}' must be bool not {type(var)}")
 def TypeCheckFloat(var, varName):
     if not isinstance(var, (float, np.float32, np.float64)):
         raise TypeError(f"'{varName}' must be float not {type(var)}")
 def TypeCheckInt(var, varName):
     if not isinstance(var, (int, np.int32, np.int64)):
         raise TypeError(f"'{varName}' must be int not {type(var)}")
@@ -69,16 +70,16 @@
                 TypeCheckDatetime(var, varName)
             else:
                 TypeCheckDateEasy(var, varName)
     except Exception as e:
         raise TypeError(str(e) + " for interval "+yfcd.intervalToString[interval])
 
 def TypeCheckPeriod(var, varName):
-    if not isinstance(var, yfcd.Period):
-        raise TypeError(f"'{varName}' must be yfcd.Period not {type(var)}")
+    if not isinstance(var, yfcd.Period) and not isinstance(var, (timedelta, pd.Timedelta, relativedelta)):
+        raise TypeError(f"'{varName}' must be Timedelta or yfcd.Period not {type(var)}")
 
 def TypeCheckNpArray(var, varName):
     if not isinstance(var, np.ndarray):
         raise TypeError(f"'{varName}' must be numpy array not {type(var)}")
 def TypeCheckDataFrame(var, varName):
     if not isinstance(var, pd.DataFrame):
         raise TypeError(f"'{varName}' must be pd.DataFrame not {type(var)}")
@@ -382,117 +383,185 @@
     h_divs = h_divs[h_divs.index.isin(yf_divs.index)]
     yf_divs = yf_divs[yf_divs.index.isin(h_divs.index)]
     f_close = np.isclose(h_divs[c].to_numpy(), yf_divs.to_numpy(), rtol=rtol)
     f_close = pd.Series(f_close, h_divs.index)
     f_diff = ~f_close
     if f_diff.any():
         n_diff = np.sum(f_diff)
-        print(f"{n_diff}/{n} differences in column {c}")
-        df_diffs = h_divs[f_diff].join(yf_divs[f_diff], lsuffix="_cache", rsuffix="_Yahoo")
-        df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_Yahoo"]
-        df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_Yahoo"]).round(1).astype(str) + '%'
+        if not quiet:
+            print(f"WARNING: {istr}: {n_diff}/{n} differences in column {c}")
+        df_diffs = h_divs[f_diff].join(yf_divs[f_diff], lsuffix="_cache", rsuffix="_yf")
+        df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_yf"]
+        df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_yf"]).round(1).astype(str) + '%'
         if not quiet:
             print(df_diffs)
         f_diff_all = f_diff_all | f_diff
         divs_bad = True
 
     # Verify stock splits
     # - first compare dates
     c = "Stock Splits"
     h_ss = h.loc[h[c] != 0.0, [c, "FetchDate"]].copy().dropna()
     yf_ss = df_yf.loc[df_yf[c] != 0.0, c]
     dts_missing_from_cache = yf_ss.index[~yf_ss.index.isin(h_ss.index)]
     dts_missing_from_yf = h_ss.index[~h_ss.index.isin(yf_ss.index)]
+    splits_bad = False
     if len(dts_missing_from_cache) > 0:
         if not quiet:
             print("WARNING: Stock splits missing from cache:")
             print("- ", dts_missing_from_cache)
         for dt in dts_missing_from_cache:
             f_diff_all.loc[dt] = True
     # - now compare values
     h_ss = h_ss[h_ss.index.isin(yf_ss.index)]
     yf_ss = yf_ss[yf_ss.index.isin(h_ss.index)]
-    f_close = np.isclose(h_ss.to_numpy(), yf_ss.to_numpy(), rtol=rtol)
-    f_diff = ~f_close
-    if f_diff.any():
-        n_diff = np.sum(f_diff)
-        if not quiet:
-            print(f"{n_diff}/{n} differences in column {c}")
-        df_diffs = pd.DataFrame(h_ss[f_diff]).join(yf_ss[f_diff], lsuffix="_cache", rsuffix="_Yahoo")
-        df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_Yahoo"]
-        df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_Yahoo"]).round(2).astype(str) + '%'
-        raise Exception("Need to test handling stock split mismatches - prune stock-split store?")
+    if not yf_ss.empty:
+        f_close = np.isclose(h_ss[c].to_numpy(), yf_ss.to_numpy(), rtol=rtol)
+        f_diff = ~f_close
+        if f_diff.any():
+            n_diff = np.sum(f_diff)
+            if not quiet:
+                print(f"WARNING: {istr}: {n_diff}/{n} differences in column {c}")
+            df_diffs = h_ss.join(yf_ss[f_diff], lsuffix="_cache", rsuffix="_yf")
+            df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_yf"]
+            df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_yf"]).round(2).astype(str) + '%'
+            if not quiet:
+                print(df_diffs)
+            f_diff_all = f_diff_all | f_diff
+            splits_bad = True
 
     def _print_sig_diffs(df, df_yf, column, rtol):
         c = column
         f_close = np.isclose(df[c].to_numpy(), df_yf[c].to_numpy(), rtol=rtol)
         f_diff = ~f_close
         if f_diff.any():
-            df_diffs = df.loc[f_diff, ["FetchDate", c]].join(df_yf.loc[f_diff, [c]], lsuffix="_cache", rsuffix="_Yahoo")
+            # Use looser tolerance if different 'Repaired?' states
+            f_repair_mismatch = np.logical_xor(df["Repaired?"].to_numpy(), df_yf["Repaired?"].to_numpy())
+            if f_repair_mismatch.any():
+                if column == 'Volume':
+                    loose_tol = 0.5
+                else:
+                    loose_tol = 0.1
+                f_diff[f_repair_mismatch] = ~np.isclose(df[c].to_numpy()[f_repair_mismatch], df_yf[c].to_numpy()[f_repair_mismatch], rtol=loose_tol)
+
+        if f_diff.any():
+            cols = ["FetchDate"]
+            if "Adj" in column:
+                cols.append("LastDivAdjustDt")
+            cols.append("Repaired?")
+            cols.append(c)
+            # yahoo_cols = [c]
+            yahoo_cols = [c, "Repaired?"]
+            df_diffs = df.loc[f_diff, cols].join(df_yf.loc[f_diff, yahoo_cols], lsuffix="_cache", rsuffix="_yf")
             df_diffs.index = df_diffs.index.tz_convert(df.index[0].tz)
 
-            df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_Yahoo"]
-            df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_Yahoo"]).round(2).astype(str) + '%'
+            df_diffs["error"] = df_diffs[c+"_cache"] - df_diffs[c+"_yf"]
+            df_diffs["error %"] = (df_diffs["error"]*100 / df_diffs[c+"_yf"]).round(2).astype(str) + '%'
 
+            # Combine the 'Repaired?' columns
+            df_diffs["Repaired?"] = "cache="
+            f = df_diffs["Repaired?_cache"].to_numpy()
+            df_diffs.loc[f,"Repaired?"] += 'Y'
+            df_diffs.loc[~f,"Repaired?"] += 'N'
+            df_diffs["Repaired?"] += ' yf='
+            f = df_diffs["Repaired?_yf"].to_numpy()
+            df_diffs.loc[f,"Repaired?"] += 'Y'
+            df_diffs.loc[~f,"Repaired?"] += 'N'
+            df_diffs = df_diffs.drop(["Repaired?_cache", "Repaired?_yf"], axis=1)
+
+            df_diffs["FetchDate"] = df_diffs["FetchDate"].dt.tz_convert(df.index.tz)
+            df_diffs["FetchDate"] = df_diffs["FetchDate"].dt.strftime("%Y-%m-%d %H:%M:%S%z")
+            if "LastDivAdjustDt" in df_diffs.columns:
+                df_diffs["LastDivAdjustDt"] = df_diffs["LastDivAdjustDt"].dt.tz_convert(df.index.tz)
+                df_diffs["LastDivAdjustDt"] = df_diffs["LastDivAdjustDt"].dt.strftime("%Y-%m-%d %H:%M:%S%z")
             f_diff_n = sum(f_diff)
             msg = f"WARNING: {istr}: {f_diff_n}/{n} sig. diffs in column {c} with rtol={rtol}"
             print(msg)
             print(df_diffs)
 
     # Verify volumes match
     c = "Volume"
     f_close = np.isclose(h[c].to_numpy(), df_yf[c].to_numpy(), vol_rtol)
     f_close = pd.Series(f_close, h.index)
     f_yfZeroVol = df_yf[c].to_numpy() == 0
     if f_yfZeroVol.any():
         # Ignore differences where YF volume = 0, because what has happened
         # is cached data contains repair but now too old for YF to repair
         if debug:
-            msg = f"ignoring {np.sum(f_yfZeroVol & ~f_close)} diffs where YF volume = 0"
+            msg = f"ignoring {np.sum(f_yfZeroVol)} diffs where YF volume = 0"
             print("- " + msg)
         f_close[f_yfZeroVol] = True
     f_diff_vol = ~f_close
     if f_diff_vol.any():
+        # Use looser tolerance if different 'Repaired?' states
+        f_repair_mismatch = np.logical_xor(h["Repaired?"].to_numpy(), df_yf["Repaired?"].to_numpy())
+        if f_repair_mismatch.any():
+            # loose_tol = 0.5
+            loose_tol = 1.0
+            f_diff_vol[f_repair_mismatch] = ~np.isclose(h[c].to_numpy()[f_repair_mismatch], df_yf[c].to_numpy()[f_repair_mismatch], rtol=loose_tol)
+    if f_diff_vol.any():
         if debug:
             _print_sig_diffs(h, df_yf, "Volume", vol_rtol)
         elif not quiet:
             msg = f"WARNING: {istr}: {np.sum(f_diff_vol)}/{n} differences in 'Volume'"
             # If very few date(times), append to string
             if not interday and np.sum(f_diff_vol) == 1:
                 msg += f" @ {h.index[f_diff_vol]}"
             elif interday and np.sum(f_diff_vol) < 2:
                 msg += f" @ {h.index.date[f_diff_vol]}"
             print(msg)
         f_diff_all = f_diff_all | f_diff_vol
 
+    f_diff_prices = pd.Series(np.full(h.shape[0], False), h.index)
     for c in ["Open", "Close", "High", "Low"]:
         f_close = np.isclose(h[c].to_numpy(), df_yf[c].to_numpy(), rtol)
         f_close = pd.Series(f_close, h.index)
         f_diff_c = ~f_close
         if f_diff_c.any():
+            # Use looser tolerance if different 'Repaired?' states
+            f_repair_mismatch = np.logical_xor(h["Repaired?"].to_numpy(), df_yf["Repaired?"].to_numpy())
+            if f_repair_mismatch.any():
+                loose_tol = 0.1
+                f_diff_c[f_repair_mismatch] = ~np.isclose(h[c].to_numpy()[f_repair_mismatch], df_yf[c].to_numpy()[f_repair_mismatch], rtol=loose_tol)
+        if f_diff_c.any():
             if debug:
                 _print_sig_diffs(h, df_yf, c, rtol)
             elif not quiet:
-                msg = f"WARNING: {istr}: {np.sum(f_diff_vol)}/{n} differences in '{c}'"
+                msg = f"WARNING: {istr}: {np.sum(f_diff_c)}/{n} differences in '{c}'"
                 # If very few date(times), append to string
-                if not interday and np.sum(f_diff_vol) == 1:
-                    msg += f" @ {h.index[f_diff_vol]}"
-                elif interday and np.sum(f_diff_vol) < 2:
-                    msg += f" @ {h.index.date[f_diff_vol]}"
+                if not interday and np.sum(f_diff_c) == 1:
+                    msg += f" @ {h.index[f_diff_c]}"
+                elif interday and np.sum(f_diff_c) < 2:
+                    msg += f" @ {h.index.date[f_diff_c]}"
                 print(msg)
-            f_diff_all = f_diff_all | f_diff_c
+            f_diff_prices = f_diff_prices | f_diff_c
+    prices_bad = f_diff_prices.any()
+    f_diff_all = f_diff_all | f_diff_prices
 
-    if not divs_bad:
-        f_diff_divs = pd.Series(np.full(h.shape[0], False), h_adj.index)
+    if not divs_bad and not splits_bad and not prices_bad:
+        f_diff_divs = pd.Series(np.full(h.shape[0], False), h.index)
         if interday:
             # Yahoo div-adjusts interday data, so check my div adjustment
+            # Use looser tolerance if different 'Repaired?' states
+            try:
+                f_repair_mismatch = np.logical_xor(h_adj["Repaired?"].to_numpy(), df_yf_adj["Repaired?"].to_numpy())
+            except:
+                print("- h_adj.shape:", h_adj.shape)
+                print("- df_yf_adj.shape:", df_yf_adj.shape)
+                print('h_adj["Repaired?"].dtype') ; print(h_adj["Repaired?"].dtype)
+                print('df_yf_adj["Repaired?"].dtype') ; print(df_yf_adj["Repaired?"].dtype)
+                raise
             for c in ["Open", "Close", "High", "Low"]:
                 c = "Adj "+c
                 f_close = np.isclose(h_adj[c].to_numpy(), df_yf_adj[c].to_numpy(), rtol=0.0005)
                 f_close = pd.Series(f_close, h.index)
+                if f_repair_mismatch.any():
+                    loose_tol = 0.1
+                    f_close2 = np.isclose(h_adj[c].to_numpy()[f_repair_mismatch], df_yf_adj[c].to_numpy()[f_repair_mismatch], rtol=loose_tol)
+                    f_close[f_repair_mismatch] = f_close2
                 f_diff_c = (~f_close) & (~f_diff_all)
                 f_diff_divs = f_diff_divs | f_diff_c
         f_diff_divs = f_diff_divs & ~f_diff_all
         if f_diff_divs.any():
             if debug:
                 print("Bad div-adjustments detected:")
                 if not f_diff_all.any():
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache.egg-info/PKG-INFO` & `yfinance-cache-0.4.4/yfinance_cache.egg-info/PKG-INFO`

 * *Files 9% similar despite different names*

```diff
@@ -1,51 +1,60 @@
 Metadata-Version: 2.1
 Name: yfinance-cache
-Version: 0.4.3
+Version: 0.4.4
 Summary: Smart caching wrapper for 'yfinance' module
 Home-page: https://github.com/ValueRaider/yfinance-cache
 Author: ValueRaider
 Author-email: ValueRaider@protonmail.com
 Project-URL: Bug Tracker, https://github.com/ValueRaider/yfinance-cache/issues
 Classifier: Programming Language :: Python :: 3
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: OS Independent
 Requires-Python: >=3
 Description-Content-Type: text/markdown
 License-File: LICENSE
 
 # yfinance-cache
-Caching wrapper for `yfinance` module. Intelligent caching, not dumb caching of web requests. This means only updating cache if (i) missing and (ii) new data expected.
+Persistent caching wrapper for `yfinance` module. Intelligent caching, not dumb caching of web requests - only update cache if missing and new data expected.
 
-Only price data fully implemented. Uses [exchange schedule](https://github.com/gerrymanoim/exchange_calendars) to know when new price data available. '1d' price data always fetched from `start` date to today (i.e. ignores `end`), as need to know all dividends and stock splits since `start`.
+Only price data caching fully implemented. Everything else is cached once but never updated (unless you delete their files).
 
-Planning to intelligently cache financials too using Yahoo's earnings calendar to estimate next release (prototype code ready), but `yfinance` decryption issue blocks this.
+Persistent cache stored in your user cache folder:
+- Windows = C:/Users/\<USER\>/AppData/Local/py-yfinance-cache
+- Linux = /home/\<USER\>/.cache/py-yfinance-cache
+- MacOS = /Users/\<USER\>/Library/Caches/py-yfinance-cache
+
+### Price cache
+
+How is my price caching different to other market price caches? Simple - they don't adjust cached data for new stock splits or dividends.
+
+Uses [exchange schedule](https://github.com/gerrymanoim/exchange_calendars) to know when new price data available. '1d' price data always fetched from `start` date to today (i.e. ignores `end`), as need to know all dividends and stock splits since `start`.
 
 ## Interface
 Interaction almost identical to yfinance. Differences highlighted underneath code:
 
 ```python
 import yfinance_cache as yfc
 
 msft = yfc.Ticker("MSFT")
 
 # get stock info
 msft.info
 
 # get historical market data
-hist = msft.history(period="max")
+hist = msft.history(period="1d")
 ...
 # etc. See yfinance documentation for full API
 ```
 
 #### Refreshing cache
 ```python
 msft.history(interval="1d", max_age="1h", trigger_at_market_close=False, ...)
 ```
-`max_age` controls when to yodate cache. If market is still open and `max_age` time has passed since last fetch, then today's cached price data will be refreshed. If `trigger_at_market_close`=True then refresh also triggered if market has closed since last fetch. Must be `Timedelta` or equivalent `str`, defaults to half of interval. 
+`max_age` controls when to update cache. If market is still open and `max_age` time has passed since last fetch, then today's cached price data will be refreshed. If `trigger_at_market_close=True` then refresh also triggered if market has closed since last fetch. Must be `Timedelta` or equivalent `str`, defaults to half of interval. 
 
 #### Adjusting price
 Price can be adjusted for stock splits, dividends, or both.
 ```python
 msft.history(..., adjust_splits=True, adjust_divs=True)
 ```
 
@@ -64,23 +73,34 @@
 
 # Verify prices of entire cache, ticker symbols processed alphabetically. Recommend using `requests_cache` session.
 yfc.verify_cached_tickers_prices(
 	session=None,  # recommend you provide a requests_cache here
 	rtol=0.0001,
 	vol_rtol=0.005,
 	correct=False,
+	halt_on_fail=True,  # stop verifying on first fail
 	resume_from_tkr=None,  # in case you aborted verification, can jump ahead to this ticker symbol. Append '+1' to start AFTER the ticker
 	debug_tkr=None,  # only verify this ticker symbol
 	debug_interval=None)
 ```
 
 With latest version the only genuine differences you should see are tiny Volume differences (~0.5%). Seems Yahoo is still adjusting Volume over 24 hours after that day ended, e.g. updating Monday Volume on Wednesday.
 
 If you see big differences in the OHLC price of recent intervals (last few days), probably Yahoo is wrong! Since fetching that price data on day / day after, Yahoo has messed up their data - at least this is my experience. Cross-check against TradingView or stock exchange website.
 
+## Performance
+
+For each ticker, YFC basically performs 2 tasks:
+
+1 - check if fetch needed
+
+2 - fetch data and integrate into cache
+
+Throughput on 1 thread decent CPU: task 1 @ ~60/sec, task 2 @ ~5/sec.
+
 ## Installation
 
 Available on PIP: `pip install yfinance_cache`
 
 ## Limitations
 
 - only price data is checked if refresh needed
```

### Comparing `yfinance-cache-0.4.3/yfinance_cache.egg-info/SOURCES.txt` & `yfinance-cache-0.4.4/yfinance_cache.egg-info/SOURCES.txt`

 * *Files identical despite different names*

